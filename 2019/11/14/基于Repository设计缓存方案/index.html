<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="相比于使用一个中间件来“暴力”缓存接口的响应，提高接口查询速度而言，Repository缓存能更好的控制缓存粒度和更新时机。">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="https://www.yeqown.xyz/2019/11/14/%E5%9F%BA%E4%BA%8ERepository%E8%AE%BE%E8%AE%A1%E7%BC%93%E5%AD%98%E6%96%B9%E6%A1%88/">
  <meta property="og:site_name" content="Yeqown">
  <meta property="og:title" content="基于Repository设计缓存方案">
  <meta property="og:description" content="相比于使用一个中间件来“暴力”缓存接口的响应，提高接口查询速度而言，Repository缓存能更好的控制缓存粒度和更新时机。">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2019-11-14T09:14:25+08:00">
    <meta property="article:modified_time" content="2019-11-14T09:14:25+08:00">
    <meta property="article:tag" content="Cache">
    <meta property="article:tag" content="Repository">
<title>基于Repository设计缓存方案 | Yeqown</title>
<link rel="icon" href="/favicon.png" >
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="https://www.yeqown.xyz/2019/11/14/%E5%9F%BA%E4%BA%8ERepository%E8%AE%BE%E8%AE%A1%E7%BC%93%E5%AD%98%E6%96%B9%E6%A1%88/">
<link rel="stylesheet" href="/book.min.c2fbf3db843e2f212ac724c116ea0973ae0c44d9926b1c14e16b29de812a6dc5.css" integrity="sha256-wvvz24Q&#43;LyEqxyTBFuoJc64MRNmSaxwU4Wsp3oEqbcU=" crossorigin="anonymous">
  <script defer src="/fuse.min.js"></script>
  <script defer src="/en.search.min.f17080086de35ea2d8ae7bbe8fd7dfab7183b485730a9353be99f4f0986495e5.js" integrity="sha256-8XCACG3jXqLYrnu&#43;j9ffq3GDtIVzCpNTvpn08JhkleU=" crossorigin="anonymous"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <meta name="referrer" content="no-referrer-when-downgrade"><!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>Yeqown</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>







  
<ul>
  
  <li>
    <a href="/categories"  target="_blank" rel="noopener">
        Categories
      </a>
  </li>
  
  <li>
    <a href="/tags"  target="_blank" rel="noopener">
        Tags
      </a>
  </li>
  
</ul>










  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/aboutme/" class="">About Me</a>
  

        </li>
      
    
  </ul>














</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>基于Repository设计缓存方案</h3>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#场景">场景</a></li>
        <li><a href="#问题来了">问题来了</a></li>
        <li><a href="#缓存算法">缓存算法</a></li>
        <li><a href="#简单测试">简单测试</a></li>
        <li><a href="#代码">代码</a></li>
        <li><a href="#参考">参考</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
<article class="markdown book-post">
  <h2>
    基于Repository设计缓存方案
  </h2>
  
  <div class="flex align-center text-small book-post-date">
    <img src="/svg/calendar.svg" class="book-icon " alt="" />
    <span>November 14, 2019</span>
  </div>



  

  
  <div class="text-small">
    
      <a href="/tags/cache/">Cache</a>, 
      <a href="/tags/repository/">Repository</a>
  </div>
  


  <div class="book-post-content"><h3 id="场景">
  场景
  <a class="anchor" href="#%e5%9c%ba%e6%99%af">#</a>
</h3>
<pre><code>Tester—A：这个 getInfo 接口咋这么慢呢？查一下要5+s？QPS竟然只有10！！！！
RD-B    ：这是因为getInfo要查库。。。N多库
Tester-B：那优化一下呗？
RD-B    ：好的，容我操作一波（给接口加上一个响应缓存），好了你再测试一下
Tester-B：（测试中。。。），速度果然快了不少。诶不对，这个接口里拿到的用户信息不对，我明明已经balaba了，这里没有更新！！！
RD-B    ：哦哦哦，我晓得咯，再容我操作一波（缓存加有效时间，个人信息更新的时候再强删缓存），O了

至此开始了针对于QPS+缓存更新的一些列测试。。。剧终。
</code></pre>
<p>QPS和响应时间是后（jie）端（kou)工程师非常熟悉的指标，这两个值能比较直观的反映该接口的性能，<del>间接</del>直接影响了前端页面的流畅度。。。</p>
<h3 id="问题来了">
  问题来了
  <a class="anchor" href="#%e9%97%ae%e9%a2%98%e6%9d%a5%e4%ba%86">#</a>
</h3>
<h4 id="del接口del查询性能如何提高">
  <del>接口</del>查询性能如何提高
  <a class="anchor" href="#del%e6%8e%a5%e5%8f%a3del%e6%9f%a5%e8%af%a2%e6%80%a7%e8%83%bd%e5%a6%82%e4%bd%95%e6%8f%90%e9%ab%98">#</a>
</h4>
<p>除去机器和编程语言的因素之后，肯定要从业务场景出发，分析接口响应缓慢的原因。譬如，最常见的:</p>
<ol>
<li>查N多表，表还没有索引orz</li>
<li>无用数据，增加传输的Size</li>
<li>反复查询某些<del>热点</del>数据，但每次都直接打到数据库</li>
<li>上游服务响应缓慢</li>
<li>其他</li>
</ol>
<p>好了，这里只讨论热点数据的缓存方案，毕竟要具体场景具体分析，而缓存方案是比较通用的。</p>
<h4 id="缓存方案如何选择">
  缓存方案如何选择
  <a class="anchor" href="#%e7%bc%93%e5%ad%98%e6%96%b9%e6%a1%88%e5%a6%82%e4%bd%95%e9%80%89%e6%8b%a9">#</a>
</h4>
<table>
  <thead>
      <tr>
          <th>序号</th>
          <th>缓存方案</th>
          <th>优势</th>
          <th>劣势</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td>Response缓存</td>
          <td>简单暴力</td>
          <td>缓存更新时机不好把控，如果面面俱到可能心态崩坏；缓存粒度太大，无法局部更新；针对查询接口有帮助，其他业务下查询数据则毫无帮助</td>
      </tr>
      <tr>
          <td>2</td>
          <td>Repository缓存</td>
          <td>粒度由Repo自行掌握，可控性强；Repo复用场景下会提高应用整体的速度</td>
          <td>需要针对各个Repo做缓存的处理；改动较多；其他orz</td>
      </tr>
  </tbody>
</table>
<p>总的来说，Repository的缓存方案，在上述背景上较简单暴力的中间件缓存法要更加优雅可控～。</p>
<h3 id="缓存算法">
  缓存算法
  <a class="anchor" href="#%e7%bc%93%e5%ad%98%e7%ae%97%e6%b3%95">#</a>
</h3>
<p>提到缓存就一定会提到缓存替换策略，有最常见的：<code>LRU</code> <code>LFU</code> <code>FIFO</code> <code>MRU(最近频繁使用算法)</code> <code>LRU的多个变种算法</code> <code>LIRS</code>等。
这里选用了LRU-K（K=2）并基于<code>golang</code>来实现 <code>cached-repository</code>，更多算法的详细信息参见参考文档中的<a href="https://yeqown.github.io/2019/08/12/LRU%E5%92%8CLRU-K/">LRU和LRU-K</a>:</p>
<p>这里分成了两个<code>interface</code>:</p>
<p><code>CacheAlgor</code>重点在于与<code>Repo</code>交互，所以只提供了简单的增删改查，底层还是基于<code>Cache</code>来实现的。本意是想实现多种缓存替换算法来丰富<code>cached-repository</code>，orz</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#75715e">// cache.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// CacheAlgor is an interface implements different alg.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CacheAlgor</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span> <span style="color:#66d9ef">interface</span>{})
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">value</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">ok</span> <span style="color:#66d9ef">bool</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span> <span style="color:#66d9ef">interface</span>{})
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">interface</span>{})
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>lru.Cache</code> 在于提供 基于<code>LRU-like</code>算法缓存和替换能力，所以接口会更丰富一些，</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#75715e">// lru/types.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Cache is the interface for simple LRU cache.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Cache</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Puts a value to the cache, returns true if an eviction occurred and
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// updates the &#34;recently used&#34;-ness of the key.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Returns key&#39;s value from the cache and
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// updates the &#34;recently used&#34;-ness of the key. #value, isFound
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">value</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">ok</span> <span style="color:#66d9ef">bool</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Removes a key from the cache.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Remove</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Peeks a key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// Returns key&#39;s value without updating the &#34;recently used&#34;-ness of the key.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Peek</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">value</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">ok</span> <span style="color:#66d9ef">bool</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Returns the oldest entry from the cache. #key, value, isFound
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Oldest</span>() (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">bool</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Returns a slice of the keys in the cache, from oldest to newest.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Keys</span>() []<span style="color:#66d9ef">interface</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Returns the number of items in the cache.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Len</span>() <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// iter all key and items in cache
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Iter</span>(<span style="color:#a6e22e">f</span> <span style="color:#a6e22e">IterFunc</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Clears all cache entries.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Purge</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>关于如何实现<code>LRU</code>或者<code>LRU-K</code>，网上已经有很多文章了，原理也不复杂，这里就不过多赘述了，直接上测试结果</p>
<h3 id="简单测试">
  简单测试
  <a class="anchor" href="#%e7%ae%80%e5%8d%95%e6%b5%8b%e8%af%95">#</a>
</h3>
<p>完整代码参见<a href="https://github.com/yeqown/cached-repository/tree/master/examples/custom-cache-manage">code</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#75715e">// MysqlRepo .
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MysqlRepo</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">db</span>   <span style="color:#f92672">*</span><span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">DB</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">calg</span> <span style="color:#a6e22e">cp</span>.<span style="color:#a6e22e">CacheAlgor</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// *cp.EmbedRepo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// NewMysqlRepo .
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewMysqlRepo</span>(<span style="color:#a6e22e">db</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">DB</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">MysqlRepo</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// func NewLRUK(k, size, hSize uint, onEvict EvictCallback) (*K, error)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lru</span>.<span style="color:#a6e22e">NewLRUK</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">k</span>, <span style="color:#a6e22e">v</span> <span style="color:#66d9ef">interface</span>{}) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;key: %v, value: %v\n&#34;</span>, <span style="color:#a6e22e">k</span>, <span style="color:#a6e22e">v</span>)
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">MysqlRepo</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">db</span>:   <span style="color:#a6e22e">db</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// func New(c lru.Cache) CacheAlgor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">calg</span>: <span style="color:#a6e22e">cp</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">c</span>),
</span></span><span style="display:flex;"><span>	}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// GetByID .
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">repo</span> <span style="color:#a6e22e">MysqlRepo</span>) <span style="color:#a6e22e">GetByID</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">uint</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">userModel</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">start</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;this queryid=%d cost: %d ns\n&#34;</span>,<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Sub</span>(<span style="color:#a6e22e">start</span>).<span style="color:#a6e22e">Nanoseconds</span>())
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">calg</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">userModel</span>), <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// actual find in DB
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">userModel</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Where</span>(<span style="color:#e6db74">&#34;id = ?&#34;</span>, <span style="color:#a6e22e">id</span>).<span style="color:#a6e22e">First</span>(<span style="color:#a6e22e">m</span>).<span style="color:#a6e22e">Error</span>; <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">calg</span>.<span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">m</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Update .
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">repo</span> <span style="color:#a6e22e">MysqlRepo</span>) <span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">uint</span>, <span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">userModel</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Where</span>(<span style="color:#e6db74">&#34;id = ?&#34;</span>, <span style="color:#a6e22e">id</span>).<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">m</span>).<span style="color:#a6e22e">Error</span>; <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;before: %v\n&#34;</span>, <span style="color:#a6e22e">m</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">ID</span> = <span style="color:#a6e22e">id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">First</span>(<span style="color:#a6e22e">m</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;after: %v\n&#34;</span>, <span style="color:#a6e22e">m</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// update cache, ifcache hit id
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">calg</span>.<span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">m</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Delete .
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">repo</span> <span style="color:#a6e22e">MysqlRepo</span>) <span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">uint</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Delete</span>(<span style="color:#66d9ef">nil</span>, <span style="color:#e6db74">&#34;id = ?&#34;</span>, <span style="color:#a6e22e">id</span>).<span style="color:#a6e22e">Error</span>; <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">calg</span>.<span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ... prepare data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Seed</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">UnixNano</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">1000</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> uint(<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">10</span>))
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">id</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">GetByID</span>(<span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;err: %d , %v\n&#34;</span>, <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">ID</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">id</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Name</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;name-%d&#34;</span>, <span style="color:#a6e22e">id</span>) <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Province</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;province-%d&#34;</span>, <span style="color:#a6e22e">id</span>) <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">City</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;city-%d&#34;</span>, <span style="color:#a6e22e">id</span>) {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;err: not matched target with id[%d]: %v\n&#34;</span>, <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">ID</span>, <span style="color:#a6e22e">v</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>		}()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>➜  custom-cache-manage git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ go run main.go 
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> cost: <span style="color:#ae81ff">245505</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> cost: <span style="color:#ae81ff">131838</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> cost: <span style="color:#ae81ff">128272</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> cost: <span style="color:#ae81ff">112281</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> cost: <span style="color:#ae81ff">123942</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">140267</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> cost: <span style="color:#ae81ff">148814</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> cost: <span style="color:#ae81ff">126904</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">129676</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> cost: <span style="color:#ae81ff">174202</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> cost: <span style="color:#ae81ff">151673</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">156370</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> cost: <span style="color:#ae81ff">159285</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">142215</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> cost: <span style="color:#ae81ff">691</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> cost: <span style="color:#ae81ff">450</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> cost: <span style="color:#ae81ff">160263</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> cost: <span style="color:#ae81ff">149655</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">756</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> cost: <span style="color:#ae81ff">143363</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> cost: <span style="color:#ae81ff">740</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> cost: <span style="color:#ae81ff">558</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> cost: <span style="color:#ae81ff">476</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> cost: <span style="color:#ae81ff">184098</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> cost: <span style="color:#ae81ff">824</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> cost: <span style="color:#ae81ff">556</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> cost: <span style="color:#ae81ff">632</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> cost: <span style="color:#ae81ff">480</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> cost: <span style="color:#ae81ff">439</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> cost: <span style="color:#ae81ff">409</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> cost: <span style="color:#ae81ff">431</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">479</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">423</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> cost: <span style="color:#ae81ff">423</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> cost: <span style="color:#ae81ff">411</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">423</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> cost: <span style="color:#ae81ff">394</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> cost: <span style="color:#ae81ff">410</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> cost: <span style="color:#ae81ff">424</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">428</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> cost: <span style="color:#ae81ff">433</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">420</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> cost: <span style="color:#ae81ff">424</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">406</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">399</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> cost: <span style="color:#ae81ff">405</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> cost: <span style="color:#ae81ff">428</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> cost: <span style="color:#ae81ff">383</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">399</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> cost: <span style="color:#ae81ff">413</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">381</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> cost: <span style="color:#ae81ff">427</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> cost: <span style="color:#ae81ff">430</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> cost: <span style="color:#ae81ff">468</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> cost: <span style="color:#ae81ff">406</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">380</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> cost: <span style="color:#ae81ff">360</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> cost: <span style="color:#ae81ff">660</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">393</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> cost: <span style="color:#ae81ff">419</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> cost: <span style="color:#ae81ff">1254</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">723</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">503</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> cost: <span style="color:#ae81ff">448</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> cost: <span style="color:#ae81ff">510</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> cost: <span style="color:#ae81ff">432</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> cost: <span style="color:#ae81ff">999</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> cost: <span style="color:#ae81ff">419</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> cost: <span style="color:#ae81ff">658</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> cost: <span style="color:#ae81ff">1322</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> cost: <span style="color:#ae81ff">543</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">1311</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> cost: <span style="color:#ae81ff">348</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">309</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> cost: <span style="color:#ae81ff">350</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> cost: <span style="color:#ae81ff">311</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> cost: <span style="color:#ae81ff">336</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> cost: <span style="color:#ae81ff">567</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> cost: <span style="color:#ae81ff">293</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> cost: <span style="color:#ae81ff">338</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">499</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> cost: <span style="color:#ae81ff">318</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> cost: <span style="color:#ae81ff">330</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> cost: <span style="color:#ae81ff">322</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">339</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> cost: <span style="color:#ae81ff">1273</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> cost: <span style="color:#ae81ff">1175</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">306</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> cost: <span style="color:#ae81ff">316</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> cost: <span style="color:#ae81ff">330</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> cost: <span style="color:#ae81ff">322</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">324</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> cost: <span style="color:#ae81ff">291</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> cost: <span style="color:#ae81ff">310</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> cost: <span style="color:#ae81ff">321</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> cost: <span style="color:#ae81ff">294</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> cost: <span style="color:#ae81ff">293</span> ns
</span></span><span style="display:flex;"><span>this queryid<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> cost: <span style="color:#ae81ff">3566</span> ns
</span></span><span style="display:flex;"><span>...more ignored
</span></span></code></pre></div><blockquote>
<p>水平有限，如有错误，欢迎勘误指正🙏。</p>
</blockquote>
<h3 id="代码">
  代码
  <a class="anchor" href="#%e4%bb%a3%e7%a0%81">#</a>
</h3>
<p><a href="https://github.com/yeqown/cached-repository">github.com/yeqown/cached-repository</a></p>
<h3 id="参考">
  参考
  <a class="anchor" href="#%e5%8f%82%e8%80%83">#</a>
</h3>
<ul>
<li><a href="https://cloud.tencent.com/developer/article/1005742">LIRS</a></li>
<li><a href="https://yeqown.github.io/2019/08/12/LRU%E5%92%8CLRU-K/">LRU-k</a></li>
</ul>
</div>
</article>


<section class="comment">
  <div id="gitalk-container"></div>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
  <script>
      const gitalk = new Gitalk({
          clientID: '7d8c8c91ae6aff3e46e7',
          clientSecret: '0f0f2ea4fb6eb3067955823f06286e7d88509b9f',
          repo: 'yeqown.github.io',
          owner: 'yeqown',
          admin: ['yeqown'],
          id: "cached-repository-design", 
          distractionFreeMode: false 
      });
      (function () {
          if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
              document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
              return;
          }
          gitalk.render('gitalk-container');
      })();
  </script>
</section>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">






<div class="flex align-center">
    <span id="busuanzi_container_site_pv" style="margin-right: 10px;">
        访问量<span id="busuanzi_value_site_pv"></span>
    </span>
    <span id="busuanzi_container_site_uv" style="margin-right: 10px;">
        访客数<span id="busuanzi_value_site_uv"></span>
    </span>
</div></div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#场景">场景</a></li>
        <li><a href="#问题来了">问题来了</a></li>
        <li><a href="#缓存算法">缓存算法</a></li>
        <li><a href="#简单测试">简单测试</a></li>
        <li><a href="#代码">代码</a></li>
        <li><a href="#参考">参考</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












