<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="è§£å†³å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œé“¾è·¯è¿½è¸ªï¼Œé—®é¢˜å®šä½å’Œå¯è§†åŒ–åˆ†æç­‰é—®é¢˜ï¼Œé“¾è·¯è¿½è¸ªè¿˜æ˜¯å¾®æœåŠ¡å¯è§‚æµ‹æ€§çš„é‡è¦åŸºçŸ³ï¼Œæœ¬æ–‡å°±å®æˆ˜äº†åœ¨Goé¡¹ç›®ä¸­å¦‚ä½•å°†opentracingè½åœ°">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="https://www.yeqown.xyz/2020/08/06/opentracing%E5%AE%9E%E6%88%98/">
  <meta property="og:site_name" content="Yeqown">
  <meta property="og:title" content="Opentracingå®æˆ˜">
  <meta property="og:description" content="è§£å†³å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œé“¾è·¯è¿½è¸ªï¼Œé—®é¢˜å®šä½å’Œå¯è§†åŒ–åˆ†æç­‰é—®é¢˜ï¼Œé“¾è·¯è¿½è¸ªè¿˜æ˜¯å¾®æœåŠ¡å¯è§‚æµ‹æ€§çš„é‡è¦åŸºçŸ³ï¼Œæœ¬æ–‡å°±å®æˆ˜äº†åœ¨Goé¡¹ç›®ä¸­å¦‚ä½•å°†opentracingè½åœ°">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-08-06T08:34:45+08:00">
    <meta property="article:modified_time" content="2020-08-06T08:34:45+08:00">
    <meta property="article:tag" content="Golang">
    <meta property="article:tag" content="Opentracing">
    <meta property="article:tag" content="Tracing">
    <meta property="article:tag" content="Jaeger">
<title>Opentracingå®æˆ˜ | Yeqown</title>
<link rel="icon" href="/favicon.png" >
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="https://www.yeqown.xyz/2020/08/06/opentracing%E5%AE%9E%E6%88%98/">
<link rel="stylesheet" href="/book.min.c2fbf3db843e2f212ac724c116ea0973ae0c44d9926b1c14e16b29de812a6dc5.css" integrity="sha256-wvvz24Q&#43;LyEqxyTBFuoJc64MRNmSaxwU4Wsp3oEqbcU=" crossorigin="anonymous">
  <script defer src="/fuse.min.js"></script>
  <script defer src="/en.search.min.f17080086de35ea2d8ae7bbe8fd7dfab7183b485730a9353be99f4f0986495e5.js" integrity="sha256-8XCACG3jXqLYrnu&#43;j9ffq3GDtIVzCpNTvpn08JhkleU=" crossorigin="anonymous"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <meta name="referrer" content="no-referrer-when-downgrade"><!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>Yeqown</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>







  
<ul>
  
  <li>
    <a href="/categories"  target="_blank" rel="noopener">
        Categories
      </a>
  </li>
  
  <li>
    <a href="/tags"  target="_blank" rel="noopener">
        Tags
      </a>
  </li>
  
</ul>










  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/aboutme/" class="">About Me</a>
  

        </li>
      
    
  </ul>














</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>Opentracingå®æˆ˜</h3>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#èƒŒæ™¯">èƒŒæ™¯</a></li>
        <li><a href="#opentracing">Opentracing</a></li>
        <li><a href="#å®æˆ˜">å®æˆ˜</a></li>
        <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
        <li><a href="#å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
<article class="markdown book-post">
  <h2>
    Opentracingå®æˆ˜
  </h2>
  
  <div class="flex align-center text-small book-post-date">
    <img src="/svg/calendar.svg" class="book-icon " alt="" />
    <span>August 6, 2020</span>
  </div>



  
  <div class="text-small">
    
      <a href="/categories/Tracing/">Tracing</a>
  </div>
  

  
  <div class="text-small">
    
      <a href="/tags/Golang/">Golang</a>, 
      <a href="/tags/Opentracing/">Opentracing</a>, 
      <a href="/tags/Tracing/">Tracing</a>, 
      <a href="/tags/Jaeger/">Jaeger</a>
  </div>
  


  <div class="book-post-content"><h3 id="èƒŒæ™¯">
  èƒŒæ™¯
  <a class="anchor" href="#%e8%83%8c%e6%99%af">#</a>
</h3>
<p>åœ¨æ²¡æœ‰é“¾è·¯è¿½è¸ªç³»ç»Ÿçš„æƒ…å†µä¸‹ï¼Œå¦‚æœåªè¦å°‘æ•°å‡ ä¸ªæœåŠ¡ï¼Œæˆ–è®¸è¿˜å¯ä»¥é€šè¿‡æ—¥å¿—æ¥æ’æŸ¥å®šä½é—®é¢˜ã€‚ä½†æ˜¯å¦‚æœæœåŠ¡ä¸€æ—¦è¶…è¿‡10ä¸ªï¼Œé‚£ä¹ˆå†æƒ³é€šè¿‡æ—¥å¿—æ¥å®šä½åˆ†æé—®é¢˜å°†æ— æ¯”ç¹çã€‚
å› ä¸ºï¼Œä½ å…ˆè¦ä»å¤§é‡çš„æ—¥å¿—ä¸­åˆ ç­›é€‰å‡ºæŸæ¬¡è¯·æ±‚çš„æ—¥å¿—æ•°æ®ï¼Œæ‰èƒ½è¿›è¡Œåç»­çš„å®šä½åˆ†æã€‚
å€˜è‹¥æ—¥å¿—ç³»ç»Ÿä¹Ÿä¸å¤Ÿå®Œå–„ï¼Œæ—¥å¿—å¯¹äºè°ƒè¯•æ¯«æ— å¸®åŠ©ï¼Œé‚£åˆå¾—é€€å›åˆ°æœ€åŸå§‹çš„æ–¹å¼ï¼Œé€šè¿‡ä»£ç æ–­ç‚¹å’Œå¢åŠ æ—¥å¿—ï¼Œç­‰å¾…é—®é¢˜å¤ç°ï¼Œæˆ–è€…é€šè¿‡è‚‰çœ¼æ£€æŸ¥ä»£ç ã€‚
ä¸æ˜¯è¯´è¿™ç§æ–¹å¼ä¸è¡Œï¼Œè€Œæ˜¯å¤§éƒ¨åˆ†çš„ç¨‹åºå‘˜çš„ä¸šåŠ¡éœ€æ±‚æ¯”è¾ƒç´§å¼ ï¼Œè¿™æ ·çš„æ’æŸ¥æ‰‹æ®µæ•ˆç‡å’Œæ”¶ç›Šè¿œè¿œè¾¾ä¸åˆ°è¦æ±‚ï¼ˆå¦‚æœä½ æœ‰æ—¶é—´ï¼Œå½“æˆ‘æ²¡è¯´ ğŸ¶ï¼‰ã€‚</p>
<p>åœ¨å®é™…åœºæ™¯ä¸­ï¼Œæˆ‘ä¹Ÿé‡åˆ°äº†è¿™æ ·çš„é—®é¢˜ï¼š</p>
<ol>
<li>æ—¥å¿—ç³»ç»Ÿé‡ŒåŒ…å«äº†è¿‡å°‘çš„ä¿¡æ¯ï¼Œå¯¹äºè°ƒè¯•å‡ ä¹æ²¡æœ‰å¸®åŠ© (å‡ ä¹åªæœ‰é”™è¯¯æ—¥å¿—ï¼Œç¼ºå°‘è¾“å‡ºä¸Šä¸‹æ–‡çš„æ—¥å¿—)ã€‚</li>
<li>æœåŠ¡è°ƒç”¨å¤æ‚ï¼Œä¸€ä¸ªè¯·æ±‚å¤±è´¥ï¼Œåªèƒ½é€è¿‡é”™è¯¯ç å’Œé”™è¯¯ä¿¡æ¯è¿›è¡Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨è°ƒç”¨å¤±è´¥çš„æƒ…å†µã€‚</li>
<li>è°ƒç”¨é“¾è·¯å¤æ‚çš„æƒ…å†µä¸‹ï¼Œæƒ³è¦å¯¹æŸä¸ªè¯·æ±‚è¿›è¡Œä¼˜åŒ–ï¼Œæ— ä»ä¸‹æ‰‹ã€‚</li>
</ol>
<p>è¿™é‡Œåªåˆ—ä¸¾äº†è·Ÿ<code>trace</code>ç›¸å…³çš„ä¸€äº›åŸå§‹åœºæ™¯ï¼Œå½“ç„¶ä»ä¸Šé¢çš„æè¿°ä¸­è¿˜èƒ½å‘ç°<code>æ—¥å¿—ç³»ç»Ÿä¸å¤Ÿå®Œå–„ï¼Œå¯¹è°ƒè¯•ä¸å‹å¥½</code>ï¼Œä¸è¿‡è¿™é‡Œé¦–è¦è§£å†³çš„é—®é¢˜æ˜¯<code>é“¾è·¯è¿½è¸ªé—®é¢˜</code>ã€‚</p>
<blockquote>
<p>å¦‚æœå¯¹è·¯é“¾è·¯è¿½è¸ªæ²¡æœ‰æ¦‚å¿µï¼Œè¿˜æœ›è‡ªè¡ŒæŸ¥é˜…èµ„æ–™ï¼Œè¿™é‡Œä¸ä¼šè¿‡å¤šä»‹ç»ï½</p>
</blockquote>
<h3 id="opentracing">
  Opentracing
  <a class="anchor" href="#opentracing">#</a>
</h3>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šOpentracing æ˜¯ä¸€å¥—æ ‡å‡†æ¥å£ï¼Œè€Œä¸æ˜¯å…·ä½“å®ç°ã€‚</p>
</blockquote>
<p>è¿™é‡Œå°±å®æˆ˜opentracing + jaeger çš„é“¾è·¯è¿½è¸ªæ–¹æ¡ˆã€‚å…¶ä¸­ opentracing æ˜¯ä¸€å¥—æ ‡å‡†æ¥å£ï¼Œè€Œjaegeræ˜¯åŒ…å«äº† opentracing çš„å®ç°çš„ä¸€å¥—å·¥å…·ã€‚
Traceé“¾è·¯ç®€å•ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<img src="/images/tracing1_0.png" />
<h4 id="trace">
  Trace
  <a class="anchor" href="#trace">#</a>
</h4>
<p>æè¿°åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ä¸€æ¬¡&quot;äº‹åŠ¡&quot;ã€‚</p>
<h4 id="span">
  Span
  <a class="anchor" href="#span">#</a>
</h4>
<p>è¡¨ç¤ºå·¥ä½œæµçš„ä¸€éƒ¨åˆ†çš„å‘½åå’Œå®šæ—¶æ“ä½œã€‚å¯ä»¥æ¥å—æ ‡ç­¾(Tag Key:Value)ï¼Œä»¥åŠé™„åŠ åˆ°ç‰¹å®šspanå®ä¾‹çš„æ ‡æ³¨(Annotation)ï¼Œå¦‚æ—¶é—´æˆ³å’Œç»“æ„åŒ–æ—¥å¿—ã€‚</p>
<h4 id="spancontext">
  SpanContext
  <a class="anchor" href="#spancontext">#</a>
</h4>
<p>è¿½è¸ªä¼´éšåˆ†å¸ƒå¼äº‹åŠ¡çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å®ƒé€šè¿‡ç½‘ç»œæˆ–é€šè¿‡æ¶ˆæ¯æ€»çº¿å°†æœåŠ¡ä¼ é€’ç»™æœåŠ¡çš„æ—¶é—´ã€‚spanä¸Šä¸‹æ–‡åŒ…å«TraceIdã€SpanIdå’Œè¿½è¸ªç³»ç»Ÿéœ€è¦ä¼ æ’­åˆ°ä¸‹æ¸¸æœåŠ¡çš„å…¶ä»–æ•°æ®ã€‚</p>
<h3 id="å®æˆ˜">
  å®æˆ˜
  <a class="anchor" href="#%e5%ae%9e%e6%88%98">#</a>
</h3>
<p>è¿™é‡Œæˆ‘å‡†å¤‡çš„æ˜¯ Go é¡¹ç›®ï¼ŒæœåŠ¡ä¹‹é—´é€šè¿‡<code>gRPC</code>é€šä¿¡ã€‚é“¾è·¯å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>                                +-- process internal trace2
</span></span><span style="display:flex;"><span>                                |
</span></span><span style="display:flex;"><span>                     +---&gt; process internal trace1
</span></span><span style="display:flex;"><span>                     |
</span></span><span style="display:flex;"><span>                     |                 +---&gt; server-b trace<span style="color:#f92672">(</span>gRPC<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>entry<span style="color:#f92672">(</span>HTTP<span style="color:#f92672">)</span> ---&gt; server-a trace--gRPC--|
</span></span><span style="display:flex;"><span>                                       +---&gt; server-c trace<span style="color:#f92672">(</span>gRPC<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                                                   |
</span></span><span style="display:flex;"><span>                                                   +----&gt; process internal trace3
</span></span></code></pre></div><p>ä»ä¸Šå›¾ä¸­å¯ä»¥æ˜ç¡®ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯ï¼šå®è·µ<code>è·¨æœåŠ¡è°ƒç”¨</code>å’Œ<code>æœåŠ¡å†…éƒ¨è°ƒç”¨</code>çš„é“¾è·¯è¿½è¸ªï¼Œé…åˆjaegeræˆ‘ä»¬è¿˜å¯ä»¥å°†é“¾è·¯ä¿¡æ¯å¯è§†åŒ–ã€‚</p>
<h4 id="æˆ‘æœ‰äº†æœåŠ¡æ€ä¹ˆå®æ–½è½åœ°">
  æˆ‘æœ‰äº†æœåŠ¡ï¼Œæ€ä¹ˆå®æ–½è½åœ°ï¼Ÿ
  <a class="anchor" href="#%e6%88%91%e6%9c%89%e4%ba%86%e6%9c%8d%e5%8a%a1%e6%80%8e%e4%b9%88%e5%ae%9e%e6%96%bd%e8%90%bd%e5%9c%b0">#</a>
</h4>
<p>ä¸ºäº†å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘æŠŠè¿™ä¸ªé—®é¢˜ç»“åˆopentracingçš„æ¦‚å¿µå†åˆ†è§£ä¸€ä¸‹ï¼š</p>
<ol>
<li>ParentSpan ä»å“ªå„¿æ¥ï¼Ÿ</li>
<li>ChildSpanç”±ParentSpanåˆ›å»ºï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼Ÿ</li>
<li>é“¾è·¯Tracerä»å“ªå„¿æ¥ï¼Ÿ</li>
<li>Traceä¿¡æ¯æ€ä¹ˆä¼ é€’ï¼Ÿ</li>
<li>é“¾è·¯ä¿¡æ¯å¦‚ä½•æœé›†ï¼Ÿ</li>
</ol>
<h5 id="parent-span-ä»å“ªå„¿æ¥é“¾è·¯ä»å“ªé‡Œå¼€å§‹">
  Parent-Span ä»å“ªå„¿æ¥ï¼Ÿé“¾è·¯ä»å“ªé‡Œå¼€å§‹ã€‚
  <a class="anchor" href="#parent-span-%e4%bb%8e%e5%93%aa%e5%84%bf%e6%9d%a5%e9%93%be%e8%b7%af%e4%bb%8e%e5%93%aa%e9%87%8c%e5%bc%80%e5%a7%8b">#</a>
</h5>
<p>åœ¨ä¸Šè¿°çš„å®è·µç›®æ ‡ä¸­ï¼Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ªå…¥å£æœåŠ¡ï¼Œé‚£ä¹ˆå¾ˆæ˜æ˜¾æ¯ä¸€æ¬¡çš„&quot;äº‹åŠ¡&quot;éƒ½æ˜¯åœ¨è¿™ä¸ªå…¥å£ï¼ˆhttp entryï¼‰å¼€å¯çš„ã€‚æˆ‘å†™äº†å¦‚ä¸‹çš„ä¸­é—´ä»¶ï¼ˆåŸºäºginï¼‰ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// è¿™ä¸ªå®šä¹‰æ˜¯å› ä¸ºopentracingæ²¡æœ‰å®šä¹‰è·å–traceId å’ŒspanIdçš„æ–¹æ³•ï¼Œè€Œæˆ‘åˆå®è·µäº† zipkin å’Œ jaeger
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">getTraceID</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">spCtx</span> <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">SpanContext</span>) <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// get trace info from header, if not then create an new one
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Opentracing</span>(<span style="color:#a6e22e">getTraceIdFromSpanContext</span> <span style="color:#a6e22e">getTraceID</span>) <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">HandlerFunc</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// prepare work ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        
</span></span><span style="display:flex;"><span>    	<span style="color:#75715e">// è¿™é‡Œé¦–å…ˆå°è¯•ä»å®¢æˆ·ç«¯è¯·æ±‚ä¸­è·å–åˆ°traceé“¾è·¯ä¿¡æ¯ï¼Œå¦‚æœè·å–åˆ°åˆ™åˆ›å»ºchild span.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">carrier</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">HTTPHeadersCarrier</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">Header</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">clientSpCtx</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tracer</span>.<span style="color:#a6e22e">Extract</span>(<span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">HTTPHeaders</span>, <span style="color:#a6e22e">carrier</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;could not extract trace data from http header, err=%v\n&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// derive a span or create an root span
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">sp</span> = <span style="color:#a6e22e">tracer</span>.<span style="color:#a6e22e">StartSpan</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">RequestURI</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">ChildOf</span>(<span style="color:#a6e22e">clientSpCtx</span>),
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">sp</span>.<span style="color:#a6e22e">Finish</span>()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// do some work
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å°†å«æœ‰spançš„ context.Context è®¾ç½®åˆ° gin.Context ç”¨äºä¼ é€’span
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">ctx</span> = <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">ContextWithSpan</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">Context</span>(), <span style="color:#a6e22e">sp</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#a6e22e">_traceContextKey</span>, <span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">traceId</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getTraceIdFromSpanContext</span>(<span style="color:#a6e22e">sp</span>.<span style="color:#a6e22e">Context</span>())
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Header</span>(<span style="color:#e6db74">&#34;X-Trace-Id&#34;</span>, <span style="color:#a6e22e">traceId</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// continue process request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Next</span>()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// do some work 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h5 id="child-spanä»€ä¹ˆæ—¶å€™åˆ›å»º">
  Child-Spanä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼Ÿ
  <a class="anchor" href="#child-span%e4%bb%80%e4%b9%88%e6%97%b6%e5%80%99%e5%88%9b%e5%bb%ba">#</a>
</h5>
<p>å…¶å®åœ¨ä¸Šè¿°çš„ä¸­é—´ä»¶é‡Œå·²ç»æœ‰äº†ä½“ç°ï¼ˆè·¨æœåŠ¡è°ƒç”¨æ—¶ï¼‰ã€‚è¿™é‡Œä¸»è¦æœ‰ä¸¤ç§åœºæ™¯ï¼š<code>è·¨æœåŠ¡è°ƒç”¨</code>ï¼Œ<code>æœåŠ¡å†…éƒ¨è°ƒ</code>ï¼Œè¿™ä¸¤ç§çš„åŒºåˆ«åœ¨äºæ˜¯å¦æ˜¯åŒä¸€ä¸ªè¿›ç¨‹ã€‚
é’ˆå¯¹è·¨æœåŠ¡è°ƒç”¨ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†gRPCæ¥é€šä¿¡ï¼Œé‚£ä¹ˆåˆ›å»ºçš„æ—¶æœºå°±åœ¨äºgRPCå®¢æˆ·ç«¯å‘èµ·è°ƒç”¨æ—¶ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªchildSpanå¹¶ä¼ é€’ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯éœ€è¦è§£æåˆ°è¯¥spanå¹¶åœ¨å½“æ¬¡è¯·æ±‚ä¸­ä½¿ç”¨ã€‚
è€Œå¯¹äºæœåŠ¡å†…éƒ¨çš„è°ƒç”¨ï¼Œç›¸è¾ƒè€Œè¨€ä¼šæ›´ç®€å•ä¸€ç‚¹ï¼Œç›´æ¥ä½¿ç”¨è¯¥spanåˆ›å»ºchildSpanå°±å¥½äº†ã€‚</p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€èˆ¬æ¥è¯´åœ¨Goå¼€å‘è¿‡ç¨‹ä¸­æ¨èä½¿ç”¨Contextä½œä¸ºå‡½æ•°è°ƒç”¨çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œopentracingä¹Ÿè€ƒè™‘äº†è¿™ä¸€ç‚¹ï¼Œå¦‚ä¸‹ï¼š
å®˜æ–¹æä¾›äº†å¯¹åº”çš„æ–¹æ³•ï¼Œæ¥å¸®åŠ©ä½¿ç”¨è€…æŠŠspanå’Œcontext.Contextä¸€èµ·ä½¿ç”¨ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ContextWithSpan returns a new `context.Context` that holds a reference to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// the span. If span is nil, a new context without an active span is returned.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ContextWithSpan</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">span</span> <span style="color:#a6e22e">Span</span>) <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">span</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tracerWithHook</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">span</span>.<span style="color:#a6e22e">Tracer</span>().(<span style="color:#a6e22e">TracerContextWithSpanExtension</span>); <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ctx</span> = <span style="color:#a6e22e">tracerWithHook</span>.<span style="color:#a6e22e">ContextWithSpanHook</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">span</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithValue</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">activeSpanKey</span>, <span style="color:#a6e22e">span</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// SpanFromContext returns the `Span` previously associated with `ctx`, or
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// `nil` if no such `Span` could be found.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// NOTE: context.Context != SpanContext: the former is Go&#39;s intra-process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// context propagation mechanism, and the latter houses OpenTracing&#39;s per-Span
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// identity and baggage information.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">SpanFromContext</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#a6e22e">Span</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">val</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Value</span>(<span style="color:#a6e22e">activeSpanKey</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sp</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">val</span>.(<span style="color:#a6e22e">Span</span>); <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">sp</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>åœ¨ä¸­é—´ä»¶é‚£é‡Œï¼Œæˆ‘ä»¬å·²ç»æŠŠ context.Context è®¾ç½®åˆ°äº† gin.Context ä¸­å»äº†ï¼Œå› æ­¤åœ¨åç»­çš„ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒä» gin.Context å–å‡ºå¹¶ä¼ é€’ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// traceHdl is a trace handler from HTTP request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">traceHdl</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// get root Context from request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// TODO: try to use c.Request.WithContext() to set context
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">GetTraceContextKey</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#e6db74">&#34;impossible&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ctxåœ¨æœåŠ¡å†…éƒ¨ä¼ é€’ï¼Œctxå«æœ‰spanä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientCall</span>(<span style="color:#a6e22e">ctx</span>.(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>)); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;message&#34;</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()})
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// response to client
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;traceHdl done&#34;</span>})
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">clientCall</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨äº†gRPCæ¥åšè·¨æœåŠ¡çš„è°ƒç”¨ï¼Œå¯¹äºctxçš„å¤„ç†ï¼Œæ˜¯é€šè¿‡interceptorå®ç°çš„ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// è¿™éƒ¨åˆ†ä»£ç ä¼šåœ¨åé¢è´´ä¸Šï¼Œä½†æ˜¯é€»è¾‘ä¹Ÿè·Ÿç±»ä¼¼ï¼Œåªæ˜¯å¤šäº†éœ€è¦é€‚é…gRPCæ•°æ®ä¼ é€’çš„è§„åˆ™ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">serverAConn</span>.<span style="color:#a6e22e">PingA</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">PingAReq</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Now</span>:  <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Unix</span>(),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">From</span>: <span style="color:#e6db74">&#34;client&#34;</span>,
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// è¿™é‡Œæ¼”ç¤ºè¿›ç¨‹å†…é“¾è·¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">processInternalTrace1</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// internal process trace example 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">processInternalTrace1</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ctx2</span>, <span style="color:#a6e22e">sp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">StartSpanFromContext</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">sp</span>.<span style="color:#a6e22e">Finish</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	println(<span style="color:#e6db74">&#34;processInternalTrace1 called&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// do some ops
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">processInternalTrace2</span>(<span style="color:#a6e22e">ctx2</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>gRPC interceptor å®ç°å¦‚ä¸‹ï¼šæœåŠ¡ç«¯å·¥ä½œå†…å®¹ç›¸ä¼¼ï¼Œåªæ˜¯ä»injectæ“ä½œå˜æˆäº†extractã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// client interceptor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">OpenTracingClientInterceptor</span>(<span style="color:#a6e22e">tracer</span> <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">Tracer</span>, <span style="color:#a6e22e">optFuncs</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">Option</span>) <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">UnaryClientInterceptor</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">otgrpcOpts</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newOptions</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">otgrpcOpts</span>.<span style="color:#a6e22e">apply</span>(<span style="color:#a6e22e">optFuncs</span><span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>,<span style="color:#a6e22e">m</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ethod</span> <span style="color:#66d9ef">string</span>, 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">resp</span> <span style="color:#66d9ef">interface</span>{}, 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">ClientConn</span>, 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">invoker</span> <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">UnaryInvoker</span>, 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">CallOption</span>,
</span></span><span style="display:flex;"><span>    ) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">parentCtx</span> <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">SpanContext</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">parent</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">SpanFromContext</span>(<span style="color:#a6e22e">ctx</span>); <span style="color:#a6e22e">parent</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">parentCtx</span> = <span style="color:#a6e22e">parent</span>.<span style="color:#a6e22e">Context</span>()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">clientSpan</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tracer</span>.<span style="color:#a6e22e">StartSpan</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">method</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">ChildOf</span>(<span style="color:#a6e22e">parentCtx</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ext</span>.<span style="color:#a6e22e">SpanKindRPCClient</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">gRPCComponentTag</span>,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">clientSpan</span>.<span style="color:#a6e22e">Finish</span>()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// æ³¨å…¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">ctx</span> = <span style="color:#a6e22e">injectSpanContext</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">tracer</span>, <span style="color:#a6e22e">clientSpan</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// è°ƒç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">invoker</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">method</span>, <span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">cc</span>, <span style="color:#a6e22e">opts</span><span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ...		
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span> 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">injectSpanContext</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">tracer</span> <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">Tracer</span>, <span style="color:#a6e22e">clientSpan</span> <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">Span</span>) <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">md</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">metadata</span>.<span style="color:#a6e22e">FromOutgoingContext</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">md</span> = <span style="color:#a6e22e">metadata</span>.<span style="color:#a6e22e">New</span>(<span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">md</span> = <span style="color:#a6e22e">md</span>.<span style="color:#a6e22e">Copy</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mdWriter</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">metadataReaderWriter</span>{<span style="color:#a6e22e">md</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tracer</span>.<span style="color:#a6e22e">Inject</span>(<span style="color:#a6e22e">clientSpan</span>.<span style="color:#a6e22e">Context</span>(), <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">HTTPHeaders</span>, <span style="color:#a6e22e">mdWriter</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// We have no better place to record an error than the Span itself :-/
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">clientSpan</span>.<span style="color:#a6e22e">LogFields</span>(<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;event&#34;</span>, <span style="color:#e6db74">&#34;Tracer.Inject() failed&#34;</span>), <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">metadata</span>.<span style="color:#a6e22e">NewOutgoingContext</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">md</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è‡³æ­¤æˆ‘ä»¬å°±ä»‹ç»å®Œäº†ï¼ŒæœåŠ¡é—´ï¼ˆgRPCï¼‰è°ƒç”¨å’ŒæœåŠ¡å†…ï¼ˆcontextï¼‰è°ƒç”¨çš„childSpançš„åˆ›å»ºå’Œä¼ é€’ã€‚</p>
<h5 id="é“¾è·¯tracerä»å“ªå„¿æ¥">
  é“¾è·¯Tracerä»å“ªå„¿æ¥ï¼Ÿ
  <a class="anchor" href="#%e9%93%be%e8%b7%aftracer%e4%bb%8e%e5%93%aa%e5%84%bf%e6%9d%a5">#</a>
</h5>
<p>å…ˆè¯´Traceræœ‰ä»€ä¹ˆç”¨ï¼ŒTraceræ˜¯ç”¨æ¥ç®¡ç†Spançš„ç»Ÿç­¹è€…ï¼Œè´Ÿè´£åˆ›å»ºspanå’Œä¼ æ’­spanã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Tracerè´Ÿè´£åˆ›å»ºspanå’Œä¼ æ’­span
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Tracer</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Create, start, and return a new Span with the given `operationName` and
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// incorporate the given StartSpanOption `opts`. (Note that `opts` borrows
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// from the &#34;functional options&#34; pattern, per
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// http://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// A Span with no SpanReference options (e.g., opentracing.ChildOf() or
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// opentracing.FollowsFrom()) becomes the root of its own trace.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// Examples:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//     var tracer opentracing.Tracer = ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//     // The root-span case:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//     sp := tracer.StartSpan(&#34;GetFeed&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//     // The vanilla child span case:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//     sp := tracer.StartSpan(
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//         &#34;GetFeed&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//         opentracing.ChildOf(parentSpan.Context()))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//     // All the bells and whistles:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//     sp := tracer.StartSpan(
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//         &#34;GetFeed&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//         opentracing.ChildOf(parentSpan.Context()),
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//         opentracing.Tag{&#34;user_agent&#34;, loggedReq.UserAgent},
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//         opentracing.StartTime(loggedReq.Timestamp),
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//     )
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">StartSpan</span>(<span style="color:#a6e22e">operationName</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">StartSpanOption</span>) <span style="color:#a6e22e">Span</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Inject() takes the `sm` SpanContext instance and injects it for
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// propagation within `carrier`. The actual type of `carrier` depends on
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// the value of `format`.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// OpenTracing defines a common set of `format` values (see BuiltinFormat),
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// and each has an expected carrier type.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// Other packages may declare their own `format` values, much like the keys
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// used by `context.Context` (see https://godoc.org/context#WithValue).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// Example usage (sans error handling):
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//     carrier := opentracing.HTTPHeadersCarrier(httpReq.Header)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//     err := tracer.Inject(
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//         span.Context(),
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//         opentracing.HTTPHeaders,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//         carrier)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// NOTE: All opentracing.Tracer implementations MUST support all
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// BuiltinFormats.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// Implementations may return opentracing.ErrUnsupportedFormat if `format`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// is not supported by (or not known by) the implementation.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// Implementations may return opentracing.ErrInvalidCarrier or any other
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// implementation-specific error if the format is supported but injection
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// fails anyway.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// See Tracer.Extract().
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Inject</span>(<span style="color:#a6e22e">sm</span> <span style="color:#a6e22e">SpanContext</span>, <span style="color:#a6e22e">format</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">carrier</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Extract() returns a SpanContext instance given `format` and `carrier`.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// OpenTracing defines a common set of `format` values (see BuiltinFormat),
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// and each has an expected carrier type.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// Other packages may declare their own `format` values, much like the keys
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// used by `context.Context` (see
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// https://godoc.org/golang.org/x/net/context#WithValue).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// Example usage (with StartSpan):
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//     carrier := opentracing.HTTPHeadersCarrier(httpReq.Header)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//     clientContext, err := tracer.Extract(opentracing.HTTPHeaders, carrier)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//     // ... assuming the ultimate goal here is to resume the trace with a
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//     // server-side Span:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//     var serverSpan opentracing.Span
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//     if err == nil {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//         span = tracer.StartSpan(
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//             rpcMethodName, ext.RPCServerOption(clientContext))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//     } else {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//         span = tracer.StartSpan(rpcMethodName)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//     }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// NOTE: All opentracing.Tracer implementations MUST support all
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// BuiltinFormats.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// Return values:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//  - A successful Extract returns a SpanContext instance and a nil error
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//  - If there was simply no SpanContext to extract in `carrier`, Extract()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//    returns (nil, opentracing.ErrSpanContextNotFound)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//  - If `format` is unsupported or unrecognized, Extract() returns (nil,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//    opentracing.ErrUnsupportedFormat)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//  - If there are more fundamental problems with the `carrier` object,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//    Extract() may return opentracing.ErrInvalidCarrier,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//    opentracing.ErrSpanContextCorrupted, or implementation-specific
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//    errors.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// See Tracer.Inject().
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Extract</span>(<span style="color:#a6e22e">format</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">carrier</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">SpanContext</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä¹‹å‰å·²ç»æåˆ°äº†äº†opentracingæ˜¯ä¸€å¥—æ¥å£ï¼Œé‚£ä¹ˆå…·ä½“çš„å®ç°æ˜¯åœ¨å…¶ä»–çš„å·¥å…·ä¸­å®Œæˆçš„ï¼Œå¦‚jaegerã€‚åˆ›å»ºçš„æ—¶å€™å°±éœ€è¦jaegerçš„æ”¯æŒäº†ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ä½¿ç”¨jaegeræ¥åˆ›å»ºä¸€ä¸ªtracerï¼Œå¹¶æ³¨å…¥åˆ°opentracingå…¨å±€ä¸­å»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BootTracerWrapper</span>(<span style="color:#a6e22e">localServiceName</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">hostPort</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">tracer</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">xjaeger</span>.<span style="color:#a6e22e">BootJaegerTracer</span>(<span style="color:#a6e22e">localServiceName</span>, <span style="color:#a6e22e">hostPort</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;BootTracerWrapper.BootZipkinTracer&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ³¨å…¥åˆ°å…¨å±€åï¼Œå°±å¯ä»¥é€šè¿‡ opentracing.GlobalTracer() æ¥ä½¿ç”¨ traceräº† 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">SetGlobalTracer</span>(<span style="color:#a6e22e">tracer</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BootJaegerTracer</span>(<span style="color:#a6e22e">localServiceName</span>, <span style="color:#a6e22e">hostPort</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">Tracer</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cfg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Configuration</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Sampler</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">SamplerConfig</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Type</span>:  <span style="color:#a6e22e">jaeger</span>.<span style="color:#a6e22e">SamplerTypeConst</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Param</span>: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ServiceName</span>: <span style="color:#a6e22e">localServiceName</span>, <span style="color:#75715e">// æœåŠ¡å
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Reporter</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ReporterConfig</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">LogSpans</span>:          <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">CollectorEndpoint</span>: <span style="color:#a6e22e">_jaegerRecorderEndpoint</span>,
</span></span><span style="display:flex;"><span>		}, <span style="color:#75715e">// é“¾è·¯æœé›†é…ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">tracer</span>, <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">NewTracer</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Logger</span>(<span style="color:#a6e22e">jaegerlog</span>.<span style="color:#a6e22e">StdLogger</span>),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ZipkinSharedRPCSpan</span>(<span style="color:#66d9ef">true</span>),
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;BootJaegerTracer&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">tracer</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h5 id="traceä¿¡æ¯æ€ä¹ˆä¼ é€’">
  Traceä¿¡æ¯æ€ä¹ˆä¼ é€’ï¼Ÿ
  <a class="anchor" href="#trace%e4%bf%a1%e6%81%af%e6%80%8e%e4%b9%88%e4%bc%a0%e9%80%92">#</a>
</h5>
<p>åœ¨ <a href="#Child-Span%e4%bb%80%e4%b9%88%e6%97%b6%e5%80%99%e5%88%9b%e5%bb%ba%ef%bc%9f">Child-Spanä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼Ÿ</a> ä¸­æåˆ°äº† <code>Inject</code>, <code>Extract</code> æ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•å°±æ˜¯ç”¨æ¥è¾…åŠ©Traceä¿¡æ¯ä¼ é€’çš„æ–¹æ³•ï¼Œ
å…·ä½“çš„å®ç°ä¹Ÿæ˜¯åœ¨jaegerä¸­å®ç°çš„ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ä»£ç ã€‚</p>
<h5 id="é“¾è·¯ä¿¡æ¯å¦‚ä½•æœé›†">
  é“¾è·¯ä¿¡æ¯å¦‚ä½•æœé›†ï¼Ÿ
  <a class="anchor" href="#%e9%93%be%e8%b7%af%e4%bf%a1%e6%81%af%e5%a6%82%e4%bd%95%e6%90%9c%e9%9b%86">#</a>
</h5>
<p>åœ¨ <a href="#%e9%93%be%e8%b7%afTracer%e4%bb%8e%e5%93%aa%e5%84%bf%e6%9d%a5%ef%bc%9f">#é“¾è·¯Tracerä»å“ªå„¿æ¥</a> å·²ç»æåˆ°äº†jaegeråœ¨åˆ›å»ºtraceræ—¶å¯ä»¥æŒ‡å®šæœé›†å™¨çš„é…ç½®ï¼Œ
å› æ­¤ä¸ŠæŠ¥åŠ¨ä½œä¼šåœ¨jaegerä¸­å®Œæˆï¼Œä½†æ˜¯è¦æ³¨æ„çš„æ˜¯ï¼Œæ˜¾å¼è°ƒç”¨ <code>sp.Finish()</code> æ‰ä¼šè§¦å‘ä¸ŠæŠ¥åŠ¨ä½œã€‚</p>
<h3 id="æ€»ç»“">
  æ€»ç»“
  <a class="anchor" href="#%e6%80%bb%e7%bb%93">#</a>
</h3>
<p>æœ€ç»ˆå®æˆ˜ç»“æœæˆªå›¾å¦‚ä¸‹ï¼š
å›¾ä¸­åŒ…å«äº†è°ƒç”¨é“¾è·¯å±‚çº§å…³ç³»ï¼Œæ¯ä¸ªç¯èŠ‚çš„è€—æ—¶æƒ…å†µï¼Œè¯·æ±‚çš„å…¥å‚å’Œç»“æœæ•°æ®ï¼ˆå¼‚å¸¸ä¿¡æ¯ï¼Œå¦‚æœ‰ï¼‰ç­‰ã€‚åŒæ—¶è¿˜æ”¯æŒè‡ªå®šä¹‰ï¼ˆTag å’Œ Annotation åŠŸèƒ½ï¼‰ï¼Œ
å¦‚æœè¿˜æƒ³è¦æ›´å¤šçš„ä¿¡æ¯ï¼Œé‚£ä¹ˆæ¨èä½¿ç”¨è¿™ä¸¤ä¸ªåŠŸèƒ½ç»„åˆæ¥æ»¡è¶³éœ€æ±‚ã€‚</p>
<img src="/images/tracing1_2.png" />
<p>å†å¤šçš„æ¡ˆä¾‹å’Œæ–‡æ¡£ï¼Œéƒ½æ²¡æœ‰è‡ªå·±ä¸Šæ‰‹å®è·µçš„æ•ˆæœå¥½ï¼Œå»ºè®®å®é™…è¿è¡Œå¹¶æŸ¥é˜…opentracingæºç ã€‚æ‰€æœ‰çš„ä»£ç å‡å¯åœ¨ <a href="https://github.com/yeqown/opentracing-practice">https://github.com/yeqown/opentracing-practice</a> ä¸­æ‰¾åˆ°ã€‚</p>
<blockquote>
<p>æ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿å‹˜è¯¯æŒ‡æ­£ğŸ™ã€‚</p>
</blockquote>
<h3 id="å‚è€ƒæ–‡çŒ®">
  å‚è€ƒæ–‡çŒ®
  <a class="anchor" href="#%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae">#</a>
</h3>
<ul>
<li><a href="https://opentracing.io/docs/overview/">https://opentracing.io/docs/overview/</a></li>
<li><a href="https://github.com/opentracing/opentracing-go">https://github.com/opentracing/opentracing-go</a></li>
<li><a href="https://github.com/uber/jaeger-client-go">https://github.com/uber/jaeger-client-go</a></li>
<li><a href="https://github.com/yeqown/opentracing-practice">https://github.com/yeqown/opentracing-practice</a></li>
</ul>
</div>
</article>


<section class="comment">
  <div id="gitalk-container"></div>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
  <script>
      const gitalk = new Gitalk({
          clientID: '7d8c8c91ae6aff3e46e7',
          clientSecret: '0f0f2ea4fb6eb3067955823f06286e7d88509b9f',
          repo: 'yeqown.github.io',
          owner: 'yeqown',
          admin: ['yeqown'],
          id: "opentracing-practice", 
          distractionFreeMode: false 
      });
      (function () {
          if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
              document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
              return;
          }
          gitalk.render('gitalk-container');
      })();
  </script>
</section>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">






<div class="flex align-center">
    <span id="busuanzi_container_site_pv" style="margin-right: 10px;">
        è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>
    </span>
    <span id="busuanzi_container_site_uv" style="margin-right: 10px;">
        è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>
    </span>
</div></div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#èƒŒæ™¯">èƒŒæ™¯</a></li>
        <li><a href="#opentracing">Opentracing</a></li>
        <li><a href="#å®æˆ˜">å®æˆ˜</a></li>
        <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
        <li><a href="#å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












