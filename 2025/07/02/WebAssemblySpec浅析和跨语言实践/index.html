<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="本文将深入浅出地分析 WebAssembly Spec 规范，介绍其设计思想和实现原理。同时，通过 Rust、Python、JavaScript 等语言的实践，探讨 WebAssembly 的“汇编”特性，并对其内存模型进行详细解读。">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="https://www.yeqown.xyz/2025/07/02/WebAssemblySpec%E6%B5%85%E6%9E%90%E5%92%8C%E8%B7%A8%E8%AF%AD%E8%A8%80%E5%AE%9E%E8%B7%B5/">
  <meta property="og:site_name" content="Yeqown">
  <meta property="og:title" content="WebAssembly Spec 浅析和跨语言实践">
  <meta property="og:description" content="本文将深入浅出地分析 WebAssembly Spec 规范，介绍其设计思想和实现原理。同时，通过 Rust、Python、JavaScript 等语言的实践，探讨 WebAssembly 的“汇编”特性，并对其内存模型进行详细解读。">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-07-02T09:45:48+08:00">
    <meta property="article:modified_time" content="2025-07-02T09:45:48+08:00">
    <meta property="article:tag" content="WebAssembly">
    <meta property="article:tag" content="Rust">
    <meta property="article:tag" content="Python">
    <meta property="article:tag" content="Javascript">
    <meta property="article:tag" content="WASM">
<title>WebAssembly Spec 浅析和跨语言实践 | Yeqown</title>
<link rel="icon" href="/favicon.png" >
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="https://www.yeqown.xyz/2025/07/02/WebAssemblySpec%E6%B5%85%E6%9E%90%E5%92%8C%E8%B7%A8%E8%AF%AD%E8%A8%80%E5%AE%9E%E8%B7%B5/">
<link rel="stylesheet" href="/book.min.c2fbf3db843e2f212ac724c116ea0973ae0c44d9926b1c14e16b29de812a6dc5.css" integrity="sha256-wvvz24Q&#43;LyEqxyTBFuoJc64MRNmSaxwU4Wsp3oEqbcU=" crossorigin="anonymous">
  <script defer src="/fuse.min.js"></script>
  <script defer src="/en.search.min.f17080086de35ea2d8ae7bbe8fd7dfab7183b485730a9353be99f4f0986495e5.js" integrity="sha256-8XCACG3jXqLYrnu&#43;j9ffq3GDtIVzCpNTvpn08JhkleU=" crossorigin="anonymous"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <meta name="referrer" content="no-referrer-when-downgrade"><!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>Yeqown</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>







  
<ul>
  
  <li>
    <a href="/categories"  target="_blank" rel="noopener">
        Categories
      </a>
  </li>
  
  <li>
    <a href="/tags"  target="_blank" rel="noopener">
        Tags
      </a>
  </li>
  
</ul>










  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/aboutme/" class="">About Me</a>
  

        </li>
      
    
  </ul>














</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>WebAssembly Spec 浅析和跨语言实践</h3>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#目的">目的</a></li>
    <li><a href="#核心概念">核心概念</a></li>
    <li><a href="#举例分析">举例分析</a>
      <ul>
        <li><a href="#整体结构">整体结构</a></li>
        <li><a href="#类型定义">类型定义</a></li>
        <li><a href="#函数定义">函数定义</a></li>
        <li><a href="#内存定义">内存定义</a></li>
        <li><a href="#全局变量定义">全局变量定义</a></li>
        <li><a href="#导出定义">导出定义</a></li>
        <li><a href="#小结">小结</a></li>
      </ul>
    </li>
    <li><a href="#线性内存">线性内存</a>
      <ul>
        <li><a href="#需求">需求</a></li>
        <li><a href="#rust-到-wasm">Rust 到 WASM</a></li>
        <li><a href="#在-python-中使用">在 python 中使用</a></li>
        <li><a href="#在-nodejs-中使用">在 NodeJS 中使用</a></li>
        <li><a href="#小结-1">小结</a></li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
<article class="markdown book-post">
  <h2>
    WebAssembly Spec 浅析和跨语言实践
  </h2>
  
  <div class="flex align-center text-small book-post-date">
    <img src="/svg/calendar.svg" class="book-icon " alt="" />
    <span>July 2, 2025</span>
  </div>



  
  <div class="text-small">
    
      <a href="/categories/%E6%80%BB%E7%BB%93/">总结</a>
  </div>
  

  
  <div class="text-small">
    
      <a href="/tags/WebAssembly/">WebAssembly</a>, 
      <a href="/tags/Rust/">Rust</a>, 
      <a href="/tags/python/">Python</a>, 
      <a href="/tags/Javascript/">Javascript</a>, 
      <a href="/tags/WASM/">WASM</a>
  </div>
  


  <div class="book-post-content"><blockquote>
<p>本文主要聚焦于 WebAssembly 的核心规范（Core Spec）部分。WASI 和 Embedder Spec 等其他部分并非本文的重点，感兴趣的读者可自行查阅相关资料。</p>
</blockquote>
<img src="/images/wasm/intro.png">
<h2 id="目的">
  目的
  <a class="anchor" href="#%e7%9b%ae%e7%9a%84">#</a>
</h2>
<p>随着 Web 技术的普及，越来越多的应用场景（如游戏、音视频处理、AI 等）需要在浏览器中运行。这些场景通常涉及 CPU 密集型任务，而现有 Web 引擎在处理此类任务时，性能仍不及原生语言。此外，C/C++ 等语言已积累了大量成熟的库，为了高效复用这些库以扩展 Web 的能力，急需一种新方式，使 C++/Rust 等语言也能在浏览器环境中运行。</p>
<p>为解决上述问题，W3C 提出了 WebAssembly 规范。该规范设计了一种全新的、与机器无关的汇编指令集、运行时（可理解为虚拟机）以及内存模型等。</p>
<p>WebAssembly 规范发布后，各大浏览器厂商迅速跟进支持，使其成为一种跨平台的二进制格式，能够在不同操作系统和硬件平台上运行。WASM 的应用范围也因此不再局限于 Web 场景，而是扩展到移动端、服务器端等领域。在云原生领域，Envoy、Kong 和 Apisix 等项目已支持 WASM 作为其扩展插件。WasmEdge 更进一步，直接提出将 WASM 应用于边缘计算场景，例如无服务器应用和函数即服务等。</p>
<h2 id="核心概念">
  核心概念
  <a class="anchor" href="#%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5">#</a>
</h2>
<p>在最新规范中，WebAssembly 定义了以下核心概念：</p>
<table>
  <thead>
      <tr>
          <th>概念</th>
          <th>解释说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>Values</strong></td>
          <td>提供四种基础数值类型：32位和64位的整型及浮点型。32位整型可用于表示布尔值或内存地址。另有128位扩展整型用于高精度计算。</td>
      </tr>
      <tr>
          <td><strong>Instructions</strong></td>
          <td>基于栈式虚拟机执行的指令，分为简单指令和控制指令两类。</td>
      </tr>
      <tr>
          <td><strong>Traps</strong></td>
          <td>类似异常机制，当发生非法操作（如越界访问）时立即中止执行并报告宿主环境。功能类似于Go/Rust中的panic。</td>
      </tr>
      <tr>
          <td><strong>Functions</strong></td>
          <td>与其他编程语言一致，用于组织特定功能的代码，接收参数并返回结果。</td>
      </tr>
      <tr>
          <td><strong>Tables</strong></td>
          <td>数据结构上是一个数组，用于存储特定类型（<code>funcref</code>和<code>externref</code>），可通过索引模拟函数指针。</td>
      </tr>
      <tr>
          <td><strong>Linear Memory</strong></td>
          <td>一段可动态增长的连续字节数组，程序可存储和加载其中任意位置的数据，越界访问会触发Trap。</td>
      </tr>
      <tr>
          <td><strong>Modules</strong></td>
          <td>包含类型、函数、表、内存和全局变量的定义，作为部署、加载和编译的基本单位。可声明导入导出项，并支持定义自动执行的启动函数。</td>
      </tr>
      <tr>
          <td><strong>Embedder</strong></td>
          <td>指将WebAssembly程序嵌入宿主环境的实现方式，如wasmtime或Web环境中的WebAssembly运行时。</td>
      </tr>
  </tbody>
</table>
<img src="/images/wasm/concepts.png">
<h2 id="举例分析">
  举例分析
  <a class="anchor" href="#%e4%b8%be%e4%be%8b%e5%88%86%e6%9e%90">#</a>
</h2>
<p>接下来，我们将结合一个简单的 WASM 程序来辅助理解 WebAssembly 规范的内容。这里使用 Rust 语言编写一个简单的加法程序，并将其编译为 WASM 模块：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#![no_std]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[unsafe(no_mangle)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">add</span>(left: <span style="color:#66d9ef">u64</span>, right: <span style="color:#66d9ef">u64</span>) -&gt; <span style="color:#66d9ef">u64</span> {
</span></span><span style="display:flex;"><span>    left <span style="color:#f92672">+</span> right
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[unsafe(no_mangle)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">subtract</span>(left: <span style="color:#66d9ef">u32</span>, right: <span style="color:#66d9ef">u32</span>) -&gt; <span style="color:#66d9ef">u32</span> {
</span></span><span style="display:flex;"><span>    left <span style="color:#f92672">-</span> right
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>通过 <a href="https://wasmtime.dev/">wasmtime</a> 这样的工具可以方便的调用 wasm 模块，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt;&gt;&gt; wasmtime --invoke add ./wasm_demo.wasm <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span>
</span></span></code></pre></div><blockquote>
<p>编译生成的 wasm 可以使用 wasm2wat 将二进制格式转为 <code>WAT</code> 文本格式，方便查看和分析。
<code>wasm2wat wasm_demo.wasm -o wasm_demo.wat</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>module $wasm_demo.wasm
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">(</span>type <span style="color:#f92672">(</span>;0;<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>func <span style="color:#f92672">(</span>param i64 i64<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>result i64<span style="color:#f92672">)))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">(</span>type <span style="color:#f92672">(</span>;1;<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>func <span style="color:#f92672">(</span>param i32 i32<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>result i32<span style="color:#f92672">)))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">(</span>func $add <span style="color:#f92672">(</span>type 0<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>param i64 i64<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>result i64<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    local.get <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    local.get <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    i64.add<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">(</span>func $subtract <span style="color:#f92672">(</span>type 1<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>param i32 i32<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>result i32<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    local.get <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    local.get <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    i32.sub<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">(</span>memory <span style="color:#f92672">(</span>;0;<span style="color:#f92672">)</span> 16<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">(</span>global $__stack_pointer <span style="color:#f92672">(</span>mut i32<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>i32.const 1048576<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">(</span>global <span style="color:#f92672">(</span>;1;<span style="color:#f92672">)</span> i32 <span style="color:#f92672">(</span>i32.const 1048576<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">(</span>global <span style="color:#f92672">(</span>;2;<span style="color:#f92672">)</span> i32 <span style="color:#f92672">(</span>i32.const 1048576<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">(</span>export <span style="color:#e6db74">&#34;memory&#34;</span> <span style="color:#f92672">(</span>memory 0<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">(</span>export <span style="color:#e6db74">&#34;add&#34;</span> <span style="color:#f92672">(</span>func $add<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">(</span>export <span style="color:#e6db74">&#34;subtract&#34;</span> <span style="color:#f92672">(</span>func $subtract<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">(</span>export <span style="color:#e6db74">&#34;__data_end&#34;</span> <span style="color:#f92672">(</span>global 1<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">(</span>export <span style="color:#e6db74">&#34;__heap_base&#34;</span> <span style="color:#f92672">(</span>global 2<span style="color:#f92672">)))</span>
</span></span></code></pre></div><h3 id="整体结构">
  整体结构
  <a class="anchor" href="#%e6%95%b4%e4%bd%93%e7%bb%93%e6%9e%84">#</a>
</h3>
<p>WAT 文件以 (module &hellip;) 开头，它定义了一个 WebAssembly 模块。模块是 WebAssembly 的基本封装单元，包含类型、函数、内存、全局变量等元素。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>module $wasm_demo.wasm
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p><code>$wasm_demo.wasm</code> 是模块的可选名称，用于在调试或引用时标识该模块。</p>
<h3 id="类型定义">
  类型定义
  <a class="anchor" href="#%e7%b1%bb%e5%9e%8b%e5%ae%9a%e4%b9%89">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>type <span style="color:#f92672">(</span>;0;<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>func <span style="color:#f92672">(</span>param i64 i64<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>result i64<span style="color:#f92672">)))</span>
</span></span></code></pre></div><p><code>(type ...)</code> 用于定义函数类型。<br>
<code>(;0;)</code> 是类型的索引，这里表示该类型的索引为 0。<br>
<code>(func (param i64 i64) (result i64))</code> 定义了一个函数类型，该函数接受两个 64 位整数（i64）作为参数，并返回一个 64 位整数。</p>
<blockquote>
<p>可以看到这里有两个函数类型定义，但是如果 <code>add</code> 和 <code>subtract</code> 的函数签名改成一致的，这里就可以只定义一个函数类型。</p>
</blockquote>
<h3 id="函数定义">
  函数定义
  <a class="anchor" href="#%e5%87%bd%e6%95%b0%e5%ae%9a%e4%b9%89">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>func $add <span style="color:#f92672">(</span>type 0<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>param i64 i64<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>result i64<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  local.get <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  local.get <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  i64.add<span style="color:#f92672">)</span>
</span></span></code></pre></div><p><code>(func ...)</code> 用于定义函数。<br>
<code>$add</code> 是函数的名称，用于在其他地方引用该函数。<br>
<code>(type 0)</code> 表示该函数的类型为索引为 0 的类型。<br>
<code>(param i64 i64)</code> 定义了两个 64 位整数参数。<br>
<code>(result i64)</code> 表示函数返回一个 64 位整数。<br>
函数体由指令序列组成，这里使用了 <code>local.get</code> 和 <code>i64.add</code> 指令。</p>
<h3 id="内存定义">
  内存定义
  <a class="anchor" href="#%e5%86%85%e5%ad%98%e5%ae%9a%e4%b9%89">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>memory <span style="color:#f92672">(</span>;0;<span style="color:#f92672">)</span> 16<span style="color:#f92672">)</span>
</span></span></code></pre></div><p><code>(memory ...)</code> 用于定义内存。<br>
<code>(;0;)</code> 是内存的索引，这里表示该内存的索引为 0。<br>
<code>16</code> 表示内存的初始页数为 16 页，每页大小为 64KB, 所以初始内存大小为 16 * 64KB = 1024KB。</p>
<h3 id="全局变量定义">
  全局变量定义
  <a class="anchor" href="#%e5%85%a8%e5%b1%80%e5%8f%98%e9%87%8f%e5%ae%9a%e4%b9%89">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>global $__stack_pointer <span style="color:#f92672">(</span>mut i32<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>i32.const 1048576<span style="color:#f92672">))</span>
</span></span></code></pre></div><p><code>(global ...)</code> 用于定义全局变量。<br>
<code>$__stack_pointer</code> 是全局变量的名称。<br>
<code>(mut i32)</code> 表示该全局变量为可变的 32 位整数类型。<br>
<code>(i32.const 1048576)</code> 表示初始值为 1048576 的 32 位整数。</p>
<h3 id="导出定义">
  导出定义
  <a class="anchor" href="#%e5%af%bc%e5%87%ba%e5%ae%9a%e4%b9%89">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>export <span style="color:#e6db74">&#34;memory&#34;</span> <span style="color:#f92672">(</span>memory 0<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>export <span style="color:#e6db74">&#34;add&#34;</span> <span style="color:#f92672">(</span>func $add<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>export <span style="color:#e6db74">&#34;subtract&#34;</span> <span style="color:#f92672">(</span>func $subtract<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>export <span style="color:#e6db74">&#34;__data_end&#34;</span> <span style="color:#f92672">(</span>global 1<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>export <span style="color:#e6db74">&#34;__heap_base&#34;</span> <span style="color:#f92672">(</span>global 2<span style="color:#f92672">))</span>
</span></span></code></pre></div><p><code>(export ...)</code> 用于定义导出项。<br>
<code>&quot;memory&quot;</code> 是导出项的名称，用于在其他地方引用该内存。<br>
<code>(memory 0)</code> 表示导出索引为 0 的内存区域。</p>
<p>至于函数和全局变量的导出，也是类似的定义方式，这里就不一一列出了。</p>
<h3 id="小结">
  小结
  <a class="anchor" href="#%e5%b0%8f%e7%bb%93">#</a>
</h3>
<p>WebAssembly，顾名思义，是一种汇编语言，它定义了非常底层的指令。但与传统汇编不同的是，其指令不依赖于具体的 CPU（宿主环境）。同时，它不仅是语言规范，还提供了一些与宿主环境（尤其是 Web 和 JavaScript 宿主环境）交互的约定。</p>
<p>由此可见，WebAssembly 需要的是一个运行时支持，而这个运行时支持可以是一个嵌入某种语言的虚拟机，也可以是一个 docker 容器，也可以在裸机上运行。就像解释型语言一样，需要一个 “解释器” 来执行 WASM 模块中的指令。</p>
<p>目前，WebAssembly 还在不断发展，例如 WASI (WebAssembly System Interface) 和 WASM Component Model 等更丰富的特性也已相继推出。</p>
<p>这一小节通过从打包的 Module 出发，转换为 WAT 格式并逐个理解，虽然没有列举 Spec 中全部内容，但足以对 WebAssembly 的核心概念形成基本的认识。</p>
<h2 id="线性内存">
  线性内存
  <a class="anchor" href="#%e7%ba%bf%e6%80%a7%e5%86%85%e5%ad%98">#</a>
</h2>
<p>通过前面的示例，我们得以窥见 WebAssembly 的大致结构和概念。至于其详细指令，作为使用者我们通常无需深究，我们更关注如何编写 WASM 模块、如何在不同语言的宿主环境中运行，以及如何在宿主环境与 WASM 模块之间进行数据传输。</p>
<p>由于 WebAssembly 没有提供复杂的数据类型，当宿主环境和 WASM 模块需要传输复杂数据时，我们就需要利用 WASM 提供的线性内存进行数据交互。</p>
<blockquote>
<p>复杂数据结构包括：数组、字符串、结构体、联合体、枚举等。</p>
</blockquote>
<p>这里我们将以最简单的字符串为例，演示宿主环境和 WASM 模块如何通过线性内存进行字符串交互。</p>
<h3 id="需求">
  需求
  <a class="anchor" href="#%e9%9c%80%e6%b1%82">#</a>
</h3>
<p>假设我们使用 Rust 实现了一个为 JSON 字符串动态添加字段的 WASM 模块，现在想要在 python 和 javascript 中调用该功能。</p>
<h3 id="rust-到-wasm">
  Rust 到 WASM
  <a class="anchor" href="#rust-%e5%88%b0-wasm">#</a>
</h3>
<p>在 Rust 中，我们需要实现一个 <code>allocate</code> 函数，用于在 WASM 内存中分配一段空间。同时，我们还需要实现一个 <code>deallocate</code> 函数，用于释放之前分配的内存，并将这两个函数导出，以便在其他语言中调用。</p>
<p>至于怎么为 JSON 字符串动态添加字段，我们可以使用 serde_json 库来进行 JSON 字符串的解析和序列化。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[no_mangle]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">allocate</span>(size: <span style="color:#66d9ef">usize</span>) -&gt; <span style="color:#f92672">*</span><span style="color:#66d9ef">mut</span> <span style="color:#66d9ef">u8</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> buffer <span style="color:#f92672">=</span> Vec::with_capacity(size);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> ptr <span style="color:#f92672">=</span> buffer.as_mut_ptr();
</span></span><span style="display:flex;"><span>    core::mem::forget(buffer); <span style="color:#75715e">// 阻止 Vec 在这里被 Drop
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ptr
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[no_mangle]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">deallocate</span>(ptr: <span style="color:#f92672">*</span><span style="color:#66d9ef">mut</span> <span style="color:#66d9ef">u8</span>, capacity: <span style="color:#66d9ef">usize</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsafe</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> _ <span style="color:#f92672">=</span> Vec::from_raw_parts(ptr, <span style="color:#ae81ff">0</span>, capacity);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[no_mangle]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">json_add_field</span>(
</span></span><span style="display:flex;"><span>    json_ptr: <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">u8</span>,
</span></span><span style="display:flex;"><span>    json_len: <span style="color:#66d9ef">usize</span>,
</span></span><span style="display:flex;"><span>    field_ptr: <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">u8</span>,
</span></span><span style="display:flex;"><span>    field_len: <span style="color:#66d9ef">usize</span>,
</span></span><span style="display:flex;"><span>) -&gt; <span style="color:#66d9ef">u64</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 加载 host 传入的字符串，并解析
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> json_bytes <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> { slice::from_raw_parts(json_ptr, json_len) };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> field_bytes <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> { slice::from_raw_parts(field_ptr, field_len) };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> json_value: <span style="color:#a6e22e">serde_json</span>::Value <span style="color:#f92672">=</span> <span style="color:#66d9ef">match</span> serde_json::from_slice(json_bytes) {
</span></span><span style="display:flex;"><span>        Ok(v) <span style="color:#f92672">=&gt;</span> v,
</span></span><span style="display:flex;"><span>        Err(_) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>, <span style="color:#75715e">// 错误处理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> field_value: <span style="color:#a6e22e">serde_json</span>::Value <span style="color:#f92672">=</span> <span style="color:#66d9ef">match</span> serde_json::from_slice(field_bytes) {
</span></span><span style="display:flex;"><span>        Ok(v) <span style="color:#f92672">=&gt;</span> v,
</span></span><span style="display:flex;"><span>        Err(_) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>, <span style="color:#75715e">// 错误处理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 执行添加字段的逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> (Some(obj), Some(field_obj)) <span style="color:#f92672">=</span> (json_value.as_object_mut(), field_value.as_object()) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (k, v) <span style="color:#66d9ef">in</span> field_obj {
</span></span><span style="display:flex;"><span>            obj.insert(k.clone(), v.clone());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将修改后的 JSON 序列化回字符串
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> result_json <span style="color:#f92672">=</span> <span style="color:#66d9ef">match</span> serde_json::to_string(<span style="color:#f92672">&amp;</span>json_value) {
</span></span><span style="display:flex;"><span>        Ok(s) <span style="color:#f92672">=&gt;</span> s,
</span></span><span style="display:flex;"><span>        Err(_) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>, <span style="color:#75715e">// 错误处理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将结果字符串转换为字节向量并获取指针和长度
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> result_bytes <span style="color:#f92672">=</span> result_json.into_bytes();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> len <span style="color:#f92672">=</span> result_bytes.len();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> ptr <span style="color:#f92672">=</span> result_bytes.as_mut_ptr() <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">u64</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 泄漏内存，以便 Host 可以访问它
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    core::mem::forget(result_bytes);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将长度和指针打包成一个 u64 返回
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 长度放在高 32 位，指针放在低 32 位
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// Q: WASM 支持 multi-value 返回，RUST 如何使用这个特性呢？
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    (len <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">u64</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">32</span> <span style="color:#f92672">|</span> ptr
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="在-python-中使用">
  在 python 中使用
  <a class="anchor" href="#%e5%9c%a8-python-%e4%b8%ad%e4%bd%bf%e7%94%a8">#</a>
</h3>
<p>在 python 中，我们可以使用 wasmtime 库来加载和运行 WASM 模块。运行效果如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ python run.py 
</span></span><span style="display:flex;"><span>Initial JSON: <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Alice&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span>: 30<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>Adding Fields: <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;city&#34;</span>: <span style="color:#e6db74">&#34;New York&#34;</span>, <span style="color:#e6db74">&#34;occupation&#34;</span>: <span style="color:#e6db74">&#34;Engineer&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>Modified JSON: <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;age&#34;</span>:30,<span style="color:#e6db74">&#34;city&#34;</span>:<span style="color:#e6db74">&#34;New York&#34;</span>,<span style="color:#e6db74">&#34;name&#34;</span>:<span style="color:#e6db74">&#34;Alice&#34;</span>,<span style="color:#e6db74">&#34;occupation&#34;</span>:<span style="color:#e6db74">&#34;Engineer&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>store <span style="color:#f92672">=</span> wasmtime<span style="color:#f92672">.</span>Store()
</span></span><span style="display:flex;"><span>module <span style="color:#f92672">=</span> wasmtime<span style="color:#f92672">.</span>Module<span style="color:#f92672">.</span>from_file(store<span style="color:#f92672">.</span>engine, <span style="color:#e6db74">&#34;wasms/rust.wasm&#34;</span>)
</span></span><span style="display:flex;"><span>instance <span style="color:#f92672">=</span> wasmtime<span style="color:#f92672">.</span>Instance(store, module, [])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取 WASM 中的导出</span>
</span></span><span style="display:flex;"><span>exports <span style="color:#f92672">=</span> instance<span style="color:#f92672">.</span>exports(store)
</span></span><span style="display:flex;"><span>wasm_memory <span style="color:#f92672">=</span> exports[<span style="color:#e6db74">&#34;memory&#34;</span>]
</span></span><span style="display:flex;"><span>wasm_allocate <span style="color:#f92672">=</span> exports[<span style="color:#e6db74">&#34;allocate&#34;</span>]
</span></span><span style="display:flex;"><span>wasm_deallocate <span style="color:#f92672">=</span> exports[<span style="color:#e6db74">&#34;deallocate&#34;</span>]
</span></span><span style="display:flex;"><span>wasm_json_add_field <span style="color:#f92672">=</span> exports[<span style="color:#e6db74">&#34;json_add_field&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">rust_string_to_python</span>(ptr, length):
</span></span><span style="display:flex;"><span>    data_bytes <span style="color:#f92672">=</span> wasm_memory<span style="color:#f92672">.</span>read(store, ptr, ptr <span style="color:#f92672">+</span> length)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> data_bytes<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">python_string_to_wasm</span>(s: str) <span style="color:#f92672">-&gt;</span> tuple[int, int]:
</span></span><span style="display:flex;"><span>    s_bytes <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)
</span></span><span style="display:flex;"><span>    s_len <span style="color:#f92672">=</span> len(s_bytes)
</span></span><span style="display:flex;"><span>    s_ptr <span style="color:#f92672">=</span> wasm_allocate(store, s_len)
</span></span><span style="display:flex;"><span>    wasm_memory<span style="color:#f92672">.</span>write(store, s_bytes, s_ptr)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> s_ptr, s_len
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_json_with_wasm</span>(original_json: str, field_to_add: str) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>    json_ptr, json_len <span style="color:#f92672">=</span> python_string_to_wasm(original_json)
</span></span><span style="display:flex;"><span>    field_ptr, field_len <span style="color:#f92672">=</span> python_string_to_wasm(field_to_add)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 调用函数</span>
</span></span><span style="display:flex;"><span>    result_u64 <span style="color:#f92672">=</span> wasm_json_add_field(store, json_ptr, json_len, field_ptr, field_len)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 释放 WASM 中的内存</span>
</span></span><span style="display:flex;"><span>    wasm_deallocate(store, json_ptr, json_len)
</span></span><span style="display:flex;"><span>    wasm_deallocate(store, field_ptr, field_len)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 解析 WASM 函数返回的指针和长度</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> result_u64 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#34;Wasm function returned an error (0)&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    result_len <span style="color:#f92672">=</span> result_u64 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>    result_ptr <span style="color:#f92672">=</span> result_u64 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFFFFFF</span>
</span></span><span style="display:flex;"><span>    result_json_str <span style="color:#f92672">=</span> rust_string_to_python(result_ptr, result_len)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 在 Rust 这部分内存是没有被释放的，需要手动释放</span>
</span></span><span style="display:flex;"><span>    wasm_deallocate(store, result_ptr, result_len)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> result_json_str
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    initial_json <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;{&#34;name&#34;: &#34;Alice&#34;, &#34;age&#34;: 30}&#39;</span>
</span></span><span style="display:flex;"><span>    new_field <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;{&#34;city&#34;: &#34;New York&#34;, &#34;occupation&#34;: &#34;Engineer&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>    modified_json <span style="color:#f92672">=</span> process_json_with_wasm(initial_json, new_field)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Modified JSON: </span><span style="color:#e6db74">{</span>modified_json<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><h3 id="在-nodejs-中使用">
  在 NodeJS 中使用
  <a class="anchor" href="#%e5%9c%a8-nodejs-%e4%b8%ad%e4%bd%bf%e7%94%a8">#</a>
</h3>
<p>在 NodeJS 中已经自带了 WebAssembly 模块，我们可以直接使用。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">runWasm</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 1. 读取 Wasm 模块的二进制数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">wasmPath</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">join</span>(<span style="color:#a6e22e">__dirname</span>, <span style="color:#e6db74">&#39;wasms&#39;</span>, <span style="color:#e6db74">&#39;rust.wasm&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">wasmBytes</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">readFileSync</span>(<span style="color:#a6e22e">wasmPath</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 2. 创建 WebAssembly 内存实例
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// initial: 初始内存页数 (1页 = 64KB)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// maximum: 最大内存页数 (可选，但推荐设置，防止内存无限增长)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">memory</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">Memory</span>({ <span style="color:#a6e22e">initial</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">maximum</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">16</span> }); <span style="color:#75715e">// 1页 = 64KB
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 3. 自定义定义导入对象 (imports object)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">importObject</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">env</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">memory</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">memory</span>,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 4. 实例化 Wasm 模块
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">wasm</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">instantiate</span>(<span style="color:#a6e22e">wasmBytes</span>, <span style="color:#a6e22e">importObject</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">wasm</span>.<span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 5. 获取导出的函数和内存
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">wasmAllocate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">allocate</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">wasmDeallocate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">deallocate</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">wasmJsonAddField</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">json_add_field</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">wasmMemory</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">memory</span>; <span style="color:#75715e">// 直接获取导出的内存对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">writeStringToWasm</span>(<span style="color:#a6e22e">jsString</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">encoder</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">TextEncoder</span>(<span style="color:#e6db74">&#39;utf-8&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">encodedBytes</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">encoder</span>.<span style="color:#a6e22e">encode</span>(<span style="color:#a6e22e">jsString</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">byteLength</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">encodedBytes</span>.<span style="color:#a6e22e">length</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ptr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">wasmAllocate</span>(<span style="color:#a6e22e">byteLength</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">wasmByteView</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint8Array</span>(<span style="color:#a6e22e">wasmMemory</span>.<span style="color:#a6e22e">buffer</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">wasmByteView</span>.<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">encodedBytes</span>, <span style="color:#a6e22e">ptr</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">ptr</span>, <span style="color:#a6e22e">len</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">byteLength</span> };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">readStringFromWasm</span>(<span style="color:#a6e22e">ptr</span>, <span style="color:#a6e22e">len</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">wasmByteView</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint8Array</span>(<span style="color:#a6e22e">wasmMemory</span>.<span style="color:#a6e22e">buffer</span>, <span style="color:#a6e22e">ptr</span>, <span style="color:#a6e22e">len</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">decoder</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">TextDecoder</span>(<span style="color:#e6db74">&#39;utf-8&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">decoder</span>.<span style="color:#a6e22e">decode</span>(<span style="color:#a6e22e">wasmByteView</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">initialJson</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;{&#34;name&#34;: &#34;Alice&#34;, &#34;age&#34;: 30}&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">newField</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;{&#34;city&#34;: &#34;New York&#34;, &#34;occupation&#34;: &#34;Engineer&#34;}&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Initial JSON: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">initialJson</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Field to add: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">newField</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 写入原始 JSON 字符串到 Wasm 内存
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">ptr</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">jsonPtr</span>, <span style="color:#a6e22e">len</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">jsonLen</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">writeStringToWasm</span>(<span style="color:#a6e22e">initialJson</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 写入要添加的字段 JSON 字符串到 Wasm 内存
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">ptr</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">fieldPtr</span>, <span style="color:#a6e22e">len</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">fieldLen</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">writeStringToWasm</span>(<span style="color:#a6e22e">newField</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 调用 Wasm 函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// Rust 函数返回一个 u64，高 32 位是长度，低 32 位是指针
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">resultU64</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">wasmJsonAddField</span>(<span style="color:#a6e22e">jsonPtr</span>, <span style="color:#a6e22e">jsonLen</span>, <span style="color:#a6e22e">fieldPtr</span>, <span style="color:#a6e22e">fieldLen</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 释放输入字符串的 Wasm 内存
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">wasmDeallocate</span>(<span style="color:#a6e22e">jsonPtr</span>, <span style="color:#a6e22e">jsonLen</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">wasmDeallocate</span>(<span style="color:#a6e22e">fieldPtr</span>, <span style="color:#a6e22e">fieldLen</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">resultU64</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Wasm function returned an error (0)&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 从 u64 中解析指针和长度
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">resultLen</span> <span style="color:#f92672">=</span> Number(<span style="color:#a6e22e">resultU64</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">32</span><span style="color:#a6e22e">n</span>); <span style="color:#75715e">// 使用 BigInt 操作 u64
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">resultPtr</span> <span style="color:#f92672">=</span> Number(<span style="color:#a6e22e">resultU64</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFFFFFF</span><span style="color:#a6e22e">n</span>); <span style="color:#75715e">// 使用 BigInt 操作 u64
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 从 Wasm 内存中读取结果字符串
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">modifiedJson</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">readStringFromWasm</span>(<span style="color:#a6e22e">resultPtr</span>, <span style="color:#a6e22e">resultLen</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Modified JSON: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">modifiedJson</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 释放 Wasm 模块分配的内存
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">wasmDeallocate</span>(<span style="color:#a6e22e">resultPtr</span>, <span style="color:#a6e22e">resultLen</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;Got JSON:&#34;</span>, <span style="color:#a6e22e">expectedJsonDict</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">e</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">`An error occurred: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">message</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">runWasm</span>();
</span></span></code></pre></div><p>整体交互流程上与 python 大同小异。</p>
<h3 id="小结-1">
  小结
  <a class="anchor" href="#%e5%b0%8f%e7%bb%93-1">#</a>
</h3>
<blockquote>
<p>全部代码可以在 <a href="https://github.com/yeqown/wasm-demo">https://github.com/yeqown/wasm-demo</a> 找到。</p>
</blockquote>
<p>简而言之，WASM 内存允许开发者自行管理内存，而不依赖于宿主环境的内存管理机制。虽然诸如 wasm-bindgen 这样的工具可以实现 Rust 到 JavaScript 的绑定，但若需支持其他语言，其能力则有所局限。</p>
<p>然而，一旦理解了其底层原理，即使是更高级的数据结构，也能够自行封装实现。</p>
<blockquote>
<p>🤣 这仿佛又回到了 C 语言手动内存管理的时代。</p>
</blockquote>
<h2 id="参考">
  参考
  <a class="anchor" href="#%e5%8f%82%e8%80%83">#</a>
</h2>
<ul>
<li><a href="https://webassembly.github.io/spec/core/">WebAssembly 规范</a></li>
<li><a href="https://webassembly.github.io/spec/core/appendix/index-instructions.html">WebAssembly 指令索引</a></li>
<li><a href="https://webassembly.github.io/spec/core/appendix/index-types.html">WebAssembly 类型索引</a></li>
<li><a href="https://webassembly.github.io/spec/core/text/index.html">WebAssembly 文本格式</a></li>
</ul>
</div>
</article>


<section class="comment">
  <div id="gitalk-container"></div>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
  <script>
      const gitalk = new Gitalk({
          clientID: '7d8c8c91ae6aff3e46e7',
          clientSecret: '0f0f2ea4fb6eb3067955823f06286e7d88509b9f',
          repo: 'yeqown.github.io',
          owner: 'yeqown',
          admin: ['yeqown'],
          id: "", 
          distractionFreeMode: false 
      });
      (function () {
          if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
              document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
              return;
          }
          gitalk.render('gitalk-container');
      })();
  </script>
</section>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">






<div class="flex align-center">
    <span id="busuanzi_container_site_pv" style="margin-right: 10px;">
        访问量<span id="busuanzi_value_site_pv"></span>
    </span>
    <span id="busuanzi_container_site_uv" style="margin-right: 10px;">
        访客数<span id="busuanzi_value_site_uv"></span>
    </span>
</div></div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#目的">目的</a></li>
    <li><a href="#核心概念">核心概念</a></li>
    <li><a href="#举例分析">举例分析</a>
      <ul>
        <li><a href="#整体结构">整体结构</a></li>
        <li><a href="#类型定义">类型定义</a></li>
        <li><a href="#函数定义">函数定义</a></li>
        <li><a href="#内存定义">内存定义</a></li>
        <li><a href="#全局变量定义">全局变量定义</a></li>
        <li><a href="#导出定义">导出定义</a></li>
        <li><a href="#小结">小结</a></li>
      </ul>
    </li>
    <li><a href="#线性内存">线性内存</a>
      <ul>
        <li><a href="#需求">需求</a></li>
        <li><a href="#rust-到-wasm">Rust 到 WASM</a></li>
        <li><a href="#在-python-中使用">在 python 中使用</a></li>
        <li><a href="#在-nodejs-中使用">在 NodeJS 中使用</a></li>
        <li><a href="#小结-1">小结</a></li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












