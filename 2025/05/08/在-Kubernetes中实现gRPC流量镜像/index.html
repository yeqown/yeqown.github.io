<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="è¿™é‡Œä»‹ç»åœ¨ Kubernetes ä¸­å¯¹æ–°æ—§æœåŠ¡è¿›è¡Œ gRPC æµé‡çš„å¤åˆ¶å’Œé‡æ”¾ï¼Œå¹¶å¯¹æ¯”æ–°æ—§æœåŠ¡çš„å“åº”å†…å®¹ã€‚grpcreplayæ˜¯ä¸€æ¬¾å¼€æºçš„ gRPC æµé‡è§£æå’Œé‡æ”¾å·¥å…·ï¼Œå®ƒå¯ä»¥åœ¨ä¸ä¿®æ”¹åº”ç”¨ä»£ç çš„æƒ…å†µä¸‹ï¼Œå¯¹gRPCæµé‡è¿›è¡Œé•œåƒå’Œé‡æ”¾ã€‚è€Œ Istio åˆ™æ˜¯ä¸€ä¸ªéå¸¸æˆç†Ÿçš„ Service Mesh è§£å†³æ–¹æ¡ˆï¼Œå®ƒå¯ä»¥åœ¨ä¸ä¿®æ”¹åº”ç”¨ä»£ç çš„æƒ…å†µä¸‹ï¼Œå¯¹ gRPC æµé‡è¿›è¡Œé•œåƒå’Œé‡æ”¾ã€‚">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="https://www.yeqown.xyz/2025/05/08/%E5%9C%A8-Kubernetes%E4%B8%AD%E5%AE%9E%E7%8E%B0gRPC%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F/">
  <meta property="og:site_name" content="Yeqown">
  <meta property="og:title" content="åœ¨ Kubernetes ä¸­å®ç° gRPC æµé‡çš„é•œåƒå’Œå¯¹æ¯”">
  <meta property="og:description" content="è¿™é‡Œä»‹ç»åœ¨ Kubernetes ä¸­å¯¹æ–°æ—§æœåŠ¡è¿›è¡Œ gRPC æµé‡çš„å¤åˆ¶å’Œé‡æ”¾ï¼Œå¹¶å¯¹æ¯”æ–°æ—§æœåŠ¡çš„å“åº”å†…å®¹ã€‚grpcreplayæ˜¯ä¸€æ¬¾å¼€æºçš„ gRPC æµé‡è§£æå’Œé‡æ”¾å·¥å…·ï¼Œå®ƒå¯ä»¥åœ¨ä¸ä¿®æ”¹åº”ç”¨ä»£ç çš„æƒ…å†µä¸‹ï¼Œå¯¹gRPCæµé‡è¿›è¡Œé•œåƒå’Œé‡æ”¾ã€‚è€Œ Istio åˆ™æ˜¯ä¸€ä¸ªéå¸¸æˆç†Ÿçš„ Service Mesh è§£å†³æ–¹æ¡ˆï¼Œå®ƒå¯ä»¥åœ¨ä¸ä¿®æ”¹åº”ç”¨ä»£ç çš„æƒ…å†µä¸‹ï¼Œå¯¹ gRPC æµé‡è¿›è¡Œé•œåƒå’Œé‡æ”¾ã€‚">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-05-08T09:35:14+08:00">
    <meta property="article:modified_time" content="2025-05-08T09:35:14+08:00">
    <meta property="article:tag" content="Kubernetes">
    <meta property="article:tag" content="GRPC">
    <meta property="article:tag" content="Traffic Mirror">
    <meta property="article:tag" content="Grpcreplay">
    <meta property="article:tag" content="Sidecar">
    <meta property="article:tag" content="Istio">
<title>åœ¨ Kubernetes ä¸­å®ç° gRPC æµé‡çš„é•œåƒå’Œå¯¹æ¯” | Yeqown</title>
<link rel="icon" href="/favicon.png" >
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="https://www.yeqown.xyz/2025/05/08/%E5%9C%A8-Kubernetes%E4%B8%AD%E5%AE%9E%E7%8E%B0gRPC%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F/">
<link rel="stylesheet" href="/book.min.c2fbf3db843e2f212ac724c116ea0973ae0c44d9926b1c14e16b29de812a6dc5.css" integrity="sha256-wvvz24Q&#43;LyEqxyTBFuoJc64MRNmSaxwU4Wsp3oEqbcU=" crossorigin="anonymous">
  <script defer src="/fuse.min.js"></script>
  <script defer src="/en.search.min.f17080086de35ea2d8ae7bbe8fd7dfab7183b485730a9353be99f4f0986495e5.js" integrity="sha256-8XCACG3jXqLYrnu&#43;j9ffq3GDtIVzCpNTvpn08JhkleU=" crossorigin="anonymous"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <meta name="referrer" content="no-referrer-when-downgrade"><!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>Yeqown</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>







  
<ul>
  
  <li>
    <a href="/categories"  target="_blank" rel="noopener">
        Categories
      </a>
  </li>
  
  <li>
    <a href="/tags"  target="_blank" rel="noopener">
        Tags
      </a>
  </li>
  
</ul>










  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/aboutme/" class="">About Me</a>
  

        </li>
      
    
  </ul>














</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>åœ¨ Kubernetes ä¸­å®ç° gRPC æµé‡çš„é•œåƒå’Œå¯¹æ¯”</h3>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#åœºæ™¯æè¿°">åœºæ™¯æè¿°</a></li>
    <li><a href="#æ–¹æ¡ˆä»‹ç»">æ–¹æ¡ˆä»‹ç»</a>
      <ul>
        <li><a href="#kubernetes-ä¸­çš„-sidecar">Kubernetes ä¸­çš„ sidecar</a></li>
        <li><a href="#grpcreplay-ç®€ä»‹">grpcreplay ç®€ä»‹</a></li>
      </ul>
    </li>
    <li><a href="#å®è·µ1-grpcreplay-sidecar">å®è·µ1: grpcreplay sidecar</a>
      <ul>
        <li><a href="#æ¶æ„è®¾è®¡">æ¶æ„è®¾è®¡</a></li>
        <li><a href="#é•œåƒæ‰“åŒ…">é•œåƒæ‰“åŒ…</a></li>
        <li><a href="#æ·»åŠ -pvc">æ·»åŠ  PVC</a></li>
        <li><a href="#é…ç½®-sidecar-grpcreplay">é…ç½® Sidecar: grpcreplay</a></li>
        <li><a href="#è¸©å‘è®°å½•">è¸©å‘è®°å½•</a></li>
      </ul>
    </li>
    <li><a href="#å®è·µ2-istio-virtualservice-mirror">å®è·µ2: Istio VirtualService mirror</a>
      <ul>
        <li><a href="#é…ç½®æºæœåŠ¡-virtualservice">é…ç½®æºæœåŠ¡ VirtualService</a></li>
        <li><a href="#è¸©å‘è®°å½•-1">è¸©å‘è®°å½•</a></li>
        <li><a href="#ç¼–å†™-gprc-interceptor">ç¼–å†™ gPRC interceptor</a></li>
      </ul>
    </li>
    <li><a href="#å¯¹æ¯”è„šæœ¬">å¯¹æ¯”è„šæœ¬</a></li>
    <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
<article class="markdown book-post">
  <h2>
    åœ¨ Kubernetes ä¸­å®ç° gRPC æµé‡çš„é•œåƒå’Œå¯¹æ¯”
  </h2>
  
  <div class="flex align-center text-small book-post-date">
    <img src="/svg/calendar.svg" class="book-icon " alt="" />
    <span>May 8, 2025</span>
  </div>



  
  <div class="text-small">
    
      <a href="/categories/Kubernetes/">Kubernetes</a>
  </div>
  

  
  <div class="text-small">
    
      <a href="/tags/Kubernetes/">Kubernetes</a>, 
      <a href="/tags/gRPC/">GRPC</a>, 
      <a href="/tags/traffic-mirror/">Traffic Mirror</a>, 
      <a href="/tags/grpcreplay/">Grpcreplay</a>, 
      <a href="/tags/sidecar/">Sidecar</a>, 
      <a href="/tags/Istio/">Istio</a>
  </div>
  


  <div class="book-post-content"><p>æœ¬æ–‡ä¸»è¦è§£å†³åœ¨æœåŠ¡é‡æ„è¿‡ç¨‹ä¸­å¦‚ä½•ä¿è¯æ–°æ—§æœåŠ¡è¡Œä¸ºä¸€è‡´æ€§çš„é—®é¢˜ã€‚</p>
<h2 id="åœºæ™¯æè¿°">
  åœºæ™¯æè¿°
  <a class="anchor" href="#%e5%9c%ba%e6%99%af%e6%8f%8f%e8%bf%b0">#</a>
</h2>
<p>ç°æœ‰ä¸€ä¸ª python å¼€å‘çš„ gRPC å¾®æœåŠ¡æä¾›äº†ä¸€äº› <strong>æ•°æ®æŸ¥è¯¢</strong> æ¥å£ ä¾› ä¸Šå±‚åº”ç”¨ä½¿ç”¨ï¼Œéšç€ä¸šåŠ¡æµé‡çš„å¢åŠ è¿ç»´è¿™ä¸ªæœåŠ¡çš„æˆæœ¬ä¹Ÿé€æ¸å¢åŠ ï¼Œä¸ºäº†é™ä½è¿ç»´æˆæœ¬å’Œæé«˜æ€§èƒ½ (æœ¨æœ‰æ“…é•¿ python é«˜æ€§èƒ½çš„å¼€å‘)ï¼Œå› æ­¤é€‰æ‹©äº†ä½¿ç”¨ go è¯­è¨€å¯¹è¿™ä¸ªæœåŠ¡è¿›è¡Œé‡å†™ã€‚åœ¨å¼€å‘å®Œæˆä¹‹åï¼Œéœ€è¦å¯¹æ–°æœåŠ¡çš„ gRPC æ¥å£è¿›è¡ŒéªŒè¯ã€‚</p>
<p>è¿™ç§åœºæ™¯å¯¹æµ‹è¯•å¼€å‘äººå‘˜æ¥è¯´ï¼Œå®åœ¨æ˜¯å¤ªç†Ÿæ‚‰äº†å§ï¼Ÿå…¸å‹çš„ <strong>é‡æ”¾éªŒè¯</strong>ï¼Œé©¬ä¸Šèƒ½æƒ³åˆ°çš„éªŒè¯æ‰‹æ®µå°±æ˜¯ï¼š</p>
<ol>
<li>å¦‚æœæœ‰å­˜é‡çš„å•å…ƒæµ‹è¯•ï¼Œé‚£ä¹ˆç›´æ¥é‡æ–°è·‘ä¸€éå•å…ƒæµ‹è¯•å°±èƒ½å¿«é€Ÿçš„å®ŒæˆéªŒè¯ã€‚</li>
<li>æ²¡æœ‰å•å…ƒæµ‹è¯•çš„æƒ…å†µï¼Œé‚£ä¹ˆå¯ä»¥å°†æ–°æœåŠ¡éƒ¨ç½²èµ·æ¥ï¼Œé€šè¿‡æµé‡å¤åˆ¶çš„æ–¹å¼å°†æ—§æœåŠ¡çš„æµé‡å¤åˆ¶åˆ°æ–°æœåŠ¡ä¸Šï¼Œç„¶åå¯¹æ¯”ä¸¤ä¸ªæœåŠ¡çš„è¿”å›ç»“æœæ˜¯å¦ä¸€è‡´ã€‚</li>
</ol>


<script src="/mermaid.min.js"></script>

  <script>mermaid.initialize({
  "flowchart": {
    "useMaxWidth":true
  },
  "theme": "default"
}
)</script>




<pre class="mermaid">
flowchart LR
    %% å®šä¹‰å¸ƒå±€æ–¹å‘å’Œé—´è·
    subgraph s1["æ–¹æ¡ˆä¸€: å•å…ƒæµ‹è¯•éªŒè¯"]
        direction TB
        UT[å•å…ƒæµ‹è¯•] -->|æ‰§è¡Œ| NS1[æ–°æœåŠ¡]
    end
    
    subgraph s2["æ–¹æ¡ˆäºŒ: æµé‡å¤åˆ¶éªŒè¯"]
        direction TB
        C[å®¢æˆ·ç«¯] -->|è¯·æ±‚| OS[æ—§æœåŠ¡]
        OS -->|å“åº”| C
        OS -->|å¤åˆ¶æµé‡| NS2[æ–°æœåŠ¡]
        NS2 -->|å¯¹æ¯”å“åº”| OS
    end

    %% è®¾ç½®å¸ƒå±€æ–¹å‘å’Œå¯¹é½æ–¹å¼
    s1 ~~~ s2
</pre>

<p>ä½†æ˜¯å¾ˆé—æ†¾ ğŸ˜­ï¼Œå¹¶æ²¡æœ‰æˆç†Ÿçš„å•å…ƒæµ‹è¯•ï¼›æµ‹è¯•äººå‘˜ä¹Ÿéƒ½æ˜¯äººè‚‰æµ‹è¯•ï¼Œå¯¹äºå†…éƒ¨æœåŠ¡çš„æ¥å£éªŒè¯å¸®åŠ©ä¸å¤§ï¼Œå› æ­¤è¿™é‡Œé‡‡ç”¨ç¬¬äºŒç§æ–¹å¼è¿›è¡ŒéªŒè¯ã€‚</p>
<blockquote>
<p>æœåŠ¡å‡é‡‡ç”¨ Kubernetes éƒ¨ç½²ã€‚</p>
</blockquote>
<h2 id="æ–¹æ¡ˆä»‹ç»">
  æ–¹æ¡ˆä»‹ç»
  <a class="anchor" href="#%e6%96%b9%e6%a1%88%e4%bb%8b%e7%bb%8d">#</a>
</h2>
<p>HTTP æµé‡çš„å¤åˆ¶é‡æ”¾å·¥å…·å°±å¾ˆå¤šå¾ˆæˆç†Ÿäº†ï¼Œè€Œä¸”å¾€å¾€åœ¨ ç½‘å…³/ä»£ç† ä¸€ä¾§å°±èƒ½å®ç°æµé‡å¤åˆ¶ç”šè‡³å¯¹æ¯”ã€‚</p>
<table>
  <thead>
      <tr>
          <th>å·¥å…·</th>
          <th>åˆ†ç±»</th>
          <th>æ–‡æ¡£é“¾æ¥</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Nginx mirror</td>
          <td>ç½‘å…³/ä»£ç†</td>
          <td><a href="https://nginx.org/en/docs/http/ngx_http_mirror_module.html">https://nginx.org/en/docs/http/ngx_http_mirror_module.html</a></td>
      </tr>
      <tr>
          <td>APISIX</td>
          <td>ç½‘å…³/ä»£ç†</td>
          <td><a href="https://apisix.apache.org/docs/apisix/plugins/proxy-mirror/">https://apisix.apache.org/docs/apisix/plugins/proxy-mirror/</a></td>
      </tr>
      <tr>
          <td>Istio: Virtual Service mirror</td>
          <td>Service Mesh</td>
          <td><a href="https://istio.io/latest/docs/tasks/traffic-management/mirroring/">https://istio.io/latest/docs/tasks/traffic-management/mirroring/</a></td>
      </tr>
      <tr>
          <td>GoReplay</td>
          <td>æµé‡é•œåƒ</td>
          <td><a href="https://github.com/buger/goreplay">https://github.com/buger/goreplay</a></td>
      </tr>
      <tr>
          <td>tcpcopy</td>
          <td>æµé‡é•œåƒ</td>
          <td><a href="https://github.com/session-replay-tools/tcpcopy">https://github.com/session-replay-tools/tcpcopy</a></td>
      </tr>
  </tbody>
</table>
<blockquote>
<p>tcpcopy ç›¸æ¯”äºå…¶ä»–å·¥å…·æ–¹æ¡ˆï¼Œè™½ç„¶ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œä½†æ˜¯å…¶ä½œç”¨äº TCP ä¼ è¾“å±‚ï¼ŒåŠŸèƒ½ä¼šæ›´ä¸°å¯Œã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒgRPC æµé‡å¤åˆ¶å·¥å…·å°±æ²¡æœ‰é‚£ä¹ˆæˆç†Ÿäº†ã€‚</p>
</blockquote>
<p>ç”±äºè¿™é‡Œæ˜¯ä¸€ä¸ª Kubernetes gRPC å¾®æœåŠ¡ï¼Œå¯ä»¥æƒ³åˆ°çš„å°±æ˜¯ä½¿ç”¨ sidecar å®¹å™¨çš„æ–¹å¼æ¥å®ç°æµé‡é•œåƒï¼Œå¹¶è®°å½•åˆ°æœ¬åœ°æ–‡ä»¶ä¸­ï¼Œç„¶åé€šè¿‡å¯¹æ¯”è„šæœ¬æ¥å¯¹æ¯”æ–°æ—§æœåŠ¡çš„å“åº”å†…å®¹ã€‚</p>
<figure>
  <img src="/images/grpcr-k8s/architecture0.png" alt="k8s-grpcr-sidecar" width="100%" />
  <figcaption>Mirror and Compare flow</figcaption>
</figure>
<h3 id="kubernetes-ä¸­çš„-sidecar">
  Kubernetes ä¸­çš„ sidecar
  <a class="anchor" href="#kubernetes-%e4%b8%ad%e7%9a%84-sidecar">#</a>
</h3>
<p>Kubenetes ä¸­çš„ sidecar æ˜¯æŒ‡åœ¨åº”ç”¨å®¹å™¨ä¹‹å¤–ï¼Œéƒ¨ç½²ä¸€ä¸ªç‹¬ç«‹çš„å®¹å™¨ï¼Œç”¨äºå¤„ç†åº”ç”¨å®¹å™¨çš„è¯·æ±‚å’Œå“åº”ã€‚sidecar å®¹å™¨å’Œåº”ç”¨å®¹å™¨å…±äº«åŒä¸€ä¸ªç½‘ç»œå‘½åç©ºé—´ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ localhost æ¥è¿›è¡Œé€šä¿¡ã€‚</p>
<p>å› æ­¤ä¸ç®¡æ˜¯ä½¿ç”¨ Istio è¿˜æ˜¯ grpcreplayï¼Œéƒ½éœ€è¦åœ¨åº”ç”¨å®¹å™¨ä¹‹å¤–éƒ¨ç½²ä¸€ä¸ª sidecar å®¹å™¨ã€‚åªä¸è¿‡ä¸¤ä¸ªå®¹å™¨çš„ä½œç”¨åŸç†ä¸ç›¸åŒï¼Œgrpcreplay ä¸€ä¸ªæ˜¯é€šè¿‡å—…æ¢ç½‘ç»œåè®®æ ˆä¸Šçš„ gRPC æµé‡ï¼Œå°†è¿™éƒ¨åˆ†æ•°æ®æŠ¥æ–‡è§£æå†ä½¿ç”¨ï¼›è€Œ Istio åˆ™æ˜¯æ¥ç®¡äº†åº”ç”¨å®¹å™¨çš„è¯·æ±‚å’Œå“åº”ï¼Œç„¶åå°†æµé‡å¤åˆ¶åˆ°æ–°çš„æœåŠ¡ä¸Šã€‚</p>
<h3 id="grpcreplay-ç®€ä»‹">
  grpcreplay ç®€ä»‹
  <a class="anchor" href="#grpcreplay-%e7%ae%80%e4%bb%8b">#</a>
</h3>
<p><a href="https://github.com/vearne/grpcreplay">grpcreplay</a> æ˜¯ä¸€æ¬¾å¼€æºçš„ gRPC æµé‡è§£æå’Œé‡æ”¾å·¥å…·ï¼Œå®ƒç±»ä¼¼äº goreplay éƒ½æ˜¯é€šè¿‡æŠ“åŒ…å®ç°æµé‡çš„å¤åˆ¶ï¼Œè€Œä¸æ˜¯ä»£ç†çš„æ–¹å¼ã€‚å¦å¤–å®ƒè¿˜æ”¯æŒå¤šç§è¾“å…¥è¾“å‡ºï¼ŒåŒ…æ‹¬æ–‡ä»¶ã€ç½‘å¡ã€æ¶ˆæ¯é˜Ÿåˆ—ã€æ ‡å‡†è¾“å…¥è¾“å‡ºç­‰ã€‚å½“ç„¶ä¹Ÿæœ‰ä¸€äº›é™åˆ¶:</p>
<ul>
<li>ç›®å‰æ”¯æŒåˆ° h2c æš‚ä¸æ”¯æŒ h2</li>
<li>åºåˆ—åŒ–å™¨æ”¯æŒ protobuf</li>
<li>ä¸æ”¯æŒ Streaming</li>
</ul>
<blockquote>
<p><em><strong>h2c</strong></em> æŒ‡çš„æ˜¯ HTTP/2 over TCPï¼Œ<em><strong>h2</strong></em> æŒ‡çš„æ˜¯ HTTP/2 over TLS/SSLã€‚</p>
</blockquote>
<details ><summary>grpcr help message</summary>
  <div class="markdown-inner">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ grpcreplay -h
</span></span><span style="display:flex;"><span>   ______ ____   ____   ______ ____
</span></span><span style="display:flex;"><span>  / ____// __ <span style="color:#ae81ff">\ </span>/ __ <span style="color:#ae81ff">\ </span>/ ____// __ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> / / __ / /_/ // /_/ // /    / /_/ /
</span></span><span style="display:flex;"><span>/ /_/ // _, _// ____// /___ / _, _/
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">\_</span>___//_/ |_|/_/     <span style="color:#ae81ff">\_</span>___//_/ |_|
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage of grpcreplay:
</span></span><span style="display:flex;"><span>  -codec string
</span></span><span style="display:flex;"><span>    	 <span style="color:#f92672">(</span>default <span style="color:#e6db74">&#34;simple&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  -exit-after duration
</span></span><span style="display:flex;"><span>    	exit after specified duration
</span></span><span style="display:flex;"><span>  -include-filter-method-match string
</span></span><span style="display:flex;"><span>    	filter requests when the method matches the specified regular expression
</span></span><span style="display:flex;"><span>  -input-file-directory value
</span></span><span style="display:flex;"><span>    	grpcr --input-file-directory<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/tmp/mycapture&#34;</span> --output-grpc<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;grpc://xx.xx.xx.xx:35001â€œ (default [])
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -input-file-read-depth int
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    	 (default 100)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -input-file-replay-speed float
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    	 (default 1)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -input-raw value
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    	Capture traffic from given port (use RAW sockets and require *sudo* access):
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    	                # Capture traffic from 80 port
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    	                grpcr --input-raw=&#34;</span>0.0.0.0:80<span style="color:#e6db74">&#34; --output-grpc=&#34;</span>grpc://xx.xx.xx.xx:35001<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    	                (default [])
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -input-rocketmq-access-key string
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -input-rocketmq-group-name string
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    	 (default &#34;</span>fakeGroupName<span style="color:#e6db74">&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -input-rocketmq-name-server value
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    	grpcr --input-rocketmq-name-server=&#34;</span>192.168.2.100:9876<span style="color:#e6db74">&#34; --output-grpc=&#34;</span>grpc://xx.xx.xx.xx:35001<span style="color:#e6db74">&#34; (default [])
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -input-rocketmq-secret-key string
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -input-rocketmq-topic string
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    	 (default &#34;</span>test<span style="color:#e6db74">&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -output-file-directory value
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    	Write incoming requests to file:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    			        grpcr --input-raw=&#34;</span>0.0.0.0:80<span style="color:#e6db74">&#34; --output-file-directory=&#34;</span>/tmp/mycapture<span style="color:#e6db74">&#34; (default [])
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -output-file-max-age int
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    	MaxAge is the maximum number of days to retain old log files
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    					based on the timestamp encoded in their filename (default 30)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -output-file-max-backups int
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    	MaxBackups is the maximum number of old log files to retain. (default 10)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -output-file-max-size int
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    	MaxSize is the maximum size in megabytes of the log file before it gets rotated. (default 500)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -output-grpc value
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    	Forwards incoming requests to given grpc address.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    				    # Redirect all incoming requests to xxx.com address
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    	                grpcr --input-raw=&#34;</span>0.0.0.0:80<span style="color:#e6db74">&#34; --output-grpc=&#34;</span>grpc://xx.xx.xx.xx:35001<span style="color:#e6db74">&#34;) (default [])
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -output-grpc-worker-number int
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    	multiple workers call services concurrently (default 5)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -output-rocketmq-access-key string
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -output-rocketmq-name-server value
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    	grpcr --input-raw=&#34;</span>0.0.0.0:80<span style="color:#e6db74">&#34; --output-rocketmq-name-server=&#34;</span>192.168.2.100:9876<span style="color:#e6db74">&#34; (default [])
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -output-rocketmq-secret-key string
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -output-rocketmq-topic string
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    	 (default &#34;</span>test<span style="color:#e6db74">&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -output-stdout
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    	Just prints data to console
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -rate-limit-qps int
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    	the capture rate per second limit for Query (default -1)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -record-response
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    	record response
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -version
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    	print version
</span></span></span></code></pre></div>  </div>
</details>
<h2 id="å®è·µ1-grpcreplay-sidecar">
  å®è·µ1: grpcreplay sidecar
  <a class="anchor" href="#%e5%ae%9e%e8%b7%b51-grpcreplay-sidecar">#</a>
</h2>
<p>æƒ³è¦æŠŠ grpcreplay æƒ³è¦ä½œä¸º sidecar å®¹å™¨éƒ¨ç½²åœ¨ Kubernetes ä¸­ï¼Œè¿™é‡Œéœ€è¦åšçš„å·¥ä½œæœ‰ï¼š</p>
<ol>
<li>grpcreplay é•œåƒæ‰“åŒ…å¹¶æ¨é€åˆ°é•œåƒä»“åº“</li>
<li>æ·»åŠ  PVC ä»¥å­˜å‚¨ grpcreplay çš„æµé‡æ•°æ®</li>
<li>ä¿®æ”¹æ–°æ—§æœåŠ¡çš„ Deployment ä»¥é…ç½® sidecar å®¹å™¨ã€‚</li>
</ol>
<h3 id="æ¶æ„è®¾è®¡">
  æ¶æ„è®¾è®¡
  <a class="anchor" href="#%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1">#</a>
</h3>
<p>å›¾ä»¥è”½ä¹‹ï¼š</p>
<figure>
  <img src="/images/grpcr-k8s/architecture.png" alt="k8s-grpcr-sidecar" width="100%" />
  <figcaption>æ¶æ„æè¿°</figcaption>
</figure>
<h3 id="é•œåƒæ‰“åŒ…">
  é•œåƒæ‰“åŒ…
  <a class="anchor" href="#%e9%95%9c%e5%83%8f%e6%89%93%e5%8c%85">#</a>
</h3>
<p>æå‰å°† grpcreplay æºç ä¸‹è½½åˆ°æœ¬åœ°ï¼Œç„¶åç¼–å†™ Dockerfile è¿›è¡Œæ„å»ºã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> golang:1.23.6 AS builder</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /go/src/github.com/vearne/grpcreplay/</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> . /go/src/github.com/vearne/grpcreplay/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># å®‰è£…ä¾èµ–</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt-get update <span style="color:#f92672">&amp;&amp;</span> apt-get install -y libpcap-dev<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> go get<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># æ„å»ºåº”ç”¨</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> CGO_ENABLED<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> go build -ldflags <span style="color:#e6db74">&#34;-s -w&#34;</span> -o grpcr<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºå‡å°é•œåƒå¤§å°</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> debian:bookworm-slim</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># å®‰è£…è¿è¡Œæ—¶ä¾èµ–</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt-get update <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apt-get install -y libpcap0.8 <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apt-get clean <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    rm -rf /var/lib/apt/lists/*<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># ä»æ„å»ºé˜¶æ®µå¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>builder /go/src/github.com/vearne/grpcreplay/grpcr /app/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># è®¾ç½®å®¹å™¨å…¥å£ç‚¹</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;/app/grpcr&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># æ„å»ºé•œåƒ</span>
</span></span><span style="display:flex;"><span>podman build --platform linux/amd64 --rm -t grpcr -f Dockerfile .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¿®æ”¹é•œåƒæ ‡ç­¾</span>
</span></span><span style="display:flex;"><span>podman tag grpcr yeqown/grpcr:v0.2.6
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ¨é€åˆ° hub.docker.com é•œåƒä»“åº“ https://hub.docker.com/repository/docker/yeqown/grpcr</span>
</span></span><span style="display:flex;"><span>podman push yeqown/grpcr:v0.2.6
</span></span></code></pre></div><h3 id="æ·»åŠ -pvc">
  æ·»åŠ  PVC
  <a class="anchor" href="#%e6%b7%bb%e5%8a%a0-pvc">#</a>
</h3>
<blockquote>
<p>è¿™é‡Œä»…ä¾›å‚è€ƒï¼Œä¹Ÿä¸æ˜¯å¿…è¦çš„æ­¥éª¤ï¼Œåªè¦èƒ½ç»™ POD æŒ‚è½½ä¸€ä¸ª PV å³å¯ã€‚</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">grpc-capture-pvc</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">spec</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ReadWriteMany </span> <span style="color:#75715e"># å¤šä¸ªPodéœ€è¦åŒæ—¶è®¿é—®</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">10Gi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">YOUR_STORAGE_CLASS_NAME </span> <span style="color:#75715e"># æ›¿æ¢ä¸ºä½ çš„å­˜å‚¨ç±»åç§°</span>
</span></span></code></pre></div><h3 id="é…ç½®-sidecar-grpcreplay">
  é…ç½® Sidecar: grpcreplay
  <a class="anchor" href="#%e9%85%8d%e7%bd%ae-sidecar-grpcreplay">#</a>
</h3>
<p>é…ç½®æ–°æ—§æœåŠ¡çš„ Deployment æ–‡ä»¶ä»¥é…ç½® sidecar å®¹å™¨ã€‚åŒæ ·çš„è¿™é‡Œä»¥å®é™…æƒ…å†µä¸ºå‡†</p>
<p><em><strong>æ—§æœåŠ¡ï¼š</strong></em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: Deployment
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: old-grpc
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    app: old-grpc
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  replicas: 1
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    matchLabels:
</span></span><span style="display:flex;"><span>      app: old-grpc
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        app: old-grpc
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: old-grpc
</span></span><span style="display:flex;"><span>        image: your-registry/old-grpc:latest
</span></span><span style="display:flex;"><span>        ports:
</span></span><span style="display:flex;"><span>        - containerPort: 50051  # gRPCæœåŠ¡ç«¯å£
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">+      # grpcreplay sidecarå®¹å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+      - name: grpcreplay
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        image: docker.io/yeqown/grpcr:v0.2.6
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        securityContext:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+          capabilities:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+            add: [&#34;NET_ADMIN&#34;, &#34;NET_RAW&#34;]  # éœ€è¦è¿™äº›æƒé™æ¥æ•è·ç½‘ç»œæµé‡
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        args:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        - &#34;--input-raw=0.0.0.0:50051&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        - &#34;--output-grpc=grpc://new-grpc:50051&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        - &#34;--output-file-directory=/capture/server&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        - &#34;--record-response&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        - &#34;--codec=json&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        volumeMounts:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        - name: capture-volume
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+          mountPath: /capture/server
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+      volumes:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+      - name: capture-volume
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        persistentVolumeClaim:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+          claimName: grpc-capture-pvc
</span></span></span></code></pre></div><p><em><strong>æ–°æœåŠ¡ï¼š</strong></em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: Deployment
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: new-grpc
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    app: new-grpc
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  replicas: 1
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    matchLabels:
</span></span><span style="display:flex;"><span>      app: new-grpc
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        app: new-grpc
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: new-grpc
</span></span><span style="display:flex;"><span>        image: your-registry/new-grpc:latest
</span></span><span style="display:flex;"><span>        ports:
</span></span><span style="display:flex;"><span>        - containerPort: 50051  # gRPCæœåŠ¡ç«¯å£    
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">+      # grpcreplay sidecarå®¹å™¨ï¼ˆå¯é€‰ï¼Œç”¨äºè®°å½•è¯·æ±‚å’Œå“åº”ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+      - name: grpcreplay
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        image: docker.io/yeqown/grpcr:v0.2.6
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        securityContext:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+          capabilities:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+            add: [&#34;NET_ADMIN&#34;, &#34;NET_RAW&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        args:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        - &#34;--input-raw=0.0.0.0:50051&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        - &#34;--output-stdout&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        - &#34;--output-file-directory=/capture/mirror&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        - &#34;--record-response&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        - &#34;--codec=json&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        volumeMounts:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        - name: capture-volume
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+          mountPath: /capture/mirror
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+      
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+      volumes:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+      - name: capture-volume
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        persistentVolumeClaim:
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+          claimName: grpc-capture-pvc
</span></span></span></code></pre></div><p>æœåŠ¡å¯åŠ¨åï¼Œä¼šåœ¨ <code>/capture/server</code> å’Œ <code>/capture/mirror</code> ç›®å½•ä¸‹ç”Ÿæˆ grpcreplay çš„æµé‡æ•°æ®ã€‚</p>
<figure>
  <img src="/images/grpcr-k8s/capture-log.png" alt="k8s-grpcr-sidecar" width="100%" />
  <figcaption>grpcreplay æµé‡æ•°æ®</figcaption>
</figure>
<h3 id="è¸©å‘è®°å½•">
  è¸©å‘è®°å½•
  <a class="anchor" href="#%e8%b8%a9%e5%9d%91%e8%ae%b0%e5%bd%95">#</a>
</h3>
<p>ä½¿ç”¨ grpcreplay ä½œä¸º sidecar å®¹å™¨éƒ¨ç½²åœ¨ Kubernetes ä¸­åï¼Œç»è¿‡ä¸€æ®µæ—¶é—´åï¼Œå‘ç°è®°å½•çš„æ–‡ä»¶ä¼šå‡ºç°å¦‚ä¸‹çš„æƒ…å†µï¼š</p>
<ol>
<li>å•è¡Œæ•°æ®ä¸å®Œæ•´ï¼ŒJSON æ— æ³•è§£æ</li>
<li>Response è®°å½•å’Œæ–¹æ³•ä¸åŒ¹é…ï¼Œå¦‚ï¼šè¯·æ±‚ Method1 ä½†æ˜¯è®°å½•çš„ Response ç¡®å® gRPC å¥åº·æ£€æŸ¥çš„å“åº”</li>
<li>æŸäº›è®°å½• Request ä¸ºç©ºï¼Œå®é™…ä¸Šè¯¥è¯·æ±‚å¹¶ä¸ä¸ºç©ºã€‚</li>
</ol>
<p>å¯¼è‡´å¯¹æ¯”æ— æ³•è¿›è¡Œï¼Œä¼šå‡ºç°è¯¯åˆ¤çš„æƒ…å†µã€‚</p>
<blockquote>
<p>å¤§æ¦‚ç‡æ˜¯ grpcreplay æœ¬èº«é‡‡é›†å†™å…¥çš„é—®é¢˜ï¼Œè¿™é‡Œå†æ²¡æœ‰è¿›ä¸€æ­¥æ·±å…¥è¿½æŸ¥ã€‚</p>
</blockquote>
<h2 id="å®è·µ2-istio-virtualservice-mirror">
  å®è·µ2: Istio VirtualService mirror
  <a class="anchor" href="#%e5%ae%9e%e8%b7%b52-istio-virtualservice-mirror">#</a>
</h2>
<p>Istio æ˜¯ä¸€ä¸ªéå¸¸æˆç†Ÿçš„ Service Mesh è§£å†³æ–¹æ¡ˆï¼Œå®ƒå¯ä»¥åœ¨ä¸ä¿®æ”¹åº”ç”¨ä»£ç çš„æƒ…å†µä¸‹ï¼Œå¯¹ gRPC æµé‡è¿›è¡Œé•œåƒå’Œé‡æ”¾ã€‚åªéœ€è¦ä¸ºæœåŠ¡é…ç½®å¥½ VirtualService mirror è§„åˆ™å³å¯ã€‚</p>
<table>
  <thead>
      <tr>
          <th>å­—æ®µ</th>
          <th>è·¯å¾„å±‚çº§</th>
          <th>æè¿°</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>mirror</td>
          <td><code>spec.http[].mirror</code></td>
          <td>æŒ‡å®šè¦é•œåƒçš„ç›®æ ‡æœåŠ¡ã€‚</td>
      </tr>
      <tr>
          <td>mirrorPercentage</td>
          <td><code>spec.http[].mirrorPercentage</code></td>
          <td>æŒ‡å®šè¦é•œåƒçš„æµé‡ç™¾åˆ†æ¯”ã€‚</td>
      </tr>
  </tbody>
</table>
<p>å¤åˆ¶æµé‡ä¹‹åï¼Œè¿™ä¸ªæ–¹æ¡ˆè¿˜éœ€è¦è·å– gRPC æœåŠ¡çš„å“åº”å†…å®¹ï¼Œè®°å½•åˆ°æœ¬åœ°æ–‡ä»¶ä¸­ï¼Œç„¶åé€šè¿‡å¯¹æ¯”è„šæœ¬æ¥å¯¹æ¯”æ–°æ—§æœåŠ¡çš„å“åº”å†…å®¹ã€‚è¿™é‡Œå¯ä»¥è€ƒè™‘å®ç° Istio çš„æ’ä»¶å»è®°å½•ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©åœ¨æœåŠ¡ä¸­æ·»åŠ  gRPC æ‹¦æˆªå™¨æ¥å®ç°è®°å½•ã€‚</p>
<h3 id="é…ç½®æºæœåŠ¡-virtualservice">
  é…ç½®æºæœåŠ¡ VirtualService
  <a class="anchor" href="#%e9%85%8d%e7%bd%ae%e6%ba%90%e6%9c%8d%e5%8a%a1-virtualservice">#</a>
</h3>
<p>è¿™é‡Œä¸º <code>old-grpc</code> æœåŠ¡é…ç½® VirtualServiceã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.istio.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Gateway</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">istio-gateway</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">xxx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">istio</span>: <span style="color:#ae81ff">ingressgateway</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">servers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">old-grpc.xxx.com</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">grpc</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">number</span>: <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">GRPC</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.istio.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">VirtualService</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">old-grpc</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">old-grpc.default.svc.cluster.local</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">old-grpc.xxx.com</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">gateways</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">xxx/istio-gateway</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">route</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">destination</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">host</span>: <span style="color:#ae81ff">old-grpc.default.svc.cluster.local</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">number</span>: <span style="color:#ae81ff">50051</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">mirror</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">host</span>: <span style="color:#ae81ff">new-grpc.default.svc.cluster.local</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">mirrorPercentage</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#ae81ff">100</span>
</span></span></code></pre></div><h3 id="è¸©å‘è®°å½•-1">
  è¸©å‘è®°å½•
  <a class="anchor" href="#%e8%b8%a9%e5%9d%91%e8%ae%b0%e5%bd%95-1">#</a>
</h3>
<p>â€¼ï¸ è¿™é‡Œåœ¨å®è·µè¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜æ˜¯ï¼šä½¿ç”¨äº† AWS çš„ ALB ä½œä¸º Ingress Load Balancerï¼Œold-grpc åŸå§‹æš´éœ²äº† <a href="#">old-grpc.xxx.com</a> çš„ä¸€ä¸ªå¯¹å¤–æœåŠ¡çš„åŸŸåï¼Œåœ¨å°†è¯¥ ingress çš„ backend åˆ‡æ¢åˆ° istio-ingressgateway ä¹‹åï¼Œè¯·æ±‚å¼‚å¸¸ (è¯·æ±‚å“åº”çŠ¶æ€ç ï¼š UNIMPLEMENTED)ã€‚</p>
<figure>
  <img src="/images/grpcr-k8s/istio-gateway-issue0.jpeg" alt="istio-gateway-issue" width="100%" />
  <figcaption>Istio ingressgateway Issue</figcaption>
</figure>
<p>ä»ä¸Šå›¾å¯ä»¥å‘ç°ï¼Œingressgateway æœªèƒ½æ­£ç¡®çš„å°†è¯·æ±‚è½¬å‘åˆ°å¯¹åº”çš„åç«¯æœåŠ¡ï¼ˆService = Unkonwnï¼‰ æ‰€æœ‰çš„è¯·æ±‚å…¨éƒ½å¤±è´¥äº†ï¼Œè¿™é‡Œçš„é—®é¢˜æ˜¯ï¼š</p>
<ol>
<li>åŸæœ¬ ALB å¤„çš„é…ç½®æ˜¯æŒ‰ç…§ HTTP(s) é…ç½®çš„ï¼Œè½¬å‘åˆ°äº† ingressgateway çš„ 80 ç«¯å£ï¼Œè€Œ ingressgateway çš„ 80 ç«¯å£é…ç½®ä¸ºå¤„ç† HTTP æµé‡ã€‚</li>
<li>istio ingressgateway å¯èƒ½å­˜åœ¨æ— æ³•è‡ªåŠ¨è¯†åˆ«æµé‡çš„æƒ…å†µï¼Œéœ€è¦æ˜¾ç¤ºçš„é…ç½® gRPC åè®®ã€‚</li>
</ol>
<p>ç¬¬ä¸€ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šå°† ingress è½¬å‘ç«¯å£ä» 80 æ”¹ä¸º 443ã€‚åŒæ—¶éœ€è¦æ³¨æ„ AWS è½¬å‘è¿‡æ¥çš„æµé‡ä¹Ÿéœ€è¦åœ¨ ingress ä¸­æ·»åŠ æ³¨è§£ <code>alb.ingress.kubernetes.io/backend-protocol-version: &quot;GRPC&quot;</code></p>
<blockquote>
<p><a href="https://www.alibabacloud.com/help/zh/cs/user-guide/advanced-alb-ingress-configurations#section-b83-jhi-6ar">AWS ALB Ingress ä»£ç† gPRC æµé‡</a></p>
</blockquote>
<p>ç¬¬äºŒä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šservice æ˜¾å¼çš„é…ç½®ä¸º gRPC åè®®ã€‚port name æ”¹ä¸ºï¼š<code>protocol[-suffix]</code> æ ¼å¼ï¼Œæˆ–è€…åœ¨ kubernetes 1.18+ ç‰ˆæœ¬ä¸­ç›´æ¥ä½¿ç”¨ <code>appProtocol</code> å­—æ®µã€‚å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">old-grpc</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">xxx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">old-grpc</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">grpc-xxx</span> <span style="color:#75715e"># æ˜¾ç¤ºçš„é…ç½®ä¸º gRPC åè®®</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">appProtocol</span>: <span style="color:#ae81ff">grpc </span> <span style="color:#75715e"># æ˜¾å¼çš„é…ç½®ä¸º gRPC åè®®ï¼Œè¿™ä¸ªé…ç½®çš„ä¼˜å…ˆçº§æ›´é«˜</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">50051</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span></code></pre></div><blockquote>
<p><a href="https://istio.io/latest/docs/ops/configuration/traffic-management/protocol-selection/">Istio å¦‚ä½•è¯†åˆ«æµé‡åè®®</a></p>
</blockquote>
<h3 id="ç¼–å†™-gprc-interceptor">
  ç¼–å†™ gPRC interceptor
  <a class="anchor" href="#%e7%bc%96%e5%86%99-gprc-interceptor">#</a>
</h3>
<p>å„ä¸ªè¯­è¨€è¦å®ç° gRPC æ‹¦æˆªå™¨çš„æ–¹å¼éƒ½ä¸å°½ç›¸åŒï¼Œä½†éƒ½å¤§å·®ä¸å·®ï¼Œè¿™é‡Œä»¥ python è¯­è¨€ä¸ºä¾‹ï¼š</p>
<blockquote>
<p>PS: ä¸ºå•¥ç”¨ python ä¸¾ä¾‹ï¼Ÿå¯¹æˆ‘æ¥è¯´ï¼Œå®ƒæ˜¯çœŸæŠ½è±¡ï½</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> grpc_interceptor <span style="color:#f92672">import</span> ServerInterceptor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RecordReqRespInterceptor</span>(ServerInterceptor):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Interceptor to record request and response information.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Usage:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        server = grpc.server(
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            ThreadPoolExecutor(max_workers=5),
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            interceptors=[RecordReqRespInterceptor(store_directory)])
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    fd <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    store_directory <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>  <span style="color:#75715e"># /capture/server/capture.log</span>
</span></span><span style="display:flex;"><span>    _lock <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Lock()  <span style="color:#75715e"># æ·»åŠ çº¿ç¨‹é”</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, store_directory<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> store_directory:
</span></span><span style="display:flex;"><span>            __LOGGER__<span style="color:#f92672">.</span>warning(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Warning: store_directory is not specified, request and response information will not be recorded.&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        filename <span style="color:#f92672">=</span> store_directory <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;capture.log&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>store_directory <span style="color:#f92672">=</span> filename
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>fd <span style="color:#f92672">=</span> open(filename, <span style="color:#e6db74">&#39;a&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            __LOGGER__<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Failed to open file </span><span style="color:#e6db74">{</span>store_directory<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">record</span>(self, call_detail: CallDetails, error: str <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>fd <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">or</span> self<span style="color:#f92672">.</span>store_directory <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ä»handler_call_detailsä¸­æå–åŸºæœ¬ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>        method <span style="color:#f92672">=</span> call_detail<span style="color:#f92672">.</span>method
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> method <span style="color:#f92672">in</span> [
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;/grpc.health.v1.Health/Check&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;/grpc.reflection.v1.ServerReflection/ServerReflectionInfo&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;/grpc.reflection.v1alpha.ServerReflection/ServerReflectionInfo&#34;</span>,
</span></span><span style="display:flex;"><span>        ]:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        metadata <span style="color:#f92672">=</span> dict(call_detail<span style="color:#f92672">.</span>invocation_metadata)
</span></span><span style="display:flex;"><span>        timestamp_nano <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time_ns()
</span></span><span style="display:flex;"><span>        timestamp_seconds <span style="color:#f92672">=</span> int(timestamp_nano <span style="color:#f92672">/</span> <span style="color:#ae81ff">1000000000</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        req_body <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>dumps(MessageToDict(call_detail<span style="color:#f92672">.</span>request), separators<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#39;,&#39;</span>, <span style="color:#e6db74">&#39;:&#39;</span>))
</span></span><span style="display:flex;"><span>        resp_body <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>dumps(MessageToDict(call_detail<span style="color:#f92672">.</span>response), separators<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#39;,&#39;</span>, <span style="color:#e6db74">&#39;:&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># æ„å»ºè®°å½•</span>
</span></span><span style="display:flex;"><span>        record <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;method&#34;</span>: method,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;request&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;headers&#34;</span>: metadata,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;body&#34;</span>: req_body,
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;response&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;headers&#34;</span>: {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;failed&#34;</span>: error <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;error&#34;</span>: error <span style="color:#66d9ef">if</span> error <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;body&#34;</span>: resp_body,
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">with</span> self<span style="color:#f92672">.</span>_lock:  <span style="color:#75715e"># ä½¿ç”¨é”ä¿è¯å†™å…¥åŸå­æ€§</span>
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>fd<span style="color:#f92672">.</span>write(json<span style="color:#f92672">.</span>dumps(record) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>fd<span style="color:#f92672">.</span>flush()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            __LOGGER__<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Failed to write to file </span><span style="color:#e6db74">{</span>self<span style="color:#f92672">.</span>store_directory<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># å®ç° ServerInterceptor æŠ½è±¡æ–¹æ³•</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">intercept</span>(
</span></span><span style="display:flex;"><span>            self,
</span></span><span style="display:flex;"><span>            method: Callable,
</span></span><span style="display:flex;"><span>            request_or_iterator: Any,
</span></span><span style="display:flex;"><span>            context: grpc<span style="color:#f92672">.</span>ServicerContext,
</span></span><span style="display:flex;"><span>            method_name: str,
</span></span><span style="display:flex;"><span>    ):
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> method(request_or_iterator, context)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>record(CallDetails(method_name, context, request_or_iterator, response))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> response
</span></span></code></pre></div><h2 id="å¯¹æ¯”è„šæœ¬">
  å¯¹æ¯”è„šæœ¬
  <a class="anchor" href="#%e5%af%b9%e6%af%94%e8%84%9a%e6%9c%ac">#</a>
</h2>
<p><code>capture.log</code> ä¸­çš„ä¿å­˜æ¯ä¸€æ¡è®°å½• JSON ç»“æ„å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;method&#34;</span>: <span style="color:#e6db74">&#34;/pbpkg.Service/Method&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;request&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;headers&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;:authority&#34;</span>: <span style="color:#e6db74">&#34;10.90.74.23:50051&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;:method&#34;</span>: <span style="color:#e6db74">&#34;POST&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;:path&#34;</span>: <span style="color:#e6db74">&#34;/pbpkg.Service/Method&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;:scheme&#34;</span>: <span style="color:#e6db74">&#34;http&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;content-type&#34;</span>: <span style="color:#e6db74">&#34;application/grpc&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;grpc-accept-encoding&#34;</span>: <span style="color:#e6db74">&#34;gzip&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;te&#34;</span>: <span style="color:#e6db74">&#34;trailers&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;user-agent&#34;</span>: <span style="color:#e6db74">&#34;grpc-go/1.61.0&#34;</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;body&#34;</span>: <span style="color:#e6db74">&#34;&lt;ignored data string&gt;&#34;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;response&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;headers&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;:status&#34;</span>: <span style="color:#e6db74">&#34;200&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;content-type&#34;</span>: <span style="color:#e6db74">&#34;application/grpc&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;grpc-message&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;grpc-status&#34;</span>: <span style="color:#e6db74">&#34;0&#34;</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;body&#34;</span>: <span style="color:#e6db74">&#34;&lt;ignored data string&gt;&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>JSON ä¸­å·²ç»è¯¦ç»†çš„è®°å½•äº†è¯·æ±‚å’Œå“åº”çš„å†…å®¹ï¼Œæ³¨æ„ä¸€å®šéœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦ä¸€æ¡å”¯ä¸€è¡¨ç¤ºï¼Œæ¯”å¦‚ trace_id æˆ–è€… request_id æ–¹ä¾¿å°†æºæœåŠ¡å™¨å’Œ é•œåƒæœåŠ¡å™¨çš„è¯·æ±‚å“åº”ä¸²è”èµ·æ¥ã€‚è„šæœ¬çš„å¯¹æ¯”é€»è¾‘ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parse_capture_log</span>(log_file) <span style="color:#f92672">-&gt;</span> Record:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    è§£æ grpcreplay ç”Ÿæˆçš„ capture.log æ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ª Record å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    records <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(log_file, <span style="color:#e6db74">&#34;r&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> f:
</span></span><span style="display:flex;"><span>            record <span style="color:#f92672">=</span> Record<span style="color:#f92672">.</span>parse_raw(line)
</span></span><span style="display:flex;"><span>            records[record<span style="color:#f92672">.</span>uuid] <span style="color:#f92672">=</span> record
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>    source_records <span style="color:#f92672">=</span> parse_capture_log(<span style="color:#e6db74">&#34;capture.source.log&#34;</span>)
</span></span><span style="display:flex;"><span>    mirror_records <span style="color:#f92672">=</span> parse_capture_log(<span style="color:#e6db74">&#34;capture.mirror.log&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> source_record <span style="color:#f92672">in</span> source_records:
</span></span><span style="display:flex;"><span>        mirror_record <span style="color:#f92672">=</span> mirror_records<span style="color:#f92672">.</span>get(source_record<span style="color:#f92672">.</span>uuid)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        diff <span style="color:#f92672">=</span> source_record<span style="color:#f92672">.</span>diff(mirror_record)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> diff:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># å±•ç¤ºå·®å¼‚</span>
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Request </span><span style="color:#e6db74">{</span>source_record<span style="color:#f92672">.</span>uuid<span style="color:#e6db74">}</span><span style="color:#e6db74"> is different:&#34;</span>)
</span></span><span style="display:flex;"><span>            print(diff)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ç»Ÿè®¡å¯¹æ¯”ç»“æœï¼šæ€»å…±æœ‰å¤šå°‘æ¡è®°å½•ï¼Œæœ‰å¤šå°‘æ¡è®°å½•ä¸åŒï¼›å¤šå°‘ä¸ª method ä¸åŒï¼›method å„æœ‰å¤šå°‘æ¡è®°å½•ä¸åŒï¼›</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ç»Ÿè®¡ method ä¸åŒçš„åŸå› ï¼šè¯·æ±‚å¤´ä¸åŒã€è¯·æ±‚ä½“ä¸åŒã€å“åº”å¤´ä¸åŒã€å“åº”ä½“ä¸åŒï¼›</span>
</span></span><span style="display:flex;"><span>    print_summary()
</span></span></code></pre></div><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯åŸå§‹æœåŠ¡å™¨å’Œé•œåƒæœåŠ¡å™¨ä¿å­˜çš„JSONç»“æ„å¯èƒ½å­˜åœ¨å·®å¼‚, æ¯”å¦‚ï¼š</p>
<ol>
<li>å­—æ®µçš„åºåˆ—åŒ–é¡ºåºä¸åŒï¼Œå¦‚ï¼š<code>{&quot;a&quot;: 1, &quot;b&quot;: 2}</code> å’Œ <code>{&quot;b&quot;: 2, &quot;a&quot;: 1}</code></li>
<li>å¯¹äºç©ºå€¼çš„ï¼ˆåºåˆ—åŒ–ï¼‰å¤„ç†ä¸åŒï¼Œå¦‚ï¼š<code>{&quot;a&quot;: 1, b: []}</code> å’Œ <code>{&quot;a&quot;: 1}</code></li>
<li>åˆ—è¡¨ç±»å‹çš„é¡ºåºä¸åŒ, å¦‚ï¼š<code>[1, 2, 3]</code> å’Œ <code>[3, 2, 1]</code></li>
</ol>
<blockquote>
<p>è¿™äº›å·®å¼‚éœ€è¦è§†æƒ…å†µè€Œå®šï¼Œæœ‰äº›åœºæ™¯ä¸‹åˆ—è¡¨çš„é¡ºåºå·®å¼‚å°±ä»£è¡¨ä¸¤è€…ä¸åŒï¼Œä½†æ˜¯åœ¨è¿™é‡Œåˆ—è¡¨çš„é¡ºåºå·®å¼‚æ˜¯å¯ä»¥å¿½ç•¥ä¸è®¡çš„ã€‚</p>
</blockquote>
<p>å› æ­¤ï¼Œåœ¨å¯¹æ¯”çš„æ—¶å€™éœ€è¦å°†ä¸¤ä¸ªç»“æ„ä½“è¿›è¡Œæ³›åŒ–ï¼Œæ‰èƒ½å‡†ç¡®åœ°å¯¹æ¯”ä¸¤ä¸ªç»“æ„ä½“æ˜¯å¦ç›¸åŒï¼Œä¸‹é¢å°±ç”¨ä¸€æ®µ python ä»£ç æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">normalize_json</span>(obj: Any) <span style="color:#f92672">-&gt;</span> Any:
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;&#34;&#34;é€’å½’åœ°è§„èŒƒåŒ– JSON å¯¹è±¡ï¼Œä½¿å…¶å¯ä»¥è¿›è¡Œé¡ºåºæ— å…³çš„æ¯”è¾ƒ
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        obj: è¦è§„èŒƒåŒ–çš„å¯¹è±¡ï¼Œå¯ä»¥æ˜¯å­—å…¸ã€åˆ—è¡¨æˆ–å…¶ä»– JSON æ”¯æŒçš„ç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      è§„èŒƒåŒ–åçš„å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> isinstance(obj, dict):
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># å¦‚æœå­—å…¸ä¸ºç©ºï¼Œè¿”å› None</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> obj:
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>      normalized <span style="color:#f92672">=</span> [(k, normalize_json(v)) <span style="color:#66d9ef">for</span> k, v <span style="color:#f92672">in</span> obj<span style="color:#f92672">.</span>items()]
</span></span><span style="display:flex;"><span>      normalized <span style="color:#f92672">=</span> [(k, v) <span style="color:#66d9ef">for</span> k, v <span style="color:#f92672">in</span> normalized <span style="color:#66d9ef">if</span> v <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> sorted(normalized) <span style="color:#66d9ef">if</span> normalized <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">elif</span> isinstance(obj, list):
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> obj:
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>      normalized <span style="color:#f92672">=</span> [normalize_json(x) <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> obj]
</span></span><span style="display:flex;"><span>      normalized <span style="color:#f92672">=</span> [x <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> normalized <span style="color:#66d9ef">if</span> x <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> sorted(normalized) <span style="color:#66d9ef">if</span> normalized <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> obj
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">stringify_json</span>(obj: Any) <span style="color:#f92672">-&gt;</span> Any:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;å°†è§„èŒƒåŒ–çš„å¯¹è±¡è½¬æ¢å› JSON å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        obj: è§„èŒƒåŒ–åçš„å¯¹è±¡ï¼Œå¯èƒ½æ˜¯å…ƒç»„åˆ—è¡¨ï¼ˆå­—å…¸ï¼‰æˆ–æ’åºåçš„åˆ—è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        è½¬æ¢å›åŸå§‹ JSON ç»“æ„çš„å¯¹è±¡ï¼Œå¦‚æœè¾“å…¥ä¸º Noneï¼Œè¿”å›ç©ºå­—å…¸æˆ–ç©ºåˆ—è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> obj <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> isinstance(obj, list):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> obj <span style="color:#f92672">and</span> isinstance(obj[<span style="color:#ae81ff">0</span>], tuple):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {k: stringify_json(v) <span style="color:#66d9ef">for</span> k, v <span style="color:#f92672">in</span> obj}
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> [stringify_json(x) <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> obj]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> isinstance(obj, tuple):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {obj[<span style="color:#ae81ff">0</span>]: stringify_json(obj[<span style="color:#ae81ff">1</span>])}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> obj
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æµ‹è¯•</span>
</span></span><span style="display:flex;"><span>json1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;{&#34;a&#34;: [2, 1], &#34;b&#34;: {&#34;x&#34;: 1, &#34;y&#34;: 2}}&#39;</span>
</span></span><span style="display:flex;"><span>json2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;{&#34;a&#34;: [1, 2], &#34;b&#34;: {&#34;y&#34;: 2, &#34;x&#34;: 1}, &#34;c&#34;: []}&#39;</span>
</span></span><span style="display:flex;"><span>normalized1 <span style="color:#f92672">=</span> normalize_json(json<span style="color:#f92672">.</span>loads(json1))
</span></span><span style="display:flex;"><span>normalized2 <span style="color:#f92672">=</span> normalize_json(json<span style="color:#f92672">.</span>loads(json2))
</span></span><span style="display:flex;"><span>print(normalized1)  <span style="color:#75715e"># [(&#39;a&#39;, [1, 2]), (&#39;b&#39;, [(&#39;x&#39;, 1), (&#39;y&#39;, 2)])]</span>
</span></span><span style="display:flex;"><span>print(normalized2)  <span style="color:#75715e"># [(&#39;a&#39;, [1, 2]), (&#39;b&#39;, [(&#39;x&#39;, 1), (&#39;y&#39;, 2)])]</span>
</span></span><span style="display:flex;"><span>restored1 <span style="color:#f92672">=</span> stringify_json(normalized1)
</span></span><span style="display:flex;"><span>restored2 <span style="color:#f92672">=</span> stringify_json(normalized2)
</span></span><span style="display:flex;"><span>print(json<span style="color:#f92672">.</span>dumps(restored1))  <span style="color:#75715e"># {&#34;a&#34;: [1, 2], &#34;b&#34;: {&#34;x&#34;: 1, &#34;y&#34;: 2}}</span>
</span></span><span style="display:flex;"><span>print(json<span style="color:#f92672">.</span>dumps(restored2))  <span style="color:#75715e"># {&#34;a&#34;: [1, 2], &#34;b&#34;: {&#34;x&#34;: 1, &#34;y&#34;: 2}}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°åŸæœ¬ä¸¤ä¸ªä¸ç›¸åŒçš„JSONå­—ç¬¦ä¸²ï¼Œ<code>json1</code> å’Œ <code>json2</code>ï¼Œç»è¿‡ <code>normalize_json</code> å‡½æ•°å¤„ç†åï¼Œå¾—åˆ°çš„ç»“æœæ˜¯ç›¸åŒçš„ï¼Œå› æ­¤å¯ä»¥è®¤ä¸ºè¿™ä¸¤ä¸ªJSONå­—ç¬¦ä¸²æ˜¯ç›¸åŒçš„ã€‚</p>
<p>normalize_json å‡½æ•°çš„å®ç°æ€è·¯æ˜¯ï¼š</p>
<ol>
<li>å¯¹ key è¿›è¡Œæ’åºï¼Œè¾¾åˆ°è®© JSON å½’ä¸€åŒ–çš„ç›®çš„ã€‚æƒ³è¦æ’åºé‚£ä¹ˆæ ¼å¼ä¸€å®šæ˜¯éœ€è¦æ•°ç»„ç±»å‹ï¼Œå› æ­¤è¿™é‡Œå¯¹æ‰€æœ‰çš„ kv é€’å½’å¤„ç†ä¸ºï¼ˆkey, valueï¼‰çš„å…ƒç»„æ ¼å¼ï¼Œå­˜æ”¾ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œå†ä½¿ç”¨ key è¿›è¡Œæ’åºã€‚</li>
<li>è¿‡æ»¤æ‰å…¶ä¸­çš„ç©ºå€¼: ç©ºå€¼å¯¹æ¯”è¾ƒæ²¡æœ‰æ„ä¹‰ã€‚</li>
</ol>
<h2 id="æ€»ç»“">
  æ€»ç»“
  <a class="anchor" href="#%e6%80%bb%e7%bb%93">#</a>
</h2>
<p>æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•åœ¨ Kubernetes ä¸­ä½¿ç”¨ grpcreplay å®ç° gRPC æµé‡é•œåƒã€‚é€šè¿‡ sidecar å®¹å™¨çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å°† grpcreplay éƒ¨ç½²åœ¨æ—§æœåŠ¡å’Œæ–°æœåŠ¡çš„æ—è¾¹ï¼Œä»è€Œå®ç°æµé‡çš„å¤åˆ¶å’Œå¯¹æ¯”ã€‚è¿™ç§æ–¹å¼çš„å¥½å¤„åœ¨äºï¼š</p>
<ul>
<li>ä¸éœ€è¦ä¿®æ”¹åº”ç”¨ä»£ç ï¼›</li>
<li>ç›¸æ¯”äºä»£ç†çš„æ–¹å¼ï¼Œä¸ä¼šå½±å“åº”ç”¨çš„æ€§èƒ½ï¼›</li>
<li>å¯ä»¥æ–¹ä¾¿çš„å¯¹æ¯”æ–°æ—§æœåŠ¡çš„å“åº”å†…å®¹çš„å·®å¼‚ï¼›</li>
</ul>
<p>å¦‚æœå½“å‰ç¯å¢ƒä¸­å·²ç»æœ‰ Istio è¿™ç§ service mesh çš„è¯ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ä½¿ç”¨ Virtual Service çš„ mirror é…ç½®æ¥å¿«é€Ÿå®ç°æµé‡å¤åˆ¶ï¼Œå¦å¤–å†åŠ ä¸Šä¸€ä¸ªè¯·æ±‚å’Œå“åº”çš„è®°å½•å™¨ï¼Œå°±å¯ä»¥å®ç°æµé‡çš„å¤åˆ¶å’Œå¯¹æ¯”ã€‚</p>
</div>
</article>


<section class="comment">
  <div id="gitalk-container"></div>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
  <script>
      const gitalk = new Gitalk({
          clientID: '7d8c8c91ae6aff3e46e7',
          clientSecret: '0f0f2ea4fb6eb3067955823f06286e7d88509b9f',
          repo: 'yeqown.github.io',
          owner: 'yeqown',
          admin: ['yeqown'],
          id: "", 
          distractionFreeMode: false 
      });
      (function () {
          if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
              document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
              return;
          }
          gitalk.render('gitalk-container');
      })();
  </script>
</section>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">






<div class="flex align-center">
    <span id="busuanzi_container_site_pv" style="margin-right: 10px;">
        è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>
    </span>
    <span id="busuanzi_container_site_uv" style="margin-right: 10px;">
        è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>
    </span>
</div></div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#åœºæ™¯æè¿°">åœºæ™¯æè¿°</a></li>
    <li><a href="#æ–¹æ¡ˆä»‹ç»">æ–¹æ¡ˆä»‹ç»</a>
      <ul>
        <li><a href="#kubernetes-ä¸­çš„-sidecar">Kubernetes ä¸­çš„ sidecar</a></li>
        <li><a href="#grpcreplay-ç®€ä»‹">grpcreplay ç®€ä»‹</a></li>
      </ul>
    </li>
    <li><a href="#å®è·µ1-grpcreplay-sidecar">å®è·µ1: grpcreplay sidecar</a>
      <ul>
        <li><a href="#æ¶æ„è®¾è®¡">æ¶æ„è®¾è®¡</a></li>
        <li><a href="#é•œåƒæ‰“åŒ…">é•œåƒæ‰“åŒ…</a></li>
        <li><a href="#æ·»åŠ -pvc">æ·»åŠ  PVC</a></li>
        <li><a href="#é…ç½®-sidecar-grpcreplay">é…ç½® Sidecar: grpcreplay</a></li>
        <li><a href="#è¸©å‘è®°å½•">è¸©å‘è®°å½•</a></li>
      </ul>
    </li>
    <li><a href="#å®è·µ2-istio-virtualservice-mirror">å®è·µ2: Istio VirtualService mirror</a>
      <ul>
        <li><a href="#é…ç½®æºæœåŠ¡-virtualservice">é…ç½®æºæœåŠ¡ VirtualService</a></li>
        <li><a href="#è¸©å‘è®°å½•-1">è¸©å‘è®°å½•</a></li>
        <li><a href="#ç¼–å†™-gprc-interceptor">ç¼–å†™ gPRC interceptor</a></li>
      </ul>
    </li>
    <li><a href="#å¯¹æ¯”è„šæœ¬">å¯¹æ¯”è„šæœ¬</a></li>
    <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












