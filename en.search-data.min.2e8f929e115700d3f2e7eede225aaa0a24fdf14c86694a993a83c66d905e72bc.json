[{"id":0,"href":"/docs/aboutme/","title":"About Me","section":"Documentation","content":" Hi, I\u0026rsquo;m Yeqown! ğŸ‘‹ # Welcome to my corner of the internet! I\u0026rsquo;m a passionate backend software engineer from China ğŸ‡¨ğŸ‡³ on a journey to become a full-stack engineer and DevOps expert. I love building scalable distributed systems and contributing to the open-source community.\nğŸ¯ About Me # ğŸ“ Education: Computer Science and Technology, SouthWest Petroleum University ğŸ“Š GitHub: Active open-source contributor with numerous public repositories ğŸŒ± Currently Learning: Kubernetes, Service Mesh, WebAssembly, Lua, LSM-Tree, Rust ğŸ’¬ Love to Discuss: Microservices, DevOps, Distributed Systems, Linux Performance, Open Source ğŸ’» Technical Skills # ğŸš€ Expertise # Primary Language: Go (Production-level experience) Architecture: Microservices, Distributed Systems, High Performance Computing DevOps: Docker, Kubernetes, CI/CD, Monitoring ğŸ”§ Technologies \u0026amp; Tools # Category Technologies Languages Go, Python, Shell, Rust, JavaScript, C, Lua Go Ecosystem Kratos, Gin, GORM, Asynq, go-redis, go-metrics Networking TCP/IP, HTTP/1.1\u0026amp;2, gRPC, WebSocket, ICMP Databases MySQL, PostgreSQL, MongoDB, Redis Message Queue Kafka, RabbitMQ, NATS Infrastructure Nginx/OpenResty, Kubernetes, Docker, Prometheus Architecture CDC, Data Sharding (ShardingSphere), Data Warehouse (Doris) Other Performance Tuning, System Design, GitOps ğŸŒŸ Open Source Contributions # ğŸ† Major Contributions # Kratos - Go framework for microservices (Contributor) GORM - The fantastic ORM library for Golang (Contributor) Asynq - Simple, reliable, and efficient distributed task queue (Contributor) ğŸš€ My Featured Projects # Current featured projects (pinned on my GitHub profile):\nenchanted-sleeve - KV storage engine go-qrcode - QR code generation library in Go gitlab-flow - Git workflow CLI tool for development efficiency memcached - High-performance Memcached client with connection pool ğŸ¯ Current Focus \u0026amp; Learning Goals # ğŸ”¥ Active Projects # Building distributed KV storage with Rust and LSM-Tree Deep dive into OpenResty/Nginx performance optimization Lua scripting for high-performance systems ğŸ“š Learning Path # 2025 Q1: Advanced Kubernetes \u0026amp; Service Mesh (Istio, Linkerd) 2025 Q2: WebAssembly \u0026amp; WASI in production 2025 Q3: Distributed Systems Theory (CAP, Consensus) 2025 Q4: Linux Kernel \u0026amp; Systems Programming ğŸ¤ Let\u0026rsquo;s Connect! # ğŸ“« Reach Me # GitHub: github.com/yeqown Email: yeqown@gmail.com Twitter: @yeqown Telegram: @yeqown ğŸ’¬ Let\u0026rsquo;s Talk About # Go ecosystem best practices Microservices architecture patterns High-performance system design Open source collaboration Tech career development \u0026ldquo;The best way to learn is to build, the best way to grow is to share\u0026rdquo; - Yeqown\nThanks for visiting! Feel free to reach out if you\u0026rsquo;re interested in collaboration or just want to chat about technology! ğŸš€\n"},{"id":1,"href":"/2025/12/11/%E7%90%86%E8%A7%A3VictoriaLogs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/","title":"ç†è§£ Victoria Logs è®¾è®¡ä¸å®ç°","section":"Posts","content":"Victoria Logs ç®€å•æ˜“ä¸Šæ‰‹ï¼Œéå¸¸é€‚åˆä¸­å°å›¢é˜Ÿä½¿ç”¨ï¼ŒåŒæ—¶ä¹Ÿé€‚ç”¨äºæˆæœ¬æ•æ„Ÿçš„åœºæ™¯ã€‚\nå®˜æ–¹å»ºè®®ï¼šå¦‚æœå¯ä»¥æ¥å—åœ¨å•èŠ‚ç‚¹ä¸Šå‚ç›´æ‰©å±•æ¥æ»¡è¶³ä¸šåŠ¡éœ€æ±‚ï¼Œé‚£ä¹ˆå°±ä¸å¿…ä½¿ç”¨é›†ç¾¤æ¨¡å¼ã€‚\næœ¬æ–‡åŒ…å«å¤§é‡æºç ç‰‡æ®µï¼Œè‹¥ä¸å…³æ³¨ç»†èŠ‚ï¼Œå¯åªé˜…è¯» æ¶æ„æ¦‚è§ˆ å’Œ å­˜å‚¨æ¨¡å‹ã€‚\næ¶æ„æ¦‚è§ˆ # Victoria Logs çš„é›†ç¾¤æ¶æ„å¦‚ä¸‹ï¼š\nVictoria Logs æ¶æ„å›¾ é€šè¿‡ vlagent å®Œæˆç±»ä¼¼ Replica çš„åŠŸèƒ½ï¼Œå°†æ—¥å¿—æ•°æ®å¤åˆ¶åˆ°å¤šä¸ª vlstorage ç»„ä»¶ä¸­ï¼Œå®ç°é«˜å¯ç”¨å’Œæ•°æ®å†—ä½™ã€‚ é€šè¿‡ vlinsert æ‰§è¡Œæ—¥å¿—æ•°æ®çš„å†™å…¥ç­–ç•¥ã€‚ é€šè¿‡ vlselect æ¥èšåˆå¤šä¸ª vlstorage ç»„ä»¶ä¸­çš„æ—¥å¿—æ•°æ®ï¼Œå®ç°æŸ¥è¯¢åŠŸèƒ½ã€‚ é€šè¿‡ vlstorage å¯ä»¥æ— ç¼çš„å®ç°æ‰©å±•å­˜å‚¨å®¹é‡ï¼Œè€Œä¸ç”¨è€ƒè™‘æ•°æ®è¿ç§»ï¼ˆrebalanceï¼‰ã€‚ vlstorage çš„ç¼©å®¹ç¨å¾®å¤æ‚ä¸€äº›ï¼Œè¿™é‡Œæä¾›ä¸€ç§æ–¹æ¡ˆï¼š\nå…ˆå°†éœ€è¦ç¼©å®¹çš„ vlstorage èŠ‚ç‚¹ä» vlinsert çš„ storageNode åˆ—è¡¨ä¸­ç§»é™¤ï¼Œvlselect ä¸­ä¿ç•™ï¼› åˆ©ç”¨ Victoria Logs çš„æ•°æ®ä¿ç•™åŠŸèƒ½ï¼Œè®©æ•°æ®éšé€æ­¥è¿‡æœŸï¼Œç›´åˆ°å¾…åˆ é™¤èŠ‚ç‚¹ä¸Šçš„æ•°æ®å…¨éƒ¨è¿‡æœŸï¼› æœ€åå°†å…¶ä» vlselect ä¸­ç§»é™¤ï¼Œå¹¶é‡Šæ”¾ vlstorage èŠ‚ç‚¹ã€‚ ä¹Ÿå¯ä»¥å‚è€ƒ Partitions lifecycleï¼Œæ‰‹åŠ¨æ‰§è¡Œæ•°æ®è¿ç§»ã€‚\nvlagent # vlagent æ˜¯ Victoria Logs çš„ä»£ç†ç»„ä»¶ï¼ˆç±»ä¼¼ OpenTelemetry çš„ Agentï¼‰ï¼Œä½ç½®æ›´é è¿‘æ—¥å¿—æºï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€å±‚ç¼“å†²åŒºï¼Œè´Ÿè´£æ¥æ”¶æ—¥å¿—æ•°æ®å¹¶å°†å…¶å‘é€åˆ° vlinsert ç»„ä»¶ã€‚\nå®ƒå¯ä»¥å°†æ•°æ®å†™å…¥åˆ°ä¸åŒçš„ Victoria Logs å®ä¾‹ä¸­ï¼Œå®ç°æ•°æ®çš„å¤šå†™ï¼ˆå¤åˆ¶ï¼‰ï¼Œæ˜¯å®ç°é«˜å¯ç”¨çš„å¿…è¦ç»„ä»¶ã€‚\nPSï¼šè¿™é‡Œå°±ä¸åšè¿‡å¤šçš„å±•å¼€ï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªè¡Œç¿»çœ‹æºç ã€‚\nvlinsert # vlinsert æ˜¯ Victoria Logs çš„å†™å…¥ç»„ä»¶ï¼Œä¸ºæ— çŠ¶æ€æœåŠ¡ã€‚å†™å…¥æ—¶æ ¹æ®â€œå±€éƒ¨æ€§â€å’Œâ€œå‡åŒ€åˆ†å¸ƒâ€ç­–ç•¥é€‰æ‹©ç›®æ ‡ vlstorage èŠ‚ç‚¹ã€‚\nä»£ç ç‰‡æ®µ // app/vlstorage/netinsert/netinsert.go func (s *Storage) AddRow(streamHash uint64, r *logstorage.InsertRow) { idx := s.srt.getNodeIdx(streamHash) // sns []*storageNode ä»£è¡¨ vlstorage èŠ‚ç‚¹ç»„ sn := s.sns[idx] // è¿›ä¸€æ­¥è¿½è¸ªåˆ° sn.mustSendInsertRequest ä»£è¡¨é€šè¿‡ç½‘ç»œå†™å…¥åˆ° vlstorage èŠ‚ç‚¹ sn.addRow(r) } // app/vlstorage/netinsert/netinsert.go func (srt *streamRowsTracker) getNodeIdx(streamHash uint64) uint64 { if srt.nodesCount == 1 { // å¦‚æœåªæœ‰ä¸€ä¸ª vlstorage èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå°±ç›´æ¥å†™å…¥åˆ°è¯¥èŠ‚ç‚¹ return 0 } // streamHash := sid.id.lo ^ sid.id.hiï¼Œè¿™é‡Œçš„ sid å°±æ˜¯ streamID // sid.id = hash128(bb.B) å°±æ˜¯ stream çš„æ ‡ç­¾å’Œå€¼ hash å¾—æ¥çš„ // å¯ä»¥å‚è§ LogRows.MustAdd ä¸­çš„è¿‡ç¨‹ streamRows := srt.rowsPerStream[streamHash] + 1 srt.rowsPerStream[streamHash] = streamRows // å¦‚æœ Stream ä¸­çš„æ—¥å¿—æ•°é‡å°äº 1000 æ¡ï¼Œé‚£ä¹ˆå†™å…¥åˆ°åŒä¸€ä¸ª vlstorage ç»„ä»¶ä¸­ // å¯¹äºåªåŒ…å«å°‘é‡æ—¥å¿—çš„ Streamï¼Œå¯æé«˜å±€éƒ¨æ€§ï¼›å½“æŸä¸ª Stream é‡è¾ƒå¤§æ—¶åˆ™ // åˆ†æ•£åˆ°ä¸åŒçš„ vlstorage èŠ‚ç‚¹ï¼Œä»¥æé«˜æŸ¥è¯¢æ€§èƒ½ã€‚ if streamRows \u0026lt;= 1000 { return streamHash % uint64(srt.nodesCount) } return uint64(fastrand.Uint32n(uint32(srt.nodesCount))) } // app/vlstorage/netinsert/netinsert.go func (sn *storageNode) mustSendInsertRequest(pendingData *bytesutil.ByteBuffer) { // sn ä»£è¡¨å½“å‰é€‰ä¸­çš„å†™å…¥èŠ‚ç‚¹ err := sn.sendInsertRequest(pendingData) // å¦‚æœå†™å…¥æˆåŠŸï¼Œé‚£ä¹ˆè¿™é‡Œå°±ç›´æ¥è¿”å›äº† // å¦åˆ™ï¼Œä¼šå°è¯•å…¶ä»–èŠ‚ç‚¹ // sn.s ä»£è¡¨çš„æ˜¯ Storage // sendInsertRequestToAnyNode æ–¹æ³•åˆ™ä¼šéšæœºé€‰ä¸­ä¸€ä¸ªèŠ‚ç‚¹å°è¯•ï¼ˆå®é™…è°ƒç”¨ storageNode.sendInsertRequestï¼‰ for !sn.s.sendInsertRequestToAnyNode(pendingData) { // çœç•¥ } } // app/vlstorage/netinsert/netinsert.go func (sn *storageNode) sendInsertRequest(pendingData *bytesutil.ByteBuffer) error { // å¦‚æœæ²¡æœ‰ç¦ç”¨å‹ç¼©ï¼Œå°±ä½¿ç”¨ zstd å‹ç¼©æ•°æ® var body io.Reader if !sn.s.disableCompression { bb := zstdBufPool.Get() defer zstdBufPool.Put(bb) bb.B = zstd.CompressLevel(bb.B[:0], pendingData.B, 1) body = bb.NewReader() } else { body = pendingData.NewReader() } // å¯¹ vlstorage èŠ‚ç‚¹è¯·æ±‚ internal/insert æ¥å£ reqURL := sn.getRequestURL(\u0026#34;/internal/insert\u0026#34;) req, err := http.NewRequestWithContext(ctx, \u0026#34;POST\u0026#34;, reqURL, body) // ... resp, err := sn.c.Do(req) // ... } å°ç»“\nåœ¨é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œvlinsert è´Ÿè´£ä» vlstorage èŠ‚ç‚¹åˆ—è¡¨ä¸­é€‰æ‹©å†™å…¥ç›®æ ‡ï¼Œè·¯ç”±ç­–ç•¥å¦‚ä¸‹ï¼š\nStream ä¸­çš„æ—¥å¿—æ•°é‡å°äº 1000 æ—¶ï¼ŒåŒä¸€ä¸ª Stream çš„æ—¥å¿—ä¼šè¢«å†™å…¥åˆ°åŒä¸€ä¸ª vlstorage ç»„ä»¶ä¸­ã€‚ Stream ä¸­çš„æ—¥å¿—æ•°é‡å¤§äºç­‰äº 1000 æ—¶ï¼Œä¼šéšæœºé€‰æ‹©ä¸€ä¸ª vlstorage èŠ‚ç‚¹ï¼Œå°†æ—¥å¿—å†™å…¥åˆ°è¯¥ç»„ä»¶ä¸­ã€‚ å¦‚æœå†™å…¥å¤±è´¥ï¼Œä¼šå°è¯•å†™å…¥åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚ vlselect # vlselect æ˜¯ Victoria Logs çš„æŸ¥è¯¢ç»„ä»¶ï¼Œè´Ÿè´£æ¥æ”¶æŸ¥è¯¢è¯·æ±‚å¹¶è¿”å›æŸ¥è¯¢ç»“æœã€‚è¿™é‡Œä»¥ /select/logsql/query æ¥å£ä¸ºä¾‹ï¼Œä»‹ç»æŸ¥è¯¢çš„è¿‡ç¨‹ã€‚\nå…¥å£å‡½æ•°ä¸ºï¼šapp/vlselect/logsq/logsql.go#ProcessQueryRequest\nä»£ç ç‰‡æ®µ // app/vlselect/logsq/logsql.go // ProcessQueryRequest handles /select/logsql/query request. // // See https://docs.victoriametrics.com/victorialogs/querying/#querying-logs func ProcessQueryRequest(ctx context.Context, w http.ResponseWriter, r *http.Request) { // çœç•¥å‚æ•°è§£æï¼Œmetrics é‡‡é›†ç­‰ç­‰ // Execute the query if err := vlstorage.RunQuery(qctx, writeBlock); err != nil { // çœç•¥é”™è¯¯å¤„ç† return } } // app/vlstorage/main.go func RunQuery(qctx *logstorage.QueryContext, writeBlock logstorage.WriteDataBlockFunc) error { // è¿™éƒ¨åˆ†çš„ç›®çš„æ˜¯ç”¨æ¥åˆ¤æ–­æŸ¥è¯¢æ˜¯å¦å¯ä»¥ä¼˜åŒ–ä¸ºï¼šç›´æ¥è¿”å›æœ€åçš„ N æ¡æ—¥å¿—ï¼Œè€Œä¸ç”¨å…ˆæ‰§è¡Œè¿‡æ»¤å†æ’åº // æ¯”å¦‚ï¼š // - \u0026#39;sort by (_time desc) offset \u0026lt;offset\u0026gt; limit \u0026lt;limit\u0026gt;\u0026#39; // - \u0026#39;first \u0026lt;limit\u0026gt; by (_time desc)\u0026#39; // - \u0026#39;last \u0026lt;limit\u0026gt; by (_time)\u0026#39; qOpt, offset, limit := qctx.Query.GetLastNResultsQuery() if qOpt != nil { qctxOpt := qctx.WithQuery(qOpt) return runOptimizedLastNResultsQuery(qctxOpt, offset, limit, writeBlock) } // localStorage åœ¨ vlstorage èŠ‚ç‚¹ä¸­æ‰ä¼šè¢«èµ‹å€¼ if localStorage != nil { return localStorage.RunQuery(qctx, writeBlock) } return netstorageSelect.RunQuery(qctx, writeBlock) } å¯ä»¥çœ‹å‡ºï¼ŒRunQuery æ–¹æ³•ä¸ä»…ç”± vlselect è°ƒç”¨ï¼Œvlstorage èŠ‚ç‚¹ä¸­ä¹Ÿä¼šè°ƒç”¨ã€‚ç›®å‰å…ˆå…³æ³¨ netstorageSelect è¿™ä¸ªåˆ†æ”¯ï¼š\nä»£ç ç‰‡æ®µ // app/vlstorage/netselect/netselect.go func (s *Storage) RunQuery(qctx *logstorage.QueryContext, writeBlock logstorage.WriteDataBlockFunc) error { // nqr ä»£è¡¨ NetQueryRunnerï¼Œç”¨äºæ‰§è¡Œåˆ†å¸ƒå¼æŸ¥è¯¢ nqr, err := logstorage.NewNetQueryRunner(qctx, s.RunQuery, writeBlock) if err != nil { return err } search := func(stopCh \u0026lt;-chan struct{}, q *logstorage.Query, writeBlock logstorage.WriteDataBlockFunc) error { qctxLocal := qctx.WithQuery(q) return s.runQuery(stopCh, qctxLocal, writeBlock) } // nqr.Run å®é™…æ‰§è¡Œçš„è¿˜æ˜¯ Storage.runQuery æ–¹æ³• // nqr.Run å…¶ä¸­ä¼šå°† pipe åˆ†æˆ remote pipe å’Œ local pipe // åˆ†åˆ«æ‰§è¡Œåˆ†å¸ƒå¼æŸ¥è¯¢å’Œæœ¬åœ°æŸ¥è¯¢ concurrency := qctx.Query.GetConcurrency() return nqr.Run(qctx.Context, concurrency, search) } // app/vlstorage/netselect/netselect.go func (s *Storage) runQuery(stopCh \u0026lt;-chan struct{}, qctx *logstorage.QueryContext, writeBlock logstorage.WriteDataBlockFunc) error { // ... // è¿™é‡Œå¯ä»¥çœ‹å‡ºæ¥ï¼ŒrunQuery æ–¹æ³•ä¼šå¹¶å‘æ‰§è¡Œæ‰€æœ‰çš„ vlstorage èŠ‚ç‚¹çš„æŸ¥è¯¢ for i := range s.sns { go func(nodeIdx int) { err := sn.runQuery(qctxLocal, func(db *logstorage.DataBlock) { writeBlock(uint(nodeIdx), db) }) }(i) } // ... } func (sn *storageNode) runQuery(qctx *logstorage.QueryContext, processBlock func(db *logstorage.DataBlock)) error { path := \u0026#34;/internal/select/query\u0026#34; responseBody, reqURL, err := sn.getResponseBodyForPathAndArgs(qctx.Context, path, args) if err != nil { return err } defer responseBody.Close() // è§£æå“åº”ï¼Œçœç•¥ } å°ç»“\nvlselect ä¼šå¹¶å‘å‘æ‰€æœ‰ vlstorage èŠ‚ç‚¹å‘é€æŸ¥è¯¢è¯·æ±‚ï¼ŒæŸ¥è¯¢ä½¿ç”¨çš„æ˜¯èŠ‚ç‚¹çš„ /internal/select/query æ¥å£ã€‚\nä»è¿™éƒ¨åˆ†å®ç°ä¹Ÿèƒ½çœ‹å‡ºï¼ŒVictoria Logs å¯ä»¥å®ç° vlstorage çš„æ— ç¼æ‰©å±•ã€‚è¿™ç§æŸ¥è¯¢æ–¹å¼ä¼šå‘æ‰€æœ‰ vlstorage èŠ‚ç‚¹å‘é€è¯·æ±‚ï¼Œå¹¶å°†å„èŠ‚ç‚¹è¿”å›çš„ç»“æœè¿›è¡Œåˆå¹¶ã€‚ä¹Ÿå­˜åœ¨ä¸€äº›ç¼ºç‚¹ï¼Œä¾‹å¦‚ï¼š\næœ¨æ¡¶æ•ˆåº”ï¼šæŸ¥è¯¢å“åº”æ—¶é—´å—æœ€æ…¢èŠ‚ç‚¹å½±å“ï¼› å³ä½¿æŸäº›èŠ‚ç‚¹ä¸å­˜åœ¨ç›¸å…³æ•°æ®ï¼Œä»ä¼šå‚ä¸æŸ¥è¯¢æ‰§è¡Œï¼› ç½‘ç»œå¼€é”€ä¸å¯é¿å…ï¼Œå»¶è¿Ÿä¼šå¢åŠ ã€‚ è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆ Victoria Logs æ›´æ¨èåœ¨å¯æ¥å—çš„æƒ…å†µä¸‹ä½¿ç”¨å•èŠ‚ç‚¹æ¨¡å¼ï¼Œè€Œéé›†ç¾¤ã€‚\nvlstorage # vlstorage æ˜¯ Victoria Logs çš„å­˜å‚¨ç»„ä»¶ï¼Œè´Ÿè´£ç®¡ç†æ—¥å¿—æ•°æ®çš„å­˜å‚¨ï¼Œå¹¶ä¸º vlselect æä¾›æŸ¥è¯¢æ¥å£ï¼ˆ/internal/select/queryï¼‰ï¼Œä¸º vlinsert æä¾›å†™å…¥æ¥å£ï¼ˆ/internal/insertï¼‰ã€‚\næŸ¥è¯¢æ¥å£ # /internal/select/query æ˜ å°„ä¸º processQueryRequest æ–¹æ³•ï¼š\nä»£ç ç‰‡æ®µ // app/vlselect/internalselect/internalselect.go func processQueryRequest(ctx context.Context, w http.ResponseWriter, r *http.Request) error { // ... // è¿™é‡Œå°±æ˜¯åœ¨è·Ÿè¸ª vlselect æ—¶è°ƒç”¨çš„ RunQuery æ–¹æ³• if err := vlstorage.RunQuery(qctx, writeBlock); err != nil { return err } } // app/vlstorage/main.go func RunQuery(qctx *logstorage.QueryContext, writeBlock logstorage.WriteDataBlockFunc) error { // ... // è¿™é‡Œå°±è¦å…³æ³¨ localStorage.RunQuery æ–¹æ³• if localStorage != nil { return localStorage.RunQuery(qctx, writeBlock) } return netstorageSelect.RunQuery(qctx, writeBlock) } è¿™ä¹Ÿè¿›å…¥äº† Victoria Logs çš„æ ¸å¿ƒå­˜å‚¨å±‚ï¼Œå…·ä½“ç»†èŠ‚åœ¨åæ–‡â€œå­˜å‚¨åŸç†â€éƒ¨åˆ†å±•å¼€ã€‚\nå†™å…¥æ¥å£ # /internal/insert å¯¹åº”çš„å¤„ç†æ–¹æ³•åœ¨ app/vlinsert/internalinsert/internalinsert.go#RequestHandler ä¸­ï¼š\nä»£ç ç‰‡æ®µ // app/vlinsert/internalinsert/internalinsert.go func RequestHandler(w http.ResponseWriter, r *http.Request) { // ... // CommonParams åŒ…å«äº†å†™å…¥æ—¶çš„ä¸€äº›å…¬å…±å‚æ•°, å¦‚ï¼š // TenantID logstorage.TenantID // TimeFields []string // MsgFields []string // StreamFields []string // IgnoreFields []string // ç­‰ç­‰ cp, err := insertutil.GetCommonParams(r) // æ ¹æ®å‹ç¼©ç±»å‹è§£æ body ä¸­çš„æ•°æ®, å†é€šè¿‡ parseData è½¬ä¸º InsertRow ç±»å‹ err = protoparserutil.ReadUncompressedData(r.Body, encoding, maxRequestSize, func(data []byte) error { lmp := cp.NewLogMessageProcessor(\u0026#34;internalinsert\u0026#34;, false) irp := lmp.(insertutil.InsertRowProcessor) err := parseData(irp, data) lmp.MustClose() return err }) } // app/vlinsert/internalinsert/internalinsert.go func parseData(irp insertutil.InsertRowProcessor, data []byte) error { // ä»å¯¹è±¡æ± ä¸­è·å– InsertRow å¯¹è±¡ r := logstorage.GetInsertRow() src := data i := 0 for len(src) \u0026gt; 0 { tail, err := r.UnmarshalInplace(src) src = tail i++ // å°†è§£æåçš„ InsertRow æ·»åŠ åˆ° InsertRowProcessor ä¸­ irp.AddInsertRow(r) } } InsertRowProcessor çš„å®ç°æ˜¯ logMessageProcessorï¼š\nä»£ç ç‰‡æ®µ // app/vlinsert/insertutil/common_params.go func (lmp *logMessageProcessor) AddInsertRow(r *logstorage.InsertRow) { // è¶…è¿‡ MaxFieldsPerLineï¼ˆé»˜è®¤ 1000ï¼‰ ä¸ªå­—æ®µçš„æ—¥å¿—è¡Œä¼šè¢«ä¸¢å¼ƒ if len(r.Fields) \u0026gt; *MaxFieldsPerLine { return } // è°ƒç”¨ logstorage.LogRows å°† InsertRow æ·»åŠ åˆ° LogRows ä¸­ lmp.lr.MustAddInsertRow(r) // å¦‚æœéœ€è¦ flushï¼Œåˆ™è°ƒç”¨ flushLocked æ–¹æ³• if lmp.lr.NeedFlush() { lmp.flushLocked() } } åˆ°è¿™é‡Œä¹Ÿè¿›å…¥åˆ° Victoria Logs çš„æ ¸å¿ƒå­˜å‚¨å±‚ï¼ŒåŒæ ·åœ¨ä»‹ç»å­˜å‚¨åŸç†ä¸­å†å±•å¼€ã€‚\nå­˜å‚¨åŸç† # ä» Victoria Logs - How does victorialogs works å¯ä»¥å¾—çŸ¥ï¼ŒVictoria Logs é‡‡ç”¨äº†ä»¥ä¸‹è®¾è®¡ï¼š\næ—¥å¿—è¢«ä½œä¸º JSON æ¡ç›®å­˜å‚¨ã€‚ æ—¥å¿—çš„å­—æ®µä¼šä¿å­˜åˆ°ä¸åŒçš„æ•°æ®å—ä¸­ã€‚ ä¸åŒæ—¥å¿—çš„ç›¸åŒå­—æ®µä¼šä¿å­˜åœ¨åŒä¸€ä¸ªæ•°æ®å—ä¸­ã€‚ æ•°æ®å—ä¼šå‹ç¼©å­˜å‚¨ï¼Œä»¥å‡å°‘ç£ç›˜ç©ºé—´å ç”¨ã€‚ è¾ƒå°çš„æ•°æ®å—ä¼šåœ¨åå°åˆå¹¶æˆè¾ƒå¤§çš„æ•°æ®å—ã€‚ æŸ¥è¯¢è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªæ•°æ®å—ä¼šè¢«åŸå­çš„å¹¶å‘çš„è¯»å–ã€‚ æ­¤å¤–ï¼ŒVictoria Logs è¿˜é‡‡ç”¨ä»¥ä¸‹ä¼˜åŒ–ä»¥æå‡æŸ¥è¯¢æ•ˆç‡ï¼š\nå¼•å…¥äº† Bloom Filter æ¥è·³è¿‡æ²¡æœ‰ç»™å®šå…³é”®å­—çš„æ•°æ®å—ã€‚ é’ˆå¯¹ä¸åŒæ•°æ®ç±»å‹çš„å­—æ®µé‡‡ç”¨è‡ªå®šä¹‰ç¼–ç å’Œå‹ç¼©ã€‚ ç›¸åŒçš„ Stream è¢«ç‰©ç†çš„åˆ†ç»„ï¼ˆä½¿ç”¨ Stream Filter å¯ä»¥è·³è¿‡ä¸éœ€è¦çš„æ•°æ®å—ï¼‰ã€‚ ä¸ºæ—¥å¿—æ—¶é—´ç»´æŠ¤äº†ä¸€ä¸ªç¨€ç–ç´¢å¼•ï¼ˆä½¿ç”¨ Time Filter å¯ä»¥æé«˜æŸ¥è¯¢æ•ˆç‡ï¼‰ã€‚ ä»…å‡­æ–‡å­—è¯´æ˜éš¾ä»¥å……åˆ†ç†è§£ Victoria Logs çš„å­˜å‚¨åŸç†ï¼Œä»éœ€è¿›ä¸€æ­¥æ·±å…¥æºç æ¥æŠŠæ¡ç»†èŠ‚ã€‚\nè¿™éƒ¨åˆ†æºç åœ¨ lib/logstorage/ ç›®å½•ä¸‹ã€‚\nå†™å…¥æµç¨‹ # å‰é¢æˆ‘ä»¬è·Ÿè¸ªåˆ° logMessageProcessor ä¸­çš„ AddInsertRow æ–¹æ³•ï¼Œå…¶ä¸­è°ƒç”¨äº† flushLocked æ–¹æ³•ï¼š\nä»£ç ç‰‡æ®µ // app/vlinsert/insertutil/common_params.go func (lmp *logMessageProcessor) flushLocked() { logRowsStorage.MustAddRows(lmp.lr) } // app/vlstorage/main.go // è¿™ä¸ªæ–¹æ³•åœ¨ vlinsert ä¸­ä¹Ÿè¢«è°ƒç”¨ï¼Œåªä¸è¿‡å°±æ˜¯ä½¿ç”¨çš„ netstorageInsert.AddRow æ–¹æ³• func (*Storage) MustAddRows(lr *logstorage.LogRows) { if localStorage != nil { localStorage.MustAddRows(lr) } else { // Store lr across the remote storage nodes. lr.ForEachRow(netstorageInsert.AddRow) } } localStorageï¼ˆlogstorage.Storageï¼‰ ä»£è¡¨çš„å°±æ˜¯ Victoria Logs çš„æœ¬åœ°å­˜å‚¨å±‚å®ç°ï¼š\nä»£ç ç‰‡æ®µ // lib/logstorage/storage.go type Storage struct { path string // å­˜å‚¨ç›®å½•çš„è·¯å¾„ retention time.Duration // æ•°æ®ä¿ç•™æ—¶é—´ flockF *os.File // ç”¨äºç¡®ä¿ Storage ä»…è¢«å•ä¸ªè¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶é” partitions []*partitionWrapper // åˆ†åŒºåˆ—è¡¨ï¼ŒæŒ‰æ—¶é—´æ’åºï¼Œä¾‹å¦‚ partitions[0] æ˜¯æœ€æ—©çš„åˆ†åŒº ptwHot *partitionWrapper // æœ€æ–°çš„åˆ†åŒºï¼Œç”¨äºå†™å…¥æ–°çš„æ—¥å¿—è¡Œ // ... çœç•¥å…¶ä»–å­—æ®µ } è¿™é‡Œæ–°å‡ºäº† partition çš„æ¦‚å¿µï¼Œå…¶å®å¯¹åº”çš„å°±æ˜¯æ—¥æœŸï¼Œæ¯ä¸ªæ—¥æœŸå¯¹åº”ä¸€ä¸ªåˆ†åŒºã€‚å†å›åˆ° MustAddRows æ–¹æ³•ï¼š\nä»£ç ç‰‡æ®µ func (s *Storage) MustAddRows(lr *LogRows) { // Fast path: // å°è¯•å°† LogRows å…¨éƒ¨å†™å…¥åˆ° ptwHot ä¸­ ptwHot := s.ptwHot if ptwHot != nil { if ptwHot.canAddAllRows(lr) { ptwHot.pt.mustAddRows(lr) return } } // Slow path: // å¦‚æœ LogRows ä¸èƒ½è¢« ptwHot å…¨éƒ¨å†™å…¥ï¼Œé‚£ä¹ˆå°±éœ€è¦æŠŠ LogRows æ‹†åˆ†æˆå¤šä¸ª LogRowsï¼Œå†™å…¥åˆ°ä¸åŒçš„åˆ†åŒºä¸­ // PS: å†å²çš„åˆ†åŒºå¯èƒ½éœ€è¦ä»ç£ç›˜åŠ è½½ï¼Œä¼šå¢åŠ å†™å…¥å»¶è¿Ÿ now := time.Now().UnixNano() minAllowedDay := s.getMinAllowedDay(now) // ä¿ç•™ç­–ç•¥ï¼šè¿‡å»çš„æ—¶é—´ maxAllowedDay := s.getMaxAllowedDay(now) // ä¿ç•™ç­–ç•¥ï¼šæœªæ¥çš„æ—¶é—´ minAllowedTimestamp := now - s.maxBackfillAge.Nanoseconds() // æœ€å¤§èƒ½æ¥å—çš„å†å²æ—¥å¿—æ—¶é—´ // éå† LogRows ä¸­çš„æ¯ä¸ªæ—¥å¿—è¡Œï¼Œè¿‡æ»¤æ‰ä¸ç¬¦åˆè¦æ±‚çš„æ—¥å¿—è¡Œï¼Œ // å¹¶æ ¹æ®æ—¥å¿—è¡Œçš„æ—¶é—´æˆ³ï¼Œå°†å…¶æ·»åŠ åˆ°åŒä¸€åˆ†åŒºï¼ˆæ—¥æœŸï¼‰çš„ LogRows ä¸­ m := make(map[int64]*LogRows) for i, ts := range lr.timestamps { day := ts / nsecsPerDay\t// æ ¹æ®ä¿ç•™ç­–ç•¥ å’Œ æœ€å¤§èƒ½æ¥å—çš„å†å²æ—¥å¿—æ—¶é—´ è¿‡æ»¤æ‰ä¸ç¬¦åˆè¦æ±‚çš„æ—¥å¿—è¡Œ // ... lrPart := m[day] lrPart.mustAddInternal(lr.streamIDs[i], ts, lr.rows[i], lr.streamTagsCanonicals[i]) } for day, lrPart := range m { ptw := s.getPartitionForWriting(day) if ptw != nil { ptw.pt.mustAddRows(lrPart) } } } è¿™é‡Œå¯ä»¥å¾—çŸ¥ Storage çš„å†™å…¥æ˜¯åˆ†åŒº(day)çš„ï¼Œè€Œåˆ†åŒºå…·ä½“çš„å†™å…¥ç”± partitionWrapper.partition æ§åˆ¶ã€‚\nä»£ç ç‰‡æ®µ // lib/logstorage/partition.go type partition struct { s *Storage // path æ˜¯åˆ†åŒºçš„å®Œæ•´ç›®å½•è·¯å¾„ã€‚ä¾‹å¦‚ /data/logstorage/partitions/20230801 // å‰é¢çš„ /data/logstorage å¯ä»¥é…ç½®ï¼Œåé¢åˆ™æ˜¯ Victoria Logs è‡ªå·±çš„ç›®å½•ç»“æ„ path string name string // name æ˜¯åˆ†åŒºçš„åç§°ï¼Œæ˜¯ç›®å½•åã€‚å¦‚ï¼š20230801 idb *indexdb // idb æ˜¯ç´¢å¼•æ•°æ®åº“ï¼Œç”¨äºå­˜å‚¨æ—¥å¿—è¡Œçš„ç´¢å¼•ä¿¡æ¯ ddb *datadb // ddb æ˜¯æ•°æ®æ•°æ®åº“ï¼Œç”¨äºå­˜å‚¨æ—¥å¿—è¡Œçš„åŸå§‹æ•°æ® // .... } // lib/logstorage/partition.go // mustAddRows ä¹Ÿå°±æ˜¯æŠŠæ•°æ®å†™å…¥åˆ°ç´¢å¼•æ•°æ®åº“å’Œæ•°æ®æ•°æ®åº“ä¸­ï¼Œåªæ˜¯å…¶ä¸­ä¸ºäº†æé«˜æ€§èƒ½è¿‡æ»¤äº†å·²ç»å­˜åœ¨çš„ Stream func (pt *partition) mustAddRows(lr *LogRows) { // å°† æ–°å¢ çš„ Stream æ³¨å†Œåˆ° indexdb ä¸­ if !pt.idb.hasStreamID(streamID) { streamTagsCanonical := streamTagsCanonicals[rowIdx] pt.idb.mustRegisterStream(streamID, streamTagsCanonical) } // æœ€åæŠŠ LogRows å†™å…¥åˆ° datadb ä¸­ pt.ddb.mustAddRows(lr) } æ˜¾ç„¶ Victoria Logs çš„åˆ†åŒºä¸­ä¸»è¦ç”± ç´¢å¼•æ•°æ®åº“ï¼ˆindexdbï¼‰å’Œ æ•°æ®æ•°æ®åº“ï¼ˆdatadbï¼‰æ„æˆã€‚ä¸‹é¢å°±ä¾æ¬¡è·Ÿè¸ªä¸‹ indexdb å’Œ datadb çš„å†™å…¥æµç¨‹ã€‚\nindexdb å†™å…¥ # indexdb ç”¨äºå­˜å‚¨ Stream çš„ç´¢å¼•ä¿¡æ¯ï¼ŒåŸºäº MergeSet å®ç°ã€‚\nä»£ç ç‰‡æ®µ // lib/logstorage/indexdb.go type indexdb struct { path string // path æ˜¯ç´¢å¼•æ•°æ®åº“çš„ç›®å½•è·¯å¾„ï¼šå¦‚ path/to/partition/indexdb ç›®å½• partitionName string // partitionName æ˜¯ç´¢å¼•æ•°æ®åº“æ‰€å±çš„åˆ†åŒºåç§°(å¤©) tb *mergeset.Table // tb æ˜¯ç´¢å¼•æ•°æ®åº“çš„å­˜å‚¨ï¼Œç”¨äºå­˜å‚¨ç´¢å¼•ä¿¡æ¯ s *Storage // s æ˜¯ indexdb æ‰€å±çš„ Storage } ç´¢å¼•æ¡ç›®å‡†å¤‡ mustRegisterStream ä¼šå†™å…¥ä¸‰ç±»ç´¢å¼•æ¡ç›®ï¼š\ntenantID:streamIDï¼šstreamID åˆ° streamTagsCanonical çš„æ˜ å°„ tenantID:streamID -\u0026gt; streamTagsCanonicalï¼šstreamID åˆ° streamTagsCanonical çš„æ˜ å°„ tenantID:name:value -\u0026gt; streamIDï¼štag åˆ° streamID çš„æ˜ å°„ ä»£ç ç‰‡æ®µ // lib/logstorage/indexdb.go func (idb *indexdb) mustRegisterStream(streamID *streamID, streamTagsCanonical string) { // Register tenantID:streamID entry. bufLen := len(buf) buf = marshalCommonPrefix(buf, nsPrefixStreamID, tenantID) buf = streamID.id.marshal(buf) items = append(items, buf[bufLen:]) // Register tenantID:streamID -\u0026gt; streamTagsCanonical entry. bufLen = len(buf) buf = marshalCommonPrefix(buf, nsPrefixStreamIDToStreamTags, tenantID) buf = streamID.id.marshal(buf) buf = append(buf, streamTagsCanonical...) items = append(items, buf[bufLen:]) // Register tenantID:name:value -\u0026gt; streamIDs entries. tags := st.tags for i := range tags { bufLen = len(buf) buf = marshalCommonPrefix(buf, nsPrefixTagToStreamIDs, tenantID) buf = tags[i].indexdbMarshal(buf) buf = streamID.id.marshal(buf) items = append(items, buf[bufLen:]) } // Add items to the storage idb.tb.AddItems(items) } è¿™é‡Œä»¥ä¸€ä¸ªå…·ä½“çš„ä¾‹å­æ¥è¯´æ˜ï¼š\nå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª Stream {\u0026quot;tag1\u0026quot;:\u0026quot;value1\u0026quot;, \u0026quot;tag2\u0026quot;:\u0026quot;value2\u0026quot;}ï¼Œ å…¶ tenantID ä¸º 0, streamID ä¸º 0x12345678(hi) 90abcdef(lo)ï¼Œé‚£ä¹ˆä¼šç”Ÿæˆå¦‚ä¸‹çš„ç´¢å¼•æ¡ç›®ï¼š\n- 0x00(indexType) 0x00000000(tenantID) 0x12345678 0x90abcdef(streamID) - 0x01(indexType) 0x00000000(tenantID) 0x12345678 0x90abcdef(streamID) 0x02(tagCount) 0x04(tag1NameLen) \u0026#34;tag1\u0026#34;(tag1Name) 0x06(tag1ValueLen) \u0026#34;value1\u0026#34; 0x04(tag2NameLen) \u0026#34;tag2\u0026#34; 0x06 \u0026#34;value2\u0026#34; - 0x02(indexType) 0x00000000(tenantID) 0x04(tagNameLen) \u0026#34;tag1\u0026#34;(tagName) 0x06(tagValueLen) \u0026#34;value1\u0026#34;(tagValue) 0x12345678 0x90abcdef (streamID) - 0x02(indexType) 0x00000000(tenantID) 0x04(tagNameLen) \u0026#34;tag2\u0026#34;(tagName) 0x06(tagValueLen) \u0026#34;value2\u0026#34;(tagValue) 0x12345678 0x90abcdef (streamID) å†™å…¥å†…å­˜å— è¿™äº›ç´¢å¼•æ¡ç›®ä¼šåŠ å…¥åˆ° indexdb çš„ mergeset.Table å­˜å‚¨å¼•æ“ä¸­ï¼Œæ­¤å¼•æ“è´Ÿè´£å°†ç´¢å¼•æ¡ç›®å†™å…¥åˆ°å†…å­˜å—ï¼ˆinmemoryBlockï¼‰ä¸­ï¼Œè¿™é‡Œå†…å­˜å—é‡‡ç”¨äº†åˆ†ç‰‡ç®¡ç†ï¼Œåˆ†ç‰‡æ•°é‡ å’Œ cpu é€»è¾‘æ ¸æ•°(GOMAXPROCS) æ­£ç›¸å…³cpus * multiplier (multiplier = cpus, æœ€å¤§ 16)ã€‚\nå¹¶åœ¨åˆé€‚çš„æ—¶æœºè§¦å‘åˆå¹¶æ“ä½œã€‚\nä»£ç ç‰‡æ®µ type rawItemsShard struct { ibs []*inmemoryBlock } type inmemoryBlock struct { commonPrefix []byte // å…¬å…±å‰ç¼€ï¼Œå‡å°‘é‡å¤å­˜å‚¨ data []byte items []Item } // github.com/VictoriaMetrics/VictoriaMetrics/lib/mergeset/encoding.go func (ib *inmemoryBlock) Add(x []byte) bool { data := ib.data // å¦‚æœå†™å…¥å½“å‰ç´¢å¼•æ¡ç›®åï¼Œå†…å­˜å—å¤§å°è¶…è¿‡äº† maxInmemoryBlockSize(64KB)ï¼Œ // é‚£ä¹ˆå°±ä¸èƒ½å†™å…¥å½“å‰ç´¢å¼•æ¡ç›®ï¼Œè¿”å› false if len(x)+len(data) \u0026gt; maxInmemoryBlockSize { return false } dataLen := len(data) data = append(data, x...) ib.items = append(ib.items, Item{ Start: uint32(dataLen), End: uint32(len(data)), }) ib.data = data return true } inmemoryBlock åˆå¹¶æ—¶ï¼Œä¼šå°†å‰é¢çš„ç´¢å¼•æ¡ç›®åŠ å…¥ data å’Œ items ä¸­ï¼Œåé¢çš„ç´¢å¼•æ¡ç›®ä¼šåŠ å…¥åˆ°ä¸‹ä¸€ä¸ªå†…å­˜å—ä¸­ï¼Œæ¯”å¦‚ï¼š\n{ data([]byte): [ 0x00(indexType) 0x00000000(tenantID) 0x12345678 0x90abcdef(streamID) // 26B 0x01(indexType) 0x00000000(tenantID) 0x12345678 0x90abcdef(streamID) 0x02(tagCount) 0x04(tag1NameLen) \u0026#34;tag1\u0026#34;(tag1Name) 0x06(tag1ValueLen) \u0026#34;value1\u0026#34; 0x04(tag2NameLen) \u0026#34;tag2\u0026#34; 0x06 \u0026#34;value2\u0026#34; // 56B ], items: [ Item{Start: 0, End: 26}, Item{Start: 26, End: 82}, ], } å†…å­˜å—åˆå¹¶ mergeset.Table ä¼šå°† inmemoryBlock åˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„å†…å­˜å—ï¼ˆinmemoryPartï¼‰, inmemoryPart ä¹Ÿä¼šè¿›ä¸€æ­¥åˆå¹¶å¹¶åœ¨åˆé€‚çš„æ—¶æœºå°†å…¶åˆ·å…¥åˆ°æŒä¹…åŒ–ç£ç›˜ä¸­ã€‚\nå½“å•ä¸ª Shard ä¸­çš„å†…å­˜å—è¶…è¿‡ maxBlocksPerShard(256) æ—¶ï¼Œåˆ†ç‰‡ç®¡ç†å™¨ä¼šå°†è¿™äº›å†…å­˜å—åŠ å…¥åˆ°è‡ªèº«çš„ ibsToFlush ä¸­ï¼Œç­‰å¾…åˆå¹¶æ“ä½œã€‚\nä»£ç ç‰‡æ®µ // github.com/VictoriaMetrics/VictoriaMetrics/lib/mergeset/table.go func (riss *rawItemsShards) addIbsToFlush(tb *Table, ibsToFlush []*inmemoryBlock) { if len(ibsToFlush) == 0 { return } var ibsToMerge []*inmemoryBlock riss.ibsToFlushLock.Lock() if len(riss.ibsToFlush) == 0 { riss.updateFlushDeadline() } // å°†å½“å‰åˆ†ç‰‡çš„å†…å­˜å—åŠ å…¥åˆ° ibsToFlush ä¸­ riss.ibsToFlush = append(riss.ibsToFlush, ibsToFlush...) // å¦‚æœå¾…åˆå¹¶çš„å†…å­˜å—æ•°é‡è¶…è¿‡äº† maxBlocksPerShard(256) * cpus è¿™ä¸€é˜ˆå€¼ï¼Œ // é‚£ä¹ˆå°±éœ€è¦è¿›è¡Œåˆå¹¶æ“ä½œï¼Œå°†è¿™äº›å†…å­˜å—åˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„å†…å­˜å—ï¼ˆinmemoryPartï¼‰ if len(riss.ibsToFlush) \u0026gt;= maxBlocksPerShard*cgroup.AvailableCPUs() { ibsToMerge = riss.ibsToFlush riss.ibsToFlush = nil } riss.ibsToFlushLock.Unlock() // å°†å†…å­˜å—åˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„å†…å­˜å—ï¼ˆinmemoryPartï¼‰ tb.flushBlocksToInmemoryParts(ibsToMerge, false) } åœ¨ flushBlocksToInmemoryParts ä¸­å°† ibsToMerge æŒ‰æœ€å¤š defaultPartsToMerge(16) å¤§å°åˆ†æˆå¤šä¸ª chunkï¼Œå†æŠŠè¿™äº› chunk åˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„å†…å­˜å—ï¼ˆinmemoryPartï¼‰ã€‚æ³¨æ„å•ä¸ª inmemoryPart å¤§å°ä¸èƒ½è¶…è¿‡ 5% çš„å¯ç”¨ç³»ç»Ÿå†…å­˜ã€‚\nä»£ç ç‰‡æ®µ func (tb *Table) flushBlocksToInmemoryParts(ibs []*inmemoryBlock, isFinal bool) { pws := make([]*partWrapper, 0, (len(ibs)+defaultPartsToMerge-1)/defaultPartsToMerge) // æŒ‰æœ€å¤š defaultPartsToMerge(16) å¤§å°åˆ†æˆå¤šä¸ª chunkï¼Œ // æ¯ä¸ª chunk åˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„å†…å­˜å—ï¼ˆinmemoryPartï¼‰ for len(ibs) \u0026gt; 0 { n := defaultPartsToMerge if n \u0026gt; len(ibs) { n = len(ibs) } go func(ibsChunk []*inmemoryBlock) { if pw := tb.createInmemoryPart(ibsChunk); pw != nil { pws = append(pws, pw) } }(ibs[:n]) ibs = ibs[n:] } // å¤„ç†æ‰€æœ‰çš„ chunk (partWrapper), å°†å…¶åˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„å†…å­˜å—ï¼ˆinmemoryPartï¼‰ // é™¤éè¶…è¿‡å¤§å°é™åˆ¶ maxPartSize := getMaxInmemoryPartSize() for len(pws) \u0026gt; 1 { // åˆå¹¶ inmemoryPart pws = tb.mustMergeInmemoryParts(pws) pwsRemaining := pws[:0] for _, pw := range pws { // å¦‚æœå¤§å°è¶…è¿‡ maxPartSizeï¼Œé‚£ä¹ˆå°±ç›´æ¥åŠ å…¥åˆ° inmemoryParts ä¸­ if pw.p.size \u0026gt;= maxPartSize { tb.addToInmemoryParts(pw, isFinal) } else { pwsRemaining = append(pwsRemaining, pw) } } pws = pwsRemaining } if len(pws) == 1 { tb.addToInmemoryParts(pws[0], isFinal) } } é»˜è®¤çš„å¯ç”¨å†…å­˜ = ç³»ç»Ÿå†…å­˜ * 60% ï¼ˆå¯ä»¥é€šè¿‡ memory.allowedPercent é…ç½®ï¼‰\nåˆå¹¶ä¸åªæ˜¯ä¸Šé¢æåˆ°çš„éƒ¨åˆ†ï¼Œç¨‹åºè¿˜ä¼šåœ¨åå°å¯¹ inmemoryPart/filePart è¿›è¡Œåˆå¹¶ã€‚\næŒä¹…åŒ– ç»è¿‡åˆå¹¶åçš„ inmemoryPart ä¼šè¢«å†™å…¥åˆ°ç£ç›˜ä¸­ï¼Œå¦‚æœæ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œåˆ™ä¼šè¢«åˆ·å…¥åˆ°ç£ç›˜ä¸­ï¼š\nflushInterval å®šæ—¶è§¦å‘ part(inmemoryPart / filePart) åˆå¹¶æ—¶ ä»£ç ç‰‡æ®µ // github.com/VictoriaMetrics/VictoriaMetrics/lib/mergeset/table.go func (tb *Table) nextMergeIdx() uint64 { return tb.mergeIdx.Add(1) } // github.com/VictoriaMetrics/VictoriaMetrics/lib/mergeset/table.go func (tb *Table) mergeParts(pws []*partWrapper, stopCh \u0026lt;-chan struct{}, isFinal bool) error { mergeIdx := tb.nextMergeIdx() dstPartPath := \u0026#34;\u0026#34; if dstPartType == partFile { // åˆå¹¶åçš„ inmemoryPart ä¼šè¢«å†™å…¥åˆ°ç£ç›˜ä¸­ï¼Œæ–‡ä»¶åæ ¼å¼ä¸º %016Xï¼Œå¦‚ 18804EBAD6A80650 dstPartPath = filepath.Join(tb.path, fmt.Sprintf(\u0026#34;%016X\u0026#34;, mergeIdx)) } // åªæœ‰ä¸€ä¸ª inmemoryPart æ—¶ï¼Œç›´æ¥å°†å…¶å†™å…¥åˆ°ç£ç›˜ä¸­ if isFinal \u0026amp;\u0026amp; len(pws) == 1 \u0026amp;\u0026amp; pws[0].mp != nil { mp := pws[0].mp mp.MustStoreToDisk(dstPartPath) // æ‰“å¼€æ–°åˆ›å»ºçš„ filePart pwNew := tb.openCreatedPart(pws, nil, dstPartPath) // å°†åˆå¹¶åçš„ inmemoryPart åŠ å…¥åˆ° inmemoryParts ä¸­ tb.swapSrcWithDstParts(pws, pwNew, dstPartType) return nil } } å¯ä»¥çœ‹åˆ°ï¼ŒinmemoryPart ä¼šè¢«å†™å…¥åˆ°ç£ç›˜ç›®å½•ï¼Œç›®å½•æ ¼å¼ä¸º %016Xï¼ˆå¦‚ 18804EBAD6A80650ï¼‰ã€‚å®é™…å†™å…¥æ–‡ä»¶çš„é€»è¾‘åœ¨ mp(*inmemoryPart).MustStoreToDisk æ–¹æ³•ä¸­ã€‚\nä»£ç ç‰‡æ®µ // github.com/VictoriaMetrics/VictoriaMetrics/lib/mergeset/inmemory_part.go func (mp *inmemoryPart) MustStoreToDisk(path string) { fs.MustMkdirFailIfExist(path) metaindexPath := filepath.Join(path, metaindexFilename) // metaindex.bin indexPath := filepath.Join(path, indexFilename) // index.bin itemsPath := filepath.Join(path, itemsFilename) // items.bin lensPath := filepath.Join(path, lensFilename) // lens.bin var psw filestream.ParallelStreamWriter psw.Add(metaindexPath, \u0026amp;mp.metaindexData) psw.Add(indexPath, \u0026amp;mp.indexData) psw.Add(itemsPath, \u0026amp;mp.itemsData) psw.Add(lensPath, \u0026amp;mp.lensData) // å¹¶å‘æ‰§è¡Œå‰é¢æ·»åŠ çš„åˆ·å†™ä»»åŠ¡ psw.Run() mp.ph.MustWriteMetadata(path) // å†™å…¥ parts.json æ–‡ä»¶ fs.MustSyncPathAndParentDir(path) } å°ç»“ï¼š\nindexdb ç”¨äºå­˜å‚¨ Stream ç´¢å¼•ä¿¡æ¯ï¼Œä½äº path/to/partitions/indexdbã€‚ç´¢å¼•åŒ…æ‹¬ï¼štenantID â†’ streamIDã€streamID â†’ streamTagsCanonicalã€ä»¥åŠæ ‡ç­¾ï¼ˆtagï¼‰åˆ° streamID çš„æ˜ å°„ã€‚\nindexdb çš„å­˜å‚¨æŒ‰ç…§ part å•ä½è¿›è¡Œç®¡ç†ï¼Œæ¯ä¸ª part å¯¹åº”ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼ˆ18804EBAD6A80650ï¼‰ï¼Œæ¯ä¸ªæ–‡ä»¶å¤¹ä¸­åŒ…å«å¦‚ä¸‹çš„æ–‡ä»¶ï¼š\næ–‡ä»¶å æè¿° metadata.json (Part) ç´¢å¼•å…ƒæ•°æ®: {ç´¢å¼•æ•°é‡,å—æ•°é‡, ç¬¬ä¸€ä¸ªé¡¹çš„ç´¢å¼•, æœ€åä¸€ä¸ªé¡¹çš„ç´¢å¼•} metaindex.bin å­˜å‚¨ metaindexRowï¼ˆç”¨æ¥ç´¢å¼• indexBlock æˆ–è€… blockHeadersï¼‰ index.bin å­˜å‚¨ blockHeader (commonPrefixã€items æ•°é‡ã€ç´¢å¼• items åç§»ã€ç´¢å¼• lens åç§»ç­‰) items.bin (Block) stream ç´¢å¼• items æ•°æ®ï¼ˆä¼šä½¿ç”¨ commonPrefix æ‰‹æ®µè¿›è¡Œå‹ç¼©ï¼‰ lens.bin (Block) lens ç´¢å¼• items é•¿åº¦ä¿¡æ¯ï¼ˆç”¨äºæ”¯æŒ commonPrefix å‹ç¼©ï¼‰ datadb å†™å…¥ # datadb ç”¨äºå­˜å‚¨å®é™…çš„æ—¥å¿—æ•°æ®ã€‚\nç»§ç»­è·Ÿè¸ª pt.ddb.mustAddRowsï¼Œå¯ä»¥çœ‹åˆ° ddb(*datadb).mustFlushLogRows æ˜¯å®é™…å†™å…¥ datadb çš„æ–¹æ³•ã€‚\nä»£ç ç‰‡æ®µ // lib/logstorage/datadb.go func (ddb *datadb) mustFlushLogRows(lr *logRows) { mp.mustInitFromRows(lr) p := mustOpenInmemoryPart(ddb.pt, mp) // å°† inmemoryPart åŠ å…¥åˆ° datadb.inmemoryParts ä¸­ ddb.inmemoryParts = append(ddb.inmemoryParts, pw) // è§¦å‘ inmemoryParts åˆå¹¶ ddb.startInmemoryPartsMergerLocked() } å…¶ä¸­ mp.mustInitFromRows(lr) æ–¹æ³•ä¼šå°† logRows è½¬æ¢ä¸º inmemoryPart:\nä»£ç ç‰‡æ®µ // lib/logstorage/datadb.go func (mp *inmemoryPart) mustInitFromRows(lr *logRows) { sort.Sort(lr) // æ ¹æ® streamID æ’åºï¼Œå†æŒ‰ timestamp æ’åº lr.sortFieldsInRows() // æ ¹æ® field çš„ Name è¿›è¡Œæ’åº // å°† inmemoryPart çš„å„ç§ buffer èµ‹å€¼ç»™ blockStreamWriterï¼Œ // åç»­ bsw.Finalize å®é™…ä¸Šä¹Ÿæ˜¯å°† bsw çš„æ•°æ®å†™å…¥åˆ° inmemoryPart ä¸­ bsw.MustInitForInmemoryPart(mp) var sidPrev *streamID uncompressedBlockSizeBytes := uint64(0) timestamps := lr.timestamps rows := lr.rows streamIDs := lr.streamIDs for i := range timestamps { streamID := \u0026amp;streamIDs[i] if sidPrev == nil { sidPrev = streamID } // æ³¨æ„ï¼šå°†ç›¸åŒæµçš„æ—¥å¿—å†™å…¥åŒä¸€ä¸ª block ä¸­ï¼Œå¦‚æœè¶…è¿‡ maxUncompressedBlockSize (2MB) åˆ™ä¼šå†™å…¥ä¸‹ä¸€ä¸ª block // çœ‹ blockStreamWriter.MustWriteRows æ–¹æ³• if uncompressedBlockSizeBytes \u0026gt;= maxUncompressedBlockSize || !streamID.equal(sidPrev) { bsw.MustWriteRows(sidPrev, trs.timestamps, trs.rows) trs.reset() sidPrev = streamID uncompressedBlockSizeBytes = 0 } fields := rows[i] trs.timestamps = append(trs.timestamps, timestamps[i]) trs.rows = append(trs.rows, fields) uncompressedBlockSizeBytes += uint64(EstimatedJSONRowLen(fields)) } bsw.MustWriteRows(sidPrev, trs.timestamps, trs.rows) // å°† bsw ä¸­çš„æ•°æ®æ›´æ–°åˆ° inmemoryPart bsw.Finalize(\u0026amp;mp.ph)\t} // lib/logstorage/block_stream_writer.go func (bsw *blockStreamWriter) MustWriteRows(sid *streamID, timestamps []int64, rows [][]Field) { if len(timestamps) == 0 { return } b := getBlock() // !!! è¿™é‡ŒæŠŠåŸå§‹æ—¥å¿—çš„å­—æ®µå†™å…¥åˆ° block ä¸­ b.MustInitFromRows(timestamps, rows) bsw.MustWriteBlock(sid, b) putBlock(b) } type block struct { timestamps []int64 columns []column // æ‰€æœ‰ row ä¼šæ ¹æ®æŒ‰åˆ—è¿›è¡Œå­˜å‚¨ constColumns []Field // æ‰€æœ‰ row è¿™ä¸€åˆ—çš„å€¼ç›¸åŒå°±å¯ä»¥å­˜å‚¨åœ¨ constColumns ä¸­ï¼Œä½†å€¼ä¸èƒ½è¶…è¿‡ 256 å­—èŠ‚ } å°ç»“ï¼š\nåœ¨è¿™ä¸ªç¯èŠ‚ï¼Œæ—¥å¿—æ•°æ®ä»è¡Œæ ¼å¼ï¼ˆlogRowsï¼‰è½¬æ¢ä¸ºåˆ—æ ¼å¼ï¼ˆinmemoryPartï¼‰ï¼Œä¸»è¦ç»å†ä»¥ä¸‹æ­¥éª¤ï¼š\nå¯¹ logRows æ’åºï¼šåŒä¸€ stream çš„æ•°æ®ç›¸é‚»å¹¶æŒ‰æ—¶é—´æ’åºï¼ŒåŒæ—¶å¯¹ Fields ä¾æ® Field.Name è¿›è¡Œæ’åºï¼Œä¾¿äºç”Ÿæˆ blockï¼› å°†æ’åºåçš„ logRows ä¸­ç›¸åŒ stream çš„æ•°æ®å†™å…¥ä¸€ä¸ªæˆ–å¤šä¸ª blockï¼ˆæ¯ä¸ª block æœ€å¤§ maxUncompressedBlockSize(2MB)ï¼‰ï¼› block åŒ…å«å¸¸é‡åˆ—ï¼ˆæ‰€æœ‰è¡Œè¯¥å­—æ®µå€¼ç›¸åŒï¼‰ä¸æ™®é€šåˆ—ï¼ˆå„è¡Œå€¼ä¸å®Œå…¨ç›¸åŒï¼‰ï¼›æ™®é€šåˆ—ä¿å­˜æ‰€æœ‰è¡Œçš„è¯¥å­—æ®µå€¼ï¼ˆç¼ºå¤±åˆ™ä¸ºç©ºï¼‰ï¼› å°† block å†™å…¥ inmemoryPartï¼Œåˆå¹¶ååˆ·å…¥ç£ç›˜ã€‚ æ¯ä¸ª part åŒ…å«ä¸‹é¢å‡ ç§æ–‡ä»¶ï¼š\næ–‡ä»¶å å­˜å‚¨å†…å®¹ metadata.json (Part) part å…ƒä¿¡æ¯ï¼šè®°å½•æ•°ã€æ ¼å¼ç‰ˆæœ¬ã€æ—¶é—´èŒƒå›´ç­‰ metaindex.bin (Part) ç´¢å¼• indexBlockHeader (ä¸€ç»„ block) index.bin (Part) ç´¢å¼• blockHeader column_names.bin (Part) ä¸­æ‰€æœ‰çš„åˆ—å’Œåˆ—ID column_idxs.bin (Block) column çš„ bloom/values å­˜åœ¨çš„ shardID columns_header_index.bin (Block) ç´¢å¼• columnID åˆ° columnHeader çš„åç§»é‡ columns_header.bin (Block) columnHeader æ•°æ® timestamps.bin (Block) æ—¶é—´æˆ³æ•°æ® message_bloom.bin (Block) æ¶ˆæ¯çš„å¸ƒéš†è¿‡æ»¤å™¨ message_values.bin (Block) å®é™…çš„æ—¥å¿—æ¶ˆæ¯ bloom.bin{shard} (Block) æ™®é€šåˆ—çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œç”¨äºå¿«é€Ÿåˆ¤æ–­æ˜¯å¦åŒ…å«æŸä¸ªæ¶ˆæ¯ values.bin{shard} (Block) æ™®é€šåˆ—çš„å®é™…å€¼ å…¶ä¸­ {shardIdx} æ˜¯åˆ†ç‰‡ç´¢å¼•ï¼Œä» 0 å¼€å§‹ï¼Œä»£è¡¨äº† bloom å’Œ values åœ¨è¿™ä¸ª part ä¸­çš„åˆ†ç‰‡æ•°é‡ã€‚\nLog ä¸­çš„åˆ—åä¼šå­˜å‚¨åœ¨ column_names.bin ä¸­ï¼Œæ¯ä¸ªåˆ—åä¼šæœ‰ä¸€ä¸ªå”¯ä¸€çš„ IDï¼Œè¿™ä¸ª ID ä¼šåœ¨ column_idxs.bin ä¸­å­˜å‚¨ã€‚\nè¯»å–æµç¨‹ # ç»è¿‡å¯¹å†™å…¥æµç¨‹çš„æ¢³ç†ï¼Œæˆ‘ä»¬å†å›å¤´æ¥çœ‹è¯»å–æµç¨‹ã€‚ä» RunQuery å¼€å§‹è¿½è¸ªï¼š\nBlock è¿‡æ»¤ # ä»£ç ç‰‡æ®µ // lib/logstorage/storage_search.go func (s *Storage) runQuery(qctx *QueryContext, writeBlock writeBlockResultFunc) error { // ä»æŸ¥è¯¢æ¡ä»¶ä¸­è§£æå‡ºæŸ¥è¯¢éœ€è¦çš„å‚æ•°ï¼š // type storageSearchOptions struct { // tenantIDs []TenantID // streamIDs []streamID // minTimestamp int64 // maxTimestamp int64 // streamFilter *StreamFilter // filter filter // fieldsFilter *prefixfilter.Filter // hiddenFieldsFilter *prefixfilter.Filter // timeOffset int64 // } sso := s.getSearchOptions(qctx.TenantIDs, q, qctx.HiddenFieldsFilters) s.searchParallel(workersCount, sso, qctx.QueryStats, stopCh, writeBlockToPipes) } // lib/logstorage/storage_search.go func (s *Storage) searchParallel(workersCount int, sso *storageSearchOptions, qs *QueryStats, stopCh \u0026lt;-chan struct{}, writeBlock writeBlockResultFunc) { // ... // å¯åŠ¨å¤šä¸ª blockSearch åç¨‹ï¼Œæ¯ä¸ªåç¨‹ä» workCh ä¸­å–å‡ºä¸€ä¸ª blockSearchWorkBatch è¿›è¡Œæœç´¢ workCh := make(chan *blockSearchWorkBatch, workersCount) for workerID := 0; workerID \u0026lt; workersCount; workerID++ { go func(workerID uint) { for bswb := range workCh { for i := range bsws { // bs blockSearch ä»£è¡¨å¯¹ä¸€ä¸ª block è¿›è¡Œæœç´¢ bs.search(qsLocal, bsw, bm) if bs.br.rowsLen \u0026gt; 0 { writeBlock(workerID, \u0026amp;bs.br) }\t} } }(uint(workerID)) } // æ ¹æ®æ—¶é—´èŒƒå›´ç¡®å®šéœ€è¦æŸ¥è¯¢çš„ Partition ptws, ptwsDecRef := s.getPartitionsForTimeRange(sso.minTimestamp, sso.maxTimestamp) defer ptwsDecRef() // å¹¶å‘æŸ¥è¯¢æ¯ä¸ª Partition for i, ptw := range ptws { go func(idx int, pt *partition) { psfs[idx] = pt.search(sso, qsLocal, workCh, stopCh) }(i, ptw.pt) } } // lib/logstorage/storage_search.go func (pt *partition) search(sso *storageSearchOptions, qs *QueryStats, workCh chan\u0026lt;- *blockSearchWorkBatch, stopCh \u0026lt;-chan struct{}) partitionSearchFinalizer { // å¦‚æœæŸ¥è¯¢æ¡ä»¶ä¸­åŒ…å«äº† _streamFilter é‚£ä¹ˆä» indexdb ä¸­è·å–åˆ°å¯¹åº”çš„ streamID pso := pt.getSearchOptions(sso) // åœ¨ datadb ä¸­æ‰§è¡ŒæŸ¥è¯¢ return pt.ddb.search(pso, qs, workCh, stopCh) } // lib/logstorage/datadb_search.go func (ddb *datadb) search(pso *partitionSearchOptions, qs *QueryStats, workCh chan\u0026lt;- *blockSearchWorkBatch, stopCh \u0026lt;-chan struct{}) partitionSearchFinalizer { // æŒ‰ç…§æ—¶é—´èŒƒå›´ç¡®å®šéœ€è¦æŸ¥è¯¢çš„ Part pws, pwsDecRef := ddb.getPartsForTimeRange(pso.minTimestamp, pso.maxTimestamp) // Apply search to matching parts for _, pw := range pws { pw.p.search(pso, qs, workCh, stopCh) } return pwsDecRef } // lib/logstorage/storage_search.go func (p *part) search(pso *partitionSearchOptions, qs *QueryStats, workCh chan\u0026lt;- *blockSearchWorkBatch, stopCh \u0026lt;-chan struct{}) { bhss := getBlockHeaders() if len(pso.tenantIDs) \u0026gt; 0 { p.searchByTenantIDs(pso, qs, bhss, workCh, stopCh) } else { // è¿™ä¸ªæ–¹æ³•æ˜¯å¯¹ part ä¸­çš„ index p.searchByStreamIDs(pso, qs, bhss, workCh, stopCh) } putBlockHeaders(bhss) } ä»ä¸Šè¿°ä»£ç å¯ä»¥æ¸…æ™°çœ‹å‡ºï¼ŒVictoria Logs çš„å‰ä¸‰å±‚ç»“æ„åœ¨é€å±‚ç¼©å°æŸ¥è¯¢èŒƒå›´ä»¥æé«˜æ•ˆç‡ï¼Œå¹¶å‘æŸ¥è¯¢æ¯ä¸ª partition å’Œ part ä»¥åŠ é€Ÿæ£€ç´¢ã€‚\nå…¶ä¸­ part.searchByStreamIDs çš„ä½œç”¨æ˜¯åŸºäº streamIDs è¿‡æ»¤å‡ºç¬¦åˆæ¡ä»¶çš„ blockï¼ˆblockHeaderï¼‰ï¼šè¦æ±‚ streamID è½åœ¨ç›®æ ‡é›†åˆå†…ä¸”æ—¶é—´èŒƒå›´å‘½ä¸­ç›®æ ‡åŒºé—´ï¼Œå¹¶å°†å…¶åŠ å…¥ workChã€‚\næ ¹æ® streamFilter è·å– streamIDs çš„ä»£ç ç‰‡æ®µå¦‚ä¸‹ã€‚ä»¥ _stream: {service=\u0026quot;test-app\u0026quot;} ä¸ºä¾‹ï¼Œå¯¹åº”çš„ç­‰å€¼æŸ¥è¯¢æ–¹æ³•ä¸º getStreamIDsForNonEmptyTagValueï¼š\nä»£ç ç‰‡æ®µ func (is *indexSearch) getStreamIDsForNonEmptyTagValue(tenantID TenantID, tagName, tagValue string) map[u128]struct{} { ids := make(map[u128]struct{}) ts := \u0026amp;is.ts kb := \u0026amp;is.kb // æ„å»ºæŸ¥è¯¢å‰ç¼€ï¼šnsPrefixTagToStreamIDs + tenantID + tagName + tagValue kb.B = marshalCommonPrefix(kb.B[:0], nsPrefixTagToStreamIDs, tenantID) kb.B = marshalTagValue(kb.B, bytesutil.ToUnsafeBytes(tagName)) kb.B = marshalTagValue(kb.B, bytesutil.ToUnsafeBytes(tagValue)) prefix := kb.B // æ‰¾åˆ°ç¬¬ä¸€æ¡ä»¥ prefix å¼€å¤´çš„è®°å½• ts.Seek(prefix) for ts.NextItem() { if !bytes.HasPrefix(item, prefix) { break } // è§£æ streamID å¹¶æ›´æ–°ç»“æœ tail := item[len(prefix):] sp.UpdateStreamIDs(ids, tail) } return ids } è¿™é‡Œçš„ç»†èŠ‚ï¼š\nindexBlockHeader(s) ä» metaindex.bin åŠ è½½ï¼› ç¬¬ä¸€æ¬¡è¿‡æ»¤ï¼šé€šè¿‡ indexBlockHeader æ’é™¤ä¸åŒ…å«ç›®æ ‡ streamID å’Œæ—¶é—´èŒƒå›´çš„ç´¢å¼•å—ï¼› åŠ è½½ blockHeaderï¼šä» index.bin è¯»å–åŒ¹é…ç´¢å¼•å—ä¸­çš„æ‰€æœ‰ blockHeaderï¼› ç¬¬äºŒæ¬¡è¿‡æ»¤ï¼šä¾æ® blockHeader å†æ¬¡æ’é™¤ä¸åŒ…å«ç›®æ ‡ streamID å’Œæ—¶é—´èŒƒå›´çš„å—ã€‚ ä»£ç ç‰‡æ®µ // indexBlockHeader åŒ…å«ç´¢å¼•æ˜¯è¦†ç›–äº†å¤šä¸ª block type indexBlockHeader struct { streamID streamID // ä»£è¡¨çš„æ˜¯è¦†ç›–çš„ block ä¸­æœ€å°çš„ streamID minTimestamp int64 // ä»£è¡¨çš„æ˜¯è¦†ç›–çš„ block ä¸­æœ€å°çš„ timestamp maxTimestamp int64 // ä»£è¡¨çš„æ˜¯è¦†ç›–çš„ block ä¸­æœ€å¤§çš„ timestamp indexBlockOffset uint64 // ä»£è¡¨çš„æ˜¯åœ¨ indexFilenameï¼ˆindex.bin) ä¸­çš„æŒ‡å‘å­˜å‚¨æ•°æ®ä½ç½®çš„åç§»é‡ indexBlockSize uint64 // ä»£è¡¨çš„æ˜¯åœ¨ indexFilenameï¼ˆindex.bin) ä¸­å­˜å‚¨æ•°æ®çš„å¤§å° } // blockHeader åŒ…å«äº†å•ä¸ª block çš„å…ƒæ•°æ®ä¿¡æ¯ type blockHeader struct { streamID streamID // ä»£è¡¨çš„æ˜¯ block ä¸­å­˜å‚¨çš„æ—¥å¿—æ¡ç›®çš„ streamID uncompressedSizeBytes uint64 // ä»£è¡¨çš„æ˜¯ block ä¸­å­˜å‚¨çš„æ—¥å¿—æ¡ç›®çš„åŸå§‹ï¼ˆæœªå‹ç¼©ï¼‰å¤§å° rowsCount uint64 // ä»£è¡¨çš„æ˜¯ block ä¸­å­˜å‚¨çš„æ—¥å¿—æ¡ç›®çš„æ•°é‡ timestampsHeader timestampsHeader // timestampsHeader åŒ…å«äº† block ä¸­å­˜å‚¨çš„æ—¥å¿—æ¡ç›®çš„æ—¶é—´æˆ³ä¿¡æ¯ columnsHeaderIndexOffset uint64 // ä»£è¡¨çš„æ˜¯ columnsHeader åœ¨ columnsHeaderIndexFilename(columns_header_index.bin) ä¸­çš„åç§»é‡ columnsHeaderIndexSize uint64 // ä»£è¡¨çš„æ˜¯ columnsHeader åœ¨ columnsHeaderIndexFilename(columns_header_index.bin) ä¸­çš„å¤§å° columnsHeaderOffset uint64 // ä»£è¡¨çš„æ˜¯ columnsHeader åœ¨ columnsHeaderFilename(columns_header.bin) ä¸­çš„åç§»é‡ columnsHeaderSize uint64 // ä»£è¡¨çš„æ˜¯ columnsHeader åœ¨ columnsHeaderFilename(columns_header.bin) ä¸­çš„å¤§å° } type timestampsHeader struct { blockOffset uint64 // ä»£è¡¨çš„æ˜¯ block åœ¨ timestampsFilename(timestamps.bin) ä¸­çš„åç§»é‡ blockSize uint64 // ä»£è¡¨çš„æ˜¯ block åœ¨ timestampsFilename(timestamps.bin) ä¸­çš„å¤§å° minTimestamp int64 // ä»£è¡¨çš„æ˜¯ block ä¸­å­˜å‚¨çš„æ—¥å¿—æ¡ç›®çš„æœ€å°æ—¶é—´æˆ³ maxTimestamp int64 // ä»£è¡¨çš„æ˜¯ block ä¸­å­˜å‚¨çš„æ—¥å¿—æ¡ç›®çš„æœ€å¤§æ—¶é—´æˆ³ marshalType encoding.MarshalType // ä»£è¡¨çš„æ˜¯ block ä¸­å­˜å‚¨çš„æ—¥å¿—æ¡ç›®çš„æ—¶é—´æˆ³ä¿¡æ¯çš„ç¼–ç ç±»å‹ } ç»è¿‡ä¸Šé¢çš„å±‚å±‚è¿‡æ»¤ (æŒ‰ç…§ æ—¶é—´èŒƒå›´ + streamID åˆ—è¡¨)ï¼Œç¡®å®šäº†å“ªäº›åˆ†åŒºçš„å“ªäº› partï¼Œä»¥åŠ part ä¸­éœ€è¦è¿›ä¸€æ­¥ç­›é€‰çš„ Block(blockHeader) åˆ—è¡¨ã€‚è¿™äº›è¿˜éœ€è¦æŸ¥æ‰¾è¿‡æ»¤çš„ Block(blockHeader) ä¼šè¢«æ‰“åŒ…æˆ blockSearchWorkBatch ä»»åŠ¡ï¼Œå‘é€åˆ° workCh ä¸­, è®© blockSearch æ‰§è¡Œå…·ä½“çš„æŸ¥è¯¢ã€‚\næˆ‘ä»¬ä¹Ÿèƒ½å¾—å‡ºè¿™æ ·çš„ç»“è®ºï¼šVictoriaLogs åœ¨å­˜å‚¨æ—¶ï¼Œåœ¨æ¯ä¸€å±‚éƒ½ä¸ºæ—¶é—´ å’Œ streamID è¿‡æ»¤åœ¨ç´¢å¼•ä¸­åšäº†è®¾è®¡ï¼Œè¿›è€Œåœ¨æŸ¥è¯¢æ—¶å¸¦ä¸Šé€‚å½“æ—¶é—´èŒƒå›´ å’Œ streamFilter å¯ä»¥æå¤§çš„ç¼©å°æŸ¥è¯¢èŒƒå›´ï¼Œä»è€Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚\nBlock åŒ¹é… # blockSearch æ˜¯åœ¨ Storage.searchParallel å¯åŠ¨çš„å·¥ä½œåç¨‹ä¸­è¿è¡Œï¼Œä¾æ¬¡ä» workCh ä¸­è·å– blockSearchWorkBatchï¼Œç„¶åè¿›è¡Œè¿›è¡ŒæŸ¥è¯¢ã€‚\nä»£ç ç‰‡æ®µ // lib/logstorage/storage_search.go func (bs *blockSearch) search(qs *QueryStats, bsw *blockSearchWork, bm *bitmap) { bs.reset() bs.qs = qs bs.bsw = bsw // bitmap ç”¨æ¥å­˜å‚¨ block ä¸­å‘½ä¸­çš„ log entry çš„â€˜ç´¢å¼•â€™ bm.init(int(bsw.bh.rowsCount)) // å°†æ‰€æœ‰çš„ä½æ ‡è®°ä¸º 1ï¼ˆåˆå§‹çŠ¶æ€ï¼Œä»£è¡¨æ‰€æœ‰è¡Œéƒ½éœ€è¦æ£€æµ‹ï¼‰ bm.setBits() // filter æ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”¨æ¥å®ç° log entries çš„è¿‡æ»¤ // ä¸ä»…æœ‰ = (filterExact) è¿™ç§ç®€å•çš„è¿‡æ»¤ï¼Œè¿˜æ”¯æŒé€»è¾‘è¡¨è¾¾: ä¸”ï¼ˆfilterAnd) è¿™æ ·å¯ä»¥ç»„ç»‡æˆä¸€ä¸ªå¤æ‚çš„é€»è¾‘ filter bs.bsw.pso.filter.applyToBlockSearch(bs, bm) // å¦‚æœæ²¡æœ‰å‘½ä¸­ä»»ä½• log entryï¼Œç›´æ¥è¿”å› if bm.isZero() { return } // å°† block ä¸­çš„ bs.br.mustInit(bs, bm) // è·å–éœ€è¦çš„åˆ—ï¼Œé€šè¿‡ â€œ | fields level, streamID, timestamp, messageâ€ è¿™ç§æ–¹å¼æ¥æŒ‡å®š bs.br.initColumns(bsw.pso.fieldsFilter) } type filter interface { String() string // è¿”å› filter çš„å­—ç¬¦ä¸²è¡¨ç¤º updateNeededFields(pf *prefixfilter.Filter) matchRow(fields []Field) bool // å³æ ¹æ® filter è¿‡æ»¤å‡º bs ä¸­å‘½ä¸­çš„ log entry çš„â€˜ç´¢å¼•â€™ï¼Œå¹¶æ›´æ–°åˆ° bm ä¸­ (æ ‡è®°æˆ–è€…å–æ¶ˆæ ‡è®°) applyToBlockSearch(bs *blockSearch, bm *bitmap) // å³æ ¹æ® filter è¿‡æ»¤å‡º br ä¸­å‘½ä¸­çš„ log entry çš„â€˜ç´¢å¼•â€™ï¼Œå¹¶æ›´æ–°åˆ° bm ä¸­(æ ‡è®°æˆ–è€…å–æ¶ˆæ ‡è®°) applyToBlockResult(br *blockResult, bm *bitmap) } è¿™é‡Œå†è¿›ä¸€æ­¥æ·±å…¥å°±æ˜¯å„ç§ filter çš„å®ç°äº†ï¼Œå› æ­¤ä¸å†å±•å¼€ï¼Œè¿™é‡Œåªå…³æ³¨ä¸‹ Block å†…æ˜¯æ€ä¹ˆå¯¹ åˆ—å¼å­˜å‚¨ç»“æ„ è¿›è¡Œæ£€ç´¢çš„ï¼Ÿ\nè¿™é‡Œä»¥ filterExact ä¸ºä¾‹ï¼Œæ¥å±•ç¤ºä¸‹ Block æ˜¯æ€ä¹ˆå¯¹ åˆ—å¼å­˜å‚¨ç»“æ„ è¿›è¡Œæ£€ç´¢æ¯”è¾ƒçš„ã€‚\nä¸¾ä¾‹ï¼šfilterExact åŒ¹é… // filterExact åŒ¹é…æŒ‡å®šå­—æ®µçš„ç²¾ç¡®å€¼ // // Example LogsQL: `fieldName:exact(\u0026#34;foo bar\u0026#34;)` of `fieldName:=\u0026#34;foo bar\u0026#34;` type filterExact struct { fieldName string // ä»£è¡¨çš„æ˜¯éœ€è¦åŒ¹é…çš„å­—æ®µå value string // ä»£è¡¨çš„æ˜¯éœ€è¦åŒ¹é…çš„å­—æ®µå€¼ tokens []string tokensHashes []uint64 } // lib/logstorage/filter_exact.go func (fe *filterExact) applyToBlockSearch(bs *blockSearch, bm *bitmap) { fieldName := fe.fieldName value := fe.value // å…ˆåˆ¤æ–­æ˜¯å¦æ˜¯ const åˆ— (æ‰€æœ‰è¡Œè¿™ä¸€åˆ—çš„å€¼éƒ½æ˜¯ç›¸åŒçš„)ã€‚ // å¦‚æœæ˜¯ï¼Œå¯ä»¥ç›´æ¥æ¯”è¾ƒ value æ˜¯å¦ç›¸ç­‰ï¼Œä¸”åªéœ€è¦æ¯”è¾ƒä¸€æ¬¡å°±èƒ½ç¡®å®šæ˜¯å¦å‘½ä¸­ v := bs.getConstColumnValue(fieldName) if v != \u0026#34;\u0026#34; { if value != v { bm.resetBits() } return } // å¦‚æœä¸æ˜¯ const åˆ—ï¼Œæ£€æŸ¥åˆ—æ˜¯å¦å­˜åœ¨ï¼Œå¹¶è·å–åˆ° column headerï¼š // 1. `column_names.bin` æä¾› column_name å’Œ column_id çš„æ˜ å°„ // 2. `columns_header_index.bin` æä¾› column_id åˆ° column header çš„åç§»é‡æ˜ å°„ // 3. `column_idxs.bin` æä¾› column_name åˆ° bloom/values shardId çš„æ˜ å°„ ch := bs.getColumnHeader(fieldName) if ch == nil { // åˆ—ä¸å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæŸ¥è¯¢å€¼ä¸æ˜¯ç©ºï¼Œé‚£ä¹ˆéœ€è¦é‡ç½® bitmap if value != \u0026#34;\u0026#34; { bm.resetBits() } return } tokens := fe.getTokensHashes() switch ch.valueType { case valueTypeString: matchStringByExactValue(bs, ch, bm, value, tokens) case valueTypeDict: matchValuesDictByExactValue(bs, ch, bm, value) case valueTypeUint8: matchUint8ByExactValue(bs, ch, bm, value, tokens) // ... çœç•¥å…¶ä»–æ•°å€¼ç±»å‹ case valueTypeIPv4: matchIPv4ByExactValue(bs, ch, bm, value, tokens) case valueTypeTimestampISO8601: matchTimestampISO8601ByExactValue(bs, ch, bm, value, tokens) default: logger.Panicf(\u0026#34;FATAL: %s: unknown valueType=%d\u0026#34;, bs.partPath(), ch.valueType) } } // columnHeader ä»£è¡¨åˆ—çš„å…ƒæ•°æ®ä¿¡æ¯, å®ƒä¸€å®šåªå¯¹åº”ä¸€ä¸ª Block ä¸­çš„ä¸€åˆ— // æ³¨æ„å¦‚æœ name ä¸ºç©ºï¼Œé‚£ä¹ˆå®ƒä»£è¡¨çš„ message(_msg) åˆ— type columnHeader struct { name string valueType valueType // åˆ—ä¸­å­˜å‚¨çš„å€¼çš„ç±»å‹ minValue uint64 // åˆ—ä¸­å­˜å‚¨çš„æœ€å°å€¼, ç”¨äºå¿«é€Ÿåˆ¤æ–­æ˜¯å¦åœ¨ç»™å®šçš„èŒƒå›´å†…ã€‚é€‚ç”¨äº uint*, ipv4, timestamp å’Œ float64 ç±»å‹ maxValue uint64 // åˆ—ä¸­å­˜å‚¨çš„æœ€å¤§å€¼, ç”¨äºå¿«é€Ÿåˆ¤æ–­æ˜¯å¦åœ¨ç»™å®šçš„èŒƒå›´å†…ã€‚é€‚ç”¨äº uint*, ipv4, timestamp å’Œ float64 ç±»å‹ valuesDict valuesDict // åˆ—ä¸­å­˜å‚¨çš„å”¯ä¸€å€¼å­—å…¸, é€‚ç”¨äº valueType = valueTypeDict ç±»å‹ valuesOffset uint64 // åˆ—ä¸­å­˜å‚¨çš„ values çš„åç§»é‡, ç”¨äºå¿«é€Ÿå®šä½åˆ° values.bin ä¸­çš„å¯¹åº”ä½ç½® valuesSize uint64 // åˆ—ä¸­å­˜å‚¨çš„ values çš„å¤§å°, ç”¨äºå¿«é€Ÿå®šä½åˆ° values.bin ä¸­çš„å¯¹åº”ä½ç½® bloomFilterOffset uint64 // åˆ—ä¸­å­˜å‚¨çš„ bloom filter çš„åç§»é‡, ç”¨äºå¿«é€Ÿå®šä½åˆ° bloom.bin ä¸­çš„å¯¹åº”ä½ç½® bloomFilterSize uint64 // åˆ—ä¸­å­˜å‚¨çš„ bloom filter çš„å¤§å°, ç”¨äºå¿«é€Ÿå®šä½åˆ° bloom.bin ä¸­çš„å¯¹åº”ä½ç½® } åˆ°è¿™é‡Œä¹Ÿåªæ˜¯å®Œæˆäº†æŸ¥è¯¢ column header çš„è¿‡ç¨‹ï¼Œæ¥ä¸‹æ¥éœ€è¦æ ¹æ® column header åˆ¤æ–­å…·ä½“å‘½ä¸­äº†å“ªäº›è¡Œï¼š\nvalues åŒ¹é… // lib/logstore/filter_exact.go func matchStringByExactValue(bs *blockSearch, ch *columnHeader, bm *bitmap, value string, tokens []uint64) { // å…ˆåˆ¤æ–­ bloom filter æ˜¯å¦å‘½ä¸­, å¦‚æœ bloom filter ä¸å‘½ä¸­, é‚£ä¹ˆç›´æ¥è¿”å› if !matchBloomFilterAllTokens(bs, ch, tokens) { bm.resetBits() return } visitValues(bs, ch, bm, func(v string) bool { return v == value }) } // lib/logstore/filter_phrase.go func visitValues(bs *blockSearch, ch *columnHeader, bm *bitmap, f func(value string) bool) { if bm.isZero() { // Fast path - nothing to visit return } // æ ¹æ® åˆ—å¤´ æ¥è·å– values // 1. åˆ—å ç¡®å®š å† values.bin çš„å“ªä¸€ä¸ªåˆ†ç‰‡ // 2. å†æ ¹æ® columnHeader å­˜å‚¨çš„ valuesOffset å’Œ valuesSize æ¥è¯»å– values values := bs.getValuesForColumn(ch) bm.forEachSetBit(func(idx int) bool { return f(values[idx]) }) } åˆ°è¿™é‡Œæ•´ä¸ªæŸ¥è¯¢è¿‡ç¨‹ä¹Ÿå·®ä¸å¤šå®Œæˆäº†ï¼Œå‰©ä¸‹çš„éƒ¨åˆ†å°±æ˜¯æ ¹æ®å‘½ä¸­çš„è¡Œç´¢å¼•æ¥è·å–éœ€è¦è¿”å›çš„ fields çš„å€¼äº†ã€‚è¿™é‡Œé™äºç¯‡å¹…ï¼Œå°±ä¸å±•å¼€äº†ã€‚\nå°ç»“ï¼š\næ€»ç»“ä¸€ä¸‹æŸ¥è¯¢è¿‡ç¨‹ï¼š\næ ¹æ®æŸ¥è¯¢æ¡ä»¶ï¼Œç¡®å®šéœ€è¦æŸ¥è¯¢çš„åˆ†åŒºå’Œ partï¼› å¹¶å‘æŸ¥è¯¢æ¯ä¸ªåˆ†åŒºçš„æ¯ä¸ª partï¼ŒæŸ¥è¯¢æ—¶æ ¹æ® indexBlockHeader è¿‡æ»¤å‡ºå¯èƒ½å‘½ä¸­çš„ blockï¼› å¯¹æ¯ä¸ªå‘½ä¸­çš„ blockï¼š å…ˆæ£€æŸ¥åŒ¹é…çš„å­—æ®µæ˜¯ä¸æ˜¯å¸¸é‡åˆ—ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆåˆ¤æ–­ä¸€æ¬¡å³å¯ï¼› å¦‚æœæ˜¯æ™®é€šåˆ—ï¼Œé‚£ä¹ˆå…ˆè·å–åˆ—å¤´ï¼Œæ£€æŸ¥åˆ—æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥ç›´æ¥è¿”å›ï¼› å¦‚æœåˆ—å­˜åœ¨ï¼Œä¹Ÿä¸ç›´æ¥åŠ è½½ valuesï¼Œè€Œæ˜¯å…ˆåˆ¤æ–­ bloom filter æ˜¯å¦æœªå‘½ä¸­ï¼Œå¦‚æœæœªå‘½ä¸­ï¼Œé‚£ä¹ˆä»£è¡¨è¯¥ block ä¸­ä¸€å®šä¸å­˜åœ¨è¯¥å€¼ï¼Œç›´æ¥è¿”å›ï¼› æœ€åéå†è¿™ä¸€åˆ—æ‰€æœ‰çš„ valuesï¼Œè¿™é‡Œä¹Ÿä¸ä¼šéå†æ‰€æœ‰çš„ valuesï¼Œè€Œæ˜¯åªéå† bitmap ä¸­è®¾ç½®ä¸º 1 çš„ä½ç½®ï¼ˆè¿™äº›ä½ç½®å¯èƒ½æ˜¯å‰ç½® filter å·²ç»æ ‡è®°ä¸ºå‘½ä¸­çš„ä½ç½®ï¼‰ï¼› å­˜å‚¨æ¨¡å‹ # è‡ªå·±æœ¬åœ°å¯åŠ¨ä¸€ä¸ª Victoria Logsï¼Œå†å†™å…¥æ•°æ®ï¼Œå¯ä»¥ç›´è§‚çš„çœ‹åˆ°å­˜å‚¨å¼•æ“çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š\nä»£ç ç‰‡æ®µ /storage/ â”œâ”€â”€ partitions/ â”‚ â”œâ”€â”€ 20251210/ â”‚ â”‚ â”œâ”€â”€ indexdb â”‚ â”‚ â”‚ â”œâ”€â”€ 18804EBAD6A6ECA1 â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ index.bin â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ items.bin â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ lens.bin â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ metadata.json â”‚ â”‚ â”‚ â”‚ â””â”€â”€ metaindex.bin â”‚ â”‚ â”‚ â”œâ”€â”€ 18804EBAD6A6ECB9 â”‚ â”‚ â”‚ â”œâ”€â”€ ... â”‚ â”‚ â”‚ â”œâ”€â”€ 18804EBAD6A6ECB8 â”‚ â”‚ â”‚ â””â”€â”€ parts.json â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€ datadb/ â”‚ â”‚ â”œâ”€â”€ 18804EBAD6A80650 â”‚ â”‚ â”‚ â”œâ”€â”€ bloom.bin0 â”‚ â”‚ â”‚ â”œâ”€â”€ bloom.bin1 â”‚ â”‚ â”‚ â”œâ”€â”€ bloom.bin2 â”‚ â”‚ â”‚ â”œâ”€â”€ bloom.bin3 â”‚ â”‚ â”‚ â”œâ”€â”€ bloom.bin4 â”‚ â”‚ â”‚ â”œâ”€â”€ column_idxs.bin â”‚ â”‚ â”‚ â”œâ”€â”€ column_names.bin â”‚ â”‚ â”‚ â”œâ”€â”€ columns_header.bin â”‚ â”‚ â”‚ â”œâ”€â”€ columns_header_index.bin â”‚ â”‚ â”‚ â”œâ”€â”€ index.bin â”‚ â”‚ â”‚ â”œâ”€â”€ message_bloom.bin â”‚ â”‚ â”‚ â”œâ”€â”€ message_values.bin â”‚ â”‚ â”‚ â”œâ”€â”€ metadata.json â”‚ â”‚ â”‚ â”œâ”€â”€ metaindex.bin â”‚ â”‚ â”‚ â”œâ”€â”€ timestamps.bin â”‚ â”‚ â”‚ â”œâ”€â”€ values.bin0 â”‚ â”‚ â”‚ â”œâ”€â”€ values.bin1 â”‚ â”‚ â”‚ â”œâ”€â”€ values.bin2 â”‚ â”‚ â”‚ â”œâ”€â”€ values.bin3 â”‚ â”‚ â”‚ â””â”€â”€ values.bin4 â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ 18804EBAD6A80FF6 â”‚ â”‚ â”œâ”€â”€ ... â”‚ â”‚ â”œâ”€â”€ 18804EBAD6A81004 â”‚ â”‚ â””â”€â”€ parts.json â”‚ â”‚ â”‚ â”‚â”€â”€ 20251211/ â”‚ â”‚â”€â”€ ... â”‚ â””â”€â”€ 20251213/ â”‚ â””â”€â”€ flock.lock å…¶å®ä»ä¸Šé¢çš„æ–‡ä»¶ç›®å½•ç»“æ„å¯ä»¥çœ‹å‡ºæ¥ï¼ŒVictoriaLogs å­˜å‚¨ä¸Šåˆ†æˆäº†ä¸‰å±‚ï¼š\nStorage è¿™æ˜¯å­˜å‚¨å¼•æ“çš„æœ€é¡¶å±‚ï¼Œæ‰€æœ‰æ•°æ®éƒ½å­˜å‚¨åœ¨è¿™ä¸ªç›®å½•ä¸‹ã€‚ Partition è¿™æ˜¯å­˜å‚¨å¼•æ“çš„ç¬¬äºŒå±‚ï¼Œæ¯ä¸ª Partition å¯¹åº”ä¸€ä¸ªæ—¥æœŸï¼Œè¿™ä¸ªæ—¶é—´èŒƒå›´å†…çš„æ•°æ®æŒ‰ç…§ Part è¿›è¡Œå­˜å‚¨ã€‚ Part è¿™æ˜¯å­˜å‚¨å¼•æ“çš„ç¬¬ä¸‰å±‚ï¼Œæ¯ä¸ª Part ä»£è¡¨çš„æ˜¯åˆå¹¶å‹ç¼©åçš„æ•°æ®ï¼Œå…¶ä¸­å­˜å‚¨äº†å…·ä½“çš„æ•°æ®å’Œç´¢å¼•ä¿¡æ¯ã€‚ Block å¯ä»¥è®¤ä¸ºæ˜¯ç¬¬å››å±‚ï¼Œæ¯ä¸ª Block ä»£è¡¨çš„æ˜¯åŒä¸€ä¸€ä¸ª Stream çš„æ•°æ®ï¼ˆç‰©ç†ä¸Šç›¸é‚»ï¼‰ã€‚å¤šä¸ª Block ç»„æˆäº†ä¸€ä¸ª Partã€‚ æ¯ä¸ª Partition éƒ½åŒ…å«äº† indexdb å’Œ datadb:\nindexdb ä¿å­˜ stream çš„ç´¢å¼•ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šæ ‡ç­¾ã€tenantIDã€streamID ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚ datadb æ—¥å¿—æ•°æ®ï¼Œæ¯ä¸ª stream ä¼šæœ‰ä¸€ä¸ªå”¯ä¸€çš„ IDï¼ŒåŒä¸€ä¸ª stream çš„æ•°æ®åœ¨ç‰©ç†ä¸Šç›¸è¿‘ä¿å­˜ï¼›datadb å­˜å‚¨çš„æ•°æ®æ˜¯åˆ—æ ¼å¼çš„ï¼Œåˆ†ä¸º message, timestampï¼Œcolumns ä¸‰ç§ç±»å‹åˆ†å¼€å­˜å‚¨ï¼›ä½¿ç”¨äº† bloom è¿‡æ»¤å™¨æ¥å¿«é€Ÿåˆ¤æ–­æ˜¯å¦å­˜åœ¨æŸä¸ªå­—æ®µå€¼ã€‚ å¯¹åº”çš„å­˜å‚¨æ¨¡å‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nVictoriaLogs å­˜å‚¨æ¨¡å‹ æ€»ç»“ # é€šè¿‡æ·±å…¥ VictoriaLogs çš„å†™å…¥å’ŒæŸ¥è¯¢è¿‡ç¨‹ï¼Œå¯ä»¥å‘ç°å®ƒçš„å­˜å‚¨å¼•æ“åšäº†é’ˆå¯¹ æ—¥å¿—åœºæ™¯ åšäº†å¾ˆå¤šä¼˜åŒ–æ¥æé«˜æŸ¥è¯¢æ•ˆç‡å’ŒèŠ‚çœå­˜å‚¨å¼€é”€ï¼š\næŒ‰ç…§æ—¥æœŸè®¾è®¡åˆ†åŒºï¼Œå¦‚æœæŸ¥è¯¢ç‰¹å®šæ—¶é—´èŒƒå›´å†…ï¼Œå¯ä»¥åªæŸ¥è¯¢æ¶‰åŠåˆ°çš„åˆ†åŒºï¼› åˆ†åŒºæŒ‰ç…§ part è¿›è¡Œåˆ’åˆ†ï¼Œpart ä¸Šè®¾è®¡äº† æœ€å° streamID å’Œ è¦†ç›–çš„æ—¶é—´çš„èŒƒå›´ï¼Œç”¨äºå¸®åŠ©è¿‡æ»¤ï¼› åˆ†åŒºå†…æä¾›äº† indexBlockHeaderï¼ˆä»£è¡¨å¤šä¸ª blockHeaderï¼‰å’Œ blockHeader è¿›ä¸€æ­¥å¸®åŠ©è¿‡æ»¤ï¼Œå‡å°æ‰«æèŒƒå›´ï¼› Block ä¸­å°†åˆ—åˆ†æˆäº† const column å’Œ æ™®é€š columnï¼Œconst column å­˜å‚¨æ—¶åªéœ€è¦å­˜å‚¨ä¸€ä¸ªå€¼ï¼Œæ¯”è¾ƒæ—¶ä¹Ÿåªéœ€è¦æ¯”è¾ƒä¸€æ¬¡å°±èƒ½ç¡®å®š block æ˜¯å¦å‘½ä¸­ï¼› å°†åŒä¸€ä¸ª Stream æ•°æ®ç›¸é‚»å­˜å‚¨ï¼› æ™®é€šåˆ—çš„å€¼å­˜å‚¨åœ¨ä¸€èµ·ï¼Œè¯»å–æ—¶é¡ºåºè¯»å–ï¼Œé€Ÿåº¦æ›´å¿«ï¼› ä½¿ç”¨ bitmap åœ¨ filter ä¸­ä¼ é€’ï¼Œé¿å…é‡å¤æ£€æµ‹å·²ç»ç¡®å®šæœªå‘½ä¸­çš„è¡Œï¼› ä½¿ç”¨ bloom filter æ¥å¿«é€Ÿåˆ¤æ–­æœªå‘½ä¸­ï¼Œå‡å°‘ä¸å¿…è¦çš„è¯»å– valuesï¼› æŸ¥è¯¢æ—¶åˆ†åŒº å’Œ part éƒ½æ˜¯å¹¶å‘æŸ¥è¯¢çš„ï¼› é‡‡ç”¨ ZSTD å‹ç¼©å­˜å‚¨; é™¤äº†è®¾è®¡ä¸Šçš„ä¼˜åŒ–ï¼Œè¿˜æœ‰å¾ˆå¤š golang å®ç°ä¸Šçš„ä¼˜åŒ–ï¼š\néšå¤„å¯è§çš„ sync.Pool ç”¨æ¥å¤ç”¨å¯¹è±¡ï¼Œé¿å…é¢‘ç¹åˆ†é…å’Œé‡Šæ”¾å†…å­˜ï¼› slice åŒæ ·ä¹Ÿè¢«å¤ç”¨ï¼› å……åˆ†åˆ©ç”¨ goroutine å¹¶å‘æŸ¥è¯¢ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ï¼› æ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿å‹˜è¯¯æŒ‡æ­£ ğŸ™\nå‚è€ƒ # Github - VictoriaLogs Github - VictoriaMetrics VictoriaLogs Docs DeepWiki - VictoriaLogs "},{"id":2,"href":"/2025/11/06/%E8%AF%91-Golang%E7%BB%BF%E8%8C%B6%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/","title":"è¯‘ï¼šThe Green Tea Garbage Collector","section":"Posts","content":" åŸæ–‡é“¾æ¥ï¼šThe Green Tea Garbage Collector\nGo 1.25 å¼•å…¥äº†ä¸€æ¬¾åä¸º Green Tea çš„æ–°å‹å®éªŒæ€§åƒåœ¾å›æ”¶å™¨ï¼Œåœ¨æ„å»ºæ—¶é€šè¿‡è®¾ç½® GOEXPERIMENT=greenteagc æ¥å¯ç”¨ã€‚\nè®¸å¤šå·¥ä½œè´Ÿè½½åœ¨åƒåœ¾å›æ”¶ä¸ŠèŠ±è´¹çš„æ—¶é—´å‡å°‘äº†çº¦ 10%ï¼Œä½†æœ‰äº›å·¥ä½œè´Ÿè½½çš„é™å¹…é«˜è¾¾ 40%ï¼å®ƒå·²ç»ä¸ºç”Ÿäº§ç¯å¢ƒåšå¥½äº†å‡†å¤‡ï¼Œå¹¶ä¸”å·²ç»åœ¨ Google å†…éƒ¨ä½¿ç”¨ï¼Œæˆ‘ä»¬é¼“åŠ±æ‚¨å°è¯•ä¸€ä¸‹ã€‚æˆ‘ä»¬çŸ¥é“æœ‰äº›å·¥ä½œè´Ÿè½½å—ç›Šä¸å¤šï¼Œç”šè‡³æ ¹æœ¬æ²¡æœ‰å—ç›Šï¼Œå› æ­¤æ‚¨çš„åé¦ˆå¯¹äºæˆ‘ä»¬æœªæ¥çš„å·¥ä½œè‡³å…³é‡è¦ã€‚\næ ¹æ®æˆ‘ä»¬ç°åœ¨æŒæ¡çš„æ•°æ®ï¼Œæˆ‘ä»¬è®¡åˆ’åœ¨ Go 1.26 ä¸­å°†å…¶ä½œä¸ºé»˜è®¤è®¾ç½®ã€‚è¦æŠ¥å‘Šä»»ä½•é—®é¢˜ï¼Œè¯·æäº¤ä¸€ä¸ªæ–° issueã€‚è¦æŠ¥å‘Šä»»ä½•æˆåŠŸæ¡ˆä¾‹ï¼Œè¯·å›å¤ç°æœ‰çš„ Green Tea issueã€‚\næœ¬æ–‡æ˜¯æ ¹æ® Michael Knyszek åœ¨ GopherCon 2025 ä¸Šçš„æ¼”è®²æ•´ç†è€Œæˆçš„åšå®¢æ–‡ç« ã€‚ä¸€æ—¦æ¼”è®²è§†é¢‘åœ¨çº¿å‘å¸ƒï¼Œæˆ‘ä»¬å°†æ›´æ–°è¿™ç¯‡åšæ–‡å¹¶é™„ä¸Šé“¾æ¥ã€‚\nç†è§£åƒåœ¾å›æ”¶ # åœ¨æˆ‘ä»¬è®¨è®º Green Tea ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆå°±åƒåœ¾å›æ”¶è¾¾æˆå…±è¯†ã€‚\nå¯¹è±¡å’ŒæŒ‡é’ˆ # åƒåœ¾å›æ”¶çš„ç›®çš„æ˜¯è‡ªåŠ¨å›æ”¶å’Œé‡ç”¨ç¨‹åºä¸å†ä½¿ç”¨çš„å†…å­˜ã€‚ä¸ºæ­¤ï¼ŒGo åƒåœ¾å›æ”¶å™¨å…³æ³¨çš„æ˜¯ å¯¹è±¡ å’Œ æŒ‡é’ˆã€‚\nåœ¨ Go è¿è¡Œæ—¶çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå¯¹è±¡æ˜¯å…¶åº•å±‚å†…å­˜åœ¨å †ä¸Šåˆ†é…çš„ Go å€¼ã€‚å½“ Go ç¼–è¯‘å™¨æ— æ³•ç¡®å®šå€¼çš„ç”Ÿå‘½å‘¨æœŸæ—¶ï¼Œå°±ä¼šåœ¨å †ä¸Šåˆ†é…å†…å­˜ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç ç‰‡æ®µåˆ†é…äº†ä¸€ä¸ªå †å¯¹è±¡ï¼šä¸€ä¸ªæŒ‡é’ˆåˆ‡ç‰‡çš„åº•å±‚å­˜å‚¨ç©ºé—´ã€‚\nvar x = make([]*int, 10) // å…¨å±€å˜é‡ Go ç¼–è¯‘å™¨æ— æ³•å°†åˆ‡ç‰‡åº•å±‚å­˜å‚¨åˆ†é…åœ¨å †ä»¥å¤–çš„ä»»ä½•åœ°æ–¹ï¼Œå› ä¸ºå®ƒå¾ˆéš¾çŸ¥é“ï¼ˆç”šè‡³ä¸å¯èƒ½çŸ¥é“ï¼‰ x ä¼šå¼•ç”¨è¯¥å¯¹è±¡å¤šé•¿æ—¶é—´ã€‚\næŒ‡é’ˆåªæ˜¯æŒ‡ç¤º Go å€¼åœ¨å†…å­˜ä¸­ä½ç½®çš„æ•°å­—ï¼ŒGo ç¨‹åºå°±æ˜¯é€šè¿‡æŒ‡é’ˆæ¥å¼•ç”¨å¯¹è±¡çš„ã€‚ä¾‹å¦‚ï¼Œè¦è·å–ä¸Šä¸€ä¸ªä»£ç ç‰‡æ®µä¸­åˆ†é…çš„å¯¹è±¡çš„èµ·å§‹åœ°å€çš„æŒ‡é’ˆï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ï¼š\n\u0026amp;x[0] // 0xc000104000 æ ‡è®°æ¸…é™¤ # Go çš„åƒåœ¾å›æ”¶å™¨éµå¾ªä¸€ç§å¹¿ä¹‰ä¸Šç§°ä¸ºè¿½è¸ªå¼åƒåœ¾å›æ”¶çš„ç­–ç•¥ï¼Œè¿™æ„å‘³ç€åƒåœ¾å›æ”¶å™¨ä¼šè·Ÿéšæˆ–â€œè¿½è¸ªâ€ç¨‹åºä¸­çš„æŒ‡é’ˆï¼Œä»¥ç¡®å®šç¨‹åºä»åœ¨ä½¿ç”¨çš„å¯¹è±¡ã€‚\næ›´å…·ä½“åœ°è¯´ï¼ŒGo åƒåœ¾å›æ”¶å™¨å®ç°äº†***æ ‡è®°-æ¸…é™¤ï¼ˆMark-and-Sweepï¼‰***ç®—æ³•ï¼Œè¿™ä¸ªåå­—å¾ˆå½¢è±¡åœ°æè¿°äº†å®ƒçš„å·¥ä½œåŸç†ã€‚\næƒ³è±¡ä¸€ä¸‹ï¼Œå¯¹è±¡å’ŒæŒ‡é’ˆå°±åƒè®¡ç®—æœºç§‘å­¦ä¸­çš„å›¾ï¼šå¯¹è±¡æ˜¯èŠ‚ç‚¹ï¼ŒæŒ‡é’ˆæ˜¯è¾¹ã€‚\næ ‡è®°-æ¸…é™¤ç®—æ³•å°±ä½œç”¨äºè¿™ä¸ªå›¾ï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒåˆ†ä¸¤ä¸ªé˜¶æ®µè¿›è¡Œï¼š\nç¬¬ä¸€ä¸ªé˜¶æ®µï¼šå³ æ ‡è®° é˜¶æ®µã€‚\nä»ç§°ä¸º æ ¹ï¼ˆRootsï¼‰ çš„æ˜ç¡®å®šä¹‰çš„èµ·å§‹ç‚¹ï¼ˆå¯ä»¥æƒ³è±¡æˆå…¨å±€å˜é‡å’Œå½“å‰å‡½æ•°è°ƒç”¨æ ˆä¸­çš„å±€éƒ¨å˜é‡ï¼‰å¼€å§‹éå†å¯¹è±¡å›¾ã€‚ç„¶åï¼Œåƒåœ¾å›æ”¶å™¨å°†æ²¿é€”æ‰¾åˆ°çš„æ‰€æœ‰å¯¹è±¡éƒ½æ ‡è®°ä¸ºâ€œå·²è®¿é—®â€ï¼Œä»¥é¿å…é‡å¤è®¿é—®å’Œå¾ªç¯ã€‚è¿™ç±»ä¼¼äºå›¾éå†ç®—æ³•ï¼Œå¦‚æ·±åº¦ä¼˜å…ˆæœç´¢ï¼ˆDFSï¼‰æˆ–å¹¿åº¦ä¼˜å…ˆæœç´¢ï¼ˆBFSï¼‰ã€‚\nç¬¬äºŒä¸ªé˜¶æ®µï¼šå³ æ¸…é™¤ é˜¶æ®µã€‚\nåœ¨å›¾éå†ç»“æŸåï¼Œæ‰€æœ‰æœªè¢«è®¿é—®åˆ°çš„å¯¹è±¡å°±æ˜¯ç¨‹åºä¸å†ä½¿ç”¨æˆ–â€œæ— æ³•è®¿é—®â€çš„äº†ã€‚æˆ‘ä»¬ç§°è¿™ç§çŠ¶æ€ä¸ºä¸å¯è¾¾ï¼Œå› ä¸ºåœ¨éµå¾ª Go è¯­è¨€è§„èŒƒçš„æ­£å¸¸ä»£ç ä¸­ï¼Œå·²ç»æ— æ³•å†è®¿é—®åˆ°è¿™å—å†…å­˜äº†ã€‚\nè¦å®Œæˆæ¸…é™¤ï¼Œç®—æ³•åªéœ€éå†æ‰€æœ‰æœªè¢«æ ‡è®°ä¸ºâ€œå·²è®¿é—®â€çš„å¯¹è±¡ï¼Œå¹¶å°†å…¶å†…å­˜æ ‡è®°ä¸ºç©ºé—²ï¼Œä»¥ä¾¿å†…å­˜åˆ†é…å™¨å¯ä»¥é‡æ–°ä½¿ç”¨å®ƒä»¬ã€‚\nå°±è¿™ï¼Ÿ # ä½ å¯èƒ½è§‰å¾—æˆ‘è®²å¾—è¿‡äºç®€å•äº†ï¼Œæ¯•ç«Ÿåƒåœ¾å›æ”¶å™¨å¸¸å¸¸è¢«è®¤ä¸ºæ˜¯é­”æ³•å’Œé»‘ç›’ã€‚ä½ è¯´å¯¹äº†ä¸€éƒ¨åˆ†ï¼Œåƒåœ¾å›æ”¶å™¨çš„å®ç°ç¡®å®è¿˜æœ‰å¾ˆå¤šå¤æ‚æ€§å’Œç»†èŠ‚ã€‚\nä¾‹å¦‚ï¼Œè¯¥ç®—æ³•å®é™…ä¸Šä¼šä¸ä½ çš„ Go ä»£ç å¹¶å‘æ‰§è¡Œï¼šåœ¨ä¸€ä¸ªä¸æ–­å˜åŒ–çš„å›¾ä¸Šè¿›è¡Œéå†ä¼šå¸¦æ¥æŒ‘æˆ˜ã€‚æˆ‘ä»¬è¿˜å¹¶è¡ŒåŒ–äº†è¿™ä¸ªç®—æ³•ï¼Œè¿™ä¸ªç»†èŠ‚ç¨åä¼šå†æ¬¡æåˆ°ã€‚\nä½†è¯·ç›¸ä¿¡æˆ‘ï¼Œè¿™äº›ç»†èŠ‚åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šä¸æ ¸å¿ƒç®—æ³•æ˜¯ç‹¬ç«‹çš„ï¼Œå…¶æ ¸å¿ƒç¡®å®åªæ˜¯ä¸€ä¸ªç®€å•çš„å›¾éå†ç®—æ³•ã€‚\nç®—æ³•æ¼”ç¤ºï¼šGraph Flood # è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š\nè¿™æ˜¯ä¸€å¼ å…¨å±€å˜é‡å’Œ Go å †çš„å›¾è¡¨ï¼Œè®©æˆ‘ä»¬ä¸€æ­¥æ­¥æ¥åˆ†æã€‚\nå·¦è¾¹æ˜¯æˆ‘ä»¬çš„æ ¹èŠ‚ç‚¹ï¼Œå³å…¨å±€å˜é‡ x å’Œ yã€‚å®ƒä»¬æ˜¯å›¾éå†çš„èµ·ç‚¹ã€‚æ ¹æ®å·¦ä¸‹è§’çš„å›¾ä¾‹ï¼Œè“è‰²æ ‡è®°è¡¨ç¤ºå®ƒä»¬å½“å‰ä½äºæˆ‘ä»¬çš„å·¥ä½œåˆ—è¡¨ä¸­ã€‚\nå³è¾¹æ˜¯æˆ‘ä»¬çš„å †ã€‚ç›®å‰ï¼Œå †ä¸­çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¾ç¤ºä¸ºç°è‰²ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰å¼€å§‹éå†å®ƒä»¬ã€‚\næ¯ä¸€ä¸ªçŸ©å½¢éƒ½ä»£è¡¨ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶æ ‡è®°äº†å®ƒçš„ç±»å‹ã€‚æ¡†é€‰å‡ºæ¥çš„æ˜¯ä¸€ä¸ª T ç±»å‹çš„å¯¹è±¡ï¼Œå®ƒçš„ç±»å‹å®šä¹‰åœ¨å·¦ä¸Šè§’ã€‚ç±»å‹ T æ‹¥æœ‰ä¸€ä¸ªæŒ‡å‘å­å…ƒç´ æ•°ç»„çš„æŒ‡é’ˆ children å’Œä¸€ä¸ª int ç±»å‹çš„å€¼ã€‚çœ‹å¾—å‡ºæ¥è¿™æ˜¯ä¸€ç§é€’å½’çš„æ•°æ®ç»“æ„ã€‚\né™¤äº† T ç±»å‹çš„å¯¹è±¡ä¹‹å¤–ï¼Œä½ è¿˜ä¼šæ³¨æ„åˆ°æˆ‘ä»¬è¿˜æœ‰åŒ…å« *T çš„æ•°ç»„å¯¹è±¡ã€‚è¿™äº›å¯¹è±¡ç”± T ç±»å‹çš„ children å­—æ®µå¼•ç”¨ã€‚\nçŸ©å½¢å†…çš„æ¯ä¸ªæ–¹å—ä»£è¡¨ 8 å­—èŠ‚çš„å†…å­˜ã€‚å¸¦ç‚¹çš„æ–¹å—ä»£è¡¨æŒ‡é’ˆï¼Œå¦‚æœå®ƒæœ‰ç®­å¤´ï¼Œåˆ™å®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘å…¶ä»–å¯¹è±¡çš„éç©ºæŒ‡é’ˆã€‚\nå¦‚æœå®ƒæ²¡æœ‰å¯¹åº”çš„ç®­å¤´ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ä¸€ä¸ªç©ºæŒ‡é’ˆã€‚\nè¿™äº›è™šçº¿çŸ©å½¢ä»£è¡¨å¯ç”¨å†…å­˜ï¼Œæˆ‘ç§°ä¹‹ä¸ºç©ºé—²â€œæ’æ§½â€ã€‚æˆ‘ä»¬å¯ä»¥åœ¨é‚£é‡Œæ”¾ç½®ä¸€ä¸ªå¯¹è±¡ï¼Œå½“ç„¶ç›®å‰æ²¡æœ‰å¯¹è±¡å ç”¨è¿™äº›å†…å­˜ã€‚\nä½ åº”è¯¥æ³¨æ„åˆ°äº†ï¼Œå¯¹è±¡è¢«ä¸€äº›å¸¦æ ‡ç­¾çš„è™šçº¿åœ†è§’çŸ©å½¢ç»„åˆåœ¨äº†ä¸€èµ·ï¼ˆæ¡†é€‰ä¸­çš„éƒ¨åˆ†ï¼‰ã€‚å…¶ä¸­æ¯ä¸€ä¸ªéƒ½ä»£è¡¨ä¸€ä¸ªé¡µï¼ˆPageï¼‰ï¼Œå®ƒæ˜¯ä¸€ä¸ªè¿ç»­çš„ã€å›ºå®šå¤§å°ä¸”å¯¹é½çš„å†…å­˜å—ã€‚åœ¨ Go ä¸­ï¼Œé¡µé¢å¤§å°ä¸º 8 KiBï¼ˆæ— è®ºç¡¬ä»¶è™šæ‹Ÿå†…å­˜é¡µé¢å¤§å°å¦‚ä½•ï¼‰ã€‚åé¢æˆ‘ä»¬ä¼šç”¨ Aã€Bã€Cã€D æ¥æŒ‡ä»£è¿™å››ä¸ªé¡µé¢ã€‚\nåœ¨è¿™ä¸ªå›¾ä¸­ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½è¢«åˆ†é…åˆ°æŸä¸ªé¡µé¢ä¸­ã€‚è·Ÿå®é™…å®ç°çš„ä¸€æ ·ï¼Œæ¯ä¸€é¡µåªåŒ…å«ç‰¹å®šå¤§å°çš„å¯¹åº”å¯¹è±¡ï¼ŒGo å †å°±æ˜¯è¿™æ ·ç»„ç»‡çš„ã€‚\né¡µä¹Ÿæ˜¯æˆ‘ä»¬ç»„ç»‡æ¯ä¸ªå¯¹è±¡å…ƒæ•°æ®çš„æ–¹å¼ã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ°ä¸ƒä¸ªæ–¹æ¡†ï¼Œæ¯ä¸ªæ–¹æ¡†å¯¹åº”é¡µé¢ A ä¸­çš„ä¸ƒä¸ªå¯¹è±¡æ§½ä½ä¹‹ä¸€ã€‚\næ¯ä¸ªæ¡†ä½¿ç”¨ä¸€ä¸ªä½ï¼ˆbitï¼‰æ¥è¡¨æ˜æˆ‘ä»¬æ˜¯å¦å·²ç»è®¿é—®è¿‡è¿™ä¸ªå¯¹è±¡ã€‚å®é™…ä¸Šï¼Œè¿è¡Œæ—¶å°±æ˜¯é€šè¿‡è¿™ç§æ–¹å¼æ¥ç®¡ç†å¯¹è±¡æ˜¯å¦è¢«è®¿é—®è¿‡çš„ï¼Œè¿™ä¸€ç‚¹å¾ˆé‡è¦ã€‚\nç»†èŠ‚å¾ˆå¤šï¼Œæ„Ÿè°¢è€å¿ƒé˜…è¯»ï¼Œè¿™äº›å†…å®¹ç¨åéƒ½ä¼šæ´¾ä¸Šç”¨åœºã€‚\nç°åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å›¾éå†ç®—æ³•å¦‚ä½•åº”ç”¨äºè¿™å¼ å›¾ï¼š\næˆ‘ä»¬ä»å·¥ä½œåˆ—è¡¨ä¸­å–å‡ºä¸€ä¸ªæ ¹å¯¹è±¡ï¼Œå°†å…¶æ ‡è®°ä¸ºçº¢è‰²ï¼Œè¡¨ç¤ºå®ƒç°åœ¨å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚\næ²¿ç€è¯¥æ ¹å¯¹è±¡ï¼ˆxï¼‰çš„æŒ‡é’ˆï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†ä¸€ä¸ª T ç±»å‹çš„å¯¹è±¡ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°æˆ‘ä»¬çš„å·¥ä½œåˆ—è¡¨ä¸­ã€‚æ ¹æ®æˆ‘ä»¬çš„å›¾ä¾‹ï¼Œæˆ‘ä»¬å°†è¯¥å¯¹è±¡ç»˜åˆ¶æˆè“è‰²ä»¥è¡¨ç¤ºå®ƒåœ¨æˆ‘ä»¬çš„å·¥ä½œåˆ—è¡¨ä¸­ã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨å…ƒæ•°æ®ä¸­è®¾ç½®äº†ä¸æ­¤å¯¹è±¡å¯¹åº”çš„å·²è®¿é—®ä½ã€‚\nä¸‹ä¸€ä¸ªæ ¹å¯¹è±¡ï¼ˆyï¼‰ä¹ŸåŒæ ·å¤„ç†ã€‚\nç°åœ¨æˆ‘ä»¬å·²ç»å¤„ç†å®Œæ‰€æœ‰çš„æ ¹å¯¹è±¡ï¼Œå·¥ä½œåˆ—è¡¨ä¸­è¿˜å‰©ä¸‹ä¸¤ä¸ªå¯¹è±¡ã€‚è®©æˆ‘ä»¬ä»å·¥ä½œåˆ—è¡¨ä¸­å–å‡ºä¸€ä¸ªå¯¹è±¡ã€‚\næˆ‘ä»¬ç°åœ¨è¦åšçš„æ˜¯éå†æ‰€æœ‰ï¼ˆå·¥ä½œåˆ—è¡¨ä¸­çš„ï¼‰å¯¹è±¡çš„å¼•ç”¨ï¼ˆæŒ‡é’ˆï¼‰ï¼Œä»¥æ‰¾åˆ°æ›´å¤šå¯¹è±¡ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºæ‰«æå¯¹è±¡ã€‚\næˆ‘ä»¬æ‰¾åˆ°äº†è¿™ä¸ªæœ‰æ•ˆçš„æ•°ç»„å¯¹è±¡ï¼ˆçº¢è‰²ç®­å¤´æŒ‡å‘ï¼‰ã€‚\nç°åœ¨å¹¶å°†å…¶æ·»åŠ åˆ°æˆ‘ä»¬çš„å·¥ä½œåˆ—è¡¨ä¸­ï¼ˆå°†å…¶æ ‡è®°ä¸ºè“è‰²ï¼‰ã€‚\nä»è¿™é‡Œå¼€å§‹ï¼Œæˆ‘ä»¬è¦é€’å½’åœ°è¿›è¡Œå¤„ç†äº†ã€‚\néå†æ•°ç»„çš„æŒ‡é’ˆï¼ˆè®¿é—® index=0 å…ƒç´ ï¼Œç©ºæŒ‡é’ˆè·³è¿‡ï¼‰ã€‚\nï¼ˆè®¿é—® index=1 çš„å…ƒç´ ï¼Œéç©ºæŒ‡é’ˆï¼Œæ²¿ç€æŒ‡é’ˆè®¿é—®ï¼‰ã€‚\nï¼ˆå°†æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ï¼ŒåŠ å…¥åˆ°å·¥ä½œåˆ—è¡¨ä¸­ï¼‰ã€‚\næ‰¾åˆ°æ›´å¤šçš„å¯¹è±¡ï¼ˆè®¿é—® index=2 çš„å…ƒç´ ï¼Œéç©ºæŒ‡é’ˆï¼Œæ²¿ç€æŒ‡é’ˆè®¿é—®ï¼‰ã€‚\nï¼ˆå°†æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ï¼ŒåŠ å…¥åˆ°å·¥ä½œåˆ—è¡¨ä¸­ï¼‰ã€‚\nï¼ˆè®¿é—® index=3 çš„å…ƒç´ ï¼Œç©ºæŒ‡é’ˆè·³è¿‡ï¼‰ã€‚\nç°åœ¨æˆ‘ä»¬å¼€å§‹éå†æ•°ç»„å¯¹è±¡å¼•ç”¨çš„å¯¹è±¡ï¼ˆæ³¨æ„ï¼è¿™é‡Œå…ˆè®¿é—®çš„æ˜¯ index=2 æŒ‡å‘çš„å¯¹è±¡ï¼Œæ˜¯ååŠ å…¥å·¥ä½œé˜Ÿåˆ—çš„ï¼‰ã€‚\næ³¨æ„ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦éå†æ‰€æœ‰æŒ‡é’ˆï¼ˆT ä¸­çš„ childrenï¼‰ï¼Œå³ä½¿å®ƒä»¬æ˜¯ nilã€‚å› ä¸ºæˆ‘ä»¬ä¹Ÿæ— æ³•æå‰çŸ¥é“å®ƒä»¬æ˜¯å¦æ˜¯ nilã€‚\nè¿˜æœ‰å¦å¤–ä¸€ä¸ªå¯¹è±¡ï¼ˆindex=1 æŒ‡å‘çš„å¯¹è±¡ï¼‰ã€‚\nï¼ˆç©ºæŒ‡é’ˆï¼Œç»“æŸï¼‰ã€‚\nç°åœ¨æˆ‘ä»¬åˆ‡åˆ°å¦ä¸€ä¸ªåˆ†æ”¯ï¼Œä»æˆ‘ä»¬ä¹‹å‰ä»ä¸€ä¸ªæ ¹å¯¹è±¡ï¼ˆxï¼‰æ‰¾åˆ°çš„é‚£ä¸ªå¯¹è±¡ï¼ˆä½äº Page Aï¼‰å¼€å§‹ã€‚ä½ å¯èƒ½æ³¨æ„åˆ°äº†å·¥ä½œåˆ—è¡¨åœ¨è¿™é‡Œéµå¾ªåè¿›å…ˆå‡ºçš„åŸåˆ™ï¼Œè¿™è¡¨æ˜æˆ‘ä»¬çš„å·¥ä½œåˆ—è¡¨æ˜¯ä¸€ä¸ªå †æ ˆï¼Œå› æ­¤æˆ‘ä»¬çš„å›¾éå†ç®—æ³•è¿‘ä¼¼äºæ·±åº¦ä¼˜å…ˆæœç´¢ã€‚è¿™æ˜¯ç‰¹æ„ç”¨æ¥åæ˜  Go è¿è¡Œæ—¶ä¸­å®é™…çš„å›¾éå†ç®—æ³•ã€‚\nè®©æˆ‘ä»¬ç»§ç»­\u0026hellip;\næ¥ä¸‹æ¥æˆ‘ä»¬æ‰¾åˆ°å¦ä¸€ä¸ªæ•°ç»„å¯¹è±¡ï¼ˆPage B ä¸­çš„è“è‰²çŸ©å½¢ï¼‰ã€‚\néå†å®ƒã€‚\n(è®¿é—® index=0ï¼Œç©ºæŒ‡é’ˆ)\n(è®¿é—® index=1ï¼Œç©ºæŒ‡é’ˆ)\n(è®¿é—® index=2ï¼Œéç©ºæŒ‡é’ˆ)\n(å°† index=2 æŒ‡å‘çš„å¯¹è±¡åŠ å…¥åˆ°å·¥ä½œåˆ—è¡¨ä¸­)\nï¼ˆè®¿é—® index=3ï¼Œç©ºæŒ‡é’ˆï¼‰ç°åœ¨æˆ‘ä»¬çš„å·¥ä½œåˆ—è¡¨ä¸­åªå‰©ä¸‹ä¸€ä¸ªå¯¹è±¡äº†ã€‚\nè®©æˆ‘ä»¬å¼€å§‹æ‰«æå®ƒ\u0026hellip;\nï¼ˆå®ƒåŒ…å«äº†ä¸€ä¸ªç©ºæŒ‡é’ˆï¼Œè·³è¿‡ï¼‰ã€‚\nåˆ°è¿™é‡Œæ ‡è®°é˜¶æ®µç»“æŸäº†ï¼æ²¡æœ‰æ­£åœ¨å¤„ç†çš„å¯¹è±¡ï¼Œå·¥ä½œåˆ—è¡¨ä¹Ÿç©ºäº†ã€‚å¦‚å›¾ï¼Œæ‰€æœ‰é»‘è‰²çš„å¯¹è±¡éƒ½æ˜¯å¯è¾¾çš„ï¼Œæ‰€æœ‰ç°è‰²çš„å¯¹è±¡éƒ½æ˜¯ä¸å¯è¾¾çš„ã€‚è®©æˆ‘ä»¬ä¸€æ¬¡æ€§æ¸…é™¤æ‰€æœ‰ä¸å¯è¾¾çš„å¯¹è±¡ï¼š\næˆ‘ä»¬å·²ç»å°†è¿™äº›å¯¹è±¡è½¬æ¢ä¸ºç©ºé—²æ’æ§½ï¼Œå‡†å¤‡å¥½å®¹çº³æ–°å¯¹è±¡ã€‚\næœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ # ç»è¿‡ä¸€ç•ªæ‘¸ç´¢ï¼Œæˆ‘ä»¬åŸºæœ¬æŒæ¡äº† Go åƒåœ¾å›æ”¶å™¨çš„å·¥ä½œåŸç†ã€‚ç›®å‰çœ‹æ¥ï¼Œè¿™ä¸ªè¿‡ç¨‹è¿è¡Œè‰¯å¥½ï¼Œé‚£ä¹ˆé—®é¢˜å‡ºåœ¨å“ªé‡Œå‘¢ï¼Ÿ\näº‹å®è¯æ˜ï¼Œåœ¨æŸäº›ç¨‹åºä¸­ï¼Œæ‰§è¡Œè¿™ä¸ªç®—æ³•ä¼šèŠ±è´¹å¤§é‡æ—¶é—´ï¼Œè€Œä¸”å‡ ä¹ä¼šç»™æ‰€æœ‰ Go ç¨‹åºå¸¦æ¥æ˜¾è‘—çš„å¼€é”€ã€‚Go ç¨‹åºå°† 20% ç”šè‡³æ›´å¤šçš„ CPU æ—¶é—´ç”¨äºåƒåœ¾å›æ”¶çš„æƒ…å†µå¹¶ä¸å°‘è§ã€‚\nè®©æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¿™äº›æ—¶é—´éƒ½èŠ±åœ¨äº†å“ªé‡Œã€‚\nåƒåœ¾æ”¶é›†çš„æˆæœ¬ # ä»å®è§‚å±‚é¢æ¥çœ‹ï¼Œåƒåœ¾å›æ”¶å™¨çš„æˆæœ¬ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šä¸€æ˜¯è¿è¡Œé¢‘ç‡ï¼ŒäºŒæ˜¯æ¯æ¬¡è¿è¡Œçš„å·¥ä½œé‡ã€‚å°†è¿™ä¸¤éƒ¨åˆ†ç›¸ä¹˜ï¼Œå³å¯å¾—åˆ°åƒåœ¾å›æ”¶å™¨çš„æ€»æˆæœ¬ã€‚\næ€» GC å¼€é”€ = GC è¿è¡Œé¢‘æ¬¡ Ã— å¹³å‡æ¯æ¬¡ GC å¼€é”€ å¤šå¹´æ¥ï¼Œæˆ‘ä»¬ä¸€ç›´åœ¨ç ”ç©¶è¿™ä¸ªç­‰å¼ä¸­çš„è¿™ä¸¤ä¸ªæ–¹é¢ã€‚è¦äº†è§£æ›´å¤šå…³äºåƒåœ¾å›æ”¶å™¨è¿è¡Œé¢‘ç‡çš„ä¿¡æ¯ï¼Œè¯·å‚é˜… Michael åœ¨ 2022 GopherCon EU å¤§ä¼šä¸Šçš„æ¼”è®²ã€‚å…³äºå†…å­˜é™åˆ¶ï¼ŒGo åƒåœ¾å›æ”¶å™¨æŒ‡å— ä¹Ÿå¯¹æ­¤ä¸»é¢˜è¿›è¡Œäº†æ·±å…¥é˜è¿°ï¼Œå¦‚æœæƒ³æ·±å…¥äº†è§£ï¼Œå€¼å¾—ä¸€çœ‹ã€‚\nè¿™é‡Œï¼Œæˆ‘ä»¬åªå…³æ³¨ç¬¬äºŒéƒ¨åˆ†ï¼šæ¯æ¬¡ GC è¿è¡Œçš„æˆæœ¬ã€‚\nå¤šå¹´æ¥ï¼Œæˆ‘ä»¬ä¸æ–­åˆ†æ CPU profileï¼Œè¯•å›¾æé«˜æ€§èƒ½ï¼Œä»ä¸­æˆ‘ä»¬äº†è§£åˆ° Go çš„åƒåœ¾å›æ”¶å™¨æœ‰ä¸¤å¤§å¼€é”€ï¼š\né¦–å…ˆï¼Œåƒåœ¾æ”¶é›†å™¨çš„æˆæœ¬çº¦ 90% ç”¨äºæ ‡è®°ï¼Œåªæœ‰çº¦ 10% ç”¨äºæ¸…æ‰«ã€‚äº‹å®è¯æ˜ï¼Œæ¸…æ‰«æ¯”æ ‡è®°æ›´å®¹æ˜“ä¼˜åŒ–ï¼Œå¤šå¹´æ¥ Go ä¹Ÿç¡®å®æ‹¥æœ‰äº†éå¸¸é«˜æ•ˆçš„æ¸…æ‰«å®ç°ã€‚ å…¶æ¬¡ï¼Œåœ¨æ ‡è®°ä»»åŠ¡æ‰€èŠ±è´¹çš„æ—¶é—´ä¸­ï¼Œç›¸å½“ä¸€éƒ¨åˆ†ï¼ˆé€šå¸¸è‡³å°‘ 35%ï¼‰éƒ½æµªè´¹åœ¨äº†è®¿é—®å †å†…å­˜ä¸Šã€‚è¿™æœ¬èº«å°±å¤Ÿç³Ÿç³•çš„äº†ï¼Œæ›´ç³Ÿç³•çš„æ˜¯ï¼Œå®ƒ â€œä¸¥é‡å½±å“â€ äº†ç°ä»£ CPU å‘æŒ¥å…¶å…¨éƒ¨æ€§èƒ½çš„å…³é”®æœºåˆ¶ã€‚ â€œå¾®æ¶æ„ç¾éš¾â€ # åœ¨è¿™ä¸ªè¯­å¢ƒä¸‹ï¼Œâ€œä¸¥é‡å½±å“â€ æ˜¯æ„å‘³ç€ä»€ä¹ˆï¼Ÿç°ä»£ CPU çš„å…·ä½“æ„é€ ç›¸å½“å¤æ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨ä¸€ä¸ªç±»æ¯”æ¥è§£é‡Šï¼š\næƒ³è±¡ä¸€ä¸‹ï¼ŒCPU åœ¨ä¸€æ¡åä¸º â€œä½ çš„ç¨‹åºâ€ çš„é“è·¯ä¸Šå¼€è½¦ã€‚CPU æƒ³è¦æé«˜é€Ÿåº¦ï¼Œä¸ºæ­¤å®ƒéœ€è¦èƒ½å¤Ÿçœ‹åˆ°å‰æ–¹å¾ˆè¿œçš„è·¯å†µï¼Œè€Œä¸”é“è·¯å¿…é¡»ç•…é€šæ— é˜»ã€‚ä½†å¯¹äº CPU æ¥è¯´ï¼Œå›¾éå† ç®—æ³•å°±åƒæ˜¯åœ¨åŸå¸‚è¡—é“ä¸Šå¼€è½¦ã€‚CPU çœ‹ä¸åˆ°æ‹è§’å¤„çš„æƒ…å†µï¼Œä¹Ÿæ— æ³•é¢„æµ‹æ¥ä¸‹æ¥ä¼šå‘ç”Ÿä»€ä¹ˆã€‚ä¸ºäº†å‰è¿›ï¼Œå®ƒä¸å¾—ä¸ä¸æ–­å‡é€Ÿè½¬å¼¯ã€åœ¨çº¢ç»¿ç¯å‰åœè½¦ã€é¿è®©è¡Œäººã€‚ä½ çš„å¼•æ“é€Ÿåº¦èƒ½è½¬å¤šå¿«ä¹Ÿæ— æµäºäº‹ï¼Œå› ä¸ºä½ æ ¹æœ¬æ²¡æœ‰åŠ é€Ÿçš„æœºä¼šã€‚\nè®©æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œè®©å®ƒæ›´å…·ä½“ä¸€äº›ã€‚æˆ‘åœ¨è¿™é‡ŒæŠŠå †å’Œæˆ‘ä»¬èµ°è¿‡çš„è·¯å¾„å åŠ åœ¨ä¸€èµ·äº†ã€‚æ¯ä¸ªä»å·¦åˆ°å³çš„ç®­å¤´ä»£è¡¨æˆ‘ä»¬å®Œæˆçš„ä¸€é¡¹æ‰«æå·¥ä½œï¼Œè™šçº¿ç®­å¤´åˆ™è¡¨ç¤ºæˆ‘ä»¬åœ¨ä¸åŒçš„æ‰«æå·¥ä½œä¹‹é—´è·³è½¬ã€‚\nåœ¨æˆ‘ä»¬çš„å›¾éå†ç¤ºä¾‹ä¸­ï¼Œåƒåœ¾å›æ”¶å™¨åœ¨å †ä¸­æ‰§è¡Œçš„è·¯å¾„ ç°ä»£ CPU ä¼šè¿›è¡Œå¤§é‡çš„ç¼“å­˜ã€‚è®¿é—®ä¸»å†…å­˜çš„é€Ÿåº¦å¯èƒ½æ¯”è®¿é—®ç¼“å­˜ä¸­çš„å†…å­˜æ…¢ 100 å€ã€‚CPU ç¼“å­˜ä¸­å­˜å‚¨çš„æ˜¯æœ€è¿‘è®¿é—®è¿‡çš„å†…å­˜ï¼Œä»¥åŠä¸æœ€è¿‘è®¿é—®è¿‡çš„å†…å­˜ä½ç½®ç›¸è¿‘çš„å†…å­˜ã€‚ä½†æ˜¯ï¼Œå¹¶ä¸èƒ½ä¿è¯ä¸¤ä¸ªç›¸äº’æŒ‡å‘çš„å¯¹è±¡åœ¨å†…å­˜ä¸­ä¹Ÿå½¼æ­¤é è¿‘ã€‚å›¾éå†ç®—æ³•å¹¶æ²¡æœ‰è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ã€‚\nè¡¥å……è¯´æ˜ä¸€ä¸‹ï¼šå¦‚æœåªæ˜¯å»¶è¿Ÿå¯¹ä¸»å†…å­˜çš„è¯»å–æ“ä½œï¼Œæƒ…å†µå¯èƒ½è¿˜ä¸è‡³äºè¿™ä¹ˆç³Ÿç³•ã€‚CPU å¯ä»¥å¼‚æ­¥å‘å‡ºå†…å­˜è¯·æ±‚ï¼Œæ‰€ä»¥å³ä½¿æ˜¯æ…¢é€Ÿè¯·æ±‚ï¼Œå¦‚æœ CPU èƒ½æå‰çœ‹åˆ°è¶³å¤Ÿå¤šçš„ä¿¡æ¯ï¼Œä¹Ÿèƒ½ç›¸äº’é‡å ã€‚ä½†åœ¨å›¾éå†ä¸­ï¼Œæ¯ä¸€é¡¹å·¥ä½œéƒ½å¾ˆå°ã€ä¸å¯é¢„æµ‹ï¼Œè€Œä¸”é«˜åº¦ä¾èµ–äºå‰ä¸€é¡¹å·¥ä½œï¼Œå› æ­¤ CPU å‡ ä¹æ¯æ¬¡è¯»å–å†…å­˜éƒ½ä¼šè¢«è¿«ç­‰å¾…ã€‚\nä¸å¹¸çš„æ˜¯ï¼Œè¿™ä¸ªé—®é¢˜åªä¼šè¶Šæ¥è¶Šä¸¥é‡ã€‚è™½ç„¶ä¸šå†…æœ‰å¥è€è¯ï¼šâ€œç­‰ä¸¤å¹´ï¼Œä½ çš„ä»£ç è¿è¡Œé€Ÿåº¦å°±ä¼šæå‡â€ã€‚ä½† Go è¯­è¨€ä½œä¸ºä¸€ç§ä¾èµ–æ ‡è®°æ¸…é™¤ç®—æ³•çš„åƒåœ¾å›æ”¶è¯­è¨€ï¼Œå´é¢ä¸´ç€ç›¸åçš„é£é™©ï¼šâ€œä¸¤å¹´åï¼Œä½ çš„ä»£ç è¿è¡Œé€Ÿåº¦ä¼šå˜æ…¢â€ã€‚ç°ä»£ CPU ç¡¬ä»¶çš„å‘å±•è¶‹åŠ¿æ­£åœ¨ç»™åƒåœ¾å›æ”¶å™¨çš„æ€§èƒ½å¸¦æ¥æ–°çš„æŒ‘æˆ˜ï¼š\néå‡åŒ€å†…å­˜è®¿é—®ï¼ˆNon-uniform memory access, NUMAï¼‰ï¼š\né¦–å…ˆï¼Œå†…å­˜ç°åœ¨å¾€å¾€ä¸ CPU æ ¸å¿ƒçš„å­é›†ç›¸å…³è”ã€‚å…¶ä»– CPU æ ¸å¿ƒè®¿é—®è¯¥å†…å­˜çš„é€Ÿåº¦ä¼šå˜æ…¢ã€‚æ¢å¥è¯è¯´ï¼Œä¸»å†…å­˜è®¿é—®çš„æˆæœ¬å–å†³äºå“ªä¸ª CPU æ ¸å¿ƒåœ¨è®¿é—®å®ƒã€‚è¿™ç§æˆæœ¬æ˜¯ä¸å‡åŒ€çš„ï¼Œå› æ­¤æˆ‘ä»¬ç§°ä¹‹ä¸ºéå‡åŒ€å†…å­˜è®¿é—®ï¼Œç®€ç§° NUMAã€‚\nå†…å­˜å¸¦å®½ä¸‹é™ï¼ˆReduced memory bandwidthï¼‰ï¼š\næ¯ä¸ª CPU æ ¸å¿ƒå¯ç”¨çš„å†…å­˜å¸¦å®½å‘ˆä¸‹é™è¶‹åŠ¿ã€‚è¿™æ„å‘³ç€è™½ç„¶æˆ‘ä»¬æ‹¥æœ‰æ›´å¤šçš„ CPU æ ¸å¿ƒï¼Œä½†æ¯ä¸ªæ ¸å¿ƒèƒ½å¤Ÿå¤„ç†çš„æ•°æ®é‡ç›¸å¯¹è¾ƒå°‘ã€‚å¯¹ä¸»å†…å­˜çš„è¯·æ±‚å¯¼è‡´æœªç¼“å­˜çš„è¯·æ±‚ç­‰å¾…æ—¶é—´æ¯”ä»¥å‰æ›´é•¿ã€‚\næ›´å¤šçš„ CPU æ ¸å¿ƒï¼ˆEver more CPU coresï¼‰ï¼š\nä¸Šé¢æˆ‘ä»¬è®¨è®ºçš„æ˜¯ä¸€ç§é¡ºåºæ ‡è®°ç®—æ³•ï¼Œä½†çœŸæ­£çš„åƒåœ¾å›æ”¶å™¨æ‰§è¡Œçš„æ˜¯å¹¶è¡Œç®—æ³•ã€‚è¿™ç§æ–¹æ³•åœ¨ CPU æ ¸å¿ƒæ•°é‡æœ‰é™çš„æƒ…å†µä¸‹æ‰©å±•æ€§å¾ˆå¥½ï¼Œä½†å¾…æ‰«æå¯¹è±¡çš„å…±äº«é˜Ÿåˆ—ä¼šæˆä¸ºç“¶é¢ˆï¼Œå³ä½¿ç»è¿‡ç²¾å¿ƒè®¾è®¡ï¼Œä»ç„¶å­˜åœ¨äº‰ç”¨ã€‚\nç°ä»£ç¡¬ä»¶ç‰¹æ€§ï¼ˆModern hardware featuresï¼‰ï¼š\næ–°ç¡¬ä»¶å…·æœ‰å‘é‡æŒ‡ä»¤ç­‰å…ˆè¿›åŠŸèƒ½ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿä¸€æ¬¡å¤„ç†å¤§é‡æ•°æ®ã€‚è™½ç„¶è¿™æœ‰å¯èƒ½å¤§å¹…æå‡é€Ÿåº¦ï¼Œä½†ç›®å‰è¿˜ä¸æ¸…æ¥šå¦‚ä½•æ‰èƒ½å®ç°è¿™ä¸€ç‚¹ï¼Œå› ä¸ºæ ‡è®°å·¥ä½œæ¶‰åŠå¾ˆå¤šä¸è§„åˆ™ä¸”é€šå¸¸æ˜¯å°å—çš„å·¥ä½œã€‚\nGreen Tea # æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ Green Tea ç®—æ³•ï¼Œè¿™æ˜¯æˆ‘ä»¬å¯¹æ ‡è®°æ‰«æç®—æ³•çš„ä¸€ç§æ–°æ–¹æ³•ã€‚Green Tea ç®—æ³•çš„æ ¸å¿ƒæ€æƒ³éå¸¸ç®€å•ï¼š\nä»¥é¡µï¼ˆPageï¼‰ä¸ºå•ä½è¿›è¡Œå¤„ç†ï¼Œè€Œä¸æ˜¯å¯¹è±¡ï¼ˆObjectï¼‰\nå¬èµ·æ¥å¾ˆç®€å•ï¼Œå¯¹å§ï¼Ÿç„¶è€Œï¼Œä¸ºäº†å¼„æ¸…æ¥šå¦‚ä½•å®‰æ’å¯¹è±¡å›¾éå†çš„é¡ºåºä»¥åŠæˆ‘ä»¬éœ€è¦è·Ÿè¸ªå“ªäº›å†…å®¹æ‰èƒ½ä½¿å…¶åœ¨å®è·µä¸­æœ‰æ•ˆè¿ä½œï¼Œæˆ‘ä»¬åšäº†å¤§é‡çš„å·¥ä½œã€‚æ›´å…·ä½“åœ°è¯´ï¼š\nä¸æ‰«æå¯¹è±¡ï¼Œè€Œæ˜¯æ‰«æé¡µã€‚ ä¸åœ¨å·¥ä½œåˆ—è¡¨ä¸­è·Ÿè¸ªå¯¹è±¡ï¼Œè€Œæ˜¯è·Ÿè¸ªæ•´ä¸ªé¡µé¢ã€‚ æœ€ç»ˆä»ç„¶éœ€è¦æ ‡è®°å¯¹è±¡ï¼Œä½†æˆ‘ä»¬ä¼šè·Ÿè¸ªæ¯ä¸ªé¡µé¢æœ¬åœ°æ ‡è®°çš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯åœ¨æ•´ä¸ªå †ä¸­è¿›è¡Œè·Ÿè¸ªã€‚ ç®—æ³•æ¼”ç¤ºï¼šGreen Tea # è®©æˆ‘ä»¬å†æ¬¡æŸ¥çœ‹æˆ‘ä»¬çš„ç¤ºä¾‹å †ï¼Œçœ‹çœ‹è¿™åœ¨å®è·µä¸­æ„å‘³ç€ä»€ä¹ˆï¼Œä½†è¿™æ¬¡è¿è¡Œçš„æ˜¯ Green Tea è€Œä¸æ˜¯ç›´æ¥çš„ å›¾éå†ã€‚\nè¿™å’Œä¹‹å‰çš„å †ä¸€æ ·ï¼Œä½†æ˜¯ç°åœ¨æ¯ä¸ªå¯¹è±¡æœ‰ä¸¤ä¸ªå…ƒæ•°æ®ä½è€Œä¸æ˜¯ä¸€ä¸ªã€‚åŒæ ·ï¼Œæ¯ä¸ªä½æˆ–æ¡†å¯¹åº”äºé¡µé¢ä¸­çš„ä¸€ä¸ªå¯¹è±¡æ’æ§½ã€‚æ€»å…±ï¼Œæˆ‘ä»¬ç°åœ¨æœ‰ 14 ä¸ªä½å¯¹åº”äºé¡µé¢ A ä¸­çš„ 7 ä¸ªæ’æ§½ã€‚\né¡¶éƒ¨çš„ä½ä»£è¡¨å’Œä»¥å‰ä¸€æ ·çš„ä¸œè¥¿ï¼šæˆ‘ä»¬æ˜¯å¦çœ‹åˆ°äº†æŒ‡å‘è¯¥å¯¹è±¡çš„æŒ‡é’ˆï¼Œæˆ‘ç§°ä¹‹ä¸º å·²è§ï¼ˆseenï¼‰ä½ã€‚åº•éƒ¨çš„ä½æ˜¯æ–°å¼•å…¥çš„ï¼Œç§°ä¸º å·²æ‰«æï¼ˆscannedï¼‰ä½ è·Ÿè¸ªæˆ‘ä»¬æ˜¯å¦æ‰«æäº†è¯¥å¯¹è±¡ã€‚\nè¿™ä¸ªæ–°çš„å…ƒæ•°æ®æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºåœ¨ Green Tea ä¸­ï¼Œå·¥ä½œåˆ—è¡¨è™½ç„¶æ˜¯è·Ÿè¸ªé¡µé¢è€Œä¸æ˜¯å¯¹è±¡ï¼Œä½†æˆ‘ä»¬ä»ç„¶éœ€è¦åœ¨æŸä¸ªçº§åˆ«ä¸Šè·Ÿè¸ªå¯¹è±¡ï¼Œè¿™äº›ä½å°±æ˜¯ç”¨æ¥åœ¨è¾…åŠ©è·Ÿè¸ªå¯¹è±¡çš„ã€‚\næˆ‘ä»¬åƒä»¥å‰ä¸€æ ·ï¼Œä»æ ¹èŠ‚ç‚¹å¼€å§‹éå†å¯¹è±¡ã€‚\nï¼ˆä» x å¼€å§‹ï¼‰\nä½†è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬ä¸æ˜¯å°†ä¸€ä¸ªå¯¹è±¡æ”¾å…¥å·¥ä½œåˆ—è¡¨ï¼Œè€Œæ˜¯å°†æ•´ä¸ªé¡µé¢ï¼ˆåœ¨æœ¬ä¾‹ä¸­æ˜¯é¡µé¢ Aï¼‰æ”¾å…¥å·¥ä½œåˆ—è¡¨ï¼Œç”¨è“è‰²é˜´å½±è¡¨ç¤ºæ•´ä¸ªé¡µé¢ã€‚\næˆ‘ä»¬æ‰¾åˆ°çš„å¯¹è±¡ä¹Ÿæ˜¯è“è‰²çš„ï¼Œè¡¨ç¤ºå½“æˆ‘ä»¬ä»å·¥ä½œåˆ—è¡¨ä¸­å–å‡ºæ­¤é¡µé¢æ—¶ï¼Œæˆ‘ä»¬å°†éœ€è¦æŸ¥çœ‹è¯¥å¯¹è±¡ã€‚è¯·æ³¨æ„ï¼Œå¯¹è±¡çš„è“è‰²è‰²è°ƒç›´æ¥åæ˜ äº†é¡µé¢ A ä¸­çš„å…ƒæ•°æ®ã€‚å…¶å¯¹åº”çš„â€œå·²è§â€ä½ä¸º 1ï¼Œä½†å…¶â€œå·²æ‰«æâ€ä½æœªç½® 1ã€‚\næˆ‘ä»¬è·Ÿéšä¸‹ä¸€ä¸ªæ ¹ï¼Œæ‰¾åˆ°å¦ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åå†æ¬¡å°†æ•´ä¸ªé¡µé¢ C æ”¾åˆ°å·¥ä½œåˆ—è¡¨ä¸­ï¼Œå¹¶è®¾ç½®è¯¥å¯¹è±¡çš„â€œå·²è§â€ä½ã€‚\næˆ‘ä»¬å·²ç»å®Œæˆäº†å¯¹æ ¹çš„è·Ÿè¸ªï¼Œæ‰€ä»¥æˆ‘ä»¬è½¬å‘å·¥ä½œåˆ—è¡¨ï¼Œå¹¶å°†é¡µé¢ A ä»å·¥ä½œåˆ—è¡¨ä¸­å–å‡ºã€‚\nä½¿ç”¨â€œå·²è§â€å’Œâ€œå·²æ‰«æâ€ä½ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“é¡µé¢ A ä¸Šæœ‰ä¸€ä¸ªè¦æ‰«æçš„å¯¹è±¡ã€‚\næˆ‘ä»¬æ‰«æè¯¥å¯¹è±¡ï¼Œè·Ÿéšå®ƒçš„æŒ‡é’ˆã€‚ç»“æœï¼Œæˆ‘ä»¬å°†é¡µé¢ B æ·»åŠ åˆ°å·¥ä½œåˆ—è¡¨ä¸­ï¼Œå› ä¸ºé¡µé¢ A ä¸­çš„ç¬¬ä¸€ä¸ªå¯¹è±¡æŒ‡å‘é¡µé¢ B ä¸­çš„ä¸€ä¸ªå¯¹è±¡ã€‚\næˆ‘ä»¬å¤„ç†å®Œé¡µé¢ Aã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä»å·¥ä½œåˆ—è¡¨ä¸­å–å‡ºé¡µé¢ Cã€‚\nä¸é¡µé¢ A ç±»ä¼¼ï¼Œé¡µé¢ C ä¸Šåªæœ‰ä¸€ä¸ªè¦æ‰«æçš„å¯¹è±¡ã€‚\næˆ‘ä»¬åœ¨é¡µé¢ B ä¸­æ‰¾åˆ°äº†æŒ‡å‘å¦ä¸€ä¸ªå¯¹è±¡çš„æŒ‡é’ˆã€‚é¡µé¢ B å·²åœ¨å·¥ä½œåˆ—è¡¨ä¸­ï¼Œå› æ­¤æˆ‘ä»¬æ— éœ€å‘å·¥ä½œåˆ—è¡¨æ·»åŠ ä»»ä½•å†…å®¹ã€‚æˆ‘ä»¬åªéœ€ä¸ºç›®æ ‡å¯¹è±¡è®¾ç½®â€œå·²è§â€ä½ã€‚\nç°åœ¨è½®åˆ°é¡µé¢ B äº†ã€‚æˆ‘ä»¬å·²ç»åœ¨é¡µé¢ B ä¸Šç´¯ç§¯äº†ä¸¤ä¸ªè¦æ‰«æçš„å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰å†…å­˜é¡ºåºè¿ç»­å¤„ç†è¿™ä¸¤ä¸ªå¯¹è±¡ï¼\næˆ‘ä»¬éå†ç¬¬ä¸€ä¸ªå¯¹è±¡çš„æŒ‡é’ˆï¼ˆindex 0ï¼Œç©ºæŒ‡é’ˆï¼‰\nï¼ˆindex 1, ä¹Ÿæ˜¯ç©ºæŒ‡é’ˆï¼‰\nï¼ˆindex 2, æŒ‡å‘äº† Page A ä¸­çš„å¯¹è±¡ï¼‰\næˆ‘ä»¬åœ¨é¡µé¢ A ä¸­æ‰¾åˆ°äº†ä¸€ä¸ªæŒ‡å‘å¯¹è±¡çš„æŒ‡é’ˆã€‚é¡µé¢ A å…ˆå‰åœ¨å·¥ä½œåˆ—è¡¨ä¸­ï¼Œä½†æ­¤æ—¶ä¸åœ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å…¶æ”¾å›å·¥ä½œåˆ—è¡¨ã€‚ä¸åŸå§‹çš„æ ‡è®°-æ¸…é™¤ç®—æ³•ä¸åŒï¼ˆå…¶ä¸­ä»»ä½•ç»™å®šå¯¹è±¡åœ¨æ•´ä¸ªæ ‡è®°é˜¶æ®µæœ€å¤šåªæ·»åŠ åˆ°å·¥ä½œåˆ—è¡¨ä¸€æ¬¡ï¼‰ï¼Œåœ¨ Green Tea ä¸­ï¼Œç»™å®šé¡µé¢å¯ä»¥åœ¨æ ‡è®°é˜¶æ®µå¤šæ¬¡é‡æ–°å‡ºç°åœ¨å·¥ä½œåˆ—è¡¨ä¸­ã€‚\nï¼ˆindex 3, ç©ºæŒ‡é’ˆï¼‰\næˆ‘ä»¬ç´§æ¥ç€ç¬¬ä¸€ä¸ªå¯¹è±¡æ‰«æé¡µé¢ä¸­çœ‹åˆ°çš„ç¬¬äºŒä¸ªå¯¹è±¡ã€‚\nï¼ˆindex 0, ç©ºæŒ‡é’ˆï¼‰\nï¼ˆindex 1, æŒ‡å‘äº† Page A ä¸­çš„å¯¹è±¡ï¼‰\næˆ‘ä»¬åœ¨é¡µé¢ A ä¸­æ‰¾åˆ°äº†æ›´å¤šçš„å¯¹è±¡ï¼ˆå°†å…¶æ ‡è®°ä¸ºå·²è®¿é—®ï¼Œå¾…æ‰«æï¼‰\n(index 2, æŒ‡å‘äº† Page A ä¸­çš„å¯¹è±¡)\nï¼ˆåŒæ ·çš„ï¼Œæ ‡è®°ä¸ºå·²è®¿é—®ï¼Œå¾…æ‰«æï¼‰\nï¼ˆindex 3, ç©ºæŒ‡é’ˆï¼‰\næˆ‘ä»¬æ‰«æå®Œé¡µé¢ Bï¼Œå› æ­¤æˆ‘ä»¬å°†é¡µé¢ A ä»å·¥ä½œåˆ—è¡¨ä¸­æ‹‰å‡ºã€‚\nè¿™æ¬¡æˆ‘ä»¬åªéœ€è¦æ‰«æä¸‰ä¸ªå¯¹è±¡ï¼Œè€Œä¸æ˜¯å››ä¸ªï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»æ‰«æäº†ç¬¬ä¸€ä¸ªå¯¹è±¡ã€‚æˆ‘ä»¬é€šè¿‡æŸ¥çœ‹â€œå·²è§â€å’Œâ€œå·²æ‰«æâ€ä½ä¹‹é—´çš„å·®å¼‚æ¥çŸ¥é“è¦æ‰«æå“ªäº›å¯¹è±¡ã€‚\næˆ‘ä»¬å°†æŒ‰é¡ºåºæ‰«æï¼ˆPage A ä¸­ï¼‰è¿™äº›ï¼ˆå¾…æ‰«æçš„ï¼‰å¯¹è±¡ï¼Œä»ç¬¬äºŒä¸ªä½ç½®å¼€å§‹ã€‚\nï¼ˆç¬¬äºŒä¸ªä½ç½®ä¸Šçš„å¯¹è±¡ï¼Œä¸åŒ…å«é¢å¤–çš„æŒ‡é’ˆï¼›æ ‡è®°å…¶ä¸ºå·²æ‰«æï¼‰\nï¼ˆç¬¬äº”ä¸ªä½ç½®ä¸Šçš„å¯¹è±¡ï¼Œæ‰«æå®ƒæ˜¯å¦åŒ…å«æŒ‡é’ˆï¼‰\nï¼ˆç¬¬äº”ä¸ªä½ç½®ä¸Šçš„å¯¹è±¡ï¼Œä¸åŒ…å«é¢å¤–æŒ‡é’ˆï¼›æ ‡è®°å…¶ä¸ºå·²æ‰«æï¼‰\nï¼ˆç¬¬å…­ä¸ªä½ç½®ä¸Šçš„å¯¹è±¡ï¼Œæ‰«æå®ƒæ˜¯å¦åŒ…å«æŒ‡é’ˆï¼‰\nï¼ˆç¬¬å…­ä¸ªä½ç½®ä¸Šçš„å¯¹è±¡ï¼Œä¸åŒ…å«é¢å¤–æŒ‡é’ˆï¼›æ ‡è®°å…¶ä¸ºå·²æ‰«æï¼‰\nï¼ˆæ‰«æå®Œæˆï¼Œå·¥ä½œåˆ—è¡¨ä¸ºç©ºï¼Œä¹Ÿæ²¡æœ‰æ­£åœ¨æ‰«æçš„å¯¹è±¡ã€‚ç°è‰²å¯¹è±¡ä»£è¡¨ä¸å¯è¾¾ï¼‰\næœ€åï¼Œæˆ‘ä»¬å¯ä»¥æ¸…é™¤æ‰€æœ‰æœªè®¿é—®çš„å¯¹è±¡ï¼Œå°±åƒä¹‹å‰ä¸€æ ·ã€‚\nå¼€ä¸Šé«˜é€Ÿ # è®©æˆ‘ä»¬å›åˆ°å¼€è½¦çš„æ¯”å–»ã€‚æˆ‘ä»¬ç»ˆäºä¸Šé«˜é€Ÿå…¬è·¯äº†å—ï¼Ÿ\nè®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ä¹‹å‰ç»˜åˆ¶çš„æ´ªæ°´å›¾ï¼š\nåŸå§‹*Graph Flood*åœ¨å †ä¸­ç»è¿‡çš„è·¯å¾„éœ€è¦ 7 æ¬¡å•ç‹¬çš„æ‰«æ æˆ‘ä»¬å››å¤„å¥”æ³¢ï¼Œåœ¨ä¸åŒçš„åœ°æ–¹åšç€é›¶é›¶ç¢ç¢çš„å·¥ä½œã€‚ç»¿èŒ¶çš„å‘å±•é“è·¯çœ‹èµ·æ¥æˆªç„¶ä¸åŒ:\nç»¿èŒ¶çš„è·¯å¾„åªéœ€è¦æ‰«æ 4 æ¬¡ ç›¸æ¯”ä¹‹ä¸‹ï¼Œç»¿èŒ¶åœ¨ A å’Œ B é¡µé¢ä¸Šä»å·¦åˆ°å³çš„ç§»åŠ¨æ¬¡æ•°è¾ƒå°‘ï¼Œä½†æ¯æ¬¡ç§»åŠ¨æ—¶é—´æ›´é•¿ã€‚è¿™äº›ç®­å¤´è¶Šé•¿è¶Šå¥½ï¼Œå †è¶Šå¤§æ•ˆæœè¶Šæ˜æ˜¾ã€‚è¿™å°±æ˜¯ç»¿èŒ¶çš„é­…åŠ›æ‰€åœ¨ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬é©°éª‹é«˜é€Ÿå…¬è·¯çš„æœºä¼šã€‚\nè¿™ä¸€åˆ‡éƒ½ä½¿å¾—å®ƒä¸å¾®æ¶æ„æ›´åŠ å¥‘åˆã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥æ›´ç²¾ç¡®åœ°æ‰«æå½¼æ­¤é è¿‘çš„å¯¹è±¡ï¼Œä»è€Œæ›´æœ‰å¯èƒ½åˆ©ç”¨ç¼“å­˜å¹¶é¿å…ä½¿ç”¨ä¸»å†…å­˜ã€‚åŒæ ·ï¼Œæ¯é¡µçš„å…ƒæ•°æ®ä¹Ÿæ›´æœ‰å¯èƒ½è¢«ç¼“å­˜ã€‚è·Ÿè¸ªé¡µé¢è€Œéå¯¹è±¡æ„å‘³ç€å·¥ä½œåˆ—è¡¨æ›´å°ï¼Œè€Œå·¥ä½œåˆ—è¡¨å‹åŠ›çš„é™ä½æ„å‘³ç€äº‰ç”¨æ›´å°‘ï¼ŒCPU åœé¡¿ä¹Ÿæ›´å°‘ã€‚\nè¯´åˆ°é«˜é€Ÿå…¬è·¯ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæˆ‘ä»¬æ¯”å–»æ„ä¹‰ä¸Šçš„å¼•æ“å¼€åˆ°ä»¥å‰ä»æœªå¼€è¿‡çš„æ¡£ä½ï¼Œå› ä¸ºç°åœ¨æˆ‘ä»¬å·²ç»å¯ä»¥ç”¨ä¸Š å‘é‡ç¡¬ä»¶ æ¥åŠ é€Ÿæ‰«æäº†ï¼\nå‘é‡åŠ é€Ÿ # å¦‚æœä½ å¯¹å‘é‡ç¡¬ä»¶åªæœ‰ç²—æµ…çš„äº†è§£ï¼Œå¯èƒ½ä¼šä¸æ˜ç™½æˆ‘ä»¬åœ¨è¿™é‡Œå¦‚ä½•ä½¿ç”¨å®ƒã€‚ä½†é™¤äº†å¸¸è§çš„ç®—æœ¯å’Œä¸‰è§’è¿ç®—ä¹‹å¤–ï¼Œæœ€æ–°çš„å‘é‡ç¡¬ä»¶è¿˜æ”¯æŒä¸¤é¡¹å¯¹ç»¿èŒ¶ç®—æ³•éå¸¸æœ‰ç”¨çš„åŠŸèƒ½ï¼šè¶…å®½å¯„å­˜å™¨å’Œå¤æ‚çš„ä½è¿ç®—ã€‚\nå¤§å¤šæ•°ç°ä»£ x86 CPU éƒ½æ”¯æŒ AVX-512 æŒ‡ä»¤é›†ï¼Œå®ƒæ‹¥æœ‰ 512 ä½å®½çš„å‘é‡å¯„å­˜å™¨ã€‚å¦‚æ­¤å®½çš„å¯„å­˜å™¨è¶³ä»¥åœ¨ CPU ä¸Šä»…ä½¿ç”¨ä¸¤ä¸ªå¯„å­˜å™¨æ¥å­˜å‚¨æ•´ä¸ªé¡µé¢çš„æ‰€æœ‰å…ƒæ•°æ®ï¼Œä»è€Œä½¿ Green Tea èƒ½å¤Ÿä»…å‡ æ¡é¡ºåºæ‰§è¡Œçš„æŒ‡ä»¤å°±å®Œæˆæ•´ä¸ªé¡µé¢çš„æ‰«æã€‚\nå‘é‡ç¡¬ä»¶é•¿æœŸä»¥æ¥ä¸€ç›´æ”¯æŒå¯¹æ•´ä¸ªå‘é‡å¯„å­˜å™¨è¿›è¡ŒåŸºæœ¬çš„ä½è¿ç®—ï¼Œä½†ä» AMD Zen 4 å’Œ Intel Ice Lake å¼€å§‹ï¼Œå®ƒè¿˜æ”¯æŒä¸€ç§æ–°çš„ä½å‘é‡â€œç‘å£«å†›åˆ€â€æŒ‡ä»¤ï¼Œä½¿å¾— Green Tea æ‰«æè¿‡ç¨‹ä¸­çš„å…³é”®æ­¥éª¤èƒ½å¤Ÿåœ¨å‡ ä¸ª CPU å‘¨æœŸå†…å®Œæˆã€‚è¿™äº›æ”¹è¿›å…±åŒä½œç”¨ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿå¤§å¹…æå‡ Green Tea çš„æ‰«æå¾ªç¯é€Ÿåº¦ã€‚\nå¯¹äº Graph Flood æ¥è¯´ï¼Œè¿™æ ¹æœ¬ä¸å¯èƒ½ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦åœ¨å„ç§å¤§å°çš„å¯¹è±¡ä¹‹é—´æ¥å›æ‰«æã€‚æœ‰æ—¶åªéœ€è¦ä¸¤ä½çš„å…ƒæ•°æ®ï¼Œä½†æœ‰æ—¶å´éœ€è¦ä¸€ä¸‡ï¼Œæ ¹æœ¬å…·å¤‡è¶³å¤Ÿçš„å¯é¢„æµ‹æ€§å’Œè§„å¾‹æ€§ï¼Œæ¥ä½¿ç”¨å‘é‡ç¡¬ä»¶åŠ é€Ÿã€‚\nå¦‚æœè¿˜æƒ³æ·±å…¥äº†è§£ä¸€äº›ç»†èŠ‚ï¼Œè¯·ç»§ç»­å¾€ä¸‹ã€‚å¦‚æœä¸æ„Ÿå…´è¶£ï¼Œå¯ä»¥ç›´æ¥è·³åˆ°è¯„ä¼°éƒ¨åˆ†\nè¯‘è€…æ³¨ï¼š # ä¸‹é¢è¿™éƒ¨åˆ†æè¿°çš„æ˜¯åœ¨ GC æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œå½“ä»å·¥ä½œåˆ—è¡¨å–å‡ºä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œè¦éå†å®ƒæ‰€æŒæœ‰çš„æŒ‡é’ˆï¼ˆä»¥å‘ç°å°½å¯èƒ½å¤šçš„å¯¹è±¡ï¼‰ã€‚\nåœ¨ Green Tea ç®—æ³•æ€æƒ³ä¸­ï¼Œæ˜¯ä»¥é¡µä½å•ä½è¿›è¡Œçš„æ‰«æï¼Œè€Œä¸”å¸Œæœ›ä¸€æ¬¡æ€§æ‰«æé¡µä¸­å°½å¯èƒ½å¤šçš„å¯¹è±¡ã€‚é‚£ä¹ˆå®Œå…¨å¯ä»¥åˆ©ç”¨å‘é‡æ¥åŠ é€Ÿè¿™ä¸ª â€œéå†â€ è¿‡ç¨‹ï¼šå°†æ´»è·ƒå¯¹è±¡è½¬æ¢ä¸º æ´»è·ƒå­—ä½å›¾ï¼Œç»“åˆé¡µä¸Šçš„ æŒ‡é’ˆä½å›¾ å°±å¯ä»¥å¿«é€Ÿçš„çŸ¥é“è¿™ä¸€é¡µä¸Šï¼Œå½“å‰éœ€è¦æ‰«æçš„å¯¹è±¡ä¸­ï¼Œå“ªäº›ä½ç½®æ˜¯æŒ‡é’ˆï¼Œè€Œä¸éœ€è¦ä¾æ¬¡å»éå†ã€‚\nå°±å¥½æ¯”ï¼Œè¦è¿ç®— 8bit çš„ AND æ“ä½œï¼Œä½†ä¹‹å‰åªæœ‰ä¸€ä¸ªé—¨ç”µè·¯ï¼Œåªèƒ½æŒ‰ä½ ANDã€‚ç°åœ¨æœ‰å…«ä¸ªé—¨ç”µè·¯ï¼Œå¯ä»¥åŒæ—¶å®Œæˆ8ä½çš„ ANDã€‚\nåˆ©ç”¨å‘é‡åŠ é€Ÿçš„ç±»æ¯”ç¤ºä¾‹ ç›¸æ¯”ä¹‹ä¸‹ï¼Œå›¾éå†ç®—æ³•éœ€è¦åœ¨ä¸åŒé¡µä¹‹é—´è·³æ¥è·³å»ï¼Œmetadata çš„ä½å¤§å°ä¸å¯é¢„æµ‹ï¼Œæ— æ³•ä½¿ç”¨å‘é‡æ¥åŠ é€Ÿè¿™ä¸€ä¸ªè¿‡ç¨‹ï¼Œåªèƒ½éå†ã€‚ï¼ˆæˆ–è€…è¯´ä¸å€¼å¾—ï¼Œå¯èƒ½ä¸ºäº†å¼ºè¡Œä½¿ç”¨ä¸Šçš„å¼€é”€æ¯”åŠ é€Ÿå¸¦æ¥çš„æå‡è¿˜å¤šï¼‰ã€‚\nè¿™ä¸€åˆ‡çš„å‰ææ˜¯ï¼ŒGo å†…å­˜åˆ†é…å™¨å·²ç»ä¸ºæ¯ä¸€é¡µç»´æŠ¤äº†ä¸€ä»½ â€œæŒ‡é’ˆä½å›¾â€ï¼Œå¯ä»¥çŸ¥é“é¡µä¸­æ¯ä¸€ä¸ªå­—æ˜¯å¦å­˜å‚¨äº†æŒ‡é’ˆã€‚\nAVX-512 æ‰«æå†…æ ¸ # ä¸ºäº†äº†è§£ AVX-512 GC æ‰«æçš„æ ·å­ï¼Œè¯·çœ‹ä¸‹å›¾:\nç”¨äºæ‰«æçš„ AVX-512 å‘é‡å†…æ ¸ è¿™é‡Œé¢æ¶‰åŠçš„å†…å®¹å¾ˆå¤šï¼Œæˆ‘ä»¬å¯èƒ½å…‰æ˜¯è§£é‡Šå®ƒçš„è¿ä½œåŸç†å°±èƒ½å†™ä¸€æ•´ç¯‡åšå®¢æ–‡ç« ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å…ˆä»å®è§‚å±‚é¢æ¥æ¦‚æ‹¬ä¸€ä¸‹ï¼š\né¦–å…ˆï¼Œæˆ‘ä»¬è·å–é¡µé¢çš„â€œå·²æŸ¥çœ‹â€å’Œâ€œå·²æ‰«æâ€ä½ã€‚è¯·è®°ä½ï¼Œé¡µé¢ä¸­çš„æ¯ä¸ªå¯¹è±¡å¯¹åº”ä¸€ä½ï¼Œå¹¶ä¸”é¡µé¢ä¸­çš„æ‰€æœ‰å¯¹è±¡å¤§å°ç›¸åŒã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¯”è¾ƒè¿™ä¸¤ä¸ªä½é›†ã€‚å®ƒä»¬çš„å¹¶é›†æˆä¸ºæ–°çš„â€œæ‰«æâ€ä½ï¼Œè€Œå®ƒä»¬çš„å·®é›†åˆ™æ˜¯â€œæ´»åŠ¨å¯¹è±¡â€ä½å›¾ï¼Œå®ƒå‘Šè¯‰æˆ‘ä»¬åœ¨æœ¬æ¬¡é¡µé¢æ‰«æè¿‡ç¨‹ä¸­ï¼ˆä¸ä¹‹å‰çš„æ‰«æç›¸æ¯”ï¼‰éœ€è¦æ‰«æå“ªäº›å¯¹è±¡ã€‚\næˆ‘ä»¬è®¡ç®—ä¸¤ä¸ªä½å›¾çš„å·®å€¼å¹¶è¿›è¡Œâ€œæ‰©å±•â€ï¼Œè¿™æ ·å°±ä¸æ˜¯æ¯ä¸ªå¯¹è±¡å ç”¨ä¸€ä½ï¼Œè€Œæ˜¯é¡µé¢ä¸­çš„æ¯ä¸ªå­—ï¼ˆ8 å­—èŠ‚ï¼‰å ç”¨ä¸€ä½ã€‚æˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œæ´»åŠ¨å­—â€ä½å›¾ã€‚ä¾‹å¦‚ï¼Œå¦‚æœé¡µé¢æ˜¯å­˜å‚¨ 6 ä¸ªå­—ï¼ˆ48 å­—èŠ‚ï¼‰çš„å¯¹è±¡ï¼Œåˆ™æ´»åŠ¨å¯¹è±¡ä½å›¾ä¸­çš„æ¯ä½å°†è¢«å¤åˆ¶åˆ°æ´»åŠ¨å­—ä½å›¾ä¸­çš„ 6 ä½ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š\n0 0 1 1 ... â†’ 000000 000000 111111 111111 ... æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è·å–é¡µé¢çš„ æŒ‡é’ˆä½å›¾ ã€‚å…¶ä¸­ï¼Œè¿™é‡Œçš„æ¯ä¸€ä½éƒ½å¯¹åº”é¡µé¢çš„ä¸€ä¸ªå­—ï¼ˆ8 å­—èŠ‚ï¼‰ï¼Œå¹¶å‘Šè¯‰æˆ‘ä»¬è¯¥å­—æ˜¯å¦å­˜å‚¨çš„æŒ‡é’ˆã€‚\næŒ‡é’ˆä½å›¾ï¼šæ˜¯ç”± Go çš„å†…å­˜åˆ†é…å™¨ï¼ˆallocatorï¼‰åœ¨å¯¹è±¡åˆ†é…æ—¶å°±å·²ç»æ„å»ºå¥½å¹¶ç»´æŠ¤çš„ã€‚\næŒ‡é’ˆä½å›¾æ˜¯ä¸€ä¸ªæŒ‰å­—ï¼ˆwordï¼Œ8 å­—èŠ‚ï¼‰ç²’åº¦çš„ä½å›¾, æ¯ä¸ª bit å¯¹åº”é¡µé¢ä¸­çš„ä¸€ä¸ª wordï¼Œå¦‚æœè¯¥ä½ç½®æ˜¯æŒ‡é’ˆå­—æ®µï¼Œåˆ™ä¸º 1ï¼Œå¦åˆ™ä¸º 0ã€‚\nç°åœ¨ï¼Œæˆ‘ä»¬å– æŒ‡é’ˆ/æ ‡é‡ä½å›¾ å’Œ æ´»åŠ¨å­—ä½å›¾ çš„äº¤é›†ã€‚ç»“æœå°±æ˜¯ æ´»åŠ¨æŒ‡é’ˆä½å›¾ï¼šè¿™ä¸ªä½å›¾å‘Šè¯‰æˆ‘ä»¬å°šæœªæ‰«æçš„ä»»ä½•æ´»åŠ¨å¯¹è±¡ä¸­åŒ…å«çš„æ•´ä¸ªé¡µé¢ä¸­æ¯ä¸ªæŒ‡é’ˆçš„ä½ç½®ã€‚\næœ€åï¼Œæˆ‘ä»¬å¯ä»¥éå†é¡µé¢å†…å­˜å¹¶æ”¶é›†æ‰€æœ‰æŒ‡é’ˆã€‚é€»è¾‘ä¸Šï¼Œæˆ‘ä»¬éå†æ´»åŠ¨æŒ‡é’ˆä½å›¾ä¸­çš„æ¯ä¸ªç½®ä½ï¼ŒåŠ è½½è¯¥å¤„çš„æŒ‡é’ˆå€¼ï¼Œå¹¶å°†å…¶å†™å›ç¼“å†²åŒºã€‚è¯¥ç¼“å†²åŒºç¨åå°†ç”¨äºæ ‡è®°å·²è®¿é—®çš„å¯¹è±¡å¹¶å°†é¡µé¢æ·»åŠ åˆ°å·¥ä½œåˆ—è¡¨ä¸­ã€‚åˆ©ç”¨å‘é‡æŒ‡ä»¤ï¼Œæˆ‘ä»¬åªéœ€å‡ æ¡æŒ‡ä»¤å³å¯ä¸€æ¬¡å¤„ç† 64 å­—èŠ‚ã€‚\né€Ÿåº¦å¿«çš„éƒ¨åˆ†åŸå› åœ¨äº VGF2P8AFFINEQB æŒ‡ä»¤ï¼Œå®ƒæ˜¯ x86 æ‰©å±•â€œä¼½ç½—ç“¦åŸŸæ–°æŒ‡ä»¤â€çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬å‰é¢æåˆ°çš„ä½æ“ä½œâ€œç‘å£«å†›åˆ€â€ã€‚å®ƒæ‰æ˜¯çœŸæ­£çš„å…³é”®æ‰€åœ¨ï¼Œå› ä¸ºå®ƒä½¿æˆ‘ä»¬èƒ½å¤Ÿéå¸¸é«˜æ•ˆåœ°æ‰§è¡Œæ‰«æå†…æ ¸ä¸­çš„æ­¥éª¤ (3)ã€‚å®ƒæ‰§è¡ŒæŒ‰ä½ä»¿å°„å˜æ¢ ï¼Œå°†å‘é‡ä¸­çš„æ¯ä¸ªå­—èŠ‚æœ¬èº«è§†ä¸ºä¸€ä¸ª 8 ä½æ•°å­¦å‘é‡ï¼Œå¹¶å°†å…¶ä¸ä¸€ä¸ª 8x8 ä½çŸ©é˜µç›¸ä¹˜ã€‚æ‰€æœ‰è¿™äº›æ“ä½œéƒ½åœ¨ä¼½ç½—ç“¦åŸŸ GF(2) ä¸Šå®Œæˆï¼Œè¿™æ„å‘³ç€ä¹˜æ³•è¿ç®—æ˜¯ AND è¿ç®—ï¼ŒåŠ æ³•è¿ç®—æ˜¯ XOR è¿ç®—ã€‚å…¶ç»“æœæ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸ªå¯¹è±¡å¤§å°å®šä¹‰å‡ ä¸ª 8x8 ä½çŸ©é˜µï¼Œå®ƒä»¬èƒ½å¤Ÿç²¾ç¡®åœ°æ‰§è¡Œæˆ‘ä»¬éœ€è¦çš„ 1:n ä½æ‰©å±•ã€‚\nå®Œæ•´çš„æ±‡ç¼–ä»£ç è¯·å‚è§æ­¤æ–‡ä»¶ ã€‚â€œæ‰©å±•å™¨â€é’ˆå¯¹æ¯ä¸ªå°ºå¯¸ç±»åˆ«ä½¿ç”¨ä¸åŒçš„çŸ©é˜µå’Œä¸åŒçš„æ’åˆ—ï¼Œå› æ­¤å®ƒä»¬ä½äºå•ç‹¬çš„æ–‡ä»¶ä¸­ã€‚è¿™æ®µä»£ç æ˜¯ç”±ä»£ç ç”Ÿæˆå™¨ç”Ÿæˆçš„ã€‚é™¤äº†æ‰©å±•å‡½æ•°ä¹‹å¤–ï¼Œå®ƒå®é™…ä¸Šå¹¶æ²¡æœ‰å¤ªå¤šä»£ç ã€‚ç”±äºæˆ‘ä»¬å¯ä»¥å¯¹å®Œå…¨å­˜å‚¨åœ¨å¯„å­˜å™¨ä¸­çš„æ•°æ®æ‰§è¡Œä¸Šè¿°å¤§éƒ¨åˆ†æ“ä½œï¼Œå› æ­¤å¤§éƒ¨åˆ†ä»£ç éƒ½å¾—åˆ°äº†æå¤§çš„ç®€åŒ–ã€‚è€Œä¸”ï¼Œå¸Œæœ›ä¸ä¹…ä¹‹åè¿™æ®µæ±‡ç¼–ä»£ç å°±èƒ½è¢« Go ä»£ç å–ä»£ ï¼\næ„Ÿè°¢ Austin Clements è®¾è®¡äº†è¿™å¥—æµç¨‹ã€‚å®ƒç®€ç›´å¤ªæ£’äº†ï¼Œè€Œä¸”é€Ÿåº¦æƒŠäººï¼\nè¯„ä¼° # ä»¥ä¸Šå°±æ˜¯ Green Tea çš„å·¥ä½œåŸç†ã€‚é‚£ä¹ˆï¼Œå®ƒç©¶ç«Ÿæœ‰å¤šå¤§å¸®åŠ©å‘¢ï¼Ÿ\næ•ˆæœå¯èƒ½ç›¸å½“æ˜¾è‘—ã€‚å³ä½¿ä¸è€ƒè™‘å‘é‡å¢å¼ºï¼Œæˆ‘ä»¬çš„åŸºå‡†æµ‹è¯•å¥—ä»¶ä¹Ÿæ˜¾ç¤º åƒåœ¾å›æ”¶çš„ CPU æˆæœ¬é™ä½äº† 10% åˆ° 40%ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåº”ç”¨ç¨‹åº 10% çš„æ—¶é—´éƒ½èŠ±åœ¨äº†åƒåœ¾å›æ”¶å™¨ä¸Šï¼Œé‚£ä¹ˆæ ¹æ®å·¥ä½œè´Ÿè½½çš„å…·ä½“æƒ…å†µï¼Œæ•´ä½“ CPU æ¶ˆè€—å°†é™ä½ 1% åˆ° 4%ã€‚åƒåœ¾å›æ”¶ CPU æ—¶é—´é™ä½ 10% å¤§è‡´æ˜¯å…¸å‹çš„æ”¹è¿›å¹…åº¦ã€‚ï¼ˆæ›´å¤šç»†èŠ‚è¯·å‚è§ GitHub Issuesï¼‰\næˆ‘ä»¬åœ¨è°·æ­Œå†…éƒ¨æ¨å¹¿äº†ç»¿èŒ¶ï¼Œå¹¶ä¸”å¤§è§„æ¨¡æ¨å¹¿åä¹Ÿçœ‹åˆ°äº†ç±»ä¼¼çš„æ•ˆæœã€‚\næˆ‘ä»¬ä»åœ¨é€æ­¥æ¨å‡ºå‘é‡å¢å¼ºåŠŸèƒ½ï¼Œä½†åŸºå‡†æµ‹è¯•å’Œæ—©æœŸç»“æœè¡¨æ˜ï¼Œè¿™å°†é¢å¤–å‡å°‘ 10% çš„ GC CPU ä½¿ç”¨ç‡ã€‚\nè™½ç„¶å¤§å¤šæ•°å·¥ä½œè´Ÿè½½éƒ½èƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šå—ç›Šï¼Œä½†ä¹Ÿæœ‰ä¸€äº›å·¥ä½œè´Ÿè½½ä¸ä¼šå—ç›Šã€‚\nGreen Tea ç®—æ³•åŸºäºè¿™æ ·çš„å‡è®¾ï¼šæˆ‘ä»¬å¯ä»¥ä¸€æ¬¡æ€§åœ¨å•é¡µä¸Šç´¯ç§¯è¶³å¤Ÿå¤šçš„å¯¹è±¡è¿›è¡Œæ‰«æï¼Œä»è€ŒæŠµæ¶ˆç´¯ç§¯è¿‡ç¨‹çš„æˆæœ¬ã€‚å¦‚æœå †ç»“æ„éå¸¸è§„åˆ™ï¼ˆå¯¹è±¡å¤§å°ç›¸åŒï¼Œä¸”åœ¨å¯¹è±¡å›¾ä¸­çš„æ·±åº¦ä¹Ÿç›¸è¿‘ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡è®¾æ˜¾ç„¶æˆç«‹ã€‚ä½†æ˜¯ï¼Œæœ‰äº›å·¥ä½œè´Ÿè½½é€šå¸¸è¦æ±‚æˆ‘ä»¬æ¯æ¬¡åªèƒ½æ‰«æä¸€ä¸ªå¯¹è±¡ã€‚è¿™å¯èƒ½æ¯” Graph Flood æ›´ç³Ÿç³•ï¼šåœ¨å°è¯•ç´¯ç§¯å¯¹è±¡åˆ°é¡µé¢ä¸Šçš„è¿‡ç¨‹ä¸­ï¼Œåè€Œæ¶ˆè€—äº†æ›´å¤šã€‚\nGreen Tea ç®—æ³•é’ˆå¯¹ä»…åŒ…å«å•ä¸ªå¾…æ‰«æå¯¹è±¡çš„é¡µé¢è¿›è¡Œäº†ç‰¹æ®Šå¤„ç†ã€‚è¿™æœ‰åŠ©äºå‡å°‘å›å½’é”™è¯¯ï¼Œä½†å¹¶ä¸èƒ½å®Œå…¨æ¶ˆé™¤å®ƒä»¬ã€‚\nç„¶è€Œï¼Œè¦è¶…è¶Š Graph Flood ç®—æ³•ï¼Œæ‰€éœ€çš„å•é¡µç´¯ç§¯æ•°æ®é‡è¿œæ¯”ä½ æƒ³è±¡çš„è¦å°‘ã€‚è¿™é¡¹ç ”ç©¶çš„ä¸€ä¸ªæ„å¤–å‘ç°æ˜¯ï¼Œæ¯æ¬¡ä»…æ‰«æé¡µé¢ 2% çš„æ•°æ®å°±èƒ½å–å¾—æ¯” Graph Flood ç®—æ³•æ›´å¥½çš„æ€§èƒ½ã€‚\nå¯ç”¨æ€§ # Green Tea å·²ä½œä¸ºå®éªŒæ€§åŠŸèƒ½åŒ…å«åœ¨æœ€æ–°çš„ Go 1.25 ç‰ˆæœ¬ä¸­ï¼Œå¯é€šè¿‡åœ¨æ„å»ºæ—¶å°†ç¯å¢ƒå˜é‡ GOEXPERIMENT è®¾ç½®ä¸º greenteagc æ¥å¯ç”¨ã€‚ä½†è¿™å¹¶ä¸åŒ…å«å‰é¢æåˆ°çš„å‘é‡åŠ é€ŸåŠŸèƒ½ã€‚\næˆ‘ä»¬è®¡åˆ’åœ¨ Go 1.26 ä¸­å°†å…¶è®¾ä¸ºé»˜è®¤åƒåœ¾å›æ”¶å™¨ï¼Œä½†æ‚¨ä»ç„¶å¯ä»¥åœ¨ç¼–è¯‘æ—¶ä½¿ç”¨ GOEXPERIMENT=nogreenteagc æ¥é€‰æ‹©ç¦ç”¨å®ƒã€‚Go 1.26 è¿˜å°†ä¸ºè¾ƒæ–°çš„ x86 ç¡¬ä»¶æ·»åŠ å‘é‡åŠ é€Ÿï¼Œå¹¶æ ¹æ®æˆ‘ä»¬ç›®å‰æ”¶é›†åˆ°çš„åé¦ˆè¿›è¡Œä¸€ç³»åˆ—è°ƒæ•´å’Œæ”¹è¿›ã€‚\nå¦‚æœå¯ä»¥ï¼Œæˆ‘ä»¬é¼“åŠ±æ‚¨å°è¯•ä½¿ç”¨ Go çš„æœ€æ–°ç‰ˆæœ¬ï¼å¦‚æœæ‚¨æ›´å–œæ¬¢ä½¿ç”¨ Go 1.25ï¼Œæˆ‘ä»¬ä¹ŸåŒæ ·æ¬¢è¿æ‚¨çš„åé¦ˆã€‚è¯·å‚é˜…è¿™æ¡ GitHub è¯„è®ºï¼Œ å…¶ä¸­è¯¦ç»†è¯´æ˜äº†æˆ‘ä»¬å¸Œæœ›çœ‹åˆ°çš„è¯Šæ–­ä¿¡æ¯ï¼ˆå¦‚æœæ‚¨å¯ä»¥åˆ†äº«è¿™äº›ä¿¡æ¯ï¼‰ï¼Œä»¥åŠæˆ‘ä»¬æ¨èçš„åé¦ˆæ¸ é“ã€‚\nå†ç¨‹ # åœ¨ç»“æŸè¿™ç¯‡åšæ–‡ä¹‹å‰ï¼Œè®©æˆ‘ä»¬èŠ±ç‚¹æ—¶é—´è°ˆè°ˆæˆ‘ä»¬èµ°åˆ°ä»Šå¤©çš„å†ç¨‹ï¼Œä»¥åŠè¿™é¡¹æŠ€æœ¯èƒŒåçš„äººæ€§å› ç´ ã€‚\nç»¿èŒ¶çš„æ ¸å¿ƒç†å¿µçœ‹ä¼¼ç®€å•ï¼Œå°±åƒæŸä¸ªäººçµå…‰ä¸€é—ªçš„çµæ„Ÿç«èŠ±ã€‚\nä½†å®é™…ä¸Šï¼ŒGreen Tea æ˜¯è®¸å¤šäººå¤šå¹´æ¥å…±åŒåŠªåŠ›å’Œæ„æ€çš„æˆæœã€‚Go å›¢é˜Ÿçš„å¤šä½æˆå‘˜éƒ½å‚ä¸äº†æ„æ€ï¼ŒåŒ…æ‹¬ Michael Prattã€Cherry Muiã€David Chase å’Œ Keith Randallã€‚å½“æ—¶åœ¨è‹±ç‰¹å°”å·¥ä½œçš„ Yves Vandriessche çš„å¾®æ¶æ„è§è§£ä¹Ÿå¯¹è®¾è®¡æ¢ç´¢èµ·åˆ°äº†è‡³å…³é‡è¦çš„ä½œç”¨ã€‚ä¸ºäº†ä½¿è¿™ä¸ªçœ‹ä¼¼ç®€å•çš„ç†å¿µå¾—ä»¥å®ç°ï¼Œæˆ‘ä»¬å°è¯•äº†è®¸å¤šæ–¹æ³•ï¼Œä¹Ÿå¤„ç†äº†è®¸å¤šç»†èŠ‚é—®é¢˜ã€‚\næ—¶é—´çº¿æç»˜äº†æˆ‘ä»¬åœ¨è¾¾åˆ°ä»Šå¤©è¿™ç§çŠ¶æ€ä¹‹å‰ï¼Œå°è¯•è¿‡çš„ä¸€äº›ç±»ä¼¼æƒ³æ³• è¿™ä¸ªæƒ³æ³•çš„èŒèŠ½å¯ä»¥è¿½æº¯åˆ° 2018 å¹´ã€‚æœ‰è¶£çš„æ˜¯ï¼Œå›¢é˜Ÿé‡Œçš„æ¯ä¸ªäººéƒ½è®¤ä¸ºæœ€åˆçš„æƒ³æ³•æ˜¯åˆ«äººæå‡ºçš„ã€‚\nç»¿èŒ¶è¿™ä¸ªåå­—æ˜¯åœ¨ 2024 å¹´å¾—æ¥çš„ã€‚å½“æ—¶ï¼Œå¥¥æ–¯æ±€åœ¨æ—¥æœ¬å››å¤„å¯»è§…å’–å•¡é¦†ï¼Œå–äº†æ— æ•°æŠ¹èŒ¶ï¼Œå¹¶ç”±æ­¤æ„æ€å‡ºäº†æ—©æœŸç‰ˆæœ¬çš„åŸå‹ï¼è¿™ä¸ªåŸå‹è¯æ˜äº†ç»¿èŒ¶çš„æ ¸å¿ƒç†å¿µæ˜¯å¯è¡Œçš„ã€‚ä»æ­¤ï¼Œæˆ‘ä»¬ä¾¿å¼€å§‹äº†ç»¿èŒ¶çš„ç ”å‘ä¹‹è·¯ã€‚\nåœ¨ 2025 å¹´ï¼Œéšç€ Michael å°†ç»¿èŒ¶é¡¹ç›®å®æ–½å¹¶æŠ•å…¥ç”Ÿäº§ï¼Œå…¶ç†å¿µè¿›ä¸€æ­¥å‘å±•å’Œå˜åŒ–ã€‚\nè¿™éœ€è¦å¤§é‡çš„åä½œæ¢ç´¢ï¼Œå› ä¸ºç»¿èŒ¶ç®—æ³•ä¸ä»…ä»…æ˜¯ä¸€ä¸ªç®—æ³•ï¼Œè€Œæ˜¯ä¸€ä¸ªå®Œæ•´çš„è®¾è®¡ç©ºé—´ã€‚æˆ‘ä»¬è®¤ä¸ºï¼Œå•å‡­æˆ‘ä»¬ä¸­çš„ä»»ä½•ä¸€ä¸ªäººéƒ½æ— æ³•ç‹¬è‡ªé©¾é©­å®ƒã€‚ä»…ä»…æœ‰æƒ³æ³•æ˜¯ä¸å¤Ÿçš„ï¼Œä½ è¿˜éœ€è¦å¼„æ¸…æ¥šç»†èŠ‚å¹¶åŠ ä»¥éªŒè¯ã€‚ç°åœ¨æˆ‘ä»¬å·²ç»åšåˆ°äº†ï¼Œç»ˆäºå¯ä»¥å¼€å§‹è¿­ä»£äº†ã€‚\nç»¿èŒ¶çš„æœªæ¥ä¸€ç‰‡å…‰æ˜ã€‚\nè¯·å†æ¬¡å°è¯•è®¾ç½® GOEXPERIMENT=greenteagc ï¼Œå¹¶å‘Šè¯‰æˆ‘ä»¬ç»“æœå¦‚ä½•ï¼æˆ‘ä»¬å¯¹è¿™é¡¹å·¥ä½œæ„Ÿåˆ°éå¸¸å…´å¥‹ï¼Œå¹¶æœŸå¾…æ‚¨çš„åé¦ˆï¼\n"},{"id":3,"href":"/2025/10/16/debezium-Mongodb-Connector-%E5%A2%9E%E9%87%8F%E5%BF%AB%E7%85%A7%E4%BD%BF%E7%94%A8/","title":"Debezium Mongodb Connector å¢é‡å¿«ç…§ä½¿ç”¨","section":"Posts","content":" ä¹‹å‰çš„åšå®¢ Kafka Connect Mongodb åå¤å¿«ç…§ - å¤§æ•°æ®é›†å¿«ç…§\næœ¬æ–‡ä¸­ä½¿ç”¨çš„ MongodbSourceConnector æ˜¯ io.debezium.connector.mongodb.MongoDbConnector 2.2.1.Finalã€‚\næœºåˆ¶ç®€ä»‹ # ä¸ºäº†æä¾›ç®¡ç†å¿«ç…§çš„çµæ´»æ€§ï¼ŒDebezium åŒ…å«ä¸€ä¸ªè¡¥å……å¿«ç…§æœºåˆ¶ï¼Œç§°ä¸ºå¢é‡å¿«ç…§ã€‚å¢é‡å¿«ç…§ä¾èµ–äº Debezium æœºåˆ¶å‘ Debezium è¿æ¥å™¨å‘é€ä¿¡å·ã€‚â€¼ï¸ å¢é‡å¿«ç…§è¿è¡Œæ—¶ï¼Œä¸ä¼šé˜»å¡å˜æ›´æµäº‹ä»¶å¤„ç†ã€‚\nåˆå§‹å¿«ç…§ä¼šå…ˆä¿å­˜ change stream çš„ä½ç‚¹ï¼Œå¼€å§‹æ‰§è¡Œå…¨é‡å¿«ç…§ï¼Œå…¨é‡å¿«ç…§å®Œæˆåï¼Œå†ä»ä¿å­˜çš„ä½ç‚¹å¼€å§‹å¢é‡å¤„ç†å˜æ›´äº‹ä»¶ã€‚\nç›®å‰ Debezium æ”¯æŒå¢é‡å¿«ç…§çš„è¿æ¥å™¨æœ‰ï¼š\nDb2 MariaDB (Technology Preview) MongoDB MySQL Oracle PostgreSQL SQL Server å‘é€è¿™ä¸ªä¿¡å·æ”¯æŒå¤šç§æ–¹å¼ï¼Œé€šè¿‡é…ç½® signal.enabled.channels æ¥æŒ‡å®šï¼Œé»˜è®¤ä¸º sourceï¼ˆä¹Ÿå°±æ˜¯æ•°æ®é›†åˆæ–¹å¼ï¼‰ï¼Œå¯é€‰å€¼æœ‰ï¼šsourceã€kafkaã€file å’Œ jmxï¼š\nsource æºæ•°æ®åº“ï¼š é…ç½® signal.data.collection æ¥æŒ‡å®šé›†åˆ kafka: é…ç½® signal.kafka.topic æ¥æŒ‡å®š topic file: é…ç½® signal.file æ¥æŒ‡å®šæ–‡ä»¶è·¯å¾„ï¼Œå†™å…¥æ–‡ä»¶çš„æ ¼å¼æ•°æ®ä¸º JSONï¼Œå­—æ®µå–å€¼å‚è€ƒä¸‹é¢çš„è¡¨æ ¼ã€‚ jmx: å¯ç”¨ JMX MBean Server æ¥æš´éœ² signaling bean éœ€è¦å¯ç”¨å¢é‡å¿«ç…§æ—¶ï¼Œåªéœ€è¦å‘ç‰¹å®šæ–¹å¼ä¸­å†™å…¥æ•°æ®å³å¯ã€‚å¦‚æœæ˜¯ source åªéœ€è¦å‘æ•°æ®åº“ä¸­æ’å…¥ä¸€æ¡æ•°æ®ï¼Œå¦‚æœæ˜¯ kafka é‚£ä¹ˆåˆ™æ˜¯æŠ•é€’ä¸€æ¡æ¶ˆæ¯ã€‚\nsource(mongodb) é›†åˆæ•°æ®æ ¼å¼ï¼š\n\u0026lt;signalDataCollection\u0026gt;.insert({ \u0026#34;id\u0026#34; : _\u0026lt;idNumber\u0026gt;, // å¢é‡å¿«ç…§ä¿¡å·æ–‡æ¡£çš„ IDï¼Œå¿…é¡»å”¯ä¸€, ä½¿ç”¨ UUID ç­‰æ–¹å¼ç”Ÿæˆ, mongodb ä¸­ä½œä¸º _id å­—æ®µ \u0026#34;type\u0026#34; : \u0026lt;snapshotType\u0026gt;, // ä¿¡å·ç±»å‹ï¼Œå›ºå®šå€¼: execute-snapshot, stop-snapshot, pause-snapshot, resume-snapshot \u0026#34;data\u0026#34; : { // ä¿¡å·æ•°æ®ï¼Œæ ¹æ® type ä¸åŒè€Œä¸åŒ, è¿™é‡Œä»¥ execute-snapshot ä¸ºä¾‹ \u0026#34;data-collections\u0026#34; : [ // è¦æ‰§è¡Œå¢é‡å¿«ç…§çš„æ•°æ®é›†åˆï¼Œå¿…é¡»æ˜¯å·²æ³¨å†Œçš„é›†åˆ \u0026#34;\u0026lt;collectionName\u0026gt;\u0026#34;, \u0026#34;\u0026lt;collectionName\u0026gt;\u0026#34; ], \u0026#34;type\u0026#34;: \u0026lt;snapshotType\u0026gt;, // å¿«ç…§ç±»å‹: `incremental` å’Œ `blocking` // æ³¨æ„ï¼š2.2.1-Final ä¸­ä¸æ”¯æŒ additional-conditionsï¼Œ2.7.0-Alpha1 å¼€å§‹æ”¯æŒ \u0026#34;additional-conditions\u0026#34;: [ // å¯é€‰ï¼Œå¢é‡å¿«ç…§æ—¶çš„ç­›é€‰æ¡ä»¶ { \u0026#34;data-collection\u0026#34; : \u0026#34;\u0026lt;collectionName\u0026gt;\u0026#34;, // æŒ‡å®šé›†åˆ \u0026#34;filter\u0026#34; : \u0026#34;\u0026lt;additional-condition\u0026gt;\u0026#34; // å¯é€‰ï¼Œå¢é‡å¿«ç…§æ—¶çš„ç­›é€‰æ¡ä»¶ï¼Œå¦‚ï¼š`age \u0026gt; 18` } ] } }); ä¸¾ä¾‹å¦‚ä¸‹ï¼š\n{ \u0026#34;id\u0026#34;: \u0026#34;execute-mode-snapshot-sample\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;execute-snapshot\u0026#34;, \u0026#34;data\u0026#34;: { \u0026#34;data-collections\u0026#34;: [ \u0026#34;test.users\u0026#34; ], \u0026#34;type\u0026#34;: \u0026#34;incremental\u0026#34;, \u0026#34;additional-conditions\u0026#34;: [ { \u0026#34;data-collection\u0026#34;: \u0026#34;test.users\u0026#34;, \u0026#34;filter\u0026#34;: \u0026#34;age \u0026gt; 18\u0026#34; } ] } } kafka æ¶ˆæ¯æ ¼å¼ï¼š\nKey = `test_connector` Value = `{\u0026#34;type\u0026#34;:\u0026#34;execute-snapshot\u0026#34;,\u0026#34;data\u0026#34;: {\u0026#34;data-collections\u0026#34;: [\u0026#34;schema1.table1\u0026#34;, \u0026#34;schema1.table2\u0026#34;], \u0026#34;type\u0026#34;: \u0026#34;INCREMENTAL\u0026#34;}}` å…¶å®ç°åŸºäº DDD-3 è®¾è®¡æ–‡æ¡£ ï¼›å®˜æ–¹è¯¦ç»†ä»‹ç»åœ¨ debezium mongodb incremental-snapshotsã€‚\nä½¿ç”¨åœºæ™¯ # å¢é‡å¿«ç…§æå‡ºçš„èƒŒæ™¯æ˜¯ï¼š\nDebezium é€šå¸¸é€šè¿‡æ•°æ®åº“äº‹åŠ¡æ—¥å¿—æµå¼ä¼ è¾“å˜æ›´æ•°æ®ã€‚ç„¶è€Œï¼Œåˆå§‹å¿«ç…§ï¼ˆå³æ•è·æ—¢æœ‰æ•°æ®ï¼‰æ˜¯å…¨è¡¨æ‰«æã€‚è¿™ç§æ–¹å¼ä¸ä»…è€—æ—¶é•¿ï¼Œè€Œä¸”ä¸€æ—¦ä¸­æ–­å°±éœ€è¦ä»å¤´å¼€å§‹ã€‚ åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦ç«‹å³è·å–å…¨éƒ¨å†å²æ•°æ®ã€‚æœ‰æ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨ connector è¿è¡ŒæœŸé—´åŠ¨æ€æ·»åŠ æ–°è¡¨ï¼Œä¸”ä¸å¸Œæœ›æš‚åœæ•°æ®æµè½¬ã€‚ å…·ä½“ä¸¾ä¾‹æ¥è¯´ï¼š\nå‡è®¾ Source Connector å·²ç»å°†å˜æ›´åŒæ­¥åˆ° Kafka ä¸­ã€‚ä½†åœ¨ Sink Connector æ¶ˆè´¹ä¹‹å‰ï¼ŒKafka ä¸­çš„ topic è¢«é”™è¯¯åˆ é™¤ã€‚è¿™æ—¶å¦‚æœæƒ³è¦æ¢å¤è¿™äº›æ•°æ®ï¼Œä½¿ç”¨åˆå§‹åŒ–å¿«ç…§ä¼šéå¸¸ç¬¨é‡å’Œéº»çƒ¦ã€‚ å‡è®¾é›†åˆ A æ‹¥æœ‰è¶…å¤§æ•°æ®é‡ï¼Œæ‰§è¡Œå®Œæ•´å¿«ç…§éœ€è¦ 5 ä¸ªå°æ—¶ã€‚ä½†æ•°æ®åº“çš„ oplog æœ€å¤šåªèƒ½ä¿å­˜ 1 ä¸ªå°æ—¶çš„å˜æ›´äº‹ä»¶ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœä½¿ç”¨åˆå§‹å¿«ç…§ï¼Œå°±æ— æ³•å®ç°å®Œæ•´çš„æ•°æ®åŒæ­¥ã€‚ ä½¿ç”¨æ¼”ç¤º # å‡è®¾å·²ç»æ­å»ºå¥½äº†ä¸€æ•´å¥— CDC ç³»ç»Ÿ: å°† mongodb ä¸­çš„ test.users åŒæ­¥åˆ° ES ä¸­ã€‚\n1. åˆ›å»ºå­˜é‡æ•°æ® # ä¸ºäº†æ¼”ç¤ºå¢é‡å¿«ç…§çš„ä½¿ç”¨ï¼Œæˆ‘ä»¬å…ˆå‘ test.users é›†åˆä¸­æ’å…¥ 5 æ¡æ•°æ®ï¼š\nfor(let i = 1; i \u0026lt;= 5; i++) { db.users.insertOne({ name: \u0026#39;Pre-connector User \u0026#39; + i, email: \u0026#39;pre\u0026#39; + i + \u0026#39;@example.com\u0026#39;, created_at: new Date() }); } 2. åˆ›å»º Connector # å…¶ä¸­ Source Connector é…ç½®å¦‚ä¸‹ï¼š\n{ \u0026#34;name\u0026#34;: \u0026#34;mongodb-source\u0026#34;, \u0026#34;config\u0026#34;: { \u0026#34;connector.class\u0026#34;: \u0026#34;io.debezium.connector.mongodb.MongoDbConnector\u0026#34;, \u0026#34;mongodb.connection.string\u0026#34;: \u0026#34;mongodb://mongodb:27017/?replicaSet=rs0\u0026#34;, \u0026#34;topic.prefix\u0026#34;: \u0026#34;mongodb-cdc\u0026#34;, \u0026#34;database.include.list\u0026#34;: \u0026#34;test\u0026#34;, \u0026#34;collection.include.list\u0026#34;: \u0026#34;test.users\u0026#34;, \u0026#34;snapshot.mode\u0026#34;: \u0026#34;never\u0026#34;, // å¿«ç…§æ¨¡å¼ï¼Œnever ä»£è¡¨ä¸æ‰§è¡Œå¿«ç…§ï¼Œåªå¤„ç†å˜æ›´æµï¼ˆå¦‚æœæ˜¯å¤§æ•°æ®é›†åˆï¼Œå»ºè®®ä½¿ç”¨ neverï¼Œé€šè¿‡å¢é‡å¿«ç…§æ¥å¤„ç†å­˜é‡æ•°æ®ï¼‰ \u0026#34;incremental.snapshot.chunk.size\u0026#34;: \u0026#34;1024\u0026#34;, // å¢é‡å¿«ç…§æ¯æ¬¡å¤„ç†çš„æ–‡æ¡£æ•° \u0026#34;incremental.snapshot.allow.schema.changes\u0026#34;: \u0026#34;true\u0026#34;, // æ˜¯å¦å…è®¸å¢é‡å¿«ç…§æ—¶é›†åˆçš„ schema å‘ç”Ÿå˜åŒ– \u0026#34;signal.data.collection\u0026#34;: \u0026#34;test.debezium_signal\u0026#34; // å¢é‡å¿«ç…§ä¿¡å·é›†åˆ } } # åˆ›å»º Source Connector curl -X POST http://localhost:8083/connectors -H \u0026#34;Content-Type: application/json\u0026#34; -d @connector-tasks/mongodb-source.test.users.json # åˆ›å»º Sink Connector curl -X POST http://localhost:8083/connectors -H \u0026#34;Content-Type: application/json\u0026#34; -d @connector-tasks/es-sink.mongodb.users.json 3. æ£€æŸ¥å­˜é‡æ•°æ®æ˜¯å¦è¢«åŒæ­¥åˆ° ES ä¸­ # æˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥è¯¢ ES ä¸­çš„ mongodb-cdc-test-users ç´¢å¼•æ¥æ£€æŸ¥å­˜é‡æ•°æ®æ˜¯å¦è¢«åŒæ­¥åˆ° ES ä¸­ï¼š\n\u0026gt; sleep 10 \u0026amp;\u0026amp; curl -X GET \u0026#34;http://localhost:9200/_cat/indices?v\u0026#34; \u0026amp;\u0026amp; \\ echo \u0026amp;\u0026amp; curl -X GET \u0026#34;http://localhost:9200/mongodb-cdc.test.users/_count\u0026#34; % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 83 100 83 0 0 1659 0 --:--:-- --:--:-- --:--:-- 1693 health status index uuid pri rep docs.count docs.deleted store.size pri.store.size { \u0026#34;error\u0026#34;: { \u0026#34;root_cause\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;index_not_found_exception\u0026#34;, \u0026#34;reason\u0026#34;: \u0026#34;no such index [mongodb-cdc.test.users]\u0026#34;, \u0026#34;resource.type\u0026#34;: \u0026#34;index_or_alias\u0026#34;, \u0026#34;resource.id\u0026#34;: \u0026#34;mongodb-cdc.test.users\u0026#34;, \u0026#34;index_uuid\u0026#34;: \u0026#34;_na_\u0026#34;, \u0026#34;index\u0026#34;: \u0026#34;mongodb-cdc.test.users\u0026#34; } ], \u0026#34;type\u0026#34;: \u0026#34;index_not_found_exception\u0026#34;, \u0026#34;reason\u0026#34;: \u0026#34;no such index [mongodb-cdc.test.users]\u0026#34;, \u0026#34;resource.type\u0026#34;: \u0026#34;index_or_alias\u0026#34;, \u0026#34;resource.id\u0026#34;: \u0026#34;mongodb-cdc.test.users\u0026#34;, \u0026#34;index_uuid\u0026#34;: \u0026#34;_na_\u0026#34;, \u0026#34;index\u0026#34;: \u0026#34;mongodb-cdc.test.users\u0026#34; }, \u0026#34;status\u0026#34;: 404 } å¯ä»¥çœ‹åˆ°ï¼ŒES ä¸­æ²¡æœ‰ mongodb-cdc-test-users ç´¢å¼•ï¼Œè¯´æ˜å­˜é‡æ•°æ®è¿˜æ²¡æœ‰è¢«åŒæ­¥åˆ° ES ä¸­ã€‚\n4. æ’å…¥æ•°æ®éªŒè¯å˜æ›´æµå¤„ç†æ­£å¸¸ # ä¸ºäº†éªŒè¯å˜æ›´æµå¤„ç†æ­£å¸¸ï¼Œæˆ‘ä»¬å‘ test.users é›†åˆä¸­æ’å…¥ä¸€æ¡æ•°æ®ï¼š\ndb.users.insertOne({ name: \u0026#39;CDC Test User\u0026#39;, email: \u0026#39;cdc@example.com\u0026#39;, created_at: new Date() }); å†æ£€æŸ¥ ES ä¸­çš„ mongodb-cdc-test-users ç´¢å¼•ï¼Œå¯ä»¥çœ‹åˆ°æ–°å¢çš„æ•°æ®ï¼š\n\u0026gt; sleep 10 \u0026amp;\u0026amp; curl -X GET \u0026#34;http://localhost:9200/mongodb-cdc.test.users/_count\u0026#34; { \u0026#34;count\u0026#34;: 1, \u0026#34;_shards\u0026#34;: { \u0026#34;total\u0026#34;: 1, \u0026#34;successful\u0026#34;: 1, \u0026#34;skipped\u0026#34;: 0, \u0026#34;failed\u0026#34;: 0 } } 5. è§¦å‘å¢é‡å¿«ç…§-æ¨¡æ‹Ÿå¤§æ•°æ®é›†åˆ # ç°åœ¨å‘ test.debezium_signal é›†åˆä¸­æ’å…¥ä¸€æ¡æ–‡æ¡£ï¼š\ndb.debezium_signal.insertOne({ _id: \u0026#39;never-mode-snapshot\u0026#39;, // å¢é‡å¿«ç…§ä¿¡å·æ–‡æ¡£çš„ IDï¼Œå¿…é¡»å”¯ä¸€, ä½¿ç”¨ UUID ç­‰æ–¹å¼ç”Ÿæˆ type: \u0026#39;execute-snapshot\u0026#39;, data: { \u0026#39;data-collections\u0026#39;: [\u0026#39;test.users\u0026#39;], \u0026#39;type\u0026#39;: \u0026#39;incremental\u0026#39; } }); å†æ£€æŸ¥ ES ä¸­çš„ mongodb-cdc-test-users ç´¢å¼•ï¼Œå¯ä»¥çœ‹åˆ°å¢é‡å¿«ç…§å¤„ç†å®Œæˆåï¼Œæ•°æ®æ€»æ•°ä¸º 6ï¼š\n\u0026gt; sleep 10 \u0026amp;\u0026amp; curl -X GET \u0026#34;http://localhost:9200/mongodb-cdc.test.users/_count\u0026#34; { \u0026#34;count\u0026#34;: 6, \u0026#34;_shards\u0026#34;: { \u0026#34;total\u0026#34;: 1, \u0026#34;successful\u0026#34;: 1, \u0026#34;skipped\u0026#34;: 0, \u0026#34;failed\u0026#34;: 0 } } åœºæ™¯ Mongodb ä¸­æ•°æ® ES ä¸­æ•°æ® kafka ä¸­æ¶ˆæ¯ è§¦å‘å‰ 6 æ¡ 1 æ¡ 1 æ¡ è§¦å‘å 6 æ¡ 6 æ¡ 7 æ¡ 6. è§¦å‘å¢é‡å¿«ç…§-é‡æ–°å¿«ç…§ # è¿™æ—¶å€™å†è§¦å‘ä¸€æ¬¡å¢é‡å¿«ç…§ï¼Œæ¨¡æ‹Ÿé‡æ–°è§¦å‘å¢é‡å¿«ç…§çš„åœºæ™¯ï¼š\ndb.debezium_signal.insertOne({ _id: \u0026#39;never-mode-snapshot-again\u0026#39;, // å¢é‡å¿«ç…§ä¿¡å·æ–‡æ¡£çš„ IDï¼Œå¿…é¡»å”¯ä¸€, ä½¿ç”¨ UUID ç­‰æ–¹å¼ç”Ÿæˆ type: \u0026#39;execute-snapshot\u0026#39;, data: { \u0026#39;data-collections\u0026#39;: [\u0026#39;test.users\u0026#39;], \u0026#39;type\u0026#39;: \u0026#39;incremental\u0026#39; } }); è¿™æ—¶å€™å†æ£€æŸ¥ ES ä¸­çš„ mongodb-cdc-test-users ç´¢å¼•ï¼Œå¯ä»¥çœ‹åˆ°å¢é‡å¿«ç…§å¤„ç†å®Œæˆåï¼Œæ•°æ®æ€»æ•°ä¸º 6ï¼ˆES Sink é‡‡ç”¨äº† upsert æ¨¡å¼ï¼‰ï¼š\n\u0026gt; sleep 10 \u0026amp;\u0026amp; curl -X GET \u0026#34;http://localhost:9200/mongodb-cdc.test.users/_count\u0026#34; { \u0026#34;count\u0026#34;: 6, \u0026#34;_shards\u0026#34;: { \u0026#34;total\u0026#34;: 1, \u0026#34;successful\u0026#34;: 1, \u0026#34;skipped\u0026#34;: 0, \u0026#34;failed\u0026#34;: 0 } } åœºæ™¯ Mongodb ä¸­æ•°æ® ES ä¸­æ•°æ® kafka ä¸­æ¶ˆæ¯ è§¦å‘å‰ 6 æ¡ 6 æ¡ 7 æ¡ è§¦å‘å 6 æ¡ 6 æ¡ 13 æ¡ å¯ä»¥çœ‹åˆ°ï¼Œkafka ä¸­æ¶ˆæ¯å¢åŠ äº† 6 æ¡ï¼Œè¯´æ˜å…¨éƒ¨çš„ 6 æ¡æ•°æ®åˆè¢«å¿«ç…§äº†ä¸€æ¬¡ã€‚\nå®ç°åŸç† # Debezium çš„å®ç°æ–¹æ¡ˆå‚è€ƒäº†ï¼šDBLog: A Watermark Based Change-Data-Capture Framework è¿™ç¯‡è®ºæ–‡ã€‚\nWe wanted to (a) trigger the full state capture at any point in time. That is because the full state may not only be needed initially and may be needed at any time afterwards. For instance if the database is restored from a backup or for repairs if there is data loss or corruption downstream. There are also cases where only a subset of data needs to be repaired, for example if a specific set of rows has been identified to be corrupt downstream. (b) pause or resume at any time so that full state capture does not need to start from the beginning for large tables after restarting the process. (c) capture transaction log events and the full state side by side without stalling one or the other. There are use cases that require high availability of transaction log events so that the replication lag to the source is kept to a minimum. (d) prevent time-travel, by preserving the order of history when transmitting events to a derived datastore. This way an earlier version of a row (like the residential address of a member account) is not delivered after a later version. Hence, a solution had to combine transaction log events and the full state in a way that preserves the history of changes. (e) offer this as a platform. Hence it was crucial to minimize the impact on the source database. Otherwise this can hinter adoption of the platform, especially for use cases that have high traffic. In that regard we want to avoid primitives such as table locks which can block application write traffic. (f) function across a variety of Relational Database Management Systems (RDMBS), such as MySQL, PostgreSQL, Aurora [ 19 ] etc, that we use in production. In order to achieve that we wanted to avoid using vendor specific features\nå¯ä»¥çœ‹åˆ° DBLog æƒ³è¦è§£å†³ä»¥ä¸‹çš„é—®é¢˜ï¼š\na) éšæ—¶è§¦å‘å…¨é‡å¿«ç…§ï¼Œæ›´çµæ´»\nb) éšæ—¶æš‚åœæˆ–æ¢å¤ï¼Œè®©å¤§è¡¨ä¸éœ€è¦é‡å¤´å¼€å§‹å¿«ç…§\nc) å¿«ç…§å’Œå®æ—¶å˜æ›´äº‹ä»¶å¯ä»¥å¹¶è¡Œå¤„ç†ï¼Œäº’ä¸å¹²æ‰°\nd) é˜²æ­¢æ—¶é—´æ—…è¡Œï¼ˆå˜æ›´äº‹ä»¶çš„æ—¶åºä¸èƒ½é”™ä¹±ï¼‰ï¼ŒæŒ‰å˜æ›´é¡ºåºå¤„ç†äº‹ä»¶\ne) æä¾›å¹³å°åŒ–çš„è§£å†³æ–¹æ¡ˆï¼Œæœ€å°åŒ–å¯¹æºæ•°æ®åº“çš„å½±å“\nf) æ”¯æŒè·¨å¤šç§ RDBMSï¼Œå¦‚ MySQL, PostgreSQL, Aurora ç­‰\n1. DBLog - é¡¶å±‚æ¶æ„ # DBLog é¡¶å±‚æ¶æ„ DBLog å°†ä» Source æŒ‰ç…§ chunk å¤§å°åˆ†å—ä¾æ¬¡è¯»å–å…¨è¡¨ï¼Œå¹¶åŒæ—¶å¤„ç† change logï¼Œå°†å¤„ç†å¥½çš„æ•°æ®å†™å…¥åˆ° Output ä¸­å»ï¼Œäºæ­¤åŒæ—¶é€šè¿‡ State ç»„ä»¶è·Ÿè¸ªè®°å½•ã€‚\nå®ƒé‡‡ç”¨äº†ä¸»ä»æ¶æ„æ¥æä¾›é«˜å¯ç”¨æ”¯æŒ, è¿™ä¸æ˜¯æˆ‘ä»¬å…³æ³¨çš„é‡ç‚¹ï¼Œå°±ä¸å±•å¼€äº†ã€‚\n2. DBLog - å®ç°ç»†èŠ‚ # æƒ³è¦å®ç°è¿™æ ·çš„è§£å†³æ–¹æ¡ˆï¼Œç»•ä¸å¼€ä¸¤æ–¹é¢çš„æ•°æ®æ•è·ï¼Œåˆ†åˆ«æ˜¯ï¼š\na) å¢é‡å˜æ›´äº‹ä»¶\nå¢é‡å˜æ›´äº‹ä»¶ä»£è¡¨äº†æ•°æ®åº“ä¸­å‘ç”Ÿçš„æ¯æ¬¡å˜æ›´æ“ä½œï¼ŒåŒ…æ‹¬æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤ï¼Œè¿™äº›äº‹ä»¶ä¼šè¢«å®æ—¶æ•è·å¹¶å¤„ç†ã€‚\nb) å…¨é‡å¿«ç…§\nå…¨é‡å¿«ç…§æ˜¯æŒ‡å¯¹æ•°æ®åº“ä¸­çš„æ‰€æœ‰æ•°æ®è¿›è¡Œä¸€æ¬¡å®Œæ•´çš„å¤‡ä»½æˆ–å¤åˆ¶ã€‚\nä½†æ˜¯å¾ˆæ˜æ˜¾ï¼Œå¢é‡å’Œå…¨é‡ä¸èƒ½ç®€å•çš„å¹¶è¡Œå¤„ç†ã€‚æŒ‰ç…§å…¶ä»–æ–¹æ¡ˆçš„å¤„ç†æ–¹å¼ï¼Œå…¨é‡å¿«ç…§è¦ä¹ˆä¼šæš‚åœå¢é‡æ•è·ï¼ˆå¦‚ Maxwell å’Œ Debeziumï¼‰ï¼Œè¦ä¹ˆéœ€è¦åˆ›å»ºä¸€ä¸ªå‰¯æœ¬ï¼ˆMySQLStreamerï¼‰ï¼Œè¿˜æœ‰äº›ä¼šåŠ ä¸Šè¡¨é”ï¼ˆå¦‚ Debezium, é”å®šçš„å–å†³äºæ•°æ®åº“å’Œå®ç°ï¼‰ã€‚è¿™äº›æ–¹æ³•è¿™å¯¹äºå¤§å‹æ•°æ®åº“æ¥è¯´æ˜¯ä¸å¯æ¥å—çš„ã€‚\nä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼ŒDBLog æå‡ºçš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šå°†å¢é‡å’Œå…¨é‡å¿«ç…§åˆå¹¶å¤„ç†ã€‚å…·ä½“æ¥è¯´ï¼š\nå…¶ç®—æ³•æè¿°å¦‚ä¸‹å›¾ï¼š\nDBLog ç®—æ³•æè¿° ä¸¾ä¾‹æ¼”ç¤ºå¦‚ä¸‹å›¾ï¼š\nDBLog ä¸¾ä¾‹æ¼”ç¤º æ€»ç»“æ¥è¯´ï¼ŒDBLog æå‡ºçš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼š\nå…¨é‡å¿«ç…§é‡‡ç”¨ åˆ†å— çš„æ–¹å¼ä»æ•°æ®é›†åˆä¸­ è¯»å‡ºï¼ˆè¿™è¦æ±‚è¡¨/é›†åˆçš„ PK æ˜¯æœ‰åºçš„ä¸”ç¨³å®šçš„ï¼‰ã€‚ å‘å˜æ›´æµä¸­æ’å…¥ Low Watermarkï¼ˆLWï¼‰å’Œ High Watermarkï¼ˆHWï¼‰ï¼Œåˆ†åˆ«è¡¨ç¤ºå…¨é‡å¿«ç…§çš„å¼€å§‹å’Œç»“æŸä½ç½®ã€‚ å°†å…¨é‡ Chunk å’Œ å¢é‡å˜æ›´äº‹ä»¶åˆå¹¶ï¼Œç”Ÿæˆå…¨æ–°çš„äº‹ä»¶æµã€‚ é€šè¿‡åˆ†å—è¯»ï¼Œå¯ä»¥å®ç°å¯¹å¤§éƒ¨åˆ†æ•°æ®åº“çš„å…¼å®¹ï¼Œä¸éœ€è¦ä¾èµ–äºæ•°æ®åº“çš„ç‰¹å®šåŠŸèƒ½ã€‚chunk è·Ÿ å¢é‡äº‹ä»¶åˆå¹¶å®ç°äº†å®è§‚ä¸Šçš„å¹¶è¡Œå¤„ç†ï¼Œä¿è¯äº†å¢é‡äº‹ä»¶çš„å®æ—¶æ€§ã€‚æ°´å°åˆ™å¯ä»¥ç”¨æ¥æ§åˆ¶ chunk çš„å¤§å° å’Œ æ§åˆ¶å¿«ç…§çš„èµ·åœã€‚\n3. Debezium å®ç°æºç  # çŸ¥é“äº†æ•´ä¸ªå¢é‡å¿«ç…§çš„å®ç°æ€è·¯åï¼Œç°åœ¨æ¥çœ‹çœ‹ Debezium æ˜¯å¦‚ä½•å®ç°çš„ã€‚io.debezium.pipeline.signal.AbstractSnapshotSignal æŠ½è±¡äº†å¢é‡å¿«ç…§çš„å‡ ä¸ªä¿¡å·ï¼š\npublic abstract class AbstractSnapshotSignal\u0026lt;P extends Partition\u0026gt; implements Signal.Action\u0026lt;P\u0026gt; { private static final Logger LOGGER = LoggerFactory.getLogger(AbstractSnapshotSignal.class); protected static final String FIELD_DATA_COLLECTIONS = \u0026#34;data-collections\u0026#34;; protected static final String FIELD_TYPE = \u0026#34;type\u0026#34;; protected static final String FIELD_ADDITIONAL_CONDITION = \u0026#34;additional-condition\u0026#34;; protected static final String FIELD_SURROGATE_KEY = \u0026#34;surrogate-key\u0026#34;; // å¿½ç•¥å…¶ä»–ä»£ç ... } ä¿¡å·åˆ›å»ºåï¼Œä¼šè§¦å‘å¯¹åº”ä¿¡å·çš„ arrived æ–¹æ³•ï¼Œè¿™é‡Œä»¥ io.debezium.pipeline.signal.ExecuteSnapshot ä¸ºä¾‹ï¼š\npublic boolean arrived(Payload\u0026lt;P\u0026gt; signalPayload) throws InterruptedException { final List\u0026lt;String\u0026gt; dataCollections = getDataCollections(signalPayload.data); if (dataCollections == null) { return false; } SnapshotType type = getSnapshotType(signalPayload.data); Optional\u0026lt;String\u0026gt; additionalCondition = getAdditionalCondition(signalPayload.data); Optional\u0026lt;String\u0026gt; surrogateKey = getSurrogateKey(signalPayload.data); LOGGER.info(\u0026#34;Requested \u0026#39;{}\u0026#39; snapshot of data collections \u0026#39;{}\u0026#39; with additional condition \u0026#39;{}\u0026#39; and surrogate key \u0026#39;{}\u0026#39;\u0026#34;, type, dataCollections, additionalCondition.orElse(\u0026#34;No condition passed\u0026#34;), surrogateKey.orElse(\u0026#34;PK of table will be used\u0026#34;)); switch (type) { case INCREMENTAL: dispatcher.getIncrementalSnapshotChangeEventSource().addDataCollectionNamesToSnapshot( signalPayload.partition, dataCollections, additionalCondition, surrogateKey, signalPayload.offsetContext); break; } return true; } å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ˜¯å¢é‡å¿«ç…§ï¼Œä¼šè°ƒç”¨ IncrementalSnapshotChangeEventSource çš„ MongoDbIncrementalSnapshotChangeEventSource#addDataCollectionNamesToSnapshot æ–¹æ³•ï¼š\næ­¤æ–¹æ³•ä¼šè§¦å‘ readChunk æ–¹æ³•; readChunk æ–¹æ³•ä¼šå…ˆè§¦å‘ emitWindowOpen æ–¹æ³•ï¼Œå†æ‰§è¡Œå®é™…çš„åˆ†å—è¯»å–å’Œå¤„ç†é€»è¾‘ createDataEventsForDataCollection; readChunk æ–¹æ³•ä¼šè§¦å‘ emitWindowClose æ–¹æ³•; emitWindowClose å®é™…ä¸Šä¼šå‘å‡º snapshot-window-close ä¿¡å·ï¼Œè¢« io.debezium.pipeline.source.snapshot.incremental.CloseIncrementalSnapshotWindow å¤„ç†; public void addDataCollectionNamesToSnapshot(MongoDbPartition partition, List\u0026lt;String\u0026gt; dataCollectionIds, Optional\u0026lt;String\u0026gt; additionalCondition, Optional\u0026lt;String\u0026gt; surrogateKey, OffsetContext offsetContext) throws InterruptedException { // å¿½ç•¥å…¶ä»–ä»£ç ... final boolean shouldReadChunk = !context.snapshotRunning(); if (shouldReadChunk) { readChunk(partition); } } protected void readChunk(MongoDbPartition partition) throws InterruptedException { try { // è§¦å‘çª—å£æ‰“å¼€äº‹ä»¶ emitWindowOpen(); while (context.snapshotRunning()) { // è¯»å– chunk æ•°æ®åˆ° window ä¸­ createDataEventsForDataCollection(partition); // å¦‚æœ window ä¸ºç©ºï¼Œè¯´æ˜å½“å‰æ•°æ®é›†åˆå·²ç»è¯»å–å®Œæ¯• if (window.isEmpty()) { LOGGER.info(\u0026#34;No data returned by the query, incremental snapshotting of table \u0026#39;{}\u0026#39; finished\u0026#34;, currentDataCollectionId); collectionScanCompleted(partition); nextDataCollection(partition); } else { break; } } // è§¦å‘çª—å£å…³é—­äº‹ä»¶ emitWindowClose(); } // çœç•¥å…¶ä»–ä»£ç ... } private void createDataEventsForDataCollection(MongoDbPartition partition) throws InterruptedException { mongo.execute(\u0026#34;chunk query key for \u0026#39;\u0026#34; + currentCollection.id() + \u0026#34;\u0026#39;\u0026#34;, client -\u0026gt; { // æ„é€ æŸ¥è¯¢æ¡ä»¶ï¼š_id \u0026lt;= maxKey (å¿«ç…§å¯åŠ¨æ—¶ï¼Œæ•´ä¸ªæ–‡æ¡£çš„æœ€å¤§ä¸»é”®å€¼) final Document maxKeyPredicate = new Document(); final Document maxKeyOp = new Document(); maxKeyOp.put(\u0026#34;$lte\u0026#34;, context.maximumKey().get()[0]); maxKeyPredicate.put(DOCUMENT_ID, maxKeyOp); Document predicate = maxKeyPredicate; // å¦‚æœä¸Šä¸€æ¬¡è¯»å–çš„æœ€å¤§ä¸»é”®å€¼ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆæ„é€ æŸ¥è¯¢æ¡ä»¶ï¼š_id \u0026gt; chunkEndPosition (ä¸Šä¸€æ¬¡è¯»å–çš„æœ€å¤§ä¸»é”®å€¼) if (context.chunkEndPosititon() != null) { final Document chunkEndPredicate = new Document(); final Document chunkEndOp = new Document(); chunkEndOp.put(\u0026#34;$gt\u0026#34;, context.chunkEndPosititon()[0]); chunkEndPredicate.put(DOCUMENT_ID, chunkEndOp); predicate = new Document(); predicate.put(\u0026#34;$and\u0026#34;, Arrays.asList(chunkEndPredicate, maxKeyPredicate)); } // æŒ‰ç…§ PK ä¸»é”®å‡åºæŸ¥è¯¢ï¼Œé™åˆ¶è¿”å›çš„è®°å½•æ•°ä¸º incremental.snapshot.chunk.size for (BsonDocument doc : collection.find(predicate).sort(new Document(DOCUMENT_ID, 1)) .limit(connectorConfig.getIncrementalSnashotChunkSize())) { // æ”¾å…¥ window ä¸­ï¼Œ keyStruct ä¸ºä¸»é”® window.put(keyStruct, row); } // è®¾ç½®ä¸‹ä¸€æ¬¡ read chunk çš„ä¸‹é™ä¸ºè¿™ä¸€æ¬¡è¯»å–çš„æœ€å¤§ä¸»é”®å€¼ context.nextChunkPosition(lastKey); }); } è€Œ CloseIncrementalSnapshotWindow å®é™…ä¸Šä¼šå›è°ƒ IncrementalSnapshotChangeEventSource#closeWindow æ–¹æ³•\n// class CloseIncrementalSnapshotWindow public boolean arrived(Payload\u0026lt;P\u0026gt; signalPayload) throws InterruptedException { dispatcher.getIncrementalSnapshotChangeEventSource().closeWindow(signalPayload.partition, signalPayload.id, signalPayload.offsetContext); return true; } å› æ­¤é€»è¾‘åˆå›åˆ°äº† MongoDbIncrementalSnapshotChangeEventSource ä¸­ï¼š\npublic void closeWindow(MongoDbPartition partition, String id, OffsetContext offsetContext) throws InterruptedException { // å°† window ä¸­çš„æ•°æ®å‘é€ sendWindowEvents(partition, offsetContext); // è§¦å‘ä¸‹ä¸€ä¸ªåˆ†å—è¯»å– readChunk(partition); } å¦å¤–åœ¨ Debezium ä¸­, ChangeEventSourceCoordinator ä¼šåè°ƒ SnapshotChangeEventSource å’Œ StreamingChangeEventSource çš„æ‰§è¡Œï¼Œè¿™ä¸¤è€…äº§ç”Ÿçš„äº‹ä»¶ä¼šè¿›å…¥åˆ° EventDispatcher ä¸­çš„å…±äº«é˜Ÿåˆ—ä¸­ã€‚\n// ChangeEventSourceCoordinator#executeChangeEventSources protected void executeChangeEventSources(CdcSourceTaskContext taskContext, SnapshotChangeEventSource\u0026lt;P, O\u0026gt; snapshotSource, Offsets\u0026lt;P, O\u0026gt; previousOffsets, AtomicReference\u0026lt;LoggingContext.PreviousContext\u0026gt; previousLogContext, ChangeEventSourceContext context) throws InterruptedException { final P partition = previousOffsets.getTheOnlyPartition(); final O previousOffset = previousOffsets.getTheOnlyOffset(); previousLogContext.set(taskContext.configureLoggingContext(\u0026#34;snapshot\u0026#34;, partition)); SnapshotResult\u0026lt;O\u0026gt; snapshotResult = doSnapshot(snapshotSource, context, partition, previousOffset); if (running \u0026amp;\u0026amp; snapshotResult.isCompletedOrSkipped()) { previousLogContext.set(taskContext.configureLoggingContext(\u0026#34;streaming\u0026#34;, partition)); streamEvents(context, partition, snapshotResult.getOffset()); } } åœ¨æ¢³ç†è¿‡ç¨‹ä¸­ï¼Œæˆ‘æ²¡æœ‰å‘ç° Debezium ä¸­æœ‰ DBLog ä¸­æåˆ°çš„ Low Watermark å’Œ High Watermark ç›¸å…³çš„é€»è¾‘ï¼Œè€Œæ˜¯åœ¨ EventDispatcher ä¸­ï¼Œå½“ StreamingChangeEvent æäº¤æ—¶ (dispatchDataChangeEvent æ–¹æ³•)ï¼Œé€šçŸ¥å¢é‡å¿«ç…§å¯¹çª—å£ä¸­çš„äº‹ä»¶è¿›è¡Œå»é‡ã€‚\nè¿™é‡Œæˆ‘ä¸ªäººæ²¡æœ‰æ¢³ç†æ¸…æ¥šï¼Œå¢é‡å¿«ç…§ å’Œ å®æ—¶æµå˜æ›´ çš„äº‹ä»¶é¡ºåºæ˜¯æ€ä¹ˆæ ·çš„ï¼Œçœ‹èµ·æ¥æ˜¯å’Œ DBLog ä¸­çš„å®ç°ä¸å®Œå…¨ä¸€è‡´ã€‚\nDebezium è¿™ä¸€å—çš„æ¶æ„æ¢³ç†å¦‚ä¸‹ï¼š\nDebezium Source Connector Architecture æ€»ç»“ # å¢é‡å¿«ç…§ç›¸æ¯”åˆå§‹å¿«ç…§ï¼Œæ›´åŠ çµæ´»å¯æ§ï¼›å¯¹äºå¤§å‹æ•°æ®åº“æˆ–è€…é›†åˆçš„å¿«ç…§è¿‡ç¨‹æ›´å‹å¥½ï¼Œä¸ä¼šå½±å“å®æ—¶æµå˜æ›´çš„å¤„ç†ã€‚\n"},{"id":4,"href":"/2025/10/14/Apache-Doris-PreparedStatement%E9%97%AE%E9%A2%98%E6%8E%A2%E7%A9%B6/","title":"Apache Doris PreparedStatement ä¹‹è°œ","section":"Posts","content":" ä½¿ç”¨çš„ Apache Doris ç‰ˆæœ¬ï¼š3.0.3, å¯¹åº”çš„ Doris æºç å¦‚æœæ²¡æœ‰ç‰¹æ„è¯´æ˜ï¼Œå‡ä¸º 3.0.3 ç‰ˆæœ¬ã€‚\næ›´æ–° # åç»­åˆé‡åˆ°äº†ä¸€ä¸ªè·Ÿ prepared statement ç›¸å…³çš„é”™è¯¯ï¼Œèµ·å› æ˜¯åœ¨ä¸€æ¬¡è¿­ä»£ä¸­å°† DQ-1 çš„ gorm ç‰ˆæœ¬ä» v1.25.5 å‡çº§åˆ°äº† v1.26.1 å‘ç°å¤§é‡çš„ SQL æŠ¥é”™:\nError 1105 (HY000): errCode = 2, detailMessage = \\nmismatched input \u0026#39;LIMIT\u0026#39; expecting {\u0026lt;EOF\u0026gt;, \u0026#39;;\u0026#39;`ï¼‰ï¼› ä½†æ˜¯ SQL æ²¡æœ‰åšè¿‡ä»»ä½•è°ƒæ•´, å°† SQL å¤åˆ¶å‡ºæ¥åœ¨ mysql shell ä¸­éƒ½æ­£å¸¸è¿è¡Œã€‚\næŠ“åŒ…å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªé”™è¯¯æ˜¯åœ¨ COM_STMT_PREPARE é˜¶æ®µæŠ¥å‡ºçš„, å¦‚ä¸‹å›¾ï¼š\nupdate-prepare-limit-variables ç»è¿‡å¯¹æ¯”å’ŒæŸ¥çœ‹ gorm çš„å‘å¸ƒå†å²ï¼Œæ‰¾åˆ°è¿™æ ·ä¸€ä¸ª PR:\n#6806: let limit and offset use bind parameter\nå¸¦æ¥çš„å½±å“å°±æ˜¯æŠŠ limit åé¢çš„å˜é‡åœ¨ prepare é˜¶æ®µä½¿ç”¨å ä½ç¬¦å·æ›¿ä»£ï¼ˆä¹‹å‰çš„ç‰ˆæœ¬æ˜¯ç›´æ¥ä½¿ç”¨çš„å€¼è€Œä¸æ˜¯å ä½ç¬¦ï¼‰ã€‚æ°æ° doris è¿˜ä¸æ”¯æŒå¦‚ä¸‹è¿™ç§è¯­å¥ï¼Œæ‰€ä»¥å¯¼è‡´äº†ä¸Šé¢çš„é”™è¯¯ã€‚\nselect * from user where id = ? limit ?; åŸå› æ˜¯ doris çš„ SQL è¯­æ³•çº¦å®šäº†, LIMIT OFFSET åé¢å¿…é¡»è¦è·Ÿä¸€ä¸ªæ•´å‹å­—é¢é‡ï¼š\n// fe/fe-core/src/main/antlr4/org/apache/doris/nereids/DorisParser.g4 limitClause : (LIMIT limit=INTEGER_VALUE) | (LIMIT limit=INTEGER_VALUE OFFSET offset=INTEGER_VALUE) | (LIMIT offset=INTEGER_VALUE COMMA limit=INTEGER_VALUE) ; ä¸ºæ­¤ï¼Œæäº¤äº†ä¸€ä¸ª Feature Request: #59962: [Feature] Placeholder in LIMIT Claus\nèƒŒæ™¯ # è¿è¥åé¦ˆäº†ä¸€äº›ä¸šåŠ¡å¼‚å¸¸ï¼Œè¿™äº›å¼‚å¸¸éƒ½æŒ‡å‘äº†ä¸€ä¸ª Doris æ•°æ®æŸ¥è¯¢æœåŠ¡ï¼ˆåéƒ½ç”¨ DQ-1 æŒ‡ä»£ï¼‰ï¼Œè¯¥æœåŠ¡æ—¥å¿—ä¸­å­˜åœ¨å¤§é‡çš„é”™è¯¯æ—¥å¿—ï¼Œå¦‚ä¸‹ï¼š\nplatformAwardBiz.GetByID failed: Error 1047 (08S01): msg: Not supported such prepared statement æ—¥å¿—ä¸­å‘ç°ï¼Œå…¨éƒ¨çš„æŸ¥è¯¢å‡æŠ¥äº† Not supported such prepared statement é”™è¯¯ï¼Œè€Œä¸æ˜¯å­˜åœ¨ç‰¹å®šçš„æŸ¥è¯¢è¯­å¥ã€‚è€Œä¸æ­¤åŒæ—¶ï¼Œå¦å¤–çš„ Doris æŸ¥è¯¢æœåŠ¡ (åä½¿ç”¨ DQ-2 æŒ‡ä»£) å¹¶æ²¡æœ‰å‡ºç°è¯¥é”™è¯¯æ—¥å¿—ã€‚\nDQ-1 ä½¿ç”¨ golang ç¼–å†™ï¼Œä½¿ç”¨äº† gorm ä½œä¸ºè¿æ¥ Doris çš„æŸ¥è¯¢å·¥å…·ã€‚DQ-2 ä½¿ç”¨äº† python3ç¼–å†™ï¼Œä½¿ç”¨äº† pymysql ä½œä¸ºè¿æ¥ Doris çš„æŸ¥è¯¢å·¥å…·ã€‚\nå‘ç°é—®é¢˜åï¼ŒçŒœæµ‹æ˜¯ prepared statement æœºåˆ¶çš„ç›¸å…³é—®é¢˜ï¼Œå¿«é€Ÿè§£å†³æ–¹æ¡ˆé€‰æ‹©äº†é‡å¯ DQ-1 å’Œ Doris FE èŠ‚ç‚¹ï¼Œç„¶åé”™è¯¯æ¶ˆå¤±ã€‚\né—®é¢˜åˆ†æ # é¦–å…ˆä»æ—¥å¿—å…¥æ‰‹ï¼Œé‡‡é›†äº† FE çš„é”™è¯¯æ—¥å¿—ï¼Œä½†ç»è¿‡æ’æŸ¥æ²¡æœ‰å‘ç°æ˜æ˜¾çš„å¼‚å¸¸æ—¥å¿—ã€‚ç»è¿‡æ£€ç´¢æœç´¢å¼•æ“å’Œç¤¾åŒºï¼Œä¹Ÿæ²¡æœ‰å‘ç°æœ‰ç›¸å…³çš„ issueã€‚\né‚£åªèƒ½ä»æºç å…¥æ‰‹äº†ã€‚åœ¨è¿›å»æºç åˆ†æä¹‹å‰ï¼Œè¿™é‡Œå¸¦ç€å‡ ä¸ªç–‘é—®ï¼š\nä¸ºä»€ä¹ˆ DQ-1 ä¼šæŠ¥è¿™ä¸ªé”™è¯¯ï¼Œè€Œ DQ-2 ä¸ä¼šæŠ¥è¿™ä¸ªé”™è¯¯ï¼Ÿ ä¸ºä»€ä¹ˆé‡å¯ DQ-1 å’Œ Doris FE èŠ‚ç‚¹å¯ä»¥è§£å†³é—®é¢˜ï¼Ÿ æ˜¯ Doris FE èŠ‚ç‚¹çš„é—®é¢˜ï¼Œè¿˜æ˜¯ DQ-1 çš„é—®é¢˜ï¼Ÿ DQ-1 çš„å«Œç–‘éå¸¸å°ï¼Œå› ä¸ºé¡¹ç›®å†…æœ‰ç›¸åŒçš„ä»£ç è¿æ¥å¦å¤–çš„ MySQL æ•°æ®åº“ï¼Œå¹¶æ²¡æœ‰å‡ºç°ç±»ä¼¼çš„é—®é¢˜ã€‚\nApache Doris æºç åˆ†æ1 # å°è¯•åœ¨å®¢æˆ·ç«¯æ£€ç´¢ Not supported such prepared statement å…³é”®è¯ï¼Œå‘ç°æ²¡æœ‰ä»»ä½•ç»“æœï¼Œè¯´æ˜è¿™ä¸ªé”™è¯¯ä¿¡æ¯æ˜¯ Doris FE èŠ‚ç‚¹æŠ¥å‡ºçš„ã€‚\nåœ¨æºç ä¸­æœç´¢ Not supported such prepared statementï¼Œå‘ç°è¯¥é”™è¯¯ä¿¡æ¯å®šä¹‰åœ¨ fe/fe-core/src/main/java/org/apache/doris/qe/MysqlConnectProcessor.java æ–‡ä»¶ä¸­ï¼š\n// process COM_EXECUTE, parse binary row data // https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_com_stmt_execute.html private void handleExecute() { packetBuf = packetBuf.order(ByteOrder.LITTLE_ENDIAN); // parse stmt_id, flags, params int stmtId = packetBuf.getInt(); // flag packetBuf.get(); // iteration_count always 1, packetBuf.getInt(); // nererids PreparedStatementContext preparedStatementContext = ctx.getPreparedStementContext(String.valueOf(stmtId)); if (preparedStatementContext == null) { if (LOG.isDebugEnabled()) { LOG.debug(\u0026#34;No such statement in context, stmtId:{}\u0026#34;, stmtId); } ctx.getState().setError(ErrorCode.ERR_UNKNOWN_COM_ERROR, \u0026#34;msg: Not supported such prepared statement\u0026#34;); return; } handleExecute(preparedStatementContext.command, stmtId, preparedStatementContext); } ä»è¿™ä¸€æ®µä»£ç ï¼Œå°±å¯ä»¥å¾—åˆ°ä»¥ä¸‹å‡ ä¸ªç»“è®ºï¼š\nDoris æ”¯æŒ MySQL åè®®çš„ PreparedStatement æœºåˆ¶ è¿™ä¸ªé”™è¯¯æ˜¯åœ¨COM_STMT_EXECUTE é˜¶æ®µæŠ¥å‡ºçš„ è¯¥é”™è¯¯æ˜¯å› ä¸º PreparedStatementContext å¯¹è±¡ä¸º null å¯¼è‡´çš„ è¿™ä¸ª stmtId æ˜¯ä»å®¢æˆ·ç«¯ä¼ é€’è¿‡æ¥çš„ ç®€å•æ€»ç»“ä¸€ä¸‹ï¼Œè¿™ä¸ªé”™è¯¯çš„æ ¹æœ¬åŸå› æ˜¯ Doris FE èŠ‚ç‚¹æ²¡æœ‰æ‰¾åˆ° stmtId å¯¹åº”çš„ PreparedStatementContext å¯¹è±¡å¯¼è‡´çš„ã€‚é‚£ä¸ºä»€ä¹ˆå®¢æˆ·ç«¯ä¼šä¼ é€’ä¸€ä¸ª FE èŠ‚ç‚¹æ²¡æœ‰çš„ stmtId å‘¢ï¼Ÿ\nå†è¿›ä¸€æ­¥æ·±å…¥ä»£ç å‰ï¼Œå‘ç°è‡ªå·±å¯¹ MySQL çš„ PreparedStatement æœºåˆ¶å¹¶ä¸æ˜¯å¾ˆäº†è§£ï¼Œäºæ˜¯å…ˆå»è¡¥å……äº†ä¸€ä¸‹ç›¸å…³çŸ¥è¯†ã€‚\nMySQL Prepared Statement åè®® # MySQL åè®® - Prepared Statments\nPrepared Statments åè®®æ˜¯ä» MySQL 4.1 ç‰ˆæœ¬å¼€å§‹æ”¯æŒçš„ï¼Œä¸»è¦æ˜¯ä¸ºäº†æé«˜ SQL è¯­å¥çš„æ‰§è¡Œæ•ˆç‡å’Œå®‰å…¨æ€§ã€‚åè®®çº¦å®šäº†ä»¥ä¸‹å‡ ä¸ªå‘½ä»¤ï¼š\nCommand Description COM_STMT_PREPARE å‡†å¤‡ä¸€ä¸ª SQL è¯­å¥ï¼Œè¿”å›ä¸€ä¸ª stmt_id COM_STMT_EXECUTE æ‰§è¡Œä¸€ä¸ªå·²ç»å‡†å¤‡å¥½çš„ SQL è¯­å¥ï¼Œä½¿ç”¨ stmt_id COM_STMT_CLOSE å…³é—­ä¸€ä¸ªå·²ç»å‡†å¤‡å¥½çš„ SQL è¯­å¥ï¼Œé‡Šæ”¾èµ„æº COM_STMT_RESET é‡ç½® COM_STMT_SEND_LONG_DATA å‘½ä»¤å‘é€çš„å‚æ•°, å¹¶å…³é—­ COM_STMT_EXECUTE æ‰“å¼€çš„æ¸¸æ ‡ COM_STMT_SEND_LONG_DATA å‘é€é•¿æ•°æ®å‚æ•°ç»™ä¸€ä¸ªå·²ç»å‡†å¤‡å¥½çš„ SQL è¯­å¥ COM_STMT_FETCH è·å–ä¸€ä¸ªå·²ç»å‡†å¤‡å¥½çš„ SQL è¯­å¥çš„ç»“æœé›† PreparedStatement çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š\nPreparedStatement æµç¨‹å›¾ ä» Doris æºç ä¸­ï¼Œå·²ç»å¾—çŸ¥æ˜¯åœ¨ COM_STMT_EXECUTE é˜¶æ®µæŠ¥å‡ºçš„é”™è¯¯ï¼Œè€Œ COM_STMT_EXECUTE ä¼ é€’çš„ stmt_idæ¥è‡ªäº COM_STMT_PREPARE é˜¶æ®µã€‚é‚£ä¹ˆè¿™é‡Œå†é‡ç‚¹å…³æ³¨ä¸‹è¿™ä¸¤ä¸ªå‘½ä»¤çš„åè®®ç»†èŠ‚ã€‚\nCOM_STMT_PREPARE # COM_STMT_PREPARE å‘½ä»¤çš„è¯·æ±‚åŒ…æ ¼å¼å¦‚ä¸‹ï¼š\nType Name Description int\u0026lt;1\u0026gt; status [0x16] COM_STMT_PREPARE string query The query to prepare å“åº”åŒ…æ ¼å¼å¦‚ä¸‹ï¼š\nType Name Description int\u0026lt;1\u0026gt; status [0x00] OK int\u0026lt;4\u0026gt; statement_id The statement identifier int\u0026lt;2\u0026gt; num_columns The number of columns in the result set int\u0026lt;2\u0026gt; num_params The number of parameters in the statement int\u0026lt;1\u0026gt; reserved_1 [0x00] Filler int\u0026lt;2\u0026gt; warning_count The number of warnings çœç•¥å…¶ä½™å­—æ®µ COM_STMT_EXECUTE # COM_STMT_EXECUTE å‘½ä»¤çš„è¯·æ±‚åŒ…æ ¼å¼å¦‚ä¸‹ï¼š\nType Name Description int\u0026lt;1\u0026gt; status [0x17] COM_STMT_EXECUTE int\u0026lt;4\u0026gt; statement_id ID of the prepared statement to execute int\u0026lt;1\u0026gt; flags Flags. See enum_cursor_type int\u0026lt;4\u0026gt; iteration_count Number of times to execute the statement. Currently always 1. çœç•¥å…¶ä½™å­—æ®µ å“åº”åŒ…æ ¼å¼äº COM_QUERY ç±»ä¼¼ï¼Œè¿”å› OK åŒ…ã€é”™è¯¯åŒ…å’Œç»“æœé›†åŒ…ä¹‹ä¸€ï¼Œå–å†³äºæ‰§è¡Œç»“æœã€‚ä¸è¿™é‡Œçš„é—®é¢˜æ— å…³ï¼Œå°±ä¸èµ˜è¿°äº†ã€‚\nåˆ°è¿™é‡Œï¼Œå·²ç»å¯¹ PreparedStatement åè®®æœ‰äº†ä¸€ä¸ªåŸºæœ¬çš„äº†è§£ï¼Œä¹Ÿå¾—åˆ°äº†ä»¥ä¸‹ä¿¡æ¯ï¼š\nstmt_id æ˜¯ç”±æœåŠ¡ç«¯åœ¨ COM_STMT_PREPARE é˜¶æ®µç”Ÿæˆçš„ï¼Œå¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ å®¢æˆ·ç«¯åœ¨ COM_STMT_EXECUTE é˜¶æ®µä¼šæºå¸¦ stmt_id æ¥æ‰§è¡Œå¯¹åº”çš„ SQL è¯­å¥ã€‚ stmt_id æ˜¯ä¸€ä¸ª int\u0026lt;4\u0026gt;(å››å­—èŠ‚) çš„æ•´æ•°ã€‚ é‚£ä¹ˆè¿™ä¸ªé—®é¢˜çš„æŒ‡å‘æ›´æ¸…æ™°äº†ï¼Œè¿˜æ˜¯è¦å›åˆ° Doris æºç ä¸­ï¼Œç»§ç»­æ·±å…¥åˆ†æ stmt_id çš„ç”Ÿæˆå’Œç®¡ç†ã€‚\nApache Doris æºç åˆ†æ2 # ç»§ç»­æ·±å…¥ Doris æºç ï¼Œé‡ç‚¹å…³æ³¨ statement_id çš„ç”Ÿæˆå’Œç®¡ç†ã€‚\nä» PrepareCommand.java æ–‡ä»¶ä¸­ï¼Œå‘ç°äº†è¿”å›ç»™å®¢æˆ·ç«¯çš„ statement_id æ˜¯é€šè¿‡ ConnectionContext å¯¹è±¡çš„ getStmtId() æ–¹æ³•è·å–ï¼š\n// register prepared statement with attached statement id @Override public void run(ConnectContext ctx, StmtExecutor executor) throws Exception { List\u0026lt;String\u0026gt; labels = getLabels(); // register prepareStmt // ... if (logicalPlan instanceof InsertIntoTableCommand \u0026amp;\u0026amp; ((InsertIntoTableCommand) logicalPlan).getLabelName().isPresent()) { throw new org.apache.doris.common.UserException(\u0026#34;Only support prepare InsertStmt without label now\u0026#34;); } ctx.addPreparedStatementContext(name, new PreparedStatementContext(this, ctx, ctx.getStatementContext(), name)); if (ctx.getCommand() == MysqlCommand.COM_STMT_PREPARE) { // !!!! å…³é”®çº¿ç´¢ !!!! executor.sendStmtPrepareOK((int) ctx.getStmtId(), labels); } } executor.sendStmtPrepareOK((int) ctx.getStmtId(), labels); è¿™ä¸€è¡Œä»£ç ä¸­æœ‰ä¸€ä¸ªå…³é”®çš„çº¿ç´¢å°±æ˜¯ ctx.getStmtId() è¿”å›çš„å€¼è¿›è¡Œäº†ç±»å‹è½¬æ¢ï¼Œè½¬æ¢æˆäº† int ç±»å‹ã€‚è¿™ä¸ç¦è®©äººè”æƒ³åˆ°ä¸€ä¸ªå¯èƒ½æ€§ï¼š\nstmtId è¶…è¿‡äº† int çš„èŒƒå›´ï¼Œä½†æ˜¯ç”±äºè¿™é‡Œçš„ç±»å‹è½¬æ¢ï¼Œå¯¼è‡´äº†å®¢æˆ·ç«¯æ¥æ”¶åˆ°çš„ stmtId å’ŒæœåŠ¡ç«¯å®é™…å­˜å‚¨çš„ä¸ä¸€è‡´ï¼Œè¿›è€Œå¯¼è‡´åœ¨ COM_STMT_EXECUTE é˜¶æ®µï¼ŒDoris FE èŠ‚ç‚¹æ‰¾ä¸åˆ°å¯¹åº”çš„ stmtIdã€‚\nå†æ£€æŸ¥ä¸‹ ConnectionContext ç±»ä¸­çš„ stmtID å±æ€§ï¼š\n// ConnectionContext protected volatile long stmtId; public long getStmtId() { return stmtId; } // ç”± StmtExecutor è°ƒç”¨ public void setStmtId(long stmtId) { this.stmtId = stmtId; } ç»§ç»­è¿½è¸ª stmtId çš„ç”Ÿæˆï¼Œå‘ç°æ˜¯åœ¨ StmtExecutor ç±»ä¸­ï¼š\n// StmtExecutor private static final AtomicLong STMT_ID_GENERATOR = new AtomicLong(0); // åˆå§‹å€¼ä¸º 0 private void executeByNereids(TUniqueId queryId) throws Exception { // ... // stmtId åŸå­è‡ªå¢ context.setStmtId(STMT_ID_GENERATOR.incrementAndGet()); // ... } è‡³æ­¤ï¼Œç­”æ¡ˆä¹Ÿå·²ç»å‘¼ä¹‹æ¬²å‡ºäº†ï¼š stmtId åœ¨å†…å­˜ä¸­ç±»å‹æ˜¯ long (å…«å­—èŠ‚)ï¼Œè€Œè¿”å›ç»™å®¢æˆ·ç«¯çš„æ—¶å€™è¿›è¡Œäº†å¼ºåˆ¶ç±»å‹è½¬æ¢æˆäº† int (å››å­—èŠ‚)ã€‚stmtId ä¸€ç›´è‡ªå¢ï¼Œå½“ stmtId è¶…è¿‡äº†å››å­—èŠ‚çš„å®¹é‡æ—¶ï¼Œå°±ä¼šå‡ºç°å®¢æˆ·ç«¯æ¥æ”¶åˆ°çš„ stmtId å’ŒæœåŠ¡ç«¯å®é™…å­˜å‚¨çš„ä¸ä¸€è‡´ï¼Œè¿›è€Œå¯¼è‡´æ­¤é—®é¢˜ã€‚\nè§£å†³ # æ‰¾åˆ°é—®é¢˜åï¼Œå†å» Doris ä»“åº“åˆ‡æ¢åˆ°æœ€æ–°çš„ä»£ç æ—¶ï¼Œå‘ç°è¿™éƒ¨åˆ†é€»è¾‘å·²ç»è¢«ä¿®æ”¹äº†ï¼Œç›¸å…³çš„ PR åœ¨ï¼šhttps://github.com/apache/doris/pull/47950\né‚£å°±æ›´ç®€å•äº†ï¼Œç›´æ¥å‡çº§ Doris ç‰ˆæœ¬åˆ°æœ€æ–°å³å¯ã€‚\næ–°ç‰ˆæœ¬ä¸­çš„é€»è¾‘æ˜¯ï¼šConnectionContext æ–°å¢äº†ä¸€ä¸ª preparedStmtId å±æ€§ï¼Œç±»å‹æ˜¯ intï¼š\n// range [Integer.MIN_VALUE, Integer.MAX_VALUE] protected int preparedStmtId = Integer.MIN_VALUE; public void incPreparedStmtId() { ++preparedStmtId; } Wireshark æŠ“åŒ… # åœ¨æµ‹è¯•ç¯å¢ƒä¸­å‡çº§ Doris ç‰ˆæœ¬åï¼Œä½¿ç”¨ Wireshark æŠ“åŒ…ï¼ŒéªŒè¯ä¸€ä¸‹ stmtId æ˜¯å¦å¦‚æ–°ç‰ˆæœ¬ä¸­çš„é€»è¾‘å·¥ä½œã€‚\nåœ¨ä»¥å‰çš„ç‰ˆæœ¬ stmtId ä» 0 å¼€å§‹è‡ªå¢ï¼Œè€Œåœ¨æ–°ç‰ˆæœ¬ä¸­ preparedStmtId ä» Integer.MIN_VALUE å¼€å§‹è‡ªå¢ã€‚å› æ­¤åªéœ€è¦å…³æ³¨å‰é¢å‡ ä¸ª COM_STMT_PREPARE åŒ…çš„å“åº”ï¼Œå…¶ä¸­çš„ statement_id æ˜¯ä» 0 å¼€å§‹ï¼Œè¿˜æ˜¯ 2147483648 (å³ Integer.MIN_VALUE æ— ç¬¦å·æ•°) å¼€å§‹ã€‚\nWireshark æŠ“åŒ… - COM_STMT_PREPARE å¾ˆæ˜æ˜¾ï¼Œstatement_id æ˜¯ä» 2147483648 å¼€å§‹çš„ï¼Œè¯´æ˜æ–°ç‰ˆæœ¬ä¸­çš„é€»è¾‘å·²ç»ç”Ÿæ•ˆã€‚\nç­”ç–‘ # ä¸ºä»€ä¹ˆ DQ-1 ä¼šæŠ¥è¿™ä¸ªé”™è¯¯ï¼Œè€Œ DQ-2 ä¸ä¼šæŠ¥è¿™ä¸ªé”™è¯¯ï¼Ÿ\nDQ-2 ä½¿ç”¨çš„å®¢æˆ·ç«¯æ‹¼æ¥ SQL è¯­å¥ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨åˆ° PreparedStatement æœºåˆ¶ã€‚è€Œ DQ-1 (golang) åº•å±‚ mysql é©±åŠ¨ (github.com/go-sql-driver/mysql) ä¼šä¼˜å…ˆå°è¯•å®¢æˆ·ç«¯ prepare (ä½¿ç”¨ query è€Œä¸æ˜¯æœåŠ¡å™¨ prepare), å¦‚æœæ²¡æœ‰å¼€å¯åˆ™ä¼šä½¿ç”¨æœåŠ¡å™¨ prepare, ä½¿ç”¨ interpolateParams æ§åˆ¶å¼€å¯\nä¹Ÿå°±æ˜¯è¯´å¦‚æœæƒ³è¦é¿å…è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥åœ¨ DQ-1 çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­æ·»åŠ  interpolateParams=true å‚æ•°ï¼Œé¿å…ä½¿ç”¨æœåŠ¡å™¨ prepare è§„é¿ statement_id å¢é•¿æº¢å‡ºã€‚\nå¦å¤– gorm ä¹Ÿç”±ä¸€ä¸ª PrepareStmt çš„é…ç½®é€‰é¡¹ï¼Œä¼šç¼“å­˜å·²ç» prepared çš„ sql.Stmt, æ‰ä¼šåˆç†åˆ©ç”¨ä¸ŠæœåŠ¡ç«¯ prepare æœºåˆ¶ï¼ŒåŒæ—¶å‡å°‘å®¢æˆ·ç«¯çš„ prepare æ¬¡æ•°ã€‚\nä¸ºä»€ä¹ˆé‡å¯ DQ-1 å’Œ Doris FE èŠ‚ç‚¹å¯ä»¥è§£å†³é—®é¢˜ï¼Ÿ\nå®é™…ä¸Šæ˜¯é‡å¯ Doris FE èŠ‚ç‚¹è§£å†³äº†é—®é¢˜ï¼Œé‡å¯å stmtId é‡æ–°ä» 0 å¼€å§‹è‡ªå¢ï¼Œæš‚æ—¶é¿å…äº†æº¢å‡ºã€‚\næ˜¯ Doris FE èŠ‚ç‚¹çš„é—®é¢˜ï¼Œè¿˜æ˜¯ DQ-1 çš„é—®é¢˜ï¼Ÿ\næ˜¯ Doris FE ä¸­ PreparedStatement å®ç°å­˜åœ¨ç¼ºé™·ã€‚\næ€»ç»“ # æœ¬æ–‡å¤ç›˜äº†åœ¨ä½¿ç”¨ Apache Doris PreparedStatement æœºåˆ¶æ—¶å‡ºç° â€œNot supported such prepared statementâ€ é”™è¯¯çš„æ’æŸ¥å†ç¨‹ã€‚é€šè¿‡æºç è¿½è¸ªï¼Œå‘ç° Doris FE èŠ‚ç‚¹åœ¨ç®¡ç† stmtId æ—¶å­˜åœ¨ç±»å‹è½¬æ¢é—®é¢˜ï¼Œå¯¼è‡´æº¢å‡ºåå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„ stmtId ä¸ä¸€è‡´ï¼Œæœ€ç»ˆå¼•å‘å¼‚å¸¸ã€‚\nå‡çº§ Doris è‡³æœ€æ–°ç‰ˆæœ¬æˆ–åœ¨å®¢æˆ·ç«¯é…ç½®å‚æ•°é¿å…æœåŠ¡ç«¯ prepareï¼Œå‡å¯æœ‰æ•ˆè§„é¿è¯¥é—®é¢˜ã€‚\nåœ¨æ’æŸ¥è¿‡ç¨‹ï¼Œç³»ç»Ÿæ€§çš„äº†è§£ MySQL çš„ PreparedStatement åè®®ä»¥åŠæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åœ¨ PreparedStatement æœºåˆ¶ä¸­çš„å®ç°ç»†èŠ‚ã€‚\næ€»çš„æ¥è¯´ï¼ŒçŸ¥å…¶ç„¶æ›´è¦çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œç†è§£åº•å±‚åŸç†æ‰èƒ½æ›´å¥½åœ°è§£å†³é—®é¢˜ã€‚\n"},{"id":5,"href":"/2025/09/28/Apache-Kafka-MirrorMaker2%E4%BB%8E%E4%BD%BF%E7%94%A8%E5%88%B0%E8%BF%81%E7%A7%BB/","title":"Kafka MirrorMaker2 ä»ä½¿ç”¨åˆ°è¿ç§»","section":"Posts","content":" æœ¬æ–‡ä¸­ä½¿ç”¨çš„ Kafka ç‰ˆæœ¬ä¸º v3.3.2\nå¼•è¨€ # Kafka MirrorMaker2 æ˜¯ Kafka å®˜æ–¹æä¾›çš„è·¨é›†ç¾¤æ•°æ®å¤åˆ¶å·¥å…·, å®ƒæ˜¯åŸºäº Kafka Connect æ¡†æ¶æ„å»ºçš„ã€‚MirrorMaker2 æ”¯æŒå¤šç§éƒ¨ç½²æ¨¡å¼, åŒ…æ‹¬ Dedicated æ¨¡å¼å’Œ Connect é›†ç¾¤æ¨¡å¼ï¼Œè¿˜æœ‰ standalone æ¨¡å¼ã€‚\nå…¶ä¸­, Dedicated æ¨¡å¼æœ‰ä¸€ä¸ªå¯åŠ¨è„šæœ¬ kafka-mirror-maker.sh, è¯¥è„šæœ¬ä¼šå¯åŠ¨ä¸€ä¸ªç‹¬ç«‹çš„ MirrorMaker2 å®ä¾‹, è€Œä¸éœ€è¦ä¾èµ– Kafka Connect é›†ç¾¤ã€‚Dedicated æ¨¡å¼é€‚åˆå°è§„æ¨¡çš„å¤åˆ¶ä»»åŠ¡, ä½†åœ¨å¤§è§„æ¨¡éƒ¨ç½²ä¸­, å®ƒç¼ºä¹å¯æ‰©å±•æ€§å’Œé«˜å¯ç”¨æ€§ã€‚\nç›¸æ¯”ä¹‹ä¸‹, Connect é›†ç¾¤æ¨¡å¼åˆ™æ˜¯å…ˆæ­å»ºå‡ºä¸€ä¸ª Kafka Connect é›†ç¾¤, å†æäº¤ MirrorMaker2 çš„ MirrorSourceConnector ä»»åŠ¡ã€‚è¿™ç§æ¨¡å¼ä¸‹, å¯ä»¥é€šè¿‡å¢åŠ æˆ–å‡å°‘ Connect å·¥ä½œèŠ‚ç‚¹æ¥åŠ¨æ€è°ƒæ•´å¤åˆ¶ä»»åŠ¡çš„èµ„æº, å…·å¤‡æ›´å¥½çš„å¼¹æ€§å’Œå®¹é”™èƒ½åŠ›ã€‚\nå½“ç„¶é…ç½®ä¸Šä¹Ÿä¼šæ›´å¤æ‚ä¸€äº›, éœ€è¦ç®¡ç† Connect é›†ç¾¤çš„é…ç½®å’Œä»»åŠ¡ã€‚\né‚£ä¹ˆ, å¦‚æœæˆ‘ä»¬å·²ç»åœ¨ä½¿ç”¨ Dedicated æ¨¡å¼éƒ¨ç½²äº† MirrorMaker2, ä½†ç°åœ¨éœ€è¦åˆ‡æ¢åˆ° Connect é›†ç¾¤æ¨¡å¼, åº”è¯¥å¦‚ä½•æ“ä½œå‘¢? æœ¬æ–‡å°†ä»‹ç»ä» Dedicated æ¨¡å¼è¿ç§»åˆ° Connect é›†ç¾¤æ¨¡å¼æ—¶ï¼Œæ€ä¹ˆå¤„ç†å·²ç»åŒæ­¥çš„ offset è¿›åº¦, ä»¥ç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’Œè¿ç»­æ€§ã€‚\nKafka Connect çš„è®¾è®¡ # Kafka Connect æ˜¯ Apache Kafka ç”Ÿæ€ç³»ç»Ÿä¸­çš„æ¡†æ¶å’Œå·¥å…·é›†ï¼Œæ—¨åœ¨åœ¨ Kafka å’Œå…¶ä»–æ•°æ®ç³»ç»Ÿï¼ˆä¾‹å¦‚æ•°æ®åº“ã€äº‘æœåŠ¡å’Œæ–‡ä»¶ç³»ç»Ÿï¼‰ä¹‹é—´å¯é ä¸”å¯æ‰©å±•åœ°ä¼ è¾“æ•°æ®ã€‚ä¸»è¦ç‰¹æ€§åŒ…æ‹¬åˆ†å¸ƒå¼æ¶æ„ã€åŸºäºé…ç½®çš„æ“ä½œä»¥åŠå¯¹æ•°æ®è½¬æ¢å’Œå„ç§åºåˆ—åŒ–æ ¼å¼çš„æ”¯æŒï¼Œä½¿æ•°æ®é›†æˆæ›´ç®€å•ã€æ›´è§£è€¦ã€‚\nKafka Connect æ¶æ„ åœ¨æ•´ä¸ªæ¡†æ¶ä¸­æœ‰ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š\nWorkers: è´Ÿè´£å®é™…æ‰§è¡Œä»»åŠ¡æ‰§è¡Œ, æ¯ä¸ª Worker éƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ± , ç”¨äºæ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚\nConnectors: è¿æ¥å…¶ä»–ç³»ç»Ÿå’Œ kafka çš„ç»„ä»¶ï¼Œä¹Ÿæ˜¯æ•´ä¸ª Kafka Connect æ¡†æ¶ä¸­æœ€é‡è¦çš„æ‰©å±•ç‚¹ã€‚\nSource Connector: ä»å…¶ä»–ç³»ç»Ÿï¼ˆMySQL, Mongoï¼‰å¯¼å…¥æ•°æ®åˆ° Kafkaã€‚ Sink Connector: å°† Kafka ä¸­çš„æ•°æ®å¯¼å‡ºåˆ°å…¶ä»–ç³»ç»Ÿã€‚ Connector è‡ªèº«ä¸æ‰§è¡Œæ•°æ®å¤åˆ¶ï¼Œè€Œæ˜¯è´Ÿè´£å°†æ•´ä¸ªå¤åˆ¶ä»»åŠ¡æ‹†åˆ†æˆä¸€ç»„å¯ä»¥æ‰§è¡Œçš„ Task äº¤ç»™ Kafka Connect Worker æ‰§è¡Œã€‚å› æ­¤è¦å®ç°ä¸€ä¸ª Connector ä¹Ÿéœ€è¦ç¡®å®šè¦ä½¿ç”¨çš„ Task ç±»ï¼‰ã€‚\nTasks: åˆ™è´Ÿè´£å®é™…æ‰§è¡Œä»»åŠ¡æ‰§è¡Œã€‚\nSource Task: ä»æºç³»ç»Ÿè¯»å–æ•°æ®, å¹¶å°†å…¶å†™å…¥ Kafkaã€‚ Sink Task: ä» Kafka è¯»å–æ•°æ®, å¹¶å°†å…¶å†™å…¥ç›®æ ‡ç³»ç»Ÿã€‚ é™¤äº†ä¸Šè¿°æ ¸å¿ƒç»„ä»¶å¤–, Kafka Connect è¿˜åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªé‡è¦æ¦‚å¿µ:\nConverters: Kafka Connect è¦å’Œå¤–éƒ¨ç³»ç»Ÿäº¤äº’ï¼Œä¸å¯é¿å…çš„éœ€è¦å¯¹æ•°æ®è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚Converters è´Ÿè´£å°†æ•°æ®ä»ä¸€ç§æ ¼å¼è½¬æ¢ä¸ºå¦ä¸€ç§æ ¼å¼ã€‚ Transformers: ç”¨äºåœ¨æ•°æ®å¤åˆ¶è¿‡ç¨‹ä¸­å¯¹æ•°æ®è¿›è¡Œè½¬æ¢å’Œå¤„ç†, æ¯”å¦‚å­—æ®µé‡å‘½åï¼Œå¢åŠ /åˆ é™¤å­—æ®µç­‰ç­‰ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è¿›è¡Œè‡ªå®šä¹‰ã€‚ Kafka Connect æ¨¡å‹ Kafka Connect ä¼šåœ¨ Connector å®ä¾‹è¿è¡Œæ—¶, è·Ÿè¸ªå…¶åç§»é‡ï¼Œä»¥ä¾¿è¿æ¥å™¨åœ¨å‘ç”Ÿæ•…éšœæˆ–è€…ç»´æŠ¤æ—¶ï¼Œå¯ä»¥ä»å…ˆå‰çš„ä½ç½®æ¢å¤ã€‚å‚è€ƒ Kafka Connect æ–‡æ¡£ã€‚\nåœ¨å¯¹ Kafka Connect æ¡†æ¶æœ‰äº†ä¸€å®šçš„äº†è§£åï¼Œæˆ‘ä»¬å°±å¯ä»¥å†æ·±å…¥å»ç†è§£ MirrorMaker çš„è®¾è®¡åŸç†äº†ï¼Œä¸€è¨€ä»¥è”½ä¹‹ï¼šä¸€ä¸ªæŠŠæ•°æ®ä»æº Kafka å¤åˆ¶åˆ°ç›®æ ‡ Kafka çš„ MirrorSourceConnectorã€‚\næ€è€ƒé¢˜ï¼šä¸ºä»€ä¹ˆæ˜¯å®ç° SourceConnector è€Œä¸æ˜¯å®ç° SinkConnectorï¼Ÿ\nMirrorSourceConnector çš„è®¾è®¡ # è¿™éƒ¨åˆ†ä¸ä¼šå…³æ³¨ä¸¤ç§éƒ¨ç½²æ¨¡å¼çš„åŒºåˆ«ï¼Œé‡ç‚¹å…³æ³¨ MirrorMaker2 çš„æ ¸å¿ƒç»„ä»¶ MirrorSourceConnectorã€‚è‡³äº MirrorCheckpointConnector æ˜¯ç”¨æ¥åŒæ­¥ groupsï¼Œä¸€ä¸ªæ˜¯ç”¨æ¥æ¢æµ‹ä¸ kafka é›†ç¾¤çš„è”é€šæ€§ï¼ŒæŒ‰éœ€ä½¿ç”¨å³å¯ã€‚\nMirrorMaker2 çš„æ ¸å¿ƒç»„ä»¶æ˜¯ MirrorSourceConnector, å®ƒè´Ÿè´£ä»æºé›†ç¾¤è¯»å–æ•°æ®å¹¶å†™å…¥ç›®æ ‡é›†ç¾¤ã€‚MirrorSourceConnector å®ç°äº† Kafka Connect çš„ SourceConnector ç±», ç”±æ­¤å¯è§å®ƒçš„è°ƒåº¦å’Œä»»åŠ¡ç®¡ç†éƒ½ä¾èµ–äº Kafka Connect æ¡†æ¶ã€‚\nMirrorSourceConnector çš„ä¸»è¦ä½œç”¨å°±æ˜¯æŠŠæºé›†ç¾¤çš„ topic æ•°æ®å¤åˆ¶åˆ°ç›®æ ‡é›†ç¾¤ã€‚å®ƒçš„åŸºæœ¬å·¥ä½œæµç¨‹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªé˜¶æ®µ:\nåˆå§‹åŒ– Taskå®šä¹‰å’Œä»»åŠ¡åˆ†é… åŠ¨æ€è°ƒæ•´/ç»´æŠ¤ 1. åˆå§‹åŒ– # è¿™éƒ¨åˆ†é€»è¾‘é›†ä¸­åœ¨ MirrorSourceConnector çš„ start æ–¹æ³•ä¸­, è¯¥æ–¹æ³•ä¼šè¯»å–é…ç½®å‚æ•°, å¹¶åˆå§‹åŒ–ä¸€äº›å†…éƒ¨çŠ¶æ€, åŒ…æ‹¬:\né…ç½®è§£æï¼š é€šè¿‡ MirrorConnectorConfig è§£æé…ç½®å‚æ•°ï¼ˆå¦‚æº/ç›®æ ‡é›†ç¾¤åˆ«åã€å¤åˆ¶ç­–ç•¥ã€è¿‡æ»¤è§„åˆ™ç­‰ï¼‰ã€‚è‹¥è¿æ¥å™¨æœªå¯ç”¨ï¼ˆconfig.enabled=falseï¼‰ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚\nèµ„æºåˆå§‹åŒ–ï¼š åˆ›å»ºæº/ç›®æ ‡é›†ç¾¤çš„ AdminClientï¼ˆç”¨äºé›†ç¾¤ç®¡ç†æ“ä½œï¼‰ã€Schedulerï¼ˆç”¨äºå®šæ—¶ä»»åŠ¡ï¼‰ï¼Œå¹¶åˆå§‹åŒ– replicationPolicyï¼ˆ topic å‘½åè½¬æ¢ç­–ç•¥ï¼‰ã€topicFilterï¼ˆ topic è¿‡æ»¤è§„åˆ™ï¼‰ç­‰æ ¸å¿ƒç»„ä»¶ã€‚\nåˆå§‹ä»»åŠ¡è°ƒåº¦ï¼š\né€šè¿‡ Scheduler æ‰§è¡Œä¸€æ¬¡æ€§åˆå§‹åŒ–ä»»åŠ¡ï¼š\nåˆ›å»º offset-syncs ä¸»é¢˜ï¼ˆç”¨äºåŒæ­¥æ¶ˆè´¹è€…åç§»é‡ï¼‰ã€‚ åŠ è½½æº/ç›®æ ‡é›†ç¾¤çš„åˆå§‹ topic-partition å…ƒæ•°æ®ã€‚ åœ¨ç›®æ ‡é›†ç¾¤åˆ›å»ºç¼ºå¤±çš„ topic æˆ–åˆ†åŒºã€‚ 2. Taskå®šä¹‰å’Œä»»åŠ¡åˆ†é… # Task æ˜¯å®é™…æ‰§è¡Œæ•°æ®å¤åˆ¶çš„å·¥ä½œå•å…ƒï¼Œè¿™ä¹Ÿæ˜¯ Kafka Connect çš„æ¦‚å¿µã€‚MirrorSourceConnector å¯¹åº”çš„ Task ç±»æ˜¯ MirrorSourceTaskã€‚ å‚è§ä¸‹ä»£ç ç‰‡æ®µï¼š\n@Override public Class\u0026lt;? extends Task\u0026gt; taskClass() { return MirrorSourceTask.class; } // divide topic-partitions among tasks // since each mirrored topic has different traffic and number of partitions, to balance the load // across all mirrormaker instances (workers), \u0026#39;roundrobin\u0026#39; helps to evenly assign all // topic-partition to the tasks, then the tasks are further distributed to workers. // For example, 3 tasks to mirror 3 topics with 8, 2 and 2 partitions respectively. // \u0026#39;t1\u0026#39; denotes \u0026#39;task 1\u0026#39;, \u0026#39;t0p5\u0026#39; denotes \u0026#39;topic 0, partition 5\u0026#39; // t1 -\u0026gt; [t0p0, t0p3, t0p6, t1p1] // t2 -\u0026gt; [t0p1, t0p4, t0p7, t2p0] // t3 -\u0026gt; [t0p2, t0p5, t1p0, t2p1] @Override public List\u0026lt;Map\u0026lt;String, String\u0026gt;\u0026gt; taskConfigs(int maxTasks) { if (!config.enabled() || knownSourceTopicPartitions.isEmpty()) { return Collections.emptyList(); } int numTasks = Math.min(maxTasks, knownSourceTopicPartitions.size()); List\u0026lt;List\u0026lt;TopicPartition\u0026gt;\u0026gt; roundRobinByTask = new ArrayList\u0026lt;\u0026gt;(numTasks); for (int i = 0; i \u0026lt; numTasks; i++) { roundRobinByTask.add(new ArrayList\u0026lt;\u0026gt;()); } int count = 0; for (TopicPartition partition : knownSourceTopicPartitions) { int index = count % numTasks; roundRobinByTask.get(index).add(partition); count++; } return roundRobinByTask.stream().map(config::taskConfigForTopicPartitions) .collect(Collectors.toList()); } ä»ä¸Šä»£ç å¯ä»¥çœ‹åˆ°, MirrorSourceConnector ä¼šæ ¹æ®é…ç½®çš„ maxTasks å‚æ•°, å°†æ‰€æœ‰éœ€è¦å¤åˆ¶çš„ topic-partition åˆ’åˆ†æˆå¤šä¸ªå­é›†, æ¯ä¸ªå­é›†å¯¹åº”ä¸€ä¸ª Task çš„é…ç½®ã€‚åˆ’åˆ†ç­–ç•¥é‡‡ç”¨ round-robin æ–¹å¼, ä»¥å°½é‡å‡è¡¡æ¯ä¸ª Task çš„è´Ÿè½½ã€‚\nä½¿ç”¨æ—¶ï¼Œéœ€è¦æ³¨æ„ task æ•°é‡çš„è®¾ç½®, åˆç†çš„æ ¹æ®ä»»åŠ¡æ¥è®¾ç½® task æ•°é‡ï¼Œé¿å…è¿‡å¤šæˆ–è¿‡å°‘ã€‚\n3. æŒç»­ç»´æŠ¤ # MirrorSourceConnector Scheduler ä¼šå®šæœŸæ‰§è¡Œç»´æŠ¤ä»»åŠ¡, ä»¥ç¡®ä¿å¤åˆ¶è¿‡ç¨‹çš„ä¸€è‡´æ€§ã€‚ä¸»è¦åŒ…æ‹¬:\nåŒæ­¥ topic çš„ ACL å’Œ é…ç½®ã€‚ åˆ·æ–° topic çš„åˆ†åŒºä¿¡æ¯ï¼Œè‹¥å‘ç°æºé›†ç¾¤æ–°å¢åˆ†åŒºæˆ–ç›®æ ‡é›†ç¾¤ç¼ºå¤±åˆ†åŒºï¼Œä¼šè§¦å‘ computeAndCreateTopicPartitionsï¼Œåœ¨ç›®æ ‡é›†ç¾¤åˆ›å»º topic æˆ–æ‰©å®¹åˆ†åŒºã€‚ MirrorSourceTask çš„è®¾è®¡ # MirrorSourceTask å®ç°äº† SourceTask, å®ƒè´Ÿè´£å®é™…çš„æ•°æ®å¤åˆ¶å·¥ä½œã€‚å…¶ä¸»è¦å·¥ä½œæµç¨‹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªé˜¶æ®µ:\nåˆå§‹åŒ– æ•°æ®æ‹‰å–å’Œå†™å…¥ åç§»é‡ç®¡ç†ï¼ˆè¿™é‡Œç‰¹æŒ‡ topic åŒæ­¥çš„ offset è¿›åº¦ï¼‰ 1. åˆå§‹åŒ– # é…ç½®è§£æï¼š åŠ è½½è¿æ¥å™¨ä»»åŠ¡é…ç½®ï¼ˆå¦‚æºé›†ç¾¤åˆ«åã€åç§»é‡åŒæ­¥ä¸»é¢˜ã€æ¶ˆè´¹è€…è¶…æ—¶æ—¶é—´ç­‰ï¼‰ã€‚\nèµ„æºåˆå§‹åŒ–ï¼š åˆ›å»º Kafka æ¶ˆè´¹è€…ï¼ˆæ‹‰å–æºé›†ç¾¤æ•°æ®ï¼‰ã€Kafka ç”Ÿäº§è€…ï¼ˆå‘é€åç§»é‡åŒæ­¥ä¿¡æ¯ï¼‰ã€ä¿¡å·é‡ï¼ˆæ§åˆ¶æ¶ˆè´¹è€…å¹¶å‘è®¿é—®ï¼‰ç­‰æ ¸å¿ƒèµ„æºã€‚\nåˆ†åŒºä¸åç§»é‡å‡†å¤‡ï¼š\nä» \u0026lt;offset.storage.topic\u0026gt; ä¸»é¢˜åŠ è½½å†å²åç§»é‡ï¼ˆé€šè¿‡ loadOffsets æ–¹æ³•ï¼‰ã€‚ å°†æ¶ˆè´¹è€…åˆ†é…åˆ°æŒ‡å®šåˆ†åŒºï¼Œå¹¶å®šä½åˆ°ä¸Šæ¬¡å¤åˆ¶çš„åç§»é‡ä½ç½®ï¼ˆconsumer.seekï¼‰ã€‚ @Override public void start(Map\u0026lt;String, String\u0026gt; props) { MirrorTaskConfig config = new MirrorTaskConfig(props); // åˆå§‹åŒ–æ¶ˆè´¹è€…ã€ç”Ÿäº§è€… ç­‰èµ„æº consumer = MirrorUtils.newConsumer(config.sourceConsumerConfig()); offsetProducer = MirrorUtils.newProducer(config.offsetSyncsTopicProducerConfig()); // åŠ è½½å†å²åç§»é‡å¹¶å®šä½æ¶ˆè´¹è€… Map\u0026lt;TopicPartition, Long\u0026gt; topicPartitionOffsets = loadOffsets(config.taskTopicPartitions()); consumer.assign(topicPartitionOffsets.keySet()); topicPartitionOffsets.forEach(consumer::seek); } å…¶ä¸­ loadOffsets çš„å®ç°åœ¨ Dedicated æ¨¡å¼å’Œ Connect æ¨¡å¼ä¸‹æ˜¯ä¸åŒçš„:\nåœ¨ Dedicated æ¨¡å¼ä¸‹, åç§»é‡å­˜å‚¨åœ¨ mm2-offsets.\u0026lt;source-cluster\u0026gt; ä¸»é¢˜ä¸­, éœ€è¦ä»è¯¥ä¸»é¢˜è¯»å–åç§»é‡ã€‚ åœ¨ Connect æ¨¡å¼ä¸‹, åç§»é‡å­˜å‚¨åœ¨ \u0026lt;offset.storage.topic\u0026gt; ä¸»é¢˜ä¸­, éœ€è¦ä»è¯¥ä¸»é¢˜è¯»å–åç§»é‡ã€‚ ä½†æ— è®ºå“ªç§æ¨¡å¼, è¯»å–åç§»é‡çš„é€»è¾‘éƒ½æ˜¯ç±»ä¼¼çš„ï¼š\nä¾èµ–äº OffsetStorageReader æ¥å£, åŒæ—¶åœ¨ OffsetStorageReader çš„å…·ä½“å®ç° OffsetStorageReaderImpl ä¸­åˆä¾èµ–äº OffsetBackingStore æ¥å…·ä½“å†³å®šåç§»é‡çš„å­˜å‚¨ä»‹è´¨ï¼ˆå¦‚ Kafka ä¸»é¢˜ ã€æ–‡ä»¶ ç­‰ï¼Œå†…å­˜ç­‰ï¼‰ã€‚\nMirrorMaker2 ä½¿ç”¨çš„æ˜¯ KafkaOffsetBackingStore æ¥å­˜å‚¨åç§»é‡, é¡¾åæ€ä¹‰, å®ƒæ˜¯åŸºäº Kafka ä¸»é¢˜çš„å­˜å‚¨æ–¹å¼, ä¹Ÿå°±æ˜¯ mm2-offsets.\u0026lt;source-cluster\u0026gt;.internal æˆ– \u0026lt;offset.storage.topic\u0026gt; ä¸»é¢˜ã€‚\noffset ä¸»é¢˜ä¸­çš„æ¶ˆæ¯æ ¼å¼å¦‚ä¸‹ï¼ŒKey å’Œ Value éƒ½æ˜¯åºåˆ—åŒ–åçš„å­—èŠ‚æ•°ç»„ï¼š\n[\u0026#34;\u0026lt;connector-name\u0026gt;\u0026#34;,{\u0026#34;cluster\u0026#34;:\u0026#34;\u0026lt;source-cluster-alias\u0026gt;\u0026#34;,\u0026#34;partition\u0026#34;:\u0026lt;partition\u0026gt;,\u0026#34;topic\u0026#34;:\u0026#34;\u0026lt;topic-name\u0026gt;\u0026#34;}] // Key {\u0026#34;offset\u0026#34;: \u0026lt;offset\u0026gt;} // Value åœ¨ Dedicated æ¨¡å¼ä¸‹, \u0026lt;connector-name\u0026gt; é€šå¸¸æ˜¯ MirrorSourceConnectorï¼Œè€Œåœ¨ Connect æ¨¡å¼ä¸‹, \u0026lt;connector-name\u0026gt; åˆ™æ˜¯ç”¨æˆ·åˆ›å»ºçš„ Connector åç§°ã€‚\nâ€¼ï¸ æ‰€ä»¥æˆ‘ä»¬ä¹Ÿå°±çŸ¥é“äº†ï¼ŒMirrorMaker2 åœ¨å¯åŠ¨æ—¶ï¼Œä¼šå°è¯• æ¢å¤ ä¹‹å‰çš„å¤åˆ¶è¿›åº¦ï¼ˆåç§»é‡ï¼‰ï¼Œä»¥ç¡®ä¿æ•°æ®å¤åˆ¶çš„è¿ç»­æ€§å’Œä¸€è‡´æ€§ã€‚åªæ˜¯ä¸¤ç§æ¨¡å¼ä¸‹ï¼Œåç§»é‡çš„å­˜å‚¨ä½ç½®ä¸åŒè€Œå·²ã€‚\n2. æ•°æ®æ‹‰å–å’Œå†™å…¥ # MirrorSourceTask çš„æ‹‰å–é€»è¾‘ç”± poll æ–¹æ³•å®ç°, å®ƒç”± Kafka Connect æ¡†æ¶æ§åˆ¶è°ƒç”¨ã€‚poll æ–¹æ³•çš„ä¸»è¦èŒè´£æ˜¯ä»æºé›†ç¾¤æ‹‰å–æ•°æ®, å¹¶å°†å…¶è½¬æ¢ä¸º Connect æ¡†æ¶çš„ SourceRecord ä»¥ä¾›åç»­å¤„ç†ã€‚\n@Override public List\u0026lt;SourceRecord\u0026gt; poll() { // ... try { ConsumerRecords\u0026lt;byte[], byte[]\u0026gt; records = consumer.poll(pollTimeout); List\u0026lt;SourceRecord\u0026gt; sourceRecords = new ArrayList\u0026lt;\u0026gt;(records.count()); for (ConsumerRecord\u0026lt;byte[], byte[]\u0026gt; record : records) { SourceRecord converted = convertRecord(record); sourceRecords.add(converted); TopicPartition topicPartition = new TopicPartition(converted.topic(), converted.kafkaPartition()); } // çœç•¥éƒ¨åˆ†ä»£ç  return sourceRecords; } catch (WakeupException e) { // Ignore exception handling } } SourceRecord convertRecord(ConsumerRecord\u0026lt;byte[], byte[]\u0026gt; record) { String targetTopic = formatRemoteTopic(record.topic()); // å¤„ç†ä¸º \u0026lt;source-cluster-alias\u0026gt;.\u0026lt;topic\u0026gt; Headers headers = convertHeaders(record); return new SourceRecord( MirrorUtils.wrapPartition(new TopicPartition(record.topic(), record.partition()), sourceClusterAlias), MirrorUtils.wrapOffset(record.offset()), targetTopic, record.partition(), Schema.OPTIONAL_BYTES_SCHEMA, record.key(), Schema.BYTES_SCHEMA, record.value(), record.timestamp(), headers); } 3. åç§»é‡ç®¡ç† # Kafka Connect æ¡†æ¶ä¼šè‡ªåŠ¨ç®¡ç†åç§»é‡çš„æäº¤, å› æ­¤ MirrorSourceTask ä¸éœ€è¦æ˜¾å¼åœ°æäº¤åç§»é‡ã€‚æ¡†æ¶ä¼šå®šæœŸå°†åç§»é‡å†™å…¥ \u0026lt;offset.storage.topic\u0026gt; ä¸»é¢˜, ä»¥ç¡®ä¿åœ¨ä»»åŠ¡é‡å¯æ—¶èƒ½å¤Ÿæ¢å¤åˆ°æ­£ç¡®çš„ä½ç½®ã€‚\nåœ¨ poll æ–¹æ³•ä¸­å·²ç»åœ¨ SourceRecord ä¸­å°è£…äº†åç§»é‡ä¿¡æ¯, æ¡†æ¶ä¼šæ ¹æ®è¿™äº›ä¿¡æ¯æ¥æ›´æ–°åç§»é‡ã€‚\nKafkaOffsetBackingStore çš„è®¾è®¡ # å‰é¢æåˆ°äº† MirrorSourceTask ä½¿ç”¨äº† KafkaOffsetBackingStore æ¥ç®¡ç† topic åŒæ­¥çš„ offset è¿›åº¦ï¼Œé‚£ä¹ˆå®ƒå…·ä½“æ˜¯æ€ä¹ˆè¿›è¡Œç®¡ç†çš„ï¼Ÿ å¦‚æœåªè¿›ä¸å‡ºï¼Œtopic éšç€æ—¶é—´çš„æ¨ç§»é‡Œé¢çš„æ¶ˆæ¯ä¼šè¶Šæ¥è¶Šå¤šï¼Œå®ƒæ€ä¹ˆä»è¿™ä¹ˆå¤šæ•°æ®ä¸­è·å–åˆ°æ­£ç¡®çš„åç§»é‡å€¼ï¼ŸæŠ•é€’è¿›å»çš„æ¶ˆæ¯éš¾é“å°±ä¸€ç›´ä¿å­˜ç€å—ï¼Ÿ\nåœ¨ KafkaOffsetBackingStore å…³äºè¿™äº› topic çš„åˆ›å»ºå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°æŒ‡å®šäº† topic ä¸º compactedï¼š\nprotected NewTopic newTopicDescription(final String topic, final WorkerConfig config) { Map\u0026lt;String, Object\u0026gt; topicSettings = config instanceof DistributedConfig ? ((DistributedConfig) config).offsetStorageTopicSettings() : Collections.emptyMap(); return TopicAdmin.defineTopic(topic) .config(topicSettings) // first so that we override user-supplied settings as needed .compacted() .partitions(config.getInt(DistributedConfig.OFFSET_STORAGE_PARTITIONS_CONFIG)) .replicationFactor(config.getShort(DistributedConfig.OFFSET_STORAGE_REPLICATION_FACTOR_CONFIG)) .build(); } è€Œ compacted å®é™…å¯¹åº”äº† topic çš„ cleanup.policy = compactã€‚\npublic NewTopicBuilder compacted() { this.configs.put(CLEANUP_POLICY_CONFIG, CLEANUP_POLICY_COMPACT); return this; } KafkaOffsetBackingStore å®ç°äº† OffsetBackingStoreï¼Œå®ƒå®é™…åˆä¾èµ–äº† KafkaBasedLog, å®ƒæ˜ç¡®çš„æ³¨é‡Šäº†ï¼š\nKafkaBasedLog provides a generic implementation of a shared, compacted log of records stored in Kafka that all clients need to consume and, at times, agree on their offset / that they have read to the end of the log.\nå…¶å†…éƒ¨åˆ›å»ºäº†ä¸€ä¸ªä» earliest ä½ç‚¹å¼€å§‹æ¶ˆè´¹çš„ consumerï¼Œç”¨æ¥è¯»å–å·²å­˜å‚¨çš„åç§»é‡ä¿¡æ¯ã€‚\nprotected Consumer\u0026lt;K, V\u0026gt; createConsumer() { // Always force reset to the beginning of the log since this class wants to consume all available log data consumerConfigs.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, \u0026#34;earliest\u0026#34;); // Turn off autocommit since we always want to consume the full log consumerConfigs.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, false); return new KafkaConsumer\u0026lt;\u0026gt;(consumerConfigs); } /** * This method finds the end offsets of the Kafka log\u0026#39;s topic partitions, optionally retrying * if the {@code listOffsets()} method of the admin client throws a {@link RetriableException}. */ private void readToLogEnd(boolean shouldRetry) { Set\u0026lt;TopicPartition\u0026gt; assignment = consumer.assignment(); Map\u0026lt;TopicPartition, Long\u0026gt; endOffsets = readEndOffsets(assignment, shouldRetry); log.trace(\u0026#34;Reading to end of log offsets {}\u0026#34;, endOffsets); while (!endOffsets.isEmpty()) { Iterator\u0026lt;Map.Entry\u0026lt;TopicPartition, Long\u0026gt;\u0026gt; it = endOffsets.entrySet().iterator(); while (it.hasNext()) { Map.Entry\u0026lt;TopicPartition, Long\u0026gt; entry = it.next(); TopicPartition topicPartition = entry.getKey(); long endOffset = entry.getValue(); long lastConsumedOffset = consumer.position(topicPartition); if (lastConsumedOffset \u0026gt;= endOffset) { log.trace(\u0026#34;Read to end offset {} for {}\u0026#34;, endOffset, topicPartition); it.remove(); } else { log.trace(\u0026#34;Behind end offset {} for {}; last-read offset is {}\u0026#34;, endOffset, topicPartition, lastConsumedOffset); poll(Integer.MAX_VALUE); break; } } } } ç®€å•æ€»ç»“ä¸€ä¸‹ï¼ŒåŸºäº kafka çš„ offset å­˜å‚¨ï¼Œåˆ©ç”¨äº† kafka compact æœºåˆ¶æ¥ä¿å­˜ offset è¿›åº¦ä¿¡æ¯ï¼Œè¿™æ ·å¯ä»¥é¿å…æ¶ˆæ¯é‡æ— é™åˆ¶å¢é•¿ã€‚åœ¨éœ€è¦ä» kafka ä¸­æ¢å¤æ•°æ®æ—¶ï¼Œåˆ™ä»å¤´å¼€å§‹æ¶ˆè´¹æ•´ä¸ª topic ä¸­çš„æ¶ˆæ¯ï¼Œä¿å­˜æœ€æ–°çš„åç§»é‡ä¿¡æ¯ã€‚\nè¿ç§» # ç»è¿‡å‰é¢çš„ä»‹ç»ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº† MirrorMaker2 çš„å·¥ä½œåŸç†å’Œåç§»é‡ç®¡ç†æœºåˆ¶ã€‚é‚£ä¹ˆ, å¦‚æœæˆ‘ä»¬å·²ç»åœ¨ä½¿ç”¨ Dedicated æ¨¡å¼éƒ¨ç½²äº† MirrorMaker2, ç°åœ¨æƒ³è¦åˆ‡æ¢åˆ° Connect é›†ç¾¤æ¨¡å¼, åº”è¯¥å¦‚ä½•æ“ä½œå‘¢?\nè¿™é‡Œè€ƒè™‘ä¸¤ä¸ªé—®é¢˜ï¼š\nKafka Connect é›†ç¾¤åº”è¯¥å¦‚ä½•æ­å»ºï¼Ÿ æ€ä¹ˆè¿ç§»æ‰èƒ½ä¿è¯æ•°æ®çš„ä¸€è‡´ï¼Œä¸ä¼šé‡å¤æˆ–ä¸¢å¤±ï¼Ÿ æ­å»º Kafka Connect é›†ç¾¤ # Kafka Connect é›†ç¾¤çš„æ­å»ºå¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£æˆ–å…¶ä»–ç›¸å…³èµ„æ–™, è¿™é‡Œä¸åšè¿‡å¤šèµ˜è¿°ã€‚\nhttps://docs.confluent.io/platform/current/connect/userguide.html\nå¦‚ä½•è¿ç§»è¿›åº¦ # MirrorMaker2 åœ¨ Dedicated æ¨¡å¼ä¸‹è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œä¼šåœ¨ TARGET Kafka é›†ç¾¤ mm2-offsets.\u0026lt;source-cluster\u0026gt;.internal ä¸»é¢˜ä¸­å­˜å‚¨åç§»é‡ä¿¡æ¯ã€‚è€Œåœ¨ Connect æ¨¡å¼ä¸‹, åç§»é‡ä¿¡æ¯åˆ™å­˜å‚¨åœ¨ \u0026lt;offset.storage.topic\u0026gt; ä¸»é¢˜ä¸­ã€‚å¦‚æœæˆ‘ä»¬ä¸åšä»»ä½•å¤„ç†ï¼Œé‚£ä¹ˆåœ¨åˆ‡æ¢åˆ° Connect æ¨¡å¼å, ä»»åŠ¡ä¼šä» \u0026lt;offset.storage.topic\u0026gt; ä¸»é¢˜ä¸­è¯»å–åç§»é‡, ç”±äºè¯¥ä¸»é¢˜ä¸­æ²¡æœ‰ä»»ä½•æ•°æ®, ä»»åŠ¡ä¼šä»å¤´å¼€å§‹å¤åˆ¶æ•°æ®, è¿™ä¼šå¯¼è‡´å¤§é‡çš„é‡å¤æ•°æ®ã€‚\nå¦‚æœä¸šåŠ¡èƒ½å¤Ÿå®¹å¿é‡å¤æ•°æ®, é‚£ä¹ˆå¯ä»¥ç›´æ¥åˆ‡æ¢, ä½†å¤§å¤šæ•°åœºæ™¯ä¸‹, æˆ‘ä»¬å¸Œæœ›æ•°æ®å¤åˆ¶æ˜¯è¿ç»­ä¸”ä¸€è‡´çš„ã€‚\né‚£ä¹ˆå°±éœ€è¦æˆ‘ä»¬æŠŠ mm2-offsets.\u0026lt;source-cluster\u0026gt;.internal ä¸»é¢˜ä¸­çš„åç§»é‡æ•°æ®, è¿ç§»åˆ° \u0026lt;offset.storage.topic\u0026gt; ä¸»é¢˜ä¸­, é‚£ä¹ˆåœ¨åˆ‡æ¢åˆ° Connect æ¨¡å¼å, ä»»åŠ¡å°±èƒ½ä»æ­£ç¡®çš„ä½ç½®ç»§ç»­å¤åˆ¶æ•°æ®, é¿å…é‡å¤æˆ–ä¸¢å¤±ã€‚\nè¿™ä¸ªè½¬æ¢è¿‡ç¨‹ä¹Ÿå¾ˆç®€å•, åªéœ€è¦ç¼–å†™ä¸€ä¸ªè„šæœ¬, ä» mm2-offsets.\u0026lt;source-cluster\u0026gt;.internal ä¸»é¢˜ä¸­è¯»å–åç§»é‡æ•°æ®, ç„¶åæŒ‰ç…§ \u0026lt;offset.storage.topic\u0026gt; ä¸»é¢˜çš„æ ¼å¼å†™å…¥å³å¯ã€‚\næ¨èå°† offsets æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶æˆ–è€…å…¶ä»–å­˜å‚¨ä»‹è´¨ä¸­, æ–¹ä¾¿äººå·¥éªŒè¯æˆ–è€…è°ƒæ•´ã€‚\nä¸¾ä¾‹æ¥è¯´ï¼š\nå‡å¦‚ mm2-offsets.source.internal ä¸»é¢˜ä¸­æœ‰å¦‚ä¸‹æ¶ˆæ¯ï¼š\nKey: [\u0026#34;MirrorSourceConnector\u0026#34;,{\u0026#34;cluster\u0026#34;:\u0026#34;source\u0026#34;,\u0026#34;partition\u0026#34;:0,\u0026#34;topic\u0026#34;:\u0026#34;test-topic\u0026#34;}] Value: {\u0026#34;offset\u0026#34;: 12345} é‚£ä¹ˆæˆ‘ä»¬éœ€è¦æŠŠå®ƒè½¬æ¢ä¸º \u0026lt;offset.storage.topic\u0026gt; ä¸»é¢˜ä¸­çš„æ¶ˆæ¯ï¼š\nKey: [\u0026#34;mm2-source-connector\u0026#34;,{\u0026#34;cluster\u0026#34;:\u0026#34;source\u0026#34;,\u0026#34;partition\u0026#34;:0,\u0026#34;topic\u0026#34;:\u0026#34;test-topic\u0026#34;}] Value: {\u0026#34;offset\u0026#34;: 12345} ä¸¤è€…å”¯ä¸€çš„åŒºåˆ«åœ¨äº Key ä¸­çš„ connector åç§°ï¼Œå¦‚æœ source.cluster.alias(cluster) ä¸åŒ, ä¹Ÿéœ€è¦åšç›¸åº”çš„è°ƒæ•´ã€‚\nè„šæœ¬ä¸¾ä¾‹å¦‚ä¸‹:\noffset è¿ç§»ç¤ºä¾‹ def extract_dedicated_offsets(brokers, dedicated_offset_topic, output_file): \u0026#34;\u0026#34;\u0026#34;ä»ä¸“ç”¨æ¨¡å¼çš„ offset topic ä¸­æå– offset ä¿¡æ¯å¹¶ä¿å­˜åˆ°æ–‡ä»¶\u0026#34;\u0026#34;\u0026#34; print(f\u0026#34;ä» {dedicated_offset_topic} æå– offsets, åˆ›å»º consumer è¿æ¥åˆ° {brokers}\u0026#34;) consumer = KafkaConsumer( dedicated_offset_topic, bootstrap_servers=brokers, auto_offset_reset=\u0026#39;earliest\u0026#39;, enable_auto_commit=False, consumer_timeout_ms=10000, # 10ç§’å†…æ²¡æœ‰æ–°æ¶ˆæ¯å°±é€€å‡º key_deserializer=lambda x: json.loads(x.decode(\u0026#39;utf-8\u0026#39;)) if x else None, value_deserializer=lambda x: json.loads(x.decode(\u0026#39;utf-8\u0026#39;)) if x else None ) print(\u0026#34;å¼€å§‹æ¶ˆè´¹æ¶ˆæ¯...\u0026#34;) # åªä¿ç•™æ¯ä¸ª topic-partition çš„æœ€æ–° offset offsets = {} for message in consumer: if message.key and message.value: if message.key[0] != \u0026#34;MirrorSourceConnector\u0026#34;: # åªå¤„ç† MirrorSourceConnector çš„æ¶ˆæ¯ continue # ä¸“ç”¨æ¨¡å¼æ ¼å¼: Key[1] = {\u0026#34;cluster\u0026#34;: \u0026#34;...\u0026#34;, \u0026#34;partition\u0026#34;: ..., \u0026#34;topic\u0026#34;: \u0026#34;...\u0026#34;} partition_info = message.key[1] cluster = partition_info[\u0026#34;cluster\u0026#34;] topic = partition_info[\u0026#34;topic\u0026#34;] partition = partition_info[\u0026#34;partition\u0026#34;] offset = message.value[\u0026#34;offset\u0026#34;] # è¿‡æ»¤æ‰å†…éƒ¨ topic (heartbeats, checkpoints ç­‰) if topic.endswith(\u0026#39;heartbeats\u0026#39;) or \u0026#39;checkpoints\u0026#39; in topic or \u0026#39;internal\u0026#39; in topic: print(f\u0026#34;è·³è¿‡å†…éƒ¨ topic: {topic}\u0026#34;) continue # ä½¿ç”¨ topic-partition ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼Œä¿ç•™æœ€æ–°çš„ offset key = f\u0026#34;{cluster}-{topic}-{partition}\u0026#34; offsets[key] = { \u0026#34;cluster\u0026#34;: cluster, \u0026#34;topic\u0026#34;: topic, \u0026#34;partition\u0026#34;: partition, \u0026#34;offset\u0026#34;: offset } print(f\u0026#34;æå– offset: {key} -\u0026gt; {offset}\u0026#34;) else: print(f\u0026#34;è·³è¿‡å…¶ä»–æ¶ˆæ¯: {message.key[0] if message.key else \u0026#39;None\u0026#39;}\u0026#34;) consumer.close() # ä¿å­˜åˆ°æ–‡ä»¶ with open(output_file, \u0026#39;w\u0026#39;) as f: json.dump(offsets, f, indent=2) print(f\u0026#34;æå–äº† {len(offsets)} ä¸ª offset è®°å½•åˆ° {output_file}\u0026#34;) def publish_connect_offsets(brokers, connect_offset_topic, connector_name, input_file): \u0026#34;\u0026#34;\u0026#34;ä»æ–‡ä»¶è¯»å– offset ä¿¡æ¯ï¼Œè½¬æ¢ä¸º Connect æ ¼å¼å¹¶å‘å¸ƒåˆ° Connect offset topic\u0026#34;\u0026#34;\u0026#34; # ä»æ–‡ä»¶è¯»å– offset ä¿¡æ¯ with open(input_file, \u0026#39;r\u0026#39;) as f: offsets = json.load(f) producer = KafkaProducer( bootstrap_servers=brokers, key_serializer=lambda x: json.dumps(x, separators=(\u0026#39;,\u0026#39;, \u0026#39;:\u0026#39;)).encode(\u0026#39;utf-8\u0026#39;), value_serializer=lambda x: json.dumps(x, separators=(\u0026#39;,\u0026#39;, \u0026#39;:\u0026#39;)).encode(\u0026#39;utf-8\u0026#39;) ) success_count = 0 for offset_data in offsets.values(): # è½¬æ¢ä¸º Connect æ ¼å¼ connect_key = [ connector_name, { \u0026#34;cluster\u0026#34;: offset_data[\u0026#34;cluster\u0026#34;], \u0026#34;partition\u0026#34;: offset_data[\u0026#34;partition\u0026#34;], \u0026#34;topic\u0026#34;: offset_data[\u0026#34;topic\u0026#34;] } ] connect_value = { \u0026#34;offset\u0026#34;: offset_data[\u0026#34;offset\u0026#34;] } try: # print(f\u0026#34;å‘å¸ƒ offset: {connect_key} -\u0026gt; {connect_value} åˆ° {connect_offset_topic}\u0026#34;) future = producer.send(connect_offset_topic, key=connect_key, value=connect_value) future.get(timeout=10) success_count += 1 except KafkaError as e: print(f\u0026#34;å‘é€ offset å¤±è´¥: {e}\u0026#34;, file=sys.stderr) producer.flush() producer.close() print(f\u0026#34;æˆåŠŸå‘å¸ƒäº† {success_count}/{len(offsets)} ä¸ª offset è®°å½•\u0026#34;) æ“ä½œæ­¥éª¤ # å‡†å¤‡å¥½ Kafka Connect é›†ç¾¤ç¯å¢ƒï¼ˆéœ€è¦æ­å»ºåœ¨ Target é›†ç¾¤ä¸­ï¼‰ é€‰æ‹©åˆé€‚çš„æ—¶æœºåœæ­¢ dedicated æ¨¡å¼çš„ MirrorMaker2 æœåŠ¡ è¿è¡Œ extract_dedicated_offsets æå–å‡º offset (ä» mm2-offsets.\u0026lt;source-cluster-alias\u0026gt;.internal ä¸­æå–) è¿è¡Œ publish_connect_offsets å†™å…¥ offset (å†™å…¥ \u0026lt;offset.storage.topic\u0026gt;) åœ¨ Kafka Connect ä¸­åˆ›å»º Connector ä»»åŠ¡ curl -X POST -H \u0026#34;Content-Type: application/json\u0026#34; --data @mm2-connector.json http://localhost:8083/connectors connector é…ç½®æ–‡ä»¶ç®€å•ç¤ºä¾‹ æ›´å¤šé…ç½®è¯·å‚è€ƒ MirrorSourceConnector é…ç½®\n{ \u0026#34;name\u0026#34;: \u0026#34;mm2-source-connector\u0026#34;, // è¿æ¥åç§°, å¯ä»¥è‡ªå®šä¹‰ \u0026#34;config\u0026#34;: { \u0026#34;connector.class\u0026#34;: \u0026#34;org.apache.kafka.connect.mirror.MirrorSourceConnector\u0026#34;, // è¿æ¥ç±», å›ºå®šå€¼ \u0026#34;source.cluster.alias\u0026#34;: \u0026#34;source\u0026#34;, // æºé›†ç¾¤åˆ«å, å¯ä»¥è‡ªå®šä¹‰ï¼Œè¿ç§»æ—¶å†™å…¥ \u0026lt;offset.storage.topic\u0026gt; çš„å€¼ \u0026#34;target.cluster.alias\u0026#34;: \u0026#34;target\u0026#34;, // ç›®æ ‡é›†ç¾¤åˆ«å, å¯ä»¥è‡ªå®šä¹‰ \u0026#34;source.cluster.bootstrap.servers\u0026#34;: \u0026#34;kafka-source:9092\u0026#34;, // æºé›†ç¾¤ bootstrap.servers, è¿ç§»æ—¶éœ€è¦æŒ‡å‘æºé›†ç¾¤ \u0026#34;target.cluster.bootstrap.servers\u0026#34;: \u0026#34;kafka-target:9092\u0026#34;, // ç›®æ ‡é›†ç¾¤ bootstrap.servers, è¿ç§»æ—¶éœ€è¦æŒ‡å‘ç›®æ ‡é›†ç¾¤ \u0026#34;topics\u0026#34;: \u0026#34;test-topic,test-topic-second\u0026#34;, // è¦è¿ç§»çš„ topic åˆ—è¡¨, å¯ä»¥è‡ªå®šä¹‰ \u0026#34;tasks.max\u0026#34;: 2 // ä»»åŠ¡æ•°é‡, å¯ä»¥æ ¹æ®é›†ç¾¤èµ„æºè°ƒæ•´ // ... æ›´å¤šé…ç½® } } æ€»ç»“ # æœ¬æ–‡æ·±å…¥æ¢è®¨äº† Apache Kafka MirrorMaker2 çš„è®¾è®¡åŸç†å’Œå®ç°æœºåˆ¶ï¼Œå¹¶è¯¦ç»†ä»‹ç»äº†ä» Dedicated æ¨¡å¼è¿ç§»åˆ° Connect é›†ç¾¤æ¨¡å¼çš„å®Œæ•´æ–¹æ¡ˆã€‚\næ ¸å¿ƒè¦ç‚¹å›é¡¾ # æ¶æ„è®¾è®¡ï¼š\nMirrorMaker2 åŸºäº Kafka Connect æ¡†æ¶æ„å»ºï¼Œé€šè¿‡ MirrorSourceConnector å®ç°è·¨é›†ç¾¤æ•°æ®å¤åˆ¶ æ”¯æŒ Dedicated æ¨¡å¼ï¼ˆç‹¬ç«‹è¿è¡Œï¼‰å’Œ Connect é›†ç¾¤æ¨¡å¼ï¼ˆåˆ†å¸ƒå¼éƒ¨ç½²ï¼‰ä¸¤ç§éƒ¨ç½²æ–¹å¼ é‡‡ç”¨ round-robin ç­–ç•¥å°† topic-partition åˆ†é…ç»™å¤šä¸ª Taskï¼Œå®ç°è´Ÿè½½å‡è¡¡ åç§»é‡ç®¡ç†ï¼š\nä½¿ç”¨ KafkaOffsetBackingStore åŸºäº Kafka topic å­˜å‚¨åç§»é‡ä¿¡æ¯ åˆ©ç”¨ Kafka çš„ compact æœºåˆ¶é¿å…åç§»é‡æ•°æ®æ— é™å¢é•¿ Dedicated æ¨¡å¼å­˜å‚¨åœ¨ mm2-offsets.\u0026lt;source-cluster\u0026gt;.internalï¼ŒConnect æ¨¡å¼å­˜å‚¨åœ¨ \u0026lt;offset.storage.topic\u0026gt; è¿ç§»ç­–ç•¥ï¼š\né€šè¿‡æå–å’Œè½¬æ¢åç§»é‡æ•°æ®ï¼Œç¡®ä¿è¿ç§»è¿‡ç¨‹ä¸­æ•°æ®å¤åˆ¶çš„è¿ç»­æ€§ å…³é”®åœ¨äºæ­£ç¡®è½¬æ¢ connector åç§°å’Œé›†ç¾¤åˆ«åï¼Œä¿æŒåç§»é‡çš„ä¸€è‡´æ€§ è¿ç§»è¿‡ç¨‹éœ€è¦çŸ­æš‚åœæœºï¼Œä½†å¯ä»¥é¿å…æ•°æ®é‡å¤æˆ–ä¸¢å¤± å®è·µå»ºè®® # é€‰æ‹©åˆé€‚çš„éƒ¨ç½²æ¨¡å¼ï¼šå°è§„æ¨¡åœºæ™¯å¯é€‰æ‹© Dedicated æ¨¡å¼ï¼Œå¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ Connect é›†ç¾¤æ¨¡å¼ä»¥è·å¾—æ›´å¥½çš„å¯æ‰©å±•æ€§å’Œé«˜å¯ç”¨æ€§\nåˆç†é…ç½® Task æ•°é‡ï¼šæ ¹æ® topic-partition æ•°é‡å’Œé›†ç¾¤èµ„æºåˆç†è®¾ç½® tasks.maxï¼Œé¿å…èµ„æºæµªè´¹æˆ–æ€§èƒ½ç“¶é¢ˆ\nåšå¥½è¿ç§»è§„åˆ’ï¼šè¿ç§»å‰å……åˆ†æµ‹è¯•åç§»é‡æå–å’Œè½¬æ¢è„šæœ¬ï¼Œé€‰æ‹©ä¸šåŠ¡ä½å³°æœŸè¿›è¡Œè¿ç§»æ“ä½œ\nç›‘æ§å’ŒéªŒè¯ï¼šè¿ç§»åå¯†åˆ‡ç›‘æ§æ•°æ®å¤åˆ¶çŠ¶æ€ï¼ŒéªŒè¯åç§»é‡æ¢å¤çš„æ­£ç¡®æ€§\næ³¨æ„äº‹é¡¹ # æœ¬æ–‡åŸºäº Kafka v3.3.2ï¼Œä¸åŒç‰ˆæœ¬çš„å®ç°ç»†èŠ‚å¯èƒ½æœ‰æ‰€å·®å¼‚ æœªæ¶‰åŠ MirrorCheckpointConnector å’Œ MirrorHeartbeatConnector çš„è¯¦ç»†ä»‹ç»ï¼Œå®é™…ä½¿ç”¨ä¸­éœ€è¦æ ¹æ®åœºæ™¯è€ƒè™‘æ˜¯å¦éœ€è¦å¯ç”¨è¿™äº›ç»„ä»¶ å¯¹äºæ¶ˆè´¹è€…ç»„åç§»é‡åŒæ­¥çš„åœºæ™¯ï¼Œéœ€è¦é¢å¤–çš„è¿ç§»ç­–ç•¥ é€šè¿‡ç†è§£ MirrorMaker2 çš„å†…éƒ¨æœºåˆ¶ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ›´å¥½åœ°è¿ç»´å’Œä¼˜åŒ–è·¨é›†ç¾¤æ•°æ®å¤åˆ¶æ–¹æ¡ˆï¼Œç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’Œç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚\nå‚è€ƒ # Kafka Connect API Kafka Connect Configs Confluent - Kafka Connect Architecture Confluent - Kafka Connect Developer Guide é™„ # Connect é…ç½® # Kafka Connect çš„é…ç½®åˆ†ä¸ºä¸¤ä¸ªå±‚é¢ï¼š\nWorker é…ç½®ï¼šæ§åˆ¶ Connect é›†ç¾¤çš„åŸºç¡€è¡Œä¸º\nbootstrap.servers: Kafka é›†ç¾¤åœ°å€ group.id: Connect é›†ç¾¤çš„å”¯ä¸€æ ‡è¯† config.storage.topic: å­˜å‚¨ Connector é…ç½®çš„å†…éƒ¨ä¸»é¢˜ï¼Œé»˜è®¤å€¼ä¸º connect-configs offset.storage.topic: å­˜å‚¨åç§»é‡ä¿¡æ¯çš„å†…éƒ¨ä¸»é¢˜ï¼Œé»˜è®¤å€¼ä¸º connect-offsets status.storage.topic: å­˜å‚¨ä»»åŠ¡çŠ¶æ€çš„å†…éƒ¨ä¸»é¢˜ï¼Œé»˜è®¤å€¼ä¸º connect-status æ›´å¤šå‚è§ Kafka Connect Configs\nConnector é…ç½®ï¼šå®šä¹‰å…·ä½“çš„æ•°æ®å¤åˆ¶ä»»åŠ¡\nconnector.class: æŒ‡å®šä½¿ç”¨çš„ Connector ç±» tasks.max: æœ€å¤§ä»»åŠ¡æ•°é‡ topics æˆ– topics.regex: æŒ‡å®šè¦å¤„ç†çš„ä¸»é¢˜ å…¶ä»–ç‰¹å®šäº Connector çš„é…ç½®å‚æ•°, è¦å‚è§ç›¸åº”çš„ Connector æºç æˆ–è€…æ–‡æ¡£ã€‚\nMirrorConnector é…ç½® # è¡¨æ ¼æ ¹æ® Kafka@3.3.2/MirrorConnectorConfig.java æ•´ç†è€Œæ¥ã€‚\né…ç½®é¡¹ æè¿° é»˜è®¤å€¼ enabled æ˜¯å¦å¯ç”¨æºé›†ç¾¤åˆ°ç›®æ ‡é›†ç¾¤çš„å¤åˆ¶ true topics è¦å¤åˆ¶çš„ä¸»é¢˜ã€‚æ”¯æŒé€—å·åˆ†éš”çš„ä¸»é¢˜åç§°å’Œæ­£åˆ™è¡¨è¾¾å¼ .* (æ‰€æœ‰ä¸»é¢˜) topics.exclude æ’é™¤çš„ä¸»é¢˜ã€‚æ”¯æŒé€—å·åˆ†éš”çš„ä¸»é¢˜åç§°å’Œæ­£åˆ™è¡¨è¾¾å¼ã€‚æ’é™¤è§„åˆ™ä¼˜å…ˆäºåŒ…å«è§„åˆ™ \u0026quot;\u0026quot; (æ— æ’é™¤ä¸»é¢˜) groups è¦å¤åˆ¶çš„æ¶ˆè´¹è€…ç»„ã€‚æ”¯æŒé€—å·åˆ†éš”çš„ç»„ ID å’Œæ­£åˆ™è¡¨è¾¾å¼ .* (æ‰€æœ‰ç»„) groups.exclude æ’é™¤çš„æ¶ˆè´¹è€…ç»„ã€‚æ”¯æŒé€—å·åˆ†éš”çš„ç»„ ID å’Œæ­£åˆ™è¡¨è¾¾å¼ã€‚æ’é™¤è§„åˆ™ä¼˜å…ˆäºåŒ…å«è§„åˆ™ \u0026quot;\u0026quot; (æ— æ’é™¤ç»„) config.properties.exclude ä¸åº”å¤åˆ¶çš„ä¸»é¢˜é…ç½®å±æ€§ã€‚æ”¯æŒé€—å·åˆ†éš”çš„å±æ€§åç§°å’Œæ­£åˆ™è¡¨è¾¾å¼ \u0026quot;\u0026quot; (æ— æ’é™¤å±æ€§) topic.filter.class ä½¿ç”¨çš„ TopicFilter ç±»ã€‚é€‰æ‹©è¦å¤åˆ¶çš„ä¸»é¢˜ org.apache.kafka.connect.mirror.DefaultTopicFilter group.filter.class ä½¿ç”¨çš„ GroupFilter ç±»ã€‚é€‰æ‹©è¦å¤åˆ¶çš„æ¶ˆè´¹è€…ç»„ org.apache.kafka.connect.mirror.DefaultGroupFilter config.property.filter.class ä½¿ç”¨çš„ ConfigPropertyFilter ç±»ã€‚é€‰æ‹©è¦å¤åˆ¶çš„ä¸»é¢˜é…ç½®å±æ€§ org.apache.kafka.connect.mirror.DefaultConfigPropertyFilter source.cluster.alias æºé›†ç¾¤åˆ«å source target.cluster.alias ç›®æ ‡é›†ç¾¤åˆ«åã€‚ç”¨äºæŒ‡æ ‡æŠ¥å‘Š target consumer.poll.timeout.ms è½®è¯¢æºé›†ç¾¤æ—¶çš„è¶…æ—¶æ—¶é—´ 1000 (1 ç§’) admin.timeout.ms ç®¡ç†ä»»åŠ¡çš„è¶…æ—¶æ—¶é—´ï¼ˆä¾‹å¦‚æ£€æµ‹æ–°ä¸»é¢˜ï¼‰ 60000 (1 åˆ†é’Ÿ) refresh.topics.enabled æ˜¯å¦å®šæœŸæ£€æŸ¥æ–°ä¸»é¢˜å’Œåˆ†åŒº true refresh.topics.interval.seconds ä¸»é¢˜åˆ·æ–°é¢‘ç‡ 600 (10 åˆ†é’Ÿ) refresh.groups.enabled æ˜¯å¦å®šæœŸæ£€æŸ¥æ–°æ¶ˆè´¹è€…ç»„ true refresh.groups.interval.seconds æ¶ˆè´¹è€…ç»„åˆ·æ–°é¢‘ç‡ 600 (10 åˆ†é’Ÿ) sync.topic.configs.enabled æ˜¯å¦å®šæœŸé…ç½®è¿œç¨‹ä¸»é¢˜ä»¥åŒ¹é…å…¶å¯¹åº”çš„ä¸Šæ¸¸ä¸»é¢˜ true sync.topic.configs.interval.seconds ä¸»é¢˜é…ç½®åŒæ­¥é¢‘ç‡ 600 (10 åˆ†é’Ÿ) sync.topic.acls.enabled æ˜¯å¦å®šæœŸé…ç½®è¿œç¨‹ä¸»é¢˜ ACL ä»¥åŒ¹é…å…¶å¯¹åº”çš„ä¸Šæ¸¸ä¸»é¢˜ true sync.topic.acls.interval.seconds ä¸»é¢˜ ACL åŒæ­¥é¢‘ç‡ 600 (10 åˆ†é’Ÿ) emit.heartbeats.enabled æ˜¯å¦å‘ç›®æ ‡é›†ç¾¤å‘é€å¿ƒè·³ true emit.heartbeats.interval.seconds å¿ƒè·³é¢‘ç‡ 1 (1 ç§’) emit.checkpoints.enabled æ˜¯å¦å°†æ¶ˆè´¹è€…åç§»é‡å¤åˆ¶åˆ°ç›®æ ‡é›†ç¾¤ true emit.checkpoints.interval.seconds æ£€æŸ¥ç‚¹é¢‘ç‡ 60 (1 åˆ†é’Ÿ) sync.group.offsets.enabled æ˜¯å¦å°†è½¬æ¢åçš„åç§»é‡åŒæ­¥åˆ°ç›®æ ‡é›†ç¾¤çš„ __consumer_offsetsï¼ˆå¦‚æœæ²¡æœ‰æ´»è·ƒæ¶ˆè´¹è€…ï¼‰ false sync.group.offsets.interval.seconds æ¶ˆè´¹è€…ç»„åç§»é‡åŒæ­¥é¢‘ç‡ 60 (1 åˆ†é’Ÿ) replication.policy.class å®šä¹‰è¿œç¨‹ä¸»é¢˜å‘½åçº¦å®šçš„ç±» org.apache.kafka.connect.mirror.DefaultReplicationPolicy replication.policy.separator è¿œç¨‹ä¸»é¢˜å‘½åçº¦å®šä¸­ä½¿ç”¨çš„åˆ†éš”ç¬¦ . (ç‚¹) replication.factor æ–°åˆ›å»ºçš„è¿œç¨‹ä¸»é¢˜çš„å¤åˆ¶å› å­ 2 heartbeats.topic.replication.factor å¿ƒè·³ä¸»é¢˜çš„å¤åˆ¶å› å­ 3 checkpoints.topic.replication.factor æ£€æŸ¥ç‚¹ä¸»é¢˜çš„å¤åˆ¶å› å­ 3 offset-syncs.topic.replication.factor åç§»é‡åŒæ­¥ä¸»é¢˜çš„å¤åˆ¶å› å­ 3 offset.lag.max è¿œç¨‹åˆ†åŒºåœ¨é‡æ–°åŒæ­¥ä¹‹å‰å¯ä»¥è½åçš„æœ€å¤§åç§»é‡ 100 (åç§»é‡) offset-syncs.topic.location åç§»é‡åŒæ­¥ä¸»é¢˜çš„ä½ç½®ï¼ˆæºé›†ç¾¤/ç›®æ ‡é›†ç¾¤ï¼‰ source metric.reporters ç”¨ä½œæŒ‡æ ‡æŠ¥å‘Šå™¨çš„ç±»åˆ—è¡¨ null (æ— é¢å¤–æŠ¥å‘Šå™¨ï¼Œé»˜è®¤å¯ç”¨ JMX) security.protocol ä¸ broker é€šä¿¡æ—¶ä½¿ç”¨çš„å®‰å…¨åè®® PLAINTEXT é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€äº›é€šç”¨çš„ Kafka é…ç½®ï¼Œé‡‡ç”¨å‰ç¼€åŒ¹é…å†åˆå¹¶çš„æ–¹å¼ï¼Œå¤„ç†å…ˆåé¡ºåºæ˜¯ï¼š\n\u0026lt;source/target\u0026gt;.cluster.* -\u0026gt; consumer.* -\u0026gt; \u0026lt;source/target\u0026gt;.producer.* -\u0026gt; å›ºå®šé…ç½®ï¼Œå‚è§ä¸‹æ–¹ sourceConsumerConfig ä»£ç å¤„ç†é¡ºåºã€‚\né…ç½®ä¼šè¢«å‰ªåˆ‡æ‰å‰ç¼€å†åˆå¹¶åˆ°æœ€ç»ˆçš„ props ä¸­ã€‚å¦‚ï¼šsource.cluster.bootstrap.servers å…¶å®å¯¹åº”çš„æ˜¯ bootstrap.servers é…ç½®ã€‚\nMap\u0026lt;String, Object\u0026gt; sourceConsumerConfig() { Map\u0026lt;String, Object\u0026gt; props = new HashMap\u0026lt;\u0026gt;(); // 1. åŸºç¡€é›†ç¾¤é…ç½®ï¼ˆå¦‚ source.cluster.bootstrap.serversï¼‰ props.putAll(originalsWithPrefix(SOURCE_CLUSTER_PREFIX)); // 2. ä¿ç•™ Kafka å®¢æˆ·ç«¯é…ç½®ï¼ˆè¿‡æ»¤éå®¢æˆ·ç«¯å±æ€§ï¼‰ props.keySet().retainAll(MirrorClientConfig.CLIENT_CONFIG_DEF.names()); // 3. é€šç”¨ consumer. é…ç½®ï¼ˆå¦‚ consumer.fetch.min.bytesï¼‰ props.putAll(originalsWithPrefix(CONSUMER_CLIENT_PREFIX)); // 4. æºé›†ç¾¤ä¸“ç”¨ consumer. é…ç½®ï¼ˆå¦‚ source.consumer.max.poll.recordsï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼‰ props.putAll(originalsWithPrefix(SOURCE_PREFIX + CONSUMER_CLIENT_PREFIX)); // 5. å¼ºåˆ¶è¦†ç›–å…³é”®é…ç½®ï¼ˆå¦‚ç¦ç”¨è‡ªåŠ¨æäº¤ã€é»˜è®¤ earliest åç§»é‡ï¼‰ props.put(ENABLE_AUTO_COMMIT_CONFIG, \u0026#34;false\u0026#34;); props.putIfAbsent(AUTO_OFFSET_RESET_CONFIG, \u0026#34;earliest\u0026#34;); return props; } Key å‰ç¼€ æè¿° ç”Ÿæ•ˆèŒƒå›´ producer.* é€šç”¨ç”Ÿäº§è€…é…ç½®ï¼ˆå¦‚ producer.bootstrap.serversã€producer.acks ç­‰ï¼‰ã€‚ åŒæ—¶ä½œç”¨äºæºé›†ç¾¤å’Œç›®æ ‡é›†ç¾¤çš„ç”Ÿäº§è€…ï¼Œé™¤éè¢« source.producer. æˆ– target.producer. è¦†ç›–ã€‚ consumer.* é€šç”¨æ¶ˆè´¹è€…é…ç½®ï¼ˆå¦‚ consumer.bootstrap.serversã€consumer.group.id ç­‰ï¼‰ã€‚ åŒæ—¶ä½œç”¨äºæºé›†ç¾¤å’Œç›®æ ‡é›†ç¾¤çš„æ¶ˆè´¹è€…ï¼Œé™¤éè¢« source.consumer. æˆ– target.consumer. è¦†ç›–ã€‚ source.producer.* æºé›†ç¾¤ç”Ÿäº§è€…çš„ä¸“ç”¨é…ç½®ï¼ˆä¼˜å…ˆçº§é«˜äº producer.ï¼‰ã€‚ ä»…ç”¨äºæºé›†ç¾¤çš„ç”Ÿäº§è€…ï¼ˆå¦‚å‘é€åç§»é‡åŒæ­¥è®°å½•åˆ° offsetSyncsTopicï¼‰ã€‚ source.consumer.* æºé›†ç¾¤æ¶ˆè´¹è€…çš„ä¸“ç”¨é…ç½®ï¼ˆä¼˜å…ˆçº§é«˜äº consumer.ï¼‰ã€‚ ä»…ç”¨äºæºé›†ç¾¤çš„æ•°æ®æ‹‰å–æ¶ˆè´¹è€…ï¼ˆå¦‚ä»æºé›†ç¾¤ä¸»é¢˜æ‹‰å–å¾…å¤åˆ¶æ•°æ®ï¼‰ã€‚ target.producer.* ç›®æ ‡é›†ç¾¤ç”Ÿäº§è€…çš„ä¸“ç”¨é…ç½®ï¼ˆä¼˜å…ˆçº§é«˜äº producer.ï¼‰ã€‚ ä»…ç”¨äºç›®æ ‡é›†ç¾¤çš„ç”Ÿäº§è€…ï¼ˆå¦‚å¤åˆ¶æ•°æ®åˆ°ç›®æ ‡é›†ç¾¤ä¸»é¢˜ï¼‰ã€‚ target.consumer.* ç›®æ ‡é›†ç¾¤æ¶ˆè´¹è€…çš„ä¸“ç”¨é…ç½®ï¼ˆä¼˜å…ˆçº§é«˜äº consumer.ï¼‰ã€‚ ä»…ç”¨äºç›®æ ‡é›†ç¾¤çš„æ¶ˆè´¹è€…ï¼ˆå¦‚è¯»å–ç›®æ ‡é›†ç¾¤å…ƒæ•°æ®æˆ–åç§»é‡åŒæ­¥è®°å½•ï¼‰ã€‚ producer. å’Œ consumer. å‰ç¼€æ”¯æŒæ‰€æœ‰ Kafka æ ‡å‡†ç”Ÿäº§è€…/æ¶ˆè´¹è€…é…ç½®ï¼ˆå¦‚ acksã€retriesã€fetch.min.bytes ç­‰ï¼‰ï¼Œå…·ä½“å¯å‚è€ƒ Kafka å®˜æ–¹æ–‡æ¡£é…ç½®ï¼š Consumer Config / Producer Config\n"},{"id":6,"href":"/2025/07/02/WebAssemblySpec%E6%B5%85%E6%9E%90%E5%92%8C%E8%B7%A8%E8%AF%AD%E8%A8%80%E5%AE%9E%E8%B7%B5/","title":"WebAssembly Spec æµ…æå’Œè·¨è¯­è¨€å®è·µ","section":"Posts","content":" æœ¬æ–‡ä¸»è¦èšç„¦äº WebAssembly çš„æ ¸å¿ƒè§„èŒƒï¼ˆCore Specï¼‰éƒ¨åˆ†ã€‚WASI å’Œ Embedder Spec ç­‰å…¶ä»–éƒ¨åˆ†å¹¶éæœ¬æ–‡çš„é‡ç‚¹ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯è‡ªè¡ŒæŸ¥é˜…ç›¸å…³èµ„æ–™ã€‚\nç›®çš„ # éšç€ Web æŠ€æœ¯çš„æ™®åŠï¼Œè¶Šæ¥è¶Šå¤šçš„åº”ç”¨åœºæ™¯ï¼ˆå¦‚æ¸¸æˆã€éŸ³è§†é¢‘å¤„ç†ã€AI ç­‰ï¼‰éœ€è¦åœ¨æµè§ˆå™¨ä¸­è¿è¡Œã€‚è¿™äº›åœºæ™¯é€šå¸¸æ¶‰åŠ CPU å¯†é›†å‹ä»»åŠ¡ï¼Œè€Œç°æœ‰ Web å¼•æ“åœ¨å¤„ç†æ­¤ç±»ä»»åŠ¡æ—¶ï¼Œæ€§èƒ½ä»ä¸åŠåŸç”Ÿè¯­è¨€ã€‚æ­¤å¤–ï¼ŒC/C++ ç­‰è¯­è¨€å·²ç§¯ç´¯äº†å¤§é‡æˆç†Ÿçš„åº“ï¼Œä¸ºäº†é«˜æ•ˆå¤ç”¨è¿™äº›åº“ä»¥æ‰©å±• Web çš„èƒ½åŠ›ï¼Œæ€¥éœ€ä¸€ç§æ–°æ–¹å¼ï¼Œä½¿ C++/Rust ç­‰è¯­è¨€ä¹Ÿèƒ½åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­è¿è¡Œã€‚\nä¸ºè§£å†³ä¸Šè¿°é—®é¢˜ï¼ŒW3C æå‡ºäº† WebAssembly è§„èŒƒã€‚è¯¥è§„èŒƒè®¾è®¡äº†ä¸€ç§å…¨æ–°çš„ã€ä¸æœºå™¨æ— å…³çš„æ±‡ç¼–æŒ‡ä»¤é›†ã€è¿è¡Œæ—¶ï¼ˆå¯ç†è§£ä¸ºè™šæ‹Ÿæœºï¼‰ä»¥åŠå†…å­˜æ¨¡å‹ç­‰ã€‚\nWebAssembly è§„èŒƒå‘å¸ƒåï¼Œå„å¤§æµè§ˆå™¨å‚å•†è¿…é€Ÿè·Ÿè¿›æ”¯æŒï¼Œä½¿å…¶æˆä¸ºä¸€ç§è·¨å¹³å°çš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œèƒ½å¤Ÿåœ¨ä¸åŒæ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶å¹³å°ä¸Šè¿è¡Œã€‚WASM çš„åº”ç”¨èŒƒå›´ä¹Ÿå› æ­¤ä¸å†å±€é™äº Web åœºæ™¯ï¼Œè€Œæ˜¯æ‰©å±•åˆ°ç§»åŠ¨ç«¯ã€æœåŠ¡å™¨ç«¯ç­‰é¢†åŸŸã€‚åœ¨äº‘åŸç”Ÿé¢†åŸŸï¼ŒEnvoyã€Kong å’Œ Apisix ç­‰é¡¹ç›®å·²æ”¯æŒ WASM ä½œä¸ºå…¶æ‰©å±•æ’ä»¶ã€‚WasmEdge æ›´è¿›ä¸€æ­¥ï¼Œç›´æ¥æå‡ºå°† WASM åº”ç”¨äºè¾¹ç¼˜è®¡ç®—åœºæ™¯ï¼Œä¾‹å¦‚æ— æœåŠ¡å™¨åº”ç”¨å’Œå‡½æ•°å³æœåŠ¡ç­‰ã€‚\næ ¸å¿ƒæ¦‚å¿µ # åœ¨æœ€æ–°è§„èŒƒä¸­ï¼ŒWebAssembly å®šä¹‰äº†ä»¥ä¸‹æ ¸å¿ƒæ¦‚å¿µï¼š\næ¦‚å¿µ è§£é‡Šè¯´æ˜ Values æä¾›å››ç§åŸºç¡€æ•°å€¼ç±»å‹ï¼š32ä½å’Œ64ä½çš„æ•´å‹åŠæµ®ç‚¹å‹ã€‚32ä½æ•´å‹å¯ç”¨äºè¡¨ç¤ºå¸ƒå°”å€¼æˆ–å†…å­˜åœ°å€ã€‚å¦æœ‰128ä½æ‰©å±•æ•´å‹ç”¨äºé«˜ç²¾åº¦è®¡ç®—ã€‚ Instructions åŸºäºæ ˆå¼è™šæ‹Ÿæœºæ‰§è¡Œçš„æŒ‡ä»¤ï¼Œåˆ†ä¸ºç®€å•æŒ‡ä»¤å’Œæ§åˆ¶æŒ‡ä»¤ä¸¤ç±»ã€‚ Traps ç±»ä¼¼å¼‚å¸¸æœºåˆ¶ï¼Œå½“å‘ç”Ÿéæ³•æ“ä½œï¼ˆå¦‚è¶Šç•Œè®¿é—®ï¼‰æ—¶ç«‹å³ä¸­æ­¢æ‰§è¡Œå¹¶æŠ¥å‘Šå®¿ä¸»ç¯å¢ƒã€‚åŠŸèƒ½ç±»ä¼¼äºGo/Rustä¸­çš„panicã€‚ Functions ä¸å…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸€è‡´ï¼Œç”¨äºç»„ç»‡ç‰¹å®šåŠŸèƒ½çš„ä»£ç ï¼Œæ¥æ”¶å‚æ•°å¹¶è¿”å›ç»“æœã€‚ Tables æ•°æ®ç»“æ„ä¸Šæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç”¨äºå­˜å‚¨ç‰¹å®šç±»å‹ï¼ˆfuncrefå’Œexternrefï¼‰ï¼Œå¯é€šè¿‡ç´¢å¼•æ¨¡æ‹Ÿå‡½æ•°æŒ‡é’ˆã€‚ Linear Memory ä¸€æ®µå¯åŠ¨æ€å¢é•¿çš„è¿ç»­å­—èŠ‚æ•°ç»„ï¼Œç¨‹åºå¯å­˜å‚¨å’ŒåŠ è½½å…¶ä¸­ä»»æ„ä½ç½®çš„æ•°æ®ï¼Œè¶Šç•Œè®¿é—®ä¼šè§¦å‘Trapã€‚ Modules åŒ…å«ç±»å‹ã€å‡½æ•°ã€è¡¨ã€å†…å­˜å’Œå…¨å±€å˜é‡çš„å®šä¹‰ï¼Œä½œä¸ºéƒ¨ç½²ã€åŠ è½½å’Œç¼–è¯‘çš„åŸºæœ¬å•ä½ã€‚å¯å£°æ˜å¯¼å…¥å¯¼å‡ºé¡¹ï¼Œå¹¶æ”¯æŒå®šä¹‰è‡ªåŠ¨æ‰§è¡Œçš„å¯åŠ¨å‡½æ•°ã€‚ Embedder æŒ‡å°†WebAssemblyç¨‹åºåµŒå…¥å®¿ä¸»ç¯å¢ƒçš„å®ç°æ–¹å¼ï¼Œå¦‚wasmtimeæˆ–Webç¯å¢ƒä¸­çš„WebAssemblyè¿è¡Œæ—¶ã€‚ ä¸¾ä¾‹åˆ†æ # æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ç»“åˆä¸€ä¸ªç®€å•çš„ WASM ç¨‹åºæ¥è¾…åŠ©ç†è§£ WebAssembly è§„èŒƒçš„å†…å®¹ã€‚è¿™é‡Œä½¿ç”¨ Rust è¯­è¨€ç¼–å†™ä¸€ä¸ªç®€å•çš„åŠ æ³•ç¨‹åºï¼Œå¹¶å°†å…¶ç¼–è¯‘ä¸º WASM æ¨¡å—ï¼š\n#![no_std] #[unsafe(no_mangle)] pub extern \u0026#34;C\u0026#34; fn add(left: u64, right: u64) -\u0026gt; u64 { left + right } #[unsafe(no_mangle)] pub extern \u0026#34;C\u0026#34; fn subtract(left: u32, right: u32) -\u0026gt; u32 { left - right } é€šè¿‡ wasmtime è¿™æ ·çš„å·¥å…·å¯ä»¥æ–¹ä¾¿çš„è°ƒç”¨ wasm æ¨¡å—ï¼Œå¦‚ä¸‹ï¼š\n\u0026gt;\u0026gt;\u0026gt; wasmtime --invoke add ./wasm_demo.wasm 1 2 3 ç¼–è¯‘ç”Ÿæˆçš„ wasm å¯ä»¥ä½¿ç”¨ wasm2wat å°†äºŒè¿›åˆ¶æ ¼å¼è½¬ä¸º WAT æ–‡æœ¬æ ¼å¼ï¼Œæ–¹ä¾¿æŸ¥çœ‹å’Œåˆ†æã€‚ wasm2wat wasm_demo.wasm -o wasm_demo.wat\n(module $wasm_demo.wasm (type (;0;) (func (param i64 i64) (result i64))) (type (;1;) (func (param i32 i32) (result i32))) (func $add (type 0) (param i64 i64) (result i64) local.get 1 local.get 0 i64.add) (func $subtract (type 1) (param i32 i32) (result i32) local.get 0 local.get 1 i32.sub) (memory (;0;) 16) (global $__stack_pointer (mut i32) (i32.const 1048576)) (global (;1;) i32 (i32.const 1048576)) (global (;2;) i32 (i32.const 1048576)) (export \u0026#34;memory\u0026#34; (memory 0)) (export \u0026#34;add\u0026#34; (func $add)) (export \u0026#34;subtract\u0026#34; (func $subtract)) (export \u0026#34;__data_end\u0026#34; (global 1)) (export \u0026#34;__heap_base\u0026#34; (global 2))) æ•´ä½“ç»“æ„ # WAT æ–‡ä»¶ä»¥ (module \u0026hellip;) å¼€å¤´ï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ª WebAssembly æ¨¡å—ã€‚æ¨¡å—æ˜¯ WebAssembly çš„åŸºæœ¬å°è£…å•å…ƒï¼ŒåŒ…å«ç±»å‹ã€å‡½æ•°ã€å†…å­˜ã€å…¨å±€å˜é‡ç­‰å…ƒç´ ã€‚\n(module $wasm_demo.wasm ... ) $wasm_demo.wasm æ˜¯æ¨¡å—çš„å¯é€‰åç§°ï¼Œç”¨äºåœ¨è°ƒè¯•æˆ–å¼•ç”¨æ—¶æ ‡è¯†è¯¥æ¨¡å—ã€‚\nç±»å‹å®šä¹‰ # (type (;0;) (func (param i64 i64) (result i64))) (type ...) ç”¨äºå®šä¹‰å‡½æ•°ç±»å‹ã€‚\n(;0;) æ˜¯ç±»å‹çš„ç´¢å¼•ï¼Œè¿™é‡Œè¡¨ç¤ºè¯¥ç±»å‹çš„ç´¢å¼•ä¸º 0ã€‚\n(func (param i64 i64) (result i64)) å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°ç±»å‹ï¼Œè¯¥å‡½æ•°æ¥å—ä¸¤ä¸ª 64 ä½æ•´æ•°ï¼ˆi64ï¼‰ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ª 64 ä½æ•´æ•°ã€‚\nå¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰ä¸¤ä¸ªå‡½æ•°ç±»å‹å®šä¹‰ï¼Œä½†æ˜¯å¦‚æœ add å’Œ subtract çš„å‡½æ•°ç­¾åæ”¹æˆä¸€è‡´çš„ï¼Œè¿™é‡Œå°±å¯ä»¥åªå®šä¹‰ä¸€ä¸ªå‡½æ•°ç±»å‹ã€‚\nå‡½æ•°å®šä¹‰ # (func $add (type 0) (param i64 i64) (result i64) local.get 1 local.get 0 i64.add) (func ...) ç”¨äºå®šä¹‰å‡½æ•°ã€‚\n$add æ˜¯å‡½æ•°çš„åç§°ï¼Œç”¨äºåœ¨å…¶ä»–åœ°æ–¹å¼•ç”¨è¯¥å‡½æ•°ã€‚\n(type 0) è¡¨ç¤ºè¯¥å‡½æ•°çš„ç±»å‹ä¸ºç´¢å¼•ä¸º 0 çš„ç±»å‹ã€‚\n(param i64 i64) å®šä¹‰äº†ä¸¤ä¸ª 64 ä½æ•´æ•°å‚æ•°ã€‚\n(result i64) è¡¨ç¤ºå‡½æ•°è¿”å›ä¸€ä¸ª 64 ä½æ•´æ•°ã€‚\nå‡½æ•°ä½“ç”±æŒ‡ä»¤åºåˆ—ç»„æˆï¼Œè¿™é‡Œä½¿ç”¨äº† local.get å’Œ i64.add æŒ‡ä»¤ã€‚\nå†…å­˜å®šä¹‰ # (memory (;0;) 16) (memory ...) ç”¨äºå®šä¹‰å†…å­˜ã€‚\n(;0;) æ˜¯å†…å­˜çš„ç´¢å¼•ï¼Œè¿™é‡Œè¡¨ç¤ºè¯¥å†…å­˜çš„ç´¢å¼•ä¸º 0ã€‚\n16 è¡¨ç¤ºå†…å­˜çš„åˆå§‹é¡µæ•°ä¸º 16 é¡µï¼Œæ¯é¡µå¤§å°ä¸º 64KB, æ‰€ä»¥åˆå§‹å†…å­˜å¤§å°ä¸º 16 * 64KB = 1024KBã€‚\nå…¨å±€å˜é‡å®šä¹‰ # (global $__stack_pointer (mut i32) (i32.const 1048576)) (global ...) ç”¨äºå®šä¹‰å…¨å±€å˜é‡ã€‚\n$__stack_pointer æ˜¯å…¨å±€å˜é‡çš„åç§°ã€‚\n(mut i32) è¡¨ç¤ºè¯¥å…¨å±€å˜é‡ä¸ºå¯å˜çš„ 32 ä½æ•´æ•°ç±»å‹ã€‚\n(i32.const 1048576) è¡¨ç¤ºåˆå§‹å€¼ä¸º 1048576 çš„ 32 ä½æ•´æ•°ã€‚\nå¯¼å‡ºå®šä¹‰ # (export \u0026#34;memory\u0026#34; (memory 0)) (export \u0026#34;add\u0026#34; (func $add)) (export \u0026#34;subtract\u0026#34; (func $subtract)) (export \u0026#34;__data_end\u0026#34; (global 1)) (export \u0026#34;__heap_base\u0026#34; (global 2)) (export ...) ç”¨äºå®šä¹‰å¯¼å‡ºé¡¹ã€‚\n\u0026quot;memory\u0026quot; æ˜¯å¯¼å‡ºé¡¹çš„åç§°ï¼Œç”¨äºåœ¨å…¶ä»–åœ°æ–¹å¼•ç”¨è¯¥å†…å­˜ã€‚\n(memory 0) è¡¨ç¤ºå¯¼å‡ºç´¢å¼•ä¸º 0 çš„å†…å­˜åŒºåŸŸã€‚\nè‡³äºå‡½æ•°å’Œå…¨å±€å˜é‡çš„å¯¼å‡ºï¼Œä¹Ÿæ˜¯ç±»ä¼¼çš„å®šä¹‰æ–¹å¼ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€åˆ—å‡ºäº†ã€‚\nå°ç»“ # WebAssemblyï¼Œé¡¾åæ€ä¹‰ï¼Œæ˜¯ä¸€ç§æ±‡ç¼–è¯­è¨€ï¼Œå®ƒå®šä¹‰äº†éå¸¸åº•å±‚çš„æŒ‡ä»¤ã€‚ä½†ä¸ä¼ ç»Ÿæ±‡ç¼–ä¸åŒçš„æ˜¯ï¼Œå…¶æŒ‡ä»¤ä¸ä¾èµ–äºå…·ä½“çš„ CPUï¼ˆå®¿ä¸»ç¯å¢ƒï¼‰ã€‚åŒæ—¶ï¼Œå®ƒä¸ä»…æ˜¯è¯­è¨€è§„èŒƒï¼Œè¿˜æä¾›äº†ä¸€äº›ä¸å®¿ä¸»ç¯å¢ƒï¼ˆå°¤å…¶æ˜¯ Web å’Œ JavaScript å®¿ä¸»ç¯å¢ƒï¼‰äº¤äº’çš„çº¦å®šã€‚\nç”±æ­¤å¯è§ï¼ŒWebAssembly éœ€è¦çš„æ˜¯ä¸€ä¸ªè¿è¡Œæ—¶æ”¯æŒï¼Œè€Œè¿™ä¸ªè¿è¡Œæ—¶æ”¯æŒå¯ä»¥æ˜¯ä¸€ä¸ªåµŒå…¥æŸç§è¯­è¨€çš„è™šæ‹Ÿæœºï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ª docker å®¹å™¨ï¼Œä¹Ÿå¯ä»¥åœ¨è£¸æœºä¸Šè¿è¡Œã€‚å°±åƒè§£é‡Šå‹è¯­è¨€ä¸€æ ·ï¼Œéœ€è¦ä¸€ä¸ª â€œè§£é‡Šå™¨â€ æ¥æ‰§è¡Œ WASM æ¨¡å—ä¸­çš„æŒ‡ä»¤ã€‚\nç›®å‰ï¼ŒWebAssembly è¿˜åœ¨ä¸æ–­å‘å±•ï¼Œä¾‹å¦‚ WASI (WebAssembly System Interface) å’Œ WASM Component Model ç­‰æ›´ä¸°å¯Œçš„ç‰¹æ€§ä¹Ÿå·²ç›¸ç»§æ¨å‡ºã€‚\nè¿™ä¸€å°èŠ‚é€šè¿‡ä»æ‰“åŒ…çš„ Module å‡ºå‘ï¼Œè½¬æ¢ä¸º WAT æ ¼å¼å¹¶é€ä¸ªç†è§£ï¼Œè™½ç„¶æ²¡æœ‰åˆ—ä¸¾ Spec ä¸­å…¨éƒ¨å†…å®¹ï¼Œä½†è¶³ä»¥å¯¹ WebAssembly çš„æ ¸å¿ƒæ¦‚å¿µå½¢æˆåŸºæœ¬çš„è®¤è¯†ã€‚\nçº¿æ€§å†…å­˜ # é€šè¿‡å‰é¢çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬å¾—ä»¥çª¥è§ WebAssembly çš„å¤§è‡´ç»“æ„å’Œæ¦‚å¿µã€‚è‡³äºå…¶è¯¦ç»†æŒ‡ä»¤ï¼Œä½œä¸ºä½¿ç”¨è€…æˆ‘ä»¬é€šå¸¸æ— éœ€æ·±ç©¶ï¼Œæˆ‘ä»¬æ›´å…³æ³¨å¦‚ä½•ç¼–å†™ WASM æ¨¡å—ã€å¦‚ä½•åœ¨ä¸åŒè¯­è¨€çš„å®¿ä¸»ç¯å¢ƒä¸­è¿è¡Œï¼Œä»¥åŠå¦‚ä½•åœ¨å®¿ä¸»ç¯å¢ƒä¸ WASM æ¨¡å—ä¹‹é—´è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚\nç”±äº WebAssembly æ²¡æœ‰æä¾›å¤æ‚çš„æ•°æ®ç±»å‹ï¼Œå½“å®¿ä¸»ç¯å¢ƒå’Œ WASM æ¨¡å—éœ€è¦ä¼ è¾“å¤æ‚æ•°æ®æ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦åˆ©ç”¨ WASM æä¾›çš„çº¿æ€§å†…å­˜è¿›è¡Œæ•°æ®äº¤äº’ã€‚\nå¤æ‚æ•°æ®ç»“æ„åŒ…æ‹¬ï¼šæ•°ç»„ã€å­—ç¬¦ä¸²ã€ç»“æ„ä½“ã€è”åˆä½“ã€æšä¸¾ç­‰ã€‚\nè¿™é‡Œæˆ‘ä»¬å°†ä»¥æœ€ç®€å•çš„å­—ç¬¦ä¸²ä¸ºä¾‹ï¼Œæ¼”ç¤ºå®¿ä¸»ç¯å¢ƒå’Œ WASM æ¨¡å—å¦‚ä½•é€šè¿‡çº¿æ€§å†…å­˜è¿›è¡Œå­—ç¬¦ä¸²äº¤äº’ã€‚\néœ€æ±‚ # å‡è®¾æˆ‘ä»¬ä½¿ç”¨ Rust å®ç°äº†ä¸€ä¸ªä¸º JSON å­—ç¬¦ä¸²åŠ¨æ€æ·»åŠ å­—æ®µçš„ WASM æ¨¡å—ï¼Œç°åœ¨æƒ³è¦åœ¨ python å’Œ javascript ä¸­è°ƒç”¨è¯¥åŠŸèƒ½ã€‚\nRust åˆ° WASM # åœ¨ Rust ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ª allocate å‡½æ•°ï¼Œç”¨äºåœ¨ WASM å†…å­˜ä¸­åˆ†é…ä¸€æ®µç©ºé—´ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®ç°ä¸€ä¸ª deallocate å‡½æ•°ï¼Œç”¨äºé‡Šæ”¾ä¹‹å‰åˆ†é…çš„å†…å­˜ï¼Œå¹¶å°†è¿™ä¸¤ä¸ªå‡½æ•°å¯¼å‡ºï¼Œä»¥ä¾¿åœ¨å…¶ä»–è¯­è¨€ä¸­è°ƒç”¨ã€‚\nè‡³äºæ€ä¹ˆä¸º JSON å­—ç¬¦ä¸²åŠ¨æ€æ·»åŠ å­—æ®µï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ serde_json åº“æ¥è¿›è¡Œ JSON å­—ç¬¦ä¸²çš„è§£æå’Œåºåˆ—åŒ–ã€‚\n#[no_mangle] pub extern \u0026#34;C\u0026#34; fn allocate(size: usize) -\u0026gt; *mut u8 { let mut buffer = Vec::with_capacity(size); let ptr = buffer.as_mut_ptr(); core::mem::forget(buffer); // é˜»æ­¢ Vec åœ¨è¿™é‡Œè¢« Drop ptr } #[no_mangle] pub extern \u0026#34;C\u0026#34; fn deallocate(ptr: *mut u8, capacity: usize) { unsafe { let _ = Vec::from_raw_parts(ptr, 0, capacity); } } #[no_mangle] pub extern \u0026#34;C\u0026#34; fn json_add_field( json_ptr: *const u8, json_len: usize, field_ptr: *const u8, field_len: usize, ) -\u0026gt; u64 { // åŠ è½½ host ä¼ å…¥çš„å­—ç¬¦ä¸²ï¼Œå¹¶è§£æ let json_bytes = unsafe { slice::from_raw_parts(json_ptr, json_len) }; let field_bytes = unsafe { slice::from_raw_parts(field_ptr, field_len) }; let mut json_value: serde_json::Value = match serde_json::from_slice(json_bytes) { Ok(v) =\u0026gt; v, Err(_) =\u0026gt; return 0, // é”™è¯¯å¤„ç† }; let field_value: serde_json::Value = match serde_json::from_slice(field_bytes) { Ok(v) =\u0026gt; v, Err(_) =\u0026gt; return 0, // é”™è¯¯å¤„ç† }; // æ‰§è¡Œæ·»åŠ å­—æ®µçš„é€»è¾‘ if let (Some(obj), Some(field_obj)) = (json_value.as_object_mut(), field_value.as_object()) { for (k, v) in field_obj { obj.insert(k.clone(), v.clone()); } } else { return 0; } // å°†ä¿®æ”¹åçš„ JSON åºåˆ—åŒ–å›å­—ç¬¦ä¸² let result_json = match serde_json::to_string(\u0026amp;json_value) { Ok(s) =\u0026gt; s, Err(_) =\u0026gt; return 0, // é”™è¯¯å¤„ç† }; // å°†ç»“æœå­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚å‘é‡å¹¶è·å–æŒ‡é’ˆå’Œé•¿åº¦ let mut result_bytes = result_json.into_bytes(); let len = result_bytes.len(); let ptr = result_bytes.as_mut_ptr() as u64; // æ³„æ¼å†…å­˜ï¼Œä»¥ä¾¿ Host å¯ä»¥è®¿é—®å®ƒ core::mem::forget(result_bytes); // å°†é•¿åº¦å’ŒæŒ‡é’ˆæ‰“åŒ…æˆä¸€ä¸ª u64 è¿”å› // é•¿åº¦æ”¾åœ¨é«˜ 32 ä½ï¼ŒæŒ‡é’ˆæ”¾åœ¨ä½ 32 ä½ // Q: WASM æ”¯æŒ multi-value è¿”å›ï¼ŒRUST å¦‚ä½•ä½¿ç”¨è¿™ä¸ªç‰¹æ€§å‘¢ï¼Ÿ (len as u64) \u0026lt;\u0026lt; 32 | ptr } åœ¨ python ä¸­ä½¿ç”¨ # åœ¨ python ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ wasmtime åº“æ¥åŠ è½½å’Œè¿è¡Œ WASM æ¨¡å—ã€‚è¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š\n$ python run.py Initial JSON: {\u0026#34;name\u0026#34;: \u0026#34;Alice\u0026#34;, \u0026#34;age\u0026#34;: 30} Adding Fields: {\u0026#34;city\u0026#34;: \u0026#34;New York\u0026#34;, \u0026#34;occupation\u0026#34;: \u0026#34;Engineer\u0026#34;} Modified JSON: {\u0026#34;age\u0026#34;:30,\u0026#34;city\u0026#34;:\u0026#34;New York\u0026#34;,\u0026#34;name\u0026#34;:\u0026#34;Alice\u0026#34;,\u0026#34;occupation\u0026#34;:\u0026#34;Engineer\u0026#34;} store = wasmtime.Store() module = wasmtime.Module.from_file(store.engine, \u0026#34;wasms/rust.wasm\u0026#34;) instance = wasmtime.Instance(store, module, []) # è·å– WASM ä¸­çš„å¯¼å‡º exports = instance.exports(store) wasm_memory = exports[\u0026#34;memory\u0026#34;] wasm_allocate = exports[\u0026#34;allocate\u0026#34;] wasm_deallocate = exports[\u0026#34;deallocate\u0026#34;] wasm_json_add_field = exports[\u0026#34;json_add_field\u0026#34;] def rust_string_to_python(ptr, length): data_bytes = wasm_memory.read(store, ptr, ptr + length) return data_bytes.decode(\u0026#39;utf-8\u0026#39;) def python_string_to_wasm(s: str) -\u0026gt; tuple[int, int]: s_bytes = s.encode(\u0026#39;utf-8\u0026#39;) s_len = len(s_bytes) s_ptr = wasm_allocate(store, s_len) wasm_memory.write(store, s_bytes, s_ptr) return s_ptr, s_len def process_json_with_wasm(original_json: str, field_to_add: str) -\u0026gt; str: json_ptr, json_len = python_string_to_wasm(original_json) field_ptr, field_len = python_string_to_wasm(field_to_add) # è°ƒç”¨å‡½æ•° result_u64 = wasm_json_add_field(store, json_ptr, json_len, field_ptr, field_len) # é‡Šæ”¾ WASM ä¸­çš„å†…å­˜ wasm_deallocate(store, json_ptr, json_len) wasm_deallocate(store, field_ptr, field_len) # è§£æ WASM å‡½æ•°è¿”å›çš„æŒ‡é’ˆå’Œé•¿åº¦ if result_u64 == 0: raise ValueError(\u0026#34;Wasm function returned an error (0)\u0026#34;) result_len = result_u64 \u0026gt;\u0026gt; 32 result_ptr = result_u64 \u0026amp; 0xFFFFFFFF result_json_str = rust_string_to_python(result_ptr, result_len) # åœ¨ Rust è¿™éƒ¨åˆ†å†…å­˜æ˜¯æ²¡æœ‰è¢«é‡Šæ”¾çš„ï¼Œéœ€è¦æ‰‹åŠ¨é‡Šæ”¾ wasm_deallocate(store, result_ptr, result_len) return result_json_str if __name__ == \u0026#34;__main__\u0026#34;: initial_json = \u0026#39;{\u0026#34;name\u0026#34;: \u0026#34;Alice\u0026#34;, \u0026#34;age\u0026#34;: 30}\u0026#39; new_field = \u0026#39;{\u0026#34;city\u0026#34;: \u0026#34;New York\u0026#34;, \u0026#34;occupation\u0026#34;: \u0026#34;Engineer\u0026#34;}\u0026#39; modified_json = process_json_with_wasm(initial_json, new_field) print(f\u0026#34;Modified JSON: {modified_json}\u0026#34;) åœ¨ NodeJS ä¸­ä½¿ç”¨ # åœ¨ NodeJS ä¸­å·²ç»è‡ªå¸¦äº† WebAssembly æ¨¡å—ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚\nasync function runWasm() { // 1. è¯»å– Wasm æ¨¡å—çš„äºŒè¿›åˆ¶æ•°æ® const wasmPath = path.join(__dirname, \u0026#39;wasms\u0026#39;, \u0026#39;rust.wasm\u0026#39;); const wasmBytes = fs.readFileSync(wasmPath); // 2. åˆ›å»º WebAssembly å†…å­˜å®ä¾‹ // initial: åˆå§‹å†…å­˜é¡µæ•° (1é¡µ = 64KB) // maximum: æœ€å¤§å†…å­˜é¡µæ•° (å¯é€‰ï¼Œä½†æ¨èè®¾ç½®ï¼Œé˜²æ­¢å†…å­˜æ— é™å¢é•¿) const memory = new WebAssembly.Memory({ initial: 1, maximum: 16 }); // 1é¡µ = 64KB // 3. è‡ªå®šä¹‰å®šä¹‰å¯¼å…¥å¯¹è±¡ (imports object) const importObject = { env: { memory: memory, } }; // 4. å®ä¾‹åŒ– Wasm æ¨¡å— const wasm = await WebAssembly.instantiate(wasmBytes, importObject); const exports = wasm.instance.exports; // 5. è·å–å¯¼å‡ºçš„å‡½æ•°å’Œå†…å­˜ const wasmAllocate = exports.allocate; const wasmDeallocate = exports.deallocate; const wasmJsonAddField = exports.json_add_field; const wasmMemory = exports.memory; // ç›´æ¥è·å–å¯¼å‡ºçš„å†…å­˜å¯¹è±¡ function writeStringToWasm(jsString) { const encoder = new TextEncoder(\u0026#39;utf-8\u0026#39;); const encodedBytes = encoder.encode(jsString); const byteLength = encodedBytes.length; const ptr = wasmAllocate(byteLength); const wasmByteView = new Uint8Array(wasmMemory.buffer); wasmByteView.set(encodedBytes, ptr); return { ptr, len: byteLength }; } function readStringFromWasm(ptr, len) { const wasmByteView = new Uint8Array(wasmMemory.buffer, ptr, len); const decoder = new TextDecoder(\u0026#39;utf-8\u0026#39;); return decoder.decode(wasmByteView); } const initialJson = \u0026#39;{\u0026#34;name\u0026#34;: \u0026#34;Alice\u0026#34;, \u0026#34;age\u0026#34;: 30}\u0026#39;; const newField = \u0026#39;{\u0026#34;city\u0026#34;: \u0026#34;New York\u0026#34;, \u0026#34;occupation\u0026#34;: \u0026#34;Engineer\u0026#34;}\u0026#39;; console.log(`Initial JSON: ${initialJson}`); console.log(`Field to add: ${newField}`); try { // å†™å…¥åŸå§‹ JSON å­—ç¬¦ä¸²åˆ° Wasm å†…å­˜ const { ptr: jsonPtr, len: jsonLen } = writeStringToWasm(initialJson); // å†™å…¥è¦æ·»åŠ çš„å­—æ®µ JSON å­—ç¬¦ä¸²åˆ° Wasm å†…å­˜ const { ptr: fieldPtr, len: fieldLen } = writeStringToWasm(newField); // è°ƒç”¨ Wasm å‡½æ•° // Rust å‡½æ•°è¿”å›ä¸€ä¸ª u64ï¼Œé«˜ 32 ä½æ˜¯é•¿åº¦ï¼Œä½ 32 ä½æ˜¯æŒ‡é’ˆ const resultU64 = wasmJsonAddField(jsonPtr, jsonLen, fieldPtr, fieldLen); // é‡Šæ”¾è¾“å…¥å­—ç¬¦ä¸²çš„ Wasm å†…å­˜ wasmDeallocate(jsonPtr, jsonLen); wasmDeallocate(fieldPtr, fieldLen); if (resultU64 === 0) { throw new Error(\u0026#34;Wasm function returned an error (0)\u0026#34;); } // ä» u64 ä¸­è§£ææŒ‡é’ˆå’Œé•¿åº¦ const resultLen = Number(resultU64 \u0026gt;\u0026gt; 32n); // ä½¿ç”¨ BigInt æ“ä½œ u64 const resultPtr = Number(resultU64 \u0026amp; 0xFFFFFFFFn); // ä½¿ç”¨ BigInt æ“ä½œ u64 // ä» Wasm å†…å­˜ä¸­è¯»å–ç»“æœå­—ç¬¦ä¸² const modifiedJson = readStringFromWasm(resultPtr, resultLen); console.log(`Modified JSON: ${modifiedJson}`); // é‡Šæ”¾ Wasm æ¨¡å—åˆ†é…çš„å†…å­˜ wasmDeallocate(resultPtr, resultLen); console.log(\u0026#34;Got JSON:\u0026#34;, expectedJsonDict); } catch (e) { console.error(`An error occurred: ${e.message}`); } } runWasm(); æ•´ä½“äº¤äº’æµç¨‹ä¸Šä¸ python å¤§åŒå°å¼‚ã€‚\nå°ç»“ # å…¨éƒ¨ä»£ç å¯ä»¥åœ¨ https://github.com/yeqown/wasm-demo æ‰¾åˆ°ã€‚\nç®€è€Œè¨€ä¹‹ï¼ŒWASM å†…å­˜å…è®¸å¼€å‘è€…è‡ªè¡Œç®¡ç†å†…å­˜ï¼Œè€Œä¸ä¾èµ–äºå®¿ä¸»ç¯å¢ƒçš„å†…å­˜ç®¡ç†æœºåˆ¶ã€‚è™½ç„¶è¯¸å¦‚ wasm-bindgen è¿™æ ·çš„å·¥å…·å¯ä»¥å®ç° Rust åˆ° JavaScript çš„ç»‘å®šï¼Œä½†è‹¥éœ€æ”¯æŒå…¶ä»–è¯­è¨€ï¼Œå…¶èƒ½åŠ›åˆ™æœ‰æ‰€å±€é™ã€‚\nç„¶è€Œï¼Œä¸€æ—¦ç†è§£äº†å…¶åº•å±‚åŸç†ï¼Œå³ä½¿æ˜¯æ›´é«˜çº§çš„æ•°æ®ç»“æ„ï¼Œä¹Ÿèƒ½å¤Ÿè‡ªè¡Œå°è£…å®ç°ã€‚\nğŸ¤£ è¿™ä»¿ä½›åˆå›åˆ°äº† C è¯­è¨€æ‰‹åŠ¨å†…å­˜ç®¡ç†çš„æ—¶ä»£ã€‚\nå‚è€ƒ # WebAssembly è§„èŒƒ WebAssembly æŒ‡ä»¤ç´¢å¼• WebAssembly ç±»å‹ç´¢å¼• WebAssembly æ–‡æœ¬æ ¼å¼ "},{"id":7,"href":"/2025/05/08/%E5%9C%A8-Kubernetes%E4%B8%AD%E5%AE%9E%E7%8E%B0gRPC%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F/","title":"åœ¨ Kubernetes ä¸­å®ç° gRPC æµé‡çš„é•œåƒå’Œå¯¹æ¯”","section":"Posts","content":"æœ¬æ–‡ä¸»è¦è§£å†³åœ¨æœåŠ¡é‡æ„è¿‡ç¨‹ä¸­å¦‚ä½•ä¿è¯æ–°æ—§æœåŠ¡è¡Œä¸ºä¸€è‡´æ€§çš„é—®é¢˜ã€‚\nåœºæ™¯æè¿° # ç°æœ‰ä¸€ä¸ª python å¼€å‘çš„ gRPC å¾®æœåŠ¡æä¾›äº†ä¸€äº› æ•°æ®æŸ¥è¯¢ æ¥å£ ä¾› ä¸Šå±‚åº”ç”¨ä½¿ç”¨ï¼Œéšç€ä¸šåŠ¡æµé‡çš„å¢åŠ è¿ç»´è¿™ä¸ªæœåŠ¡çš„æˆæœ¬ä¹Ÿé€æ¸å¢åŠ ï¼Œä¸ºäº†é™ä½è¿ç»´æˆæœ¬å’Œæé«˜æ€§èƒ½ (æœ¨æœ‰æ“…é•¿ python é«˜æ€§èƒ½çš„å¼€å‘)ï¼Œå› æ­¤é€‰æ‹©äº†ä½¿ç”¨ go è¯­è¨€å¯¹è¿™ä¸ªæœåŠ¡è¿›è¡Œé‡å†™ã€‚åœ¨å¼€å‘å®Œæˆä¹‹åï¼Œéœ€è¦å¯¹æ–°æœåŠ¡çš„ gRPC æ¥å£è¿›è¡ŒéªŒè¯ã€‚\nè¿™ç§åœºæ™¯å¯¹æµ‹è¯•å¼€å‘äººå‘˜æ¥è¯´ï¼Œå®åœ¨æ˜¯å¤ªç†Ÿæ‚‰äº†å§ï¼Ÿå…¸å‹çš„ é‡æ”¾éªŒè¯ï¼Œé©¬ä¸Šèƒ½æƒ³åˆ°çš„éªŒè¯æ‰‹æ®µå°±æ˜¯ï¼š\nå¦‚æœæœ‰å­˜é‡çš„å•å…ƒæµ‹è¯•ï¼Œé‚£ä¹ˆç›´æ¥é‡æ–°è·‘ä¸€éå•å…ƒæµ‹è¯•å°±èƒ½å¿«é€Ÿçš„å®ŒæˆéªŒè¯ã€‚ æ²¡æœ‰å•å…ƒæµ‹è¯•çš„æƒ…å†µï¼Œé‚£ä¹ˆå¯ä»¥å°†æ–°æœåŠ¡éƒ¨ç½²èµ·æ¥ï¼Œé€šè¿‡æµé‡å¤åˆ¶çš„æ–¹å¼å°†æ—§æœåŠ¡çš„æµé‡å¤åˆ¶åˆ°æ–°æœåŠ¡ä¸Šï¼Œç„¶åå¯¹æ¯”ä¸¤ä¸ªæœåŠ¡çš„è¿”å›ç»“æœæ˜¯å¦ä¸€è‡´ã€‚ flowchart LR %% å®šä¹‰å¸ƒå±€æ–¹å‘å’Œé—´è· subgraph s1[\"æ–¹æ¡ˆä¸€: å•å…ƒæµ‹è¯•éªŒè¯\"] direction TB UT[å•å…ƒæµ‹è¯•] --\u003e|æ‰§è¡Œ| NS1[æ–°æœåŠ¡] end subgraph s2[\"æ–¹æ¡ˆäºŒ: æµé‡å¤åˆ¶éªŒè¯\"] direction TB C[å®¢æˆ·ç«¯] --\u003e|è¯·æ±‚| OS[æ—§æœåŠ¡] OS --\u003e|å“åº”| C OS --\u003e|å¤åˆ¶æµé‡| NS2[æ–°æœåŠ¡] NS2 --\u003e|å¯¹æ¯”å“åº”| OS end %% è®¾ç½®å¸ƒå±€æ–¹å‘å’Œå¯¹é½æ–¹å¼ s1 ~~~ s2 ä½†æ˜¯å¾ˆé—æ†¾ ğŸ˜­ï¼Œå¹¶æ²¡æœ‰æˆç†Ÿçš„å•å…ƒæµ‹è¯•ï¼›æµ‹è¯•äººå‘˜ä¹Ÿéƒ½æ˜¯äººè‚‰æµ‹è¯•ï¼Œå¯¹äºå†…éƒ¨æœåŠ¡çš„æ¥å£éªŒè¯å¸®åŠ©ä¸å¤§ï¼Œå› æ­¤è¿™é‡Œé‡‡ç”¨ç¬¬äºŒç§æ–¹å¼è¿›è¡ŒéªŒè¯ã€‚\næœåŠ¡å‡é‡‡ç”¨ Kubernetes éƒ¨ç½²ã€‚\næ–¹æ¡ˆä»‹ç» # HTTP æµé‡çš„å¤åˆ¶é‡æ”¾å·¥å…·å°±å¾ˆå¤šå¾ˆæˆç†Ÿäº†ï¼Œè€Œä¸”å¾€å¾€åœ¨ ç½‘å…³/ä»£ç† ä¸€ä¾§å°±èƒ½å®ç°æµé‡å¤åˆ¶ç”šè‡³å¯¹æ¯”ã€‚\nå·¥å…· åˆ†ç±» æ–‡æ¡£é“¾æ¥ Nginx mirror ç½‘å…³/ä»£ç† https://nginx.org/en/docs/http/ngx_http_mirror_module.html APISIX ç½‘å…³/ä»£ç† https://apisix.apache.org/docs/apisix/plugins/proxy-mirror/ Istio: Virtual Service mirror Service Mesh https://istio.io/latest/docs/tasks/traffic-management/mirroring/ GoReplay æµé‡é•œåƒ https://github.com/buger/goreplay tcpcopy æµé‡é•œåƒ https://github.com/session-replay-tools/tcpcopy tcpcopy ç›¸æ¯”äºå…¶ä»–å·¥å…·æ–¹æ¡ˆï¼Œè™½ç„¶ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œä½†æ˜¯å…¶ä½œç”¨äº TCP ä¼ è¾“å±‚ï¼ŒåŠŸèƒ½ä¼šæ›´ä¸°å¯Œã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒgRPC æµé‡å¤åˆ¶å·¥å…·å°±æ²¡æœ‰é‚£ä¹ˆæˆç†Ÿäº†ã€‚\nç”±äºè¿™é‡Œæ˜¯ä¸€ä¸ª Kubernetes gRPC å¾®æœåŠ¡ï¼Œå¯ä»¥æƒ³åˆ°çš„å°±æ˜¯ä½¿ç”¨ sidecar å®¹å™¨çš„æ–¹å¼æ¥å®ç°æµé‡é•œåƒï¼Œå¹¶è®°å½•åˆ°æœ¬åœ°æ–‡ä»¶ä¸­ï¼Œç„¶åé€šè¿‡å¯¹æ¯”è„šæœ¬æ¥å¯¹æ¯”æ–°æ—§æœåŠ¡çš„å“åº”å†…å®¹ã€‚\nMirror and Compare flow Kubernetes ä¸­çš„ sidecar # Kubenetes ä¸­çš„ sidecar æ˜¯æŒ‡åœ¨åº”ç”¨å®¹å™¨ä¹‹å¤–ï¼Œéƒ¨ç½²ä¸€ä¸ªç‹¬ç«‹çš„å®¹å™¨ï¼Œç”¨äºå¤„ç†åº”ç”¨å®¹å™¨çš„è¯·æ±‚å’Œå“åº”ã€‚sidecar å®¹å™¨å’Œåº”ç”¨å®¹å™¨å…±äº«åŒä¸€ä¸ªç½‘ç»œå‘½åç©ºé—´ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ localhost æ¥è¿›è¡Œé€šä¿¡ã€‚\nå› æ­¤ä¸ç®¡æ˜¯ä½¿ç”¨ Istio è¿˜æ˜¯ grpcreplayï¼Œéƒ½éœ€è¦åœ¨åº”ç”¨å®¹å™¨ä¹‹å¤–éƒ¨ç½²ä¸€ä¸ª sidecar å®¹å™¨ã€‚åªä¸è¿‡ä¸¤ä¸ªå®¹å™¨çš„ä½œç”¨åŸç†ä¸ç›¸åŒï¼Œgrpcreplay ä¸€ä¸ªæ˜¯é€šè¿‡å—…æ¢ç½‘ç»œåè®®æ ˆä¸Šçš„ gRPC æµé‡ï¼Œå°†è¿™éƒ¨åˆ†æ•°æ®æŠ¥æ–‡è§£æå†ä½¿ç”¨ï¼›è€Œ Istio åˆ™æ˜¯æ¥ç®¡äº†åº”ç”¨å®¹å™¨çš„è¯·æ±‚å’Œå“åº”ï¼Œç„¶åå°†æµé‡å¤åˆ¶åˆ°æ–°çš„æœåŠ¡ä¸Šã€‚\ngrpcreplay ç®€ä»‹ # grpcreplay æ˜¯ä¸€æ¬¾å¼€æºçš„ gRPC æµé‡è§£æå’Œé‡æ”¾å·¥å…·ï¼Œå®ƒç±»ä¼¼äº goreplay éƒ½æ˜¯é€šè¿‡æŠ“åŒ…å®ç°æµé‡çš„å¤åˆ¶ï¼Œè€Œä¸æ˜¯ä»£ç†çš„æ–¹å¼ã€‚å¦å¤–å®ƒè¿˜æ”¯æŒå¤šç§è¾“å…¥è¾“å‡ºï¼ŒåŒ…æ‹¬æ–‡ä»¶ã€ç½‘å¡ã€æ¶ˆæ¯é˜Ÿåˆ—ã€æ ‡å‡†è¾“å…¥è¾“å‡ºç­‰ã€‚å½“ç„¶ä¹Ÿæœ‰ä¸€äº›é™åˆ¶:\nç›®å‰æ”¯æŒåˆ° h2c æš‚ä¸æ”¯æŒ h2 åºåˆ—åŒ–å™¨æ”¯æŒ protobuf ä¸æ”¯æŒ Streaming h2c æŒ‡çš„æ˜¯ HTTP/2 over TCPï¼Œh2 æŒ‡çš„æ˜¯ HTTP/2 over TLS/SSLã€‚\ngrpcr help message $ grpcreplay -h ______ ____ ____ ______ ____ / ____// __ \\ / __ \\ / ____// __ \\ / / __ / /_/ // /_/ // / / /_/ / / /_/ // _, _// ____// /___ / _, _/ \\____//_/ |_|/_/ \\____//_/ |_| Usage of grpcreplay: -codec string (default \u0026#34;simple\u0026#34;) -exit-after duration exit after specified duration -include-filter-method-match string filter requests when the method matches the specified regular expression -input-file-directory value grpcr --input-file-directory=\u0026#34;/tmp/mycapture\u0026#34; --output-grpc=\u0026#34;grpc://xx.xx.xx.xx:35001â€œ (default []) -input-file-read-depth int (default 100) -input-file-replay-speed float (default 1) -input-raw value Capture traffic from given port (use RAW sockets and require *sudo* access): # Capture traffic from 80 port grpcr --input-raw=\u0026#34;0.0.0.0:80\u0026#34; --output-grpc=\u0026#34;grpc://xx.xx.xx.xx:35001\u0026#34; (default []) -input-rocketmq-access-key string -input-rocketmq-group-name string (default \u0026#34;fakeGroupName\u0026#34;) -input-rocketmq-name-server value grpcr --input-rocketmq-name-server=\u0026#34;192.168.2.100:9876\u0026#34; --output-grpc=\u0026#34;grpc://xx.xx.xx.xx:35001\u0026#34; (default []) -input-rocketmq-secret-key string -input-rocketmq-topic string (default \u0026#34;test\u0026#34;) -output-file-directory value Write incoming requests to file: grpcr --input-raw=\u0026#34;0.0.0.0:80\u0026#34; --output-file-directory=\u0026#34;/tmp/mycapture\u0026#34; (default []) -output-file-max-age int MaxAge is the maximum number of days to retain old log files based on the timestamp encoded in their filename (default 30) -output-file-max-backups int MaxBackups is the maximum number of old log files to retain. (default 10) -output-file-max-size int MaxSize is the maximum size in megabytes of the log file before it gets rotated. (default 500) -output-grpc value Forwards incoming requests to given grpc address. # Redirect all incoming requests to xxx.com address grpcr --input-raw=\u0026#34;0.0.0.0:80\u0026#34; --output-grpc=\u0026#34;grpc://xx.xx.xx.xx:35001\u0026#34;) (default []) -output-grpc-worker-number int multiple workers call services concurrently (default 5) -output-rocketmq-access-key string -output-rocketmq-name-server value grpcr --input-raw=\u0026#34;0.0.0.0:80\u0026#34; --output-rocketmq-name-server=\u0026#34;192.168.2.100:9876\u0026#34; (default []) -output-rocketmq-secret-key string -output-rocketmq-topic string (default \u0026#34;test\u0026#34;) -output-stdout Just prints data to console -rate-limit-qps int the capture rate per second limit for Query (default -1) -record-response record response -version print version å®è·µ1: grpcreplay sidecar # æƒ³è¦æŠŠ grpcreplay æƒ³è¦ä½œä¸º sidecar å®¹å™¨éƒ¨ç½²åœ¨ Kubernetes ä¸­ï¼Œè¿™é‡Œéœ€è¦åšçš„å·¥ä½œæœ‰ï¼š\ngrpcreplay é•œåƒæ‰“åŒ…å¹¶æ¨é€åˆ°é•œåƒä»“åº“ æ·»åŠ  PVC ä»¥å­˜å‚¨ grpcreplay çš„æµé‡æ•°æ® ä¿®æ”¹æ–°æ—§æœåŠ¡çš„ Deployment ä»¥é…ç½® sidecar å®¹å™¨ã€‚ æ¶æ„è®¾è®¡ # å›¾ä»¥è”½ä¹‹ï¼š\næ¶æ„æè¿° é•œåƒæ‰“åŒ… # æå‰å°† grpcreplay æºç ä¸‹è½½åˆ°æœ¬åœ°ï¼Œç„¶åç¼–å†™ Dockerfile è¿›è¡Œæ„å»ºã€‚\nFROM golang:1.23.6 AS builder WORKDIR /go/src/github.com/vearne/grpcreplay/ COPY . /go/src/github.com/vearne/grpcreplay/ # å®‰è£…ä¾èµ– RUN apt-get update \u0026amp;\u0026amp; apt-get install -y libpcap-dev RUN go get # æ„å»ºåº”ç”¨ RUN CGO_ENABLED=1 go build -ldflags \u0026#34;-s -w\u0026#34; -o grpcr # ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºå‡å°é•œåƒå¤§å° FROM debian:bookworm-slim # å®‰è£…è¿è¡Œæ—¶ä¾èµ– RUN apt-get update \u0026amp;\u0026amp; \\ apt-get install -y libpcap0.8 \u0026amp;\u0026amp; \\ apt-get clean \u0026amp;\u0026amp; \\ rm -rf /var/lib/apt/lists/* WORKDIR /app # ä»æ„å»ºé˜¶æ®µå¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶ COPY --from=builder /go/src/github.com/vearne/grpcreplay/grpcr /app/ # è®¾ç½®å®¹å™¨å…¥å£ç‚¹ ENTRYPOINT [\u0026#34;/app/grpcr\u0026#34;] # æ„å»ºé•œåƒ podman build --platform linux/amd64 --rm -t grpcr -f Dockerfile . # ä¿®æ”¹é•œåƒæ ‡ç­¾ podman tag grpcr yeqown/grpcr:v0.2.6 # æ¨é€åˆ° hub.docker.com é•œåƒä»“åº“ https://hub.docker.com/repository/docker/yeqown/grpcr podman push yeqown/grpcr:v0.2.6 æ·»åŠ  PVC # è¿™é‡Œä»…ä¾›å‚è€ƒï¼Œä¹Ÿä¸æ˜¯å¿…è¦çš„æ­¥éª¤ï¼Œåªè¦èƒ½ç»™ POD æŒ‚è½½ä¸€ä¸ª PV å³å¯ã€‚\napiVersion: v1 kind: PersistentVolumeClaim metadata: name: grpc-capture-pvc spec accessModes: - ReadWriteMany # å¤šä¸ªPodéœ€è¦åŒæ—¶è®¿é—® resources: requests: storage: 10Gi storageClassName: YOUR_STORAGE_CLASS_NAME # æ›¿æ¢ä¸ºä½ çš„å­˜å‚¨ç±»åç§° é…ç½® Sidecar: grpcreplay # é…ç½®æ–°æ—§æœåŠ¡çš„ Deployment æ–‡ä»¶ä»¥é…ç½® sidecar å®¹å™¨ã€‚åŒæ ·çš„è¿™é‡Œä»¥å®é™…æƒ…å†µä¸ºå‡†\næ—§æœåŠ¡ï¼š\napiVersion: apps/v1 kind: Deployment metadata: name: old-grpc labels: app: old-grpc spec: replicas: 1 selector: matchLabels: app: old-grpc template: metadata: labels: app: old-grpc spec: containers: - name: old-grpc image: your-registry/old-grpc:latest ports: - containerPort: 50051 # gRPCæœåŠ¡ç«¯å£ + # grpcreplay sidecarå®¹å™¨ + - name: grpcreplay + image: docker.io/yeqown/grpcr:v0.2.6 + securityContext: + capabilities: + add: [\u0026#34;NET_ADMIN\u0026#34;, \u0026#34;NET_RAW\u0026#34;] # éœ€è¦è¿™äº›æƒé™æ¥æ•è·ç½‘ç»œæµé‡ + args: + - \u0026#34;--input-raw=0.0.0.0:50051\u0026#34; + - \u0026#34;--output-grpc=grpc://new-grpc:50051\u0026#34; + - \u0026#34;--output-file-directory=/capture/server\u0026#34; + - \u0026#34;--record-response\u0026#34; + - \u0026#34;--codec=json\u0026#34; + volumeMounts: + - name: capture-volume + mountPath: /capture/server + volumes: + - name: capture-volume + persistentVolumeClaim: + claimName: grpc-capture-pvc æ–°æœåŠ¡ï¼š\napiVersion: apps/v1 kind: Deployment metadata: name: new-grpc labels: app: new-grpc spec: replicas: 1 selector: matchLabels: app: new-grpc template: metadata: labels: app: new-grpc spec: containers: - name: new-grpc image: your-registry/new-grpc:latest ports: - containerPort: 50051 # gRPCæœåŠ¡ç«¯å£ + # grpcreplay sidecarå®¹å™¨ï¼ˆå¯é€‰ï¼Œç”¨äºè®°å½•è¯·æ±‚å’Œå“åº”ï¼‰ + - name: grpcreplay + image: docker.io/yeqown/grpcr:v0.2.6 + securityContext: + capabilities: + add: [\u0026#34;NET_ADMIN\u0026#34;, \u0026#34;NET_RAW\u0026#34;] + args: + - \u0026#34;--input-raw=0.0.0.0:50051\u0026#34; + - \u0026#34;--output-stdout\u0026#34; + - \u0026#34;--output-file-directory=/capture/mirror\u0026#34; + - \u0026#34;--record-response\u0026#34; + - \u0026#34;--codec=json\u0026#34; + volumeMounts: + - name: capture-volume + mountPath: /capture/mirror + + volumes: + - name: capture-volume + persistentVolumeClaim: + claimName: grpc-capture-pvc æœåŠ¡å¯åŠ¨åï¼Œä¼šåœ¨ /capture/server å’Œ /capture/mirror ç›®å½•ä¸‹ç”Ÿæˆ grpcreplay çš„æµé‡æ•°æ®ã€‚\ngrpcreplay æµé‡æ•°æ® è¸©å‘è®°å½• # ä½¿ç”¨ grpcreplay ä½œä¸º sidecar å®¹å™¨éƒ¨ç½²åœ¨ Kubernetes ä¸­åï¼Œç»è¿‡ä¸€æ®µæ—¶é—´åï¼Œå‘ç°è®°å½•çš„æ–‡ä»¶ä¼šå‡ºç°å¦‚ä¸‹çš„æƒ…å†µï¼š\nå•è¡Œæ•°æ®ä¸å®Œæ•´ï¼ŒJSON æ— æ³•è§£æ Response è®°å½•å’Œæ–¹æ³•ä¸åŒ¹é…ï¼Œå¦‚ï¼šè¯·æ±‚ Method1 ä½†æ˜¯è®°å½•çš„ Response ç¡®å® gRPC å¥åº·æ£€æŸ¥çš„å“åº” æŸäº›è®°å½• Request ä¸ºç©ºï¼Œå®é™…ä¸Šè¯¥è¯·æ±‚å¹¶ä¸ä¸ºç©ºã€‚ å¯¼è‡´å¯¹æ¯”æ— æ³•è¿›è¡Œï¼Œä¼šå‡ºç°è¯¯åˆ¤çš„æƒ…å†µã€‚\nå¤§æ¦‚ç‡æ˜¯ grpcreplay æœ¬èº«é‡‡é›†å†™å…¥çš„é—®é¢˜ï¼Œè¿™é‡Œå†æ²¡æœ‰è¿›ä¸€æ­¥æ·±å…¥è¿½æŸ¥ã€‚\nå®è·µ2: Istio VirtualService mirror # Istio æ˜¯ä¸€ä¸ªéå¸¸æˆç†Ÿçš„ Service Mesh è§£å†³æ–¹æ¡ˆï¼Œå®ƒå¯ä»¥åœ¨ä¸ä¿®æ”¹åº”ç”¨ä»£ç çš„æƒ…å†µä¸‹ï¼Œå¯¹ gRPC æµé‡è¿›è¡Œé•œåƒå’Œé‡æ”¾ã€‚åªéœ€è¦ä¸ºæœåŠ¡é…ç½®å¥½ VirtualService mirror è§„åˆ™å³å¯ã€‚\nå­—æ®µ è·¯å¾„å±‚çº§ æè¿° mirror spec.http[].mirror æŒ‡å®šè¦é•œåƒçš„ç›®æ ‡æœåŠ¡ã€‚ mirrorPercentage spec.http[].mirrorPercentage æŒ‡å®šè¦é•œåƒçš„æµé‡ç™¾åˆ†æ¯”ã€‚ å¤åˆ¶æµé‡ä¹‹åï¼Œè¿™ä¸ªæ–¹æ¡ˆè¿˜éœ€è¦è·å– gRPC æœåŠ¡çš„å“åº”å†…å®¹ï¼Œè®°å½•åˆ°æœ¬åœ°æ–‡ä»¶ä¸­ï¼Œç„¶åé€šè¿‡å¯¹æ¯”è„šæœ¬æ¥å¯¹æ¯”æ–°æ—§æœåŠ¡çš„å“åº”å†…å®¹ã€‚è¿™é‡Œå¯ä»¥è€ƒè™‘å®ç° Istio çš„æ’ä»¶å»è®°å½•ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©åœ¨æœåŠ¡ä¸­æ·»åŠ  gRPC æ‹¦æˆªå™¨æ¥å®ç°è®°å½•ã€‚\né…ç½®æºæœåŠ¡ VirtualService # è¿™é‡Œä¸º old-grpc æœåŠ¡é…ç½® VirtualServiceã€‚\napiVersion: networking.istio.io/v1beta1 kind: Gateway metadata: name: istio-gateway namespace: xxx spec: selector: istio: ingressgateway servers: - hosts: - old-grpc.xxx.com port: name: grpc number: 443 protocol: GRPC --- apiVersion: networking.istio.io/v1 kind: VirtualService metadata: name: old-grpc spec: hosts: - old-grpc.default.svc.cluster.local - old-grpc.xxx.com gateways: - xxx/istio-gateway http: - route: - destination: host: old-grpc.default.svc.cluster.local port: number: 50051 weight: 100 mirror: host: new-grpc.default.svc.cluster.local mirrorPercentage: value: 100 è¸©å‘è®°å½• # â€¼ï¸ è¿™é‡Œåœ¨å®è·µè¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜æ˜¯ï¼šä½¿ç”¨äº† AWS çš„ ALB ä½œä¸º Ingress Load Balancerï¼Œold-grpc åŸå§‹æš´éœ²äº† old-grpc.xxx.com çš„ä¸€ä¸ªå¯¹å¤–æœåŠ¡çš„åŸŸåï¼Œåœ¨å°†è¯¥ ingress çš„ backend åˆ‡æ¢åˆ° istio-ingressgateway ä¹‹åï¼Œè¯·æ±‚å¼‚å¸¸ (è¯·æ±‚å“åº”çŠ¶æ€ç ï¼š UNIMPLEMENTED)ã€‚\nIstio ingressgateway Issue ä»ä¸Šå›¾å¯ä»¥å‘ç°ï¼Œingressgateway æœªèƒ½æ­£ç¡®çš„å°†è¯·æ±‚è½¬å‘åˆ°å¯¹åº”çš„åç«¯æœåŠ¡ï¼ˆService = Unkonwnï¼‰ æ‰€æœ‰çš„è¯·æ±‚å…¨éƒ½å¤±è´¥äº†ï¼Œè¿™é‡Œçš„é—®é¢˜æ˜¯ï¼š\nåŸæœ¬ ALB å¤„çš„é…ç½®æ˜¯æŒ‰ç…§ HTTP(s) é…ç½®çš„ï¼Œè½¬å‘åˆ°äº† ingressgateway çš„ 80 ç«¯å£ï¼Œè€Œ ingressgateway çš„ 80 ç«¯å£é…ç½®ä¸ºå¤„ç† HTTP æµé‡ã€‚ istio ingressgateway å¯èƒ½å­˜åœ¨æ— æ³•è‡ªåŠ¨è¯†åˆ«æµé‡çš„æƒ…å†µï¼Œéœ€è¦æ˜¾ç¤ºçš„é…ç½® gRPC åè®®ã€‚ ç¬¬ä¸€ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šå°† ingress è½¬å‘ç«¯å£ä» 80 æ”¹ä¸º 443ã€‚åŒæ—¶éœ€è¦æ³¨æ„ AWS è½¬å‘è¿‡æ¥çš„æµé‡ä¹Ÿéœ€è¦åœ¨ ingress ä¸­æ·»åŠ æ³¨è§£ alb.ingress.kubernetes.io/backend-protocol-version: \u0026quot;GRPC\u0026quot;\nAWS ALB Ingress ä»£ç† gPRC æµé‡\nç¬¬äºŒä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šservice æ˜¾å¼çš„é…ç½®ä¸º gRPC åè®®ã€‚port name æ”¹ä¸ºï¼šprotocol[-suffix] æ ¼å¼ï¼Œæˆ–è€…åœ¨ kubernetes 1.18+ ç‰ˆæœ¬ä¸­ç›´æ¥ä½¿ç”¨ appProtocol å­—æ®µã€‚å¦‚ä¸‹ï¼š\napiVersion: v1 kind: Service metadata: name: old-grpc namespace: xxx spec: selector: app: old-grpc ports: - name: grpc-xxx # æ˜¾ç¤ºçš„é…ç½®ä¸º gRPC åè®® appProtocol: grpc # æ˜¾å¼çš„é…ç½®ä¸º gRPC åè®®ï¼Œè¿™ä¸ªé…ç½®çš„ä¼˜å…ˆçº§æ›´é«˜ port: 50051 protocol: TCP Istio å¦‚ä½•è¯†åˆ«æµé‡åè®®\nç¼–å†™ gPRC interceptor # å„ä¸ªè¯­è¨€è¦å®ç° gRPC æ‹¦æˆªå™¨çš„æ–¹å¼éƒ½ä¸å°½ç›¸åŒï¼Œä½†éƒ½å¤§å·®ä¸å·®ï¼Œè¿™é‡Œä»¥ python è¯­è¨€ä¸ºä¾‹ï¼š\nPS: ä¸ºå•¥ç”¨ python ä¸¾ä¾‹ï¼Ÿå¯¹æˆ‘æ¥è¯´ï¼Œå®ƒæ˜¯çœŸæŠ½è±¡ï½\nfrom grpc_interceptor import ServerInterceptor class RecordReqRespInterceptor(ServerInterceptor): \u0026#34;\u0026#34;\u0026#34; Interceptor to record request and response information. Usage: server = grpc.server( ThreadPoolExecutor(max_workers=5), interceptors=[RecordReqRespInterceptor(store_directory)]) \u0026#34;\u0026#34;\u0026#34; fd = None store_directory = None # /capture/server/capture.log _lock = threading.Lock() # æ·»åŠ çº¿ç¨‹é” def __init__(self, store_directory=None): if not store_directory: __LOGGER__.warning( \u0026#34;Warning: store_directory is not specified, request and response information will not be recorded.\u0026#34;) return filename = store_directory + \u0026#34;capture.log\u0026#34; try: self.store_directory = filename self.fd = open(filename, \u0026#39;a\u0026#39;) except Exception as e: __LOGGER__.error(f\u0026#34;Failed to open file {store_directory}: {e}\u0026#34;) def record(self, call_detail: CallDetails, error: str = None): if self.fd is None or self.store_directory is None: return # ä»handler_call_detailsä¸­æå–åŸºæœ¬ä¿¡æ¯ method = call_detail.method if method in [ \u0026#34;/grpc.health.v1.Health/Check\u0026#34;, \u0026#34;/grpc.reflection.v1.ServerReflection/ServerReflectionInfo\u0026#34;, \u0026#34;/grpc.reflection.v1alpha.ServerReflection/ServerReflectionInfo\u0026#34;, ]: return metadata = dict(call_detail.invocation_metadata) timestamp_nano = time.time_ns() timestamp_seconds = int(timestamp_nano / 1000000000) req_body = json.dumps(MessageToDict(call_detail.request), separators=(\u0026#39;,\u0026#39;, \u0026#39;:\u0026#39;)) resp_body = json.dumps(MessageToDict(call_detail.response), separators=(\u0026#39;,\u0026#39;, \u0026#39;:\u0026#39;)) # æ„å»ºè®°å½• record = { \u0026#34;method\u0026#34;: method, \u0026#34;request\u0026#34;: { \u0026#34;headers\u0026#34;: metadata, \u0026#34;body\u0026#34;: req_body, }, \u0026#34;response\u0026#34;: { \u0026#34;headers\u0026#34;: { \u0026#34;failed\u0026#34;: error is not None, \u0026#34;error\u0026#34;: error if error else \u0026#34;\u0026#34;, }, \u0026#34;body\u0026#34;: resp_body, } } try: with self._lock: # ä½¿ç”¨é”ä¿è¯å†™å…¥åŸå­æ€§ self.fd.write(json.dumps(record) + \u0026#39;\\n\u0026#39;) self.fd.flush() except Exception as e: __LOGGER__.error(f\u0026#34;Failed to write to file {self.store_directory}: {e}\u0026#34;) # å®ç° ServerInterceptor æŠ½è±¡æ–¹æ³• def intercept( self, method: Callable, request_or_iterator: Any, context: grpc.ServicerContext, method_name: str, ): response = method(request_or_iterator, context) self.record(CallDetails(method_name, context, request_or_iterator, response)) return response å¯¹æ¯”è„šæœ¬ # capture.log ä¸­çš„ä¿å­˜æ¯ä¸€æ¡è®°å½• JSON ç»“æ„å¦‚ä¸‹ï¼š\n{ \u0026#34;method\u0026#34;: \u0026#34;/pbpkg.Service/Method\u0026#34;, \u0026#34;request\u0026#34;: { \u0026#34;headers\u0026#34;: { \u0026#34;:authority\u0026#34;: \u0026#34;10.90.74.23:50051\u0026#34;, \u0026#34;:method\u0026#34;: \u0026#34;POST\u0026#34;, \u0026#34;:path\u0026#34;: \u0026#34;/pbpkg.Service/Method\u0026#34;, \u0026#34;:scheme\u0026#34;: \u0026#34;http\u0026#34;, \u0026#34;content-type\u0026#34;: \u0026#34;application/grpc\u0026#34;, \u0026#34;grpc-accept-encoding\u0026#34;: \u0026#34;gzip\u0026#34;, \u0026#34;te\u0026#34;: \u0026#34;trailers\u0026#34;, \u0026#34;user-agent\u0026#34;: \u0026#34;grpc-go/1.61.0\u0026#34; }, \u0026#34;body\u0026#34;: \u0026#34;\u0026lt;ignored data string\u0026gt;\u0026#34; }, \u0026#34;response\u0026#34;: { \u0026#34;headers\u0026#34;: { \u0026#34;:status\u0026#34;: \u0026#34;200\u0026#34;, \u0026#34;content-type\u0026#34;: \u0026#34;application/grpc\u0026#34;, \u0026#34;grpc-message\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;grpc-status\u0026#34;: \u0026#34;0\u0026#34; }, \u0026#34;body\u0026#34;: \u0026#34;\u0026lt;ignored data string\u0026gt;\u0026#34; } } JSON ä¸­å·²ç»è¯¦ç»†çš„è®°å½•äº†è¯·æ±‚å’Œå“åº”çš„å†…å®¹ï¼Œæ³¨æ„ä¸€å®šéœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦ä¸€æ¡å”¯ä¸€è¡¨ç¤ºï¼Œæ¯”å¦‚ trace_id æˆ–è€… request_id æ–¹ä¾¿å°†æºæœåŠ¡å™¨å’Œ é•œåƒæœåŠ¡å™¨çš„è¯·æ±‚å“åº”ä¸²è”èµ·æ¥ã€‚è„šæœ¬çš„å¯¹æ¯”é€»è¾‘ä¼ªä»£ç å¦‚ä¸‹ï¼š\ndef parse_capture_log(log_file) -\u0026gt; Record: \u0026#34;\u0026#34;\u0026#34; è§£æ grpcreplay ç”Ÿæˆçš„ capture.log æ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ª Record å¯¹è±¡ \u0026#34;\u0026#34;\u0026#34; records = {} with open(log_file, \u0026#34;r\u0026#34;) as f: for line in f: record = Record.parse_raw(line) records[record.uuid] = record def main(): source_records = parse_capture_log(\u0026#34;capture.source.log\u0026#34;) mirror_records = parse_capture_log(\u0026#34;capture.mirror.log\u0026#34;) for source_record in source_records: mirror_record = mirror_records.get(source_record.uuid) diff = source_record.diff(mirror_record) if diff: # å±•ç¤ºå·®å¼‚ print(f\u0026#34;Request {source_record.uuid} is different:\u0026#34;) print(diff) # ç»Ÿè®¡å¯¹æ¯”ç»“æœï¼šæ€»å…±æœ‰å¤šå°‘æ¡è®°å½•ï¼Œæœ‰å¤šå°‘æ¡è®°å½•ä¸åŒï¼›å¤šå°‘ä¸ª method ä¸åŒï¼›method å„æœ‰å¤šå°‘æ¡è®°å½•ä¸åŒï¼› # ç»Ÿè®¡ method ä¸åŒçš„åŸå› ï¼šè¯·æ±‚å¤´ä¸åŒã€è¯·æ±‚ä½“ä¸åŒã€å“åº”å¤´ä¸åŒã€å“åº”ä½“ä¸åŒï¼› print_summary() è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯åŸå§‹æœåŠ¡å™¨å’Œé•œåƒæœåŠ¡å™¨ä¿å­˜çš„JSONç»“æ„å¯èƒ½å­˜åœ¨å·®å¼‚, æ¯”å¦‚ï¼š\nå­—æ®µçš„åºåˆ—åŒ–é¡ºåºä¸åŒï¼Œå¦‚ï¼š{\u0026quot;a\u0026quot;: 1, \u0026quot;b\u0026quot;: 2} å’Œ {\u0026quot;b\u0026quot;: 2, \u0026quot;a\u0026quot;: 1} å¯¹äºç©ºå€¼çš„ï¼ˆåºåˆ—åŒ–ï¼‰å¤„ç†ä¸åŒï¼Œå¦‚ï¼š{\u0026quot;a\u0026quot;: 1, b: []} å’Œ {\u0026quot;a\u0026quot;: 1} åˆ—è¡¨ç±»å‹çš„é¡ºåºä¸åŒ, å¦‚ï¼š[1, 2, 3] å’Œ [3, 2, 1] è¿™äº›å·®å¼‚éœ€è¦è§†æƒ…å†µè€Œå®šï¼Œæœ‰äº›åœºæ™¯ä¸‹åˆ—è¡¨çš„é¡ºåºå·®å¼‚å°±ä»£è¡¨ä¸¤è€…ä¸åŒï¼Œä½†æ˜¯åœ¨è¿™é‡Œåˆ—è¡¨çš„é¡ºåºå·®å¼‚æ˜¯å¯ä»¥å¿½ç•¥ä¸è®¡çš„ã€‚\nå› æ­¤ï¼Œåœ¨å¯¹æ¯”çš„æ—¶å€™éœ€è¦å°†ä¸¤ä¸ªç»“æ„ä½“è¿›è¡Œæ³›åŒ–ï¼Œæ‰èƒ½å‡†ç¡®åœ°å¯¹æ¯”ä¸¤ä¸ªç»“æ„ä½“æ˜¯å¦ç›¸åŒï¼Œä¸‹é¢å°±ç”¨ä¸€æ®µ python ä»£ç æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ï¼š\ndef normalize_json(obj: Any) -\u0026gt; Any: \u0026#34;\u0026#34;\u0026#34;é€’å½’åœ°è§„èŒƒåŒ– JSON å¯¹è±¡ï¼Œä½¿å…¶å¯ä»¥è¿›è¡Œé¡ºåºæ— å…³çš„æ¯”è¾ƒ Args: obj: è¦è§„èŒƒåŒ–çš„å¯¹è±¡ï¼Œå¯ä»¥æ˜¯å­—å…¸ã€åˆ—è¡¨æˆ–å…¶ä»– JSON æ”¯æŒçš„ç±»å‹ Returns: è§„èŒƒåŒ–åçš„å¯¹è±¡ \u0026#34;\u0026#34;\u0026#34; if isinstance(obj, dict): # å¦‚æœå­—å…¸ä¸ºç©ºï¼Œè¿”å› None if not obj: return None normalized = [(k, normalize_json(v)) for k, v in obj.items()] normalized = [(k, v) for k, v in normalized if v is not None] return sorted(normalized) if normalized else None elif isinstance(obj, list): if not obj: return None normalized = [normalize_json(x) for x in obj] normalized = [x for x in normalized if x is not None] return sorted(normalized) if normalized else None else: return obj def stringify_json(obj: Any) -\u0026gt; Any: \u0026#34;\u0026#34;\u0026#34;å°†è§„èŒƒåŒ–çš„å¯¹è±¡è½¬æ¢å› JSON å¯¹è±¡ Args: obj: è§„èŒƒåŒ–åçš„å¯¹è±¡ï¼Œå¯èƒ½æ˜¯å…ƒç»„åˆ—è¡¨ï¼ˆå­—å…¸ï¼‰æˆ–æ’åºåçš„åˆ—è¡¨ Returns: è½¬æ¢å›åŸå§‹ JSON ç»“æ„çš„å¯¹è±¡ï¼Œå¦‚æœè¾“å…¥ä¸º Noneï¼Œè¿”å›ç©ºå­—å…¸æˆ–ç©ºåˆ—è¡¨ \u0026#34;\u0026#34;\u0026#34; if obj is None: return {} elif isinstance(obj, list): if obj and isinstance(obj[0], tuple): return {k: stringify_json(v) for k, v in obj} return [stringify_json(x) for x in obj] elif isinstance(obj, tuple): return {obj[0]: stringify_json(obj[1])} else: return obj # æµ‹è¯• json1 = \u0026#39;{\u0026#34;a\u0026#34;: [2, 1], \u0026#34;b\u0026#34;: {\u0026#34;x\u0026#34;: 1, \u0026#34;y\u0026#34;: 2}}\u0026#39; json2 = \u0026#39;{\u0026#34;a\u0026#34;: [1, 2], \u0026#34;b\u0026#34;: {\u0026#34;y\u0026#34;: 2, \u0026#34;x\u0026#34;: 1}, \u0026#34;c\u0026#34;: []}\u0026#39; normalized1 = normalize_json(json.loads(json1)) normalized2 = normalize_json(json.loads(json2)) print(normalized1) # [(\u0026#39;a\u0026#39;, [1, 2]), (\u0026#39;b\u0026#39;, [(\u0026#39;x\u0026#39;, 1), (\u0026#39;y\u0026#39;, 2)])] print(normalized2) # [(\u0026#39;a\u0026#39;, [1, 2]), (\u0026#39;b\u0026#39;, [(\u0026#39;x\u0026#39;, 1), (\u0026#39;y\u0026#39;, 2)])] restored1 = stringify_json(normalized1) restored2 = stringify_json(normalized2) print(json.dumps(restored1)) # {\u0026#34;a\u0026#34;: [1, 2], \u0026#34;b\u0026#34;: {\u0026#34;x\u0026#34;: 1, \u0026#34;y\u0026#34;: 2}} print(json.dumps(restored2)) # {\u0026#34;a\u0026#34;: [1, 2], \u0026#34;b\u0026#34;: {\u0026#34;x\u0026#34;: 1, \u0026#34;y\u0026#34;: 2}} å¯ä»¥çœ‹åˆ°åŸæœ¬ä¸¤ä¸ªä¸ç›¸åŒçš„JSONå­—ç¬¦ä¸²ï¼Œjson1 å’Œ json2ï¼Œç»è¿‡ normalize_json å‡½æ•°å¤„ç†åï¼Œå¾—åˆ°çš„ç»“æœæ˜¯ç›¸åŒçš„ï¼Œå› æ­¤å¯ä»¥è®¤ä¸ºè¿™ä¸¤ä¸ªJSONå­—ç¬¦ä¸²æ˜¯ç›¸åŒçš„ã€‚\nnormalize_json å‡½æ•°çš„å®ç°æ€è·¯æ˜¯ï¼š\nå¯¹ key è¿›è¡Œæ’åºï¼Œè¾¾åˆ°è®© JSON å½’ä¸€åŒ–çš„ç›®çš„ã€‚æƒ³è¦æ’åºé‚£ä¹ˆæ ¼å¼ä¸€å®šæ˜¯éœ€è¦æ•°ç»„ç±»å‹ï¼Œå› æ­¤è¿™é‡Œå¯¹æ‰€æœ‰çš„ kv é€’å½’å¤„ç†ä¸ºï¼ˆkey, valueï¼‰çš„å…ƒç»„æ ¼å¼ï¼Œå­˜æ”¾ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œå†ä½¿ç”¨ key è¿›è¡Œæ’åºã€‚ è¿‡æ»¤æ‰å…¶ä¸­çš„ç©ºå€¼: ç©ºå€¼å¯¹æ¯”è¾ƒæ²¡æœ‰æ„ä¹‰ã€‚ æ€»ç»“ # æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•åœ¨ Kubernetes ä¸­ä½¿ç”¨ grpcreplay å®ç° gRPC æµé‡é•œåƒã€‚é€šè¿‡ sidecar å®¹å™¨çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å°† grpcreplay éƒ¨ç½²åœ¨æ—§æœåŠ¡å’Œæ–°æœåŠ¡çš„æ—è¾¹ï¼Œä»è€Œå®ç°æµé‡çš„å¤åˆ¶å’Œå¯¹æ¯”ã€‚è¿™ç§æ–¹å¼çš„å¥½å¤„åœ¨äºï¼š\nä¸éœ€è¦ä¿®æ”¹åº”ç”¨ä»£ç ï¼› ç›¸æ¯”äºä»£ç†çš„æ–¹å¼ï¼Œä¸ä¼šå½±å“åº”ç”¨çš„æ€§èƒ½ï¼› å¯ä»¥æ–¹ä¾¿çš„å¯¹æ¯”æ–°æ—§æœåŠ¡çš„å“åº”å†…å®¹çš„å·®å¼‚ï¼› å¦‚æœå½“å‰ç¯å¢ƒä¸­å·²ç»æœ‰ Istio è¿™ç§ service mesh çš„è¯ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ä½¿ç”¨ Virtual Service çš„ mirror é…ç½®æ¥å¿«é€Ÿå®ç°æµé‡å¤åˆ¶ï¼Œå¦å¤–å†åŠ ä¸Šä¸€ä¸ªè¯·æ±‚å’Œå“åº”çš„è®°å½•å™¨ï¼Œå°±å¯ä»¥å®ç°æµé‡çš„å¤åˆ¶å’Œå¯¹æ¯”ã€‚\n"},{"id":8,"href":"/2025/04/24/kafka-mongodb%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE%E7%BA%AA%E8%A6%81/","title":"Kafka + Mongodb é€šä¿¡åè®®çºªè¦","section":"Posts","content":"Kafka å’Œ MongoDB æ˜¯ç›®å‰ä½¿ç”¨æ¯”è¾ƒå¹¿æ³›çš„æ¶ˆæ¯é˜Ÿåˆ—å’Œæ•°æ®åº“ï¼Œåœ¨ä¹‹å‰çš„å¾ˆé•¿æ—¶é—´é‡Œå¯¹è¿™ä¸¤ä¸ªè½¯ä»¶ç³»ç»Ÿçš„ç†è§£éƒ½åœç•™åœ¨æ¦‚å¿µå’Œä½¿ç”¨ä¸Šï¼Œç›´åˆ°æœ€è¿‘é‡åˆ°ä¸€ä¸ªâ€œè¯¡å¼‚â€çš„é—®é¢˜ï¼Œå·²æœ‰çš„ç»éªŒå’Œè°ƒè¯•æ–¹æ³•æ— æ³•å®šä½æ—¶ï¼Œæœ€ç»ˆå°è¯•äº†ä¸‹æŠ“åŒ…åˆ†ææ‰æœ€ç»ˆå®šä½åˆ°é—®é¢˜çš„æ ¹æºã€‚\né—®é¢˜æè¿°ï¼š ä½¿ç”¨ sarama ç¼–å†™äº†ä¸€ä¸ª kafka æ¶ˆè´¹è€…ç»„ï¼Œè¿™é‡Œä¸åŒå¯»å¸¸çš„åœ°æ–¹åœ¨äºï¼šæ‰‹åŠ¨æäº¤ + æ‰¹é‡æ¶ˆè´¹ã€‚é‡åˆ°çš„é—®é¢˜ï¼šæŸäº›åˆ†åŒºæ¶ˆè´¹è¿›åº¦æ— æ³•æˆåŠŸæäº¤ï¼Œä½†æ˜¯æ¶ˆæ¯æ˜¯æ¶ˆè´¹æˆåŠŸçš„ã€‚å‡ºç°è¿™ç§æƒ…å†µçš„åˆ†åŒºæ²¡æœ‰è§„å¾‹ï¼Œè§¦å‘ rebalance å â€œæ•…éšœåˆ†åŒºâ€ æœ‰æ¦‚ç‡ä¼šå‘ç”Ÿå˜åŒ–ã€‚\nåˆ†æ/å®šä½ï¼šè¿™é‡Œå¾ˆæ˜æ˜¾çš„é—®é¢˜åœ¨äºæ‰‹åŠ¨æäº¤ offset ä¸ºä»€ä¹ˆä¸æˆåŠŸï¼Ÿä»å®ç°æ¥è¯´ï¼Œæäº¤ offset çš„é€»è¾‘è·Ÿåˆ†åŒºæ²¡æœ‰å…³ç³»æ˜¯ä¸€è‡´ï¼Œé‚£è¿™ç§ä¸ç¡®å®šæ€§æ•…éšœæ—¶ä»å“ªå„¿æ¥çš„ï¼Ÿè€Œä¸”è¿˜å’Œ rebalance ç›¸å…³ã€‚ æ¢³ç†ä¸‹ kafka å®¢æˆ·ç«¯æ¶ˆè´¹æäº¤æ¶‰åŠåˆ°çš„æ“ä½œï¼šFetch, OffsetCommit, ä½†æ˜¯æ¶ˆè´¹æ˜¯æ­£å¸¸çš„ï¼Œé‚£ä¹ˆåªéœ€è¦æŠ“åŒ…åˆ†æ OffsetCommit å°±å¯ä»¥çŸ¥é“ offset æäº¤å­˜åœ¨ä»€ä¹ˆé—®é¢˜ã€‚\nç»“æœï¼š é€šè¿‡æŠ“åŒ…ä¸€åˆ‡éƒ½æ˜æœ—äº†ï¼šå‡ºç°é—®é¢˜çš„åˆ†åŒºåŒæ—¶æœ‰å¤šä¸ª OffsetCommit è¯·æ±‚ï¼Œä¸”å…¶ä¸­æœ‰çš„è¯·æ±‚æäº¤çš„ offset ä¸€è‡´åœç•™åœ¨ä¸€ä¸ª â€œæ—§çš„â€ ä½ç½®ï¼Œä¸ä¼šæ›´æ–°ï¼Œè¿™æ ·å°±ç¼©å°äº†èŒƒå›´ï¼šç¨‹åºæäº¤ offset é€»è¾‘å¼‚å¸¸ã€‚\nKAFKA åè®® # Kafka åè®®æ˜¯åŸºäº TCP/IP åè®®çš„äºŒè¿›åˆ¶åè®®ã€‚å…¶ç»“æ„ç»„æˆå¦‚ä¸‹ï¼š\nstruct RequestOrResponse { RequestResponseHeader requestResponseHeader; // uint32 messageLength; SpecificRequestOrResponseHeader body; // æ ¼å¼å–å†³äºå…·ä½“çš„è¯·æ±‚å’Œå“åº”ï¼Œæ¯”å¦‚ï¼šRequestV1Header } struct RequestV1Header { int16 apiKey; int16 apiVersion; int32 correlationId; string clientId; } åè®®ç»“æ„ # https://kafka.apache.org/protocol.html#protocol_messages\näºŒè¿›åˆ¶åè®®çš„ç»“æ„å¦‚ä¸‹ï¼š\nRequest V1 Header:\n0 1 2 3 4 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ | message length (total message size) | +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ | request api key | request api version | +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ | correlation_id | +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ | client id length N | | | client_id å ç”¨ N ç©ºé—´çš„ï¼Œè¿™é‡Œä¸ç¡®å®šå…·ä½“çš„é•¿åº¦ | +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ | request extend header | | .................................... | | .................................... | | request extend header | | .................................... | +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ å­—æ®µ æè¿° message length INT32, æ¶ˆæ¯é•¿åº¦ï¼ŒåŒ…æ‹¬æ‰€æœ‰å­—æ®µï¼Œä¸åŒ…æ‹¬æ¶ˆæ¯é•¿åº¦æœ¬èº«ã€‚ request api key INT16 è¯·æ±‚çš„ API é”®ï¼Œç”¨äºæ ‡è¯†è¯·æ±‚çš„ç±»å‹ã€‚ request api version INT16 è¯·æ±‚çš„ API ç‰ˆæœ¬ï¼Œç”¨äºæ ‡è¯†è¯·æ±‚çš„ç‰ˆæœ¬ã€‚ correlation_id INT32 å…³è” IDï¼Œç”¨äºæ ‡è¯†è¯·æ±‚å’Œå“åº”ä¹‹é—´çš„å…³ç³»ã€‚ client id NULLABLE_STRING, å®¢æˆ·ç«¯ ID, æ˜¯ä¸€ä¸ª NULLABLE_STRING NULLABLE_STRING Represents a sequence of characters or null.\nFor non-null strings, first the length N is given as an INT16. Then N bytes follow which are the UTF-8 encoding of the character sequence.\nA null value is encoded with length of -1 and there are no following bytes.\nRequest V2 Header:\n0 1 2 3 4 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ | message length (total message size) | +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ | request api key | request api version | +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ | correlation_id | +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ | client id length N | | | client_id å ç”¨ N ç©ºé—´çš„ï¼Œè¿™é‡Œä¸ç¡®å®šå…·ä½“çš„é•¿åº¦ | +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ | _tagged_fields (ä»…ä¸ºè¯´æ˜è¯¥å€¼ä¼ è¾“ï¼Œå ç”¨ç©ºé—´ä¸ç¡®å®š) | +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ | request extend header | | .................................... | | .................................... | | request extend header | | .................................... | +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ Response V0 Header:\n0 1 2 3 4 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ | message length (total message size) | +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ | correlation_id | +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ å­—æ®µ æè¿° correlation_id UINT32 å…³è” IDï¼Œç”¨äºæ ‡è¯†è¯·æ±‚å’Œå“åº”ä¹‹é—´çš„å…³ç³»ã€‚ Response V1 Header:\n0 1 2 3 4 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ | message length (total message size) | +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ | correlation_id | +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ | _tagged_fields (ä»…ä¸ºè¯´æ˜è¯¥å€¼ä¼ è¾“ï¼Œå ç”¨ç©ºé—´ä¸ç¡®å®š) | +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ è¿™é‡Œ request å’Œ reponse header åˆ†åˆ«æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸”ç›¸å½“äºå‰ä¸€ä¸ªç‰ˆæœ¬ï¼Œåè€…å¢åŠ äº†ä¸€ä¸ª _tagged_fields å­—æ®µï¼Œå…¶æ ¼å¼ä¸ºï¼š\nhttps://cwiki.apache.org/confluence/display/KAFKA/KIP-482%3A+The+Kafka+Protocol+should+Support+Optional+Tagged+Fields\nThe number of tagged fields Field 1 Tag Field 1 Length Field 1 Data Field 2 Tag Field 2 Length Field 2 Data \u0026hellip; UNSIGNED_VARINT UNSIGNED_VARINT UNSIGNED_VARINT \u0026lt;field 1 type\u0026gt; UNSIGNED_VARINT UNSIGNED_VARINT \u0026lt;field 2 type\u0026gt; \u0026hellip; UNSIGNED_VARINT æ˜¯ä¸€ç§å˜é•¿çš„æ— ç¬¦å·æ•´æ•°ç¼–ç æ–¹å¼ï¼Œå‚è€ƒ google protobuf varint å’Œ zig-zag ç¼–ç ã€‚å¦‚æœæ˜¯ tagCount = 0ï¼Œé‚£ä¹ˆè¿™é‡Œåªéœ€è¦ä½¿ç”¨ä¸€ä¸ªå­—èŠ‚è¡¨ç¤º 0x00ã€‚\nAPI è¯·æ±‚å’Œå“åº”ä¸¾ä¾‹ # å…¶ä¸­ request å’Œ response header æ ¼å¼å–å†³äºè¯·æ±‚å’Œå“åº”çš„ç±»å‹ã€‚æ¯”å¦‚ ApiVersion(18) è¯·æ±‚æœ‰ 5 ä¸ªç‰ˆæœ¬ï¼Œå¦‚ä¸‹ï¼š\nAPI Version Based Request Header Version fields 0 1 - 1 1 - 2 1 - 3 2 client_software_name(COMPACT_STRING); client_software_version(COMPACT_STRING); _tagged_fileds 4 2 client_software_name(COMPACT_STRING); client_software_version(COMPACT_STRING); _tagged_fileds å“åº”æœ‰ 4 ä¸ªç‰ˆæœ¬ï¼Œå¦‚ä¸‹ï¼š\nAPI Version Based Response Header Version fields 0 0 {error_code, api_keys[{api_key,min_version,max_version}]} 1 0 {error_code, api_keys[{api_key,min_version,max_version}], throttle_time_ms} 2 0 {error_code, api_keys[{api_key,min_version,max_version}], throttle_time_ms} 3 0 {error_code, api_keys[{api_key,min_version,max_version,_tagged_fields}], throttle_time_ms, _tagged_fields} æ›´å¤šçš„è¯·æ±‚å’Œå“åº” header æ ¼å¼å‚è€ƒï¼šAPI Keys\nåè®®æŠ“åŒ…åˆ†æ # ä¸‹é¢ä½¿ç”¨ wireshark æŠ“åŒ…å¹¶ç»“åˆå‰é¢æåˆ°çš„åè®®å®é™…åˆ†æä¸‹ Kafka åè®®çš„äº¤äº’è¿‡ç¨‹ã€‚å¯åŠ¨ä¸€ä¸ª kafka å®¢æˆ·ç«¯ï¼š\nKafka æŠ“åŒ…ï¼šApiVersions Request Kafka æŠ“åŒ…ï¼šApiVersions Response ä»å›¾ä¸­èƒ½çœ‹åˆ°ç”±äº wireshark è§£æå·²ç»è¶³å¤Ÿå¥½äº†ï¼Œæ‰€ä»¥çœ‹åˆ°çš„ kafka åè®®å­—æ®µå·²ç»å¯è¯»æ€§éå¸¸é«˜äº†ï¼Œç›´æ¥å°±èƒ½å’Œåè®®æ–‡æ¡£ä¸€ä¸€å¯¹åº”èµ·æ¥ã€‚å”¯ä¸€éœ€è¦æ³¨æ„çš„å°±æ˜¯ kafka åè®®çš„ç¼–ç éœ€è¦æ ¹æ®æ–‡æ¡£å’Œå­—æ®µç±»å‹è¿›è¡Œè§£æï¼Œæ¯”å¦‚ NullableString ç±»å‹çš„å­—æ®µéœ€è¦å…ˆè§£æé•¿åº¦ï¼Œç„¶åå†è§£æå­—ç¬¦ä¸²; VARINT éµå¾ªäº†å˜é•¿çš„ zig-zag ç¼–ç ï¼Œå‚è€ƒ Google Protocol Buffers\nZig-zag ç¼–ç è§£é‡Šï¼šhttps://gist.github.com/mfuerstenau/ba870a29e16536fdbaba\nå°ç»“ # ä¸ºäº†æ”¯æŒåè®®çš„å‘åå…¼å®¹æ€§ï¼ŒKafka API æä¾›äº†ç‰ˆæœ¬åŒ–è¯­ä¹‰ å’Œ ApiVersions API æ¥åŠ¨æ€åå•†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šä¿¡åè®®ï¼ˆç‰ˆæœ¬ï¼‰ã€‚å®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡å™¨ä¹‹åéœ€è¦è¯·æ±‚æœåŠ¡ç«¯æ”¯æŒçš„ API ç‰ˆæœ¬èŒƒå›´ï¼Œä»ä¸­é€‰ä¸€ä¸ªä¸¤è¾¹éƒ½æ”¯æŒçš„ç‰ˆæœ¬ã€‚åœ¨å‘é€è¯·æ±‚æ—¶ï¼Œå®¢æˆ·ç«¯æºå¸¦ è¯·æ±‚API çš„ç‰ˆæœ¬ï¼ŒæœåŠ¡å™¨é»˜è®¤ç›¸åŒç‰ˆæœ¬çš„å“åº”æ ¼å¼è¿”å›ï¼Œå¦‚æœå®¢æˆ·ç«¯æºå¸¦äº†ä¸æ”¯æŒçš„ç‰ˆæœ¬ï¼ŒæœåŠ¡å™¨ä¼šå“åº” UNSUPPORTED_VERSION(35) ä»¥æç¤ºå®¢æˆ·ç«¯è°ƒæ•´ç‰ˆæœ¬ã€‚\nåè®®ä¸­å®šä¹‰äº† API Keys æšä¸¾ï¼Œç”¨æ¥è¯´æ˜æœåŠ¡å™¨æ”¯æŒçš„ API æ¸…å•ï¼Œæ¯ä¸ª API éƒ½æœ‰å”¯ä¸€çš„æ ‡è¯†IDï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šè¿‡è¿™ä¸ª ID å¯¹åº”ç‰¹å®šçš„åŠŸèƒ½ï¼Œä¹Ÿç”¨æ¥ç¡®å®šå…·ä½“çš„è¯·æ±‚å’Œå“åº”æ ¼å¼ã€‚\nKafka åè®®é‡‡ç”¨äº†äºŒè¿›åˆ¶ç¼–ç ï¼Œä¸ºæ­¤åè®®ä¸­çº¦å®šäº†ä¸€äº›åŸºç¡€ç±»å‹ï¼Œå¦‚ï¼šBOOLEANï¼ŒINT8, INT16, INT32, INT64, UINT, VARINT, VARLONG, UUID, STRING, COMPACT_STRING ç­‰ç­‰ã€‚\nMongoDB åè®® # MongoDB åè®®æ˜¯ä¸€ä¸ªç®€å•çš„åŸºäº socket çš„è¯·æ±‚å“åº”åè®®ã€‚å®¢æˆ·ç«¯é€šè¿‡ä¸€ä¸ªå¸¸è§„çš„ TCP/IP å¥—æ¥å­—ä¸æ•°æ®åº“æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼ŒæœåŠ¡å™¨é»˜è®¤ç«¯å£ä¸º 27017ï¼Œåè®®é‡‡ç”¨äº†å°ç«¯å­—èŠ‚åºã€‚\næ ‡å‡†æ¶ˆæ¯å¤´ # é€šå¸¸è€Œè¨€ï¼Œæ¯æ¡æ¶ˆæ¯éƒ½æ˜¯æœ‰ä¸€ä¸ªæ ‡å‡†æ¶ˆæ¯å¤´å’Œç´§è·Ÿç€çš„æ•°æ®æ„æˆï¼Œæ ‡å‡†æ¶ˆæ¯å¤´æ ¼å¼å¦‚ä¸‹ï¼š\n0 1 2 3 4 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ | message length (total message size) | +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ | requestID (identifier for this message) | +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ | responseTo (requestID from the origin request) | +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ | opcode (message type) | +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ å…¶ä¸­ OpCode çš„å–å€¼æœ‰å¦‚ä¸‹å‡ ç§ï¼š\næ³¨æ„éšç€ MongoDB ç‰ˆæœ¬çš„å‡çº§ï¼ŒMongoDB å·²ç»ä½¿ç”¨ OP_MSG æ“ä½œç æ¥ç»Ÿä¸€è¯·æ±‚å’Œå“åº”æ ¼å¼ã€‚\nOpCode å€¼ æè¿° OP_COMPRESSED 2011 ä½¿ç”¨å‹ç¼©æ¥æ¥åŒ…è£…å…¶ä»–æ“ä½œç  OP_MSG 2013 ä½¿ç”¨æ ‡å‡†æ ¼å¼å‘é€æ¶ˆæ¯ã€‚ç”¨äºå®¢æˆ·ç«¯è¯·æ±‚å’Œæ•°æ®åº“å›å¤ã€‚ OP_REPLY 1 å“åº”æ¶ˆæ¯ã€‚è‡ª MongoDB 5.0 å¼ƒç”¨ï¼Œ5.1 åˆ é™¤ OP_UPDATE 2001 æ›´æ–°æ¶ˆæ¯ã€‚è‡ª MongoDB 5.0 å¼ƒç”¨ï¼Œ5.1 åˆ é™¤ OP_INSERT 2002 æ’å…¥æ¶ˆæ¯ã€‚è‡ª MongoDB 5.0 å¼ƒç”¨ï¼Œ5.1 åˆ é™¤ RESERVED 2003 ä»¥å‰ç”¨äº OP_GET_BY_OID OP_QUERY 2004 æŸ¥è¯¢æ¶ˆæ¯ã€‚è‡ª MongoDB 5.0 å¼ƒç”¨ï¼Œ5.1 åˆ é™¤ OP_GET_MORE 2005 è·å–æ›´å¤šæ¶ˆæ¯ã€‚è‡ª MongoDB 5.0 å¼ƒç”¨ï¼Œ5.1 åˆ é™¤ OP_DELETE 2006 åˆ é™¤æ¶ˆæ¯ã€‚è‡ª MongoDB 5.0 å¼ƒç”¨ï¼Œ5.1 åˆ é™¤ OP_KILL_CURSORS 2007 æ€æ­»æ¸¸æ ‡æ¶ˆæ¯ã€‚è‡ª MongoDB 5.0 å¼ƒç”¨ï¼Œ5.1 åˆ é™¤ OP_COMPRESSED æ¶ˆæ¯æ ¼å¼ # ä»»ä½•æ“ä½œç éƒ½å¯ä»¥ä½¿ç”¨ OP_COMPRESSED æ¥åŒ…è£…ï¼ŒOP_COMPRESSED æ¶ˆæ¯æ ¼å¼å¦‚ä¸‹ï¼š\nstruct OP_COMPRESSED { MsgHeader header; // æ ‡å‡†æ¶ˆæ¯å¤´ int32 originalOpcode; // åŸå§‹ opcode int32 uncompressedSize; // æœªå‹ç¼©æ¶ˆæ¯å¤§å° uint8 compressorId; // å‹ç¼©å™¨ï¼ˆç®—æ³•ï¼‰çš„æ ‡è¯† char *compressedMessage; // å‹ç¼©åçš„æ¶ˆæ¯ï¼Œä¸åŒ…æ‹¬æ ‡å‡†æ¶ˆæ¯å¤´ } compressorId çš„å–å€¼æœ‰å¦‚ä¸‹å‡ ç§ï¼š\ncompressorId å€¼ æè¿° 0 noop ä¸å‹ç¼© 1 snappy snappy å‹ç¼©ç®—æ³• 2 zlib zlib å‹ç¼©ç®—æ³• 3 zstd zstd å‹ç¼©ç®—æ³• 4-255 ä¿ç•™ ä¿ç•™ OP_MSG æ¶ˆæ¯æ ¼å¼ # OP_MSG æ˜¯ä¸€ç§å¯ä»¥æ‰©å±•çš„æ¶ˆæ¯æ ¼å¼ï¼Œç”¨äºå®¢æˆ·ç«¯è¯·æ±‚å’ŒæœåŠ¡å™¨å“åº”ã€‚å…¶æ ¼å¼å¦‚ä¸‹ï¼š\nstruct OP_MSG { MsgHeader header; // æ ‡å‡†æ¶ˆæ¯å¤´ uint32 flagBits; // æ ‡å¿—ä½ Sections[] sections; // æ•°æ®æ®µ optional\u0026lt;uint32\u0026gt; checksum; // æ ¡éªŒå’Œ CRC-32C } FlagBits\nFlagsBits æ˜¯ä¸€ä¸ª 32 ä½çš„æ— ç¬¦å·æ•´æ•°ï¼Œç”¨æ¥è¯´æ˜ OP_MSG çš„æ ¼å¼å’Œè¡Œä¸ºã€‚å‰ 16 ä½æ˜¯å¿…è¦çš„ï¼Œå¹¶ä¸”å¦‚æœæœ‰æœªçŸ¥ä½è®¾ç½®ï¼Œè§£æå™¨å¿…é¡»è¦æŠ›å‡ºé”™è¯¯ã€‚å16ä½æ˜¯å¯é€‰çš„ï¼Œè§£æå™¨å¿…é¡»å¿½ç•¥ä»»ä½•æœªçŸ¥ä½è®¾ç½®ï¼Œä»£ç†å’Œæ¶ˆæ¯è½¬å‘å™¨å¿…é¡»æ¸…é™¤ä»»ä½•æœªçŸ¥ä½è®¾ç½®ã€‚\nbitä½ å­—æ®µ è¯·æ±‚ å“åº” æè¿° 0 checksumPresent âœ… âœ… è¡¨ç¤ºæ¶ˆæ¯æ˜¯å¦åŒ…å«æ ¡éªŒå’Œ 1 moreToCome âœ… âœ… è¡¨ç¤ºæ˜¯å¦æœ‰æ›´å¤šæ•°æ®æ®µã€‚å¦ä¸€æ¡æ¶ˆæ¯å°†ç´§éšæ­¤æ¶ˆæ¯ä¹‹åï¼Œæ— éœ€æ¥æ”¶æ–¹é‡‡å–è¿›ä¸€æ­¥è¡ŒåŠ¨ã€‚æ¥æ”¶æ–¹åœ¨æ”¶åˆ° moreToCome è®¾ç½®ä¸º 0 çš„æ¶ˆæ¯ä¹‹å‰ï¼Œ ä¸å¾—å‘é€å…¶ä»–æ¶ˆæ¯ï¼Œå¦åˆ™å‘é€å¯èƒ½ä¼šé˜»å¡ï¼Œä»è€Œå¯¼è‡´æ­»é”ã€‚å¸¦æœ‰ moreToCome çš„è¯·æ±‚ ä½è®¾ç½®ä¸ä¼šæ”¶åˆ°å›å¤ã€‚å›å¤åªä¼šåŒ…å«æ­¤ å“åº”è®¾ç½®äº† exhaustAllowed ä½çš„è¯·æ±‚è€Œè®¾ç½®ã€‚ 16 exhaustAllowed âœ… - å®¢æˆ·ç«¯å·²å‡†å¤‡å¥½ä½¿ç”¨ moreToCome ä½å¯¹æ­¤è¯·æ±‚è¿›è¡Œå¤šæ¬¡å›å¤ã€‚é™¤éè¯·æ±‚ä¸­è®¾ç½®äº†æ­¤ä½ï¼Œå¦åˆ™æœåŠ¡å™¨æ°¸è¿œä¸ä¼šç”Ÿæˆè®¾ç½®äº† moreToCome ä½çš„å›å¤ã€‚ Sections\nOP_MSG æ¶ˆæ¯åŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªéƒ¨åˆ†ï¼ˆsectionï¼‰ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½ä»¥ä¸€ä¸ªkind å­—èŠ‚å¼€å¤´ï¼Œkind ç”¨æ¥æŒ‡ç¤ºç±»å‹ã€‚kind ä¹‹åçš„å­—èŠ‚æ„æˆè¯¥éƒ¨åˆ†çš„è½½è·ã€‚\nkind æè¿° 0 Body, body section è¢«ç¼–ç ä¸ºå•ä¸ª BSON å¯¹è±¡ï¼›BSON å¯¹è±¡çš„å­—èŠ‚å¤§å°åœ¨ section å¼€å§‹ä½ç½®ï¼ˆ64ä½ï¼‰ 1 Document Sequence, æ”¯æŒä¼ è¾“å¤šä¸ªæ–‡æ¡£ï¼Œä¼˜åŒ–æ‰¹é‡æ“ä½œã€‚ å…¶åŸºæœ¬ç»“æ„æ˜¯ 2 ä»…å†…éƒ¨ä½¿ç”¨ Body ç±»å‹å¸¸ç”¨äºæ ‡å‡†çš„è¯·æ±‚å’Œå“åº”ä½“ã€‚\nCheckSum\næ¯æ¡æ¶ˆæ¯éƒ½å¯ä»¥é™„å¸¦ CRC-32C æ ¡éªŒå’Œï¼Œç”¨äºéªŒè¯æ¶ˆæ¯çš„å®Œæ•´æ€§ï¼ˆé™¤ checksum è‡ªèº«ï¼‰ã€‚\nåè®®æŠ“åŒ…åˆ†æ # ä¸‹é¢ç”¨ wireshark æŠ“åŒ…å¹¶ç»“åˆå‰é¢æåˆ°çš„åè®®å®é™…åˆ†æä¸‹ MongoDB åè®®çš„äº¤äº’è¿‡ç¨‹ã€‚ä½¿ç”¨ mongosh è¿æ¥åˆ° MongoDB æ•°æ®åº“ï¼Œæ‰§è¡Œä¸€æ¡æŸ¥è¯¢æ‰€æœ‰dbçš„å‘½ä»¤ï¼š\nUsing MongoDB:\t7.0.2 Using Mongosh:\t2.3.2\n$ mongosh \u0026gt; show databases æŠ“åŒ…ç»“æœå¦‚ä¸‹ï¼š\nMongoDB æŠ“åŒ…ï¼šRequest MongoDB æŠ“åŒ…ï¼šResponse wireshark å¯ä»¥æ¸…æ™°çš„çœ‹åˆ° show databases å‘½ä»¤çš„è¯·æ±‚å’Œå“åº”ä½“ã€‚éƒ½åŒ…å«äº†æ ‡å‡†æ¶ˆæ¯å¤´ï¼ˆmessage length, requestID, responseTo, opcodeï¼‰ã€‚å“åº”ä¸­çš„ reponseTo å€¼ç­‰äºå¯¹åº”è¯·æ±‚çš„ requestIDï¼Œè€Œè¯·æ±‚ä¸­çš„ reponseTo å€¼ä¸º 0ï¼Œè¿™ä¹Ÿæ˜¯åŒºåˆ†è¯·æ±‚å’Œå“åº”çš„æ–¹æ³•ã€‚\nåœ¨ OP_MSGï¼ˆopcode = 2013, ä¹Ÿå°±æ˜¯ Extensible Message Formatï¼‰ æ¶ˆæ¯ä½“ä¸­åŒ…å«äº† flagBits, sections ç­‰å­—æ®µï¼Œè€Œ checksum ç”±äº flagBits ä¸­æ²¡æœ‰è®¾ç½®ï¼Œæ‰€ä»¥æ²¡æœ‰åŒ…å«ã€‚\næŒæ¡äº†è¿™äº›åŸºæœ¬æ¦‚å¿µåï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•çš„æ‰‹æ“ä¸€ä¸ªè„šæœ¬ç”¨æ¥è§£æ MongoDB åè®®ï¼ˆ wireshark æ¯•ç«Ÿçœ‹èµ·æ¥ä¸é‚£ä¹ˆç›´è§‚ï¼‰ã€‚æ ¸å¿ƒè§£æä»£ç å¦‚ä¸‹ï¼š\ndef parse_op_msg(self, payload): \u0026#34;\u0026#34;\u0026#34;è§£æ OP_MSG æ¶ˆæ¯æ ¼å¼ OP_MSG æ ¼å¼ (MongoDB 3.6+): struct { MsgHeader header; // æ ‡å‡†æ¶ˆæ¯å¤´, 16 å­—èŠ‚ uint32 flagBits; // æ ‡å¿—ä½ // æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªéƒ¨åˆ† (sections) // æ¯ä¸ªéƒ¨åˆ†ä»¥ä¸€ä¸ªå­—èŠ‚çš„ç±»å‹æ ‡è¯†å¼€å§‹ // ç±»å‹ 0: æ­£æ–‡éƒ¨åˆ† (body section) // ç±»å‹ 1: æ–‡æ¡£åºåˆ—éƒ¨åˆ† (document sequence) } \u0026#34;\u0026#34;\u0026#34; if len(payload) \u0026lt; 20: # å¤´éƒ¨ 16 å­—èŠ‚ + æ ‡å¿—ä½ 4 å­—èŠ‚ return None try: # è§£ææ ‡å¿—ä½ flag_bits = struct.unpack(\u0026#34;\u0026lt;I\u0026#34;, payload[16:20])[0] flags = [] for bit, name in OP_MSG_FLAGS.items(): if flag_bits \u0026amp; (1 \u0026lt;\u0026lt; bit): flags.append(name) result = { \u0026#34;flags\u0026#34;: flags, \u0026#34;sections\u0026#34;: [] } # è§£æéƒ¨åˆ† (sections) offset = 20 # è·³è¿‡å¤´éƒ¨å’Œæ ‡å¿—ä½ # è¯»å–éƒ¨åˆ†ç±»å‹ kind = payload[offset] offset += 1 if kind == 0: # Body kind section = { \u0026#34;kind\u0026#34;: \u0026#34;body\u0026#34;, \u0026#34;document\u0026#34;: None, \u0026#34;error\u0026#34;: None } doc = parse_body_kind(payload[offset:]) if doc: section[\u0026#34;document\u0026#34;] = doc result[\u0026#34;sections\u0026#34;].append(section) offset = len(payload) else: # documentSequence kind å’Œ å…¶ä»–ï¼Œè¿™é‡Œæš‚ä¸è€ƒè™‘ section = { \u0026#34;kind\u0026#34;: f\u0026#34;unknown({kind})\u0026#34;, \u0026#34;error\u0026#34;: \u0026#34;æœªçŸ¥çš„éƒ¨åˆ†ç±»å‹\u0026#34; } result[\u0026#34;sections\u0026#34;].append(section) return result except Exception as e: raise Exception(f\u0026#34;è§£æ OP_MSG æ¶ˆæ¯æ—¶å‡ºé”™: {e}\u0026#34;) return None def parse_body_kind(payload) -\u0026gt; dict: \u0026#34;\u0026#34;\u0026#34; è§£æ OP_MSG æ¶ˆæ¯ä½“ä¸­çš„ body ç±»çš„ section: 8byte çš„ sectionMessageLength å‰©ä½™éƒ½æ˜¯ body çš„ section \u0026#34;\u0026#34;\u0026#34; if len(payload) \u0026lt; 4: return None try: # è¿™é‡Œé€šè¿‡ bson.decode_document æ•´ä¸ª payload å°±æ˜¯ bson åºåˆ—åŒ–åçš„ç»“æ„ã€‚ # length (4 bytes) + payload (length-4, bytes) doc = bson.decode_document(payload, 0) return doc except Exception as e: print(f\u0026#34;è§£æ OP_MSG æ¶ˆæ¯ä½“ä¸­çš„ body ç±»çš„ section æ—¶å‡ºé”™: {e}\u0026#34;) return None å±•ç¤ºç»“æœå¦‚ä¸‹ï¼š\nshow databases db.coll.find().limit(10) å°ç»“ # MongoDB åè®®é‡‡ç”¨äº†å°ç«¯å­—èŠ‚åºï¼Œå¹¶ä¸”ä½¿ç”¨äº†æ ‡å‡†çš„ TCP/IP å¥—æ¥å­—è¿›è¡Œé€šä¿¡ï¼›å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šè¿‡ä¸€ä¸ªå¸¸è§„çš„ TCP/IP å¥—æ¥å­—è¿›è¡Œé€šä¿¡ï¼ŒæœåŠ¡å™¨é»˜è®¤ç«¯å£ä¸º 27017ã€‚\néšç€ MongoDB ç‰ˆæœ¬çš„å‡çº§ï¼ŒMongoDB å·²ç»ä½¿ç”¨ OP_MSG æ“ä½œç æ¥ç»Ÿä¸€è¯·æ±‚å’Œå“åº”æ ¼å¼ã€‚åœ¨ OP_MSG ä¸­ Section é‡‡ç”¨ BSON ç¼–ç ï¼Œè¿™æ ·éå¸¸çµæ´»ï¼Œå¦‚æœ API åŠŸèƒ½è¿›è¡Œäº†è°ƒæ•´ï¼ˆæ–°å¢/è°ƒæ•´äº†å­—æ®µï¼Œé‚£ä¹ˆæ˜¯å¯ä»¥ä¸éœ€è¦è°ƒæ•´åè®®ï¼Œè€Œåªç”¨è°ƒæ•´åŠŸèƒ½å³å¯ï¼‰ã€‚\nè¦è¿›ä¸€æ­¥æ·±å…¥çš„è¯å¯ä»¥å†å®ç°ä¸€ä¸ªç®€å•çš„ MongoDB å®¢æˆ·ç«¯ï¼Œæˆ–è€…ç»“åˆæŸä¸ªç‰¹å®šçš„å®¢æˆ·ç«¯å®ç°ä»£ç æ¥æ·±å…¥äº†è§£ mongodb åè®®çš„äº¤äº’è¿‡ç¨‹ã€‚å½“ç„¶è¿™é‡Œè¿˜æ²¡æœ‰æ·±ç©¶ show databases è¿™ç§å‘½ä»¤çš„å…·ä½“å†…å®¹ï¼Œæœ‰å…´è¶£å¯ä»¥ç»§ç»­ç ”ç©¶ä¸‹ MongoDB specificationã€‚\næ€»ç»“ # ä»»ä½• C/S æ¨¡å¼çš„è½¯ä»¶ç³»ç»Ÿéƒ½å¯ä»¥è‡ªå®šä¹‰è‡ªå·±çš„ â€œåè®®â€ï¼Œè€Œè¿™äº›åè®®çš„æ¨¡å¼å¤§åŒå°å¼‚ï¼Œç®€å•çš„å¯ä»¥ç›´æ¥ä½¿ç”¨æ–‡æœ¬åè®®å®ç°å¦‚ memcached, å¤æ‚çš„åˆ™å¯ä»¥å®Œå…¨è‡ªå®šä¹‰è‡ªå·±çš„äºŒè¿›åˆ¶åè®®ï¼Œå¦‚ kafka å’Œ mongodb, æ›´è¿›ä¸€æ­¥å®ƒä»¬ç”šè‡³æœ‰è‡ªå·±ç‹¬ä¸€å¥—çš„ç¼–ç åè®®ï¼Œä½†æ˜¯ä¸ç®¡æ€ä¹ˆæ ·ä¸€å¥—åè®®ä¹Ÿæ— éå°±æ˜¯ï¼šç¡®å®šä¼ è¾“åè®® + è®¾è®¡åº”ç”¨åè®® + é‡‡ç”¨ä»€ä¹ˆç¼–ç ã€‚\næŒæ¡è¿™äº›åè®®çš„è®¾è®¡æ€è·¯å’Œç†å¿µä¹‹åï¼Œä¸‹ä¸€æ­¥å°±å¯ä»¥å»æ·±å…¥äº†è§£è½¯ä»¶æ•´ä½“çš„ API åŠŸèƒ½è®¾è®¡ï¼Œè¿™æ ·ä¼šå¸®åŠ©æˆ‘ä»¬æ›´æ·±å…¥æœåŠ¡ä¾§çš„é€»è¾‘å®ç°ï¼ŒåŠ æ·±å¯¹è½¯ä»¶ç³»ç»Ÿçš„ç†è§£ã€‚\nå‚è€ƒæ–‡æ¡£ # Kafka Protocol Guide MongoDB Wire Protocol MongoDB specification OP_MSG BSON serialization specification "},{"id":9,"href":"/2025/02/28/%E5%9C%A8k8s%E4%B8%AD%E6%90%AD%E5%BB%BA%E5%AD%98%E7%AE%97%E5%88%86%E7%A6%BB%E7%9A%84Doris%E9%9B%86%E7%BE%A4/","title":"åœ¨ K8S ä¸­éƒ¨ç½²å­˜ç®—åˆ†ç¦» Doris é›†ç¾¤","section":"Posts","content":" æœ¬æ–‡è®°å½•äº†åœ¨ ubuntu 22.04 ä¸Šé…åˆ minikube æ­å»ºçš„ k8s é›†ç¾¤ï¼Œæ­å»º doris å­˜ç®—åˆ†ç¦»é›†ç¾¤çš„è¿‡ç¨‹ã€‚\n0. ç¯å¢ƒä¿¡æ¯ # è½¯ä»¶ ç‰ˆæœ¬ OS Ubuntu 24.04.1 LTS x86_64 kernel 6.8.0-52-generic minikube v1.35.0 kubernetes v1.32.0 doris v3.0.3 è¿™é‡Œé»˜è®¤å·²ç»å‡†å¤‡å¥½äº†åŸºç¡€çš„ kubernetes é›†ç¾¤ï¼Œæ‰€ä»¥ä¹Ÿä¸å†é˜è¿°å¦‚ä½•é€šè¿‡ minikube æˆ–è€…å…¶ä»–æ–¹å¼æ­å»º kubernetes é›†ç¾¤ã€‚\n1. å®‰è£… FoundationDB # å‚è€ƒæ–‡æ¡£ï¼šhttps://doris.apache.org/zh-CN/docs/3.0/install/deploy-on-kubernetes/separating-storage-compute/install-fdb\n1.1 å®‰è£… FoundationDB CRD èµ„æº # kubectl apply -f https://raw.githubusercontent.com/FoundationDB/fdb-kubernetes-operator/main/config/crd/bases/apps.foundationdb.org_foundationdbclusters.yaml kubectl apply -f https://raw.githubusercontent.com/FoundationDB/fdb-kubernetes-operator/main/config/crd/bases/apps.foundationdb.org_foundationdbbackups.yaml kubectl apply -f https://raw.githubusercontent.com/FoundationDB/fdb-kubernetes-operator/main/config/crd/bases/apps.foundationdb.org_foundationdbrestores.yaml 1.2 éƒ¨ç½² FoundationDB Operator # wget https://raw.githubusercontent.com/apache/doris-operator/master/config/operator/fdb-operator.yaml kubectl apply -f fdb-operator.yaml 1.3 éƒ¨ç½² FoundationDB é›†ç¾¤ # wget https://raw.githubusercontent.com/foundationdb/fdb-kubernetes-operator/main/config/samples/cluster.yaml -O fdb-cluster.yaml kubectl apply -f fdb-cluster.yaml # æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ kubectl get fdb # é¢„æœŸè¾“å‡ºï¼ˆå¯åŠ¨éœ€è¦æ—¶é—´ï¼Œéœ€è¦ç­‰å¾…å‡ åˆ†é’Ÿï¼‰ NAME GENERATION RECONCILED AVAILABLE FULLREPLICATION VERSION AGE test-cluster 1 1 true true 7.1.26 3m30s 2. å®‰è£… Doris Operator # 2.1 å®‰è£… CRD éƒ¨ç½² Doris ç›¸å…³èµ„æºå®šä¹‰ # kubectl create -f https://raw.githubusercontent.com/apache/doris-operator/master/config/crd/bases/crds.yaml 2.2 éƒ¨ç½² Doris Operator # wget https://raw.githubusercontent.com/apache/doris-operator/master/config/operator/disaggregated-operator.yaml -O disaggregated-operator.yaml kubectl apply -f disaggregated-operator.yaml # æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€ kubectl get pod -n doris # é¢„æœŸè¾“å‡º NAME READY STATUS RESTARTS AGE doris-operator-5fd65d8d69-rgqlk 1/1 Running 0 79s 3. éƒ¨ç½²å­˜ç®—åˆ†ç¦»é›†ç¾¤ # 3.1 ä¸‹è½½ç¤ºä¾‹é…ç½® # wget https://raw.githubusercontent.com/apache/doris-operator/master/doc/examples/disaggregated/cluster/ddc-sample.yaml -O ddc-sample.yaml 3.2 é…ç½® ConfigMap # å¯¹äº ddc-sample.yaml é…ç½®è¿›è¡Œè°ƒæ•´é…ç½®ã€‚è¿™ä¸‰ä¸ªéƒ½éœ€è¦åˆ†åˆ«é…ç½® ConfigMap å¹¶ä¿®æ”¹é›†ç¾¤ä¸­çš„é…ç½®æŒ‚è½½ã€‚\né…ç½®å…ƒæ•°æ® https://doris.apache.org/zh-CN/docs/3.0/install/deploy-on-kubernetes/separating-storage-compute/config-ms é…ç½® FE é›†ç¾¤ https://doris.apache.org/zh-CN/docs/3.0/install/deploy-on-kubernetes/separating-storage-compute/config-fe é…ç½®è®¡ç®—èµ„æºç»„ https://doris.apache.org/zh-CN/docs/3.0/install/deploy-on-kubernetes/separating-storage-compute/config-cg ConfigMap é…ç½® apiVersion: v1 data: doris_cloud.conf: | # // meta_service brpc_listen_port = 5000 brpc_num_threads = -1 brpc_idle_timeout_sec = 30 http_token = greedisgood9999 # // doris txn config label_keep_max_second = 259200 expired_txn_scan_key_nums = 1000 # // logging log_dir = ./log/ # info warn error log_level = info log_size_mb = 1024 log_filenum_quota = 10 log_immediate_flush = false log_verbose_modules = * # //max stage num max_num_stages = 40 kind: ConfigMap metadata: name: doris-metaservice namespace: default --- apiVersion: v1 kind: ConfigMap metadata: name: fe-configmap namespace: default labels: app.kubernetes.io/component: fe data: fe.conf: | CUR_DATE=`date +%Y%m%d-%H%M%S` # Log dir LOG_DIR = ${DORIS_HOME}/log # For jdk 17, this JAVA_OPTS will be used as default JVM options JAVA_OPTS_FOR_JDK_17=\u0026#34;-Djavax.security.auth.useSubjectCredsOnly=false -Xmx8192m -Xms8192m -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$LOG_DIR -Xlog:gc*:$LOG_DIR/fe.gc.log.$CUR_DATE:time,uptime:filecount=10,filesize=50M --add-opens=java.base/java.nio=ALL-UNNAMED --add-opens java.base/jdk.internal.ref=ALL-UNNAMED\u0026#34; # INFO, WARN, ERROR, FATAL sys_log_level = INFO # NORMAL, BRIEF, ASYNC sys_log_mode = NORMAL # Default dirs to put jdbc drivers,default value is ${DORIS_HOME}/jdbc_drivers # jdbc_drivers_dir = ${DORIS_HOME}/jdbc_drivers http_port = 8030 rpc_port = 9020 query_port = 9030 edit_log_port = 9010 enable_fqdn_mode=true --- apiVersion: v1 kind: ConfigMap metadata: name: be-configmap labels: app.kubernetes.io/component: be data: be.conf: | # For jdk 17, this JAVA_OPTS will be used as default JVM options JAVA_OPTS_FOR_JDK_17=\u0026#34;-Xmx1024m -DlogPath=$LOG_DIR/jni.log -Xlog:gc*:$LOG_DIR/be.gc.log.$CUR_DATE:time,uptime:filecount=10,filesize=50M -Djavax.security.auth.useSubjectCredsOnly=false -Dsun.security.krb5.debug=true -Dsun.java.command=DorisBE -XX:-CriticalJNINatives -XX:+IgnoreUnrecognizedVMOptions --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.lang.invoke=ALL-UNNAMED --add-opens=java.base/java.lang.reflect=ALL-UNNAMED --add-opens=java.base/java.io=ALL-UNNAMED --add-opens=java.base/java.net=ALL-UNNAMED --add-opens=java.base/java.nio=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED --add-opens=java.base/java.util.concurrent=ALL-UNNAMED --add-opens=java.base/java.util.concurrent.atomic=ALL-UNNAMED --add-opens=java.base/sun.nio.ch=ALL-UNNAMED --add-opens=java.base/sun.nio.cs=ALL-UNNAMED --add-opens=java.base/sun.security.action=ALL-UNNAMED --add-opens=java.base/sun.util.calendar=ALL-UNNAMED --add-opens=java.security.jgss/sun.security.krb5=ALL-UNNAMED --add-opens=java.management/sun.management=ALL-UNNAMED\u0026#34; file_cache_path = [{\u0026#34;path\u0026#34;:\u0026#34;/mnt/disk1/doris_cloud/file_cache\u0026#34;,\u0026#34;total_size\u0026#34;:107374182400,\u0026#34;query_limit\u0026#34;:107374182400}] deploy_mode = cloud 3.3 å¯åŠ¨é›†ç¾¤ # # éƒ¨ç½²é›†ç¾¤ kubectl apply -f ddc-sample.yaml # æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ kubectl get ddc # é¢„æœŸè¾“å‡º NAME CLUSTERHEALTH MSPHASE FEPHASE CGCOUNT CGAVAILABLECOUNT CGFULLAVAILABLECOUNT test-disaggregated-cluster green Ready Ready 2 2 2 3.4 åˆ›å»ºè¿œç¨‹å­˜å‚¨åç«¯ # kubectl get svc # test-disaggregated-cluster-fe ClusterIP 10.104.79.145 \u0026lt;none\u0026gt; 8030/TCP,9020/TCP,9030/TCP,9010/TCP 35m # MySQL å®¢æˆ·ç«¯å¯åŠ¨ kubectl run mysql-client --image=mysql:5.7 -it --rm --restart=Never -- /bin/bash # è¿æ¥ Doris FE mysql -uroot -P9030 -h test-disaggregated-cluster-fe # MYSQL å‘½ä»¤æ‰§è¡Œï¼šS3 Storage Vault CREATE STORAGE VAULT IF NOT EXISTS s3_vault PROPERTIES ( \u0026#34;type\u0026#34;=\u0026#34;S3\u0026#34;, \u0026#34;s3.endpoint\u0026#34; = \u0026#34;oss-cn-beijing.aliyuncs.com\u0026#34;, \u0026#34;s3.region\u0026#34; = \u0026#34;bj\u0026#34;, \u0026#34;s3.bucket\u0026#34; = \u0026#34;bucket\u0026#34;, \u0026#34;s3.root.path\u0026#34; = \u0026#34;big/data/prefix\u0026#34;, \u0026#34;s3.access_key\u0026#34; = \u0026#34;your-ak\u0026#34;, \u0026#34;s3.secret_key\u0026#34; = \u0026#34;your-sk\u0026#34;, \u0026#34;provider\u0026#34; = \u0026#34;OSS\u0026#34; ); # MYSQL å‘½ä»¤æ‰§è¡Œï¼šè®¾ç½®é»˜è®¤æ•°æ®åç«¯ SET s3_vault AS DEFAULT STORAGE VAULT; 4. æµ‹è¯•é›†ç¾¤ # 4.1 å¯åŠ¨ MySQL å®¢æˆ·ç«¯ # # åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ MySQL å®¢æˆ·ç«¯ Pod kubectl run mysql-client --image=mysql:5.7 -it --rm --restart=Never -- mysql -h test-disaggregated-cluster-fe -P9030 -uroot 4.2 æµ‹è¯•åŸºæœ¬æ“ä½œ # æ‰§è¡Œä¸€äº›æŸ¥è¯¢è¯­å¥å’Œåˆå§‹åŒ–æµ‹è¯•è¡¨æ•°æ®ï¼ŒéªŒè¯é›†ç¾¤æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚\n-- æŸ¥çœ‹ FE èŠ‚ç‚¹çŠ¶æ€ SHOW FRONTENDS; -- æŸ¥çœ‹ BE èŠ‚ç‚¹çŠ¶æ€ SHOW BACKENDS; -- åˆ›å»ºæµ‹è¯•æ•°æ®åº“ CREATE DATABASE test_db; USE test_db; -- åˆ›å»ºæµ‹è¯•è¡¨ CREATE TABLE test_tbl ( id INT, name VARCHAR(50), score DECIMAL(10,2) ) UNIQUE KEY(id) DISTRIBUTED BY HASH(id) BUCKETS 3; -- æ’å…¥æµ‹è¯•æ•°æ® INSERT INTO test_tbl VALUES (1, \u0026#39;Tom\u0026#39;, 89.5), (2, \u0026#39;Jerry\u0026#39;, 92.0), (3, \u0026#39;Jack\u0026#39;, 85.5); -- æŸ¥è¯¢æ•°æ® SELECT * FROM test_tbl; 4.3 éªŒè¯å­˜ç®—åˆ†ç¦» # -- æŸ¥çœ‹å­˜å‚¨åç«¯çŠ¶æ€ SHOW STORAGE VAULTS; -- æŸ¥çœ‹è¡¨çš„å­˜å‚¨ä½ç½® SHOW CREATE TABLE test_db.test_tbl; 5. éƒ¨ç½²æœŸé—´é‡åˆ°çš„é—®é¢˜å’Œè§£å†³åŠæ³• # 5.1 Coupute Group (BE) æ— æ³•å¯åŠ¨ # é—®é¢˜ç°è±¡ï¼š\nBe å¯åŠ¨æ—¶è¾“å‡ºå¦‚ä¸‹æ—¥å¿—ï¼š\nDefaulted container \u0026#34;compute\u0026#34; out of: compute, default-init (init) [Fri Feb 28 02:56:24 UTC 2025] [info] Process conf file be.conf ... /opt/apache-doris/be_disaggregated_entrypoint.sh: line 73: /opt/apache-doris/be/conf/: Is a directory [Fri Feb 28 02:56:24 UTC 2025] [info] use root no password show backends result 10221\ttest-disaggregated-cluster-cg1-1.test-disaggregated-cluster-cg1.default.svc.cluster.local\t9050\t-1\t-1\t-1\t-1\tNULL\tNULL\tfalse\tfalse\t0\t0.000 0.000 1.000 B\t0.000 0.00 %\t0.00 %\t0.000 {\u0026#34;cloud_unique_id\u0026#34; : \u0026#34;1:1751150972:t1Ws6Mrv\u0026#34;, \u0026#34;compute_group_status\u0026#34; : \u0026#34;NORMAL\u0026#34;, \u0026#34;private_endpoint\u0026#34; : \u0026#34;\u0026#34;, \u0026#34;compute_group_name\u0026#34; : \u0026#34;cg1\u0026#34;, \u0026#34;location\u0026#34; : \u0026#34;default\u0026#34;, \u0026#34;public_endpoint\u0026#34; : \u0026#34;\u0026#34;, \u0026#34;compute_group_id\u0026#34; : \u0026#34;ZNES_zRC\u0026#34;}\tjava.net.UnknownHostException: test-disaggregated-cluster-cg1-1.test-disaggregated-cluster-cg1.default.svc.cluster.local\t{\u0026#34;lastStreamLoadTime\u0026#34;:-1,\u0026#34;isQueryDisabled\u0026#34;:false,\u0026#34;isLoadDisabled\u0026#34;:false,\u0026#34;isActive\u0026#34;:true,\u0026#34;currentFragmentNum\u0026#34;:0,\u0026#34;lastFragmentUpdateTime\u0026#34;:0}\t287\t1\t0.00 10222\ttest-disaggregated-cluster-cg1-0.test-disaggregated-cluster-cg1.default.svc.cluster.local\t9050\t-1\t-1\t-1\t-1\tNULL\tNULL\tfalse\tfalse\t0\t0.000 0.000 1.000 B\t0.000 0.00 %\t0.00 %\t0.000 {\u0026#34;cloud_unique_id\u0026#34; : \u0026#34;1:1751150972:YA6LXvvg\u0026#34;, \u0026#34;compute_group_status\u0026#34; : \u0026#34;NORMAL\u0026#34;, \u0026#34;private_endpoint\u0026#34; : \u0026#34;\u0026#34;, \u0026#34;compute_group_name\u0026#34; : \u0026#34;cg1\u0026#34;, \u0026#34;location\u0026#34; : \u0026#34;default\u0026#34;, \u0026#34;public_endpoint\u0026#34; : \u0026#34;\u0026#34;, \u0026#34;compute_group_id\u0026#34; : \u0026#34;ZNES_zRC\u0026#34;}\tjava.net.UnknownHostException: test-disaggregated-cluster-cg1-0.test-disaggregated-cluster-cg1.default.svc.cluster.local\t{\u0026#34;lastStreamLoadTime\u0026#34;:-1,\u0026#34;isQueryDisabled\u0026#34;:false,\u0026#34;isLoadDisabled\u0026#34;:false,\u0026#34;isActive\u0026#34;:true,\u0026#34;currentFragmentNum\u0026#34;:0,\u0026#34;lastFragmentUpdateTime\u0026#34;:0}\t287\t1\t0.00 10223\ttest-disaggregated-cluster-cg1-2.test-disaggregated-cluster-cg1.default.svc.cluster.local\t9050\t-1\t-1\t-1\t-1\tNULL\tNULL\tfalse\tfalse\t0\t0.000 0.000 1.000 B\t0.000 0.00 %\t0.00 %\t0.000 {\u0026#34;cloud_unique_id\u0026#34; : \u0026#34;1:1751150972:Ox_RJuee\u0026#34;, \u0026#34;compute_group_status\u0026#34; : \u0026#34;NORMAL\u0026#34;, \u0026#34;private_endpoint\u0026#34; : \u0026#34;\u0026#34;, \u0026#34;compute_group_name\u0026#34; : \u0026#34;cg1\u0026#34;, \u0026#34;location\u0026#34; : \u0026#34;default\u0026#34;, \u0026#34;public_endpoint\u0026#34; : \u0026#34;\u0026#34;, \u0026#34;compute_group_id\u0026#34; : \u0026#34;ZNES_zRC\u0026#34;}\tjava.net.UnknownHostException: test-disaggregated-cluster-cg1-2.test-disaggregated-cluster-cg1.default.svc.cluster.local\t{\u0026#34;lastStreamLoadTime\u0026#34;:-1,\u0026#34;isQueryDisabled\u0026#34;:false,\u0026#34;isLoadDisabled\u0026#34;:false,\u0026#34;isActive\u0026#34;:true,\u0026#34;currentFragmentNum\u0026#34;:0,\u0026#34;lastFragmentUpdateTime\u0026#34;:0}\t287\t1\t0.00 10224\ttest-disaggregated-cluster-cg2-0.test-disaggregated-cluster-cg2.default.svc.cluster.local\t9050\t-1\t-1\t-1\t-1\tNULL\tNULL\tfalse\tfalse\t0\t0.000 0.000 1.000 B\t0.000 0.00 %\t0.00 %\t0.000 {\u0026#34;cloud_unique_id\u0026#34; : \u0026#34;1:1751150972:E_SJoMU8\u0026#34;, \u0026#34;compute_group_status\u0026#34; : \u0026#34;NORMAL\u0026#34;, \u0026#34;private_endpoint\u0026#34; : \u0026#34;\u0026#34;, \u0026#34;compute_group_name\u0026#34; : \u0026#34;cg2\u0026#34;, \u0026#34;location\u0026#34; : \u0026#34;default\u0026#34;, \u0026#34;public_endpoint\u0026#34; : \u0026#34;\u0026#34;, \u0026#34;compute_group_id\u0026#34; : \u0026#34;oZ2gH5Ml\u0026#34;}\tjava.net.UnknownHostException: test-disaggregated-cluster-cg2-0.test-disaggregated-cluster-cg2.default.svc.cluster.local\t{\u0026#34;lastStreamLoadTime\u0026#34;:-1,\u0026#34;isQueryDisabled\u0026#34;:false,\u0026#34;isLoadDisabled\u0026#34;:false,\u0026#34;isActive\u0026#34;:true,\u0026#34;currentFragmentNum\u0026#34;:0,\u0026#34;lastFragmentUpdateTime\u0026#34;:0}\t287\t1\t0.00 10251\ttest-disaggregated-cluster-cg2-1.test-disaggregated-cluster-cg2.default.svc.cluster.local\t9050\t-1\t-1\t-1\t-1\tNULL\tNULL\tfalse\tfalse\t0\t0.000 0.000 1.000 B\t0.000 0.00 %\t0.00 %\t0.000 {\u0026#34;cloud_unique_id\u0026#34; : \u0026#34;1:1751150972:B_h0m9vp\u0026#34;, \u0026#34;compute_group_status\u0026#34; : \u0026#34;NORMAL\u0026#34;, \u0026#34;private_endpoint\u0026#34; : \u0026#34;\u0026#34;, \u0026#34;compute_group_name\u0026#34; : \u0026#34;cg2\u0026#34;, \u0026#34;location\u0026#34; : \u0026#34;default\u0026#34;, \u0026#34;public_endpoint\u0026#34; : \u0026#34;\u0026#34;, \u0026#34;compute_group_id\u0026#34; : \u0026#34;oZ2gH5Ml\u0026#34;}\tjava.net.UnknownHostException: test-disaggregated-cluster-cg2-1.test-disaggregated-cluster-cg2.default.svc.cluster.local\t{\u0026#34;lastStreamLoadTime\u0026#34;:-1,\u0026#34;isQueryDisabled\u0026#34;:false,\u0026#34;isLoadDisabled\u0026#34;:false,\u0026#34;isActive\u0026#34;:true,\u0026#34;currentFragmentNum\u0026#34;:0,\u0026#34;lastFragmentUpdateTime\u0026#34;:0}\t287\t1\t0.00 10252\ttest-disaggregated-cluster-cg2-2.test-disaggregated-cluster-cg2.default.svc.cluster.local\t9050\t-1\t-1\t-1\t-1\tNULL\tNULL\tfalse\tfalse\t0\t0.000 0.000 1.000 B\t0.000 0.00 %\t0.00 %\t0.000 {\u0026#34;cloud_unique_id\u0026#34; : \u0026#34;1:1751150972:nmt5aHJC\u0026#34;, \u0026#34;compute_group_status\u0026#34; : \u0026#34;NORMAL\u0026#34;, \u0026#34;private_endpoint\u0026#34; : \u0026#34;\u0026#34;, \u0026#34;compute_group_name\u0026#34; : \u0026#34;cg2\u0026#34;, \u0026#34;location\u0026#34; : \u0026#34;default\u0026#34;, \u0026#34;public_endpoint\u0026#34; : \u0026#34;\u0026#34;, \u0026#34;compute_group_id\u0026#34; : \u0026#34;oZ2gH5Ml\u0026#34;}\tjava.net.UnknownHostException: test-disaggregated-cluster-cg2-2.test-disaggregated-cluster-cg2.default.svc.cluster.local\t{\u0026#34;lastStreamLoadTime\u0026#34;:-1,\u0026#34;isQueryDisabled\u0026#34;:false,\u0026#34;isLoadDisabled\u0026#34;:false,\u0026#34;isActive\u0026#34;:true,\u0026#34;currentFragmentNum\u0026#34;:0,\u0026#34;lastFragmentUpdateTime\u0026#34;:0}\t287\t1\t0.00 . [Fri Feb 28 02:56:24 UTC 2025] [info] Check myself (test-disaggregated-cluster-cg1-0.test-disaggregated-cluster-cg1.default.svc.cluster.local:9050) exist in FE, start be directly ... /etc/podinfo/annotationsis not exists. [Fri Feb 28 02:56:24 UTC 2025] run start_be.sh Disable swap memory before starting be é—®é¢˜åˆ†æï¼š\né—®é¢˜è¯¦æƒ…å‚è§ï¼š https://github.com/apache/doris/issues/48460 ã€‚ä¸€å¼€å§‹å…³æ³¨äº† /opt/apache-doris/be_disaggregated_entrypoint.sh: line 73: /opt/apache-doris/be/conf/: Is a directory ä»¥ä¸ºæ˜¯è„šæœ¬ be_disaggregated_entrypoint.sh æœ‰é—®é¢˜, ç»è¿‡è‡ªå·±ä¿®æ”¹é‡æ–°æ‰“åŒ…åå‘ç°é—®é¢˜ä¾æ—§ã€‚é‡æ–°æ£€æŸ¥æ—¥å¿—å’Œè„šæœ¬å‘ç°åœ¨ start_be.sh ä¸­, æ£€æŸ¥äº†äº¤æ¢å†…å­˜çš„å‘½ä»¤ï¼Œå¦‚æœå‘ç°äº¤æ¢å†…å­˜å¯ç”¨ï¼Œå°±ä¼šé€€å‡ºã€‚\n# start_be.sh line 193 if [[ \u0026#34;$(swapon -s | wc -l)\u0026#34; -gt 1 ]]; then echo \u0026#34;Disable swap memory before starting be\u0026#34; exit 1 fi è§£å†³åŠæ³•ï¼š\né€šè¿‡åœ¨å®¿ä¸»æœºä¸Šæ‰§è¡Œ sudo swapoff -a å…³é—­äº¤æ¢å†…å­˜åï¼ŒBe å°±å¯ä»¥æ­£å¸¸å¯åŠ¨äº†ã€‚\n5.2 FE æˆ–è€… MS æ— æ³•å¯åŠ¨ # é—®é¢˜ç°è±¡ï¼š\nRuntimeLogger 2025-02-28 06:38:51,460 WARN (main|1) [CloudEnv.getLocalTypeFromMetaService():165] failed to get cloud cluster due to incomplete response, cloud_unique_id=1:1751150972:fe, clusterId=RESERVED_CLUSTER_ID_FOR_SQL_SERVER, response=status { code: INVALID_ARGUMENT msg: \u0026#34;empty instance_id\u0026#34; } é—®é¢˜åˆ†æï¼š\nè¿™ä¸ªé—®é¢˜æ²¡æœ‰æ‰¾åˆ°åŸå› ï¼Œåœ¨ issue ä¸­æœ‰ç›¸åŒé—®é¢˜ï¼šhttps://github.com/apache/doris/issues/47678\nè§£å†³åŠæ³•ï¼š\né€šè¿‡é‡æ–°æ­å»º fdb + doris é›†ç¾¤è§£å†³ã€‚\n5.3 æ•°æ®å†™å…¥å¤±è´¥ # doris é›†ç¾¤å’Œ Storage Vault éƒ½éƒ¨ç½²æˆåŠŸåï¼Œé€šè¿‡ mysql å®¢æˆ·ç«¯è¿æ¥åˆ° FE åˆ›å»º test_db, test_tbl å¹¶æ’å…¥æ•°æ®ã€‚æ’å…¥æ•°æ®æ—¶å¡é¡¿ï¼Œä¸”æœ€ç»ˆå¤±è´¥ï¼š\n\u0026gt; INSERT INTO test_tbl VALUES (1, \u0026#39;Tom\u0026#39;, 89.5), (2, \u0026#39;Jerry\u0026#39;, 92.0), (3, \u0026#39;Jack\u0026#39;, 85.5); \u0026gt; ERROR 1105 (HY000): errCode = 2, detailMessage = Backend Backend [id=10262, host=test-disaggregated-cluster-cg1-2.test-disaggregated-cluster-cg1.default.svc.cluster.local, heartbeatPort=9050, alive=false, lastStartTime=2025-02-28 08:46:45, process epoch=1740732405712, isDecommissioned=false, tags: {cloud_cluster_id=Ppt5BJ3g, cloud_unique_id=1:1751150972:JxbgZEBP, cloud_cluster_status=NORMAL, cloud_cluster_name=cg1, location=default, cloud_cluster_private_endpoint=, cloud_cluster_public_endpoint=}], backendStatus: [lastSuccess ä¸æ­¤åŒæ—¶ cg1 æ•´ä½“éƒ½è§¦å‘äº†é‡å¯ï¼ŒæŸ¥çœ‹æ—¥å¿—å‘ç°ï¼š\nRuntimeLogger F20250228 09:32:36.952682 878 storage_engine.cpp:120] Check failed: _type == Type::CLOUD ( vs. ) *** Check failure stack trace: *** RuntimeLogger I20250228 09:32:36.955466 1376 workload_group_manager.cpp:200] Process Memory Summary: process memory used 856.95 MB(= 935.89 MB[vm/rss] - 78.94 MB[tc/jemalloc_cache] + 0[reserved] + 0B[waiting_refresh]), sys available memory 37.77 GB(= 37.77 GB[proc/available] - 0[reserved] - 0B[waiting_refresh]), all workload groups memory usage: 384.00 B, weighted_memory_limit_ratio: 0.9851607626358986 @ 0x5f7414439556 google::LogMessage::SendToLog() @ 0x5f7414435fa0 google::LogMessage::Flush() @ 0x5f7414439d99 google::LogMessageFatal::~LogMessageFatal() @ 0x5f7409adbc3a doris::BaseStorageEngine::to_cloud() @ 0x5f7409d600a7 doris::LoadChannel::open() @ 0x5f7409d5ab0a doris::LoadChannelMgr::open() @ 0x5f7409eaa68d std::_Function_handler\u0026lt;\u0026gt;::_M_invoke() @ 0x5f7409ec4ebb doris::WorkThreadPool\u0026lt;\u0026gt;::work_thread() @ 0x5f74173d1b20 execute_native_thread_routine @ 0x7ce578024ac3 (unknown) @ 0x7ce5780b6850 (unknown) @ (nil) (unknown) *** Query id: 66dcfbe890a240d8-b45c17c9fa19c124 *** *** is nereids: 0 *** *** tablet id: 0 *** *** Aborted at 1740735157 (unix time) try \u0026#34;date -d @1740735157\u0026#34; if you are using GNU date *** *** Current BE git commitID: 62a58bff4c *** *** SIGABRT unknown detail explain (@0x86) received by PID 134 (TID 878 OR 0x7ce39d600640) from PID 134; stack trace: *** RuntimeLogger I20250228 09:32:37.674818 463 wal_manager.cpp:485] Scheduled(every 10s) WAL info: [/opt/apache-doris/be/storage/wal: limit 3993782272 Bytes, used 0 Bytes, estimated wal bytes 0 Bytes, available 3993782272 Bytes.]; RuntimeLogger I20250228 09:32:37.726341 1376 daemon.cpp:239] os physical memory 62.66 GB. process memory used 1.12 GB(= 1.20 GB[vm/rss] - 79.15 MB[tc/jemalloc_cache] + 0[reserved] + 0B[waiting_refresh]), limit 56.40 GB, soft limit 50.76 GB. sys available memory 37.55 GB(= 37.55 GB[proc/available] - 0[reserved] - 0B[waiting_refresh]), low water mark 3.13 GB, warning water mark 6.27 GB. 0# doris::signal::(anonymous namespace)::FailureSignalHandler(int, siginfo_t*, void*) at /home/zcp/repo_center/doris_release/doris/be/src/common/signal_handler.h:421 1# 0x00007CE577FD2520 in /lib/x86_64-linux-gnu/libc.so.6 2# pthread_kill in /lib/x86_64-linux-gnu/libc.so.6 3# raise in /lib/x86_64-linux-gnu/libc.so.6 4# abort in /lib/x86_64-linux-gnu/libc.so.6 5# 0x00005F7414443E2D in /opt/apache-doris/be/lib/doris_be 6# 0x00005F741443646A in /opt/apache-doris/be/lib/doris_be 7# google::LogMessage::SendToLog() in /opt/apache-doris/be/lib/doris_be 8# google::LogMessage::Flush() in /opt/apache-doris/be/lib/doris_be 9# google::LogMessageFatal::~LogMessageFatal() in /opt/apache-doris/be/lib/doris_be 10# doris::BaseStorageEngine::to_cloud() in /opt/apache-doris/be/lib/doris_be 11# doris::LoadChannel::open(doris::PTabletWriterOpenRequest const\u0026amp;) at /home/zcp/repo_center/doris_release/doris/be/src/runtime/load_channel.cpp:131 12# doris::LoadChannelMgr::open(doris::PTabletWriterOpenRequest const\u0026amp;) at /home/zcp/repo_center/doris_release/doris/be/src/runtime/load_channel_mgr.cpp:108 13# std::_Function_handler\u0026lt;void (), doris::PInternalService::tablet_writer_open(google::protobuf::RpcController*, doris::PTabletWriterOpenRequest const*, doris::PTabletWriterOpenResult*, google::protobuf::Closure*)::$_0\u0026gt;::_M_invoke(std::_Any_data const\u0026amp;) at /var/local/ldb-toolchain/bin/../lib/gcc/x86_64-linux-gnu/11/../../../../include/c++/11/bits/std_function.h:291 14# doris::WorkThreadPool\u0026lt;false\u0026gt;::work_thread(int) at /home/zcp/repo_center/doris_release/doris/be/src/util/work_thread_pool.hpp:159 15# execute_native_thread_routine at ../../../../../libstdc++-v3/src/c++11/thread.cc:84 16# 0x00007CE578024AC3 in /lib/x86_64-linux-gnu/libc.so.6 17# 0x00007CE5780B6850 in /lib/x86_64-linux-gnu/libc.so.6 /opt/apache-doris/be/bin/start_be.sh: line 433: 134 Aborted (core dumped) ${LIMIT:+${LIMIT}} \u0026#34;${DORIS_HOME}/lib/doris_be\u0026#34; \u0026#34;$@\u0026#34; 2\u0026gt;\u0026amp;1 \u0026lt; /dev/null é—®é¢˜åˆ†æï¼š\næ ¹æ®å †æ ˆæ‰¾åˆ° storage_engine.cpp ä¸­çš„ 120 è¡Œï¼š\nStorageEngine\u0026amp; BaseStorageEngine::to_local() { CHECK_EQ(_type, Type::LOCAL); return *static_cast\u0026lt;StorageEngine*\u0026gt;(this); } CloudStorageEngine\u0026amp; BaseStorageEngine::to_cloud() { CHECK_EQ(_type, Type::CLOUD); return *static_cast\u0026lt;CloudStorageEngine*\u0026gt;(this); } // CHECK_EQ æ˜¯ glog çš„ä¸€ä¸ªå®ï¼Œç”¨äºæ£€æŸ¥è¡¨è¾¾å¼æ˜¯å¦ä¸ºçœŸã€‚å¦‚æœè¡¨è¾¾å¼ä¸ºå‡ï¼Œåˆ™ä¼šæ‰“å°é”™è¯¯æ¶ˆæ¯å¹¶ç»ˆæ­¢ç¨‹åºã€‚ // https://github.com/google/glog/blob/master/src/glog/logging.h#L688 ä»è¿™é‡Œå¯ä»¥å¾—çŸ¥ CHECK_EQ(_type, Type::CLOUD); è¿™ä¸ªæ£€æŸ¥å¤±è´¥ï¼Œå¯¼è‡´ BE é‡å¯ã€‚\nè§£å†³åŠæ³•ï¼š\nå°† BE çš„å­˜å‚¨å¼•æ“æ¨¡å¼è®¾ç½®ä¸º cloudã€‚å‚è§ https://doris.apache.org/zh-CN/docs/3.0/compute-storage-decoupled/compilation-and-deployment#541-%E9%85%8D%E7%BD%AE-beconf\n"},{"id":10,"href":"/2025/01/03/%E9%80%9A%E8%BF%87%E4%B8%80%E6%AC%A1%E6%8A%93%E5%8C%85%E6%9D%A5%E6%8E%8C%E6%8F%A1memcached/","title":"é€šè¿‡ä¸€æ¬¡æŠ“åŒ…æ¥æŒæ¡memcached","section":"Posts","content":" ä»€ä¹ˆæ˜¯ memcached # memcached æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„â€œåˆ†å¸ƒå¼â€å†…å­˜å¯¹è±¡ç¼“å­˜ç³»ç»Ÿï¼Œç”¨äºåŠ¨æ€ Web åº”ç”¨ä»¥å‡è½»æ•°æ®åº“è´Ÿè½½ã€‚å®ƒé€šè¿‡åœ¨å†…å­˜ä¸­ç¼“å­˜æ•°æ®å’Œå¯¹è±¡æ¥å‡å°‘è¯»å–æ•°æ®åº“çš„æ¬¡æ•°ï¼Œä»è€Œæé«˜åŠ¨æ€ã€æ•°æ®åº“é©±åŠ¨ç½‘ç«™çš„é€Ÿåº¦ã€‚memcached æ˜¯è‡ªç”±è½¯ä»¶ï¼Œä»¥ BSD è®¸å¯è¯å‘å¸ƒã€‚\nç›¸æ¯”äºå¤§å®¶ç†ŸçŸ¥çš„ Redisï¼Œmemcached æ›´åŠ ç®€å•ï¼Œåªæ”¯æŒ key-value å­˜å‚¨ï¼Œè€Œ Redis æ”¯æŒæ›´å¤šçš„æ•°æ®ç»“æ„ï¼Œå¦‚ listã€setã€hash ç­‰ã€‚\nGithub åœ°å€ï¼šhttps://github.com/memcached/memcached\nä¸ºä»€ä¹ˆæœ‰ redis è¿˜è¦ä½¿ç”¨ memcached # ä»æˆ‘ä¸ªäººçš„è§’åº¦æ¥è¯´ï¼Œè¦åœ¨é‡‡ç”¨ä¸€ä¸ªç¼“å­˜ç³»ç»Ÿçš„æ—¶å€™ï¼Œæˆ‘ä¼šä¼˜å…ˆé€‰æ‹© Redisï¼Œå› ä¸º Redis åŠŸèƒ½æ›´åŠ å¼ºå¤§ï¼Œæ”¯æŒæ›´å¤šçš„æ•°æ®ç»“æ„ï¼Œè€Œä¸” Redis ä¹Ÿæ”¯æŒæŒä¹…åŒ–ï¼Œåœ¨é«˜å¯ç”¨å’Œåˆ†å¸ƒå¼éƒ¨åˆ†çš„è®¾è®¡ä¸Šä¹Ÿæ›´åŠ å®Œå–„ã€‚\nä½†æ˜¯ memcached ä¹Ÿæœ‰è‡ªå·±çš„ä¼˜åŠ¿ï¼Œæ¯”å¦‚æ›´åŠ ç®€å•ï¼Œæ›´åŠ è½»é‡çº§ï¼Œæ›´åŠ å®¹æ˜“ä¸Šæ‰‹ï¼Œå› æ­¤åœ¨æŸäº›ç³»ç»Ÿä¸­ä¹Ÿä¼šé€‰ç”¨ memcachedã€‚å› æ­¤ï¼Œäº†è§£ memcached çš„è®¾è®¡ä¹Ÿæ˜¯æœ‰å¿…è¦çš„ã€‚\nmemcached åè®®æ¦‚è§ˆ # memcached æ”¯æŒåŸºæœ¬çš„æ–‡æœ¬åè®®å’Œå…ƒæ–‡æœ¬åè®®ï¼Œå…¶ä¸­å…ƒæ–‡æœ¬åè®®äº 2019 å¹´æ¨å‡ºã€‚memcached è¿˜æ›¾æ”¯æŒè¿‡äºŒè¿›åˆ¶åè®®ï¼Œä½†å·²ç»è¢«åºŸå¼ƒã€‚\nmemcached çš„åè®®æ˜¯åŸºäºæ–‡æœ¬çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ telnet æˆ–è€… netcat å·¥å…·æ¥æ¨¡æ‹Ÿ memcached çš„å®¢æˆ·ç«¯ï¼Œä»è€Œæ–¹ä¾¿çš„è¿›è¡Œæµ‹è¯•ã€‚\nè¿™ä¸¤è€…æ˜¯ â€œäº¤å‰å…¼å®¹â€ çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥é€šè¿‡ æ–‡æœ¬åè®®æ¥è®¾ç½®é”®å€¼, é€šè¿‡ å…ƒæ–‡æœ¬åè®®æ¥æŸ¥è¯¢ï¼Œåä¹‹äº¦ç„¶ã€‚\nStandard Text Protocol # è¯¦ç»†çš„åè®®æ–‡æ¡£å¯ä»¥å‚è€ƒï¼šhttps://github.com/memcached/memcached/blob/master/doc/protocol.txt\nmemcached çš„æ ‡å‡†æ–‡æœ¬åè®®æ˜¯ä¸€ä¸ªåŸºäºæ–‡æœ¬çš„åè®®ï¼Œå®ƒä½¿ç”¨ ASCII å­—ç¬¦ä¸²æ¥è¿›è¡Œé€šä¿¡ã€‚memcached æœåŠ¡å™¨ç›‘å¬åœ¨é»˜è®¤ç«¯å£ 11211 ä¸Šï¼Œå®¢æˆ·ç«¯é€šè¿‡ TCP è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œç„¶åå‘é€å‘½ä»¤å’Œæ•°æ®ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„é€šè¿‡ telnet å·¥å…·å°±å¯ä»¥å®Œæˆ memcached çš„åŸºæœ¬æ“ä½œã€‚\ntelnet 127.0.0.1 11211 ç„¶åæˆ‘ä»¬å¯ä»¥è¾“å…¥ memcached çš„å‘½ä»¤ï¼Œå¦‚ setã€get ç­‰ã€‚\nset key 0 0 5 # set key flag expire_time data_length value # data STORED # è¡¨ç¤ºå­˜å‚¨æˆåŠŸ get key VALUE key 0 5 # VALUE key flag data_length CAS value # data END # è¡¨ç¤ºè·å–ç»“æŸ Storage Commands # å­˜å‚¨å‘½ä»¤åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯å­˜å‚¨å‘½ä»¤ï¼ˆset, add, replace, append å’Œ prependï¼‰ï¼Œå¦ä¸€ç±»æ˜¯æ£€æŸ¥å¹¶è®¾ç½®å‘½ä»¤ï¼ˆcasï¼‰ã€‚å„è‡ªçš„æ ¼å¼å¦‚ä¸‹ï¼š\nç›´æ¥å­˜å‚¨å‘½ä»¤\n\u0026lt;command name\u0026gt; \u0026lt;key\u0026gt; \u0026lt;flags\u0026gt; \u0026lt;exptime\u0026gt; \u0026lt;bytes\u0026gt; [noreply]\\r\\n \u0026lt;data block\u0026gt; \\r\\n\nkey: å®¢æˆ·ç«¯å£°æ˜çš„ç”¨äºå­˜å‚¨çš„ key flags: ä»»æ„çš„ 16 ä½æ— ç¬¦å·æ•´æ•°ç”¨äºå­˜å‚¨é¢å¤–çš„ä¿¡æ¯ï¼Œå¯¹æœåŠ¡å™¨é€æ˜ï¼Œå½“æ•°æ®è¢«è·å–æ—¶ä¼šåŸå°ä¸åŠ¨çš„è¿”å›ã€‚åœ¨ v1.2.1 ä¹‹åï¼Œflags å¯ä»¥æ˜¯ 32 ä½æ— ç¬¦å·æ•´æ•°ã€‚ exptime: ä»¥ç§’ä¸ºå•ä½çš„è¿‡æœŸæ—¶é—´ï¼Œ0 è¡¨ç¤ºæ°¸ä¸è¿‡æœŸï¼ˆä½†ä»ç„¶å¯èƒ½ä¼šå› ä¸ºå†…å­˜ä¸è¶³è€Œè¢«åˆ é™¤ï¼‰ bytes: å­˜å‚¨çš„æ•°æ®é•¿åº¦ noreply: å¯é€‰å‚æ•°ï¼Œå¦‚æœå­˜åœ¨åˆ™ä¸ä¼šè¿”å›å“åº” data block: å­˜å‚¨çš„æ•°æ® CAS å‘½ä»¤\ncas \u0026lt;key\u0026gt; \u0026lt;flags\u0026gt; \u0026lt;exptime\u0026gt; \u0026lt;bytes\u0026gt; \u0026lt;cas unique\u0026gt; [noreply]\\r\\n \u0026lt;data block\u0026gt; \\r\\n\ncas unique: 64 ä½æ— ç¬¦å·æ•´æ•°ã€‚ä½¿ç”¨ cas å‰éœ€è¦å…ˆé€šè¿‡ gets è·å–åˆ° token(cas unique)ï¼Œä½¿ç”¨ cas æ—¶æºå¸¦è¿™ä¸ª tokenï¼Œå¦åˆ™ä¼šæ“ä½œå¤±è´¥ã€‚ å…¶ä»–å‚æ•°å’Œå­˜å‚¨å‘½ä»¤ä¸€è‡´ å‘½ä»¤ è¯´æ˜ set å­˜å‚¨æ•°æ®ï¼Œä¼šè¦†ç›–ä»»ä½•ç°æœ‰æ•°æ® add ä»…å½“è¯¥æ•°æ®å°šä¸å­˜åœ¨æ—¶æ‰å­˜å‚¨è¯¥æ•°æ® replace æ›¿æ¢æ•°æ®ï¼Œä½†å‰ææ˜¯è¯¥æ•°æ®å·²å­˜åœ¨ append åœ¨ç°æœ‰æ•°æ®å­—èŠ‚ä¹‹åè¿½åŠ æ•°æ® prepend åœ¨ç°æœ‰æ•°æ®å­—èŠ‚ä¹‹å‰è¿½åŠ æ•°æ® cas æ£€æŸ¥å¹¶è®¾ç½®ï¼Œç”¨äºå®ç°ä¹è§‚é” Retrieval Commands # å‘½ä»¤ è¯´æ˜ get è·å–æ•°æ® get key1 key2 ... keyn \\r\\n gets è·å–æ•°æ®å’Œ CAS å€¼ gets key1 key2 ... keyn \\r\\n Statistics Commands # å…³äº stats çš„è¯¦ç»†å­—æ®µè§£é‡ŠæŸ¥é˜…ï¼šhttps://github.com/memcached/memcached/blob/7d6bc7b09e3c6bb8eaff8b2b3d78d01e0bf17f6f/doc/protocol.txt#L1299-L1451\nå‘½ä»¤ è¯´æ˜ stats åŸºæœ¬ç»Ÿè®¡å‘½ä»¤ stats \\r\\n stats items è·å–æœåŠ¡å™¨ç»Ÿè®¡ä¿¡æ¯ stats items \\r\\n stats slabs è·å–æœåŠ¡å™¨ç»Ÿè®¡ä¿¡æ¯ stats slabs \\r\\n stats sizes è·å–æœåŠ¡å™¨ç»Ÿè®¡ä¿¡æ¯ stats sizes \\r\\n Other Commands # å‘½ä»¤ è¯´æ˜ version è·å–æœåŠ¡å™¨ç‰ˆæœ¬ä¿¡æ¯ version \\r\\n quit å…³é—­è¿æ¥ quit \\r\\n flush_all æ¸…ç©ºæ‰€æœ‰æ•°æ® flush_all \\r\\n delete åˆ é™¤æ•°æ® delete key \\r\\n incr/decr valueä¸ºæ— ç¬¦å· 64 ä½æ•´æ•°çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ï¼Œå¯ä»¥è¿›è¡Œé€’å¢/é€’å‡æ“ä½œã€‚key ä¸å­˜åœ¨ä¼šæ“ä½œå¤±è´¥ã€‚\nincr key value \\r\\n Meta Text Protocol # å…ƒæ–‡æœ¬åè®®ä¸­ä¼šå‡ºç°å¤§é‡çš„ token å­—æ ·çš„æè¿°, å…¶æŒ‡ä»£çš„æ˜¯è·Ÿåœ¨ flag åé¢ â€œè¯­æ³•å•å…ƒâ€ æˆ– ç†è§£ä¸ºflags å‚æ•°äº¦å¯ã€‚ å¦‚ mg foo k v R30 ä¸­ï¼ŒR å°±æ˜¯ä¸€ä¸ª flag, 30 å°±æ˜¯å°±æ˜¯ R æºå¸¦çš„tokenã€‚\nå…ƒæ–‡æœ¬åè®®ï¼ˆMeta Text Protocolï¼‰æ˜¯ memcached 1.6.0 ç‰ˆæœ¬å¼•å…¥çš„æ–°åè®®ï¼Œå®ƒæ˜¯ä¸€ç§åŸºäºæ–‡æœ¬çš„åè®®ï¼Œç”¨äºæ”¯æŒ memcached çš„å…ƒæ•°æ®æ“ä½œã€‚ç›¸æ¯”äºæ ‡å‡†æ–‡æœ¬åè®®ï¼Œå…ƒæ–‡æœ¬åè®®æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\nå¼•å…¥äº†æ–°å‘½ä»¤å’Œï¼ˆä½¿ç”¨ ms æ¥å–ä»£ setï¼›mg æ¥å–ä»£ getï¼Œgets, touch, GAT, GATS ç­‰ï¼‰ æ–°å¢äº†å…ƒæ•°æ®æ ‡å¿—ï¼Œå¦‚ l æ ‡å¿—è‡ªä¸Šä¸€æ¬¡è®¿é—®ä»¥æ¥çš„ç§’æ•°ï¼Œh è¡¨ç¤ºè‡ªå­˜å‚¨ä»¥æ¥æ˜¯å¦è¢«è®¿é—®è¿‡ï¼Œt è¡¨ç¤ºè¿‡æœŸå‰å‰©ä½™çš„ç§’æ•°ã€‚ æ”¯æŒ key é‡‡ç”¨äºŒè¿›åˆ¶æ ¼å¼ï¼ˆä¼ è¾“æ—¶éœ€è¦ä½¿ç”¨ base64 ç¼–ç ï¼‰ æ”¯æŒåŸå­æ€§æ“ä½œ æ”¯æŒå¯¹é¢‘ç¹è®¿é—®çš„å¯¹è±¡è¿›è¡Œæå‰ç¼“å­˜ã€‚é€šè¿‡ R æ ‡å¿—ï¼Œå¯ä»¥åœ¨æŸ¥è¯¢æ—¶å°±æŒ‡ç¤ºæœåŠ¡å™¨åˆ·æ–°ç¼“å­˜ã€‚ æ–°å¢çš„å‘½ä»¤æœ‰ï¼šms(meta set), mg(meta get), md(meta delete), me(meta debug) ç­‰ã€‚\nMeta Set å‘½ä»¤ï¼šms # è¯¦ç»†çš„åè®®æ–‡æ¡£å¯ä»¥å‚è€ƒï¼šhttps://github.com/memcached/memcached/blob/master/doc/protocol.txt#L685\nåœ¨å…ƒæ–‡æœ¬åè®®ä¸­ï¼Œè¯·æ±‚çš„æ ¼å¼å¦‚ä¸‹ï¼š\n# è¯·æ±‚ ms \u0026lt;key\u0026gt; \u0026lt;datalen\u0026gt; \u0026lt;flags\u0026gt;\\r\\n \u0026lt;data block\u0026gt;\\r\\n # å“åº” \u0026lt;CD\u0026gt; \u0026lt;flags\u0026gt;\\r\\n ä¸¾ä¾‹å¦‚ä¸‹ï¼š\n# è®¾ç½®ä¸€ä¸ª key=foo, value=bar çš„æ•°æ®, å…¶ä¸­ T90 è¡¨ç¤º 90 ç§’åè¿‡æœŸ, F1 è¡¨ç¤º flags=1 ms foo 3 T90 F1\\r\\n bar\\r\\n # å“åº” HD ms å“åº”çš„ CD æœ‰ä»¥ä¸‹å‡ ç§ï¼š\nHD STORED æˆåŠŸã€‚\nNS NOT_STORED æ•°æ®å› ä¸ºé”™è¯¯è€Œæœªå­˜å‚¨ã€‚\nEX EXISTS æ•°æ®å·²ç»å­˜åœ¨ï¼Œå¾€å¾€æ˜¯ CAS è¯­ä¹‰ï¼Œtokenå¤±æ•ˆçš„ç»“æœã€‚\nNF NOT_FOUND æ•°æ®ä¸å­˜åœ¨, å¾€å¾€æ˜¯ CAS è¯­ä¹‰ï¼Œkey ä¸å­˜åœ¨çš„ç»“æœã€‚\nms æ”¯æŒçš„ flags æ ‡å¿—å¦‚ä¸‹ï¼š\nFlags è¯´æ˜ b key é‡‡ç”¨ base64 ç¼–ç  c å­˜å‚¨æˆåŠŸåˆ™è¿”å› cas tokenï¼Œå¦åˆ™è¿”å›0ï¼ˆä½† 0 ä¸èƒ½ä½œä¸ºåˆ¤æ–­æˆåŠŸå¤±è´¥çš„ä¾æ®ï¼‰ã€‚ C(token) æ¯”è¾ƒ CAS å€¼ï¼Œå¦‚æœ token ä¸æœåŠ¡å™¨çš„ CAS å€¼ä¸ä¸€è‡´åˆ™æ“ä½œå¤±è´¥ã€‚å¯ä»¥é…åˆ I æ ‡è®°ä½¿ç”¨ E(token) ä½¿ç”¨ token ä½œä¸ºæ–°çš„ CAS å€¼ï¼Œå¦‚æœ item è¢«ä¿®æ”¹ F(token) è®¾ç½® client flags (32bit) I ä½¿ item å¤±æ•ˆï¼Œå¦‚æœæä¾›çš„ CAS å€¼æ¯” item çš„ CAS å€¼æ—§åˆ™æ“ä½œå¤±è´¥ k æŠŠ key ä½œä¸º token è¿”å›ï¼ˆmg é»˜è®¤ä¸å›æºå¸¦ key, é‚£ä¹ˆå¯ä»¥é€šè¿‡æ­¤ flag è¿”å›ï¼‰ O(token) é€æ˜å€¼, ä¼šåŸå°ä¸åŠ¨çš„è¿”å› q ä½¿ç”¨ noreply è¯­ä¹‰ s è¿”å› item å­—èŠ‚å¤§å° T(token) è®¾ç½® item çš„ TTL M(token) æ¨¡å¼åˆ‡æ¢,é»˜è®¤ Setã€‚Token å¯é€‰å€¼ E(add), A(Append), P(Prepend), R(Replace) , S(Set) N(token) å¦‚æœæ˜¯ append æ¨¡å¼ä¸‹ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ itemï¼Œæ¥å— TTL ä½œä¸ºå‚æ•° Meta Get å‘½ä»¤ï¼šmg # è¯¦ç»†çš„åè®®æ–‡æ¡£å¯ä»¥å‚è€ƒï¼š[https://github.com/memcached/memcached/blob/master/doc/protocol.txt#L685\nmg å‘½ä»¤ç”¨äºè·å–æ•°æ®ï¼Œè¯·æ±‚çš„æ ¼å¼å¦‚ä¸‹ï¼š\n# è¯·æ±‚ mg \u0026lt;key\u0026gt; \u0026lt;flags\u0026gt;\\r\\n # å“åº” \u0026lt;CD\u0026gt; \u0026lt;flags\u0026gt; \u0026lt;flags token\u0026gt;\\r\\n \u0026lt;data block\u0026gt;\\r\\n ä¸¾ä¾‹å¦‚ä¸‹ï¼š\n# è·å– key=foo çš„æ•°æ®, v è¡¨ç¤º valueï¼Œt è¡¨ç¤ºè¿‡æœŸæ—¶é—´ï¼Œf è¡¨ç¤º flags mg foo t f v\\r\\n # å“åº” VA 3 t79 f1 bat mg å“åº”çš„ CD æœ‰ä»¥ä¸‹å‡ ç§ï¼š\nVA \u0026lt;size\u0026gt; \u0026lt;flags\u0026gt;\\r\\n \u0026lt;data block\u0026gt;\\r\\n å¦‚æœä½¿ç”¨äº† v æ ‡å¿— ä¸” æœåŠ¡å™¨æœ‰æ•°æ®ã€‚\nHD \u0026lt;flags\u0026gt;\\r\\n å¦‚æœæ²¡æœ‰ä½¿ç”¨ v æ ‡å¿—ã€‚\nEN\\r\\n ä»£è¡¨ key ä¸å­˜åœ¨ã€‚\nmg æ”¯æŒçš„ flags æ ‡å¿—å¦‚ä¸‹ï¼š\nFlags è¯´æ˜ b key é‡‡ç”¨ base64 ç¼–ç  c è¿”å› cas token f è¿”å› client flags token h è¿”å›æ˜¯å¦è¢«è®¿é—®è¿‡çš„æ ‡å¿— k è¿”å› key l è¿”å›è‡ªä¸Šæ¬¡è®¿é—®ä»¥æ¥çš„ç§’æ•° O é€æ˜å€¼ q ä½¿ç”¨ noreply è¯­ä¹‰ s è¿”å› item å¤§å° t è¿”å›å‰©ä½™çš„ TTL u ä¸æ›´æ–° LRU v è¿”å› value E(token) ä½¿ç”¨ token ä½œä¸ºæ–°çš„ CAS å€¼ï¼Œå¦‚æœ item è¢«ä¿®æ”¹ N(token) å¦‚æœ item ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ itemï¼Œæ¥å— TTL ä½œä¸ºå‚æ•° R(token) å¦‚æœå‰©ä½™çš„ TTL å°äº tokenï¼Œä¸º recache è€Œèƒœå‡º T(token) æ›´æ–°å‰©ä½™çš„ TTL ç”±æ­¤å¯è§ï¼Œå…ƒæ–‡æœ¬åè®®ç›¸æ¯”äºæ ‡å‡†æ–‡æœ¬åè®®æ›´åŠ çµæ´»ï¼Œæ”¯æŒæ›´å¤šçš„å…ƒæ•°æ®æ“ä½œã€‚å°¤å…¶æ˜¯ mg è·Ÿ flags çš„ç»“åˆæ›´åŠ çµæ´»ï¼Œå°†ä»¥å‰éœ€è¦æ‰§è¡Œå¤šä¸ªå‘½ä»¤çš„æ“ä½œåˆå¹¶åˆ°äº†ä¸€ä¸ªå‘½ä»¤ä¸­ï¼Œå‡å°‘äº†ç½‘ç»œå¾€è¿”çš„æ¬¡æ•°ã€‚\nå…ƒæ–‡æœ¬åè®®ä¸­å½“ç„¶ä¸æ­¢è¿™ä¸¤ä¸ªå‘½ä»¤ï¼Œè¿˜æœ‰ md, me ç­‰å‘½ä»¤ï¼Œå°±ä¸å†ä¸€ä¸€åˆ—ä¸¾äº†ã€‚é€šè¿‡ ms, mg å‘½ä»¤å°±è¶³å¤ŸæŒæ¡äº†å…ƒæ–‡æœ¬åè®®çš„è®¾è®¡ç†å¿µå’Œä½¿ç”¨æ–¹æ³•ã€‚\næŠ“åŒ…/æºç åˆ†æ # ä¸‹é¢æˆ‘ä»¬é€šè¿‡æŠ“åŒ…çš„æ–¹å¼æ¥åˆ†æ memcached çš„åè®®äº¤äº’è¿‡ç¨‹ï¼Œå†ç»“åˆä¸€éƒ¨åˆ†æºç æ¥åˆ†æä¸‹ memcached æ˜¯æ€ä¹ˆæ”¯æŒâ€œåˆ†å¸ƒå¼â€åœºæ™¯çš„ã€‚\nåˆ†æ0: memcached çš„åè®®é•¿ä»€ä¹ˆæ ·ï¼Ÿ # è¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ç”šè‡³ä¸éœ€è¦æŠ“åŒ…ï¼Œä» memcached çš„åè®®ä»‹ç»æˆ‘ä»¬å°±å·²ç»çŸ¥é“äº†å®ƒæ˜¯ä¸€ä¸ªæ–‡æœ¬åè®®ï¼Œç›´æ¥ä½¿ç”¨ telnet å°±å¯ä»¥å®Œæˆ memcached çš„åŸºæœ¬æ“ä½œã€‚ä¸‹é¢å°±æ˜¯ä¸€ä¸ª telnet ä»è¿æ¥åˆ° set å¹¶ get çš„å®Œæ•´æŠ“åŒ…æˆªå›¾ï¼š\nä»æˆªå›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç»è¿‡ä¸‰æ¬¡æ¡æ‰‹åï¼Œå®¢æˆ·ç«¯å‘é€äº† ms foo 3 t90\\r\\nbar\\r\\n å‘½ä»¤ï¼Œç„¶å memcached æœåŠ¡å™¨è¿”å›äº† HD è¡¨ç¤ºå­˜å‚¨æˆåŠŸã€‚æ¥ç€å®¢æˆ·ç«¯å‘é€äº† mg foo t f v\\r\\n å‘½ä»¤ï¼Œmemcached æœåŠ¡å™¨è¿”å›äº† VA 3 t-1 s3\\r\\nbar\\r\\n è¡¨ç¤ºè·å–æˆåŠŸã€‚\néƒ½éå¸¸çš„ç›´è§‚ï¼Œè¿™é‡Œå”¯ä¸€éœ€è¦æ³¨æ„ t90 è¿™ ä¸ªflag ä½¿ç”¨é”™äº†ï¼Œåº”è¯¥æ˜¯ T90ï¼Œè¡¨ç¤º 90 ç§’åè¿‡æœŸï¼Œä½†æ˜¯ memcached æœåŠ¡å™¨å¹¶æ²¡æœ‰æŠ¥é”™ï¼Œè€Œæ˜¯ç›´æ¥å­˜å‚¨äº† -1 è¡¨ç¤ºæ°¸ä¸è¿‡æœŸã€‚\nå¦å¤–æˆ‘ä»¬ä¹Ÿä¼šæ³¨æ„åˆ°telnetå®¢æˆ·ç«¯å‘é€ ms foo 3 t90\\r\\nbar\\r\\n æ˜¯åˆ†æˆäº†ä¸¤ä¸ª TCP åŒ…å‘é€çš„ï¼Œè¿™æ˜¯å› ä¸º telnet é»˜è®¤æ˜¯è¡Œç¼“å†²æ¨¡å¼ï¼Œéœ€è¦æŒ‰ä¸‹å›è½¦é”®æ‰ä¼šå‘é€æ•°æ®ã€‚\nåˆ†æ1: memcached é›†ç¾¤æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ # æˆ‘ä»¬é€šå¸¸çœ‹åˆ° memcached çš„ä»‹ç»éƒ½ä¼šè¯´ memcached æ˜¯ä¸€ä¸ªâ€œåˆ†å¸ƒå¼â€ç¼“å­˜ç³»ç»Ÿï¼Œé‚£ä¹ˆ memcached æ˜¯å¦‚ä½•æ”¯æŒåˆ†å¸ƒå¼åœºæ™¯çš„å‘¢ï¼Ÿä»å®˜æ–¹æ–‡æ¡£ä¸­æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°è¿™æ ·çš„æè¿°ï¼š\nLogic Half in Client, Half in Server\nA â€œmemcached implementationâ€ is partially in a client, and partially in a server. Clients understand how to choose which server to read or write to for an item, what to do when it cannot contact a server.\nServers are Disconnected From Each Other\nMemcached servers are unaware of each other. There is no crosstalk, no synchronization, no broadcasting, no replication. Adding servers increases the available memory. Cache invalidation is simplified, as clients delete or overwrite data on the server which owns it directly.\næ„æ€å…¶å®å¾ˆç®€å•ï¼Œè™½ç„¶ memcached æ˜¯ä¸€ä¸ªâ€œåˆ†å¸ƒå¼â€ç¼“å­˜ç³»ç»Ÿï¼Œä½†æ˜¯å®ƒçš„åˆ†å¸ƒå¼æ˜¯éœ€è¦å®¢æˆ·ç«¯é…åˆçš„ä¼ªåˆ†å¸ƒå¼ï¼Œè€Œä¸æ˜¯é€šå¸¸æ„ä¹‰ä¸Šçš„åˆ†å¸ƒå¼ã€‚å®ƒæ‰€æ”¯æŒçš„åˆ†å¸ƒå¼æ˜¯æŒ‡å®¢æˆ·ç«¯å¯ä»¥é‡‡å–åˆ†ç‰‡ç®—æ³•æ¥å†³å®šæ•°æ®å­˜å‚¨åœ¨å“ªä¸ªæœåŠ¡å™¨ä¸Šï¼Œè€Œ memcached æœåŠ¡å™¨æœ¬èº«æ˜¯ä¸ä¼šç›¸äº’é€šä¿¡çš„ï¼Œä¹Ÿä¸ä¼šè¿›è¡Œæ•°æ®åŒæ­¥çš„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nè¿™æ ·çš„è®¾è®¡æœ‰åˆ©æœ‰å¼Šï¼Œä¼˜ç‚¹æ˜¯ memcached æœåŠ¡å™¨ä¹‹é—´ä¸éœ€è¦ç›¸äº’é€šä¿¡ï¼Œä¸éœ€è¦åŒæ­¥æ•°æ®ï¼Œå› æ­¤ memcached æœåŠ¡å™¨å¯ä»¥å¾ˆå®¹æ˜“çš„æ‰©å±•ï¼Œåªéœ€è¦å¢åŠ æœåŠ¡å™¨å°±å¯ä»¥å¢åŠ ç¼“å­˜å®¹é‡ã€‚ç¼ºç‚¹ä¹Ÿæ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œåˆ†å¸ƒå¼çš„ç‰¹æ€§éœ€è¦å®¢æˆ·ç«¯æ¥å®ç°ï¼Œè¿™å°±éœ€è¦å®¢æˆ·ç«¯æœ‰ä¸€å®šçš„åˆ†ç‰‡ç®—æ³•ï¼Œå¦‚æœæƒ³è¦å®ç°é«˜å¯ç”¨(æŸå°æœºå™¨å®•æœº)ï¼Œè¿˜éœ€è¦å®¢æˆ·ç«¯æ”¯æŒâ€œå¤åˆ¶â€æœºåˆ¶ã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ï¼ŒæŠ“åŒ…æ¥éªŒè¯è¿™ä¸€ç‚¹ï¼š\néƒ¨ç½² memcached é›†ç¾¤ # é€šè¿‡ docker å¯åŠ¨ä¸¤ä¸ª memcached å®ä¾‹, åˆ†åˆ«ç›‘å¬å®¿ä¸»æœºçš„ 11211 å’Œ 11212 ç«¯å£ version: \u0026#39;3\u0026#39; services: memcached1: image: memcached:1.5.6 ports: - \u0026#34;11211:11211\u0026#34; memcached2: image: memcached:1.5.6 ports: - \u0026#34;11212:11211\u0026#34; å®¢æˆ·ç«¯ä»£ç  from pymemcache.client.hash import HashClient client = HashClient([ \u0026#34;127.0.0.1:11211\u0026#34;, \u0026#34;127.0.0.1:11212\u0026#34;, ]) client.set(\u0026#34;key-0\u0026#34;, \u0026#34;I\u0026#39;ll be sent to node1(11211)\u0026#34;, expire=30) client.set(\u0026#34;key-2\u0026#34;, \u0026#34;I\u0026#39;ll be sent to node2(11212)\u0026#34;, expire=30) é€šè¿‡ wirehsark æŠ“åŒ…ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®¢æˆ·ç«¯æŒ‰ç…§é¢„æœŸå‘é€äº†ä¸¤ä¸ª set å‘½ä»¤ï¼Œåˆ†åˆ«å­˜å‚¨åœ¨ 11211 å’Œ 11212 ç«¯å£çš„ memcached æœåŠ¡å™¨ä¸Šï¼š\nè€Œå®¢æˆ·ç«¯ï¼ˆpymemcacheï¼‰çš„é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œé€šè¿‡ä½¿ç”¨ Rendezvous Hashing ç®—æ³•æ¥è®¡ç®—ç»„åˆ key (node-$key) çš„ hash å€¼ï¼Œé€‰æ‹© score æœ€é«˜çš„æœåŠ¡å™¨ï¼Œå¦‚ä¸‹ï¼š\n# self.hash_function = lambda x: murmur3_32(x) def get_node(self, key): high_score = -1 winner = None for node in self.nodes: score = self.hash_function(f\u0026#34;{node}-{key}\u0026#34;) if score \u0026gt; high_score: (high_score, winner) = (score, node) elif score == high_score: (high_score, winner) = (score, max(str(node), str(winner))) return winner è¿™é‡Œæœ‰æ„æ€çš„æ˜¯ï¼Œå®¢æˆ·ç«¯çš„åšæ³•ä¸æ˜¯éå¸¸å¸¸è§çš„ hash å–æ¨¡çš„æ–¹å¼ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ç§å«åš HRWï¼ˆHighest Random Weightï¼‰Hashing çš„ç®—æ³•ï¼Œè¿™ç§ç®—æ³•çš„ä¼˜ç‚¹æ˜¯å½“èŠ‚ç‚¹å¢åŠ æˆ–è€…å‡å°‘æ—¶ï¼Œå½±å“çš„æ•°æ®é‡æœ€å°ï¼Œè€Œä¸”ä¸éœ€è¦ç»´æŠ¤ä¸€è‡´æ€§å“ˆå¸Œç¯ã€‚\nå‡å¦‚æˆ‘ä»¬æœ‰ä¸‰ä¸ªèŠ‚ç‚¹ï¼ˆnode1, node2, node3ï¼‰ï¼Œkey1 -\u0026gt; node1ï¼Œkey2 -\u0026gt; node2ï¼Œkey3 -\u0026gt; node3\nå¦‚æœ node2 æŒ‚æ‰äº†ï¼Œé‚£ä¹ˆæœ€åçš„æƒ…å†µä¸‹ï¼škey1-\u0026gt; node3ï¼Œkey2 -\u0026gt; node3ï¼Œkey3 -\u0026gt; node1ï¼Œè¿™æ‰€æœ‰çš„ key éƒ½è¦é‡æ–°åˆ†é…ã€‚\nè€Œ HRW ç®—æ³•çš„ä¼˜ç‚¹æ˜¯ï¼šå½“ node2 æŒ‚æ‰äº†ï¼Œåªæœ‰ key2 -\u0026gt; node3 éœ€è¦é‡æ–°åˆ†é…ï¼Œå…¶ä»–çš„ key ä»ç„¶ä¿æŒåŸæ¥çš„åˆ†é…ï¼Œè¿™æ˜¯å› ä¸ºä¸€å¼€å§‹ key1 -\u0026gt; node1 å°±å·²ç»æ˜¯æœ€é«˜ï¼Œé‚£ä¹ˆèŠ‚ç‚¹å‡å°‘è¿™ä¸ªçŠ¶å†µä¹Ÿä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚\nåˆ†æ2: å…ƒæ–‡æœ¬åè®®æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ # é¡¾åæ€ä¹‰ï¼Œå…ƒæ–‡æœ¬åè®®è¿˜æ˜¯åŸºäºæ–‡æœ¬çš„ï¼Œä½†æ˜¯å®ƒå¼•å…¥äº†æ›´å¤šçš„å…ƒæ•°æ®æ ‡å¿—ï¼Œé€šè¿‡æ ‡å¿—çš„ç»„åˆé¿å…äº†å¤šæ¬¡ç½‘ç»œå¾€è¿”çš„é—®é¢˜ï¼Œè¿™å¯¹äºéœ€è¦ä¼˜åŒ– memcached ä½¿ç”¨åœºæ™¯æ˜¯éå¸¸æœ‰å¸®åŠ©çš„ã€‚\nä½†æ˜¯è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹ memcached å†…éƒ¨æ˜¯æ€ä¹ˆå¤„ç†å…ƒæ–‡æœ¬åè®®çš„ï¼Œä»¥ä¸‹æ˜¯ memcached æºç ä¸­å¯¹äºå…ƒæ–‡æœ¬åè®®çš„å¤„ç†ï¼š\nåè®®è§£æç‰‡æ®µ void process_command_ascii(conn *c, char *command) { // ... çœç•¥éƒ¨åˆ†ä»£ç  // Meta commands are all 2-char in length. char first = tokens[COMMAND_TOKEN].value[0]; if (first == \u0026#39;m\u0026#39; \u0026amp;\u0026amp; tokens[COMMAND_TOKEN].length == 2) { switch (tokens[COMMAND_TOKEN].value[1]) { case \u0026#39;g\u0026#39;: process_mget_command(c, tokens, ntokens); break; case \u0026#39;s\u0026#39;: process_mset_command(c, tokens, ntokens); break; // ... çœç•¥éƒ¨åˆ†ä»£ç  } } else if (first == \u0026#39;g\u0026#39;) { // Various get commands are very common. WANT_TOKENS_MIN(ntokens, 3); if (strcmp(tokens[COMMAND_TOKEN].value, \u0026#34;get\u0026#34;) == 0) { process_get_command(c, tokens, ntokens, false, false); } // ... çœç•¥éƒ¨åˆ†ä»£ç  } else if (first == \u0026#39;s\u0026#39;) { if (strcmp(tokens[COMMAND_TOKEN].value, \u0026#34;set\u0026#34;) == 0 \u0026amp;\u0026amp; (comm = NREAD_SET)) { WANT_TOKENS_OR(ntokens, 6, 7); process_update_command(c, tokens, ntokens, comm, false); } else if (strcmp(tokens[COMMAND_TOKEN].value, \u0026#34;stats\u0026#34;) == 0) { process_stat(c, tokens, ntokens); } else { out_string(c, \u0026#34;ERROR\u0026#34;); } } else if (first == \u0026#39;d\u0026#39;) { if (strcmp(tokens[COMMAND_TOKEN].value, \u0026#34;delete\u0026#34;) == 0) { WANT_TOKENS(ntokens, 3, 5); process_delete_command(c, tokens, ntokens); } else { out_string(c, \u0026#34;ERROR\u0026#34;); } } else if (first == \u0026#39;t\u0026#39;) { if (strcmp(tokens[COMMAND_TOKEN].value, \u0026#34;touch\u0026#34;) == 0) { WANT_TOKENS_OR(ntokens, 4, 5); process_touch_command(c, tokens, ntokens); } else { out_string(c, \u0026#34;ERROR\u0026#34;); } } else if (strcmp(tokens[COMMAND_TOKEN].value, \u0026#34;version\u0026#34;) == 0) { process_version_command(c); } else if (strcmp(tokens[COMMAND_TOKEN].value, \u0026#34;quit\u0026#34;) == 0) { process_quit_command(c); } // ... çœç•¥éƒ¨åˆ†ä»£ç  return; } å¯ä»¥çœ‹åˆ° meta åè®®æ˜¯åœ¨æ–‡æœ¬åè®®ä¹‹å‰çš„ï¼Œé€šè¿‡åˆ¤æ–­ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯å¦æ˜¯ m æ¥åˆ¤æ–­æ˜¯å¦æ˜¯ meta åè®®ï¼Œç„¶åå†æ ¹æ®ç¬¬äºŒä¸ªå­—ç¬¦æ¥åˆ¤æ–­å…·ä½“çš„ meta å‘½ä»¤ã€‚è‡³äºå†…éƒ¨çš„å¤„ç†é€»è¾‘ï¼Œå¤§ä½“æµç¨‹ä¸Šå’Œæ–‡æœ¬åè®®æ˜¯ä¸€è‡´çš„ï¼Œåªæ˜¯åœ¨å‘½ä»¤ä¸­å¢åŠ äº†æ›´å¤šçš„å…ƒæ•°æ®æ ‡å¿—ï¼Œè¿™é‡Œå°±ä¸å†å±•å¼€äº†ã€‚\næ–‡æœ¬åè®®æ¢³ç† # ğŸŸ© æ ‡è®°çš„æ˜¯æ ‡å‡†æ–‡æœ¬åè®®çš„å‘½ä»¤ â­•ï¸ æ ‡è®°çš„æ˜¯å…ƒæ–‡æœ¬åè®®çš„å‘½ä»¤\nCommand Usage Description Remark set set \u0026lt;key\u0026gt; \u0026lt;flags\u0026gt; \u0026lt;exptime\u0026gt; \u0026lt;bytes\u0026gt; [noreply]\\r\\n\u0026lt;data block\u0026gt;\\r\\n Stores data. ğŸŸ© add add \u0026lt;key\u0026gt; \u0026lt;flags\u0026gt; \u0026lt;exptime\u0026gt; \u0026lt;bytes\u0026gt; [noreply]\\r\\n\u0026lt;data block\u0026gt;\\r\\n Stores data only if the server doesn\u0026rsquo;t already hold data for this key. ğŸŸ© replace replace \u0026lt;key\u0026gt; \u0026lt;flags\u0026gt; \u0026lt;exptime\u0026gt; \u0026lt;bytes\u0026gt; [noreply]\\r\\n\u0026lt;data block\u0026gt;\\r\\n Stores data only if the server already holds data for this key. ğŸŸ© append append \u0026lt;key\u0026gt; \u0026lt;bytes\u0026gt; [noreply]\\r\\n\u0026lt;data block\u0026gt;\\r\\n Appends data to an existing key. ğŸŸ© prepend prepend \u0026lt;key\u0026gt; \u0026lt;bytes\u0026gt; [noreply]\\r\\n Prepends data to an existing key. ğŸŸ© cas cas \u0026lt;key\u0026gt; \u0026lt;flags\u0026gt; \u0026lt;exptime\u0026gt; \u0026lt;bytes\u0026gt; \u0026lt;cas unique\u0026gt; [noreply]\\r\\n\u0026lt;data block\u0026gt;\\r\\n \u0026ldquo;Check and set\u0026rdquo; operation; stores data only if no one else has updated since it was last fetched. ğŸŸ© ms (Meta Set) ms \u0026lt;key\u0026gt; \u0026lt;datalen\u0026gt; \u0026lt;flags\u0026gt;*\\r\\n\u0026lt;data block\u0026gt;\\r\\n Generic command for storing data to memcached. â­•ï¸ get get \u0026lt;key\u0026gt;*\\r\\n Retrieves data for one or more keys. ğŸŸ© gets gets \u0026lt;key\u0026gt;*\\r\\n Retrieves data for one or more keys, including CAS unique values. ğŸŸ© gat gat \u0026lt;exptime\u0026gt; \u0026lt;key\u0026gt;*\\r\\n Retrieves data and updates the expiration time of existing items. ğŸŸ© gats gats \u0026lt;exptime\u0026gt; \u0026lt;key\u0026gt;*\\r\\n Retrieves data and updates the expiration time of existing items, including CAS unique values. ğŸŸ© mg (Meta Get) mg \u0026lt;key\u0026gt; \u0026lt;flags\u0026gt;*\\r\\n Generic command for retrieving key data from memcached. â­•ï¸ delete delete \u0026lt;key\u0026gt; [noreply]\\r\\n Explicitly deletes items. ğŸŸ© incr incr \u0026lt;key\u0026gt; \u0026lt;value\u0026gt; [noreply]\\r\\n Increments the value of an item. ğŸŸ© decr decr \u0026lt;key\u0026gt; \u0026lt;value\u0026gt; [noreply]\\r\\n Decrements the value of an item. ğŸŸ© touch touch \u0026lt;key\u0026gt; \u0026lt;exptime\u0026gt; [noreply]\\r\\n Updates the expiration time of an existing item without fetching it. ğŸŸ© me (Meta Debug) me \u0026lt;key\u0026gt; \u0026lt;flag\u0026gt;\\r\\n Human readable dump of all available internal metadata of an item. â­•ï¸ md (Meta Delete) md \u0026lt;key\u0026gt; \u0026lt;flags\u0026gt;*\\r\\n Explicitly deletes items, marking them as \u0026ldquo;stale\u0026rdquo;. â­•ï¸ ma (Meta Arithmetic) ma \u0026lt;key\u0026gt; \u0026lt;flags\u0026gt;*\\r\\n Basic operations against numerical values, replacing \u0026ldquo;incr\u0026rdquo; and \u0026ldquo;decr\u0026rdquo; commands. â­•ï¸ mn (Meta No-Op) mn\\r\\n Returns a static response code. â­•ï¸ slabs reassign slabs reassign \u0026lt;source class\u0026gt; \u0026lt;dest class\u0026gt;\\r\\n Redistributes memory after the server hits its limit. ğŸŸ© Memcached Client å®ç° # è¿™æ˜¯æˆ‘å®ç°çš„ Go è¯­è¨€ memcached client åŒ…ï¼šhttps://github.com/yeqown/memcached æ”¯æŒæ ‡å‡†æ–‡æœ¬åè®®å’Œå…ƒæ–‡æœ¬åè®®ã€è¿æ¥æ± å’Œé›†ç¾¤æ¨¡å¼ç­‰åŠŸèƒ½ï¼Œæ¬¢è¿ä½¿ç”¨å’Œåé¦ˆã€‚\n"},{"id":11,"href":"/2024/12/17/%E8%BF%91%E6%9C%9F%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93/","title":"è¿‘æœŸçš„ä¸€äº›ç»éªŒæ€»ç»“","section":"Posts","content":" è¿™é‡Œä¸ä¼šè¿‡å¤šçš„ä»‹ç»è½¯ä»¶çš„ç›¸å…³æ¦‚å¿µå’Œæ¶æ„ï¼Œä¸»è¦æ˜¯é’ˆå¯¹å®é™…é—®é¢˜çš„è§£å†³æ–¹æ¡ˆå’Œæ€è€ƒã€‚\né—®é¢˜æ±‡æ€» # CDC ç›¸å…³\nCDC kafka-connect mysql sink ä¾§æ¶ˆè´¹ç§¯å‹é—®é¢˜ CDC kafka-connect mysql source ä¾§åˆ é™¤äº‹ä»¶æŠ•é€’äº†ä¸¤æ¡äº‹ä»¶ï¼Œå¯¼è‡´åˆ é™¤åŠ¨ä½œæ•°æ®é‡è¢«æ”¾å¤§ CDC kafka-connect mongodb æ•°æ®åŒæ­¥ä»»åŠ¡å¼‚å¸¸ï¼ˆæ¶ˆæ¯è¶…è¿‡ 1MB ï¼‰ æ›´æ–°äº: 2025-02-06\nCDC Elasticsearch sink æ€ä¹ˆè‡ªå®šä¹‰ç´¢å¼•åç§°ï¼Ÿ è‡ªå®šä¹‰ transform å®ç°è‡ªå®šä¹‰ç´¢å¼•åç§° æ›´æ–°äºï¼š2025-10-11\nCDC kafka-connect mongodb ä¾§åå¤è¿›è¡Œ â€œå¿«ç…§â€ å¯¼è‡´æ•°æ®åŒæ­¥å¼‚å¸¸ DMS æ•°æ®åŒæ­¥ç›¸å…³\næ•°æ®è¿ç§»å®Œæˆåï¼Œæ€ä¹ˆå¯¹æ¯”æºæ•°æ®å’Œç›®æ ‡æ•°æ®æ˜¯å¦ä¸€è‡´ï¼Ÿ å¦‚æœä¸ä¸€è‡´æ€ä¹ˆå¤„ç†ï¼Ÿ Istio ç›¸å…³\nIstio ä¸­å¤šä¸ª gateway ä½¿ç”¨ç›¸åŒ hostï¼Œanalyze æ˜¯æç¤ºé”™è¯¯ Istio ä¸­ä¸€ä¸ªæœåŠ¡æä¾›äº†å¤šä¸ªç«¯å£çš„æœåŠ¡ï¼Œæ€ä¹ˆé…ç½® Virtual Service ï¼Ÿ APISIX ç›¸å…³\nä½¿ç”¨ APISIX ä½œä¸ºç½‘å…³ï¼Œæ€ä¹ˆè¿›è¡Œæœ‰æ¡ä»¶çš„å“åº”é‡å†™ï¼Ÿ APISIX æ’ä»¶çš„æ‰§è¡Œé¡ºåºæ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ ShardingSphere Proxy\nHINTç­–ç•¥ åœ¨ ShardingSphere Proxy ä¸­çš„ä½¿ç”¨ Kafka ç›¸å…³\nå¦‚ä½•å°†è¿ç§»kafkaé›†ç¾¤ä¸­çš„æ•°æ®ï¼Ÿ Pyroscope ç›¸å…³\nä½¿ç”¨ Go Pull æ¨¡å¼é‡‡é›†æ•°æ®æ—¶ä¸ºä»€ä¹ˆåªæœ‰ cpu + gourotines + cpu samples ä¸‰ä¸ªæŒ‡æ ‡ï¼Ÿ Doris ç›¸å…³\nåŠ¨æ€åˆ†åŒºè¡¨æ’å…¥æ•°æ®æ—¶å¤±è´¥ï¼Œæç¤º \u0026ldquo;no partition for this tuple\u0026rdquo; 1. CDC ç›¸å…³ # CDC æ˜¯ Change Data Capture çš„ç¼©å†™ï¼Œå³å˜æ›´æ•°æ®æ•è·ã€‚CDC æ˜¯ä¸€ç§è½¯ä»¶æ¨¡å¼ï¼Œç”¨äºæ•è·å’Œè·Ÿè¸ªæ•°æ®åº“ä¸­çš„å˜æ›´ã€‚CDC é€šå¸¸ç”¨äºå¤åˆ¶æ•°æ®ã€æ•°æ®é›†æˆå’Œæ•°æ®ä»“åº“åŠ è½½ç­‰åœºæ™¯ã€‚\nè¿™é‡Œ CDC çš„æŠ€æœ¯å®ç°ä¸ºä½¿ç”¨ kafka-connect è¿æ¥ mysql å’Œ mongodb å°†æ•°æ®åŒæ­¥åˆ°å¼‚æ„ç³»ç»Ÿä¸­ elasticsearchã€‚source å’Œ sink connector ä½¿ç”¨çš„ debezium æ’ä»¶ã€‚kafka-connect æ˜¯åŸºäº kafka æ„å»ºçš„æ²Ÿé€šæ•°æ®ç³»ç»Ÿçš„å¯é å·¥å…·ï¼Œå®ƒæœ€å¸¸ç”¨äºå°†æ•°æ®å¼‚æ„å­˜å‚¨ï¼Œä»¥æ»¡è¶³ç¦»çº¿æŸ¥è¯¢å’Œåˆ†æã€æ•°æ®ä»“åº“ã€æ•°æ®æ¹–ç­‰éœ€æ±‚ã€‚\nè¿™é‡Œä½¿ç”¨åˆ° mysql source connector çš„é…ç½®å¦‚ä¸‹ï¼š\n{ \u0026#34;name\u0026#34;: \u0026#34;xxx\u0026#34;, \u0026#34;connector.class\u0026#34;: \u0026#34;io.debezium.connector.mysql.MySqlConnector\u0026#34;, \u0026#34;include.schema.changes\u0026#34;: \u0026#34;true\u0026#34;, \u0026#34;topic.prefix\u0026#34;: \u0026#34;mysql-xxx\u0026#34;, // é…ç½®äº† Reroute transformï¼Œå°† çœŸå®è¡¨ å½’é›†åˆ°ä¸€ä¸ª é€»è¾‘è¡¨å¯¹åº”çš„ topic ä¸­ \u0026#34;transforms\u0026#34;: \u0026#34;Reroute\u0026#34;, \u0026#34;transforms.Reroute.type\u0026#34;: \u0026#34;io.debezium.transforms.ByLogicalTableRouter\u0026#34;, \u0026#34;transforms.Reroute.topic.regex\u0026#34;: \u0026#34;xxx\u0026#34;, \u0026#34;transforms.Reroute.key.enforce.uniqueness\u0026#34;: \u0026#34;false\u0026#34;, \u0026#34;transforms.Reroute.topic.replacement\u0026#34;: \u0026#34;\u0026lt;topic_prefix\u0026gt;\u0026#34;, \u0026#34;schema.history.internal.kafka.topic\u0026#34;: \u0026#34;mysql-connector.schemahistory.xxx\u0026#34;, \u0026#34;schema.history.internal.kafka.bootstrap.servers\u0026#34;: \u0026#34;\u0026lt;kafka_server\u0026gt;\u0026#34;, \u0026#34;database.include.list\u0026#34;: \u0026#34;\u0026lt;database_name or regex\u0026gt;\u0026#34;, \u0026#34;database.port\u0026#34;: \u0026#34;\u0026lt;mysql_port\u0026gt;\u0026#34;, \u0026#34;database.hostname\u0026#34;: \u0026#34;\u0026lt;mysql_host\u0026gt;\u0026#34;, \u0026#34;database.password\u0026#34;: \u0026#34;\u0026lt;mysql_pass\u0026gt;\u0026#34;, \u0026#34;database.user\u0026#34;: \u0026#34;\u0026lt;mysql_user\u0026gt;\u0026#34;, \u0026#34;table.exclude.list\u0026#34;: \u0026#34;\u0026lt;table_name or regex\u0026gt;\u0026#34;, } mysql sink connector çš„é…ç½®å¦‚ä¸‹ï¼š\n{ \u0026#34;name\u0026#34;: \u0026#34;\u0026lt;connector name\u0026gt;\u0026#34;, \u0026#34;connector.class\u0026#34;: \u0026#34;io.confluent.connect.elasticsearch.ElasticsearchSinkConnector\u0026#34;, \u0026#34;behavior.on.null.values\u0026#34;: \u0026#34;DELETE\u0026#34;, \u0026#34;tasks.max\u0026#34;: \u0026#34;1\u0026#34;, // ä»»åŠ¡æ•°å¯¹åº” consumer group çš„æ¶ˆè´¹è€…å®ä¾‹æ•° \u0026#34;key.ignore\u0026#34;: \u0026#34;false\u0026#34;, \u0026#34;write.method\u0026#34;: \u0026#34;UPSERT\u0026#34;, \u0026#34;connection.url\u0026#34;: \u0026#34;\u0026lt;es_addr\u0026gt;\u0026#34;, \u0026#34;topics.regex\u0026#34;: \u0026#34;\u0026lt;topic_regex\u0026gt;\u0026#34;, \u0026#34;transforms\u0026#34;: \u0026#34;unwrap,key\u0026#34;, // unwrap tranform é…ç½®ï¼Œå¤„ç†åˆ é™¤äº‹ä»¶ï¼šå°†åˆ é™¤äº‹ä»¶çš„ value è®¾ç½®ä¸º null \u0026#34;transforms.unwrap.type\u0026#34;: \u0026#34;io.debezium.transforms.ExtractNewRecordState\u0026#34;, \u0026#34;transforms.unwrap.delete.handling.mode\u0026#34;: \u0026#34;none\u0026#34;, \u0026#34;transforms.unwrap.drop.tombstones\u0026#34;: \u0026#34;false\u0026#34;, // key tranform é…ç½®ï¼Œè®¾ç½® ES çš„ docID ä¸º mysql æ•°æ®è¡¨ä¸­çš„id (ä¸»é”®) \u0026#34;transforms.key.field\u0026#34;: \u0026#34;id\u0026#34;, \u0026#34;transforms.key.type\u0026#34;: \u0026#34;org.apache.kafka.connect.transforms.ExtractField$Key\u0026#34;, } 1.1 CDC kafka-connect mysql sink ä¾§æ¶ˆè´¹ç§¯å‹é—®é¢˜ # ç§¯å‹çš„åŸå› ï¼Œé’ˆå¯¹ mysql source / sink connector åªä½¿ç”¨äº†ä¸€ä¸ªåˆ†åŒºã€‚ä¼—æ‰€å‘¨çŸ¥ topic åˆ†åŒºæ•°ä¼šç›´æ¥å½±å“åˆ°æ¶ˆè´¹çš„å¹¶å‘åº¦ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªåˆ†åŒºï¼Œé‚£ä¹ˆåªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹ï¼Œæ¶ˆè´¹è€…çš„æ¶ˆè´¹é€Ÿåº¦å°±ä¼šå—åˆ°é™åˆ¶ã€‚è§£å†³æ–¹æ¡ˆæ˜¯å¢åŠ åˆ†åŒºæ•°ï¼Œå¢åŠ æ¶ˆè´¹è€…çš„å¹¶å‘åº¦ã€‚\nè¿™é‡Œå­˜åœ¨çš„ç–‘æƒ‘æ˜¯ï¼š\nmysql ç›¸å…³çš„ connector æ˜¯å¦åªèƒ½ä½¿ç”¨ä¸€ä¸ªåˆ†åŒºï¼Ÿè¿˜èƒ½å¦ä¿è¯é¡ºåºæ¶ˆè´¹ï¼Ÿ æœ‰äººåé¦ˆçš„çš„åªèƒ½ä½¿ç”¨ä¸€ä¸ªåˆ†åŒºçš„ topic æ˜¯æŒ‡çš„è¿™éƒ¨åˆ†å—ï¼Ÿ å¢åŠ  topic æ•°ä¹‹åï¼Œsource connector å’Œ sink connector éƒ½èƒ½å¤Ÿå¢åŠ å¹¶è¡Œçš„ä»»åŠ¡å—ï¼Ÿ æ–‡æ¡£æŸ¥é˜…å’Œå®éªŒï¼š\nåœ¨æœ€å¼€å§‹ä½¿ç”¨æ—¶ï¼Œå½“æ—¶ç¡®å®šä¸ºåªæœ‰ä¸€ä¸ªåˆ†åŒºæ˜¯ç”±äºæ–‡æ¡£ä¸­æåŠäº†ï¼š\nhttps://debezium.io/documentation/reference/stable/connectors/mysql.html#mysql-schema-change-topic\nNever partition the database schema history topic. For the database schema history topic to function correctly, it must maintain a consistent, global order of the event records that the connector emits to it.\nTo ensure that the topic is not split among partitions, set the partition count for the topic by using one of the following methods:\nIf you create the database schema history topic manually, specify a partition count of 1.\nIf you use the Apache Kafka broker to create the database schema history topic automatically, the topic is created, set the value of the Kafka num.partitions \u0026gt; configuration option to 1.\nä½†æ˜¯å®é™…ä¸Šçœ‹æ¥ï¼Œè¿™é‡Œçš„æ„æ€æ˜¯æŒ‡çš„ schema history topic è€Œä¸æ˜¯å…¶ä»–çš„ topicã€‚å”¯ä¸€æ‰¾åˆ°é™åˆ¶æ˜¯ mysql source connector task åªèƒ½ä¸º 1 å¦‚ä¸‹æ‰€ç¤ºï¼š\ntasks.max\nDefault value: 1\nThe maximum number of tasks to create for this connector. Because the MySQL connector always uses a single task, changing the default value has no effect.\nå› æ­¤åˆ†åŒºæ•°ä¸º 1 åªæ˜¯â€œå†å²â€é—®é¢˜ï¼Œå®é™…ä¸Šå¯ä»¥å¢åŠ åˆ†åŒºæ•°ï¼Œä»¥å¢åŠ æ¶ˆè´¹ä¾§å¹¶å‘åº¦ã€‚\nå¦å¤–æ–‡æ¡£ä¸­ä¹Ÿè¯´æ˜äº† source connector æŠ•é€’æ¶ˆæ¯çš„ message key å¯ä»¥è‡ªå®šä¹‰ key, å…¶é»˜è®¤å€¼ä¸ºæ•°æ®åº“è¡¨çš„ä¸»é”®ï¼Œè¿™æ ·å¯ä»¥ä¿è¯åŒä¸€æ¡æ•°æ®çš„å˜æ›´äº‹ä»¶è¢«æŠ•é€’åˆ°åŒä¸€ä¸ªåˆ†åŒºä¸­ï¼Œä»è€Œä¿è¯äº†é¡ºåºæ€§ã€‚\nå¦‚ä¸‹æ˜¯çœŸå®ç¯å¢ƒä¸­ä¸€æ¡æ•°æ®çš„å˜æ›´äº‹ä»¶çš„ message key ç¤ºä¾‹ï¼š\n{ \u0026#34;schema\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;struct\u0026#34;, \u0026#34;fields\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;int64\u0026#34;, \u0026#34;optional\u0026#34;: false, \u0026#34;field\u0026#34;: \u0026#34;id\u0026#34; } ], \u0026#34;optional\u0026#34;: false, \u0026#34;name\u0026#34;: \u0026#34;$connectorName.$dbName.$tblName.Key\u0026#34; }, \u0026#34;payload\u0026#34;: { \u0026#34;id\u0026#34;: 1075966706511257600 // å”¯ä¸€çš„å˜é‡ï¼Œå³ä¸»é”®åˆ—çš„å€¼ } } å¤„ç†æ‰‹æ®µï¼š\nè°ƒæ•´ mysql sink connector çš„ topic åˆ†åŒºæ•°ï¼Œå¢åŠ å¹¶å‘åº¦ã€‚ ./kafka-topics.sh --bootstrap-server \u0026lt;kafka_server\u0026gt; --alter --topic \u0026lt;topic_name\u0026gt; --partitions \u0026lt;new_partition_num\u0026gt; è°ƒæ•´ mysql sink connector çš„ä»»åŠ¡æ•°ä¸åˆ†åŒºæ•°ä¸€è‡´ï¼ˆè¿™é‡Œ20ä¸ºç¤ºä¾‹ï¼‰ï¼Œä»¥ä¿è¯æ¯ä¸ªä»»åŠ¡éƒ½èƒ½å¤Ÿæ¶ˆè´¹åˆ°æ•°æ®ã€‚ - â€œtasks.maxâ€: \u0026#34;1\u0026#34; + â€œtasks.maxâ€: \u0026#34;20\u0026#34; æ³¨æ„ï¼šå¢åŠ åˆ†åŒºæ•°ï¼Œå¤§æ¦‚ç‡ä¼šå¯¼è‡´æŸäº›æ¶ˆæ¯ä»ä¹‹å‰çš„åˆ†åŒºè¢«æŠ•é€’åˆ°æ–°çš„åˆ†åŒºï¼Œè¿™æ ·ä¼šå¯¼è‡´æ¶ˆæ¯çš„é¡ºåºæ€§è¢«æ‰“ä¹±ï¼Œå› æ­¤è¦è°¨æ…å¤„ç†ï¼Œè¦ä¹ˆèƒ½å¤Ÿå®¹å¿è¿™ç§å¼‚å¸¸ï¼Œè¦ä¹ˆäº‹åæ¢å¤æœ€ç»ˆä¸€è‡´ï¼Œä¹Ÿå¯ä»¥å…ˆåœæ­¢ç”Ÿäº§ç­‰æ¶ˆè´¹å®Œæ¯•åå†è¡Œè°ƒæ•´ã€‚\n1.2 CDC kafka-connect mysql source ä¾§åˆ é™¤äº‹ä»¶æŠ•é€’äº†ä¸¤æ¡äº‹ä»¶ï¼Œå¯¼è‡´åˆ é™¤åŠ¨ä½œæ•°æ®é‡è¢«æ”¾å¤§ # è¿™ä¸ªé—®é¢˜çš„èƒŒæ™¯æ˜¯ï¼Œmysql éƒ¨åˆ†è¡¨æ•°æ®é‡æå¤§ï¼Œä¸ªåˆ«å•è¡¨è¶…è¿‡ 100 million æ¡æ•°æ®ï¼Œä¸”æ—¥å¢é‡æå¤§ï¼Œå› æ­¤ä¼šå®šæœŸåˆ é™¤ã€‚å®šæœŸåˆ é™¤ä¸€å¼€å§‹é€‰æ‹©çš„æ˜¯ä½¿ç”¨ mysql Event Scheduler å®šæ—¶ä»»åŠ¡ + Procedure åˆ é™¤ï¼Œä½†è¿™ç§æ–¹å¼å¯¹äºè¿ç»´äººå‘˜çš„è¦æ±‚è¾ƒé«˜ï¼Œä¸”ä¸å¤Ÿçµæ´»ï¼ˆåˆ†åº“åˆ†è¡¨åœºæ™¯ä¸‹ï¼‰ï¼Œå…¶æ¬¡åœ¨ä¸šåŠ¡é«˜å³°æœŸåˆ é™¤æ“ä½œä¼šå½±å“åˆ°ä¸šåŠ¡çš„æ­£å¸¸è¿è¡Œã€‚å› æ­¤å¦å¤–é€‰æ‹©äº†è‡ªè¡Œå®ç°ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œå®šæ—¶åˆ é™¤æ•°æ®ï¼Œä»¥é¿å¼€ä¸šåŠ¡é«˜å³°ã€‚\nä½†æ˜¯éƒ¨ç½²ä¸Šçº¿æ—¶å‘ç°ä¸€ä¸ªé—®é¢˜ï¼šåˆ é™¤çš„æ•°æ®é‡å¤§æ¦‚æ˜¯ 20 Million æ¡ï¼Œä½†æ˜¯ kafka ä¸­çš„æ¶ˆæ¯æ•°é‡æ˜¯ 40 Million æ¡ï¼Œä¸”æ¯æ¡æ¶ˆæ¯éƒ½æ˜¯åˆ é™¤æ“ä½œã€‚\næ¼”ç¤ºå¦‚ä¸‹å›¾ä¸­æ‰€ç¤ºï¼Œé’ˆå¯¹åŒä¸€æ¡æ•°æ®çš„åˆ é™¤æ“ä½œï¼Œsource connector æŠ•é€’äº†ä¸¤æ¡æ¶ˆæ¯ï¼Œå¯¼è‡´æ•°æ®é‡è¢«æ”¾å¤§ã€‚\næ–‡æ¡£æŸ¥é˜…ï¼š\nDebezium/Source Connector/Mysql#delete events Debezium/Source Connector/Mysql#tombstone events When a row is deleted, the delete event value still works with log compaction, because Kafka can remove all earlier messages that have that same key. However, for Kafka to remove all messages that have that same key, the message value must be null. To make this possible, after the Debezium MySQL connector emits a delete event, the connector emits a special tombstone event that has the same key but a null value.\nè¿™æ„å‘³ç€å½“ä¸€æ¡æ•°æ®è¢«åˆ é™¤æ—¶ï¼Œsource connector ä¼šå…ˆæŠ•é€’ä¸€æ¡åˆ é™¤äº‹ä»¶ï¼Œç„¶åå†æŠ•é€’ä¸€æ¡ tombstone äº‹ä»¶ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†ä¿è¯ kafka çš„ log compaction æœºåˆ¶èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œå³å¦‚æœä¸€æ¡æ•°æ®è¢«åˆ é™¤åï¼Œå½“ log compaction å¼€å¯æ—¶ï¼Œkafka å¯ä»¥åˆ é™¤æ‰€æœ‰ä¹‹å‰çš„æ¶ˆæ¯ï¼Œåªä¿ç•™æœ€æ–°çš„æ¶ˆæ¯ï¼ˆå³è¢«åˆ é™¤çš„çŠ¶æ€ï¼‰ï¼Œå½“å…¶ä»–ç³»ç»Ÿæ¶ˆè´¹æ—¶ï¼Œåªéœ€è¦å…³æ³¨æœ€æ–°çš„çŠ¶æ€å³å¯ã€‚\nKafka Log Compaction å‚è€ƒï¼šKafka Log Compaction\nä½†åœ¨æˆ‘ä»¬çš„å®é™…åœºæ™¯ä¸­ï¼ŒLog Compaction æœºåˆ¶å¹¶ä¸é€‚ç”¨ä¹Ÿæ²¡æœ‰å¼€å¯ï¼Œå› æ­¤ä¸éœ€è¦ tombstone äº‹ä»¶ï¼Œåªéœ€è¦åˆ é™¤äº‹ä»¶å³å¯ã€‚ä¸é€‚ç”¨çš„åŸå› åœ¨äºï¼Œå½“æ•°æ®è¢«åˆ é™¤æ—¶ç¦»å®ƒçš„åˆ›å»ºæ—¶é—´å·²ç»è¿‡å»äº†å¾ˆä¹…ï¼ŒåŒæ—¶ kafka ä¸­ä¹Ÿåªä¿ç•™ 7d çš„æ•°æ®ï¼Œå› æ­¤ tombstone äº‹ä»¶å¯¹æˆ‘ä»¬æ¥è¯´æ²¡æœ‰æ„ä¹‰ã€‚\nå¤„ç†æ‰‹æ®µï¼š\nè°ƒæ•´ source connecor é…ç½®ï¼Œå¢åŠ  unwrap tranform ä»¥åˆ é™¤ä¸å¿…è¦çš„åˆ é™¤äº‹ä»¶ã€‚ - \u0026#34;transforms\u0026#34;: \u0026#34;Reroute\u0026#34;, + \u0026#34;transforms\u0026#34;: \u0026#34;Reroute,unwrap\u0026#34;, + \u0026#34;transforms.unwrap.type\u0026#34;: \u0026#34;io.debezium.transforms.ExtractNewRecordState\u0026#34;, + \u0026#34;transforms.unwrap.delete.handling.mode\u0026#34;: \u0026#34;none\u0026#34;, + \u0026#34;transforms.unwrap.delete.tomstones.handling.mode\u0026#34;: \u0026#34;tomstone\u0026#34;, è°ƒæ•´åçš„æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nè¿˜å¯ä»¥ç›´æ¥è°ƒæ•´ source connector çš„é…ç½®ï¼Œä¸äº§ç”Ÿä»»ä½•çš„åˆ é™¤äº‹ä»¶ï¼Œä»è€Œå‡å°‘æ¶ˆæ¯é‡ã€‚ - \u0026#34;transforms\u0026#34;: \u0026#34;Reroute\u0026#34;, + \u0026#34;transforms\u0026#34;: \u0026#34;Reroute,unwrap\u0026#34;, + \u0026#34;transforms.unwrap.type\u0026#34;: \u0026#34;io.debezium.transforms.ExtractNewRecordState\u0026#34;, + \u0026#34;transforms.unwrap.drop.tombstones\u0026#34;: \u0026#34;true\u0026#34;, + \u0026#34;transforms.unwrap.delete.handling.mode\u0026#34;: \u0026#34;drop\u0026#34; 1.3 CDC kafka-connect mongodb æ•°æ®åŒæ­¥ä»»åŠ¡å¼‚å¸¸ï¼ˆæ¶ˆæ¯è¶…è¿‡ 1MB ï¼‰ # è¿™ä¸ªé—®é¢˜æ˜¯å¶ç„¶å‘ç° mongodb source connector å¼‚å¸¸ï¼ŒæŸ¥çœ‹æ—¥å¿—å‘ç°å¦‚ä¸‹å¼‚å¸¸ï¼š\norg.apache.kafka.connect.errors.ConnectException: Unrecoverable exception from producer send callback at org.apache.kafka.connect.runtime.WorkerSourceTask.maybeThrowProducerSendException(WorkerSourceTask.java:334) at org.apache.kafka.connect.runtime.WorkerSourceTask.prepareToSendRecord(WorkerSourceTask.java:128) at org.apache.kafka.connect.runtime.AbstractWorkerSourceTask.sendRecords(AbstractWorkerSourceTask.java:404) at org.apache.kafka.connect.runtime.AbstractWorkerSourceTask.execute(AbstractWorkerSourceTask.java:361) at org.apache.kafka.connect.runtime.WorkerTask.doRun(WorkerTask.java:204) at org.apache.kafka.connect.runtime.WorkerTask.run(WorkerTask.java:259) at org.apache.kafka.connect.runtime.AbstractWorkerSourceTask.run(AbstractWorkerSourceTask.java:75) at org.apache.kafka.connect.runtime.isolation.Plugins.lambda$withClassLoader$1(Plugins.java:181) at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515) at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264) at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) at java.base/java.lang.Thread.run(Thread.java:829) Caused by: org.apache.kafka.common.errors.RecordTooLargeException: The message is 1096354 bytes when serialized which is larger than 1048576, which is the value of the max.request.size configuration. å¦‚æœæ˜¯ç†Ÿæ‚‰ java + kafka å¼€å‘çš„åŒå­¦ï¼Œåº”è¯¥ä¸€çœ¼å°±èƒ½çœ‹å‡ºæ¥æ˜¯æ¶ˆæ¯è¶…è¿‡äº† kafka çš„ max.request.size é…ç½®ï¼Œå¯¼è‡´æ¶ˆæ¯å‘é€å¤±è´¥ã€‚\næ–‡æ¡£æŸ¥é˜…ï¼š\nè¿™é‡Œèµ°äº†â€œå¼¯è·¯â€å»ç¿»äº†æ–‡æ¡£ï¼Œæ˜¯å› ä¸ºå¯¹ java + kafka å¼€å‘ä¸ç†Ÿæ‚‰ï¼Œåªæ˜¯å¤§è‡´çŒœæµ‹æ˜¯æ¶ˆæ¯å°ºå¯¸è¶…è¿‡äº† kafka çš„é™åˆ¶ï¼Œå› æ­¤æŸ¥é˜…äº† kafka çš„æ–‡æ¡£ã€‚\nApache Kafka Producer Config#max.request.size Apache Kafka Broker Config#message.max.bytes å¤„ç†æ‰‹æ®µï¼š\nè°ƒæ•´ kafka broker çš„ message.max.bytes é…ç½®ï¼Œå¢åŠ æ¶ˆæ¯çš„æœ€å¤§å°ºå¯¸ã€‚\n./kafka-configs.sh --zookeeper \u0026lt;zookeeper\u0026gt; --entity-type brokers --entity-name \u0026lt;broker_id\u0026gt; --alter --add-config message.max.bytes=10485760 è°ƒæ•´ kafka connect çš„é…ç½®ï¼Œå¢åŠ  producer.max.request.size é…ç½®ã€‚\n+ producer.max.request.size=10485760 // 10MB 1.4 CDC Elasticsearch sink æ€ä¹ˆè‡ªå®šä¹‰ç´¢å¼•åç§°ï¼Ÿ # èƒŒæ™¯ï¼š é€šè¿‡ CDC å°†æ•°æ®å¼‚æ„åˆ° Elasticsearch ä¸­ï¼Œ MySQL çš„é€»è¾‘è¡¨ è·Ÿ ES ç´¢å¼•ä¸€ä¸€å¯¹åº”ã€‚éšç€ä¸šåŠ¡å¢é•¿ï¼Œæ•°æ®é‡ä¸æ–­å¢é•¿ï¼Œç´¢å¼•æ•°é‡ä¹Ÿåœ¨ä¸æ–­å¢åŠ ï¼Œç›´åˆ°è¶…è¿‡äº† Elasticsearch çš„é™åˆ¶ å•ä¸€åˆ†ç‰‡çš„æ–‡æ¡£æ•°é‡ä¸èƒ½è¶…è¿‡ 2^31 - 1 çº¦ä¸º 21äº¿ä¸ªæ–‡æ¡£ã€‚\nè¯¥æ•°æ®ä¸ºæµæ°´æ•°æ®ï¼Œå…¶ä¸šåŠ¡ç‰¹æ€§ä¸ºï¼šåªå†™ä¸æ”¹ï¼Œä¿å­˜3ä¸ªæœˆï¼Œå› æ­¤è¿™é‡Œçš„è§£å†³æ€è·¯æœ‰ä¸¤ç§ï¼š\nè°ƒæ•´ç´¢å¼•çš„åˆ†ç‰‡æ•°ï¼ˆä¹‹å‰ä¸º 1ï¼‰ æ ¹æ®æ—¥æœŸåˆ†åˆ«ç´¢å¼•ï¼Œæ¯”å¦‚ï¼šindex_name_20240101ï¼Œindex_name_20240102ï¼Œä»¥æ­¤ç±»æ¨ã€‚ ä¸¤ç§æ–¹æ¡ˆæœ‰å…¶å„è‡ªçš„ä¼˜ç¼ºç‚¹ï¼š\nES ä¼šå°½é‡è®©åˆ†ç‰‡åˆ†æ•£ä¿å­˜åœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œé™ä½å•ä¸ªèŠ‚ç‚¹æ•…éšœæ—¶çš„å½±å“ã€‚åˆ†ç‰‡çš„åˆ†é…ç­–ç•¥ä¸»è¦è€ƒé‡ä¸¤ä¸ªå› ç´ ï¼š\nåˆ†ç‰‡æ•°é‡ï¼šå¤§å¤šæ•°æœç´¢ä¼šå‘½ä¸­å¤šä¸ªåˆ†ç‰‡ï¼Œæ¯ä¸ªåˆ†ç‰‡çš„æœç´¢ä¼šå ç”¨æœç´¢çº¿ç¨‹å’Œå…¶ä»–èµ„æºã€‚ES é»˜è®¤å•ä¸ªèŠ‚ç‚¹æœ€å¤š 1000 åˆ†ç‰‡ã€‚\nåˆ†ç‰‡å¤§å°: åˆ†ç‰‡åˆç†çš„å¤§å°ä¸º 10-50GBã€‚ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥å®¹çº³çš„åˆ†ç‰‡æ•°é‡ä¸èŠ‚ç‚¹çš„å †å†…å­˜æˆæ­£æ¯”ï¼Œå°äº20åˆ†ç‰‡/æ¯GBå †å†…å­˜ï¼›\né€‚å½“å¢åŠ åˆ†ç‰‡æ•°ä¼šå¢åŠ ç³»ç»Ÿçš„ååé‡ï¼Œæé«˜åˆ©ç”¨ç‡ï¼›ä½†æ˜¯åˆ†ç‰‡æ•°è¿‡å¤šä¼šå¯¼è‡´ç³»ç»Ÿçš„æ€§èƒ½ä¸‹é™ï¼Œå¢åŠ ç³»ç»Ÿçš„è´Ÿæ‹…ã€‚\næ–¹æ¡ˆä¸€ï¼šè°ƒæ•´åˆ†ç‰‡æ•° ï¼ˆå¦‚ï¼š1 =\u0026gt; 3ï¼‰\nä¼˜ç‚¹ï¼š ä¸šåŠ¡æ— æ„Ÿï¼Œä¸éœ€è¦ä¿®æ”¹ä¸šåŠ¡ä»£ç  å¯ä»¥æé«˜ååé‡ ç¼ºç‚¹ï¼š åˆ†ç‰‡æ•°è°ƒæ•´ä¸çµæ´»ï¼Œå½“æ•°æ®å¢é‡å†æ¬¡è¶…é™åˆ¶æ—¶ï¼Œè¿˜éœ€è¦å†æ¥ä¸€æ¬¡ï¼ˆé‡å»ºæˆæœ¬æ›´é«˜ï¼‰ã€‚ éœ€è¦é‡å»ºç´¢å¼•ï¼Œåœ¨æ•°æ®é‡éå¸¸å¤§çš„æƒ…å†µä¸‹éœ€è¦æ…é‡æ“ä½œï¼Œé¿å…é•¿æ—¶é—´é™ä½é›†ç¾¤æ€§èƒ½ æ–¹æ¡ˆäºŒï¼šæ ¹æ®æ—¥æœŸåˆ†åˆ«ç´¢å¼•ï¼Œä¸šåŠ¡ä¸­ä½¿ç”¨ alias æŒ‡å‘å…¨éƒ¨çš„ç´¢å¼•\nä¼˜ç‚¹ï¼š å¯ä»¥çµæ´»çš„åˆ é™¤ç´¢å¼•æ•°æ® å¯ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½ ç¼ºç‚¹ï¼š ç´¢å¼•æ•°é‡ï¼Œåˆ†ç‰‡æ•°é‡å¢åŠ è¾ƒå¤šï¼Œéœ€è¦è€ƒè™‘é›†ç¾¤çš„æ€§èƒ½ éœ€è¦\u0026quot;é‡å»º\u0026quot;ç´¢å¼• ES Sink Connector éœ€è¦æŒ‰ç…§æ—¥æœŸç´¢å¼•çš„èƒ½åŠ› The Kafka source topic name is used to create the destination index name in Elasticsearch. You can change this name prior to it being used as the index name with a Single Message Transformation (SMT)â€“RegexRouter or TimeStampRouterâ€“only when the flush.synchronously configuration property is set to true.\nhttps://docs.confluent.io/kafka-connectors/elasticsearch/current/overview.html\nè¿™é‡Œç»¼åˆå®é™…æƒ…å†µï¼Œé€‰æ‹©äº†æ–¹æ¡ˆäºŒã€‚ä½†é—®é¢˜ä¹Ÿéšä¹‹è€Œæ¥ï¼ŒES Sink Connector é»˜è®¤ä½¿ç”¨çš„ index = topic ä¹Ÿå°±æ˜¯ cdc.dbname.tablename è¿™ç§å½¢å¼, è€Œæˆ‘ä»¬æƒ³è¦çš„æ˜¯ index = cdc.dbname.tablename-yyyyMMdd è¿™ç§å½¢å¼ã€‚\næ–‡æ¡£æŸ¥é˜…ï¼š\nConfluent/Elasticsearch Sink Connector#index Confluent/SMT/RegexRouter Confluent/SMT/TimestampRouter ç»è¿‡æŸ¥é˜…æ–‡æ¡£ï¼Œå‘ç°å¯ä»¥ä½¿ç”¨ SMT æ¥å®ç°è‡ªå®šä¹‰ç´¢å¼•åç§°ï¼Œå…¶ä¸­ RegexRouter å’Œ TimestampRouter éƒ½æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯ç¬¦åˆæˆ‘ä»¬çš„åœºæ™¯çš„æ˜¯ TimestampRouterã€‚\nåœ¨ ES Sink Connector ä¸­å¢åŠ å¦‚ä¸‹é…ç½®ï¼š\n\u0026#34;transforms\u0026#34;: \u0026#34;TimestampRouter\u0026#34;, \u0026#34;transforms.TimestampRouter.type\u0026#34;: \u0026#34;org.apache.kafka.connect.transforms.TimestampRouter\u0026#34;, \u0026#34;transforms.TimestampRouter.topic.format\u0026#34;: \u0026#34;foo-${topic}-${timestamp}\u0026#34;, \u0026#34;transforms.TimestampRouter.timestamp.format\u0026#34;: \u0026#34;YYYYMM\u0026#34; è¿™æ ·å°±å¯ä»¥å®ç°è‡ªå®šä¹‰ç´¢å¼•åç§°äº† ordersTopic ç»è¿‡ä¸Šè¿°é…ç½®å: foo-ordersTopic-202401ã€‚ä½†æ˜¯è¿™é‡Œéœ€è¦æ³¨æ„ timestamp çš„æ¥æºæ˜¯ kafka message.timestampï¼Œè€Œä¸æ˜¯ message.key/value ä¸­çš„ timestamp å­—æ®µã€‚\nä¸€èˆ¬æ¥è¯´æµæ°´è¿™ç§è®°å½•åœºæ™¯æ˜¯å¤Ÿç”¨çš„ï¼Œå¯èƒ½ä¼šå­˜åœ¨æ—¥æœŸåç§»çš„æƒ…å†µã€‚æ¯”å¦‚ï¼šrecord çš„å®é™…åˆ›å»ºæ—¶é—´ä¸º 2024-01-01 23:59:59ï¼Œä½†æ˜¯å®é™…å†™å…¥ kafka çš„æ—¶é—´ä¸º 2024-01-02 00:00:00ï¼Œè¿™æ ·è¯¥æ¡è®°å½•ä¼šè¢«è·¯ç”±åˆ° foo-ordersTopic-20240201 ç´¢å¼•ä¸­ã€‚\nå¤„ç†æ‰‹æ®µï¼š\nå‚è€ƒ TimestampRouter çš„è®¾è®¡å’Œä»£ç ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ª transformï¼Œå®ç°æ ¹æ® message.value ä¸­çš„ field å­—æ®µæ¥ç”Ÿæˆæ—¶é—´æˆ³, å†ç»„è£… ES index åã€‚å…·ä½“å®ç°å‚è§ #1.5 è‡ªå®šä¹‰ MessageTimestampRouterã€‚\n1.5 è‡ªå®šä¹‰ MessageTimestampRouter å®ç°åŠ¨æ€ç´¢å¼•åç§° # é¢„æœŸçš„ä½¿ç”¨æ•ˆæœæ˜¯ï¼š\n{ \u0026#34;transforms.TimestampRouter.type\u0026#34;: \u0026#34;com.custom.kafka.connect.transforms.MessageTimestampRouter\u0026#34;, \u0026#34;transforms.TimestampRouter.topic.format\u0026#34;: \u0026#34;${topic}-${timestamp}\u0026#34;, \u0026#34;transforms.TimestampRouter.timestamp.format\u0026#34;: \u0026#34;yyyyMMdd\u0026#34;, \u0026#34;transforms.TimestampRouter.message.timestamp.field\u0026#34;: \u0026#34;created_at\u0026#34; } messageValue : {\u0026#34;created_at\u0026#34;: \u0026#34;2024-01-01 00:00:00\u0026#34;, \u0026#34;id\u0026#34;: 1} sourceTopicName : ordersTopic destinationIndexName: ordersTopic-20240101 æ–‡æ¡£æŸ¥é˜…ï¼š\ngithub/kafka/org.apache.kafka.connect.transforms.TimestampRouter Custom Kafka Connect Single Message Transforms å¤„ç†æ‰‹æ®µï¼š\næ–°å»ºä¸€ä¸ª java å·¥ç¨‹ï¼Œåˆ›å»ºä¸€ä¸ª class ç»§æ‰¿ org.apache.kafka.connect.transforms.Transformation æ¥å£ã€‚ /** * Single message transformation for Kafka Connect record types. * \u0026lt;p\u0026gt; * Connectors can be configured with transformations to make lightweight message-at-a-time modifications. * \u0026lt;p\u0026gt;Kafka Connect may discover implementations of this interface using the Java {@link java.util.ServiceLoader} mechanism. * To support this, implementations of this interface should also contain a service provider configuration file in * {@code META-INF/services/org.apache.kafka.connect.transforms.Transformation}. * * @param \u0026lt;R\u0026gt; The type of record (must be an implementation of {@link ConnectRecord}) */ public interface Transformation\u0026lt;R extends ConnectRecord\u0026lt;R\u0026gt;\u0026gt; extends Configurable, Closeable { /** * Apply transformation to the {@code record} and return another record object (which may be {@code record} itself) * or {@code null}, corresponding to a map or filter operation respectively. * \u0026lt;p\u0026gt; * A transformation must not mutate objects reachable from the given {@code record} * (including, but not limited to, {@link org.apache.kafka.connect.header.Headers Headers}, * {@link org.apache.kafka.connect.data.Struct Structs}, {@code Lists}, and {@code Maps}). * If such objects need to be changed, a new {@link ConnectRecord} should be created and returned. * \u0026lt;p\u0026gt; * The implementation must be thread-safe. * * @param record the record to be transformed; may not be null * @return the transformed record; may be null to indicate that the record should be dropped */ R apply(R record); /** Configuration specification for this transformation. */ ConfigDef config(); /** Signal that this transformation instance will no longer will be used. */ @Override void close(); } å®šä¹‰ ConfigDef é…ç½®é¡¹ï¼Œç”¨äºé…ç½® transformationã€‚ /** * é…ç½®å‚æ•° * message.timestamp.field: æ—¶é—´æˆ³å­—æ®µå * topic.format: ä¸»é¢˜æ ¼å¼ * timestamp.format: æ—¶é—´æˆ³å¤„ç†æ ¼å¼åŒ– */ public static final ConfigDef CONFIG_DEF = new ConfigDef() .define(ConfigName.MESSAGE_TIMESTAMP_FIELD, ConfigDef.Type.STRING, \u0026#34;created_at\u0026#34;, ConfigDef.Importance.HIGH, \u0026#34;æ—¶é—´æˆ³å­—æ®µå\u0026#34;) .define(ConfigName.TOPIC_FORMAT, ConfigDef.Type.STRING, \u0026#34;${topic}-${timestamp}\u0026#34;, ConfigDef.Importance.HIGH, \u0026#34;ä¸»é¢˜æ ¼å¼\u0026#34;) .define(ConfigName.TIMESTAMP_FORMAT, ConfigDef.Type.STRING, \u0026#34;yyyyMMdd\u0026#34;, ConfigDef.Importance.HIGH, \u0026#34;æ—¶é—´æˆ³å¤„ç†æ ¼å¼\u0026#34;); @Override public ConfigDef config() { return CONFIG_DEF; } å®ç° apply æ–¹æ³•ï¼Œç”¨äºæŒ‰ç…§éœ€æ±‚å¤„ç† record çš„ topicã€‚ @Override public R apply(R record) { Long timestamp = null; // å°è¯•ä»è®°å½•å€¼ä¸­è·å–æ—¶é—´æˆ³ if (record.value() instanceof Struct) { Struct value = (Struct) record.value(); try { Field field = value.schema().field(messageTimestampField); if (field != null) { timestamp = value.getInt64(messageTimestampField); } } catch (Exception e) { log.warn(\u0026#34;Failed to extract timestamp from field {}: {}\u0026#34;, messageTimestampField, e.getMessage()); } } // å¦‚æœæ— æ³•ä»å­—æ®µè·å–æ—¶é—´æˆ³ï¼Œåˆ™ä½¿ç”¨è®°å½•çš„æ—¶é—´æˆ³ if (timestamp == null) { log.warn(\u0026#34;No timestamp found in record.value {}, trying record.timestamp\u0026#34;, messageTimestampField); timestamp = record.timestamp(); if (timestamp == null) { log.warn(\u0026#34;No timestamp found in record, using current time\u0026#34;); timestamp = System.currentTimeMillis(); } } // æ ¼å¼åŒ–æ—¶é—´æˆ³ String formattedTimestamp = timestampFormat.get().format(new Date(timestamp)); // æ›¿æ¢ä¸»é¢˜æ ¼å¼ä¸­çš„å˜é‡ String updatedTopic = topicFormat .replace(\u0026#34;${topic}\u0026#34;, record.topic()) .replace(\u0026#34;${timestamp}\u0026#34;, formattedTimestamp); // log.info(\u0026#34;Updated topic: {}\u0026#34;, updatedTopic); // åˆ›å»ºæ–°è®°å½• return record.newRecord( updatedTopic, record.kafkaPartition(), record.keySchema(), record.key(), record.valueSchema(), record.value(), record.timestamp() ); } 1.6 CDC kafka-connect mongodb ä¾§åå¤è¿›è¡Œ â€œå¿«ç…§â€ å¯¼è‡´æ•°æ®åŒæ­¥å¼‚å¸¸ # å¯¼è‡´è¿™ä¸ªç°è±¡çš„èµ·å§‹åŸå› æ˜¯ï¼Œmongodb æ•°æ®åº“ä¸­æœ‰å¤šä¸ªé›†åˆï¼Œå…¶ä¸­æ‹¥æœ‰éå¸¸å¤šçš„è¿‡æœŸæ•°æ®ï¼Œè¶…è¿‡ 8000w æ¡ï¼Œå¯¼è‡´äº†æ˜æ˜¾çš„æ…¢æŸ¥è¯¢ï¼Œå› æ­¤å¼€å‘å¢åŠ äº† TTL ç´¢å¼•æ¥è‡ªåŠ¨åˆ é™¤è¿‡æœŸæ•°æ®ã€‚å½“ç„¶è¿™ä¸¤ä¸ªé›†åˆé…ç½®åœ¨äº† mongodb source connector ä¸­ï¼Œéœ€è¦åŒæ­¥å˜æ›´ã€‚\nä½†æ˜¯åœ¨å®é™…è¿è¡Œä¸­ï¼Œå‘ç° mongodb source connector åå¤è¿›è¡Œâ€œå¿«ç…§â€ï¼Œmongodb source connector çš„ç”Ÿäº§é€Ÿç‡ç›‘æ§å¦‚ä¸‹ï¼š\næŸä¸€ä¸ª collection ç”Ÿäº§é€Ÿç‡ è¯¥é›†åˆæ­£å¸¸ç”Ÿäº§çš„é€Ÿç‡çº¦ä¸º 20æ¡/sï¼Œå›¾ä¸­çš„é€Ÿç‡å·²ç»è¾¾åˆ° 2000æ¡/sï¼Œä¸”åå¤å‡ºç°ã€‚\næ–‡æ¡£æŸ¥é˜…ï¼š\nDebezium/Source Connector/Mongodb#performing-a-snapshot However, if no offset is found, or if the oplog no longer contains that position, the task must first obtain the current state of the replica set contents by performing a snapshot.\nå¦‚æœæ²¡æœ‰æ‰¾åˆ° offsetï¼Œæˆ–è€… oplog ä¸­ä¸å†åŒ…å«è¯¥ä½ç½®ï¼Œåˆ™ä»»åŠ¡å¿…é¡»é¦–å…ˆé€šè¿‡æ‰§è¡Œå¿«ç…§æ¥è·å–å‰¯æœ¬é›†å†…å®¹çš„å½“å‰çŠ¶æ€ã€‚\næ€»ç»“ä¸€ä¸‹ï¼ŒMongodb source connector ä¼šåœ¨ä»¥ä¸‹æƒ…å†µä¸‹æ‰§è¡Œå¿«ç…§ï¼š\nåˆæ¬¡å¯åŠ¨ connector æ—¶ï¼Œæ‰¾ä¸åˆ°ä¿å­˜çš„åç§»é‡ åç§»é‡è¿‡æœŸï¼Œoplog ä¸­ä¸å†åŒ…å«è¯¥ä½ç½® è¿™é‡Œé‡åˆ°çš„æƒ…å†µå±äºç¬¬äºŒç§æƒ…å†µï¼Œå³åç§»é‡è¿‡æœŸï¼Œoplog ä¸­ä¸å†åŒ…å«è¯¥ä½ç½®ã€‚ç”±äºåˆ é™¤çš„æ•°æ®é‡éå¸¸å¤§ï¼Œå¯¼è‡´ oplog æ»šåŠ¨éå¸¸å¿«ï¼Œmongodb source connector ä¿å­˜çš„åç§»é‡å¾ˆå¿«å°±è¿‡æœŸäº†ï¼Œå› æ­¤ä¼šè§¦å‘å¿«ç…§ã€‚\nè€Œå¯¼è‡´åå¤å¿«ç…§çš„åŸå› ä¹Ÿç±»ä¼¼ï¼Œæ‰§è¡Œå¿«ç…§çš„é›†åˆä¸­æœ‰éå¸¸å¤§çš„é›†åˆè¶…è¿‡ 100 million æ¡æ•°æ®ï¼Œå¯¼è‡´å¿«ç…§æ—¶é—´éå¸¸é•¿ï¼Œå¿«ç…§è¿‡ç¨‹ä¸­ï¼Œoplog ç»§ç»­æ»šåŠ¨ï¼Œå¯¼è‡´å¿«ç…§ç»“æŸåï¼Œä¿å­˜çš„åç§»é‡å·²ç»è¿‡æœŸï¼Œå› æ­¤ä¼šå†æ¬¡è§¦å‘å¿«ç…§ã€‚é™·å…¥äº†ä¸€ä¸ªæ­»å¾ªç¯ã€‚\nå¤„ç†æ‰‹æ®µï¼š\nè¿™é‡Œä¼˜åŒ–çš„æ–¹å‘æœ‰ä¸¤ä¸ªï¼š\nç¼©çŸ­å¿«ç…§æŒç»­æ—¶é—´ å¢å¤§ oplog çš„å¤§å° db.oplog.rs.stats() // å…¶ä¸­ maxSize å­—æ®µè¡¨ç¤º oplog çš„æœ€å¤§å¤§å°ï¼Œå•ä½ä¸º B { maxSize: 10632303360 // çº¦ 10GB } ç¼©çŸ­å¿«ç…§å¯ä»¥ å¢åŠ å¿«ç…§çº¿ç¨‹æ•° æ¥æé«˜å¹¶å‘åº¦ï¼š\n+ \u0026#34;snapshot.max.threads\u0026#34;: 6 // é»˜è®¤å€¼ä¸º 1 è¿˜å¯ä»¥ æ‹†åˆ†æˆå¤šä¸ª connector æ¥å¢åŠ å¹¶å‘åº¦ã€‚\nä¸ªäººç»éªŒ: é‡‡ç”¨ include è¿™ç§æ˜¾å¼åŒ…å«çš„æ–¹å¼æ¥æŒ‡å®šéœ€è¦åŒæ­¥çš„é›†åˆï¼Œè€Œä¸æ˜¯ exclude æ’é™¤çš„æ–¹å¼ã€‚\nè‡³äºæ˜¯è°ƒå¤§ oplog ï¼Œåˆ™éœ€è¦æ ¹æ®å®é™…æƒ…å†µæ¥å®šã€‚å¯ä»¥é€šè¿‡æŸ¥çœ‹ oplog çš„ä½¿ç”¨æƒ…å†µæ¥åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒå¤§ oplog çš„å¤§å°ï¼š\n\u0026gt; rs.printReplicationInfo() actual oplog size \u0026#39;10139.754638671875 MB\u0026#39; --- configured oplog size \u0026#39;10139.754638671875 MB\u0026#39; --- log length start to end \u0026#39;5012612 secs (1392.39 hrs)\u0026#39; --- // å…¶ä»– å¦‚æœç¡®å®éœ€è¦è°ƒå¤§ oplog çš„å¤§å°ï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹æ–‡æ¡£ï¼š\nMongoDB/Replication/Oplog Size db.adminCommand( { replSetResizeOplog: 1, size: \u0026lt;double\u0026gt;, // ä»¥ MB ä¸ºå•ä½ minRetainHours: \u0026lt;double\u0026gt; // å¯é€‰ï¼Œæœ€å°ä¿ç•™æ—¶é—´ï¼Œå•ä½ä¸ºå°æ—¶, å¦‚ 1.5 ä»£è¡¨ 1h30m } ) å¦å¤–æ–‡æ¡£ä¸­è¿˜æåˆ°äº†ï¼Œå¢é‡å¿«ç…§ çš„æ–¹å¼æ¥è§£å†³å¤§æ•°æ®é‡çš„å¿«ç…§é—®é¢˜ï¼š\nå¢é‡å¿«ç…§çš„å«ä¹‰å°±æ˜¯ä¸ä¼šä¸€æ¬¡æ€§å¿«ç…§å®Œæ•°æ®åº“çš„å®Œæ•´çŠ¶æ€ï¼Œè€Œæ˜¯åˆ†æ‰¹ï¼ˆå—ï¼‰çš„å¿«ç…§æ¯ä¸ªé›†åˆï¼ˆå¯ä»¥è‡ªå®šä¹‰é›†åˆå’Œå—å¤§å°ï¼‰ã€‚ å¢é‡å¿«ç…§è¿è¡Œæ˜¯, oplog stream change åº”ç”¨ä¹Ÿä¼šåŒæ­¥è¿›è¡Œï¼Œè€Œä¸ç”¨ç­‰å¾…å¿«ç…§å®Œæˆå å¢é‡å¿«ç…§åœæ­¢åæ¢å¤ä¹Ÿä¸ä¼šä»å¤´å¼€å§‹ï¼Œè€Œæ˜¯ä»ä¸Šæ¬¡å¿«ç…§çš„åœ°æ–¹ç»§ç»­ ç”±äºå¢é‡å¿«ç…§æ˜¯åŸºäºä¿¡å·è§¦å‘çš„ï¼ˆå‘ æ•°æ®åº“ä¿¡å·é›†åˆ æ’å…¥æ–°æ•°æ® / å‘å¸ƒKafka ä¿¡å·æ¶ˆæ¯ï¼‰ï¼Œå› æ­¤å¯ä»¥éšæ—¶è§¦å‘å¿«ç…§ å°ç»“ï¼šå¢é‡å¿«ç…§å¯ä»¥å¾ˆå¥½è§„é¿çš„å¤§æ•°æ®é‡å¿«ç…§çš„é—®é¢˜ï¼Œåªæ˜¯ä¼šå¢åŠ ä½¿ç”¨æˆæœ¬ã€‚\nç»éªŒæ€»ç»“ï¼š\nå¦‚æœå­˜åœ¨è¶…å¤§æ•°æ®é‡çš„é›†åˆï¼Œå»ºè®®ä½¿ç”¨å¢é‡å¿«ç…§ Mongodb source connector çš„å¿«ç…§çº¿ç¨‹é»˜è®¤ä¸º 1ï¼Œå¯¹äºå¤§æ•°æ®é‡çš„é›†åˆï¼Œå»ºè®®å¢åŠ å¿«ç…§çº¿ç¨‹æ•° å¦‚æœ oplog æ»šåŠ¨è¿‡å¿«ï¼Œå»ºè®®å¢å¤§ oplog çš„å¤§å° 2. DMS æ•°æ®åŒæ­¥ç›¸å…³ # DMS æ˜¯ Data Migration Service çš„ç¼©å†™ï¼Œå³æ•°æ®è¿ç§»æœåŠ¡ã€‚DMS æ˜¯ä¸€ç§æ•°æ®è¿ç§»æœåŠ¡ï¼Œç”¨äºå°†æ•°æ®ä»ä¸€ä¸ªåœ°æ–¹è¿ç§»åˆ°å¦ä¸€ä¸ªåœ°æ–¹ã€‚DMS é€šå¸¸ç”¨äºæ•°æ®è¿ç§»ã€æ•°æ®å¤‡ä»½ã€æ•°æ®æ¢å¤ç­‰åœºæ™¯ã€‚\n2.1 æ•°æ®è¿ç§»å®Œæˆåï¼Œæ€ä¹ˆå¯¹æ¯”æºæ•°æ®å’Œç›®æ ‡æ•°æ®æ˜¯å¦ä¸€è‡´ï¼Ÿ # åœ¨å®é™…åœºæ™¯ä¸­ï¼Œå¯èƒ½ä¼šæœ‰æ•°æ®è¿ç§»çš„éœ€æ±‚ï¼Œæ¯”å¦‚è¯´å°†æ•°æ®ä»ä¸€ä¸ªæ•°æ®åº“è¿ç§»åˆ°å¦ä¸€ä¸ªæ•°æ®åº“ï¼Œæˆ–è€…å°†æ•°æ®ä»ä¸€ä¸ªè¡¨è¿ç§»åˆ°å¦ä¸€ä¸ªè¡¨ã€‚åœ¨è¿ç§»å®Œæˆåï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ¯”æºæ•°æ®å’Œç›®æ ‡æ•°æ®æ˜¯å¦ä¸€è‡´ï¼Œä»¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚\nè¿™é‡Œè®°å½•ä¸‹åœ¨æ£€ç´¢ä¸­å‡ºæ¥å¯ä»¥ä½¿ç”¨çš„ä¸€äº›å·¥å…·ï¼š\ntidb-tools/sync_diff_inspector: æ˜¯ä¸€ä¸ªå¯ä»¥å¯¹æ¯”ä¸¤ä¸ªæ•°æ®åº“å¹¶ä¸”è¾“å‡ºå·®å¼‚çš„å·¥å…·ï¼Œæ”¯æŒ MySQL å’Œ TiDB æ•°æ®åº“ã€‚ä½¿ç”¨æ–‡æ¡£å‚è€ƒï¼šsync_diff_inspector#usage pt-table-checksum: æ˜¯ Percona Toolkit ä¸­çš„ä¸€ä¸ªå·¥å…·ï¼Œç”¨äºæ£€æŸ¥ MySQL å¤åˆ¶çš„ä¸€è‡´æ€§ã€‚ pt-table-sync: æ˜¯ Percona Toolkit ä¸­çš„ä¸€ä¸ªå·¥å…·ï¼Œç”¨äºåŒæ­¥ä¸¤ä¸ªè¡¨çš„æ•°æ®ã€‚ 2.2 å¦‚æœä¸ä¸€è‡´æ€ä¹ˆå¤„ç†ï¼Ÿ # tidb-tools/sync_diff_inspector å¯ä»¥è¾“å‡ºä¿®å¤SQLã€‚Percona Toolkit ä¸­çš„ pt-table-sync ä¹Ÿå¯ä»¥ç”¨äºåŒæ­¥ä¸¤ä¸ªè¡¨çš„æ•°æ®ã€‚\n3. Istio ç›¸å…³ # 3.1 Istio ä¸­å¤šä¸ª gateway ä½¿ç”¨ç›¸åŒ hostï¼Œanalyze æ˜¯æç¤ºé”™è¯¯ # åœ¨ Istio ä¸­ï¼Œgateway æ˜¯ä¸€ä¸ªè™šæ‹ŸæœåŠ¡ï¼Œç”¨äºå°†æµé‡è·¯ç”±åˆ°å¯¹åº”çš„æœåŠ¡ã€‚gateway æœ‰ä¸€ä¸ª host å­—æ®µï¼Œç”¨äºæŒ‡å®šåŸŸåã€‚åœ¨å®é™…åœºæ™¯ä¸­ï¼Œå¯èƒ½ä¼šæœ‰å¤šä¸ª gateway ä½¿ç”¨ç›¸åŒçš„ hostï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´ analyze æ—¶æç¤ºé”™è¯¯ã€‚\n3.2 Istio ä¸­ä¸€ä¸ªæœåŠ¡æä¾›äº†å¤šä¸ªç«¯å£çš„æœåŠ¡ï¼Œæ€ä¹ˆé…ç½® Virtual Service ï¼Ÿ # æˆ‘ä»¬æœ‰ä¸€ä¸ªçŸ­ä¿¡æœåŠ¡ï¼Œå®ƒåŒæ—¶æä¾›äº† HTTP å’Œ gRPC æœåŠ¡ï¼Œåˆ†åˆ«ä½¿ç”¨äº† 8000 å’Œ 50051 ç«¯å£ã€‚åœ¨æ²¡æœ‰ä½¿ç”¨ istio å»è·¯ç”±æµé‡çš„æ—¶å€™ï¼Œåœ¨ k8s ä¸­é…ç½®è¿™ä¸ªæœåŠ¡å…¶å®å¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨ Service ä¸­é…ç½®å¤šä¸ªç«¯å£å³å¯ã€‚å¦‚ä¸‹ï¼š\napiVersion: v1 kind: Service metadata: name: sms-service spec: selector: app: sms-service ports: - name: http port: 8000 targetPort: 8000 - name: grpc port: 50051 targetPort: 50051 ä½†æ˜¯åœ¨ä½¿ç”¨ istio æ—¶ï¼Œéœ€è¦é…ç½® Virtual Service æ¥è·¯ç”±æµé‡ï¼Œé‚£ä¹ˆå¦‚ä½•é…ç½® Virtual Service æ¥æ”¯æŒå¤šä¸ªç«¯å£çš„æœåŠ¡å‘¢ï¼Ÿ\næ–‡æ¡£æŸ¥é˜…ï¼š\nIstio Virtual Service#HTTPRoute HTTPRoute\nDescribes match conditions and actions for routing HTTP/1.1, HTTP2, and gRPC traffic. See VirtualService for usage examples.\nhttp[].match.port (Optional) uint32\nSpecifies the ports on the host that is being addressed. Many services only expose a single port or label ports with the protocols they support, in these cases it is not required to explicitly select the port.\nä»è¿™ä¸€èŠ‚æ–‡æ¡£ï¼Œæˆ‘ä»¬å¾—çŸ¥ HTTPRoute å¯ä»¥ç”¨äºè·¯ç”± HTTP/1.1ã€HTTP2 å’Œ gRPC æµé‡ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ HTTPRoute æ¥é…ç½® Virtual Serviceã€‚match åŒ¹é…æ¡ä»¶ä¸­çš„ port å­—æ®µå¯ä»¥ç”¨äºæŒ‡å®šç«¯å£ï¼Œä¸“é—¨ç”¨äºå•ä¸ªæœåŠ¡æä¾›å¤šç«¯å£çš„åœºæ™¯ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ port ä»£è¡¨çš„æ˜¯è®¿é—®åœ°å€ä¸­çš„ç«¯å£ï¼Œè€Œä¸æ˜¯æœåŠ¡æš´éœ²çš„ç«¯å£ã€‚\nå¤„ç†æ‰‹æ®µï¼š\nåœ¨ Virtual Service é…ç½®ä¸­ï¼Œæ–°å¢å¤šä¸ª httpRoute æ¥è·¯ç”±åˆ°ä¸åŒçš„ç«¯å£ã€‚ apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: sms-service spec: hosts: - api.my http: - name: http match: - uri: prefix: / port: 80 route: - destination: host: sms-service port: number: 8000 - name: grpc match: - port: 50051 route: - destination: host: sms-service port: number: 50051 4. APISIX ç›¸å…³ # 4.1 ä½¿ç”¨ APISIX ä½œä¸ºç½‘å…³ï¼Œæ€ä¹ˆè¿›è¡Œæœ‰æ¡ä»¶çš„å“åº”é‡å†™ï¼Ÿ # å“åº”é‡å†™å±äºç½‘å…³çš„åŸºæœ¬åŠŸèƒ½ï¼ŒAPISIX ä½œä¸ºä¸€ä¸ªå¼€æºçš„ç½‘å…³ï¼Œä¹Ÿæ”¯æŒå“åº”é‡å†™ã€‚ä½†æ˜¯åœ¨å®é™…åœºæ™¯ä¸­ï¼Œå¯èƒ½ä¼šæœ‰ä¸€äº›ç‰¹æ®Šçš„éœ€æ±‚ï¼Œæ¯”å¦‚è¯´åªæœ‰æ»¡è¶³ä¸€å®šæ¡ä»¶æ—¶æ‰è¿›è¡Œå“åº”é‡å†™ã€‚ä¸¾ä¸ªå®é™…çš„ä¾‹å­ï¼š\nå½“æœåŠ¡å™¨è¦è¿›è¡Œåœæœºç»´æŠ¤çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›æ‰€æœ‰çš„è¯·æ±‚ï¼Œä¸è®ºæ˜¯å®¢æˆ·ç«¯è¿˜æ˜¯ç¬¬ä¸‰æ–¹è¯·æ±‚çš„è¯·æ±‚ï¼Œéƒ½å“åº” 503 çŠ¶æ€ç ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªæç¤ºä¿¡æ¯ â€œæœåŠ¡å™¨æ­£åœ¨ç»´æŠ¤ä¸­ï¼Œé¢„è®¡ç»´æŠ¤æ—¶é—´ä¸º 2024-12-17 00:00:00 - 2024-12-17 06:00:00â€ï¼ŒåŒæ—¶è¿˜æœ‰å¦å¤–ä¸€ä¸ªè¦æ±‚å½“æœåŠ¡å™¨æ¢å¤æ—¶ï¼Œå¯ä»¥å…è®¸ç‰¹å®šçš„è¯·æ±‚é€šè¿‡ï¼Œæ¯”å¦‚è¯´åªæœ‰æ¥è‡ªå…¬å¸å†…éƒ¨çš„è¯·æ±‚æ‰å¯ä»¥é€šè¿‡ã€‚\nè¿™é‡Œé»˜è®¤å®¢æˆ·ç«¯æ˜¯æ”¯æŒå±•ç¤ºè¿™ç§å“åº”çš„ï¼Œå› æ­¤ä¸è€ƒè™‘å®¢æˆ·ç«¯å±•ç¤ºé—®é¢˜ã€‚\næ–‡æ¡£æŸ¥é˜…ï¼š\nAPISIX#Response-Rewrite APISIX#Response-Rewrite Attributes APISIX#Response-Rewrite GITHUB è¿™é‡Œå…³æ³¨è¯¥æ’ä»¶çš„ä»¥ä¸‹å‡ ä¸ªå±æ€§ï¼š\nstatus_code: å“åº”çŠ¶æ€ç  body: å“åº”ä½“ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–è€… base64 ç¼–ç çš„å­—ç¬¦ä¸²ã€‚ï¼ï¼ï¼æ³¨æ„ body å’Œ filters ä¸èƒ½åŒæ—¶ä½¿ç”¨ã€‚ body_base64: ç”¨äºæŒ‡ç¤º body æ˜¯å¦ base64 ç¼–ç  vars: ç”¨äºåŒ¹é…æ¡ä»¶ï¼Œæ”¯æŒå¤šä¸ªåŒ¹é…æ¡ä»¶ã€‚ å˜é‡åˆ—è¡¨å‚è€ƒï¼š Nginx å˜é‡ï¼šhttps://nginx.org/en/docs/varindex.html APISIX å˜é‡ï¼šhttps://apisix.apache.org/docs/apisix/apisix-variable/ æ“ä½œç¬¦å‚è€ƒï¼šhttps://github.com/api7/lua-resty-expr#operator-list filters: å¯¹ body å†…å®¹è¿›è¡Œæ­£åˆ™åŒ¹é…å¹¶æ›¿æ¢ã€‚ vars é…ç½®ä¸¾ä¾‹ï¼š\n# åŒ¹é…æ‰€æœ‰æŸ¥è¯¢å‚æ•°å¸¦æœ‰ pkg=com.company.io çš„è¯·æ±‚ vars: - - arg_pkg - ~= - \u0026#34;com.company.io\u0026#34; filter é…ç½®ä¸¾ä¾‹ï¼š\n# è¿™ä¸ªé…ç½®ä¼šå°†å“åº”ä½“ä¸­çš„æ‰€æœ‰ Example æ›¿æ¢ä¸º Example-Replaced filters: - regex: Example scope: global replace: Example-Replaced options: \u0026#34;jo\u0026#34; # æ­£åˆ™åŒ¹é…é€‰é¡¹ï¼Œå‚è§ https://github.com/openresty/lua-nginx-module#ngxrematch å¤„ç†æ‰‹æ®µï¼š\nåœ¨ ApisixRoute é…ç½®ä¸­ï¼Œé…ç½® response-rewrite æ’ä»¶ï¼Œè®¾ç½® body ä¸ºç»´æŠ¤æç¤ºä¿¡æ¯ï¼Œè®¾ç½® vars ä¸ºç‰¹å®šè¯·æ±‚çš„åŒ¹é…æ¡ä»¶ã€‚\nä»£ç ç‰‡æ®µ apiVersion: apisix.apache.org/v2 kind: ApisixRoute metadata: name: account-api spec: http: - name: account-api backends: - serviceName: account-api servicePort: 8000 match: hosts: - api.example.com paths: - /account/* plugins: - name: cors enable: true - name: response-rewrite enable: true body: \u0026gt;- { \u0026#34;code\u0026#34;: 503, \u0026#34;message\u0026#34;: \u0026#34;æœåŠ¡å™¨æ­£åœ¨ç»´æŠ¤ä¸­ï¼Œé¢„è®¡ç»´æŠ¤æ—¶é—´ä¸º 2024-12-17 00:00:00 - 2024-12-17 06:00:00\u0026#34; } body_base64: false # æ˜¯å¦ body base64ï¼Œé€‚ç”¨äºäºŒè¿›åˆ¶æ•°æ® vars: - - arg_pkg - ~= - \u0026#34;com.company.io\u0026#34; 4.2 APISIX æ’ä»¶çš„æ‰§è¡Œé¡ºåºæ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ # APISIX ä¼šä¼˜å…ˆæ‰§è¡Œå…¨å±€çš„æ’ä»¶ï¼Œç„¶åå†æ‰§è¡Œè·¯ç”±çº§åˆ«çš„æ’ä»¶ã€‚æ¯ä¸ªæ’ä»¶å†…éƒ¨å®šä¹‰äº†ä¸€ä¸ªä¼˜å…ˆçº§ priorityï¼Œä¼˜å…ˆçº§è¶Šé«˜çš„æ’ä»¶è¶Šå…ˆæ‰§è¡Œã€‚\nå¦‚æœæƒ³è¦è°ƒæ•´æ’ä»¶çš„é¡ºåºï¼Œå¯ä»¥é…ç½® _meta å­—æ®µ, å‚è§ APISIX#Plugin Custom priority\n5. ShardingSphere Proxy # 5.1 HINTç­–ç•¥ åœ¨ ShardingSphere Proxy ä¸­çš„ä½¿ç”¨ # åœ¨å‰æ–‡ ShardingSphere Proxy é—®é¢˜å‡ åˆ™ ä¸­æåˆ°äº† Shardingsphere æ”¯æŒ HINT ç­–ç•¥ï¼Œå³é€šè¿‡ SQL Hint æ¥æŒ‡å®šè·¯ç”±è§„åˆ™ã€‚\nè¿™é‡Œçš„åœºæ™¯æ˜¯é’ˆå¯¹å·²ç»ä½¿ç”¨äº†æ ‡å‡†åˆ†ç‰‡ç®—æ³•ä¸­ Inline ç­–ç•¥çš„åœºæ™¯ï¼Œä½†æ˜¯ä¸ªåˆ«åœºæ™¯æ²¡æœ‰åŠæ³•ä½¿ç”¨åˆ†ç‰‡é”®è¿›è¡Œè·¯ç”±ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ HINT ç­–ç•¥ã€‚æ¯”å¦‚è¯´æœ‰ä¸€ä¸ª t_order è¡¨ï¼Œè¿›è¡Œäº†æ•°æ®åˆ†ç‰‡ï¼Œåˆ†åº“åˆ†è¡¨çš„ç­–ç•¥æ˜¯ï¼šæ ¹æ® mch_id å–æ¨¡åˆ†ä¸º 2 ä¸ªåº“ï¼Œæ ¹æ® user_id å–æ¨¡åˆ†ä¸º 2 ä¸ªè¡¨ã€‚\nç°åœ¨è¦é’ˆå¯¹è¿™ä¸ªè¡¨æ¸…ç†æ•°æ®ã€‚æœ€ç®€å•çš„æƒ³æ³•å°±æ˜¯ç›´æ¥æ‰§è¡Œ DELETE FROM t_order WHERE created_at \u0026lt; 'yyyy-MM-dd' æ¥æ¸…ç†æ•°æ®ï¼Œä½†æ˜¯å¾ˆæ˜æ˜¾ç›´æ¥åˆ é™¤ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚å¯ä»¥è€ƒè™‘ä½¿ç”¨æ‰¹é‡åˆ é™¤çš„æ–¹å¼ï¼Œä¾‹å¦‚ï¼š\nDELETE FROM t_order WHERE created_at \u0026lt; \u0026#39;yyyy-MM-dd\u0026#39; limit 1000; ä½†æ˜¯è¿™æ ·çš„æ–¹å¼ä¸è¢« Shardingsphere Proxy æ”¯æŒï¼Œå› ä¸ºè¿™æ ·çš„ SQL è¯­å¥æ²¡æœ‰åˆ†ç‰‡é”®ä¼šå¯¼è‡´å…¨è·¯ç”±ï¼ŒShardingsphere Proxy å¹¶ä¸æ”¯æŒã€‚\næ–‡æ¡£æŸ¥é˜…ï¼š\nShardingSphere Proxy#SQL HINT è¿™é‡Œéœ€è¦æå‰å¼€å¯ sqlCommentParseEnable é€‰é¡¹ï¼Œä»¥æ”¯æŒ sql comment è§£æã€‚\nå¤„ç†æ‰‹æ®µï¼š\næƒ³è¦è®©è¿™æ ·çš„åˆ é™¤è¯­å¥å¯ä»¥è½åˆ°ç‰¹å®šçš„åˆ†ç‰‡ä¸Šå»ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ HINT ç­–ç•¥ï¼Œå³åœ¨ SQL è¯­å¥ä¸­æ·»åŠ  Hint æ¥æŒ‡å®šè·¯ç”±è§„åˆ™ï¼Œå¦‚ä¸‹ï¼š\n/* ShardingSphere hint: dataSourceName=sharding_db_0 */ delete from t_order_0 where created_at \u0026lt; \u0026#39;yyyy-MM-dd\u0026#39; limit 1000; 6. Kafka ç›¸å…³ # 6.1 å¦‚ä½•å°†è¿ç§»kafkaé›†ç¾¤ä¸­çš„æ•°æ®ï¼Ÿ # åœ¨å®é™…åœºæ™¯ä¸­ï¼Œå¯èƒ½ä¼šæœ‰è¿ç§» kafka é›†ç¾¤çš„éœ€æ±‚ï¼Œæ¯”å¦‚è¯´è¿ç§»åˆ°æ–°çš„é›†ç¾¤ï¼Œæˆ–è€…è¿ç§»åˆ°æ–°çš„ç‰ˆæœ¬ç­‰ã€‚è¿™é‡Œçš„è¿ç§»æ˜¯æŒ‡è¿ç§»æ•°æ®ï¼Œè€Œä¸æ˜¯è¿ç§»é›†ç¾¤ã€‚ä¸€èˆ¬è¯´æ¥ï¼Œkafka æ•°æ®è¿ç§»åˆ†ä¸ºä¸¤ç§ï¼š\né›†ç¾¤å†…è¿ç§»ï¼šæ¯”å¦‚æ–°å¢ä¸€ä¸ª broker, éœ€è¦å°†ç°æœ‰çš„æ•°æ®é‡æ–°åˆ†å¸ƒï¼Œå·²å®ç°è´Ÿè½½å‡è¡¡ã€‚bin/kafka-reassign-partitions.sh è„šæœ¬å¯ä»¥ç”¨äºè¿ç§»æ•°æ®, å‚è§ Kafka#automigrate é›†ç¾¤é—´è¿ç§»ï¼šæ¯”å¦‚å°† cluster-ea ä¸­çš„ topic-demo æ•´ä½“è¿ç§»åˆ° cluster-eu ä¸­ã€‚ æŸ¥é˜…æ–‡æ¡£/æ€è·¯æ€»ç»“ï¼š\nè·¨é›†ç¾¤è¿ç§»çš„æ€è·¯æ˜¯ï¼š\nä½¿ç”¨ mirror-maker å…ˆå°†æ•°æ®ä» cluster-ea ä¸­å¤åˆ¶åˆ° cluster-eu ä¸­ã€‚ è¿ç§»æ‰€æœ‰çš„æ¶ˆè´¹è€…åˆ° cluster-eu ä¸­ è¿ç§»æ‰€æœ‰çš„ç”Ÿäº§è€…åˆ° cluster-eu ä¸­ å¤„ç†æ‰‹æ®µï¼š\nä»¥ä¸‹å‘½ä»¤ä»…ä¾›å‚è€ƒï¼Œå…·ä½“çš„å‚æ•°éœ€è¦æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ã€‚\nä½¿ç”¨ mirror-maker å¤åˆ¶æ•°æ®\n./kafka-mirror-maker.sh --consumer.config consumer.properties --producer.config producer.properties --whitelist \u0026#34;topic-demo\u0026#34; è¿ç§»æ¶ˆè´¹è€…\nä¿®æ”¹æ¶ˆè´¹è€…é…ç½®æ–‡ä»¶ä¸­çš„ bootstrap.servers ä¸ºæ–°çš„é›†ç¾¤åœ°å€\nè¿ç§»ç”Ÿäº§è€…\nä¿®æ”¹ç”Ÿäº§è€…é…ç½®æ–‡ä»¶ä¸­çš„ bootstrap.servers ä¸ºæ–°çš„é›†ç¾¤åœ°å€\nåœæ­¢ mirror-maker\n7. Pyroscope ç›¸å…³ # Pyroscope æ˜¯ä¸€ä¸ªå¼€æºçš„æ€§èƒ½ç›‘æ§å·¥å…·ï¼Œæ”¯æŒå¤šç§è¯­è¨€ SDKï¼Œæ”¯æŒå¤šç§é‡‡é›†æ¨¡å¼ã€‚Pyroscope æœ‰ä¸¤ç§é‡‡é›†æ¨¡å¼ï¼š\nPull æ¨¡å¼ï¼šPyroscope ä¼šå®šæ—¶ä»åº”ç”¨ç¨‹åºä¸­æ‹‰å–æ•°æ®ã€‚ç¨‹åºéœ€è¦ä¸»åŠ¨æš´éœ²ç›¸åº”çš„ç«¯å£ï¼Œå‚è§ï¼šPyroscope#Scrape Push æ¨¡å¼ï¼šåº”ç”¨ç¨‹åºé€šè¿‡å†…ç½® SDK ä¸»åŠ¨æ¨é€æ•°æ®åˆ° Pyroscopeï¼Œå‚è§ï¼šPyroscope#Push å¦‚ä¸‹ï¼š\n7.1 ä½¿ç”¨ Go Pull æ¨¡å¼é‡‡é›†æ•°æ®æ—¶ä¸ºä»€ä¹ˆåªæœ‰ cpu + gourotines + cpu samples ä¸‰ä¸ªæŒ‡æ ‡ï¼Ÿ # æŒ‰ç…§å®˜æ–¹æ–‡æ¡£é…ç½®å¥½ Alloy æœåŠ¡ï¼Œå¹¶åœ¨åº”ç”¨ä¸Šæš´éœ² /debug/pprof/* ç­‰ç«¯å£ä¹‹åï¼ˆä½¿ç”¨æ ‡å‡†åº“çš„ pprofï¼‰ï¼Œå‘ç°åœ¨ Pyroscope ä¸­åªæœ‰ cpu + gourotines + cpu samples ä¸‰ä¸ªæŒ‡æ ‡ï¼Œè€Œæ²¡æœ‰å…¶ä»–çš„æŒ‡æ ‡ã€‚å¦‚ä¸‹å›¾ï¼š\næ­¤æ—¶ä½¿ç”¨çš„ alloy scrape é…ç½®å¦‚ä¸‹ï¼š\nä»£ç ç‰‡æ®µ pyroscope.scrape \u0026#34;scrape_job_name\u0026#34; { // è¿™éƒ¨åˆ†ä»…ä½œæ¼”ç¤º targets = [{\u0026#34;__address__\u0026#34; = \u0026#34;localhost:4040\u0026#34;, \u0026#34;service_name\u0026#34; = \u0026#34;example_service\u0026#34;}] forward_to = [pyroscope.write.write_job_name.receiver] // å…³æ³¨è¿™éƒ¨åˆ†é…ç½® profiling_config { profile.process_cpu { enabled = true } profile.godeltaprof_memory { enabled = true } profile.memory { // disable memory, use godeltaprof_memory instead enabled = false } profile.godeltaprof_mutex { enabled = true } profile.mutex { // disable mutex, use godeltaprof_mutex instead enabled = false } profile.godeltaprof_block { enabled = true } profile.block { // disable block, use godeltaprof_block instead enabled = false } profile.goroutine { enabled = true } } } æ–‡æ¡£æŸ¥é˜…ï¼š\nPyroscope#Scrape é€šè¿‡æ–‡æ¡£å°±å¾ˆæ˜äº†äº†ï¼Œå› ä¸º alloy scrape ä»»åŠ¡é…ç½®çš„ memoryã€mutexã€block ç­‰æŒ‡æ ‡éƒ½éƒ½æŒ‡å‘äº† godeltaprof_memoryã€godeltaprof_mutexã€godeltaprof_block ç­‰æŒ‡æ ‡ï¼Œå…¶è®¿é—®è·¯å¾„æœŸæœ›æ˜¯ /debug/pprof/delta_heap è€Œä¸æ˜¯åº”ç”¨å®é™…æš´éœ²çš„ /debug/pprof/allocsï¼Œæ‰€ä»¥æ‰æœ‰æ²¡æœ‰ memory ç›¸å…³çš„æŒ‡æ ‡ã€‚\nè€Œ delta_heap ç­‰æŒ‡æ ‡æ˜¯åœ¨åº”ç”¨ç¨‹åºä¸­é€šè¿‡ SDK æ–°å¢çš„æŒ‡æ ‡ï¼Œå¯¹äº Go æ ‡å‡†åº“ä¸­çš„ pprof å¹¶ä¸åŒ…å«ã€‚\nå…³äº godeltaprof è¿™ä¸ªåŒ…ï¼Œæ˜¯ runtime/pprof çš„ä¸€ä¸ª fork ç‰ˆæœ¬ï¼šå‡å°‘äº†å†…å­˜åˆ†é…ï¼Œç›¸åº”çš„GCå‹åŠ›æ›´å°ï¼›åŒæ—¶æ”¯æŒæƒ°æ€§é‡‡æ ·ï¼Œé‡‡æ ·æ›´åŠ é«˜æ•ˆï¼ˆæ ·æœ¬å°ºå¯¸æ›´å°ï¼‰ã€‚\nå¤„ç†æ‰‹æ®µ1ï¼š\nåœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ pyroscope SDKï¼Œæ–°å¢ godeltaprof æŒ‡æ ‡ã€‚\nå¤„ç†æ‰‹æ®µ2ï¼š\nç»§ç»­åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨æ ‡å‡†åº“çš„ pprofï¼Œè°ƒæ•´ scrape é…ç½®ï¼Œå°† memoryã€mutexã€block ç­‰æŒ‡æ ‡æŒ‡å‘æ ‡å‡†åº“çš„ pprofã€‚\nä»£ç ç‰‡æ®µ profile.godeltaprof_memory { - enabled = true + enabled = false } profile.memory { // disable memory, use godeltaprof_memory instead - enabled = false + enabled = true } profile.godeltaprof_mutex { - enabled = true + enabled = false } profile.mutex { // disable mutex, use godeltaprof_mutex instead - enabled = false + enabled = true } profile.godeltaprof_block { - enabled = true + enabled = false } profile.block { // disable block, use godeltaprof_block instead - enabled = false + enabled = true } æ•ˆæœå±•ç¤ºï¼š\nè°ƒæ•´åçš„æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå·²ç»æ­£å¸¸å±•ç¤ºï¼š\n8. Doris ç›¸å…³ # 8.1 åŠ¨æ€åˆ†åŒºè¡¨æ’å…¥æ•°æ®æ—¶å¤±è´¥ï¼Œæç¤º \u0026ldquo;no partition for this tuple\u0026rdquo; # å­˜åœ¨è¿™ä¹ˆä¸€ä¸ªåŠ¨æ€åˆ†åŒºè¡¨ æ ¹æ® day å­—æ®µåŠ¨æ€åˆ†åŒºï¼Œå…¶ DDL å¦‚ä¸‹ï¼š\ncreate table if not exists a_daily_tbl ( `mch_id` INT not null, `user_id` BIGINT not null, `day` DATE not null, `type` VARCHAR(64) not null, `count` INT SUM, `total` BIGINT SUM, `add_total` BIGINT SUM, `updated_at` DATETIME MAX ) AGGREGATE KEY(`mch_id`, `user_id`, `day`,`type`) PARTITION BY range (`day`) () DISTRIBUTED BY HASH(`mch_id`, `user_id`) BUCKETS AUTO PROPERTIES ( \u0026#34;replication_allocation\u0026#34; = \u0026#34;tag.location.default: 3\u0026#34;, \u0026#34;dynamic_partition.enable\u0026#34; = \u0026#34;true\u0026#34;, \u0026#34;dynamic_partition.time_unit\u0026#34; = \u0026#34;DAY\u0026#34;, \u0026#34;dynamic_partition.start\u0026#34; = \u0026#34;-90\u0026#34;, \u0026#34;dynamic_partition.end\u0026#34; = \u0026#34;1\u0026#34;, \u0026#34;dynamic_partition.prefix\u0026#34; = \u0026#34;a_daily_tbl_prefix\u0026#34;, \u0026#34;dynamic_partition.buckets\u0026#34;=\u0026#34;2\u0026#34;, \u0026#34;dynamic_partition.create_history_partition\u0026#34;=\u0026#34;true\u0026#34; ); å½“æŸä¸€å¤©å¦‚ 2024-12-31 è¿™ä¸€å¤©çš„æ•°æ®æƒ³è¦æ’å…¥æœªæ¥çš„ä¸€æ¡æ•°æ®ï¼Œæ‰§è¡Œå¦‚ä¸‹ SQL è¯­å¥ï¼š\nINSERT INTO a_daily_tbl values (101, 101743183, \u0026#39;2025-01-02\u0026#39;, \u0026#39;type_1\u0026#39;, 1, 5000000, 5000000, \u0026#39;2025-01-02 02:40:16\u0026#39;); æç¤ºé”™è¯¯ï¼š\nerrCode = 2, detailMessage = Insert has filtered data in strict mode. url: http://HOST:PORT/api/_load_error_log?file=__shard_3/error_log_insert_stmt_16be9eb83cde44be-a0ecc5687c9ead8e_16be9eb83cde44be_a0ecc5687c9ead8e # é“¾æ¥ä¸­çš„å†…å®¹å¦‚ä¸‹ï¼š Reason: no partition for this tuple. tuple= +---------------+---------------+---------------+---------------+-----------------+-----------------+-----------------+----------------------+ |(Int32) |(Int64) |(DateV2) |(String) |(Nullable(Int32))|(Nullable(Int64))|(Nullable(Int64))|(Nullable(DateTimeV2))| +---------------+---------------+---------------+---------------+-----------------+-----------------+-----------------+----------------------+ | 101| 101743183| 2025-01-02| type_1| 1| 5000000| 5000000| 2025-01-02 02:40:16| +---------------+---------------+---------------+---------------+-----------------+-----------------+-----------------+----------------------+ . src line []; æ–‡æ¡£æŸ¥é˜…ï¼š\nDoris#Dynamic Partition Doris#Alter Table Property æ ¹æ®æ–‡æ¡£ï¼ŒåŠ¨æ€åˆ†åŒºè¡¨çš„åˆ†åŒºèŒƒå›´æ˜¯åœ¨ dynamic_partition.start å’Œ dynamic_partition.end ä¹‹é—´çš„ï¼Œå¦‚æœæ’å…¥çš„æ•°æ®è¶…å‡ºäº†è¿™ä¸ªèŒƒå›´ï¼Œå°±ä¼šæç¤º \u0026ldquo;no partition for this tuple\u0026rdquo;ã€‚\ndynamic_partition.start\nThe starting offset of the dynamic partition, usually a negative number. Depending on the time_unit attribute, based on the current day (week / month), the partitions with a partition range before this offset will be deleted. If not filled, the default is -2147483648, that is, the history partition will not be deleted.\nä»£è¡¨åŠ¨æ€åˆ†åŒºçš„èµ·å§‹åç§»é‡ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªè´Ÿæ•°ã€‚æ ¹æ® time_unit å±æ€§çš„ä¸åŒï¼ŒåŸºäºå½“å‰çš„å¤©ï¼ˆå‘¨/æœˆï¼‰ï¼Œåœ¨è¿™ä¸ªåç§»é‡ä¹‹å‰çš„åˆ†åŒºèŒƒå›´çš„åˆ†åŒºå°†è¢«åˆ é™¤ã€‚å¦‚æœæœªå¡«å†™ï¼Œåˆ™é»˜è®¤ä¸º -2147483648ï¼Œå³å†å²åˆ†åŒºä¸ä¼šè¢«åˆ é™¤ã€‚\ndynamic_partition.end\nThe end offset of the dynamic partition, usually a positive number. According to the difference of the time_unit attribute, the partition of the corresponding range is created in advance based on the current day (week / month).\nä»£è¡¨åŠ¨æ€åˆ†åŒºçš„ç»“æŸåç§»é‡ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªæ­£æ•°ã€‚æ ¹æ® time_unit å±æ€§çš„ä¸åŒï¼ŒåŸºäºå½“å‰çš„å¤©ï¼ˆå‘¨/æœˆï¼‰ï¼Œæå‰åˆ›å»ºå¯¹åº”èŒƒå›´çš„åˆ†åŒºã€‚\nå¤„ç†æ‰‹æ®µï¼š\nå› æ­¤ä» DDL ä¸­å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªè¡¨çš„åŠ¨æ€åˆ†åŒºèŒƒå›´æ˜¯ä» -90 å¤©åˆ° 1 å¤©ï¼Œå› æ­¤å½“æˆ‘ä»¬åœ¨ 2024-12-31 è¿™ä¸€å¤©æ’å…¥ 2025-01-02 (cur + 2) è¿™ä¸€å¤©çš„æ•°æ®æ—¶ï¼Œè¶…å‡ºäº†åŠ¨æ€åˆ†åŒºçš„èŒƒå›´ï¼Œå› æ­¤æç¤ºåˆ†åŒºä¸å­˜åœ¨ã€‚\né‚£ä¹ˆè§£å†³åŠæ³•è¦ä¹ˆå°±æ˜¯è°ƒæ•´æ’å…¥æ•°æ®çš„æ—¶é—´ï¼Œè¦ä¹ˆå°±æ˜¯è°ƒæ•´åŠ¨æ€åˆ†åŒºçš„èŒƒå›´ã€‚\nè°ƒæ•´åŠ¨æ€åˆ†åŒºçš„èŒƒå›´ï¼Œå°† dynamic_partition.end è°ƒæ•´ä¸º 2 å¤©ã€‚\nALTER TABLE a_daily_tbl SET (\u0026#34;dynamic_partition.end\u0026#34; = \u0026#34;2\u0026#34;); ç„¶åç¨ç­‰ç‰‡åˆ»ï¼Œç¡®è®¤åˆ†åŒºå·²ç»åˆ›å»º show partitions from a_daily_tblï¼Œç„¶åå†æ’å…¥æ•°æ®å°±å¯ä»¥äº†ã€‚\n"},{"id":12,"href":"/2024/08/18/shardingsphere-proxy%E9%97%AE%E9%A2%98%E5%87%A0%E5%88%99/","title":"ShardingSphere-Proxyé—®é¢˜å‡ åˆ™","section":"Posts","content":"ShardingSphere Proxy æ˜¯ Apache ShardingSphere çš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œæ˜¯ä¸€ä¸ªåŸºäº MySQL åè®®çš„æ•°æ®åº“ä¸­é—´ä»¶ï¼Œç”¨äºå®ç°åˆ†åº“åˆ†è¡¨ã€è¯»å†™åˆ†ç¦»ç­‰åŠŸèƒ½ã€‚åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œè®°å½•å¦‚ä¸‹ã€‚\nè¿™é‡Œä¸»è¦é’ˆå¯¹çš„æ˜¯ åˆ†åº“åˆ†è¡¨ çš„ä½¿ç”¨åœºæ™¯ã€‚\né—®é¢˜æ¦‚è¿° # æ•°æ®åº“å¾€å¾€æ˜¯ä¸€ä¸ªç³»ç»Ÿæœ€å®¹æ˜“å‡ºç°ç“¶é¢ˆçš„ç‚¹ï¼Œå½“é‡åˆ°æ•°æ®åº“ç“¶é¢ˆæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ•°æ®æ‹†åˆ†æ¥ç¼“è§£é—®é¢˜ã€‚æ•°æ®æ‹†åˆ†çš„æ–¹å¼é€šå¸¸åˆ†ä¸ºæ¨ªå‘æ‹†åˆ†å’Œçºµå‘æ‹†åˆ†ï¼Œæ¨ªå‘æ‹†åˆ†å³åˆ†åº“åˆ†è¡¨ï¼›çºµå‘æ‹†åˆ†å³æŠŠä¸€ä¸ªåº“è¡¨ä¸­çš„å­—æ®µæ‹†åˆ†åˆ°ä¸åŒçš„åº“è¡¨ä¸­å»ã€‚è¿™ä¸¤ç§æ‰‹æ®µå¹¶ä¸äº’æ–¥ï¼Œè€Œæ˜¯åœ¨å®é™…æƒ…å†µä¸­ç›¸è¾…ç›¸æˆã€‚æœ¬æ–‡å³æ˜¯æ¨ªå‘æ‹†åˆ†ç›¸å…³å†…å®¹ã€‚\nå¸¸è§çš„éƒ¨ç½²æ–¹å¼æœ‰å“ªäº›ï¼Ÿ æ•°æ®åˆ†ç‰‡è§„åˆ™æ€ä¹ˆé…ç½®ï¼Ÿ æ•°æ®åˆ†ç‰‡æ•°åº”è¯¥æ€ä¹ˆç¡®å®šï¼Ÿ æ•°æ®åˆ†ç‰‡åå”¯ä¸€ç´¢å¼•è¿˜æœ‰ç”¨å—ï¼Ÿ æ•°æ®åˆ†ç‰‡åæ•°æ®è¿ç§»ï¼Ÿ æ•°æ®åˆ†ç‰‡åå¦‚ä½•ç¡®å®šå®é™…æ‰§è¡Œ SQL è¯­å¥ï¼Ÿ æ•°æ®åˆ†ç‰‡åçš„æŸ¥è¯¢ä¼˜åŒ–ï¼Ÿ 0. å¸¸è§çš„éƒ¨ç½²æ–¹å¼ # å®˜æ–¹æä¾›äº†ä¸¤ç§éƒ¨ç½²æ–¹å¼ï¼š\nå•æœºéƒ¨ç½²ï¼šå°† ShardingSphere Proxy éƒ¨ç½²åœ¨å•å°æœåŠ¡å™¨ä¸Šï¼Œç”¨äºæµ‹è¯•å’Œå¼€å‘ç¯å¢ƒã€‚ é›†ç¾¤éƒ¨ç½²ï¼šå°† ShardingSphere Proxy éƒ¨ç½²åœ¨å¤šå°æœåŠ¡å™¨ä¸Šï¼Œç”¨äºç”Ÿäº§ç¯å¢ƒã€‚é›†ç¾¤æ¨¡å¼ä¸‹ä½¿ç”¨ zookeeper æ¥å­˜å‚¨å…ƒæ•°æ®ã€‚ å…³äºå…ƒæ•°æ®ï¼Œå…ƒæ•°æ®æ˜¯ ShardingSphere Proxy çš„æ ¸å¿ƒï¼Œç”¨äºå­˜å‚¨åˆ†åº“åˆ†è¡¨è§„åˆ™ã€è¯»å†™åˆ†ç¦»è§„åˆ™ç­‰ä¿¡æ¯ã€‚ å®˜æ–¹å»ºè®®ä½¿ç”¨é›†ç¾¤æ¨¡å¼éƒ¨ç½² ç”Ÿäº§ç¯å¢ƒçš„ ShardingSphere Proxy\nå¦‚æœä¸æŒ‰ç…§å®˜æ–¹çš„æŒ‡å¼•ï¼Œé€‰æ‹©éƒ¨ç½²äº†å¤šä¸ª Standalone æ¨¡å¼çš„ ShardingSphere Proxyï¼Œé‚£ä¹ˆéœ€è¦æ³¨æ„â€œæ¯ä¸ªè¿™æ ·çš„ proxy èŠ‚ç‚¹ä¼šæœ‰è‡ªå·±çš„å…ƒä¿¡æ¯ï¼Œä»–ä»¬ä¹‹é—´å¹¶ä¸äº’é€šâ€ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ä¼šå‡ºç°èŠ‚ç‚¹ä¹‹é—´å…ƒæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œå‚çœ‹å¦‚ä¸‹æµ‹è¯•ï¼š\n# å¯åŠ¨ 3 ä¸ª standalone æ¨¡å¼çš„ ShardingSphere Proxy +-------+ | LB | +-------+ | |-------------|--------------| | | | +-------+ +-------+ +-------+ | Node1 | | Node2 | | Node3 | +-------+ +-------+ +-------+ åˆå§‹è¡¨ç»“æ„å¦‚ä¸‹ï¼š\nCREATE TABLE t_user ( id BIGINT NOT NULL comment \u0026#39;ä¸»é”®\u0026#39;, /* ä¸»é”® */ user_id BIGINT NOT NULL unique comment \u0026#39;ç”¨æˆ·ID\u0026#39;, /* ç”¨æˆ·ID, åˆ†è¡¨ key */ mch_id BIGINT NOT NULL comment \u0026#39;å•†æˆ·ID\u0026#39;, /* å•†æˆ·ID, åˆ†åº“ key */ PRIMARY KEY (user_id) ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4; ç„¶ååœ¨ä»»æ„ä¸€ä¸ª standalone æ¨¡å¼çš„ ShardingSphere Proxy æ‰§è¡Œæ›´æ–°è¡¨ç»“æ„çš„ SQL è¯­å¥ï¼š\nALTER TABLE t_user ADD COLUMN name VARCHAR(255) NOT NULL DEFAULT \u0026#39;\u0026#39; COMMENT \u0026#39;å§“å\u0026#39;; è¿™æ—¶å€™åœ¨å¦å¤–ä¸€ä¸ª standalone æ¨¡å¼çš„ ShardingSphere Proxy æŸ¥è¯¢è¡¨ç»“æ„ å’Œ æŸ¥è¯¢æ•°æ®çš„è¯­å¥ï¼š\ndesc t_user; select * from t_user; ä¼šå‘ç°è¡¨ç»“æ„æè¿°å·²ç»æ˜¯æœ€æ–°çš„ï¼Œä½†æ˜¯å®é™…æŸ¥è¯¢æ•°æ®æ—¶ï¼Œæ²¡æœ‰æ–°å¢çš„å­—æ®µï¼Œå¦‚ä¸‹å›¾ï¼š\nè¿™å°±æ˜¯å…ƒæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œæ‰€ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®ä½¿ç”¨é›†ç¾¤æ¨¡å¼éƒ¨ç½² ShardingSphere Proxyã€‚å½“ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡æ‰‹åŠ¨åŒæ­¥å…ƒæ•°æ®çš„æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå‚è€ƒå¦‚ä¸‹ï¼š\nREFRESH TABLE METADATA è¿™æ ·æ“ä½œåå†æŸ¥è¯¢æ•°æ®ï¼Œå°±èƒ½æ‹¿åˆ°æ–°å¢çš„å­—æ®µäº†, å¦‚ä¸‹å›¾ï¼š\n1. å¦‚ä½•é…ç½®åˆ†åº“åˆ†è¡¨è§„åˆ™ï¼Ÿç®—æ³•æœ‰å“ªäº›ï¼Ÿ # è§„åˆ™é…ç½®å‚è€ƒï¼šhttps://shardingsphere.apache.org/document/current/cn/user-manual/shardingsphere-jdbc/yaml-config/rules/sharding/\nè¿™ä¸ªé—®é¢˜å¾ˆå¥½ç†è§£ï¼Œåˆ†åº“åˆ†è¡¨çš„è§„åˆ™é…ç½®æ˜¯æ•´ä¸ªæ•°æ®åˆ†ç‰‡çš„æ ¸å¿ƒï¼Œä¹Ÿæ˜¯æœ€é‡è¦çš„ä¸€ç¯ã€‚åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯ä»¥é€šè¿‡ shardingAlgorithms é…ç½®é¡¹æŒ‡å®šåˆ†åº“åˆ†è¡¨ç®—æ³•ï¼Œå¦‚ä¸‹ï¼š\n- !SHARDING tables: # åˆ†ç‰‡è¡¨é…ç½® t_user: # é€»è¾‘è¡¨å actualDataNodes: ds_${0..1}.t_user_${0..1} # å®é™…æ•°æ®èŠ‚ç‚¹ databaseStrategy: # åˆ†åº“ç­–ç•¥ standard: # ç”¨äºå•åˆ†ç‰‡é”®çš„åˆ†ç‰‡ç­–ç•¥ shardingColumn: mch_id # åˆ†ç‰‡é”® shardingAlgorithmName: database_inline # åˆ†åº“ç®—æ³• tableStrategy: # åˆ†è¡¨ç­–ç•¥ standard: # ç”¨äºå•åˆ†ç‰‡é”®çš„åˆ†ç‰‡ç­–ç•¥ shardingColumn: user_id # åˆ†ç‰‡é”® shardingAlgorithmName: t_user_inline # åˆ†è¡¨ç®—æ³• shardingAlgorithms: # åˆ†ç‰‡ç®—æ³•é…ç½® database_inline: # ç®—æ³•1 - åˆ†åº“ç®—æ³• props: algorithm-expression: ds_${mch_id % 2} # åˆ†åº“ç®—æ³•è¡¨è¾¾å¼ t_user_inline: # ç®—æ³•2 - åˆ†è¡¨ç®—æ³• props: algorithm-expression: t_user_${user_id % 2} # åˆ†è¡¨ç®—æ³•è¡¨è¾¾å¼ åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é…ç½®äº†ä¸€ä¸ª t_user è¡¨ï¼Œä½¿ç”¨ standard ç®—æ³•ï¼Œåˆ†åº“åˆ†è¡¨çš„è§„åˆ™å¦‚ä¸‹ï¼š\nåˆ†åº“è§„åˆ™ï¼šæ ¹æ® mch_id å­—æ®µè¿›è¡Œåˆ†åº“ï¼Œåˆ†åº“ç®—æ³•ä¸º database_inlineï¼Œåˆ†åº“ç®—æ³•è¡¨è¾¾å¼ä¸º ds_${mch_id % 2}ã€‚ åˆ†è¡¨è§„åˆ™ï¼šæ ¹æ® user_id å­—æ®µè¿›è¡Œåˆ†è¡¨ï¼Œåˆ†è¡¨ç®—æ³•ä¸º t_user_inlineï¼Œåˆ†è¡¨ç®—æ³•è¡¨è¾¾å¼ä¸º t_user_${user_id % 2}ã€‚ è¿™é‡Œçš„åˆ†åº“åˆ†è¡¨ç®—æ³•éƒ½æ˜¯åŸºäº â€œå–æ¨¡â€ çš„ç®—æ³•ï¼Œè¿™æ˜¯ä¸€ç§ç®€å•çš„åˆ†ç‰‡ç®—æ³•ï¼Œé€‚ç”¨äºå¤§éƒ¨åˆ†åœºæ™¯ã€‚ShardingSphere Proxy æ”¯æŒçš„åˆ†ç‰‡ç®—æ³•å¦‚ä¸‹ï¼š\nhttps://shardingsphere.apache.org/document/current/cn/user-manual/common-config/builtin-algorithm/sharding/\nè‡ªåŠ¨åˆ†ç‰‡ç®—æ³•\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè‡ªåŠ¨åˆ†ç‰‡ç®—æ³•çš„åˆ†ç‰‡é€»è¾‘ç”± ShardingSphere è‡ªåŠ¨ç®¡ç†ï¼Œéœ€è¦é€šè¿‡é…ç½® autoTables åˆ†ç‰‡è§„åˆ™è¿›è¡Œä½¿ç”¨ã€‚\nè‡ªåŠ¨åˆ†ç‰‡ç®—æ³•åˆåˆ†ä¸ºï¼š\nå–æ¨¡åˆ†ç‰‡ç®—æ³•ï¼ˆMODï¼‰ï¼šæ ¹æ®åˆ†ç‰‡é”®ï¼ˆintï¼‰å¯¹åˆ†ç‰‡æ•°å–æ¨¡ï¼Œç„¶åè·¯ç”±åˆ°å¯¹åº”çš„åˆ†ç‰‡ä¸Šæ‰§è¡Œã€‚\nHashå–æ¨¡åˆ†ç‰‡ç®—æ³•ï¼ˆHASH_MODï¼‰ï¼šæ ¹æ®åˆ†ç‰‡é”®ï¼ˆintï¼‰è¿›è¡Œ Hash è®¡ç®—ï¼Œç„¶åå¯¹åˆ†ç‰‡æ•°å–æ¨¡ï¼Œç„¶åè·¯ç”±åˆ°å¯¹åº”çš„åˆ†ç‰‡ä¸Šæ‰§è¡Œã€‚\nåŸºäºåˆ†ç‰‡å®¹é‡çš„èŒƒå›´åˆ†ç‰‡ç®—æ³•ï¼ˆVOLUME_RANGEï¼‰ï¼šé…ç½®åˆ†ç‰‡é”®çš„èŒƒå›´ä¸Šé™ï¼ˆrange-upperï¼‰å’Œä¸‹é™ï¼ˆrange-lowerï¼‰ï¼ŒåŒæ—¶è¿˜éœ€è¦é…ç½®åˆ†ç‰‡å®¹é‡ï¼ˆsharding-volumeï¼‰ã€‚é€‚ç”¨äºæ•°æ®å¢é•¿è¶‹åŠ¿ç›¸å¯¹å‡åŒ€ï¼ŒæŒ‰åˆ†ç‰‡å®¹é‡å°†æ•°æ®å‡åŒ€åœ°åˆ†å¸ƒåˆ°ä¸åŒçš„åˆ†ç‰‡è¡¨ä¸­ï¼Œå¯ä»¥æœ‰æ•ˆé¿å…æ•°æ®å€¾æ–œé—®é¢˜ï¼›ç”±äºæ•°æ®å·²ç»è¢«æŒ‰ç…§èŒƒå›´è¿›è¡Œåˆ†ç‰‡ï¼Œæ”¯æŒé¢‘ç¹è¿›è¡ŒèŒƒå›´æŸ¥è¯¢åœºæ™¯ã€‚\nåŸºäºåˆ†ç‰‡è¾¹ç•Œçš„èŒƒå›´åˆ†ç‰‡ç®—æ³•ï¼ˆBOUNDARY_RANGEï¼‰ï¼šæ ¹æ®æ•°æ®çš„å–å€¼èŒƒå›´è¿›è¡Œåˆ†ç‰‡ï¼Œç‰¹åˆ«é€‚åˆæŒ‰æ•°å€¼èŒƒå›´é¢‘ç¹æŸ¥è¯¢çš„åœºæ™¯ï¼Œæ¯”å¦‚æ•°æ®ä¸­å¦‚æœåŒ…å« date: 202408 è¿™ç§å­—æ®µï¼Œå¯ä»¥æŒ‰ç…§ date å­—æ®µè¿›è¡Œåˆ†ç‰‡ï¼Œåœ¨æŸ¥è¯¢æ—¶å¯ä»¥ç›´æ¥æ ¹æ® date å­—æ®µçš„èŒƒå›´è¿›è¡ŒæŸ¥è¯¢ã€‚\nè‡ªåŠ¨æ—¶é—´æ®µåˆ†ç‰‡ç®—æ³•ï¼ˆAUTO_INTERVALï¼‰ï¼šé…ç½®åˆ†ç‰‡çš„èµ·å§‹æ—¶é—´èŒƒå›´ï¼ˆdatetime-lowerï¼‰å’Œç»“æŸæ—¶é—´èŒƒå›´ï¼ˆdatetime-upperï¼‰ï¼ŒåŒæ—¶è¿˜éœ€è¦é…ç½®å•ä¸€åˆ†ç‰‡èƒ½æ‰¿è½½çš„æœ€å¤§æ—¶é—´ï¼ˆsharding-secondsï¼‰ã€‚å¦‚ä¸‹é…ç½®ï¼š\nshardingAlgorithms: t_order_auto_interval: props: datetime-lower: 2024-08-01 00:00:00 datetime-upper: 2029-08-31 23:59:59 sharding-seconds: 31536000 # 1å¹´ è¯¥é…ç½®è¡¨ç¤ºï¼Œå°†æ•°æ®æŒ‰ç…§æ—¶é—´èŒƒå›´è¿›è¡Œåˆ†ç‰‡ï¼Œå­˜å‚¨ä» 2024-08-01 åˆ° 2029-08-31 çš„æ•°æ®ï¼Œæ¯ä¸ªåˆ†ç‰‡æœ€å¤šå­˜å‚¨ 1 å¹´çš„æ•°æ®ã€‚\næ ‡å‡†åˆ†ç‰‡ç®—æ³•\nShardingSphere Proxy å®ç°çš„æ ‡å‡†åˆ†ç‰‡ç®—æ³•æœ‰ï¼š\nè¡Œè¡¨è¾¾å¼åˆ†ç‰‡ç®—æ³•ï¼ˆINLINEï¼‰ï¼šæä¾›å¯¹ SQL ä¸­çš„ = å’Œ IN è¿ç®—ç¬¦çš„åˆ†ç‰‡æ“ä½œæ”¯æŒï¼Œåªæ”¯æŒå•åˆ†ç‰‡é”®ã€‚\næ—¶é—´èŒƒå›´åˆ†ç‰‡ç®—æ³•ï¼ˆINTERVALï¼‰ï¼šé’ˆå¯¹äºæ—¶é—´å­—æ®µï¼ˆå­—ç¬¦ä¸²ç±»å‹ï¼‰ä½œä¸ºåˆ†ç‰‡å¥çš„èŒƒå›´åˆ†ç‰‡ç®—æ³•ï¼Œé€‚ç”¨äºæŒ‰ç…§å¤©ã€æœˆã€å¹´è¿™ç§å›ºå®šåŒºé—´çš„æ•°æ®åˆ†ç‰‡ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š\nshardingAlgorithms: t_order_interval: props: datetime-pattern: \u0026#34;yyyy-MM-dd HH:mm:ss\u0026#34; # åˆ†ç‰‡å­—æ®µæ ¼å¼ datetime-lower: \u0026#34;2024-01-01 00:00:00\u0026#34; # èŒƒå›´ä¸‹é™ datetime-upper: \u0026#34;2024-06-30 23:59:59\u0026#34; # èŒƒå›´ä¸Šé™ sharding-suffix-pattern: \u0026#34;yyyyMM\u0026#34; # åˆ†ç‰‡ååç¼€ï¼Œå¯ä»¥æ˜¯MMï¼ŒyyyyMMddç­‰ã€‚ datetime-interval-amount: 1 # åˆ†ç‰‡é—´éš”ï¼Œè¿™é‡ŒæŒ‡ä¸€ä¸ªæœˆ datetime-interval-unit: \u0026#34;MONTHS\u0026#34; # åˆ†ç‰‡é—´éš”å•ä½ è¿™é‡Œçš„é…ç½®è¡¨ç¤ºï¼Œå°†æ•°æ®æŒ‰ç…§æ—¶é—´èŒƒå›´è¿›è¡Œåˆ†ç‰‡ï¼Œå­˜å‚¨ä» 2024-01-01 åˆ° 2024-06-30 çš„æ•°æ®ï¼Œæ¯ä¸ªåˆ†ç‰‡æœ€å¤šå­˜å‚¨ 1 ä¸ªæœˆçš„æ•°æ®ã€‚æ•°æ®åˆ†ç‰‡åçš„è¡¨ååç¼€ä¸º yyyyMMï¼Œå³æ¯ä¸ªæœˆä¸€ä¸ªåˆ†ç‰‡ã€‚\nå¤åˆåˆ†ç‰‡ç®—æ³•\nå¤åˆè¡Œè¡¨è¾¾å¼åˆ†ç‰‡ç®—æ³•ï¼ˆCOMPLEX_INLINEï¼‰ï¼šè¿™ä¸ªä¹Ÿæ˜¯ç±»ä¼¼äº INLINE ç®—æ³•ï¼Œä½†æ˜¯æ”¯æŒå¤šåˆ†ç‰‡é”®çš„åœºæ™¯ã€‚æ¯”å¦‚åœ¨å•åˆ†ç‰‡é”®çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ t_user.user_id æ¥è¿›è¡Œåˆ†ç‰‡ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦ä½¿ç”¨ t_user.mch_id å’Œ t_user.user_id æ¥è¿›è¡Œåˆ†ç‰‡ï¼Œè¿™æ—¶å€™å°±å¯ä»¥ä½¿ç”¨ COMPLEX_INLINE ç®—æ³•ã€‚å¦‚ä¸‹ï¼š\n- !SHARDING tables: t_user: actualDataNodes: ds_${0..1}.t_user_${0..1} databaseStrategy: complex: shardingColumns: mch_id, user_id shardingAlgorithmName: complex_inline shardingAlgorithms: complex_inline: props: algorithm-expression: ds_${mch_id + user_id % 2} Hint åˆ†ç‰‡ç®—æ³•\nHint è¡Œè¡¨è¾¾å¼åˆ†ç‰‡ç®—æ³•ï¼ˆHINT_INLINEï¼‰ï¼šç±»ä¼¼äº INLINE ç®—æ³•ï¼Œä½†æ˜¯æ”¯æŒä¸ä¾èµ–äº SQL çš„åˆ†ç‰‡é”®åœºæ™¯ã€‚java å¯ä»¥ç›´æ¥ä½¿ç”¨ hint API è¿›è¡Œä½¿ç”¨ï¼Œå…¶ä»–è¯­è¨€å¯ä»¥é€šè¿‡ SQL æ³¨é‡Šè¿›è¡Œä½¿ç”¨ã€‚å¦‚ä¸‹ï¼š\nHintManager hintManager = HintManager.getInstance(); hintManager.addDatabaseShardingValue(\u0026#34;t_order\u0026#34;, 1); hintManager.addTableShardingValue(\u0026#34;t_order\u0026#34;, 1); /* SHARDINGSPHERE_HINT: {key} = {value}, {key} = {value} */ SELECT * FROM t_user WHERE id = 1; å¯ä»¥ä½¿ç”¨ keys å‚è§ https://shardingsphere.apache.org/document/5.5.0/cn/user-manual/common-config/sql-hint/\næ³¨æ„å¦‚æœä½¿ç”¨çš„æ˜¯ shardingsphere-proxy ä»£ç†ï¼Œéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­å¼€å¯ sqlCommentParseEnabled å¼€å…³ã€‚\nprops: sql-show: true sqlParser: sqlCommentParseEnabled: true è‡ªå®šä¹‰åˆ†ç‰‡ç®—æ³•\nè‡ªå®šä¹‰åˆ†ç‰‡ç®—æ³•ï¼ˆCLASS_BASEDï¼‰ï¼šç”¨æˆ·è‡ªå®šä¹‰åˆ†ç‰‡ç®—æ³•ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚çš„åˆ†ç‰‡ç®—æ³•ï¼Œå¦‚æœæ²¡æœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œå¯ä»¥ä½¿ç”¨è‡ªåŠ¨åˆ†ç‰‡ç®—æ³•ï¼Œè¿™æ ·å¯ä»¥å‡å°‘é…ç½®çš„å¤æ‚åº¦ã€‚\n2. åˆ†ç‰‡æ•°å¦‚ä½•ç¡®å®šï¼Ÿ # è¯´åˆ°æ•°æ®åˆ†ç‰‡æ•°ï¼Œé‚£ä¹ˆå¿…é¡»è¦é—®ä¸€ä¸‹ä¸ºä»€ä¹ˆè¦è¿›è¡Œæ•°æ®åˆ†ç‰‡ï¼Œä¸åˆ†ç‰‡ä¸è¡Œå—ï¼Ÿå¤§éƒ¨åˆ†ä¸šåŠ¡å¯èƒ½éƒ½ç”¨ä¸ä¸Šåˆ†åº“åˆ†è¡¨ï¼Œè€ƒè™‘åˆ†åº“åˆ†è¡¨æ—¶æˆ‘ä»¬é¢ä¸´çš„åœºæ™¯å¤§éƒ¨åˆ†éƒ½æ˜¯ï¼šâ€œå•è¡¨æ•°æ®è¶…è¿‡ä¸€ä¸ªç•Œé™å¯¼è‡´æ€§èƒ½å—åˆ°ä¸¥é‡å½±å“â€ï¼Œè¿™ä¸ªç•Œé™ç°åœ¨è¯´æ³•æ¯”è¾ƒå¤šçš„æ˜¯ 500w - 2000wï¼Œä½†è¿™å¹¶ä¸æ˜¯é“å¾‹ï¼Œè¿˜æ˜¯è¦ä»¥å®é™…æƒ…å†µä¸ºå‡†ã€‚\nåœ¨å†³å®šåˆ†ç‰‡æ•°æ—¶å€™ï¼Œæœ‰å‡ ä¸ªè€ƒè™‘å› ç´ ï¼š\næ•°æ®é‡ï¼šæ ¹æ®æ•°æ®é‡çš„å¤§å°æ¥å†³å®šåˆ†ç‰‡æ•°ã€‚ç¡®ä¿åˆ†ç‰‡æ•°èƒ½å¤Ÿé™ä½å•è¡¨çš„æ€§èƒ½å‹åŠ›ï¼ŒåŒæ—¶ä¸ºæœªæ¥é¢„ç•™ä¸€å®šçš„å¢é•¿ç©ºé—´ã€‚ åˆ†ç‰‡é”®çš„é€‰æ‹©ï¼šé€‰æ‹©åˆé€‚çš„åˆ†ç‰‡é”®éå¸¸é‡è¦ï¼Œåˆ†ç‰‡é”®çš„é€‰æ‹©ä¼šç›´æ¥å½±å“åˆ°åˆ†ç‰‡æ•°ã€‚è­¬å¦‚è¯´ä¸€ä¸ªåˆ†ç‰‡é”®çš„å–å€¼åªæœ‰ A å’Œ Bï¼Œé‚£æˆ‘ä»¬è®¾ç½®è¶…è¿‡2ä¸ªåˆ†ç‰‡æ•°ä¹Ÿæ²¡æœ‰å¤ªå¤§çš„æ„ä¹‰ã€‚ åˆ†ç‰‡ç®—æ³•ï¼šé€‰æ‹© mod å’Œ range ä¸¤ç§åˆ†ç‰‡ç®—æ³•æ—¶ï¼Œåˆ†ç‰‡æ•°ä¹Ÿä¼šä¸ä¸€æ ·ã€‚è­¬å¦‚ï¼Œä¸šåŠ¡ä¸­æ ¹æ®æ—¶é—´åˆ†ç‰‡ï¼Œé‚£ä¹ˆéœ€è¦è€ƒè™‘æ˜¯ä»€ä¹ˆæ—¶é—´èŒƒå›´ï¼ŒæŒ‰æœˆè¿˜æ˜¯å¹´ï¼Ÿè€Œä½¿ç”¨ mod åˆ†ç‰‡åˆ™éœ€è¦è€ƒè™‘æ•°æ®é‡å’Œåˆ†ç‰‡é”®ã€‚ ç»´æŠ¤æˆæœ¬ï¼šåˆ†ç‰‡æ•°è¶Šå¤šï¼Œéœ€è¦çš„èµ„æºå’Œç»´æŠ¤æˆæœ¬å°±è¶Šé«˜ã€‚ è¿™ä¸ªå½“ç„¶éœ€è¦ç»“åˆå…·ä½“æƒ…å†µå…·ä½“åˆ†æï¼Œä¸Šè¿°åªæ˜¯ä¸€ä¸ªç®€å•çš„åˆ†æåŠæ³•ï¼Œå®é™…æƒ…å†µä¸­æˆ‘ä»¬è¿˜è¦è€ƒè™‘æ•°æ®å€¾æ–œã€æ•°æ®å¢é•¿å’Œéƒ¨ç½²æ–¹å¼ç­‰å› ç´ ã€‚\né™¤æ‰ä¸Šè¿°çš„å› ç´ è€ƒè™‘å¤–ï¼Œé€‰æ‹©çš„æ•°å€¼å°½é‡æ˜¯ 2 çš„å¹‚æ¬¡ã€‚å…è´£æ¡æ¬¾ï¼šçº¯ä¸ªäººç»éªŒï¼Œä¸ä¿çœŸ\n3. åˆ†åº“åˆ†è¡¨åå”¯ä¸€ç´¢å¼•çš„ç”Ÿæ•ˆèŒƒå›´å¦‚ä½•ï¼Ÿ # åˆ†åº“åˆ†è¡¨åï¼Œå”¯ä¸€ç´¢å¼•çš„ç”Ÿæ•ˆèŒƒå›´æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ£˜æ‰‹çš„é—®é¢˜ã€‚åœ¨åˆ†åº“åˆ†è¡¨çš„åœºæ™¯ä¸‹ï¼Œå”¯ä¸€ç´¢å¼•çš„ç”Ÿæ•ˆèŒƒå›´æ˜¯åœ¨å•ä¸ªåˆ†ç‰‡å†…ï¼Œè€Œä¸æ˜¯æ•´ä¸ªåˆ†ç‰‡é›†ç¾¤å†…ã€‚è¿™å°±æ„å‘³ç€ï¼Œå¦‚æœè¦ä¿è¯å”¯ä¸€ç´¢å¼•çš„å”¯ä¸€æ€§ï¼Œéœ€è¦åœ¨åº”ç”¨å±‚è¿›è¡Œå¤„ç†ã€‚\nä¸¾ä¸ªä¾‹å­ï¼š\nCREATE TABLE `t_order` ( `order_id` BIGINT(20) NOT NULL AUTO_INCREMENT, `user_id` INT(11) NOT NULL, `status` VARCHAR(45) NOT NULL, PRIMARY KEY (`order_id`), UNIQUE KEY `uk_order_id` (`order_id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8; åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œorder_id å­—æ®µæ˜¯å”¯ä¸€ç´¢å¼•ï¼Œä½†æ˜¯åœ¨åˆ†åº“åˆ†è¡¨çš„åœºæ™¯ä¸‹ï¼Œå”¯ä¸€ç´¢å¼•çš„ç”Ÿæ•ˆèŒƒå›´æ˜¯åœ¨å•ä¸ªåˆ†ç‰‡å†…ï¼Œè€Œä¸æ˜¯æ•´ä¸ªåˆ†ç‰‡é›†ç¾¤å†…ã€‚è¿™å°±æ„å‘³ç€ï¼Œå¦‚æœè¦ä¿è¯å”¯ä¸€ç´¢å¼•çš„å”¯ä¸€æ€§ï¼Œéœ€è¦åœ¨åº”ç”¨å±‚è¿›è¡Œå¤„ç†ã€‚\nå¦‚ä¸‹ä¼ªä»£ç ï¼š\n// ç”Ÿæˆè®¢å•å· String orderId = generateOrderId(); // æ ¹æ®è®¢å•å·æŸ¥è¯¢è®¢å• Order order = orderService.findByOrderId(orderId); if (order != null) { // è®¢å•å·å·²å­˜åœ¨ throw new OrderIdExistException(); } // ä¿å­˜è®¢å• orderService.save(order); åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œé€šè¿‡åœ¨åº”ç”¨å±‚è¿›è¡Œå¤„ç†ï¼Œå¯ä»¥ä¿è¯å”¯ä¸€ç´¢å¼•çš„å”¯ä¸€æ€§ã€‚å½“ç„¶è¿™é‡Œä¼šå­˜åœ¨å¹¶å‘é—®é¢˜ï¼ŒåŒæ ·éœ€è¦åœ¨åº”ç”¨å±‚è¿›è¡Œå¤„ç†ã€‚å¯ä»¥è€ƒè™‘å…¶ä»–çš„è§£å†³æ–¹æ¡ˆï¼Œå¦‚åˆ†å¸ƒå¼é”ç­‰ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚\nè¿™é‡Œè¿˜å¼•ç”³å‡ºæ¥å¦ä¸€ä¸ªé—®é¢˜ï¼šåˆ†åº“åˆ†è¡¨åæ€ä¹ˆç”Ÿæˆå…¨å±€å”¯ä¸€IDï¼Ÿ\nè¿™ä¸ªé—®é¢˜åœ¨ ShardingSphere ä¸­å¯ä»¥é€šè¿‡è®¾ç½® snowflake ç®—æ³•æ¥ç”Ÿæˆä¸»é”®ID (å…·ä½“å‚è€ƒå®˜æ–¹æ–‡æ¡£è¯´æ˜é…ç½®)ï¼Œå¦‚ä¸‹ï¼š\n# è®¾ç½®è¡¨çš„ä¸»é”®ç”Ÿæˆç­–ç•¥ your_table: keyGenerateStrategy: column: id keyGeneratorName: snowflake # è®¾ç½®ä¸»é”®ç”Ÿæˆå™¨ keyGenerators: snowflake: type: SNOWFLAKE props: worker-id: 1 # æ³¨æ„ï¼Œå¦‚æœæœ‰å¤šå°æœºå™¨ï¼Œè¿™é‡Œéœ€è¦è®¾ç½®ä¸åŒçš„å€¼ã€‚å¦‚æœä¸ç†è§£ï¼Œè¯·ç†Ÿè¯»é›ªèŠ±ç®—æ³• 4. åˆ†åº“åˆ†è¡¨åå¦‚ä½•è¿ç§»æ•°æ®ï¼Ÿ # è™½ç„¶åœ¨æ•°æ®åˆ†ç‰‡æ—¶å·²ç»æå‰é¢„ä¼°äº†æ•°æ®å®¹é‡ï¼Œä½†æ˜¯éš¾å…ä¼šæœ‰æ•°æ®å¢é•¿è¶…å‡ºé¢„æœŸï¼Œæˆ–è€…æ•°æ®æ„å¤–å€¾æ–œå¯¼è‡´å•ä¸ª/æŸä¸ªæ•°æ®åˆ†ç‰‡æ•°æ®é‡è¶…å‡ºæ‰¿è½½èƒ½åŠ›ï¼Œè¿™æ—¶å€™å¾€å¾€é€šè¿‡æ•°æ®è¿ç§»æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\næœ‰äº›æƒ…å†µå¯ä»¥é€šè¿‡åˆ é™¤æ— æ•ˆæ•°æ®æ¥è§£å†³ã€‚è­¬å¦‚ä¸€äº›è¡Œä¸ºæ•°æ®ï¼Œå†å²æ•°æ® ç­‰ç­‰ã€‚\nShardingSphere-Scaling æä¾›äº†æ•°æ®è¿ç§»çš„åŠŸèƒ½ï¼Œç›®å‰å¤„äºå®éªŒå®¤é˜¶æ®µï¼Œå¯ä»¥ç”¨äºæ•°æ®è¿ç§»ã€‚å‚è€ƒï¼šhttps://shardingsphere.apache.org/document/5.1.0/cn/user-manual/shardingsphere-scaling/\né™¤æ­¤ä¹‹å¤–ï¼Œå°±æ˜¯äº’è”ç½‘ä¸­å¸¸ç”¨çš„è¿ç§»æ•°æ®çš„æ–¹å¼ï¼Œå¦‚ï¼š\nåœæœºè¿ç§»ï¼šåœæ­¢æœåŠ¡ï¼Œå°†è€æ•°æ®ä¾æ¬¡åº”ç”¨æ–°çš„åˆ†ç‰‡è§„åˆ™å†™å…¥åˆ°æ–°çš„æ•°æ®æºä¸­ï¼›æ‰§è¡Œåˆ‡æ¢ï¼›å¯åŠ¨æœåŠ¡ã€‚ ä¸åœæœºè¿ç§»ï¼š ç¼–å†™è¿ç§»ç¨‹åºï¼Œå°†å†å²æ•°æ®è¿ç§»åˆ°æ–°çš„åˆ†ç‰‡ä¸Šï¼› æ›´æ–°ä¸šåŠ¡åº”ç”¨ï¼Œæ·»åŠ åŒå†™/è¯»å†™åˆ‡æ¢ åŠŸèƒ½ã€‚æ‰“å¼€åŒå†™ï¼Œ æ•°æ®åˆ†ç‰‡åè¿ç§»ä¼šéå¸¸éº»çƒ¦ï¼Œå»ºè®®åœ¨è®¾è®¡åˆ†ç‰‡è§„åˆ™æ—¶ï¼Œå°½é‡è€ƒè™‘åˆ°æœªæ¥çš„æ•°æ®å¢é•¿æƒ…å†µï¼Œé¿å…æ•°æ®è¿ç§»ï¼ˆé€‚å½“çš„å¢åŠ åˆ†ç‰‡æ•°,åˆ†ç‰‡é”®é¿å…äº§ç”Ÿæ•°æ®å€¾æ–œï¼‰ã€‚\n5. å¦‚ä½•ç¡®å®šå®é™…æ‰§è¡Œçš„SQLï¼Ÿ # ShardingSphere Proxy æä¾›äº† DistSQL æ“ä½œè¯­è¨€ï¼Œåˆ†ä¸ºï¼šRDLã€RQLã€RAL å’Œ RULï¼Œæè¿°å¦‚ä¸‹ï¼š\næ“ä½œè¯­è¨€ æè¿° RDL Resource \u0026amp; Rule Definition Languageï¼Œè´Ÿè´£èµ„æºå’Œè§„åˆ™çš„åˆ›å»ºã€ä¿®æ”¹å’Œåˆ é™¤ã€‚ RQL Resource \u0026amp; Rule Query Languageï¼Œè´Ÿè´£èµ„æºå’Œè§„åˆ™çš„æŸ¥è¯¢å’Œå±•ç°ã€‚ RAL Resource \u0026amp; Rule Administration Languageï¼Œè´Ÿè´£å¼ºåˆ¶è·¯ç”±ã€ç†”æ–­ã€é…ç½®å¯¼å…¥å¯¼å‡ºã€æ•°æ®è¿ç§»æ§åˆ¶ç­‰ç®¡ç†åŠŸèƒ½ã€‚ RUL Resource \u0026amp; Rule Utility Languageï¼Œè´Ÿè´£ SQL è§£æã€SQL æ ¼å¼åŒ–ã€æ‰§è¡Œè®¡åˆ’é¢„è§ˆç­‰åŠŸèƒ½ã€‚ å¦‚æœæˆ‘ä»¬è¦ç¡®å®šå®é™…æ‰§è¡Œçš„ SQL è¯­å¥ï¼Œå¯ä»¥é€šè¿‡ RUL æ“ä½œè¯­è¨€æ¥å®ç°ï¼Œå¦‚ä¸‹ï¼š\n-- é¢„è§ˆæ‰§è¡Œè®¡åˆ’ PREVIEW SELECT * FROM t_user WHERE user_id = 1; è¿™é‡Œæˆ‘ä»¬åˆ†åˆ«è¯•éªŒä¸‹ï¼Œä¸åŒçš„æŸ¥è¯¢æ¡ä»¶çš„å®é™…æ‰§è¡Œæœ‰ä»€ä¹ˆå¼‚åŒã€‚\nCREATE TABLE t_user ( id BIGINT NOT NULL comment \u0026#39;ä¸»é”®\u0026#39;, /* ä¸»é”® */ user_id BIGINT NOT NULL unique comment \u0026#39;ç”¨æˆ·ID\u0026#39;, /* ç”¨æˆ·ID, åˆ†è¡¨ key */ mch_id BIGINT NOT NULL comment \u0026#39;å•†æˆ·ID\u0026#39;, /* å•†æˆ·ID, åˆ†åº“ key */ PRIMARY KEY (user_id) ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4; 5.1. æŸ¥è¯¢æ¡ä»¶ä¸æ˜¯åˆ†ç‰‡é”® # å¯ä»¥å‘ç°å½“æŸ¥è¯¢æ¡ä»¶ä¸­æ²¡æœ‰åŒ…å«ä»»ä½•çš„åˆ†ç‰‡é”®æ—¶ï¼ŒShardingSphere Proxy ä¼šå°† SQL è¯­å¥å‘é€åˆ°æ‰€æœ‰çš„åˆ†ç‰‡èŠ‚ç‚¹ï¼ˆåˆ†åº“ \u0026amp; åˆ†è¡¨ï¼‰ä¸Šæ‰§è¡Œï¼Œç„¶åå°†ç»“æœåˆå¹¶è¿”å›ã€‚\n5.2. æŸ¥è¯¢æ¡ä»¶æ˜¯åˆ†ç‰‡é”®ï¼ˆåˆ†åº“é”®ï¼‰ # å½“æŸ¥è¯¢æ¡ä»¶ä¸­åŒ…å«åˆ†ç‰‡é”®ï¼ˆåˆ†åº“é”®ï¼‰æ—¶ï¼ŒShardingSphere Proxy ä¼šæ ¹æ®åˆ†ç‰‡é”®çš„å€¼ï¼Œå°† SQL è¯­å¥ç›´æ¥è·¯ç”±åˆ°å¯¹åº”çš„åˆ†åº“ä¸Šæ‰§è¡Œï¼Œä½†æ˜¯ä»ç„¶è¦èšåˆåˆ†è¡¨çš„ç»“æœã€‚\n5.3. æŸ¥è¯¢æ¡ä»¶æ˜¯åˆ†ç‰‡é”®ï¼ˆåˆ†è¡¨é”®ï¼‰ # å½“æŸ¥è¯¢æ¡ä»¶ä¸­åŒ…å«åˆ†ç‰‡é”®ï¼ˆåˆ†è¡¨é”®ï¼‰æ—¶ï¼ŒShardingSphere Proxy ä¼šæ ¹æ®åˆ†ç‰‡é”®çš„å€¼ï¼Œè¿˜éœ€è¦å°† SQL è¯­å¥è·¯ç”±åˆ°æ‰€æœ‰çš„åˆ†åº“ä¸Šæ‰§è¡Œï¼Œä½†æ˜¯åˆ†è¡¨å·²ç»ç¡®å®šæ‰€ä»¥ä¸éœ€è¦èšåˆåˆ†è¡¨çš„ç»“æœã€‚\n5.4. æŸ¥è¯¢æ¡ä»¶æ˜¯åˆ†ç‰‡é”®ï¼ˆåˆ†åº“é”®å’Œåˆ†è¡¨é”®ï¼‰ # å½“æŸ¥è¯¢æ¡ä»¶ä¸­åŒ…å«åˆ†ç‰‡é”®ï¼ˆåˆ†åº“é”®å’Œåˆ†è¡¨é”®ï¼‰æ—¶ï¼ŒShardingSphere Proxy ä¼šæ ¹æ®åˆ†ç‰‡é”®çš„å€¼ï¼Œå·²ç»èƒ½å‡†ç¡®çš„ç¡®å®šåˆ°åˆ†åº“å’Œåˆ†è¡¨ï¼Œæ‰€ä»¥ç›´æ¥å°† SQL è¯­å¥è·¯ç”±ç‰¹å®šçš„æ•°æ®åˆ†ç‰‡ä¸Šæ‰§è¡Œã€‚\nä»ä¸Šè¿°æµ‹è¯•ç»“æœï¼Œæµ‹è¯•äº† RUL ä¸­çš„ PREVIEW è¯­å¥ï¼Œå¯ä»¥çœ‹åˆ° ShardingSphere Proxy åœ¨æ‰§è¡Œ SQL æ—¶ï¼Œä¼šæ ¹æ® SQL ä¸­çš„æŸ¥è¯¢æ¡ä»¶ï¼Œå°† SQL è¯­å¥è·¯ç”±åˆ°ç‰¹å®šçš„æ•°æ®åˆ†ç‰‡ä¸Šæ‰§è¡Œï¼Œè¿™æ ·å¯ä»¥å‡å°‘ä¸å¿…è¦çš„æ•°æ®ä¼ è¾“å’Œè®¡ç®—ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚åŒæ—¶ä¹Ÿæé†’æˆ‘ä»¬åœ¨ä½¿ç”¨åˆ†åº“åˆ†è¡¨æ—¶ï¼Œéœ€è¦é€‰æ‹©åˆç†çš„åˆ†ç‰‡é”®ï¼Œä»¥æé«˜æŸ¥è¯¢æ•ˆç‡ã€‚åœ¨ç¼–å†™ SQL æ—¶ï¼Œä¹Ÿè¦å°½é‡åŒ…å«åˆ†ç‰‡é”®ï¼Œä»¥å‡å°‘ä¸å¿…è¦çš„æ•°æ®ä¼ è¾“å’Œè®¡ç®—ã€‚\n6. åˆ†åº“åˆ†è¡¨åæ€ä¹ˆä¼˜åŒ–æŸ¥è¯¢ï¼Ÿ # æƒ³è¦ä¼˜åŒ– Shardingsphere Proxy çš„æŸ¥è¯¢ï¼Œé¦–å…ˆè¦äº†è§£ Shardingsphere Proxy çš„æŸ¥è¯¢è¿‡ç¨‹ã€‚Shardingsphere Proxy çš„æŸ¥è¯¢è¿‡ç¨‹å¦‚ä¸‹ï¼š\nå®¢æˆ·ç«¯å‘é€ SQL è¯­å¥åˆ° Shardingsphere Proxyã€‚ Shardingsphere Proxy è§£æ SQL è¯­å¥ï¼Œæ ¹æ® SQL è¯­å¥ä¸­çš„åˆ†ç‰‡é”®ï¼Œå°† SQL è¯­å¥è·¯ç”±åˆ°ç‰¹å®šçš„æ•°æ®åˆ†ç‰‡ä¸Šæ‰§è¡Œã€‚ æ•°æ®åˆ†ç‰‡æ‰§è¡Œ SQL è¯­å¥ï¼Œè¿”å›ç»“æœã€‚ Shardingsphere Proxy å°†ç»“æœèšåˆè¿”å›ç»™å®¢æˆ·ç«¯ã€‚ å…¶ä¸­ç¬¬äºŒæ­¥æ˜¯æœ€é‡è¦çš„ä¸€æ­¥ï¼ŒShardingsphere Proxy ä¼šæ ¹æ® SQL è¯­å¥ä¸­çš„åˆ†ç‰‡é”®ï¼Œå°† SQL è¯­å¥è·¯ç”±åˆ°ç‰¹å®šçš„æ•°æ®åˆ†ç‰‡ä¸Šæ‰§è¡Œã€‚é€šè¿‡å‰é¢äº”ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¹Ÿå·²ç»çŸ¥é“äº†ä½¿ç”¨ RUL å»åˆ†æ SQL çš„å®é™…æ‰§è¡Œè®¡åˆ’ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥çŸ¥é“ SQL è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„ã€‚æˆ‘ä»¬èƒ½å‘ç°åˆ†ç‰‡é”®åœ¨æŸ¥è¯¢ä¸­ä¼šç›´æ¥å½±å“åˆ° SQL çš„æ‰§è¡Œè®¡åˆ’ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆç†çš„ä½¿ç”¨åˆ†ç‰‡é”®æ¥ä¼˜åŒ–æŸ¥è¯¢ã€‚\n6.1 Shardingsphere Proxy è·¯ç”±ç­–ç•¥ # è¿™é‡Œé’ˆå¯¹ Shardingsphere Proxy è·¯ç”±å¼•æ“å±•å¼€ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä»ç¬¬äº”ä¸ªé—®é¢˜åªèƒ½çŸ¥é“å¸¦ä¸å¸¦åˆ†ç‰‡é”®ä¼šå½±å“åˆ° SQL çš„æ‰§è¡Œè®¡åˆ’ï¼Œä½†æ˜¯å…·ä½“çš„è·¯ç”±å¼•æ“æ˜¯æ€ä¹ˆè·¯ç”±çš„å‘¢ï¼Ÿå‚è§ä¸‹å›¾ï¼š\nhttps://shardingsphere.apache.org/document/5.1.1/cn/reference/sharding/route/\nè·¯ç”±ç­–ç•¥ åˆ†ç±» æè¿° ç›´æ¥è·¯ç”± åˆ†ç‰‡è·¯ç”± ç›´æ¥è·¯ç”±åˆ°ç‰¹å®šçš„æ•°æ®åˆ†ç‰‡ä¸Šæ‰§è¡Œã€‚å¦‚ï¼šhintManager.setDatabaseShardingValue(3); æ ‡å‡†è·¯ç”± åˆ†ç‰‡è·¯ç”± ä¸åŒ…å«å…³è”æŸ¥è¯¢æˆ–ä»…åŒ…å«ç»‘å®šè¡¨ä¹‹é—´å…³è”æŸ¥è¯¢çš„ SQLï¼Œå½“åˆ†ç‰‡è¿ç®—ç¬¦æ˜¯ç­‰äºå·æ—¶ï¼Œè·¯ç”±ç»“æœå°†è½å…¥å•åº“ï¼ˆè¡¨ï¼‰ï¼Œå½“åˆ†ç‰‡è¿ç®—ç¬¦æ˜¯ BETWEEN æˆ– IN æ—¶ï¼Œåˆ™è·¯ç”±ç»“æœä¸ä¸€å®šè½å…¥å”¯ä¸€çš„åº“ï¼ˆè¡¨ï¼‰ã€‚ ç¬›å¡å°”è·¯ç”± åˆ†ç‰‡è·¯ç”± æ— æ³•å®šä½åˆ†ç‰‡è§„åˆ™ï¼Œè¡¨ä¹‹é—´çš„å…³è”æŸ¥è¯¢éœ€è¦æ‹†è§£ä¸ºç¬›å¡å°”ç§¯ç»„åˆæ‰§è¡Œã€‚å¦‚åæ–‡ä¸­çš„ order å’Œ order_item è¡¨çš„å…³è”æŸ¥è¯¢ ã€‚ å…¨åº“è·¯ç”± å¹¿æ’­è·¯ç”± å…¨åº“è·¯ç”±ç”¨äºå¤„ç†å¯¹æ•°æ®åº“çš„æ“ä½œï¼ŒåŒ…æ‹¬ç”¨äºåº“è®¾ç½®çš„ SET ç±»å‹çš„æ•°æ®åº“ç®¡ç†å‘½ä»¤ï¼Œä»¥åŠ TCL è¿™æ ·çš„äº‹åŠ¡æ§åˆ¶è¯­å¥ã€‚å¦‚ï¼šSET autocommit=0; å…¨åº“è¡¨è·¯ç”± å¹¿æ’­è·¯ç”± å…¨åº“è¡¨è·¯ç”±ç”¨äºå¤„ç†å¯¹æ•°æ®åº“ä¸­ä¸å…¶é€»è¾‘è¡¨ç›¸å…³çš„æ‰€æœ‰çœŸå®è¡¨çš„æ“ä½œï¼Œä¸»è¦åŒ…æ‹¬ä¸å¸¦åˆ†ç‰‡é”®çš„ DQL å’Œ DMLï¼Œä»¥åŠ DDL ç­‰ã€‚å¦‚ SELECT * FROM t_order WHERE good_prority IN (1, 10); å…¨å®ä¾‹è·¯ç”± å¹¿æ’­è·¯ç”± å…¨å®ä¾‹è·¯ç”±ç”¨äº DCL æ“ä½œï¼Œæˆæƒè¯­å¥é’ˆå¯¹çš„æ˜¯æ•°æ®åº“çš„å®ä¾‹ã€‚ä¾‹å¦‚ï¼šCREATE USER customer@127.0.0.1 identified BY '123'; å•æ’­è·¯ç”± å¹¿æ’­è·¯ç”± å•æ’­è·¯ç”±ç”¨äºè·å–æŸä¸€çœŸå®è¡¨ä¿¡æ¯çš„åœºæ™¯ï¼Œå®ƒä»…éœ€è¦ä»ä»»æ„åº“ä¸­çš„ä»»æ„çœŸå®è¡¨ä¸­è·å–æ•°æ®å³å¯ã€‚ä¾‹å¦‚ï¼šDESCRIBE t_order é˜»æ–­è·¯ç”± å¹¿æ’­è·¯ç”± é˜»æ–­è·¯ç”±ç”¨äºå±è”½ SQL å¯¹æ•°æ®åº“çš„æ“ä½œï¼Œä¾‹å¦‚ï¼šUSE order_db; ä¸ä¼šåœ¨çœŸå®æ•°æ®åº“ä¸­æ‰§è¡Œã€‚ 6.2 ç»‘å®šè¡¨ # https://shardingsphere.apache.org/document/current/cn/features/sharding/concept/#%E7%BB%91%E5%AE%9A%E8%A1%A8\næŒ‡åˆ†ç‰‡è§„åˆ™ä¸€è‡´çš„ä¸€ç»„åˆ†ç‰‡è¡¨ã€‚ ä¾‹å¦‚ï¼št_orderè¡¨å’Œt_order_itemè¡¨ï¼Œå‡æŒ‰ç…§order_idåˆ†ç‰‡ï¼Œåˆ™æ­¤ä¸¤å¼ è¡¨äº’ä¸ºç»‘å®šè¡¨å…³ç³»ã€‚ç»‘å®šè¡¨ä¹‹é—´çš„å¤šè¡¨å…³è”æŸ¥è¯¢ä¸ä¼šå‡ºç°ç¬›å¡å°”ç§¯å…³è”ï¼Œå…³è”æŸ¥è¯¢æ•ˆç‡å°†å¤§å¤§æå‡ã€‚ä¸¾ä¾‹è¯´æ˜ï¼Œå¦‚æœSQLä¸ºï¼š\nSELECT i.* FROM t_order o JOIN t_order_item i ON o.order_id=i.order_id WHERE o.order_id in (10, 11); åœ¨ä¸é…ç½®ç»‘å®šè¡¨å…³ç³»æ—¶ï¼Œå‡è®¾åˆ†ç‰‡é”®order_idå°†æ•°å€¼10è·¯ç”±è‡³ç¬¬0ç‰‡ï¼Œå°†æ•°å€¼11è·¯ç”±è‡³ç¬¬1ç‰‡ï¼Œé‚£ä¹ˆè·¯ç”±åçš„SQLåº”è¯¥ä¸º4æ¡ï¼Œå®ƒä»¬å‘ˆç°ä¸ºç¬›å¡å°”ç§¯ï¼š\nSELECT i.* FROM t_order_0 o JOIN t_order_item_0 i ON o.order_id=i.order_id WHERE o.order_id in (10, 11); SELECT i.* FROM t_order_0 o JOIN t_order_item_1 i ON o.order_id=i.order_id WHERE o.order_id in (10, 11); SELECT i.* FROM t_order_1 o JOIN t_order_item_0 i ON o.order_id=i.order_id WHERE o.order_id in (10, 11); SELECT i.* FROM t_order_1 o JOIN t_order_item_1 i ON o.order_id=i.order_id WHERE o.order_id in (10, 11); å¦‚æœé…ç½®äº†ç»‘å®šè¡¨å…³ç³»ï¼Œé‚£ä¹ˆè·¯ç”±åçš„SQLåº”è¯¥ä¸º2æ¡ï¼Œå®ƒä»¬ä¸å†å‘ˆç°ä¸ºç¬›å¡å°”ç§¯ï¼š\nSELECT i.* FROM t_order_0 o JOIN t_order_item_0 i ON o.order_id=i.order_id WHERE o.order_id in (10, 11); SELECT i.* FROM t_order_1 o JOIN t_order_item_1 i ON o.order_id=i.order_id WHERE o.order_id in (10, 11); ç»‘å®šè¡¨é…ç½®éœ€è¦åœ¨ ShardingSphere Proxy çš„é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œå¦‚ä¸‹ï¼š\nrules: - !SHARDING tables: t_order: actualDataNodes: ds_${0..1}.t_order_${0..1} t_order_item: actualDataNodes: ds_${0..1}.t_order_item_${0..1} bindingTables: # ç»‘å®šè¡¨é…ç½® - t_order, t_order_item 6.3 å¹¿æ’­è¡¨ # https://shardingsphere.apache.org/document/5.4.1/cn/user-manual/shardingsphere-jdbc/yaml-config/rules/broadcast/\næŒ‡æ‰€æœ‰çš„åˆ†ç‰‡æ•°æ®æºä¸­éƒ½å­˜åœ¨çš„è¡¨ï¼Œè¡¨ç»“æ„å’Œè¡¨ä¸­çš„æ•°æ®åœ¨æ¯ä¸ªæ•°æ®åº“ä¸­å‡å®Œå…¨ä¸€è‡´ã€‚é€‚ç”¨äºæ•°æ®é‡ä¸å¤§ä¸”éœ€è¦ä¸æµ·é‡æ•°æ®çš„è¡¨è¿›è¡Œå…³è”æŸ¥è¯¢çš„åœºæ™¯ï¼Œä¾‹å¦‚ï¼šå­—å…¸è¡¨ã€‚\nå¹¿æ’­è¡¨é…ç½®éœ€è¦åœ¨ ShardingSphere Proxy çš„é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œå¦‚ä¸‹ï¼š\nrules: - !BROADCAST tables: # å¹¿æ’­è¡¨è§„åˆ™åˆ—è¡¨ - t_country - t_address å¹¿æ’­è¡¨æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\næ’å…¥ã€æ›´æ–°æ“ä½œä¼šå®æ—¶åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œä¿æŒå„ä¸ªåˆ†ç‰‡çš„æ•°æ®ä¸€è‡´æ€§ æŸ¥è¯¢æ“ä½œï¼Œåªä»ä¸€ä¸ªèŠ‚ç‚¹è·å– å¯ä»¥è·Ÿä»»ä½•ä¸€ä¸ªè¡¨è¿›è¡Œ JOIN æ“ä½œ 6.4 æ€»ç»“ # é€šè¿‡å‰é¢çš„åˆ†æï¼Œæˆ‘ä»¬å¤§è‡´å¯ä»¥å¾—å‡ºä»¥ä¸‹å‡ ä¸ªä¼˜åŒ–æŸ¥è¯¢çš„æ–¹æ³•ï¼š\nåˆç†é€‰æ‹©å’Œä½¿ç”¨åˆ†ç‰‡é”®ï¼Œè®© SQL èƒ½å¤Ÿè¢«è·¯ç”±åˆ°ç‰¹å®šçš„æ•°æ®åˆ†ç‰‡ä¸Šæ‰§è¡Œï¼Œé¿å…æ•°æ®èšåˆå’Œç¬›å¡å°”ç§¯ã€‚ å¯ä»¥é€šè¿‡é…ç½®ç»‘å®šè¡¨æ¥é¿å…ç¬›å¡å°”ç§¯ã€‚ åŒæ ·çš„ï¼Œåˆç†çš„è¯†åˆ«å¹¶è®¾ç½®å¹¿æ’­è¡¨ï¼Œå¯ä»¥æé«˜æŸ¥è¯¢æ•ˆç‡ï¼ˆé¿å…è·¨ åº“/å®ä¾‹ï¼‰ã€‚ é€šè¿‡ DistSQL çš„ PREVIEW è¯­å¥ï¼Œå¯ä»¥é¢„è§ˆ SQL çš„æ‰§è¡Œè®¡åˆ’ï¼Œä»è€Œä¼˜åŒ– SQLã€‚ åœ¨ç¼–å†™é’ˆå¯¹æ•°æ®åˆ†ç‰‡çš„ SQL æ—¶ï¼Œè™½ç„¶ ShardingSphere Proxy èƒ½åšåˆ°å¤§éƒ¨åˆ†åœºæ™¯çš„é€æ˜åŒ–ï¼Œä½†æˆ‘ä»¬è¿˜æ˜¯éœ€è¦æ¸…æ™°çš„äº†è§£å…¶è·¯ç”±ç­–ç•¥å’Œæ‰§è¡Œæ–¹å¼ï¼Œè¿™æ ·æ‰èƒ½äº†ç„¶äºå¿ƒï¼Œé’ˆå¯¹æ€§çš„ç¼–å†™ SQLï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚\næ€»ç»“ # å½“æˆ‘ä»¬é€‰æ‹©åˆ†åº“åˆ†è¡¨çš„æ–¹æ¡ˆæ—¶ï¼Œæˆ‘ä»¬éœ€è¦å†³å®š åˆ†ç‰‡çš„é‡ï¼Œåˆ†ç‰‡çš„ç®—æ³•å’Œåˆ†ç‰‡é”®ï¼Œè€Œè¿™ä¸€åˆ‡éƒ½åŸºäºæˆ‘ä»¬å¯¹ä¸šåŠ¡çš„ç†è§£å’Œå¯¹åˆ†åº“åˆ†è¡¨çš„è®¤çŸ¥ã€‚è€Œæœ€ç»ˆå†³å®šè¿™ä¸€åˆ‡çš„éƒ½æ˜¯ä¸šåŠ¡çš„éœ€æ±‚ã€‚åœ¨å†³ç­–æ—¶ï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦è€ƒè™‘æ•°æ®åˆ†ç‰‡åæ˜¯å¦ä¼šå‡ºç°ï¼šåˆ†å¸ƒä¸å‡åŒ€ï¼Œå‡ºç°çƒ­ç‚¹æ•°æ®ï¼Ÿ åˆ†ç‰‡ç®—æ³•æ‰©å±•æ€§ä¸è¶³ï¼Œå¯¼è‡´æ‰©å±•æ—¶éœ€è¦æ•°æ®è¿ç§»ï¼Ÿ æ•°æ®åˆ†ç‰‡é”®é€‰æ‹©ä¸åˆç†ï¼Œä¸ç¬¦åˆä¸šåŠ¡ä¸­çš„æŸ¥è¯¢æ¨¡å¼ï¼Œå½±å“æŸ¥è¯¢æ€§èƒ½ï¼Ÿ\nåˆ†åº“åˆ†è¡¨ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œä¹Ÿä¸æ˜¯å®Œå…¨æ— æŸçš„ã€‚åˆ†åº“ä¹‹åä¸€å®šä¼šå¸¦æ¥çš„é—®é¢˜æ˜¯ï¼šäº‹åŠ¡ï¼›join æŸ¥è¯¢ï¼›æ’åºï¼›åˆ†é¡µï¼›group åˆ†ç»„ï¼›æ‰€ä»¥å†³å®šåˆ†ç‰‡å‰ä¸€å®šè¦ç»“åˆä¸šåŠ¡åˆ†æèƒ½ä¸èƒ½åˆ†ç‰‡ã€‚\nå‚è€ƒ # https://www.cnblogs.com/chengxy-nds/p/18097298 https://shardingsphere.apache.org/document/current/en/overview/ "},{"id":13,"href":"/2024/03/25/istio-idle-timeout%E9%97%AE%E9%A2%98%E5%A4%8D%E7%8E%B0%E5%92%8C%E8%A7%A3%E5%86%B3/","title":"Istio Idle Timeouté—®é¢˜å¤ç°å’Œè§£å†³","section":"Posts","content":" æ›´æ–° # æ›´æ–° 2024-04-01 # é€šè¿‡è°ƒæ•´ tcp_proxy çš„ idle_timeout å‚æ•°åï¼Œéƒ¨åˆ†ä¸­é—´ä»¶ï¼ˆredis, mongoï¼‰çš„å¼‚å¸¸é—®é¢˜ä¸å†å‡ºç°ï¼Œä½†æ˜¯ mysql(sharding-spere) å’Œ memcached ä»ç„¶å­˜åœ¨ \u0026ldquo;invalid connection\u0026rdquo; é”™è¯¯ï¼Œæ‰€ä»¥è¿˜éœ€è¦æ‰¾åˆ°èƒ½å¤Ÿè§£å†³ mysql(sharding-spere) å’Œ memcached çš„æ–¹æ³•ã€‚\nä¸Šè¿°æè¿°çš„ç°è±¡éå¸¸ä¸»è§‚ï¼Œä¸ä¸€å®šæ­£ç¡®ä¹Ÿä¸èƒ½ä½œä¸ºæœ€ç»ˆç»“è®ºï¼Œä½†æ˜¯ idle_timeout é…ç½®ç¡®å®æ²¡æœ‰è§£å†³æ‰€æœ‰çš„é—®é¢˜ã€‚\nè¿™é‡Œï¼Œéœ€è¦çŸ¥é“ istio åœ¨ inject æ—¶ä¼šé€šè¿‡ iptables å¯¹åº”ç”¨çš„æµé‡è¿›è¡ŒåŠ«æŒï¼Œå¯¹äº outbound çš„æµé‡ iptables è§„åˆ™æ‹¦æˆªè½¬å‘åˆ° OUTPUT é“¾ã€‚OUTPUT çš„é“¾è½¬å‘æµé‡åˆ° ISTIO_OUTPUTï¼Œè¿™ä¸ªé“¾ä¼šå†³å®šæœåŠ¡è®¿é—®å¤–éƒ¨æœåŠ¡çš„æµé‡å‘å¾€ä½•å¤„ã€‚\nè¿™æ ·äº§ç”Ÿçš„æ•ˆæœæ˜¯ï¼Œé™¤äº†åº”ç”¨è‡ªå·±å»ºç«‹çš„è¿æ¥ä¹‹å¤– envoy ä¹Ÿä¼šåˆ›å»ºä¸€ä¸ªä»£ç†è¿æ¥ã€‚\n$ netstat -notp | grep 3307 tcp 0 172.23.105.25:41030 x.x.x.x:3307 ESTABLISHED - off(0.00/0/0) tcp 0 172.23.105.25:41022 x.x.x.x:3307 ESTABLISHED 1/./app keepalive(0.88/0/0) æˆ‘é‡åˆ°çš„é—®é¢˜å¯ä»¥ç¡®å®šé—®é¢˜å°±å‡ºåœ¨ envoy å»ºç«‹çš„è¿æ¥ä¸Šï¼Œå› ä¸ºåº”ç”¨è‡ªå·±å»ºç«‹çš„è¿æ¥æ˜¯æ­£å¸¸çš„ï¼ŒåŒæ—¶è¿˜å¯ä»¥çœ‹åˆ°åº”ç”¨è‡ªå·±çš„è¿æ¥å¼€å¯äº† keepalive, è€Œ envoy å»ºç«‹çš„è¿æ¥æ²¡æœ‰å¼€å¯ã€‚è¿™æ ·å¯èƒ½ä¼šå‡ºç°è¿™ä¸ªè¿æ¥ä¼šå› ä¸ºè¶…æ—¶è€Œè¢«å…³é—­çš„æƒ…å†µï¼Œæˆ–è€…å…¶ä»–åŸå› å¯¼è‡´è¿æ¥è¢«é‡Šæ”¾ã€‚é‚£å¦‚æœå¯ä»¥é¿å…å°†ä¸­é—´ä»¶çš„æµé‡é€šè¿‡ envoy ä»£ç†ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜ã€‚\nåœ¨å®˜æ–¹çš„æ–‡æ¡£ä¸­ä¹Ÿæåˆ°ï¼Œhttps://istio.io/latest/zh/docs/tasks/traffic-management/egress/egress-control/ å¯¹äºå¤–éƒ¨æœåŠ¡ï¼Œå¯ä»¥é€šè¿‡é…ç½® excludeOutboundPorts æˆ–è€… excludeOutboundIPRanges æ¥ä½¿å¾—æŸäº›æœåŠ¡çš„æµé‡ä¸ç»è¿‡ istio sidecarã€‚å…¶èƒŒåçš„åŸç†æ˜¯é€šè¿‡ iptables çš„è§„åˆ™ä¸­æ’é™¤è¿™äº›ç«¯å£æˆ–è€… IP åœ°å€ã€‚\nç»è¿‡å®éªŒï¼Œå‘ç°è¿™ä¸ªæ–¹æ³•å¯ä»¥ è§£å†³ï¼ˆç»•è¿‡ï¼‰è¿™ä¸ªé—®é¢˜ã€‚è¿˜æ˜¯æ²¡æœ‰å®šä½åˆ° envoy ä»£ç†è¿‡ç¨‹ä¸­å‘ç”Ÿäº†ä»€ä¹ˆå¯¼è‡´è¿æ¥è¢«å…³é—­çš„åŸå› ï¼Œè¿™ä¸ªé—®é¢˜è¿˜éœ€è¦è¿›ä¸€æ­¥çš„åˆ†æã€‚\né—®é¢˜æè¿° # åœ¨ kubernetes é›†ç¾¤ä¸­ä½¿ç”¨ istio æ—¶ï¼Œå¼€å‘åŒå­¦åé¦ˆç»å¸¸ä¼šå‡ºç° â€œinvalid connectionâ€ é”™è¯¯ï¼Œå¯¼è‡´ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼Œè€Œåœ¨æ²¡æœ‰ä½¿ç”¨ istio çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªé—®é¢˜å¹¶ä¸ä¼šå‡ºç°ã€‚é€šè¿‡æŸ¥çœ‹æ—¥å¿—ï¼Œå‘ç°è¿™ç§é”™è¯¯å¸¸å‘ç”Ÿåœ¨é›†ç¾¤å¤–çš„æœåŠ¡è¿æ¥ï¼Œå¦‚ï¼šmemcachedã€redis, mysql, mongodb ç­‰ã€‚\né€šè¿‡ä¸Šè¿°çš„æè¿°ï¼Œé¦–å…ˆæ€€ç–‘çš„æ˜¯ istio çš„ sidecar ä»£ç†å¯¼è‡´çš„é—®é¢˜ï¼Œå› ä¸ºè¿™ç§é”™è¯¯åªæœ‰åœ¨ä½¿ç”¨ istio æ—¶æ‰ä¼šå‡ºç°ã€‚\nIstio å’Œ envoy çš„åŸºæœ¬æ¦‚å¿µ # Istio æœåŠ¡ç½‘æ ¼ä»é€»è¾‘ä¸Šåˆ†ä¸ºæ•°æ®é¢å’Œæ§åˆ¶é¢ï¼Œå…¶ä¸­æ•°æ®é¢ç”± Envoy ä»£ç†ç»„æˆï¼Œæ§åˆ¶é¢ç”± Pilotã€Citadelã€Galley ç­‰ç»„ä»¶ç»„æˆã€‚æ•°æ®é¢æ˜¯ç”± Envoy ä»£ç†ç»„æˆçš„ï¼Œè´Ÿè´£å®é™…çš„æµé‡ä»£ç†å’Œæ§åˆ¶ã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬åœ¨ kubernetes é›†ç¾¤ä¸­éƒ¨ç½²äº† istio æ—¶ï¼Œæ¯ä¸ª pod éƒ½ä¼šæœ‰ä¸€ä¸ª sidecar å®¹å™¨ï¼Œè¿™ä¸ªå®¹å™¨ä¸­å°±åŒ…å«äº† Envoy ä»£ç†ï¼Œä¼šåŠ«æŒ pod ä¸­çš„æ‰€æœ‰æµé‡ã€‚å†å›åˆ°ä¸Šé¢çš„é—®é¢˜ï¼Œåœ¨æ²¡æœ‰è¿™ä¸ªä»£ç†çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªé—®é¢˜å¹¶ä¸ä¼šå‡ºç°ï¼Œæ‰€ä»¥è¿™ä¸ªé—®é¢˜å¾ˆæœ‰å¯èƒ½æ˜¯ç”± Envoy ä»£ç†å¯¼è‡´çš„ã€‚\nçŒœæµ‹é—®é¢˜åŸå›  # æ•°æ®åº“è¿æ¥è¶…æ—¶ # è¿™é‡Œä½¿ç”¨çš„å¼€å‘è¯­è¨€ä¸º goï¼Œ\u0026ldquo;invalid connection\u0026rdquo; é”™è¯¯å¾€å¾€å‘ç”Ÿåœ¨â€œè¿æ¥è¶…æ—¶â€çš„æƒ…å†µä¸‹ï¼ˆè¿æ¥è¢«æœåŠ¡ç«¯å•æ–¹é¢å…³é—­ï¼Œè€Œå®¢æˆ·ç«¯è¿˜åœ¨ä½¿ç”¨ï¼‰ã€‚åœ¨æ•°æ®åº“è¿æ¥åœºæ™¯ä¸­ï¼Œå¾€å¾€è¿˜ä¼šæœ‰â€œè¿æ¥æ± â€è¿™ä¸ªæ¦‚å¿µï¼Œè¿æ¥æ± ä¼šåœ¨è¿æ¥ç©ºé—²ä¸€æ®µæ—¶é—´åå…³é—­è¿æ¥ï¼Œä¸æ­¤åŒæ—¶æœåŠ¡ç«¯ä¹Ÿä¼šè®¾ç½®ç›¸åº”çš„è¶…æ—¶æ—¶é—´ï¼Œå½“è¿æ¥ç©ºé—²æ—¶é—´è¶…è¿‡è¿™ä¸ªæ—¶é—´æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šä¸»åŠ¨å…³é—­è¿æ¥ã€‚\nå¦‚ï¼š\nmysql çš„ wait_timeout å‚æ•°ï¼Œå½“è¿æ¥ç©ºé—²æ—¶é—´è¶…è¿‡è¿™ä¸ªæ—¶é—´æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šä¸»åŠ¨å…³é—­è¿æ¥ã€‚ mongodb çš„ maxIdleTimeMS å‚æ•°ï¼Œè¿æ¥åœ¨æ± ä¸­å¯ä¿æŒç©ºé—²çŠ¶æ€çš„æœ€å¤§æ¯«ç§’æ•°ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´åï¼Œè¿æ¥ä¼šè¢«åˆ é™¤æˆ–å…³é—­ã€‚ åœ¨å¤–éƒ¨æ²¡æœ‰ä»£ç†çš„æƒ…å†µæ—¶ï¼Œå¦‚æœå‡ºç° â€œinvalid connectionâ€ é”™è¯¯ï¼Œå¾ˆæœ‰å¯èƒ½æ˜¯ç”±äºè¿æ¥è¶…æ—¶å¯¼è‡´çš„ã€‚å¯ä»¥æ£€æŸ¥ä¸‹å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„è¿æ¥è¶…æ—¶æ—¶é—´æ˜¯å¦åˆç†è®¾ç½®äº†ï¼ˆæœåŠ¡ç«¯çš„è¶…æ—¶æ—¶é—´è¦å¤§äºå®¢æˆ·ç«¯çš„è¶…æ—¶æ—¶é—´ï¼‰ã€‚\nenvoy å…³é—­è¿æ¥ # æ ¹æ®ä¸Šé¢çš„æè¿°ï¼Œæˆ‘ä»¬å¯ä»¥çŒœæµ‹è¿™ä¸ªé—®é¢˜æ˜¯ç”±äº Envoy ä»£ç†äº§ç”Ÿçš„ï¼Œé‚£ä¹ˆç»è¿‡åœ¨ç½‘ä¸ŠæŸ¥æ‰¾èµ„æ–™ï¼Œå‘ç°è¿™ä¸ªé—®é¢˜å¯èƒ½æ˜¯ç”±äº Envoy çš„ tcp_idle_timeout å¯¼è‡´çš„ã€‚\nhttps://github.com/istio/istio/issues/24387\nhttps://www.envoyproxy.io/docs/envoy/latest/faq/configuration/timeouts#tcp\nThe TCP proxy idle_timeout is the amount of time that the TCP proxy will allow a connection to exist with no upstream or downstream activity. The default idle timeout if not otherwise specified is 1 hour.\nTCP ä»£ç†ç©ºé—²è¶…æ—¶æ˜¯ TCP ä»£ç†å…è®¸è¿æ¥åœ¨æ²¡æœ‰ä¸Šæ¸¸æˆ–ä¸‹æ¸¸æ´»åŠ¨çš„æƒ…å†µä¸‹å­˜åœ¨çš„æ—¶é—´é‡ã€‚å¦‚æœæ²¡æœ‰å¦å¤–æŒ‡å®šï¼Œé»˜è®¤ç©ºé—²è¶…æ—¶ä¸º 1 å°æ—¶ã€‚\nhttps://stackoverflow.com/questions/63843610/istio-proxy-closing-long-running-tcp-connection-after-1-hour\né‚£æ˜¯ä¸æ˜¯ enovy å…³é—­äº†è¿æ¥ï¼Œå¯¼è‡´äº†è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿä¸‹é¢ï¼Œæˆ‘ä»¬å°†é€šè¿‡è®¾è®¡ä¸€ä¸ªç®€å•çš„å¤ç°åœºæ™¯æ¥éªŒè¯è¿™ä¸ªé—®é¢˜ã€‚\nè®¾è®¡å¤ç° # å‡†å¤‡ä¸€ä¸ª k8s é›†ç¾¤ ,å¹¶å®‰è£…å¥½ istio åœ¨é›†ç¾¤å¤–éƒ¨ç½²ä¸€ä¸ª redis æœåŠ¡ è®¾ç½®ä¸€ä¸ªè¾ƒå°çš„ tcp idle timeout å‚æ•°ï¼ˆ10sï¼‰ï¼Œä¾¿äºè§‚å¯Ÿ åœ¨é›†ç¾¤å†…éƒ¨ç½²ä¸€ä¸ªä¸¤ä¸ª POD, ä¸€ä¸ªæ¥å…¥ istioï¼Œä¸€ä¸ªä¸æ¥å…¥ istioï¼ˆä¸¤ä¸ª POD éƒ½é€šè¿‡ telnet è¿æ¥ redis æœåŠ¡ï¼‰ è°ƒæ•´ istio çš„ tcp_idle_timeout å‚æ•°ï¼Œè§‚å¯Ÿè¿æ¥æƒ…å†µ ä½¿ç”¨åˆ°çš„ç›¸å…³æ–‡ä»¶å‚è§ https://github.com/yeqown/playground/tree/master/k8s/istio-idle-timeout\nEnovyFilter ä¿®æ”¹ tcp_idle_timeout å‚æ•° kubectl apply -f envoyfilter-10s.yaml éƒ¨ç½² POD kubectl create ns istio-idle-timeout \u0026amp;\u0026amp; kubectl label ns istio-idle-timeout istio-injection=enabled # éƒ¨ç½²æ²¡æœ‰ istio çš„ POD kubectl apply -f deployment.yaml -n default # éƒ¨ç½²æœ‰ istio çš„ POD kubectl apply -f deployment.yaml -n istio-idle-timeout è¿æ¥å¤–éƒ¨ redis æœåŠ¡ åœ¨æœ¬åœ°é€šè¿‡ minikube å¯åŠ¨ k8s é›†ç¾¤ï¼Œå¹¶ä¸”åœ¨æœ¬æœºéƒ¨ç½²ä¸€ä¸ª redis æœåŠ¡ã€‚\ntime telnet host.minikube.internal 3306 è§‚å¯Ÿå¹¶é…ç½®è°ƒæ•´ # æ²¡æœ‰ istio sidecar çš„ POD, è¿æ¥ä¸ä¼šæ–­å¼€ã€‚ æœ‰ istio sidecar çš„ POD, 10s åè¿æ¥ä¼šæ–­å¼€ã€‚ / # time telnet 192.168.105.1 6379 Connected to 192.168.105.1 Connection closed by foreign host Command exited with non-zero status 1 real\t0m 10.00s user\t0m 0.00s sys\t0m 0.00s æ¸…é™¤ idle_timeout å‚æ•° # kubectl delete -f envoyfilter-remove.yaml é‡æ–°è¿æ¥åˆ° redis ï¼Œè§‚å¯Ÿè¿æ¥æƒ…å†µã€‚\n/ # time telnet 192.168.105.1 6379 Connected to 192.168.105.1 Connection closed by foreign host Command exited with non-zero status 1 real\t1h 0m 00s user\t0m 0.00s sys\t0m 0.00s æ€»ç»“ # enovy çš„ tcp_idle_timeout å‚æ•°é»˜è®¤ä¸º 1hï¼Œè¿™ä¸ªå‚æ•°ä¼šå¯¼è‡´ä¸€äº›è¿æ¥è¶…æ—¶çš„é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ istio EnvoyFilter æ¥è°ƒæ•´è¿™ä¸ªå‚æ•°ã€‚\napiVersion: networking.istio.io/v1alpha3 kind: EnvoyFilter metadata: name: idle-timeout namespace: istio-system spec: configPatches: - applyTo: NETWORK_FILTER match: context: SIDECAR_OUTBOUND listener: filterChain: filter: name: envoy.filters.network.tcp_proxy patch: operation: MERGE value: name: envoy.filters.network.tcp_proxy typed_config: \u0026#34;@type\u0026#34;: type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy idle_timeout: 10s éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„ envov filter æ˜¯ä½œç”¨åœ¨ sidecar çš„ outbound ä¸Šçš„ï¼Œæ‰€ä»¥åªä¼šå½±å“ sidecar ä»£ç†çš„è¿æ¥ã€‚ä½†æ˜¯ envoy è¿˜ä¼šä½œä¸º ingress å’Œ egress çš„ä»£ç†ï¼Œè¿™ä¸ªå‚æ•°ä¸ä¼šå½±å“åˆ°è¿™ä¸¤ä¸ªåœºæ™¯ã€‚\nè§£å†³ # çŸ¥é“ envoy çš„ tcp_idle_timeout å‚æ•°çš„å½±å“åï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡è°ƒå¤§è¿™ä¸ªå‚æ•°æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æ¯”å¦‚è®¾ç½®ä¸ºæ¯”å®¢æˆ·ç«¯è¶…æ—¶æ—¶é—´æ›´å¤§çš„å€¼ï¼Œæ¯”æœåŠ¡ç«¯è¶…æ—¶æ—¶é—´æ›´å¤§çš„å€¼ã€‚\nå…¶ä»– # å¯èƒ½ç›¸å…³çš„æ—¥å¿—è¾“å‡º # è°ƒæ•´æ—¥å¿—çº§åˆ« curl -X POST http://127.0.0.1:15000/logging?level=debug é€šè¿‡æ—¥å¿—å‘ç°ï¼Œè¿æ¥åœ¨ 10s åæ–­å¼€æ—¶ä¼´éšç€ invoking idle callbacks çš„æ—¥å¿—è¾“å‡ºã€‚å¦‚ä¸‹ï¼š(å‰åä¸€å…±æµ‹è¯•äº†4æ¬¡)\nâœ istio-1.19.3 klf istio-idle-timeout-demo-5b4894b67d-tdpb5 -n istio-idle-timeout -c istio-proxy | grep \u0026#34;invoking idle callbacks\u0026#34; 2024-03-01T07:22:21.481180Z\tdebug\tenvoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:454\tinvoking idle callbacks - is_draining_for_deletion_=false\tthread=22 2024-03-01T07:22:21.481310Z\tdebug\tenvoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:454\tinvoking idle callbacks - is_draining_for_deletion_=false\tthread=22 2024-03-01T07:24:03.947896Z\tdebug\tenvoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:454\tinvoking idle callbacks - is_draining_for_deletion_=false\tthread=23 2024-03-01T07:24:03.947903Z\tdebug\tenvoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:454\tinvoking idle callbacks - is_draining_for_deletion_=false\tthread=23 2024-03-01T07:25:04.884340Z\tdebug\tenvoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:454\tinvoking idle callbacks - is_draining_for_deletion_=false\tthread=22 2024-03-01T07:25:04.884394Z\tdebug\tenvoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:454\tinvoking idle callbacks - is_draining_for_deletion_=false\tthread=22 2024-03-01T07:25:17.629907Z\tdebug\tenvoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:454\tinvoking idle callbacks - is_draining_for_deletion_=false\tthread=22 2024-03-01T07:25:17.629912Z\tdebug\tenvoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:454\tinvoking idle callbacks - is_draining_for_deletion_=false\tthread=22 åº”ç”¨ envoy filter è¶…æ—¶è®¾ç½®åï¼Œå·²ç»å»ºç«‹çš„è¿æ¥ä¸ä¼šåº”ç”¨æ–°çš„è¶…æ—¶è®¾ç½®ï¼Œåªæœ‰æ–°çš„è¿æ¥æ‰ä¼šåº”ç”¨æ–°çš„è¶…æ—¶æ—¶é—´ï¼Ÿ EnovyFilter è®¾ç½®è¶…æ—¶åï¼Œå¯ä»¥é€šè¿‡è®¾ç½®ä¸ºç©ºæ¥æ¸…é™¤è¶…æ—¶è®¾ç½®ã€‚ patch: operation: MERGE value: name: envoy.filters.network.tcp_proxy typed_config: \u0026#34;@type\u0026#34;: type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy idle_timeout: "},{"id":14,"href":"/2024/02/26/nats%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/","title":"Natsè®¾è®¡ä¸å®ç°","section":"Posts","content":" NATSè®¾è®¡ä¸å®ç° # https://github.com/nats-io/nats-sevrer\nNATS å°±æ˜¯ä¸€ä¸ªæ¶ˆæ¯ä¸­é—´ä»¶ï¼Œæä¾›äº† Pub/Sub æ ¸å¿ƒæ•°æ®æµï¼Œå¹¶åŸºäºæ­¤æ„å»ºäº† Request/Reply API å’Œ JetStream ç”¨æ¥æä¾›å¯é çš„åˆ†å¸ƒå¼å­˜å‚¨èƒ½åŠ›ï¼Œå’Œæ›´é«˜çš„ QoSï¼ˆè‡³å°‘ä¸€æ¬¡ + ACKï¼‰ã€‚\n1. æ ¸å¿ƒæ¦‚å¿µ # åºå· åè¯ï¼ˆENGï¼‰ åè¯ï¼ˆzh-CNï¼‰ è§£é‡Š 1 Publish å‘å¸ƒ å‘å¸ƒåŠ¨ä½œï¼Œå¾€ subject ä¸­æŠ•é€’ä¸€æ¡æ¶ˆæ¯\n2 Subscribe è®¢é˜… è®¢é˜…åŠ¨ä½œï¼Œè¡¨ç¤ºæƒ³è¦æ¥å—å‘å¸ƒç›¸åº” subject çš„æ¶ˆæ¯ 3 Subject ä¸»é¢˜ å”¯ä¸€æ ‡è¯†ï¼Œç”¨äºæ ‡è¯†ä¸€ç§æˆ–è€…ä¸€ç±»äº‹ä»¶çš„æ¦‚å¿µã€‚è®¢é˜…æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ nats çº¦å®šçš„é€šåŒ¹é…ç¬¦æ¥æ¥æ”¶ä¸€ç±» subjectsï¼Œå¦‚ orders.\u0026gt; ã€‚ 4 Core Nats NATS æ ¸å¿ƒ CORE NATS æä¾›äº†ä»¥ä¸‹èƒ½åŠ›ï¼š\n- PUB / SUB https://docs.nats.io/nats-concepts/core-nats/pubsub\n- Request / Reply https://docs.nats.io/nats-concepts/core-nats/reqreply\n- Queue Groups https://docs.nats.io/nats-concepts/core-nats/queue\næä¾› æœ€å¤šä¸€æ¬¡ çš„æ¶ˆæ¯ä¼ é€’ä¿è¯ 5 Request / Reply è¯·æ±‚ / å›å¤ NATS åŸºäº PUB / SUB å®ç°çš„å¯¹ request å¼‚æ­¥å›å¤çš„åŠŸèƒ½ï¼Œä¾èµ–äºæ¶ˆæ¯ä¸­çš„ reply å­—æ®µã€‚reply æ˜¯å†…ç½®å®ç°ï¼Œéšæœºç”Ÿæˆä¸€ä¸ª â€œinboxâ€ subjectã€‚\nè®¢é˜…è€…ä¸­é—´ä¹Ÿæ˜¯å­˜åœ¨ Queue Group æ¦‚å¿µçš„ã€‚\næ³¨æ„ï¼šå‘èµ· request å¦‚æœæ²¡æœ‰replyï¼Œé‚£ä¹ˆæœåŠ¡ç«¯ä¼šè¿”å› No Responders æ¶ˆæ¯ã€‚ 6 Queue groups é˜Ÿåˆ—ç»„ è®¢é˜…è€…ä½¿ç”¨åŒä¸€ä¸ªé˜Ÿåˆ—åç§°ï¼Œå®ƒä»¬å°±ä¼šæˆä¸ºä¸€ä¸ªé˜Ÿåˆ—ç»„ã€‚æ¯æ¬¡é˜Ÿåˆ—ç»„æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œåªæœ‰é˜Ÿåˆ—ç»„ä¸­_éšæœºé€‰æ‹©_çš„ä¸€ä¸ªè®¢é˜…è€…ä¼šæ¶ˆè´¹ä¸€æ¡æ¶ˆæ¯ï¼Œå†…ç½®çš„è´Ÿè½½å‡è¡¡ã€‚ 7 Message æ¶ˆæ¯ or äº‹ä»¶ ä¸€æ¡æ¶ˆæ¯åŒ…å«äº†ä»¥ä¸‹å†…å®¹ï¼š\n- Subject.\n- A payload in the form of a byte array.\n- Any number of header fields.\n- An optional \u0026lsquo;reply\u0026rsquo; address field. 8 Subject wildcards\nhttps://docs.nats.io/nats-concepts/subjects#wildcards ä¸»é¢˜é€šé…ç¬¦ è®¢é˜…è€…å¯ä»¥ä½¿ç”¨è¿™äº›é€šé…ç¬¦_é€šè¿‡å•ä¸ªè®¢é˜…æ”¶å¬å¤šä¸ªä¸»é¢˜ã€‚_\næ³¨æ„ï¼šä½†å‘å¸ƒè€…å°†å§‹ç»ˆä½¿ç”¨å®Œå…¨æŒ‡å®šçš„ä¸»é¢˜ï¼Œè€Œä¸ä½¿ç”¨é€šé…ç¬¦ã€‚ 9 JetStream\nhttps://docs.nats.io/nats-concepts/jetstream æ—  / æµ NATS ä¸­ä¸€ä¸ªåŠŸèƒ½ç‰¹æ€§ï¼Œå®ƒæ˜¯ä¸€ä¸ªå†…ç½®çš„åˆ†å¸ƒå¼å­˜å‚¨ï¼Œåœ¨ CORE nats çš„åŸºç¡€ä¸Šæ‰©å±•äº†æ›´å¤šçš„åŠŸèƒ½å’Œæ›´é«˜çš„ QoSã€‚åŠŸèƒ½ä¸Šï¼š\n- Streamï¼šå°† NATS æ¶ˆæ¯å­˜å‚¨åœ¨æµä¸­ï¼Œæä¾›å¤šç§ä¿ç•™ç­–ç•¥ã€é™åˆ¶ã€ä¸¢å¼ƒç­–ç•¥å’Œä¸»é¢˜æ˜ å°„åŠŸèƒ½ã€‚\n- Consumer: è®©å®¢æˆ·ç«¯åº”ç”¨è®¢é˜…æˆ–æ‹‰å–æµä¸­çš„æ¶ˆæ¯ï¼Œæ”¯æŒå¤šç§é‡æ”¾ç­–ç•¥ã€ç¡®è®¤æœºåˆ¶å’Œæµæ§åŠŸèƒ½\n- Persistence: å°†æµçš„æ•°æ®å¤åˆ¶åˆ°å¤šä¸ª NATS æœåŠ¡å™¨ï¼Œæä¾›å®¹é”™èƒ½åŠ›å’ŒåŠ å¯†å­˜å‚¨åŠŸèƒ½\n- KV Store: å¯ä»¥å°†æ¶ˆæ¯ä¸é”®å…³è”ï¼Œæä¾›å­˜å‚¨ã€æ£€ç´¢ã€åˆ é™¤å’Œç›‘å¬é”®å€¼å˜åŒ–çš„åŠŸèƒ½ã€‚\n- Object Store: JetStream å¯ä»¥å­˜å‚¨ä»»æ„å¤§å°çš„å¯¹è±¡ï¼ˆå¦‚æ–‡ä»¶ï¼‰ï¼Œæä¾›åˆ†å—ã€æ ¡éªŒå’Œã€å…ƒæ•°æ®ç­‰åŠŸèƒ½ã€‚\nå…¶ä¸­æœ€æ ¸å¿ƒï¼ˆå¼€å‘å¸¸ç”¨ï¼‰çš„æ¦‚å¿µå°±æ˜¯ï¼šstream å’Œ consumerã€‚ 10 Stream\nhttps://docs.nats.io/nats-concepts/jetstream/streams æµ æµå³æ˜¯æ¶ˆæ¯å­˜å‚¨ï¼Œå®ƒå®šä¹‰äº†æ¶ˆæ¯çš„å­˜å‚¨æ–¹å¼ä»¥åŠä¿ç•™çš„é™åˆ¶ã€‚\næ›´å…·ä½“çš„å†…å®¹å‚è§ #5.1 Stream é…ç½®è§£æ 11 Consumer æ¶ˆè´¹è€… æ¶ˆè´¹è€…ä½œä¸ºå®¢æˆ·ç«¯çš„æ¥å£ï¼Œä½¿ç”¨å­˜å‚¨åœ¨æµä¸­çš„æ¶ˆæ¯ï¼Œè·Ÿè¸ªå®¢æˆ·ç«¯ä¼ é€’å’Œç¡®è®¤çš„æ¶ˆæ¯ã€‚Nats åŒæ—¶æ”¯æŒ pull å’Œ push ä¸¤ç§æ¶ˆè´¹æ¨¡å¼ï¼›consumer è¿˜æä¾›äº† durable é…ç½®ï¼Œç”¨äºæŒä¹…åŒ– consumer æ¶ˆè´¹ä¿¡æ¯ï¼ˆé™¤éè®¾ç½®äº† InactiveThresholdï¼‰\næ›´å…·ä½“çš„å†…å®¹å‚è§ #5.2 Consumer é…ç½®è§£æ 12 Replay / Redelivery 13 Raft Group\nhttps://docs.nats.io/running-a-nats-service/configuration/clustering/jetstream_clustering RAFT ç»„ å¯¹äºç‰¹å®šå†…å®¹è¾¾æˆä¸€è‡´çš„åˆ†ç»„ï¼Œnats ä¸­æœ‰ meta, stream, consumer å‡ ç§ç»„ã€‚\nMeta: å…¨éƒ¨èŠ‚ç‚¹éƒ½æ˜¯ç»„æˆå‘˜ã€‚è´Ÿè´£ï¼šJetStream API + é›†ç¾¤ç®¡ç†ã€‚\nStream: (æ ¹æ® replicas é…ç½®é€‰æ‹©ç»„å†…çš„æœåŠ¡å™¨æˆå‘˜)ã€‚è´Ÿè´£ï¼šstream æ•°æ®\nConsumer: ï¼ˆæ ¹æ® stream groupçš„æˆå‘˜æ¥ç¡®å®šæ¶ˆè´¹è€…ç»„å†…çš„æˆå‘˜ï¼‰ã€‚è´Ÿè´£ï¼šæ¶ˆè´¹è€…çŠ¶æ€\n14 KV Store é”®å€¼å­˜å‚¨ 15 Object Store å¯¹è±¡å­˜å‚¨ 2. è½¯ä»¶æ¶æ„ï¼ˆé›†ç¾¤æ¨¡å¼ï¼‰ # Nats è‡ªèº«æ˜¯æä¾›äº†å¤šç§è¿è¡Œæ–¹å¼:\nå•æœº åªè¿è¡Œäº†ä¸€ä¸ª nats å®ä¾‹ã€‚\næ™®é€šé›†ç¾¤ï¼š è¿è¡Œäº† 3 / 5 ä¸ªå®ä¾‹ï¼Œå…¶ä¸­ä¸€ä¸ªä¸ºé›†ç¾¤ leaderï¼Œæ­¤æ—¶é›†ç¾¤å¦‚ä¸‹ï¼š\nè¶…çº§é›†ç¾¤ï¼š å­˜åœ¨å¤šä¸ªé›†ç¾¤ï¼Œé›†ç¾¤ä¹‹é—´å¯ä»¥é€šè¿‡ ç½‘å…³ æ¥ä¼ æ’­æ¶ˆæ¯_ã€‚_ç½‘å…³æä¾›äº†ä¸‰ç§ä¼ æ’­æœºåˆ¶ï¼šè¿™é‡Œ A / B åˆ†åˆ«ä»£è¡¨ä¸¤ä¸ªé›†ç¾¤ã€‚\nOptimistic Mode ä¹è§‚æ¨¡å¼ å½“ A ä¸­çš„å‘å¸ƒè€…å‘å¸ƒâ€œfooâ€æ—¶ï¼ŒA ç½‘å…³å°†æ£€æŸ¥é›†ç¾¤ B æ˜¯å¦å·²æ³¨å†Œå¯¹â€œfooâ€æ²¡æœ‰å…´è¶£ã€‚å¦‚æœæ²¡æœ‰ï¼Œåˆ™å°†â€œfooâ€è½¬å‘ç»™Bã€‚å¦‚æœBæ”¶åˆ°â€œfooâ€åï¼Œåœ¨â€œfooâ€ä¸Šæ²¡æœ‰è®¢é˜…è€…ï¼Œåˆ™Bå°†å‘Aå‘é€ä¸€æ¡ç½‘å…³åè®®æ¶ˆæ¯ï¼Œè¡¨ç¤ºå®ƒå¯¹â€œfooâ€æ²¡æœ‰å…´è¶£ï¼Œä»è€Œé˜»æ­¢å°†æ¥çš„æ¶ˆæ¯å…³äºâ€œfooâ€è¢«è½¬å‘ã€‚\nå½“åç»­ B ä¸­æœ‰è®¢é˜…è€…å…³æ³¨ \u0026ldquo;foo\u0026rdquo;, é‚£ä¹ˆ B ä¼šå‘é€ä¸€æ¡ç½‘å…³åè®®ï¼Œç”¨æ¥å–æ¶ˆå¯¹ \u0026ldquo;foo\u0026rdquo; æ²¡å…´è¶£çš„è®¾ç½®ã€‚\nInterest-only Mode å…´è¶£ï¼ˆå…³æ³¨ï¼‰æ¨¡å¼ å½“ A ä¸Šçš„ç½‘å…³å‘é€è®¸å¤šå…³äº B ä¸æ„Ÿå…´è¶£çš„å„ç§ä¸»é¢˜çš„æ¶ˆæ¯æ—¶ã€‚ B å‘é€ä¸€æ¡ç½‘å…³åè®®æ¶ˆæ¯ï¼Œè¦æ±‚ A ä¹è§‚åœ°åœæ­¢å‘é€ï¼Œå¦‚æœå·²çŸ¥å¯¹è¯¥ä¸»é¢˜æ„Ÿå…´è¶£ï¼Œåˆ™å‘é€ã€‚éšç€ B ä¸Šçš„è®¢é˜…ä¸æ–­å¢å¤šï¼ŒB å°†å‘ A æ›´æ–°å…¶ä¸»é¢˜å…´è¶£ã€‚\nQueue Subscriptions é˜Ÿåˆ—è®¢é˜…æ¨¡å¼ æœåŠ¡å™¨å°†å§‹ç»ˆé¦–å…ˆå°è¯•ä¸ºæœ¬åœ°é˜Ÿåˆ—è®¢é˜…è€…æä¾›æœåŠ¡ï¼Œå¹¶ä¸”ä»…åœ¨æœªæ‰¾åˆ°æœ¬åœ°é˜Ÿåˆ—è®¢é˜…è€…æ—¶è¿›è¡Œæ•…éšœè½¬ç§»ã€‚æœåŠ¡å™¨å°†é€‰æ‹© RTT æœ€ä½çš„é›†ç¾¤ã€‚\nå¶å­ç»“ç‚¹/é›†ç¾¤ï¼ˆä»£ç†æ¨¡å¼ï¼‰ï¼š\né€æ˜åœ°ä»æœ¬åœ°å®¢æˆ·ç«¯è·¯ç”±æ¶ˆæ¯åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªè¿œç¨‹ NATS ç³»ç»Ÿã€‚å¶å­ç»“ç‚¹é‡‡ç”¨æœ¬åœ°çš„è®¤è¯è¿›è¡Œè®¤è¯ï¼Œè¿æ¥è¿œç¨‹ NATS ç»“ç‚¹æ—¶ï¼Œé‡‡ç”¨è¿œç¨‹ NATS ç³»ç»Ÿçš„è®¤è¯ã€‚é€šå¸¸ç”¨æ¥é™ä½ local æœåŠ¡çš„å»¶è¿Ÿå’Œæµé‡ã€‚ æ³¨æ„ï¼šå¦‚æœé›†ç¾¤ä¸­ä¸€ä¸ªèŠ‚ç‚¹é…ç½®ä¸ºå¶å­ç»“ç‚¹ï¼Œé‚£ä¹ˆå…¶ä½™ç»“ç‚¹ä¹Ÿè¦é…ç½®ä¸ºå¶å­ç»“ç‚¹ã€‚\nä¸€èˆ¬åœºæ™¯ä¸‹æœ€å¸¸ç”¨çš„å°±æ˜¯é›†ç¾¤æ¨¡å¼ã€‚\nQs:\nè¿ç»´æ—¶æ€ä¹ˆä¿è¯é›†ç¾¤å„èŠ‚ç‚¹çš„è´Ÿè½½å‡è¡¡ï¼Ÿæ€ä¹ˆä¿è¯é›†ç¾¤çš„é«˜å¯ç”¨ï¼Ÿ\n3. Nats å®¢æˆ·ç«¯åè®® # https://docs.nats.io/reference/reference-protocols/nats-protocol\nNats åè®®æ˜¯ä¸€ä¸ª_æ–‡æœ¬åè®®_ è¿™æ„å‘³ç€ï¼Œæˆ‘ä»¬é€šè¿‡ telnet å°±å¯ä»¥ä¸ä¹‹äº¤äº’ï¼Œé€šè¿‡æŠ“åŒ…å·¥å…·ä¹Ÿå¯ä»¥å¾ˆè½»æ¾çš„åˆ†æå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„äº¤äº’è¡Œä¸º\nOp æ“ä½œ å‘é€æ–¹ æ“ä½œåœºæ™¯æè¿° æ³¨æ„äº‹é¡¹ INFO æœåŠ¡å™¨ å½“å®¢æˆ·ç«¯å»ºç«‹è¿æ¥æ—¶ï¼Œæˆ–è€…æœåŠ¡å™¨é›†ç¾¤æ‹“æ‰‘å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒæœåŠ¡å™¨å‘é€è‡ªèº«çš„ä¿¡æ¯ï¼Œé…ç½®å’Œå®‰å…¨è¦æ±‚ç»™å®¢æˆ·ç«¯ CONNECT å®¢æˆ·ç«¯ å½“å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨çš„ INFO æ¶ˆæ¯åï¼Œå®¢æˆ·ç«¯å‘é€è‡ªèº«çš„ä¿¡æ¯å’Œå®‰å…¨ä¿¡æ¯ç»™æœåŠ¡å™¨ï¼Œä»¥å®Œæˆè¿æ¥ verbose å­—æ®µé»˜è®¤ä¸º falseï¼Œè¡¨ç¤ºæœåŠ¡å™¨ä¸ä¼šå¯¹æ¯ä¸ªæ¶ˆæ¯å›å¤ +OK PUB å®¢æˆ·ç«¯ å½“å®¢æˆ·ç«¯æƒ³è¦å‘å¸ƒä¸€ä¸ªæ¶ˆæ¯ç»™æŒ‡å®šçš„ä¸»é¢˜æ—¶ï¼Œå®¢æˆ·ç«¯å‘é€ PUB æ¶ˆæ¯ï¼Œå¯é€‰åœ°æä¾›ä¸€ä¸ªå›å¤ä¸»é¢˜ æ¶ˆæ¯å†…å®¹æ˜¯å¯é€‰çš„ï¼Œå¦‚æœæ²¡æœ‰å†…å®¹ï¼Œéœ€è¦æŠŠå†…å®¹å¤§å°è®¾ç½®ä¸º 0ï¼Œå¹¶ä¸”ä»ç„¶éœ€è¦ç¬¬äºŒä¸ª CRLF HPUB å®¢æˆ·ç«¯ å’Œ PUB ç›¸åŒï¼Œä½†æ˜¯æ¶ˆæ¯å†…å®¹åŒ…å«äº† NATS å¤´éƒ¨ä¿¡æ¯ æ¶ˆæ¯å†…å®¹æ˜¯å¯é€‰çš„ï¼Œå¦‚æœæ²¡æœ‰å†…å®¹ï¼Œéœ€è¦æŠŠæ€»æ¶ˆæ¯å¤§å°è®¾ç½®ä¸ºå¤´éƒ¨å¤§å°ï¼Œå¹¶ä¸”ä»ç„¶éœ€è¦ç¬¬äºŒä¸ª CRLF SUB å®¢æˆ·ç«¯ å½“å®¢æˆ·ç«¯æƒ³è¦è®¢é˜…ä¸€ä¸ªä¸»é¢˜æ—¶ï¼Œå®¢æˆ·ç«¯å‘é€ SUB æ¶ˆæ¯ï¼Œå¯é€‰åœ°åŠ å…¥ä¸€ä¸ªåˆ†å¸ƒå¼é˜Ÿåˆ—ç»„ ä¸»é¢˜åç§°å¿…é¡»æ˜¯åˆæ³•çš„ï¼Œä¸èƒ½åŒ…å«ç©ºæ ¼æˆ–è€…åˆ†éš”ç¬¦ UNSUB å®¢æˆ·ç«¯ å½“å®¢æˆ·ç«¯æƒ³è¦å–æ¶ˆè®¢é˜…ä¸€ä¸ªä¸»é¢˜æ—¶ï¼Œå®¢æˆ·ç«¯å‘é€ UNSUB æ¶ˆæ¯ï¼Œå¯é€‰åœ°æŒ‡å®šä¸€ä¸ªæ¶ˆæ¯æ•°é‡ï¼Œè¾¾åˆ°åè‡ªåŠ¨å–æ¶ˆè®¢é˜… MSG æœåŠ¡å™¨ å½“æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªåº”ç”¨æ¶ˆæ¯æ—¶ï¼ŒæœåŠ¡å™¨å‘é€ MSG æ¶ˆæ¯ï¼ŒåŒ…å«ä¸»é¢˜ï¼Œsidï¼Œå¯é€‰çš„å›å¤ä¸»é¢˜å’Œå†…å®¹ HMSG æœåŠ¡å™¨ å’Œ MSG ç›¸åŒï¼Œä½†æ˜¯æ¶ˆæ¯å†…å®¹åŒ…å«äº† NATS å¤´éƒ¨ä¿¡æ¯ PING æœåŠ¡å™¨æˆ–å®¢æˆ·ç«¯ å½“æœåŠ¡å™¨æˆ–å®¢æˆ·ç«¯æƒ³è¦æ£€æµ‹å¯¹æ–¹æ˜¯å¦å­˜æ´»æ—¶ï¼Œå‘é€ PING æ¶ˆæ¯ æœåŠ¡å™¨ä¼šå®šæœŸå‘é€ PING æ¶ˆæ¯ç»™å®¢æˆ·ç«¯ï¼Œå¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰åŠæ—¶å›å¤ PONGï¼ŒæœåŠ¡å™¨ä¼šæ–­å¼€è¿æ¥ PONG æœåŠ¡å™¨æˆ–å®¢æˆ·ç«¯ å½“æœåŠ¡å™¨æˆ–å®¢æˆ·ç«¯æ”¶åˆ° PING æ¶ˆæ¯æ—¶ï¼Œå›å¤ PONG æ¶ˆæ¯ æœåŠ¡å™¨ä¼šæŠŠæ­£å¸¸çš„æµé‡å½“ä½œ PING/PONG çš„ä»£ç†ï¼Œæ‰€ä»¥å¦‚æœå®¢æˆ·ç«¯æœ‰æ¶ˆæ¯æµåŠ¨ï¼Œå¯èƒ½ä¸ä¼šæ”¶åˆ°æœåŠ¡å™¨çš„ PING +OK æœåŠ¡å™¨ å½“æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„åˆæ³•æ¶ˆæ¯æ—¶ï¼Œå¦‚æœ verbose å­—æ®µä¸º trueï¼ŒæœåŠ¡å™¨å›å¤ +OK æ¶ˆæ¯ å¤§å¤šæ•°å®¢æˆ·ç«¯ä¼šæŠŠ verbose å­—æ®µè®¾ç½®ä¸º false -ERR æœåŠ¡å™¨ å½“æœåŠ¡å™¨é‡åˆ°åè®®é”™è¯¯ï¼Œæˆæƒé”™è¯¯ï¼Œæˆ–è€…å…¶ä»–è¿è¡Œæ—¶é”™è¯¯æ—¶ï¼ŒæœåŠ¡å™¨å‘é€ -ERR æ¶ˆæ¯ç»™å®¢æˆ·ç«¯ å¤§å¤šæ•°è¿™äº›é”™è¯¯ä¼šå¯¼è‡´æœåŠ¡å™¨å…³é—­è¿æ¥ï¼Œå®¢æˆ·ç«¯éœ€è¦å¼‚æ­¥å¤„ç†è¿™äº›é”™è¯¯ ä»è¡¨é‡Œæ²¡æœ‰çœ‹åˆ° Request å¯¹ä¸å¯¹ï¼Ÿé‚£æ˜¯å› ä¸º Request æ˜¯åŸºäº Pub / Sub å®ç°çš„ APIï¼Œå› æ­¤ä¸åœ¨é€šä¿¡åè®®ä¸­ï¼Œå±äºåº”ç”¨å±‚çš„åŠŸèƒ½ã€‚ å¦å¤–ä¹Ÿæ²¡æœ‰çœ‹åˆ° JetStream ç›¸å…³çš„ Op å¯¹ä¸å¯¹ï¼Ÿç¿»ä¸‹ä»£ç å°±å¯ä»¥å‘ç°ï¼Œå®ƒæ˜¯åŸºäº Request æœºåˆ¶å®ç°çš„ pubï¼Œä½†é€šè¿‡å‰é¢çš„ä»‹ç»ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ CORE Nats çš„ Reply å…¶å®æ˜¯ Subscriber å›å¤çš„ï¼Œè€Œ JetStream æ˜¯æä¾›å¯é å­˜å‚¨çš„ ACK å¹¶ä¸èƒ½ä¾èµ–äº Consumer ï¼Œæ‰€ä»¥è¿™é‡ŒæœåŠ¡å™¨ä¸€å®šæ˜¯æœ‰ç‰¹æ®Šå¤„ç†ã€‚æˆ‘ä»¬åœ¨ #6.5 JetStream æ¶ˆæ¯çš„æŠ•é€’å’Œæ¶ˆè´¹ ä¸€èŠ‚ä¸­å†è¯¦ç»†å±•å¼€ã€‚\n4. NATS-Server é…ç½®è§£æ # https://docs.nats.io/running-a-nats-service/configuration\nNats ç«¯å£åˆ—è¡¨\né»˜è®¤ç«¯å£å· ä½œç”¨ è¡¥å……è¯´æ˜ 443 WebSocket åè®®ç«¯å£ï¼Œé€šè¿‡ websocket æ¥è¿›è¡Œäº¤äº’ 1883 MQTT åè®®æ”¯æŒ 4222 NATS è‡ªèº«ç«¯å£ 4111 å¶èŠ‚ç‚¹å…è®¸æœ¬åœ°å®¢æˆ·ç«¯é€šè¿‡ç«¯å£ 4111 è¿æ¥ï¼Œä¸”ä¸éœ€è¦ä»»ä½•è®¤è¯ 6222 é›†ç¾¤è·¯ç”±ç›‘å¬ç«¯å£ 7222 ç½‘å…³ç›‘å¬ç«¯å£ 7422 å¶å­ç»“ç‚¹ç›‘å¬ç«¯å£ 8222 ç›‘æ§æœåŠ¡ç«¯å£ 5. JetStream é…ç½®è§£æ # Nats çš„ jetstream æ˜¯é€šè¿‡ raft æ¥è§£å†³åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜ï¼Œä»¥æ­¤å®ç° stream ç›¸å…³çš„åŠŸèƒ½ã€‚\nä¸Šå›¾ä¸­å±•ç¤ºäº† jetstream çš„ä¸€äº›å…³é”®ç‚¹ï¼š\nStream å¯ä»¥å­˜å‚¨å¤šä¸ª subjectçš„æ¶ˆæ¯ã€‚ æ¶ˆè´¹è€…æœ‰å¤šç§æ¶ˆè´¹æ¨¡å¼ï¼ˆpull/pushï¼‰ï¼Œè¿˜å¯ä»¥è¿‡æ»¤stream ä¸­çš„ subject è¿›è¡Œæ¶ˆè´¹ã€‚ æ¶ˆè´¹æœ‰å¤šç§ç¡®è®¤æ¨¡å¼ï¼ˆackï¼‰ 5.1 Stream é…ç½®æ¸…å• # https://docs.nats.io/nats-concepts/jetstream/streams#configuration\næˆ‘ä»¬å½“å‰ä½¿ç”¨çš„ nats ç‰ˆæœ¬å¯¹åº” 2.9.21 ä¸‹è¡¨é…ç½®ä¸­ï¼ŒMetadataï¼Œcompression, FirstSeq å’Œ SubjectTransform æš‚ä¸å¯ç”¨ã€‚\né…ç½®é€‰é¡¹ æè¿° ç‰ˆæœ¬ å¯ç¼–è¾‘ Name æµçš„åç§°ï¼Œå¿…é¡»æ˜¯å”¯ä¸€çš„ 2.2.0 âŒ Storage æµçš„å­˜å‚¨ç±»å‹ï¼Œå¯ä»¥æ˜¯ Fileï¼ˆé»˜è®¤ï¼‰æˆ– Memory 2.2.0 âŒ Subjects æµè®¢é˜…çš„ä¸»é¢˜åˆ—è¡¨ï¼Œå¯ä»¥ä½¿ç”¨é€šé…ç¬¦ 2.2.0 âœ… Replicas æµçš„å‰¯æœ¬æ•°é‡ï¼Œå¿…é¡»å¤§äºç­‰äº 1 2.2.0 âœ… Retention æµçš„ä¿ç•™ç­–ç•¥ï¼Œå†³å®šäº†ä½•æ—¶åˆ é™¤æ¶ˆæ¯ 2.2.0 âœ… MaxAge æµå…è®¸çš„æœ€å¤§æ¶ˆæ¯å­˜æ´»æ—¶é—´ï¼Œ0 è¡¨ç¤ºæ— é™åˆ¶ 2.2.0 âœ… MaxBytes æµå…è®¸çš„æœ€å¤§å­—èŠ‚æ•°ï¼Œ-1 è¡¨ç¤ºæ— é™åˆ¶ 2.2.0 âœ… MaxMsgs æµå…è®¸çš„æœ€å¤§æ¶ˆæ¯æ•°é‡ï¼Œ-1 è¡¨ç¤ºæ— é™åˆ¶ 2.2.0 âœ… MaxMsgSize æµå…è®¸æ¥æ”¶çš„æœ€å¤§æ¶ˆæ¯ä½“ 2.2.0 âœ… MaxConsumers æµå…è®¸çš„æœ€å¤§æ¶ˆè´¹è€…æ•°é‡ï¼Œ-1 è¡¨ç¤ºæ— é™åˆ¶ 2.2.0 âŒ NoAck æµæ˜¯å¦ç¦ç”¨ç¡®è®¤æœºåˆ¶ï¼Œå¦‚æœä¸º trueï¼Œåˆ™ä¸éœ€è¦æ¶ˆè´¹è€…ç¡®è®¤æ¶ˆæ¯ã€‚ 2.2.0 âœ… Retention å£°æ˜æµçš„ä¿ç•™ç­–ç•¥ 2.2.0 âŒ Discard æµè¾¾åˆ°é™åˆ¶æ—¶çš„ä¸¢å¼ƒç­–ç•¥ï¼Œå¯ä»¥æ˜¯ DiscardOldï¼ˆé»˜è®¤ï¼‰ã€DiscardNew æˆ– DiscardNewPerSubject 2.2.0 âœ… DuplicateWindow æµçš„å»é‡çª—å£ï¼Œç”¨äºæ£€æµ‹å’Œåˆ é™¤é‡å¤çš„æ¶ˆæ¯ï¼Œ0 è¡¨ç¤ºç¦ç”¨å»é‡ 2.2.0 âœ… Placement æµçš„æ”¾ç½®é€‰é¡¹ï¼Œå¯ä»¥æŒ‡å®šé›†ç¾¤å’Œæ ‡ç­¾ 2.2.0 âœ… Mirror æµçš„é•œåƒé€‰é¡¹ï¼Œå¯ä»¥æŒ‡å®šæºæµå’Œè¿‡æ»¤æ¡ä»¶ 2.2.0 å·²è®¾ç½®ä¸å¯ä¿®æ”¹ Sources æµçš„æºé€‰é¡¹ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªæºæµå’Œè¿‡æ»¤æ¡ä»¶ 2.2.0 âœ… MaxMsgsPerSubject æµå…è®¸çš„æ¯ä¸ªä¸»é¢˜çš„æœ€å¤§æ¶ˆæ¯æ•°é‡ï¼Œ0 è¡¨ç¤ºæ— é™åˆ¶ 2.3.0 âœ… Description æè¿°ä¿¡æ¯ 2.3.3 âœ… Sealed stream å°å­˜ï¼Œä¸å…è®¸åˆ é™¤ã€‚ 2.6.2 å¯ä¿®æ”¹ä¸€æ¬¡ DenyDelete é™åˆ¶é€šè¿‡ API ä» stream ä¸­åˆ é™¤æ¶ˆæ¯ã€‚ 2.6.2 âŒ DenyPurge é™åˆ¶é€šè¿‡ API ä» stream ä¸­æ¸…é™¤æ¶ˆæ¯ã€‚ 2.6.2 âŒ AllowRollup æµæ˜¯å¦å…è®¸æ»šåŠ¨æ›´æ–°ï¼Œå¦‚æœä¸º trueï¼Œåˆ™å¯ä»¥ä½¿ç”¨ Nats-Rollup å¤´éƒ¨åˆ é™¤æ—§çš„æ¶ˆæ¯ 2.6.2 âœ… RePublish å­˜å‚¨åœ¨ stream ä¼šé©¬ä¸Šé‡æ–°å¾€é…ç½®çš„ subject å‘å¸ƒæ¶ˆæ¯ 2.8.3 âœ… AllowDirect ï¼Ÿï¼Ÿï¼Ÿ âœ… MirroDirect ï¼Ÿï¼Ÿï¼Ÿ 2.9.0 âœ… DiscardNewPerSubject å¦‚æœä¸º true, ä¸¢å¼ƒç­–ç•¥ä¸º DiscardNew æ—¶ï¼Œåˆ™ä¸¢å¼ƒæ¯ä¸ª subject æ–°æ¥çš„æ¶ˆæ¯ã€‚ 2.9.0 âœ… Metadata ???? 2.10.0 âœ… Compression æ–‡ä»¶å­˜å‚¨å‹ç¼©ç®—æ³•ï¼Œs2 = snappy 2.10.0 âœ… FirstSeq æŒ‡å®š stream çš„åˆå§‹åºåˆ—å· 2.10.0 âŒ SubjectTransform æµçš„ä¸»é¢˜è½¬æ¢é€‰é¡¹ï¼Œå¯ä»¥æŒ‡å®šæºä¸»é¢˜å’Œç›®æ ‡ä¸»é¢˜ï¼Œç”¨äºåœ¨å­˜å‚¨æ¶ˆæ¯æ—¶ä¿®æ”¹ä¸»é¢˜ 2.10.0 âœ… 5.2 Consumer é…ç½®æ¸…å• # https://docs.nats.io/nats-concepts/jetstream/consumers\n5.2.1 é€šç”¨é…ç½® # é…ç½®é€‰é¡¹ æè¿° ç‰ˆæœ¬ æ˜¯å¦å¯ç¼–è¾‘ Durable è®¢é˜…ç»‘å®šåˆ°ä½¿ç”¨è€…ï¼Œç›´åˆ°è¢«æ˜¾ç¤ºåˆ é™¤ 2.2.0 âŒ FilterSubject è¿‡æ»¤ consumer æ¶ˆè´¹çš„ä¸»é¢˜ï¼Œä¸èƒ½å’Œ FilterSubjects åŒæ—¶ä½¿ç”¨ 2.2.0 âœ… AckPolicy å®¢æˆ·ç«¯ç¡®è®¤ç­–ç•¥ï¼š\nAckExplicit: é»˜è®¤ç­–ç•¥ï¼Œæ¯æ¡æ¶ˆæ¯å•ç‹¬ç¡®è®¤ã€‚\nAckNone: ä¸ç¼ºäººä»»ä½•æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨å‘é€æ—¶å³ç¡®è®¤ã€‚\nAckAllï¼šæ”¶åˆ°ç³»åˆ—æ¶ˆæ¯ï¼Œåªéœ€è¦ç¡®è®¤æœ€åä¸€æ¡ã€‚ 2.2.0 âŒ AckWait ä¸€æ—¦ä»»ä½•å•ä¸ªæ¶ˆæ¯è¢«ä¼ é€’ç»™æ¶ˆè´¹è€…ï¼ŒæœåŠ¡å™¨å°†ç­‰å¾…å…¶ç¡®è®¤çš„æŒç»­æ—¶é—´ã€‚å¦‚æœæ²¡æœ‰åŠæ—¶æ”¶åˆ°ç¡®è®¤ï¼Œæ¶ˆæ¯å°†è¢«é‡æ–°å‘é€ã€‚ 2.2.0 âœ… DeliverPolicy æ¶ˆè´¹è€…æ¥å—æ¶ˆæ¯çš„ç­–ç•¥ï¼š\nDeliverAllï¼šé»˜è®¤ç­–ç•¥ï¼Œå°†ä»æœ€æ—©å¯ç”¨çš„æ¶ˆæ¯å¼€å§‹æ¶ˆè´¹\nDeliverLast: å¼€å§‹æ¶ˆè´¹åï¼Œæ¶ˆè´¹åŠ å…¥åˆ° stream ä¸­çš„æœ€æ–°ä¸€æ¡æ¶ˆæ¯ï¼ˆå¦‚æœè¿‡æ»¤ï¼Œåˆ™æ˜¯åŒ¹é…çš„æœ€åä¸€æ¡ï¼‰\nDeliverNew: å¼€å§‹æ¶ˆè´¹åï¼Œåªä¼šå¼€å§‹æ¥æ”¶åœ¨æ¶ˆè´¹è€…åˆ›å»ºä¹‹ååˆ›å»ºçš„æ¶ˆæ¯ã€‚\nDeliverByStartSequence: åŒ¹é…åºåˆ—å·çš„ç¬¬ä¸€æ¡æˆ–è€…ä¸‹ä¸€æ¡seq \u0026gt;= OptStartSeq\nDeliverByStartTime: åŒ¹é…æ—¶é—´çš„ç¬¬ä¸€æ¡æˆ–è€…ä¸‹ä¸€æ¡ time \u0026gt;= OptStartTime\nDeliverLastPerSubject: å¼€å§‹æ¶ˆè´¹åï¼Œæ¶ˆè´¹ï¼ˆåŒ¹é…çš„ï¼‰æ¯ä¸ª subject çš„æœ€æ–°ä¸€æ¡æ¶ˆæ¯ã€‚ 2.2.0 âŒ OptStartSeq DeliverByStartSequence é…åˆä½¿ç”¨ 2.2.0 âŒ OptStartTime DeliverByStartTime é…åˆä½¿ç”¨ 2.2.0 âŒ Description æ¶ˆè´¹è€…æè¿° InactiveThreshold Consumer è¶…è¿‡è¿™ä¸ªæ—¶é—´æœªæ´»åŠ¨ä¼šè¢«æ¸…ç†ï¼Œåœ¨ 2.9 ä»¥å‰ä»…å¯¹ ä¸´æ—¶æ¶ˆè´¹è€…ç”Ÿæ•ˆã€‚ 2.2.0 âœ… MaxAckPending å®šä¹‰ä¸ºç¡®è®¤çš„æ¶ˆæ¯çš„æœ€å¤§æ•°é‡ï¼Œä¸€æ—¦åˆ°è¾¾è¿™ä¸ªé™åˆ¶ï¼Œé‚£ä¹ˆå°†æš‚å®šæŠ•é€’æ¶ˆæ¯ã€‚ 2.2.0 âœ… MaxDeliver å°è¯•ä¼ é€æ¶ˆæ¯çš„æœ€å¤§æ¬¡æ•°ã€‚æ¶ˆè´¹è€…æœªç¡®è®¤ï¼ˆNAckæˆ–è€…æœªå‘é€ç¡®è®¤ï¼‰æ—¶ä¼šé‡æ–°ä¼ é€’ã€‚ 2.2.0 âœ… ReplayPolicy ReplayOriginalï¼šæ¨¡æ‹Ÿæ¥æ”¶åˆ°æ¶ˆæ¯çš„æ—¶é—´å‘ consumer æ¨é€ã€‚\nReplayInstantï¼šæ¶ˆæ¯å°†å°½å¿«æ¨é€åˆ°å®¢æˆ·ç«¯ã€‚ 2.2.0 âŒ Replicas è®¾ç½® consumer group çš„å‰¯æœ¬æ•°ï¼Œé»˜è®¤ç»§æ‰¿ streamã€‚ 2.8.3 âœ… MemoryStorage è®¾ç½®å°† Consumer çš„çŠ¶æ€ä¿ç•™åœ¨å†…å­˜ä¸­ï¼Œè€Œä¸æ˜¯ç»§æ‰¿ stream çš„å­˜å‚¨ç±»å‹ã€‚ 2.8.3 âœ… SampleFrequency é‡‡æ ·ç‡ï¼šï¼Ÿï¼Ÿï¼Ÿ 2.2.0 âœ… Metadata ç”¨äºå…³è”æ¶ˆè´¹è€…çš„å…ƒæ•°æ® 2.10.0 âœ… FilterSubjects ç±»ä¼¼äº FilterSubjectï¼Œä½†æ˜¯å¤šä¸ª 2.10.0 âœ… 5.2.2 æ‹‰æ¨¡å¼ - ä¸“å±é…ç½® # é…ç½®é€‰é¡¹ æè¿° ç‰ˆæœ¬ æ˜¯å¦å¯ç¼–è¾‘ MaxWaiting æœ€å¤§æ‹‰å–è¯·æ±‚æ•° 2.2.0 âŒ MaxRequestExpires å•ä¸ªæ‹‰å–è¯·æ±‚ç­‰å¾…æ¶ˆæ¯å¯ä¾›æ‹‰å–çš„æœ€é•¿æ—¶é—´ 2.2.0 âŒ MaxRequestBatch å•ä¸ªè¯·æ±‚çš„æœ€å¤§æ•°é‡ (MaxRequestMaxBytes å…±åŒä½œç”¨ï¼Œå…ˆåˆ°å…ˆé™åˆ¶) 2.7.0 âœ… MaxRequestMaxBytes å•ä¸ªè¯·æ±‚çš„æœ€å¤§å­—èŠ‚æ•° 2.8.3 âœ… 5.2.3 æ¨æ¨¡å¼ - ä¸“å±é…ç½® # é…ç½®é€‰é¡¹ æè¿° ç‰ˆæœ¬ æ˜¯å¦å¯ç¼–è¾‘ DeliverSubject è®¾ç½®æœåŠ¡å™¨æ¨é€çš„ä¸»é¢˜ï¼Œå°†éšå¼çš„è®¾ç½®æ¶ˆè´¹è€…æ˜¯åŸºäºæ¨é€ã€‚ 2.2.0 âŒ DeliverGroup ç±»ä¼¼äº queue group 2.2.0 âœ… FlowControl å¯ç”¨æ»‘åŠ¨çª—å£åè®®ï¼ˆæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯é€šä¿¡äº¤æ¢ï¼‰ï¼Œç”¨äºæ§åˆ¶æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€å¤šå°‘æ¶ˆæ¯ã€‚ 2.2.0 âœ… IdleHeartbeat æœåŠ¡å™¨å®šæ—¶å‘å®¢æˆ·ç«¯å‘é€çŠ¶æ€æ¶ˆæ¯ï¼ˆåœ¨å¿ƒè·³å‘¨æœŸå†…æ²¡æœ‰æ–°æ¶ˆæ¯å‘é€ï¼‰ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ„ŸçŸ¥åˆ°æœåŠ¡å™¨çš„çŠ¶æ€ã€‚ 2.2.0 âœ… RateLimit é™åˆ¶å‘æ¶ˆè´¹è€…å‘é€æ¶ˆæ¯çš„çš„é€Ÿç‡ bits Per Second 2.2.0 âœ… HeadersOnly ä»…ä¼ é€æµä¸­çš„æ¶ˆæ¯æ ‡å¤´ï¼Œè€Œä¸ä¼ é€æ­£æ–‡ã€‚å…¶ä¸­ä¼šæºå¸¦ Nats-Msg-Size æ¥æ ‡è¯†è´Ÿè½½çš„å¤§å°ã€‚ 2.6.2 âœ… 6. å…³é”®æµç¨‹ # è¿™é‡Œæ¢³ç†äº†ä¸€äº› Nats çš„å…³é”®æµç¨‹ï¼Œç”¨æ¥ç†è§£ nats ä¸­çš„è®¾è®¡å’Œå®ç°åŸç†ã€‚\n6.1 æœåŠ¡å¯åŠ¨ / é›†ç¾¤ # é›†ç¾¤ gossip æµç¨‹ç¤ºæ„å›¾ï¼š\nnats-server -D -p 4222 -cluster nats://localhost:6222 nats-server -D -p 4333 -cluster nats://localhost:6333 -routes nats://localhost:6222 nats-server -D -p 4444 -cluster nats://localhost:6444 -routes nats://localhost:6333 æµç¨‹è§£é‡Šè¯´æ˜ï¼š\nnats-1 å¯åŠ¨ nats-2 è¿æ¥åˆ° nats-1, nats-1 å›å¤ INFO æ¶ˆæ¯ï¼Œå¹¶å°† nats-2 æ·»åŠ åˆ°è‡ªå·±çš„è·¯ç”±ï¼ŒåŒæ—¶å»ºç«‹åˆ° nats-2 çš„è¿æ¥ã€‚ nats-3 è¿æ¥åˆ° nats-2, nats-2 å›å¤ INFO æ¶ˆæ¯ï¼Œå¹¶å°† nats-3 æ·»åŠ åˆ°è‡ªå·±çš„è·¯ç”±ï¼ŒåŒæ—¶å»ºç«‹åˆ° nats-3 çš„è¿æ¥ã€‚è¿™é‡Œ nats-2 ä¼šå°†æ–°è·¯ç”±ï¼ˆ nats-3 ï¼‰ä¼ æ’­ï¼ˆINFO æ¶ˆæ¯ï¼‰åˆ°è‡ªå·±å·²çŸ¥çš„æœåŠ¡èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ nats-1, è€Œ nats-1 æ”¶åˆ° INFO æ¶ˆæ¯åï¼Œä¼šå‘ nats-3 å»ºç«‹è¿æ¥ï¼Œä¸å‰é¢çš„æµç¨‹ç±»ä¼¼ã€‚ 6.2 PUB / SUB # æ•´ä½“æµç¨‹æ¦‚è§ˆå¦‚ä¸‹ï¼š\n6.2.1Â SUB # å½“å®¢æˆ·ç«¯æ–°å¢è®¢é˜…æ—¶ï¼Œä¼šå‘æœåŠ¡å™¨å‘é€ä¸€æ¡ SUB æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨åˆ™ä¼šæ›´æ–°å®¢æˆ·ç«¯ï¼ˆåŠå¯¹åº”è´¦æˆ·ï¼‰çš„è®¢é˜…å…³ç³»ï¼ŒåŒæ—¶å‘å…¶ä½™é›†ç¾¤ä¸­çš„ route (æœåŠ¡èŠ‚ç‚¹) å‘é€ RS+ ï¼ˆé›†ç¾¤é€šè®¯åè®®ï¼‰æ¶ˆæ¯ä»¥æ›´æ–°è®¢é˜…ã€‚\n6.2.2Â PUB # å®¢æˆ·ç«¯å‘å¸ƒä¸€æ¡æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨å†…éƒ¨åŒ¹é…ï¼ˆæœ‰ç¼“å­˜è®¾è®¡ä»¥æé«˜åŒ¹é…æ•ˆç‡ï¼‰ç›¸å…³è®¢é˜…å®¢æˆ·ç«¯ã€‚å°†æ¶ˆæ¯åŠ å…¥åˆ°å®¢æˆ·ç«¯çš„å‘é€ç¼“å†²åŒºï¼ˆæ³¨æ„ï¼šè®¢é˜…ä¸­åŒºåˆ† æ™®é€šè®¢é˜…å’Œ é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—æ¨¡å¼åˆ™éœ€è¦éšæœºé€‰ä¸­ä¸€ä¸ªå®¢æˆ·ç«¯ï¼‰ï¼Œå½“ç›¸åº”çš„ route èŠ‚ç‚¹æ”¶åˆ°æ¶ˆæ¯åï¼Œä¼šå†ä»æœ¬åœ°çš„è®¢é˜…åˆ—è¡¨ä¸­åŒ¹é…å½“å‰èŠ‚ç‚¹ä¸­çš„å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯ã€‚\n6.3 Request / Reply # ä» Nats è®¾è®¡çš„åè®®å·²ç»çŸ¥é“ï¼ŒRequest å’Œ Reply ä¸¤ä¸ª API æ˜¯åŸºäº PUB / SUB æœºåˆ¶ã€‚PUB å‚æ•°ä¸­å¯ä»¥æºå¸¦ä¸€ä¸ª reply å‚æ•°ï¼Œè¯¥ reply å‚æ•°æ˜¯å‘å¸ƒæ—¶è‡ªåŠ¨åˆ›å»ºçš„ä¸€ä¸ª _INBOX subjectã€‚æœåŠ¡ç«¯åœ¨æ¨é€æ¶ˆæ¯æ—¶ï¼Œä¼šå°† reply æ”¾åˆ° MSG æ¶ˆæ¯å¤´ä¼ é€’ç»™è®¢é˜…è€…ã€‚\n// This processes the sublist results for a given message. // Returns if the message was delivered to at least target and queue filters. func (c *client) processMsgResults(acc *Account, r *SublistResult, msg, deliver, subject, reply []byte, flags int) (bool, [][]byte) { // ... var creply = reply // ... // Loop over all normal subscriptions that match. for _, sub := range r.psubs { ... // Normal delivery mh := c.msgHeader(dsubj, creply, sub) c.deliverMsg(prodIsMQTT, sub, acc, dsubj, creply, mh, msg, rplyHasGWPrefix) } } 6.4 æ–°å»º jetstream # åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ multi-raft æœ‰ä¸ªå¤§è‡´çš„æ¦‚å¿µï¼Œç¤ºæ„å›¾å¦‚ä¸‹ï¼š stream raft group å°±å¯¹åº”ä¸Šå›¾ä¸­çš„ä¸€ä¸ª raft groupã€‚ä¸æ­¤åŒæ—¶ï¼Œé›†ç¾¤ä¸­æ‰€æœ‰å¼€å¯ jetstream åŠŸèƒ½çš„èŠ‚ç‚¹è¿˜ä¼šç»„æˆä¸€ä¸ª meta raft group, ç”¨æ¥ç®¡ç† jestream API çš„æ‰§è¡Œå’Œ jetstream é›†ç¾¤æ‹“æ‰‘ï¼ˆèŠ‚ç‚¹ä¸Šçº¿ç¦»çº¿ï¼‰ã€‚\nä» nats-cli çš„æºç å…¥æ‰‹ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ï¼š\n// NewStreamFromDefault creates a new stream based on a supplied template and optionsfunc (m *Manager) NewStreamFromDefault(name string, dflt api.StreamConfig, opts ...StreamOption) (stream *Stream, err error) { // ... var resp api.JSApiStreamCreateResponse err = m.jsonRequest(fmt.Sprintf(api.JSApiStreamCreateT, name), \u0026amp;cfg, \u0026amp;resp) if err != nil { return nil, err } return m.streamFromConfig(\u0026amp;resp.Config, resp.StreamInfo), nil } Manager çš„å«ä¹‰æ˜¯ JetStreamManagerï¼Œä»£è¡¨ä¸æœåŠ¡ç«¯ JS API äº¤äº’ï¼Œå…¶ä¸­ api. JSApiStreamCreateT string = \u0026quot;$JS.API.STREAM.CREATE.%s\u0026quot; å¯ä»¥å‘ç°åº•å±‚è¿˜æ˜¯é€šè¿‡ PUB / SUB æœºåˆ¶å®ç°çš„äº¤äº’ã€‚\nåœ¨ nats-server ä¸­æ£€ç´¢å¯ä»¥å‘ç°ï¼Œåœ¨ nats-server å†…éƒ¨å®šä¹‰äº† JetStream ç›¸å…³API çš„ msgHandlerã€‚\nfunc (s *Server) setJetStreamExportSubs() error { // Start the go routine that will process API requests received by the // subscription below when they are coming from routes, etc.. s.jsAPIRoutedReqs = newIPQueue[*jsAPIRoutedReq](s, \u0026#34;Routed JS API Requests\u0026#34;) s.startGoRoutine(s.processJSAPIRoutedRequests) // This is the catch all now for all JetStream API calls. if _, err := s.sysSubscribe(jsAllAPI, js.apiDispatch); err != nil { return err } // ... // API handles themselves. pairs := []struct { subject string handler msgHandler }{ {JSApiAccountInfo, s.jsAccountInfoRequest}, {JSApiTemplateCreate, s.jsTemplateCreateRequest}, {JSApiTemplates, s.jsTemplateNamesRequest}, {JSApiTemplateInfo, s.jsTemplateInfoRequest}, {JSApiTemplateDelete, s.jsTemplateDeleteRequest}, {JSApiStreamCreate, s.jsStreamCreateRequest}, {JSApiStreamUpdate, s.jsStreamUpdateRequest}, {JSApiStreams, s.jsStreamNamesRequest}, {JSApiStreamList, s.jsStreamListRequest}, {JSApiStreamInfo, s.jsStreamInfoRequest}, {JSApiStreamDelete, s.jsStreamDeleteRequest}, {JSApiStreamPurge, s.jsStreamPurgeRequest}, {JSApiStreamSnapshot, s.jsStreamSnapshotRequest}, {JSApiStreamRestore, s.jsStreamRestoreRequest}, {JSApiStreamRemovePeer, s.jsStreamRemovePeerRequest}, {JSApiStreamLeaderStepDown, s.jsStreamLeaderStepDownRequest}, {JSApiConsumerLeaderStepDown, s.jsConsumerLeaderStepDownRequest}, {JSApiMsgDelete, s.jsMsgDeleteRequest}, {JSApiMsgGet, s.jsMsgGetRequest}, {JSApiConsumerCreateEx, s.jsConsumerCreateRequest}, {JSApiConsumerCreate, s.jsConsumerCreateRequest}, {JSApiDurableCreate, s.jsConsumerCreateRequest}, {JSApiConsumers, s.jsConsumerNamesRequest}, {JSApiConsumerList, s.jsConsumerListRequest}, {JSApiConsumerInfo, s.jsConsumerInfoRequest}, {JSApiConsumerDelete, s.jsConsumerDeleteRequest}, } js.mu.Lock() defer js.mu.Unlock() for _, p := range pairs { sub := \u0026amp;subscription{subject: []byte(p.subject), icb: p.handler} if err := js.apiSubs.Insert(sub); err != nil { return err } } return nil } åœ¨ client æ¶ˆæ¯åˆ†å‘(deliverMsg) çš„é€»è¾‘ä¸­ä¼šå¯¹åŒ¹é…çš„ subscription æ‰§è¡Œ icb (msgHandler)ã€‚\nåœ¨é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œè¿™äº› JetStream API çš„è®¢é˜…ä¹Ÿæ˜¯ä¼šé€šè¿‡ route å®¢æˆ·ç«¯ä¼ å¯¼åˆ°é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ã€‚ç›¸å½“äºæ¯ä¸ªèŠ‚ç‚¹éƒ½è®¢é˜…/å¤„ç†ï¼ŒJS API çš„æ¶ˆæ¯ï¼Œä½†æ˜¯åªæœ‰ leader èŠ‚ç‚¹å¯ä»¥å¤„ç†ã€‚\njsStreamCreateRequest åç»­ä»£ç é€»è¾‘ï¼ˆé›†ç¾¤æ¨¡å¼ä¸‹, å•æœºåªéœ€è¦åœ¨æœ¬åœ°æ“ä½œå³å¯ï¼‰:\njsStreamCluster(jetstream meta group) çš„å¯åŠ¨è·¯å¾„ï¼š Reload / Start -\u0026gt; enableJetStream -\u0026gt; enableJetStreamClustering -\u0026gt; startRaftNode/setupMetaGroup -\u0026gt; monitorCluster\né€šè¿‡ meta raft group æäº¤ä¸€æ¡æ–°å¢ stream çš„æ—¥å¿—æ¶ˆæ¯ï¼ˆå…¶ä¸­å·²ç»è®¾ç½® raftgroup çš„åŸºæœ¬ä¿¡æ¯ï¼‰å‚è§ jsClusteredStreamRequest å‡½æ•° jetstream é›†ç¾¤ä¸­çš„èŠ‚ç‚¹æ¥æ”¶åˆ°è¯¥æ—¥å¿—åï¼ˆmonitorClusterï¼‰ï¼Œä¼šæ‰§è¡Œï¼ˆapplyMetaEntriesï¼‰å…¶ä¸­çš„æ“ä½œ ï¼ˆassignStreamOpï¼‰æ·»åŠ  stream æ‰§è¡Œé€»è¾‘å‚è§ processStreamAssignment -\u0026gt; processClusterCreateStream æ–°å»ºä¸€ä¸ª stream raft group å¯åŠ¨ raft èŠ‚ç‚¹ å†…éƒ¨åˆ›å»ºä¸€ä¸ª stream æ•°æ®ç»“æ„ï¼ˆmset= streamï¼‰ å¯åŠ¨ç›‘è§†åç¨‹ monitorStreamï¼Œå¤„ç† raft group ä¸­çš„äº‹ä»¶ï¼ˆå¿«ç…§ï¼Œé¢†å¯¼è€…å˜æ›´ï¼Œæ—¥å¿—åº”ç”¨ï¼‰ 6.5 JetStream æ¶ˆæ¯çš„æŠ•é€’å’Œæ¶ˆè´¹ # æœ€ç®€å•çš„å¼€å§‹ä½¿ç”¨ JetStream æ¶ˆè´¹è€…çš„ä»£ç å¦‚ä¸‹ï¼š\n// connect to nats server nc, _ := nats.Connect(nats.DefaultURL) // create jetstream context from nats connection js, _ := jetstream.New(nc) ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second) defer cancel() // get existing stream handle stream, _ := js.Stream(ctx, \u0026#34;foo\u0026#34;) // retrieve consumer handle from a stream cons, _ := stream.Consumer(ctx, \u0026#34;cons\u0026#34;) // consume messages from the consumer in callback cc, _ := cons.Consume(func(msg jetstream.Msg) { fmt.Println(\u0026#34;Received jetstream message: \u0026#34;, string(msg.Data())) msg.Ack() }) defer cc.Stop() 6.5.1 æ¶ˆè´¹è€…åˆ›å»º # æ¶ˆè´¹è€…å¯ä»¥æ˜¾å¼æˆ–è€…éšå¼çš„åˆ›å»ºï¼Œå¦‚æœéšå¼åˆ›å»ºå¾€å¾€éƒ½ä»£è¡¨ä¸´æ—¶ï¼Œä¹Ÿå°±æ˜¯å¦‚æœæ¶ˆè´¹è€…ä¸æ´»è·ƒåˆ™ä¼šè¢«æœåŠ¡ç«¯åˆ é™¤ã€‚ä¹‹åï¼Œå®¢æˆ·ç«¯å¼€å§‹è®¢é˜…æ¶ˆè´¹è€…ä¸‹å‘æ¶ˆæ¯çš„ subjectï¼Œpush æ–¹å¼ç­‰æœåŠ¡ç«¯æ¨é€ï¼Œè€Œ pull æ¨¡å¼åˆ™éœ€è¦å®šæ—¶å¾€æœåŠ¡ç«¯å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œè§¦å‘æ¶ˆæ¯ä¸‹æ¨ã€‚\nä» nats.go çš„æºç å‡ºå‘ï¼ŒStreamConsumerManager æ¥å£å®šä¹‰äº†ä¸€ä¸ª JetStream ä¸­ Consumer çš„ç›¸å…³æ“ä½œã€‚æˆ‘ä»¬é¦–å…ˆçœ‹ä¸‹ consumer çš„åˆ›å»ºï¼ŒåŒæ ·çš„å®¢æˆ·ç«¯æ˜¯é€šè¿‡ JS API æ¥å®Œæˆè°ƒç”¨ï¼š æœåŠ¡ç«¯ç»Ÿä¸€ä½¿ç”¨äº† jsConsumerCreateRequest è¿›è¡Œå¤„ç†ï¼Œå…¶ä¸­é€»è¾‘ä¸æ·»åŠ  stream ç±»ä¼¼ï¼šjetstreamé›†ç¾¤æ¨¡å¼ä¸‹ä¼šåˆ›å»ºä¸€ä¸ªraft group è®¾ç½®å¥½ leader, å¹¶é€šè¿‡ meta group æ¥æäº¤æ–°å¢ consumer çš„æ—¥å¿—ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¼šå¤„ç†è¯¥æ¶ˆæ¯ï¼ˆprocessConsumerAssignment-\u0026gt;processClusterCreateConsumerï¼‰ï¼š\nè·å–åˆ°æµ é€šè¿‡ addConsumerWithAssignment æ·»åŠ ä¸€ä¸ª consumer ï¼ˆleaderï¼‰å‘é€å“åº” è¿™ä¸ªæ“ä½œä¼šåœ¨ stream raft group çš„ éƒ¨åˆ†/å…¨éƒ¨ï¼ˆå–å†³äº consumer é…ç½®çš„ Replicasï¼‰èŠ‚ç‚¹ä¸­åˆ›å»ºä¸€ä¸ª raft group (consumer) ç”¨æ¥ä¿å­˜ consumer çš„ç›¸å…³ä¿¡æ¯ï¼ˆæ¶ˆè´¹ç‚¹ä½ï¼‰ã€‚åŒæ—¶åœ¨ stream å¯¹åº”çš„èŠ‚ç‚¹ä¸­æ·»åŠ  consumer å®ä¾‹ã€‚\nå†å›åˆ°å®¢æˆ·ç«¯ï¼Œconsumer åˆ›å»ºï¼ˆæŸ¥è¯¢ï¼‰åï¼Œè·å–åˆ° consume çš„ä¿¡æ¯ï¼Œä»ä¸­è·å–åˆ° delivery subjectï¼ˆä»£è¡¨ consumer æ¶ˆè´¹çš„æ¶ˆæ¯ä¼šä»è¿™ä¸ª subject æ¨é€å‡ºæ¥ï¼‰ï¼Œåç»­å®¢æˆ·ç«¯ä¼šè®¢é˜…è¿™ä¸ªè¿™ä¸ª subjectã€‚\nè¿™é‡Œå¯ä»¥è¯´æ˜æœåŠ¡ç«¯ consumer å’Œ å®¢æˆ·ç«¯ consumer æ²¡æœ‰å¿…ç„¶çš„çš„è”ç³»ï¼Œåç»­å¦å¤–çš„å®¢æˆ·ç«¯ä½¿ç”¨åŒä¸€ä¸ª consumer ä¿¡æ¯æ—¶ï¼Œä¹Ÿåªæ˜¯å…±äº« consumer çš„é…ç½®ï¼Œè®¢é˜…ç›¸åŒçš„ subjectï¼Œå›åˆ°äº† CORE NATS æä¾›çš„æ•°æ®æ¨¡å‹ã€‚\n6.5.2 æ¶ˆæ¯æ¶ˆè´¹ # consumer æä¾›äº†ä¸¤ç§æ¨¡å¼ pull (PullSubscribe) å’Œ push(Subscribe) æ¨¡å¼ï¼Œè™½ç„¶å«åš pull å’Œ pushï¼Œä½†æ˜¯è¿™ä¸¤ç§æœºåˆ¶çš„åº•å±‚å®ç°è¿˜æ˜¯åŸºäº nats çš„ pub / sub æœºåˆ¶ã€‚push ç­‰ä»·äº subscribeï¼ŒæœåŠ¡ç«¯ä¼šå°†æ¶ˆæ¯ç›´æ¥æ¨é€åˆ°å®¢æˆ·ç«¯ï¼›pull åˆ™æ˜¯å®¢æˆ·ç«¯ä¸»åŠ¨è°ƒç”¨ JS API â€è¯·æ±‚â€œï¼ŒæœåŠ¡ç«¯ â€œå“åº”â€ æ•°æ®ç»™å®¢æˆ·ç«¯æ¶ˆè´¹ã€‚å‚è§ä¸‹å›¾æŠ“åŒ…æ•°æ®åˆ†ææˆªå›¾ï¼ˆæå‰åˆ›å»ºäº† stream å’Œ consumerï¼ŒæŒ‡å®šäº†æ‹‰æ¨¡å¼ï¼‰\nnats.go çš„ jetstream åŒ…é’ˆå¯¹ pull consumer æä¾›äº†ä¸°å¯Œçš„APIï¼ˆå°¤å…¶æ˜¯ Consumeï¼‰è®© pull consumer å¯ä»¥å’Œ push consumer ç”¨ç›¸ä¼¼çš„æ–¹å¼æ¥æŒç»­çš„å¤„ç†æ¶ˆæ¯ã€‚\n6.5.2.1 pull æ¨¡å¼ # pullConsumer Consume æ–¹æ³•å®ç°å¦‚ä¸‹ï¼ˆå·²ç²¾ç®€ï¼‰ï¼Œä¸ PullSubscribe.Fetch çš„åŸç†ç±»ä¼¼ï¼ˆè¯·æ±‚ JS APIï¼‰ï¼ŒåŒºåˆ«åœ¨äº API çš„å½¢å¼è¡¨ç°ä¸åŒï¼š\nfunc (p *pullConsumer) Consume(handler MessageHandler, opts ...PullConsumeOpt) (ConsumeContext, error) { // è§£ææ¶ˆè´¹é€‰é¡¹ consumeOpts, err := parseConsumeOpts(false, opts...) if err != nil { return nil, fmt.Errorf(\u0026#34;%w: %s\u0026#34;, ErrInvalidOption, err) } // pull subject æ˜¯ JS.API ä¸‹çš„ä¸€ä¸ª subject // apiRequestNextT string = \u0026#34;CONSUMER.MSG.NEXT.%s.%s\u0026#34; subject := apiSubj(p.jetStream.apiPrefix, fmt.Sprintf(apiRequestNextT, p.stream, p.name)) sub := \u0026amp;pullSubscription{ consumer: p, errs: make(chan error, 1), done: make(chan struct{}, 1), fetchNext: make(chan *pullRequest, 1), consumeOpts: consumeOpts, } // åˆ›å»ºä¸€ä¸ª inbox subject ä½œä¸º pull è¯·æ±‚çš„ replyï¼ŒinternalHandler å°±æ˜¯ MsgHandler inbox := p.jetStream.conn.NewInbox() sub.subscription, err = p.jetStream.conn.Subscribe(inbox, internalHandler) if err != nil { return nil, err } go func() { for { select { case status, ok := \u0026lt;-sub.connStatusChanged: case err := \u0026lt;-sub.errs: if errors.Is(err, ErrNoHeartbeat) { sub.fetchNext \u0026lt;- \u0026amp;pullRequest{ Expires: sub.consumeOpts.Expires, Batch: batchSize, MaxBytes: sub.consumeOpts.MaxBytes, Heartbeat: sub.consumeOpts.Heartbeat, } } } } }() // æ ¹æ® fetchNext é€šçŸ¥å‘æœåŠ¡ç«¯å‘é€ pull è¯·æ±‚ // fetchNext æ˜¯ç”±ä¸€ä¸ª consumeOpts çš„å¿ƒè·³è®¾ç½®çš„ä¸€ä¸ª timer è§¦å‘ ErrNoHeartbeat æ¥æ¿€æ´» go sub.pullMessages(subject) return sub, nil } 6.5.2.2 push æ¨¡å¼ # ä½¿ç”¨ DeliverSubject (æ²¡æœ‰è®¾ç½®ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª) æ¥è®¾ç½®æ¶ˆè´¹è€…è®¢é˜…çš„ä¸»é¢˜ï¼ŒåŒæ—¶åˆ›å»ºä¸€ä¸ªå¯¹è¯¥ä¸»é¢˜çš„è®¢é˜…ï¼Œç”¨äºæ¥æ”¶å¤„ç†æ¶ˆæ¯ã€‚push æ¨¡å¼åŒæ ·ä¼šåœ¨æœåŠ¡å™¨åˆ›å»ºæ¶ˆè´¹è€…ã€‚\nå°ç»“ï¼šå¯¹äºå®¢æˆ·ç«¯æ¥è¯´æ¶ˆè´¹ stream ä¸­çš„æ¶ˆæ¯ï¼Œå…¶å®å°±æ˜¯äº§ç”Ÿä¸€ä¸ªè®¢é˜…ä¸»é¢˜ï¼Œå®¢æˆ·ç«¯ä¼šå¦‚åŒæ™®é€šçš„ SUB å®¢æˆ·ç«¯ä¸€æ ·æ¶ˆè´¹è¿™é‡Œçš„æ¶ˆæ¯ã€‚ä½†åœ¨æ­¤ä¹‹å‰ï¼Œéœ€è¦æ ¹æ®åœºæ™¯å’Œé€‰é¡¹åœ¨æœåŠ¡å™¨åˆ›å»ºä¸€ä¸ª consumerï¼Œå‘Šè¯‰æœåŠ¡ç«¯è‡ªå·±çš„æ¶ˆè´¹åœºæ™¯ï¼ˆæ˜¯å¦æŒä¹…åŒ–ï¼Œå…³æ³¨streamä¸­çš„å“ªäº› subject, æ¶ˆæ¯çš„åˆ†å‘ç­–ç•¥ ç­‰ç­‰ï¼‰\n6.5.3 æ¶ˆæ¯æŠ•é€’æ¨é€ # é€šè¿‡å‰é¢çš„æ¶ˆæ¯æ¶ˆè´¹æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒpullConsumer æ‹‰å–æ¶ˆæ¯æ—¶ä¼šå¾€ä¸€ä¸ªå½¢å¦‚ CONSUMER.MSG.NEXT çš„ä¸»é¢˜ä¸­å‘èµ·è¯·æ±‚ï¼Œé€šè¿‡åœ¨æœåŠ¡ç«¯ä»£ç æ£€ç´¢å¯ä»¥å‘ç°ï¼Œconsumer ç»“æ„å†…ä¿å­˜äº†è¿™ä¹ˆä¸€ä¸ª subject, å¹¶å…³è”äº†å¯¹åº”çš„ icbï¼ˆprocessNextMsgReqï¼‰ï¼Œè€Œè¿™ä¸ªåŠ¨ä½œæ˜¯åœ¨ consumer åˆ›å»ºæ—¶ï¼Œåœ¨ leader èŠ‚ç‚¹ä¸Šè®¾ç½®çš„ï¼ˆconsumer.setLeaderï¼‰ã€‚\nè¿™é‡Œè¦æ³¨æ„ï¼Œè¿™ä¸ªè¯·æ±‚åªèƒ½è¢« consumer group ä¸­çš„ leader å¤„ç†ã€‚\nä¸æ­¤åŒæ—¶ consumer leader èŠ‚ç‚¹è¿˜è®¾ç½®äº†ï¼ˆä¸æ¶ˆè´¹ç›¸å…³çš„æ“ä½œï¼‰:\nackè®¢é˜…ã€è¯·æ±‚è®¢é˜… å’Œ æµæ§è®¢é˜…ç­‰ å¦‚æœæ¶ˆè´¹è€…æ˜¯æ¨æ¨¡å¼ï¼Œé‚£ä¹ˆä¼šæ³¨å†Œâ€œå…´è¶£é€šçŸ¥â€ åŒæ—¶ä¼šå¯åŠ¨å®šæ—¶å™¨æ¥æ¸…é™¤ä¸æ´»è·ƒçš„æ¶ˆè´¹è€… å¯åŠ¨æ¶ˆæ¯æ¨é€çš„ loopAndGatherMsgs é€»è¾‘ï¼Œå¾€ consumer.outq -\u0026gt; stream.outq å‘é€æ¶ˆæ¯, stream.outq åœ¨ stream.internalLoop ä¸­æ‰§è¡Œå¾€å®¢æˆ·ç«¯æ¨é€çš„é€»è¾‘ï¼ˆé€šè¿‡ stream çš„å†…éƒ¨å®¢æˆ·ç«¯å¾€ subject æ¨é€ä¸€æ¡æ¶ˆæ¯ï¼Œä¸ pub æµç¨‹ç±»ä¼¼å†ç”± CORE NATS å®Œæˆæ¶ˆæ¯çš„åˆ†å‘ï¼‰ã€‚ åˆ°è¿™é‡Œæ€»ç»“ä¸‹è¿™ä¸ªç¯èŠ‚çš„é—®é¢˜ï¼š\njetstream publish çš„æ¶ˆæ¯ç»è¿‡äº†ä»€ä¹ˆæ ·çš„æµç¨‹ï¼Ÿ æ¶ˆæ¯åˆ°æœåŠ¡ç«¯åä¼šæ£€æŸ¥ subject ç›¸å…³çš„è®¢é˜…ï¼Œè€Œ stream(leader)è®¾ç½®æ—¶å·²ç»é…ç½®äº†ä¸€ä¸ªå†…éƒ¨è®¢é˜…ã€‚è®¢é˜…ä¼šä¼ æ’­åˆ°é›†ç¾¤ä¸­ã€‚ processInboundJetStreamMsg çš„ç›®çš„å°±æ˜¯å°†å°†æ¶ˆæ¯æäº¤åˆ° raft group, æœ€ç»ˆé€šè¿‡ processJetStreamMsg æ‰§è¡Œã€‚ stream ç»„æäº¤åï¼Œå„ä¸ªå‰¯æœ¬ä¿å­˜ï¼ŒåŒæ—¶é€šçŸ¥ç›¸å…³çš„ consumer server consumerï¼ˆleaderï¼‰ é€šè¿‡ loopAndGatherMsgs å¾€ subject ä¸­æ¨é€æ¶ˆæ¯ server consumer è®¢é˜…äº†å®¢æˆ·ç«¯ ack æ¶ˆæ¯ï¼Œç”¨äºæ›´æ–°æ¶ˆè´¹è€…ä½ç‚¹ç­‰æ•°æ® æ˜¯å…ˆä¿å­˜è¿˜æ˜¯å…ˆæ¨é€ï¼Ÿ åœ¨stream ç»„å†…éƒ¨æäº¤ä¿å­˜åæ¨é€ consumer çš„æ¶ˆæ¯æ˜¯ä» leader æ¥è¿˜æ˜¯å¯ä»¥ä» follower ç›´æ¥è¯»å–ï¼Ÿ leader æœåŠ¡ç«¯ä¸­ stream å’Œ consumer è¿™ä¸¤ä¸ªç»“æ„åœ¨å…¶ä¸­æ‰¿æ‹…ä»€ä¹ˆæ ·çš„èŒè´£ï¼Ÿ stream ä»£è¡¨ stream ï¼ˆåŒ…æ‹¬ store / raft group / stream config) è´Ÿè´£ jetstream ç›¸å…³APIçš„è¯·æ±‚å¤„ç† stream æ¶ˆæ¯ å¤åˆ¶/å­˜å‚¨ é€šçŸ¥/å”¤é†’ç­‰å¾…çš„ consumer consumer ä»£è¡¨ æ¶ˆè´¹è€…ï¼ˆåŒ…æ‹¬æ¶ˆè´¹é…ç½® / raft group ï¼‰ æ³¨æ„å®ƒä¸ç­‰äºå®¢æˆ·ç«¯å®ä¾‹ consumer ç»„å†…çš„æ•°æ®ä¿å­˜ï¼ˆraft groupï¼‰ API å¤„ç†ï¼ˆæ‹‰æ¶ˆè´¹çš„ APIï¼‰ æ¶ˆæ¯æ¨é€ æ¶ˆè´¹ç¡®è®¤å¤„ç† JetStream æ¶ˆæ¯æŠ•é€’API ä¹Ÿæ˜¯åŸºäº PUB / SUB æœºåˆ¶å®ç°çš„ï¼Œä½†æ˜¯å­˜åœ¨çš„åŒºåˆ«æ˜¯ï¼š JetStream æ˜¯å­˜åœ¨ç¡®è®¤æœºåˆ¶çš„ï¼Œè€Œ Core Nats çš„ Publish API å¹¶æ²¡æœ‰ã€‚å› æ­¤è¦ä¸¥æ ¼ä¿è¯æ¶ˆæ¯å‘å¸ƒåˆ° stream ä¸­ï¼Œéœ€è¦ä½¿ç”¨ JetStream çš„ API æ¥å‘é€ã€‚\n7. æ‰©å±• # 7.1 RAFT Consensus Protocol # Consensus is a fundamental problem in fault-tolerant distributed systems. Consensus involves multiple servers agreeing on values. Once they reach a decision on a value, that decision is final.\nå…±è¯†é—®é¢˜æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿå®¹é”™ä¸­çš„åŸºç¡€æ€§é—®é¢˜ï¼Œå®ƒæè¿°çš„æ˜¯ï¼šåœ¨å¤šä¸ªæœåŠ¡èŠ‚ç‚¹é—´å¯¹æŸä¸ªå€¼è¾¾æˆä¸€è‡´ï¼Œä¸€æ—¦è¾¾æˆä¸€è‡´é‚£ä¹ˆè¿™ä¸ªå€¼å°±æ˜¯æœ€ç»ˆçš„ç»“æœã€‚RAFT å°±æ˜¯è§£å†³å…±è¯†é—®é¢˜çš„ä¸€ç§ç®—æ³•ï¼Œå®ƒä»¥ç®€å•è‘—åã€‚\nå¸¸è§çš„ä¸€ç§å®ç°æ˜¯ï¼Œé€šè¿‡ å¤åˆ¶/å¤šå‰¯æœ¬ çš„æ–¹å¼æ¥è§£å†³åˆ†å¸ƒå¼é—®é¢˜ä¸­çš„ å¯é æ€§ é—®é¢˜ã€‚å¸¸è§çš„ï¼Œæˆ‘ä»¬çš„ç³»ç»Ÿæä¾›äº†3ä¸ªå‰¯æœ¬ï¼Œå½“å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹å®•æœºæ—¶ï¼Œä¹Ÿä¸å½±å“ç³»ç»Ÿå¯¹å¤–æä¾›æœåŠ¡ã€‚è€Œ RAFT åˆ™æä¾›ç›¸åº”çš„æœºåˆ¶ï¼ˆé€šè¿‡å½“é€‰çš„é¢†å¯¼è€…è¾¾æˆå…±è¯†ï¼‰æ¥è§£å†³ å¤åˆ¶/å¤šå‰¯æœ¬ è¿‡ç¨‹ä¸­çš„ä¸€è‡´æ€§é—®é¢˜ã€‚\nRaft å¯è§†åŒ–ä»‹ç»ï¼šhttps://thesecretlivesofdata.com/raft/\nå®ƒå…¶ä¸­æœ‰å‡ ä¸ªæ¦‚å¿µï¼š\nLeader Electionï¼ˆé€‰ä¸¾ï¼‰äº§ç”Ÿå”¯ä¸€çš„ä¸€ä¸ª leader è§’è‰²ã€‚ Leader Candidate Follower Vote Term Log Replicationï¼ˆæ—¥å¿—å¤åˆ¶ï¼‰ç”¨äºæœåŠ¡å™¨ä¹‹é—´ä¿æŒä¸€è‡´è¦ç´ ã€‚ Replicated State Machineï¼ˆå¤åˆ¶çŠ¶æ€æœºï¼‰_æ¯ä¸ªæœåŠ¡å™¨å­˜å‚¨ä¸€ä¸ªåŒ…å«ä¸€ç³»åˆ—æŒ‡ä»¤çš„æ—¥å¿—ï¼Œå¹¶ä¸”æŒ‰é¡ºåºæ‰§è¡ŒæŒ‡ä»¤ã€‚ç”±äºæ—¥å¿—éƒ½åŒ…å«ç›¸åŒé¡ºåºçš„æŒ‡ä»¤ï¼ŒçŠ¶æ€æœºä¼šæŒ‰ç…§ç›¸åŒçš„é¡ºåºæ‰§è¡ŒæŒ‡ä»¤ï¼Œç”±äºçŠ¶æ€æœºæ˜¯ç¡®å®šçš„ï¼ˆdeterministicï¼‰ï¼Œå› æ­¤çŠ¶æ€æœºä¼šäº§ç”Ÿç›¸åŒçš„ç»“æœã€‚ 7.2 Gossip Protocol # å®ƒåŸºäºæµè¡Œç—…ä¼ æ’­æ–¹å¼çš„èŠ‚ç‚¹æˆ–è€…è¿›ç¨‹ä¹‹é—´ä¿¡æ¯äº¤æ¢çš„åè®®ã€‚ä»¥ç»™å®šçš„é¢‘ç‡ï¼Œæ¯å°è®¡ç®—æœºéšæœºé€‰æ‹©å¦ä¸€å°è®¡ç®—æœºï¼Œå¹¶å…±äº«ä»»ä½•æ¶ˆæ¯ã€‚\nå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š\nå¦‚æœæœ‰æŸä¸€é¡¹ä¿¡æ¯éœ€è¦åœ¨æ•´ä¸ªç½‘ç»œä¸­æ‰€æœ‰èŠ‚ç‚¹ä¸­ä¼ æ’­ï¼Œé‚£ä»ä¿¡æ¯æºå¼€å§‹ï¼Œé€‰æ‹©ä¸€ä¸ªå›ºå®šçš„ä¼ æ’­å‘¨æœŸï¼ˆè­¬å¦‚ 1 ç§’ï¼‰ï¼Œéšæœºé€‰æ‹©å®ƒç›¸è¿æ¥çš„ k ä¸ªèŠ‚ç‚¹ï¼ˆç§°ä¸º Fan-Outï¼‰æ¥ä¼ æ’­æ¶ˆæ¯ã€‚ æ¯ä¸€ä¸ªèŠ‚ç‚¹æ”¶åˆ°æ¶ˆæ¯åï¼Œå¦‚æœè¿™ä¸ªæ¶ˆæ¯æ˜¯å®ƒä¹‹å‰æ²¡æœ‰æ”¶åˆ°è¿‡çš„ï¼Œå°†åœ¨ä¸‹ä¸€ä¸ªå‘¨æœŸå†…ï¼Œé€‰æ‹©é™¤äº†å‘é€æ¶ˆæ¯ç»™å®ƒçš„é‚£ä¸ªèŠ‚ç‚¹å¤–çš„å…¶ä»–ç›¸é‚» k ä¸ªèŠ‚ç‚¹å‘é€ç›¸åŒçš„æ¶ˆæ¯ï¼Œç›´åˆ°æœ€ç»ˆç½‘ç»œä¸­æ‰€æœ‰èŠ‚ç‚¹éƒ½æ”¶åˆ°äº†æ¶ˆæ¯ï¼Œå°½ç®¡è¿™ä¸ªè¿‡ç¨‹éœ€è¦ä¸€å®šæ—¶é—´ï¼Œä½†æ˜¯ç†è®ºä¸Šæœ€ç»ˆç½‘ç»œçš„æ‰€æœ‰èŠ‚ç‚¹éƒ½ä¼šæ‹¥æœ‰ç›¸åŒçš„æ¶ˆæ¯ã€‚ å®ƒå¯¹ç½‘ç»œèŠ‚ç‚¹çš„ è¿é€šæ€§å’Œç¨³å®šæ€§ å‡ ä¹æ²¡æœ‰ä»»ä½•è¦æ±‚ï¼Œå®ƒä¸€å¼€å§‹å°±å°†ç½‘ç»œæŸäº›èŠ‚ç‚¹åªèƒ½ä¸ä¸€éƒ¨åˆ†èŠ‚ç‚¹_éƒ¨åˆ†è¿é€šï¼ˆPartially Connected Networkï¼‰è€Œä¸æ˜¯ä»¥å…¨è¿é€šç½‘ç»œ_ï¼ˆFully Connected Networkï¼‰ä½œä¸ºå‰æï¼›æ²¡æœ‰ä»»ä½•ä¸­å¿ƒåŒ–èŠ‚ç‚¹æˆ–è€…ä¸»èŠ‚ç‚¹çš„æ¦‚å¿µã€‚\nç›¸åº”çš„å®ƒçš„ç¼ºç‚¹æ˜¯ï¼šæ— æ³•å‡†ç¡®åœ°é¢„è®¡åˆ°éœ€è¦å¤šé•¿æ—¶é—´æ‰èƒ½è¾¾æˆå…¨ç½‘ä¸€è‡´ï¼›ä¹Ÿå­˜åœ¨é‡å¤ä¼ æ’­çš„æ¦‚ç‡ï¼Œæ¶ˆæ¯åœ¨ç½‘è·¯ä¸­å†—ä½™ã€‚\nç”±æ­¤ï¼ŒGossip è®¾è®¡äº†ä¸¤ç§å¯èƒ½çš„æ¶ˆæ¯ä¼ æ’­æ¨¡å¼ï¼šåç†µï¼ˆAnti-Entropyï¼‰å’Œä¼ è°£ï¼ˆRumor-Mongeringï¼‰ï¼š\nåç†µï¼šä¼šåŒæ­¥èŠ‚ç‚¹çš„å…¨éƒ¨æ•°æ®ï¼Œä»¥æ¶ˆé™¤å„èŠ‚ç‚¹ä¹‹é—´çš„å·®å¼‚ï¼Œç›®æ ‡æ˜¯æ•´ä¸ªç½‘ç»œå„èŠ‚ç‚¹å®Œå…¨çš„ä¸€è‡´ã€‚ ä¼ è°£ï¼šä»…ä»…å‘é€æ–°åˆ°è¾¾èŠ‚ç‚¹çš„æ•°æ®ï¼Œå³åªå¯¹å¤–å‘é€å˜æ›´ä¿¡æ¯ã€‚ åœ¨ Nats ä¸­ï¼Œgossip è¢«ç”¨äºå®ç° é›†ç¾¤æœåŠ¡å‘ç° https://docs.nats.io/reference/reference-protocols/nats-server-protocolã€‚routes é‡ŒæŒ‡å®šäº†ä¸€ä¸ªç§å­æœåŠ¡å™¨ï¼Œæ–°å¯åŠ¨çš„æœåŠ¡å™¨è¿æ¥ä¸Šç§å­æœåŠ¡å™¨åï¼Œå°±å¯ä»¥è·å–åˆ°å…¨éƒ¨çš„æœåŠ¡å™¨åˆ—è¡¨ã€‚åœ¨æœåŠ¡å™¨çš„é…ç½®é‡Œï¼Œå¯ä»¥ä¸ç”¨çŸ¥é“æ‰€æœ‰çš„èŠ‚ç‚¹ï¼Œè€Œåªç”¨é…ç½®ä¸€ä¸ªå³å¯ï¼Œä½†é€šå¸¸ä¸ºäº†é…ç½®ç®€å•ï¼Œä¼šç»Ÿä¸€ä½¿ç”¨ä¸€ä¸ªç§å­æœåŠ¡å™¨ã€‚å¦‚ä¸‹ï¼š\nnats-server -D -p 4222 -cluster nats://localhost:6222 nats-server -D -p 4333 -cluster nats://localhost:6333 -routes nats://localhost:6222 nats-server -D -p 4444 -cluster nats://localhost:6444 -routes nats://localhost:6222 // ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å¯åŠ¨ä¹Ÿæ˜¯å¯è¡Œçš„ nats-server -D -p 4444 -cluster nats://localhost:6444 -routes nats://localhost:6333 å¯ä»¥å‚è§æœåŠ¡å¯åŠ¨ / é›†ç¾¤çš„æµç¨‹ã€‚\n7.3 Zero allocation byte parser # https://www.youtube.com/watch?v=ylRKac5kSOk\u0026t=646s é›¶åˆ†é… çš„å«ä¹‰æ˜¯ï¼šnats åœ¨è§£æåè®®æ—¶ï¼Œé¿å…ä¸å¿…è¦çš„å†…å­˜åˆ†é…ï¼š\nä½¿ç”¨å±€éƒ¨å˜é‡ï¼Œåœ¨æ ˆä¸Šåˆ†é…\nä½¿ç”¨ slice å¤ç”¨åº•å±‚æ•°ç»„\né‡‡ç”¨çŠ¶æ€æœºæ¥è§£æåè®®çš„å„ä¸ªéƒ¨åˆ†ï¼Œè€Œä¸æ˜¯æ„å»ºä¸´æ—¶å¯¹è±¡æ¥å­˜å‚¨ä¸­é—´çŠ¶æ€ã€‚å¦‚: ä¸€èˆ¬æƒ…å†µä¸‹è§£æå¦‚ä¸‹åè®®æ—¶ï¼Œæœ€å¸¸è§„çš„æ€è·¯å°±æ˜¯ï¼Œå…ˆæŠŠ Command(PUB) è¯»å‡ºæ¥ï¼Œç„¶åæ ¹æ®è¿™ä¸ªcommand å†³å®šè¦åé¢çš„æ“ä½œï¼Œè¿™é‡Œå†è¯»å»ä¸¤ä¸ªå‚æ•° subject, payload length, æœ‰äº† length ä¹‹åå†è¯»å» payloadï¼Œè¿™æ ·æˆ‘ä»¬å°±åˆ›å»ºäº†_4ä¸ªä¸´æ—¶å˜é‡_åœ¨è¡¨ç¤ºä¸‹é¢çš„å‘½ä»¤ã€‚\nPUB foo.bar 7 goodbye åœ¨ nats ä¸­åˆ™æ˜¯é€šè¿‡çŠ¶æ€æœºï¼Œä¸€æ­¥ä¸€æ­¥çš„è§£æä¸­é—´æ²¡æœ‰ä½¿ç”¨ä¸´æ—¶å˜é‡æ¥å­˜å‚¨å‘½ä»¤ä¸­çš„æ•°æ®ã€‚\né¿å…ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œç½‘ç»œIOåœºæ™¯ä¸­ï¼Œæ“ä½œçš„å¯¹è±¡å‡ ä¹éƒ½æ˜¯å­—èŠ‚ï¼Œå› æ­¤ nats parser ä¹Ÿé¿å…ä½¿ç”¨å­—ç¬¦ä¸²ä»¥å‡å°‘å†…å­˜åˆ†é…å’Œæ‹·è´ã€‚\n7.4Â Nats CLI # https://docs.nats.io/using-nats/nats-tools/nats_cli èƒ½æ–¹ä¾¿å¿«æ·çš„ä¸ nats äº¤äº’ / æ¨¡æ‹Ÿ / æµ‹è¯•ã€‚\n"},{"id":15,"href":"/2023/11/17/%E5%9C%A8istio%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC%E4%B8%AD%E6%89%A9%E5%B1%95%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8A%9F%E8%83%BD/","title":"åœ¨istioæœåŠ¡ç½‘æ ¼ä¸­æ‰©å±•è‡ªå®šä¹‰åŠŸèƒ½","section":"Posts","content":" å‰æ # æœ¬æ–‡å‡è®¾ä½ å·²ç»å¯¹ Kubernetesã€istio å’Œ Envoy æœ‰ä¸€å®šçš„äº†è§£ï¼Œå¦‚æœä½ è¿˜ä¸äº†è§£ï¼Œå¯ä»¥å…ˆé˜…è¯»ä¸‹é¢çš„æ–‡ç« ï¼š\nKubernetes: https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/ istio: https://istio.io/latest/docs/concepts/what-is-istio/ Envoy: https://www.envoyproxy.io/docs/envoy/latest/intro/what_is_envoy å½“ç„¶ä¸ä»…é™äºçŸ¥é“è¿™äº›ï¼Œè¿˜éœ€è¦å¯¹å…¶æœ‰ä¸€å®šçš„å®è·µç»éªŒï¼Œè¿™æ ·æ‰èƒ½æ›´å¥½çš„ç†è§£æœ¬æ–‡çš„å†…å®¹ã€‚å½“ç„¶æœ¬æ–‡ä¹Ÿä¸ä¼šæ¶‰åŠå¤ªæ·±ï¼Œåªæ˜¯ä½œä¸º istio çš„ä¸€ä¸ªå…¥é—¨æ‰©å±•æ•™ç¨‹ã€‚\nä¸ºä»€ä¹ˆè¦æ‰©å±•åŠŸèƒ½ï¼Ÿ#èƒŒæ™¯ # ç”¨é€šä¿—çš„è¯å»ç†è§£ istio çš„ä½œç”¨å°±æ˜¯ï¼Œå¯¹æˆ‘ä»¬éƒ¨ç½²åœ¨ kubernetes ä¸Šçš„åº”ç”¨è¿›è¡Œæµé‡æ§åˆ¶ï¼ˆä»£ç†ï¼‰ï¼Œç»™æˆ‘ä»¬æä¾›äº†ï¼šæµé‡æ§åˆ¶ã€æµé‡ç›‘æ§ã€æµé‡å®‰å…¨ç­‰åŠŸèƒ½ã€‚ä½†æ˜¯åœ¨å®é™…çš„ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¼šé‡åˆ°ä¸€äº›ç‰¹æ®Šçš„åœºæ™¯ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±åŸºäºè‡ªå·±çš„ä¸šåŠ¡åœºæ™¯å»æ‰©å±•ä¸€äº›åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼šip ç™½åå•ã€ip é»‘åå•ã€ç»Ÿä¸€è®¤è¯ç­‰ã€‚è¿™äº›åŠŸèƒ½å¾€å¾€å’Œå…·ä½“å…¬å¸çš„ä¸šåŠ¡åœºæ™¯æœ‰å…³ï¼Œå› æ­¤ istio æ— æ³•ç›´æ¥æä¾›è¿™äº›åŠŸèƒ½ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±å»æ‰©å±•ã€‚\nä¼ ç»Ÿçš„æ‰©å±•æ–¹å¼ # åœ¨ä¼ ç»Ÿæ¶æ„ä¸­ï¼Œå¸¸å¸¸é€šè¿‡ API ç½‘å…³è¿™ä¸€ç»„ä»¶æ¥å®ç°è¿™ä¸€äº›æ‰©å±•èƒ½åŠ›ï¼Œå¸¸ç”¨çš„ API ç½‘å…³æœ‰ï¼škongã€apisixã€openrestyï¼Œè€Œæ‰©å±•çš„åŸç†å°±æ˜¯æ’ä»¶ï¼Œæˆ–è€…åƒ nginx/openresty åœ¨è¯·æ±‚é“¾ä¸­çš„ä¸åŒé˜¶æ®µæä¾›äº†ä¸åŒçš„ hookï¼Œæˆ‘ä»¬å¯ä»¥åŸºäºè¿™äº› hook æ¥å®ç°æ‰©å±•åŠŸèƒ½ã€‚\nå°±æˆ‘ä¸ªäººçš„ç»å†æ¥è¯´ï¼Œç½‘å…³è¦ä¹ˆè‡ªå·±å®šåˆ¶å¼€å‘ï¼Œè¦ä¹ˆåŸºäºopenrestyæ¥å®ç°ï¼Œåˆæˆ–è€…ä½¿ç”¨ä¸€äº›å¼€æºçš„ç½‘å…³ï¼Œå¦‚ï¼škongã€apisixï¼Œåœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡ŒäºŒæ¬¡å¼€å‘ã€‚ä¸è¿‡è¿™äº›æ–¹å¼éƒ½æ˜¯åœ¨ä¼ ç»ŸAPIç½‘å…³ä¸­å»å®ç°çš„ï¼Œéšç€ Service Mesh çš„å‘å±•ï¼ŒAPIç½‘å…³çš„æŸäº›åŠŸèƒ½ä¹Ÿè¢« Sidecar ä»£ç†æ‰€å–ä»£ï¼Œæ¯”å¦‚ï¼šæµé‡æ§åˆ¶ã€æµé‡ç›‘æ§ã€æµé‡å®‰å…¨ç­‰ã€‚ç›®å‰ Mesh å‘å±•çš„è¶‹åŠ¿ä¹Ÿæ˜¯è¿›ä¸€æ­¥åœ¨ Sidecar ä»£ç†ä¸­å®ç°æ›´å¤šçš„åŠŸèƒ½ï¼Œè€Œä¸æ˜¯åœ¨ API ç½‘å…³ä¸­å®ç°ã€‚\nEnvoy çš„æ‰©å±•èƒ½åŠ› # https://www.envoyproxy.io/docs/envoy/latest/extending/extending https://www.youtube.com/watch?v=XdWmm_mtVXI envoy æä¾›äº†ä¸°å¯Œçš„æ‰©å±•èƒ½åŠ›ï¼ŒAccess Logger, Access Log Filter, Clusters, Listen Filter, Network Filter, HTTP Filter ç­‰ç­‰ã€‚è¿™ä¸€å—å†…å®¹éå¸¸å¤šï¼Œå¦‚æœæƒ³è¦äº†è§£æ›´å¤šï¼Œè¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚\nistio çš„æ‰©å±•èƒ½åŠ› # https://istio.io/latest/docs/reference/config/networking/envoy-filter/\nistio ä½œä¸ºä¸€ä¸ª Service Mesh æ¡†æ¶ï¼Œå…¶åº•å±‚çš„ä»£ç†æ˜¯ Envoyï¼Œå› æ­¤ istio ä¹Ÿç»§æ‰¿äº† Envoy çš„æ‰©å±•èƒ½åŠ›ã€‚istio æä¾›äº† EnvoyFilter è¿™æ ·ä¸€ç§è‡ªå®šä¹‰ istio Pilot ç”Ÿæˆçš„ Envoy é…ç½®çš„æœºåˆ¶ã€‚å¯ä»¥ä¿®æ”¹æŸäº›å­—æ®µçš„å€¼ã€æ·»åŠ ç‰¹å®šè¿‡æ»¤å™¨ã€‚å¯¹äºç‰¹å®šå‘½åç©ºé—´ä¸­çš„ç»™å®šå·¥ä½œè´Ÿè½½ï¼Œå¯ä»¥å­˜åœ¨ä»»æ„æ•°é‡çš„ EnvoyFilterã€‚è¿™äº› EnvoyFilter çš„åº”ç”¨é¡ºåºå¦‚ä¸‹ï¼šé…ç½®æ ¹å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰ EnvoyFilterï¼Œç„¶åæ˜¯å·¥ä½œè´Ÿè½½å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰åŒ¹é…çš„ EnvoyFilterã€‚\néœ€è¦è°¨æ…çš„ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ï¼Œå› ä¸ºé”™è¯¯çš„é…ç½®ä¼šå½±å“æ•´ä¸ªç½‘æ ¼çš„ç¨³å®šæ€§ã€‚\nå®è·µï¼šå®ç°ä¸€ä¸ªè¯·æ±‚å‚æ•°æ”¹å†™è¯·æ±‚å¤´çš„åŠŸèƒ½ # å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªä¸šåŠ¡åœºæ™¯ï¼Œéœ€è¦å°†è¯·æ±‚å‚æ•°ä¸­çš„ cvn å‚æ•°çš„å€¼ï¼Œæ”¹å†™åˆ°è¯·æ±‚å¤´ä¸­çš„ x-istio-cvn å‚æ•°ä¸­ï¼Œé‚£æˆ‘ä»¬åº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ç”¨ä¼ªä»£ç æ¥ç®€å•æ¢³ç†ä¸‹é€»è¾‘ï¼š\nfunction rewrite_cvn_to_header() cvn = request.query_params.cvn request.headers.set(\u0026#34;x-istio-cvn\u0026#34;, cvn) end ç¼–å†™ EnvoyFilter # ä» envoy çš„æ‰©å±•èƒ½åŠ›ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ª HTTP Filterï¼Œç”¨äºåœ¨è¯·æ±‚åˆ°è¾¾ Sidecar ä»£ç†æ—¶ï¼Œå¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œå°†è¯·æ±‚å‚æ•°ä¸­çš„ cvn å‚æ•°çš„å€¼ï¼Œæ”¹å†™åˆ°è¯·æ±‚å¤´ä¸­çš„ x-client-cvn å‚æ•°ä¸­ã€‚è€Œåœ¨ istio ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ª EnvoyFilter èµ„æºï¼Œç”¨äºå°† HTTP Filter æ³¨å…¥åˆ° Envoy ä¸­ã€‚\napiVersion: networking.istio.io/v1alpha3 kind: EnvoyFilter metadata: name: cvn-rewrite # EnvoyFilter çš„åç§° namespace: istio-system # EnvoyFilter æ‰€åœ¨çš„å‘½åç©ºé—´, ä½œç”¨äº ingressgateway spec: workloadSelector: labels: istio: ingressgateway configPatches: - applyTo: HTTP_FILTER # åº”ç”¨äº HTTP_FILTER match: context: GATEWAY # ä½œç”¨äº GATEWAY listener: filterChain: filter: name: envoy.filters.network.http_connection_manager subFilter: name: envoy.filters.http.router patch: operation: INSERT_BEFORE # åœ¨ envoy.router ä¹‹å‰æ’å…¥ value: name: envoy.lua typed_config: \u0026#34;@type\u0026#34;: \u0026#34;type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua\u0026#34; inlineCode: | function envoy_on_request(request_handle) local cvn = request_handle:headers():get(\u0026#34;:path\u0026#34;):match(\u0026#34;cvn=([%w%.%-]+)\u0026#34;) if cvn == nil then cvn = \u0026#34;default\u0026#34; end request_handle:headers():add(\u0026#34;x-client-cvn\u0026#34;, cvn) end å¦‚æœæƒ³è¦äº†è§£ envoy ä¸­å…³äº lua æ›´å¤šçš„æ‰©å±•å†…å®¹ï¼Œä¸€å®šè¦å…ˆé€šè¯»ä¸‹å®˜æ–¹æ–‡æ¡£ï¼Œåœ°å€åœ¨æ­¤ï¼šhttps://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/lua_filter.html#lua\néƒ¨ç½² # ä¸ºäº†æ–¹ä¾¿æµ‹è¯•æˆ‘ä»¬å¯ä»¥ç¼–å†™è¿™ä¹ˆä¸€ä¸ªåº”ç”¨ç”¨äºæ‰“å°è¯·æ±‚å¤´ï¼š\napp.py æœåŠ¡ä»£ç ï¼š\nfrom flask import Flask, request app = Flask(__name__) @app.route(\u0026#34;/\u0026#34;) def index(): print(request.headers) dict = {} for key, value in request.headers: dict[key] = value return dict if __name__ == \u0026#34;__main__\u0026#34;: app.run(host=\u0026#34;0.0.0.0\u0026#34;, port=8080) Dockerfile æ–‡ä»¶è¿›è¡Œæ‰“åŒ…ï¼š\nnerdctl.lima build -t docker.io/yeqown/istio-envoy-filter-demo:0.0.1 . --build-arg VERSION=0.0.1 å¦‚æœä¸æƒ³è‡ªå·±æ‰“åŒ…ï¼Œå¯ä»¥ç›´æ¥ç”¨æˆ‘çš„é•œåƒï¼šdocker.io/yeqown/istio-envoy-filter-demo:0.0.1\nFROM python:3.8-slim-buster WORKDIR /app COPY . . RUN pip install flask EXPOSE 8080 CMD [\u0026#34;python\u0026#34;, \u0026#34;app.py\u0026#34;] k8s èµ„æºé…ç½® deployment.yaml æ–‡ä»¶ï¼š\napiVersion: apps/v1 kind: Deployment metadata: name: istio-envoy-filter-demo namespace: default labels: app: istio-envoy-filter-demo spec: selector: matchLabels: app: istio-envoy-filter-demo replicas: 1 template: metadata: labels: app: istio-envoy-filter-demo spec: containers: - name: istio-envoy-filter-demo image: docker.io/yeqown/istio-envoy-filter-demo:0.0.1 imagePullPolicy: IfNotPresent ports: - containerPort: 8080 --- apiVersion: v1 kind: Service metadata: name: istio-envoy-filter-demo namespace: default spec: selector: app: istio-envoy-filter-demo ports: - name: http-port port: 8080 targetPort: 8080 deployment.networking.yaml istio é…ç½®æ–‡ä»¶ï¼š\napiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: istio-envoy-filter-demo namespace: default spec: hosts: - \u0026#34;*\u0026#34; gateways: - istio-envoy-filter-demo-gateway http: - name: \u0026#34;istio-envoy-filter-demo\u0026#34; match: - uri: exact: /istio-envoy-filter-demo rewrite: uri: / route: - destination: host: istio-envoy-filter-demo.default.svc.cluster.local --- apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: istio-envoy-filter-demo-gateway namespace: default spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - \u0026#34;*\u0026#34; å°†è¿™äº›æ–‡ä»¶éƒ½éƒ¨ç½²åï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹çš„å‘½ä»¤æ¥æ£€æŸ¥æ—¶é“¾è·¯æ˜¯å¦é€šç•…ï¼š\nINGRESS_HOST=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=\u0026#39;{.status.loadBalancer.ingress[0].ip}\u0026#39;) INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=\u0026#39;{.spec.ports[?(@.name==\u0026#34;http2\u0026#34;)].port}\u0026#39;) curl -X GET -v http://$INGRESS_HOST:$INGRESS_PORT/istio-envoy-filter-demo # \u0026gt; GET /istio-envoy-filter-demo HTTP/1.1 # \u0026gt; Host: 10.96.133.213 # \u0026gt; User-Agent: curl/8.4.0 # \u0026gt; Accept: */* # \u0026gt; # \u0026lt; HTTP/1.1 200 OK # \u0026lt; server: istio-envoy # \u0026lt; date: Wed, 27 Dec 2023 06:56:18 GMT # \u0026lt; content-type: application/json # \u0026lt; content-length: 691 # \u0026lt; x-envoy-upstream-service-time: 1 # \u0026lt; # { [691 bytes data] # 100 691 100 691 0 0 182k 0 --:--:-- --:--:-- --:--:-- 224k # * Connection #0 to host 10.96.133.213 left intact # { # \u0026#34;Accept\u0026#34;: \u0026#34;*/*\u0026#34;, # \u0026#34;Host\u0026#34;: \u0026#34;10.96.133.213\u0026#34;, # \u0026#34;User-Agent\u0026#34;: \u0026#34;curl/8.4.0\u0026#34;, # \u0026#34;X-B3-Parentspanid\u0026#34;: \u0026#34;914dc42200412837\u0026#34;, # \u0026#34;X-B3-Sampled\u0026#34;: \u0026#34;1\u0026#34;, # \u0026#34;X-B3-Spanid\u0026#34;: \u0026#34;8c40029a531c2e93\u0026#34;, # \u0026#34;X-B3-Traceid\u0026#34;: \u0026#34;c992738f6d8be43e914dc42200412837\u0026#34;, # \u0026#34;X-Envoy-Attempt-Count\u0026#34;: \u0026#34;1\u0026#34;, # \u0026#34;X-Envoy-Internal\u0026#34;: \u0026#34;true\u0026#34;, # \u0026#34;X-Envoy-Original-Path\u0026#34;: \u0026#34;/istio-envoy-filter-demo\u0026#34;, # \u0026#34;X-Forwarded-Client-Cert\u0026#34;: \u0026#34;By=spiffe://cluster.local/ns/default/sa/default;Hash=da144c5982372ecb6463dbfed384d2c4430f7ebfd5e4f5183238f19f8efb565a;Subject=\\\u0026#34;\\\u0026#34;;URI=spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account\u0026#34;, # \u0026#34;X-Forwarded-For\u0026#34;: \u0026#34;10.244.0.1\u0026#34;, # \u0026#34;X-Forwarded-Proto\u0026#34;: \u0026#34;http\u0026#34;, # \u0026#34;X-Request-Id\u0026#34;: \u0026#34;f94024c6-8948-9a1c-af4c-aec40c395f8a\u0026#34; # } è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°ï¼Œè¯·æ±‚å¤´ä¸­é™¤äº†å¸¸è§çš„ Accept, Host, User-Agent è¿˜å¤šäº†ä¸€äº›ï¼Œå¦‚ï¼šX-B3-Parentspanid, X-Request-Id ç­‰ï¼Œè¿™äº›éƒ½æ˜¯ istio ä¸ºæˆ‘ä»¬æä¾›çš„åŠŸèƒ½ï¼Œç”¨äºé“¾è·¯è¿½è¸ªï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™äº›å‚æ•°æ¥è¿½è¸ªè¯·æ±‚çš„é“¾è·¯ã€‚å½“ç„¶å…¶ä¸­æ²¡æœ‰åŒ…å« x-client-cvn å› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰éƒ¨ç½² EnvoyFilterã€‚\néƒ¨ç½²å¹¶æµ‹è¯•è‡ªå®šä¹‰ envoyFilter # å°†ä¸Šé¢ç¼–å†™çš„ EnvoyFilter éƒ¨ç½²åˆ° k8s ä¸­ï¼š\nkubectl apply -f envoyfilter.yaml å°†è¿™ä¸ªèµ„æºéƒ½åº”ç”¨åˆ° k8s ä¹‹åï¼Œæˆ‘ä»¬å†æ¬¡è®¿é—®æœåŠ¡ï¼Œå¯ä»¥çœ‹åˆ°è¯·æ±‚å¤´ä¸­å¤šäº†ä¸€ä¸ª x-client-cvn å‚æ•°ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ EnvoyFilter æ‰€åšçš„äº‹æƒ…ã€‚\ncurl -X GET -v http://$INGRESS_HOST:$INGRESS_PORT/istio-envoy-filter-demo?cvn=v1.2.3-hotfix # * Connected to 10.96.133.213 (10.96.133.213) port 80 # \u0026gt; GET /istio-envoy-filter-demo?cvn=v1.2.3-hotfix HTTP/1.1 # \u0026gt; Host: 10.96.133.213 # \u0026gt; User-Agent: curl/8.4.0 # \u0026gt; Accept: */* # \u0026gt; # \u0026lt; HTTP/1.1 200 OK # \u0026lt; server: istio-envoy # \u0026lt; date: Wed, 27 Dec 2023 06:55:32 GMT # \u0026lt; content-type: application/json # \u0026lt; content-length: 715 # \u0026lt; x-envoy-upstream-service-time: 7 # \u0026lt; # { [715 bytes data] # 100 715 100 715 0 0 78857 0 --:--:-- --:--:-- --:--:-- 79444 # * Connection #0 to host 10.96.133.213 left intact # { # \u0026#34;Accept\u0026#34;: \u0026#34;*/*\u0026#34;, # \u0026#34;Host\u0026#34;: \u0026#34;10.96.133.213\u0026#34;, # \u0026#34;User-Agent\u0026#34;: \u0026#34;curl/8.4.0\u0026#34;, # \u0026#34;X-B3-Parentspanid\u0026#34;: \u0026#34;ea5a04a5505b30f2\u0026#34;, # \u0026#34;X-B3-Sampled\u0026#34;: \u0026#34;1\u0026#34;, # \u0026#34;X-B3-Spanid\u0026#34;: \u0026#34;579aefbe55ff1859\u0026#34;, # \u0026#34;X-B3-Traceid\u0026#34;: \u0026#34;22daad86fc4471d2ea5a04a5505b30f2\u0026#34;, # \u0026#34;X-Client-Cvn\u0026#34;: \u0026#34;v1.2.3-hotfix\u0026#34;, # \u0026#34;X-Envoy-Attempt-Count\u0026#34;: \u0026#34;1\u0026#34;, # \u0026#34;X-Envoy-Internal\u0026#34;: \u0026#34;true\u0026#34;, # \u0026#34;X-Envoy-Original-Path\u0026#34;: \u0026#34;/istio-envoy-filter-demo?cvn=v1.2.3-hotfix\u0026#34;, # \u0026#34;X-Forwarded-Client-Cert\u0026#34;: \u0026#34;By=spiffe://cluster.local/ns/default/sa/default;Hash=da144c5982372ecb6463dbfed384d2c4430f7ebfd5e4f5183238f19f8efb565a;Subject=\\\u0026#34;\\\u0026#34;;URI=spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account\u0026#34;, # \u0026#34;X-Forwarded-For\u0026#34;: \u0026#34;10.244.0.1\u0026#34;, # \u0026#34;X-Forwarded-Proto\u0026#34;: \u0026#34;http\u0026#34;, # \u0026#34;X-Request-Id\u0026#34;: \u0026#34;c5041ac1-8b18-9999-be44-63bc6fbfa885\u0026#34; # } åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å®Œæˆäº†ä¸€ä¸ªç®€å•çš„è‡ªå®šä¹‰ EnvoyFilter çš„åŠŸèƒ½ï¼šåœ¨ç½‘å…³å¤„å°†æŸ¥è¯¢å‚æ•° cvn è½¬è¯·æ±‚å¤´ X-Client-Cvn ï¼Œå½“ç„¶è¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå®é™…çš„ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åŸºäº Envoy çš„æ‰©å±•æœºåˆ¶ï¼Œå®ç°æ›´å¤šçš„åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼šip ç™½åå•ã€ip é»‘åå•ã€ç»Ÿä¸€è®¤è¯ç­‰ã€‚\næ‰€æœ‰ä»£ç éƒ½å¯ä»¥åœ¨ï¼šhttps://github.com/yeqown/playground/tree/master/k8s/istio-envoy-filter æ‰¾åˆ°ã€‚\nå‚è€ƒèµ„æ–™ # istio: EnvoyFilter Envoy: Lua Filter envoy WASM "},{"id":16,"href":"/2023/10/10/fsnotify%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/","title":"fsnotifyåŸç†æ¢ç©¶","section":"Posts","content":" æœ¬æ–‡å¦‚æœæ²¡æœ‰ç‰¹æ®Šè¯´æ˜ï¼Œæ‰€æœ‰çš„å†…å®¹éƒ½æ˜¯æŒ‡ linux ç³»ç»Ÿ\nèµ·å› æ˜¯ä» kratos ç¾¤é‡Œçœ‹åˆ°æœ‰äººé—®ï¼šâ€œæµ‹äº†ä¸‹kratosçš„config watchï¼Œå¥½åƒå¯¹è½¯é“¾ä¸ç”Ÿæ•ˆâ€ï¼Œä»–æä¾›çš„å±å¹•æˆªå›¾å¦‚ä¸‹ç±»ä¼¼ï¼š\n$ pwd /tmp/testconfig $ ls -l drwxr-xr-x 3 root root 4096 Oct 10 19:48 . drwxr-xr-x 10 root root 4096 Oct 10 19:48 .. drwxr-xr-x 1 root root 11 Oct 10 19:48 ..ver1 drwxr-xr-x 1 root root 11 Oct 10 19:48 ..ver2 lrwxr-xr-x 1 root root 11 Oct 10 19:48 ..data -\u0026gt; ..ver1 drwxr-xr-x 1 root root 11 Oct 10 19:48 data $ $ ll -a data drwxr-xr-x 3 root root 4096 Oct 10 19:48 . drwxr-xr-x 10 root root 4096 Oct 10 19:48 .. lrwxrwxrwx 1 root root 11 Oct 10 19:48 registry.yaml -\u0026gt; /tmp/testconfig/..data/registry.yaml ç„¶åè§¦å‘æ›´æ–°çš„åŠ¨ä½œå…¶å®æ˜¯æŠŠ ..data çš„æºæ”¹æˆäº† ..ver2ï¼Œä½†æ˜¯å‘ç°å¹¶æ²¡æœ‰è§¦å‘æ›´æ–°ï¼Œäºæ˜¯å°±é—®äº†ä¸€ä¸‹ã€‚\nçœ‹åˆ°è¿™ä¸ªé—®é¢˜çš„ç¬¬ä¸€ååº”æ˜¯ï¼šè½¯é“¾æ¥çš„æ–‡ä»¶æ— æ³•ç›‘æ§ï¼Œé‚£ä¹ˆç¡¬é“¾æ¥çš„æ–‡ä»¶å¯ä»¥ç›‘æ§å—ï¼Ÿï¼ˆç¬¬ä¸€ååº”æ˜¯è½¯é“¾æ¥çš„å®ç°å†³å®šï¼‰äºæ˜¯ä¾¿å›å¤è®©è¿™ä½å°ä¼™ä¼´æ˜¯å¦ç¡¬é“¾æ¥å¯ä»¥ï¼Œä»–ç»™ç­”å¤æ˜¯å¯ä»¥ã€‚\nçªç„¶æˆ‘è„‘æµ·é‡Œå†’å‡ºäº†ä¸¤ä¸ªé—®é¢˜ï¼š\nQ1 è½¯é“¾æ¥å’Œç¡¬é“¾æ¥çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ Q2 fsnotify çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ è½¯é“¾æ¥å’Œç¡¬é“¾æ¥çš„åŒºåˆ« # åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œè½¯é“¾æ¥å’Œç¡¬é“¾æ¥çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ\nç‰¹ç‚¹/æ“ä½œ è½¯é“¾æ¥ ç¡¬é“¾æ¥ åˆ›å»º ln -s æºæ–‡ä»¶ ç›®æ ‡æ–‡ä»¶ ln æºæ–‡ä»¶ ç›®æ ‡æ–‡ä»¶ åˆ›å»ºï¼ˆæºæ–‡ä»¶ä¸å­˜åœ¨ï¼‰ å¯ä»¥åˆ›å»º ä¸å¯ä»¥åˆ›å»º åˆ é™¤æºæ–‡ä»¶ è½¯é“¾æ¥æ–‡ä»¶æ— æ³•è®¿é—® ç¡¬é“¾æ¥æ–‡ä»¶å¯ä»¥è®¿é—® ä¿®æ”¹æºæ–‡ä»¶ è½¯é“¾æ¥æ–‡ä»¶æ— æ³•è®¿é—® ç¡¬é“¾æ¥æ–‡ä»¶å¯ä»¥è®¿é—® ä¿®æ”¹é“¾æ¥æ–‡ä»¶ æºæ–‡ä»¶å¯ä»¥è®¿é—® æºæ–‡ä»¶å¯ä»¥è®¿é—® å®ç°å·®å¼‚ ä¿å­˜æºæ–‡ä»¶çš„è·¯å¾„ å’Œæºæ–‡ä»¶çš„ inode ä¸€è‡´ è¿™é‡Œçš„ inode æ˜¯ linux æ–‡ä»¶ç³»ç»Ÿçš„ä¸€ä¸ªæ¦‚å¿µï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸€ä¸ª inodeï¼Œinode ä¿å­˜äº†æ–‡ä»¶çš„å…ƒæ•°æ®ï¼Œæ¯”å¦‚æ–‡ä»¶çš„æƒé™ã€æ–‡ä»¶çš„å¤§å°ã€æ–‡ä»¶çš„åˆ›å»ºæ—¶é—´ç­‰ç­‰ã€‚\nä¸¤è€…åœ¨ linux ä¸­çš„å®ç°åŒºåˆ« # é€šè¿‡ man ln æ‰‹å†Œï¼Œæˆ‘ä»¬çŸ¥é“ç¡¬é“¾æ¥å¯¹åº” link(2) ç³»ç»Ÿè°ƒç”¨ï¼Œè½¯é“¾æ¥å¯¹åº” symlink(2) ç³»ç»Ÿè°ƒç”¨ã€‚ç¡¬é“¾æ¥å£°æ˜ç³»ç»Ÿè°ƒç”¨ do_linkatï¼Œæœ€ç»ˆè°ƒç”¨ vfs_symlinkï¼›è€Œè½¯é“¾æ¥å£°æ˜ç³»ç»Ÿè°ƒç”¨ do_symlinkat, æœ€ç»ˆè°ƒç”¨ vfs_symlinkã€‚è¿™ä¸¤ä¸ªéƒ½ä¼šè°ƒç”¨å®é™…çš„æ–‡ä»¶ç³»ç»Ÿå®ç°ï¼Œæ¯”å¦‚ ext4 æ–‡ä»¶ç³»ç»Ÿçš„å®ç°ã€‚è¿™é‡Œå°±åªè´´å…³é”®çš„éƒ¨åˆ†ä»£ç ï¼š\nint do_linkat(int olddfd, struct filename *old, int newdfd, struct filename *new, int flags) { ... // è½¬åˆ° vfs_link å‡½æ•° error = vfs_link(old_path.dentry, idmap, new_path.dentry-\u0026gt;d_inode, new_dentry, \u0026amp;delegated_inode); ... } int vfs_link(struct dentry *old_dentry, struct mnt_idmap *idmap, struct inode *dir, struct dentry *new_dentry, struct inode **delegated_inode) { // è°ƒç”¨å…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿå®ç° // inode ä¸­ i_nlink è¡¨ç¤ºçš„æ˜¯ç¡¬é“¾æ¥çš„æ•°é‡ï¼Œå› æ­¤ä¸€èˆ¬çš„å®ç°éƒ½ä¼šå°†è¿™ä¸ªè®¡æ•°å™¨ +1 error = dir-\u0026gt;i_op-\u0026gt;link(old_dentry, dir, new_dentry); // è§¦å‘ fsnotify äº‹ä»¶ if (!error) fsnotify_link(dir, inode, new_dentry); return error; } /////////// å‚è€ƒ ext4 æ–‡ä»¶ç³»ç»Ÿçš„å®ç° /////////// int __ext4_link(struct inode *dir, struct inode *inode, struct dentry *dentry) { ... inode-\u0026gt;i_ctime = current_time(inode); ext4_inc_count(inode); ... } static int ext4_symlink(struct mnt_idmap *idmap, struct inode *dir, struct dentry *dentry, const char *symname) { ... // æ–°å»ºä¸€ä¸ª inode inode = ext4_new_inode_start_handle(idmap, dir, S_IFLNK|S_IRWXUGO, \u0026amp;dentry-\u0026gt;d_name, 0, NULL, EXT4_HT_DIR, credits); // è®¾ç½®è½¯é“¾æ¥çš„å†…å®¹ // 1. å¦‚æœå†…å®¹é•¿åº¦è¶…è¿‡ EXT4_N_BLOCKS * 4ï¼Œå‡½æ•° ext4_init_symlink_block ä¼šè¢«è°ƒç”¨ç”¨æ¥åˆ†é…ä¸€ä¸ªæ–°çš„ç¬¦å·é“¾æ¥å—å¹¶å¡«å……å®ƒã€‚ if ((disk_link.len \u0026gt; EXT4_N_BLOCKS * 4)) { err = ext4_init_symlink_block(handle, inode, \u0026amp;disk_link); } else { // å¦‚æœé•¿åº¦è¾ƒçŸ­ï¼Œå†…å­˜ä¼šè¢«ç›´æ¥æ‹·è´åˆ° inode ç»“æ„çš„ i_data å­—æ®µã€‚ // åœ¨è®¾ç½®é“¾æ¥å†…å®¹åï¼Œè¿˜ä¼šæ›´æ–° inode çš„ i_size å’Œ i_disksize å­—æ®µä»¥åæ˜ é“¾æ¥å†…å®¹çš„é•¿åº¦ã€‚ ext4_clear_inode_flag(inode, EXT4_INODE_EXTENTS); memcpy((char *)\u0026amp;EXT4_I(inode)-\u0026gt;i_data, disk_link.name, disk_link.len); inode-\u0026gt;i_size = disk_link.len - 1; EXT4_I(inode)-\u0026gt;i_disksize = inode-\u0026gt;i_size; } } å°ç»“ï¼š æƒ³è¦å½»åº•ææ‡‚ï¼Œè¿˜éœ€è¦çœ‹ä¸‹ VFS çš„è®¾è®¡ï¼Œå°¤å…¶æ˜¯ inode çš„ç»“æ„ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚\nfsnotify çš„å®ç° # kratos ä½¿ç”¨çš„æ˜¯ fsnotify è¿™ä¸ªä»“åº“ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æ¥ä»è¿™ä¸ªä»“åº“å…¥æ‰‹ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ã€‚ä»ä»“åº“å¯¹åº”çš„ README ä¸­å¯ä»¥å‘ç°è¿™ä¹ˆä¸€ä¸ªä½¿ç”¨å®ä¾‹ï¼š\nfunc main() { // Create new watcher. watcher, err := fsnotify.NewWatcher() // ... defer watcher.Close() // Start listening for events. go func() { for { select { case event, ok := \u0026lt;-watcher.Events: log.Println(\u0026#34;event:\u0026#34;, event) if event.Has(fsnotify.Write) { log.Println(\u0026#34;modified file:\u0026#34;, event.Name) } case err, ok := \u0026lt;-watcher.Errors: // ... } } }() // Add a path. err = watcher.Add(\u0026#34;/tmp\u0026#34;) } ä»ä¸­å¯ä»¥å‘ç°è¿™ä¸ªåº“çš„ä¸»è¦ API/å¯¹è±¡ æœ‰å¦‚ä¸‹å‡ ä¸ªï¼š\nNewWatcher() Watcher.Add() Watcher.Events è¿™ä¸ªåº“æ‹¥æœ‰è·¨å¹³å°æ”¯æŒèƒ½åŠ›ï¼Œæˆ‘ä»¬è¿™é‡Œä¹Ÿåªå…³æ³¨ linux å¹³å°çš„å®ç°ä¹Ÿå°±æ˜¯ backend_inotify.go è¿™ä¸ªæ–‡ä»¶\nWatcher å’Œ NewWacther æ„é€ æ–¹æ³• # Watcher æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š\ntype Watcher struct { // Events æ˜¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå˜æ›´äº‹ä»¶çš„ channelï¼Œå¯ä»¥å‘é€ä»¥ä¸‹çš„äº‹ä»¶ï¼š // fsnotify.Create // fsnotify.Remove // fsnotify.Rename // fsnotify.Write // fsnotify.Chmod // å…·ä½“ä»€ä¹ˆåœºæ™¯ä¸‹ä¼šè§¦å‘ä»€ä¹ˆäº‹ä»¶ï¼Œä¸åŒå¹³å°ä¸Šå¯èƒ½ä¹Ÿä¼šæœ‰å·®å¼‚ï¼Œå°±å‚è€ƒå®˜æ–¹æ–‡æ¡£ä¸ºå‡†ã€‚ Events chan Event // Errors æ˜¯ä¸€ä¸ªé”™è¯¯çš„ channelï¼Œå½“å‘ç”Ÿé”™è¯¯çš„æ—¶å€™ï¼Œä¼šå‘é€åˆ°è¿™ä¸ª channel Errors chan error // Store fd here as os.File.Read() will no longer return on close after // calling Fd(). See: https://github.com/golang/go/issues/26439 fd int inotifyFile *os.File // inotify æ–‡ä»¶ watches *watches // ç›‘å¬å¯¹è±¡çš„é›†åˆ done chan struct{} closeMu sync.Mutex doneResp chan struct{} } // è¿™ä¸¤ä¸ªç»“æ„ç”¨äºç®¡ç† é€šè¿‡ inotify_add_watch() æ·»åŠ çš„ç›‘å¬æ–‡ä»¶å¯¹è±¡ type ( watches struct { mu sync.RWMutex wd map[uint32]*watch // wd -\u0026gt; watch path map[string]uint32 // pathname -\u0026gt; wd } watch struct { wd uint32 // Watch descriptor (as returned by the inotify_add_watch() syscall) flags uint32 // inotify flags of this watch (see inotify(7) for the list of valid flags) path string // Watch path. } ) NewWatcher å‡½æ•°çš„å®ç°å¦‚ä¸‹ï¼š\n// NewWatcher creates a new Watcher. func NewWatcher() (*Watcher, error) { // Need to set nonblocking mode for SetDeadline to work, otherwise blocking // I/O operations won\u0026#39;t terminate on close. fd, errno := unix.InotifyInit1(unix.IN_CLOEXEC | unix.IN_NONBLOCK) if fd == -1 { return nil, errno } w := \u0026amp;Watcher{ fd: fd, inotifyFile: os.NewFile(uintptr(fd), \u0026#34;\u0026#34;), watches: newWatches(), Events: make(chan Event), Errors: make(chan error), done: make(chan struct{}), doneResp: make(chan struct{}), } go w.readEvents() return w, nil } å¯ä»¥çœ‹åˆ°å…¶ä¸­æœ€æ ¸å¿ƒçš„å°±æ˜¯ unix.InotifyInit1 è°ƒç”¨äº†ï¼Œé€šè¿‡æ·±å…¥æºç å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªå‡½æ•°çš„å®ç°æ˜¯è°ƒç”¨äº† linux çš„ç³»ç»Ÿè°ƒç”¨ inotify_init1ï¼Œè€Œè¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„ä½œç”¨æ˜¯ï¼šåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ inotify å®ä¾‹å¹¶è¿”å›ä¸æ–°çš„ inotify äº‹ä»¶é˜Ÿåˆ—å…³è”çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦å¯ä»¥ç”¨äºåç»­çš„æ“ä½œï¼ˆå¯ä»¥å…ˆç†è§£æˆå’Œç½‘ç»œç¼–ç¨‹ä¸­çš„ç›‘å¬å¥—æ¥å­—ä¸€æ ·çš„æ–‡ä»¶æè¿°ç¬¦ï¼‰ã€‚\nè¿™é‡Œå…³äº inotify å…ˆä¸æ€¥ç€å±•å¼€ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹å¦å¤–çš„ä¸¤ä¸ªå‡½æ•°ã€‚\nWatcher.Add # Watcher.Add æ˜¯å¯¹ Watcher.AddWith çš„åŒ…è£…ï¼Œå› æ­¤æˆ‘ä»¬ç›´æ¥çœ‹ AddWith çš„å®ç°ï¼š\n// AddWith å…è®¸ä¼ å…¥ä¸€äº›é€‰é¡¹ï¼š // - WithBufferSize è®¾ç½®ç¼“å†²åŒºå¤§å°ï¼Œè¿™ä¸ªé€‰é¡¹åªå¯¹ windows æœ‰æ•ˆï¼Œå…¶ä»–å¹³å°æ— æ•ˆ é»˜è®¤æ˜¯ 64K func (w *Watcher) AddWith(name string, opts ...addOpt) error { if w.isClosed() { return ErrClosed } name = filepath.Clean(name) _ = getOptions(opts...) var flags uint32 = unix.IN_MOVED_TO | unix.IN_MOVED_FROM | unix.IN_CREATE | unix.IN_ATTRIB | unix.IN_MODIFY | unix.IN_MOVE_SELF | unix.IN_DELETE | unix.IN_DELETE_SELF return w.watches.updatePath(name, func(existing *watch) (*watch, error) { if existing != nil { flags |= existing.flags | unix.IN_MASK_ADD } // inotify ç³»ç»Ÿè°ƒç”¨ï¼ŒæŠŠæ–‡ä»¶/ç›®å½•æ·»åŠ åˆ° inotify å®ä¾‹ä¸­ wd, err := unix.InotifyAddWatch(w.fd, name, flags) if wd == -1 { return nil, err } if existing == nil { return \u0026amp;watch{ wd: uint32(wd), path: name, flags: flags, }, nil } existing.wd = uint32(wd) existing.flags = flags return existing, nil }) } ä»è¿™é‡Œåˆå‘ç°äº†ä¸€ä¸ªæ–°çš„ inotify ç³»ç»Ÿè°ƒç”¨ inotify_add_watch, å®ƒä¼ å…¥çš„å‚æ•°æ˜¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä¸€ä¸ªæ–‡ä»¶è·¯å¾„å’Œä¸€äº› flagsï¼Œè¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„ä½œç”¨æ˜¯ï¼šå°†ç›‘è§†æ·»åŠ åˆ°åˆå§‹åŒ–çš„ inotify å®ä¾‹ä¸­ã€‚\nåŒæ ·çš„å…³äºè¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„ç»†èŠ‚ï¼Œæˆ‘ä»¬å…ˆä¸å±•å¼€ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹æœ€åä¸€ä¸ªAPIã€‚\nWatcher.Events # è¦åˆ†æå’Œç†è§£ Watcher.Events çš„ä½¿ç”¨ï¼Œéœ€è¦å…ˆçœ‹ä¸€ä¸‹ Watcher.readEvents çš„å®ç°ï¼šä»£ç è´´åœ¨è¿™é‡Œç¨å¾®æœ‰ç‚¹å†—é•¿ï¼Œå› æ­¤åªæ˜¾ç¤ºäº†æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå®Œæ•´çš„ä»£ç å¯ä»¥å‚è€ƒ https://github.com/fsnotify/fsnotify/blob/main/backend_inotify.go#L453-L560\nfunc (w *Watcher) readEvents() { // ... çœç•¥éƒ¨åˆ†ä»£ç  var ( buf [unix.SizeofInotifyEvent * 4096]byte // Buffer for a maximum of 4096 raw events errno error // Syscall errno ) for { // See if we have been closed. if w.isClosed() { return } // ä» inotify æ–‡ä»¶ä¸­è¯»å– n, err := w.inotifyFile.Read(buf[:]) // çœç•¥é”™è¯¯å¤„ç†çš„ä»£ç  if n \u0026lt; unix.SizeofInotifyEvent { // å¦‚æœè¯»å–çš„æ•°æ®å­—èŠ‚æ•°å°äºä¸€ä¸ªäº‹ä»¶çš„å¤§å°ï¼Œé‚£ä¹ˆå°±è®¤ä¸ºæ˜¯é”™è¯¯ï¼Œé‚£ä¹ˆè¿›è¡Œé”™è¯¯å¤„ç† // çœç•¥å¤„ç†é€»è¾‘ } var offset uint32 // å¤„ç†ç¼“å†²åŒºä¸­çš„æ‰€æœ‰äº‹ä»¶ï¼Œè‡³å°‘è¦æœ‰ä¸€ä¸ªäº‹ä»¶ for offset \u0026lt;= uint32(n-unix.SizeofInotifyEvent) { var ( // unix.InotifyEvent æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š // type InotifyEvent struct { // Wd int32 // Mask uint32 // Cookie uint32 // Len uint32 // } // è¿™é‡Œä½¿ç”¨äº† unsafe.Pointer å°† buf ä¸­æ­£åœ¨å¤„ç†çš„äº‹ä»¶ï¼Œè½¬æ¢æˆäº† InotifyEvent ç»“æ„ä½“ raw = (*unix.InotifyEvent)(unsafe.Pointer(\u0026amp;buf[offset])) mask = uint32(raw.Mask) nameLen = uint32(raw.Len) ) // çœç•¥éƒ¨åˆ†ä»£ç  // å¦‚æœæœ‰äº‹ä»¶å‘ç”Ÿåœ¨ç›‘æ§çš„ç›®å½•æˆ–è€…æ–‡ä»¶ä¸Šï¼Œä½†æ˜¯å†…æ ¸ä¸ä¼šå°†æ–‡ä»¶åé™„åŠ åˆ°äº‹ä»¶ä¸Šï¼Œä½†æ˜¯åˆå¸Œæœ› // \u0026#34;Name\u0026#34; èƒ½è¯´æ˜æ–‡ä»¶åï¼Œå› æ­¤ä» watches.path ä¸­æ ¹æ® wd è·å–æ–‡ä»¶åã€‚ watch := w.watches.byWd(uint32(raw.Wd)) // è‡ªåŠ¨ç§»é™¤ç›‘æ§çš„ç›®å½•æˆ–è€…æ–‡ä»¶ï¼Œå¦‚æœç›®å½•æˆ–è€…æ–‡ä»¶è¢«åˆ é™¤äº† if watch != nil \u0026amp;\u0026amp; mask\u0026amp;unix.IN_DELETE_SELF == unix.IN_DELETE_SELF { w.watches.remove(watch.wd) } if watch != nil \u0026amp;\u0026amp; mask\u0026amp;unix.IN_MOVE_SELF == unix.IN_MOVE_SELF { err := w.remove(watch.path) // çœç•¥é”™è¯¯å¤„ç† } var name string // çœç•¥ name å¤„ç† // äº‹ä»¶å¤„ç†å®Œæˆåå°±å¯ä»¥ç»™ä½¿ç”¨æ–¹å‘é€äº‹ä»¶äº† event := w.newEvent(name, mask) if mask\u0026amp;unix.IN_IGNORED == 0 { if !w.sendEvent(event) { return } } // å¤„ç†ä¸‹ä¸€ä¸ªäº‹ä»¶ offset += unix.SizeofInotifyEvent + nameLen } } } è‡³æ­¤æˆ‘ä»¬å·²ç»å¼„æ¸…æ¥šäº† fsnotify ä¸­åœ¨ linux ç³»ç»Ÿä¸Šåœ¨å¤„ç†æµç¨‹ï¼Œé‚£ä¹ˆå¯ä»¥æ›´åŠ æ·±å…¥çš„å»äº†è§£å…³äº inotify çš„ä¸€äº›ç»†èŠ‚äº†ã€‚\ninotify ç³»ç»Ÿ # ä» fsnotify çš„ backend_inotify.go æ–‡ä»¶å‘½åä¸Šæˆ‘ä»¬æ—©å°±å¯ä»¥å‘ç° inotify è¿™ä¸ªè¯ï¼Œé‚£ä¹ˆå®ƒæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ\ninotify æ˜¯ linux VFS çš„ä¸€ä¸ªå­ç³»ç»Ÿï¼Œå®ƒå¯ä»¥ç›‘æ§æ–‡ä»¶ç³»ç»Ÿçš„å˜åŒ–ï¼Œå½“æ–‡ä»¶ç³»ç»Ÿå‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œå†…æ ¸ä¼šå°†è¿™äº›å˜åŒ–é€šçŸ¥ç»™ç”¨æˆ·ç©ºé—´ï¼Œç”¨æˆ·ç©ºé—´å¯ä»¥æ ¹æ®è¿™äº›å˜åŒ–åšä¸€äº›äº‹æƒ…ã€‚\nä» fsnotify çš„ä»£ç ä¸­æˆ‘ä»¬å·²ç»å‘ç°äº† inotify ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨äº†ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹å®ƒçš„ç³»ç»Ÿè°ƒç”¨çš„æ–‡æ¡£ï¼š\nåˆå§‹åŒ–ä¸€ä¸ª inotify å®ä¾‹ï¼š\n// å¦‚æœflagsä¸º0ï¼Œåˆ™inotify_init1()ä¸inotify_init()ç›¸åŒ // // flags åŒ…å«ä»¥ä¸‹çš„æ ‡å¿—ï¼š // - IN_NONBLOCK è¯´æ˜ inotify æ–‡ä»¶æè¿°ç¬¦åº”è¯¥è¢«è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼Œè¿™æ ·çš„è¯ï¼Œå¦‚æœæ²¡æœ‰äº‹ä»¶å‘ç”Ÿï¼Œinotify_read() å°†ä¼šç«‹å³è¿”å›ï¼Œè€Œä¸æ˜¯é˜»å¡ç­‰å¾… // - IN_CLOEXEC è¯´æ˜ inotify æ–‡ä»¶æè¿°ç¬¦åº”è¯¥è¢«è®¾ç½®ä¸º close-on-execï¼Œè¿™æ ·çš„è¯ï¼Œå½“è°ƒç”¨ execve(2) æ—¶ï¼Œinotify æ–‡ä»¶æè¿°ç¬¦å°†ä¼šè¢«å…³é—­ // // æˆåŠŸåï¼Œè¿™äº›ç³»ç»Ÿè°ƒç”¨å°†è¿”å›ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å‡ºé”™æ—¶ï¼Œè¿”å› -1ï¼Œå¹¶è®¾ç½® errno æ¥æŒ‡ç¤ºé”™è¯¯ã€‚ int inotify_init(void); int inotify_init1(int flags); æ·»åŠ ç§»é™¤æ–‡ä»¶çš„ç›‘æ§ï¼š\n// ä¸ºè·¯å¾„åä¸­æŒ‡å®šä½ç½®çš„æ–‡ä»¶æ·»åŠ æ–°çš„ç›‘è§†ï¼Œæˆ–ä¿®æ”¹ç°æœ‰çš„ç›‘è§†ï¼›è°ƒç”¨è€…å¿…é¡»å…·æœ‰è¯¥æ–‡ä»¶çš„è¯»å–æƒé™ã€‚fd å‚æ•°æ˜¯ inotify å®ä¾‹å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ã€‚è¦ç›‘è§†è·¯å¾„åçš„äº‹ä»¶åœ¨æ©ç ä½å‚æ•°ä¸­æŒ‡å®šã€‚æœ‰å…³å¯åœ¨ mask ä¸­è®¾ç½®çš„ä½çš„å®Œæ•´è¯´æ˜ï¼Œè¯·å‚é˜… inotify(7)ã€‚ int inotify_add_watch(int fd, const char *pathname, uint32_t mask); // ä»ä¸æ–‡ä»¶æè¿°ç¬¦ fd å…³è”çš„ inotify å®ä¾‹ä¸­åˆ é™¤ä¸ç›‘è§†æè¿°ç¬¦ wd å…³è”çš„ç›‘è§†ã€‚ int inotify_rm_watch(int fd, int wd); å…³äºè¯»å–çš„éƒ¨åˆ† inotify(7) ä¸­æ˜¯è¿™ä¹ˆè¯´çš„ï¼š\nTo determine what events have occurred, an application read(2)s from the inotify file descriptor. If no events have so far occurred, then, assuming a blocking file descriptor, read(2) will block until at least one event occurs (unless interrupted by a signal, in which case the call fails with the error EINTR; see signal(7)).\nä¸ºäº†ç¡®å®šå‘ç”Ÿäº†å“ªäº›äº‹ä»¶ï¼Œåº”ç”¨ç¨‹åºä» inotify æ–‡ä»¶æè¿°ç¬¦ä¸­è¯»å–(2)ã€‚å¦‚æœåˆ°ç›®å‰ä¸ºæ­¢è¿˜æ²¡æœ‰å‘ç”Ÿä»»ä½•äº‹ä»¶ï¼Œåˆ™å‡è®¾æœ‰ä¸€ä¸ªé˜»å¡æ–‡ä»¶æè¿°ç¬¦ï¼Œread(2) å°†é˜»å¡ï¼Œç›´åˆ°è‡³å°‘å‘ç”Ÿä¸€ä¸ªäº‹ä»¶ï¼ˆé™¤éè¢«ä¿¡å·ä¸­æ–­ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè°ƒç”¨ä¼šå¤±è´¥å¹¶å‡ºç°é”™è¯¯ EINTRï¼›è¯·å‚é˜…signal(7)ï¼‰ã€‚\næ¯æ¬¡æˆåŠŸçš„è¯»å–éƒ½ä¼šè¿”å›ä¸€ä¸ªåŒ…å«ä»¥ä¸‹ä¸€ä¸ªæˆ–å¤šä¸ªç»“æ„çš„ç¼“å†²åŒºï¼š\nstruct inotify_event { int wd; /* ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¹Ÿå°±æ˜¯ inotify_add_watch è¿”å›çš„ wd */ uint32_t mask; /* åŒ…å«æè¿° å‘ç”Ÿ çš„äº‹ä»¶çš„æ©ç ä½ */ uint32_t cookie; /* è¿æ¥ç›¸å…³äº‹ä»¶çš„å”¯ä¸€æ•´æ•°æ ‡è¯†ï¼Œç›®å‰ä»…ç”¨äº rename äº‹ä»¶ */ uint32_t len; /* è¯´æ˜ name çš„é•¿åº¦ */ char name[]; /* æ–‡ä»¶åä»…åœ¨è¢«ç›‘è§†ç›®å½•ä¸­çš„äº‹ä»¶å‘ç”Ÿæ—¶æ‰æœ‰å€¼ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥ç›‘è§†æ–‡ä»¶ï¼Œè¿™é‡Œæ˜¯ä¸ä¼šæœ‰æ–‡ä»¶åçš„ */ }; inotify ç›¸å…³çš„ä¸œè¥¿æˆ‘ä»¬ä¹Ÿææ¸…æ¥šäº†ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸€ä¸ªç®€å•çš„ c ä»£ç ä¾‹å­æ¥ä¸²è”ä¸€ä¸‹ï¼š\n#include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;errno.h\u0026gt; #include \u0026lt;sys/inotify.h\u0026gt; #define EVENT_SIZE (sizeof (struct inotify_event)) #define BUF_LEN (1024 * (EVENT_SIZE + 16)) int main(int argc, char *argv[]) { int fd, wd; char buf[BUF_LEN]; ssize_t len; struct inotify_event *event; fd = inotify_init(); if (fd == -1) { perror(\u0026#34;inotify_init\u0026#34;); exit(EXIT_FAILURE); } wd = inotify_add_watch(fd, \u0026#34;/tmp/test\u0026#34;, IN_MODIFY); if (wd == -1) { perror(\u0026#34;inotify_add_watch\u0026#34;); exit(EXIT_FAILURE); } printf(\u0026#34;Watching /tmp/test for changes...\\n\u0026#34;); while (1) { len = read(fd, buf, BUF_LEN); if (len == -1 \u0026amp;\u0026amp; errno != EAGAIN) { perror(\u0026#34;read\u0026#34;); exit(EXIT_FAILURE); } if (len \u0026lt;= 0) { continue; } event = (struct inotify_event *) buf; if (event-\u0026gt;mask \u0026amp; IN_MODIFY) { printf(\u0026#34;File /tmp/test was modified!\\n\u0026#34;); } } inotify_rm_watch(fd, wd); close(fd); return 0; } å®é™…æ‰§è¡Œæ•ˆæœå¦‚ä¸‹ï¼š\ninotify çš„å®ç°å’Œ linux æ–‡ä»¶ç³»ç»Ÿ # åˆ°ç°åœ¨æˆ‘ä»¬æ‰ç®—æ˜¯çœŸæ­£çš„ææ¸…æ¥šäº† fsnotify æ˜¯å¦‚ä½•å®ç°çš„ã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯ä¸çŸ¥é“åœ¨ linux å†…éƒ¨ inotify åˆ°åº•æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿè·Ÿæ–‡ä»¶ç³»ç»Ÿæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ\ninotify çš„å®ç° # ä¸ºäº†ææ¸…æ¥š inotify çš„å®ç°ï¼Œæˆ‘ä»¬æœ‰å¿…è¦ç¿»ä¸€ä¸‹ linux çš„æºç ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ã€‚é€šè¿‡ç³»ç»Ÿè°ƒç”¨æˆ‘ä»¬çŸ¥é“ï¼Œinotify çš„ä½¿ç”¨ä¸»è¦æ˜¯é€šè¿‡ inotify_init å’Œ inotify_add_watch è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨æ¥å®ç° fsnotify å®ä¾‹çš„åˆå§‹åŒ–å’Œ watch æ·»åŠ , é€šè¿‡ read ç³»ç»Ÿè°ƒç”¨æ¥è·å–å‘ç”Ÿçš„äº‹ä»¶ã€‚å› æ­¤æˆ‘ä»¬ä¸»è¦è§£ç­”è¿™ä¸‰ä¸ªé—®é¢˜ï¼š\ninotify_init åšäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿ inotify_add_watch åšäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿ inotify äº‹ä»¶å¦‚ä½•äº§ç”Ÿçš„ï¼Ÿ è¿™é‡Œçš„æºç æ˜¯ linux 6.4.11ï¼Œä¸ºäº†ç¼©çŸ­ç¯‡å¹…åªæä¾›äº†è¿™é‡Œæœ€å…³å¿ƒçš„éƒ¨åˆ†ä»£ç \ninotify_init åšäº†ä»€ä¹ˆï¼Ÿ # // fs/notify/inotify/inotify_user.c#L695 static int do_inotify_init(int flags) { // ... /* åˆå§‹åŒ–ä¸€ä¸ª fsnotify_group, è¿™æ˜¯ linux ä¸­ fsnotify çš„ä¸€ä¸ªæ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯å‰æ–‡æåˆ°çš„å®ä¾‹ã€‚ */ group = inotify_new_group(inotify_max_queued_events); // ... // åˆ›å»ºä¸€ä¸ªåŒ¿å inodeï¼Œè¿™ä¸ª inode ä¼šè¢«ç”¨äº inotify å®ä¾‹ // ç»§ç»­è¿½ä¸‹å»ä¼šå‘ç°ï¼Œ è¿™é‡Œä¼šåˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œret å°±æ˜¯è¿™ä¸ªæ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œ // åŒæ—¶ group ä¼šè¢«è®¾ç½®åˆ°æ–‡ä»¶çš„ private_data ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡æ–‡ä»¶æè¿°ç¬¦è·å–åˆ° group äº† //ï¼ˆåç»­ inotify_add_watch ç­‰æ“ä½œéƒ½æ˜¯é€šè¿‡è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦æ¥è·å– group çš„ï¼‰ // åŒæ—¶ inotify_fops ä¼šè¢«è®¾ç½®åˆ°æ–‡ä»¶çš„ f_op ä¸­ï¼Œæ–‡ä»¶å¯¹åº”çš„ f_op å°±æ˜¯ inotify ç›¸å…³çš„æ“ä½œ ret = anon_inode_getfd(\u0026#34;inotify\u0026#34;, \u0026amp;inotify_fops, group, O_RDONLY | flags); return ret; } static const struct file_operations inotify_fops = { .show_fdinfo\t= inotify_show_fdinfo, .poll\t= inotify_poll, .read\t= inotify_read, .fasync\t= fsnotify_fasync, .release\t= inotify_release, .unlocked_ioctl\t= inotify_ioctl, .compat_ioctl\t= inotify_ioctl, .llseek\t= noop_llseek, }; å…³äº fsnotify_group çš„å®šä¹‰å¦‚ä¸‹ï¼š\n// include/linux/fsnotify_backend.h#L185 // // group æ˜¯ä¸€ä¸ªæƒ³è¦æ¥æ”¶æ–‡ä»¶ç³»ç»Ÿäº‹ä»¶çš„é€šçŸ¥çš„ç»“æ„ä½“ã€‚mask ä¿å­˜äº†è¿™ä¸ª group å…³å¿ƒçš„äº‹ä»¶ç±»å‹çš„å­é›†ã€‚ // group çš„ refcnt ç”±å®ç°è€…å†³å®šï¼Œä»»ä½•æ—¶å€™å¦‚æœå®ƒå˜æˆäº† 0ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„ä¸œè¥¿éƒ½ä¼šè¢«æ¸…ç†æ‰ã€‚ struct fsnotify_group { const struct fsnotify_ops *ops; // ç”¨äºå¤„ç†äº‹ä»¶çš„å›è°ƒå‡½æ•°ï¼Œinotify å¯¹åº”çš„æ˜¯ inotify_fsnotify_ops refcount_t refcnt; // è¡¨ç¤ºè¿™ä¸ª group å®ä¾‹çš„å¼•ç”¨è®¡æ•°ï¼Œå¦‚æœä¸º0åˆ™é”€æ¯ struct list_head notification_list; // ç”¨äºä¿å­˜é€šçŸ¥çš„é“¾è¡¨ wait_queue_head_t notification_waitq; // ç”¨äºç­‰å¾…é€šçŸ¥çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œé˜»å¡åœ¨è¿™ä¸ªé˜Ÿåˆ—ä¸Šçš„è¿›ç¨‹ä¼šè¢«å”¤é†’ unsigned int q_len; // äº‹ä»¶é˜Ÿåˆ—çš„é•¿åº¦ unsigned int max_events; // äº‹ä»¶é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ ... struct fsnotify_event *overflow_event; // å½“äº‹ä»¶é˜Ÿåˆ—æ»¡äº†çš„æ—¶å€™ï¼Œä¼šå°†äº‹ä»¶æ”¾åˆ°è¿™é‡Œ }; å°ç»“ï¼š inotify_init ä¸»è¦åšäº†ä¸¤ä»¶äº‹æƒ…ï¼š\nåˆ›å»ºä¸€ä¸ª fsnotify_group å®ä¾‹ åˆ›å»ºä¸€ä¸ªåŒ¿å inodeï¼Œè¿™ä¸ª inode ä¼šè¢«ç”¨äº inotify å®ä¾‹ï¼ŒåŒæ—¶è®¾å®šäº† f_op ä¸º inotify_fopsï¼Œprivate_data ä¸º group inotify_add_watch åšäº†ä»€ä¹ˆï¼Ÿ # é€šè¿‡æ£€ç´¢ inotify_add_watch çš„è°ƒç”¨é“¾ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å®ƒçš„å®ç°ï¼Œå¦‚ä¸‹ï¼š\nSYSCALL_DEFINE3(inotify_add_watch, int, fd, const char __user *, pathname, u32, mask) { // ä» inotify_init è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦ä¸­è·å– group å®ä¾‹ f = fdget(fd); group = f.file-\u0026gt;private_data; // åˆ›å»ºæˆ–è€…æ›´æ–° watch ret = inotify_update_watch(group, inode, mask); } static int inotify_update_watch(struct fsnotify_group *group, struct inode *inode, u32 arg) { // å…ˆå°è¯•æ›´æ–°å·²ç»å­˜åœ¨çš„ watch ret = inotify_update_existing_watch(group, inode, arg); // å¦‚æœä¸å­˜åœ¨ï¼Œé‚£ä¹ˆåˆ›å»º if (ret == -ENOENT) ret = inotify_new_watch(group, inode, arg); } static int inotify_new_watch(struct fsnotify_group *group, struct inode *inode, u32 arg) { struct inotify_inode_mark *tmp_i_mark; int ret; struct idr *idr = \u0026amp;group-\u0026gt;inotify_data.idr; spinlock_t *idr_lock = \u0026amp;group-\u0026gt;inotify_data.idr_lock; tmp_i_mark = kmem_cache_alloc(inotify_inode_mark_cachep, GFP_KERNEL); if (unlikely(!tmp_i_mark)) return -ENOMEM; fsnotify_init_mark(\u0026amp;tmp_i_mark-\u0026gt;fsn_mark, group); tmp_i_mark-\u0026gt;fsn_mark.mask = inotify_arg_to_mask(inode, arg); tmp_i_mark-\u0026gt;fsn_mark.flags = inotify_arg_to_flags(arg); tmp_i_mark-\u0026gt;wd = -1; // idr æ˜¯ group-\u0026gt;inotify_data.idrï¼Œè¿™æ˜¯ä¸€ä¸ª radix æ ‘ï¼Œç”¨äºä¿å­˜æ‰€æœ‰çš„ inotify_inode_mark ret = inotify_add_to_idr(idr, idr_lock, tmp_i_mark); if (ret) goto out_err; /* increment the number of watches the user has */ if (!inc_inotify_watches(group-\u0026gt;inotify_data.ucounts)) { inotify_remove_from_idr(group, tmp_i_mark); ret = -ENOSPC; goto out_err; } /* we are on the idr, now get on the inode */ ret = fsnotify_add_inode_mark_locked(\u0026amp;tmp_i_mark-\u0026gt;fsn_mark, inode, 0); if (ret) { /* we failed to get on the inode, get off the idr */ inotify_remove_from_idr(group, tmp_i_mark); goto out_err; } /* return the watch descriptor for this new mark */ ret = tmp_i_mark-\u0026gt;wd; out_err: /* match the ref from fsnotify_init_mark() */ fsnotify_put_mark(\u0026amp;tmp_i_mark-\u0026gt;fsn_mark); return ret; } å°ç»“ï¼š inotify_add_watch ä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹æƒ…ï¼š\nåˆ›å»ºä¸€ä¸ª inotify_inode_mark å®ä¾‹ å°† inotify_inode_mark å®ä¾‹æ·»åŠ åˆ° group-\u0026gt;inotify_data.idr ä¸­ inotify äº‹ä»¶å¦‚ä½•äº§ç”Ÿçš„ï¼Ÿ # åœ¨é˜…è¯» inotify ç›¸å…³çš„æºç æ—¶ fsnotify.h ä¸­æœ‰è¿™ä¹ˆäº›å‡½æ•°ï¼š\n// include/linux/fsnotify.h // fsnotify_create - \u0026#39;name\u0026#39; was linked in static inline void fsnotify_create(struct inode *dir, struct dentry *dentry) // fsnotify_link - \u0026#39;name\u0026#39; was created static inline void fsnotify_link(struct inode *dir, struct inode *inode, struct dentry *new_dentry) // fsnotify_delete - @dentry was unlinked and unhashed static inline void fsnotify_delete(struct inode *dir, struct inode *inode, struct dentry *dentry) // fsnotify_access - @file was accessed static inline void fsnotify_access(struct file *file) // ... è¿˜æœ‰æ›´å¤š å¾ˆæ˜æ˜¾ï¼Œä»åå­—å°±å¯ä»¥çœ‹å‡ºå¤§æ¦‚æ˜¯ç»™å…¶ä»–çš„ç³»ç»Ÿè°ƒç”¨æä¾›äº†ä¸€äº› hookï¼Œè¿™æ ·åœ¨è¿™äº›ç³»ç»Ÿè°ƒç”¨ä¸­å°±å¯ä»¥è°ƒç”¨è¿™äº› hook æ¥é€šçŸ¥åˆ°ç”¨æˆ·ç©ºé—´äº†ã€‚è·Ÿè¸ªä¸‹ fsnotify_access çš„è°ƒç”¨é“¾ï¼Œå¯ä»¥å‘ç°å®ƒå­˜åœ¨äº read syscall \u0026gt; ksys_read \u0026gt; vfs_read \u0026gt; fsnotify_access è°ƒç”¨é“¾ä¸­ï¼Œä¹Ÿå¯ä»¥ä»ä¾§é¢ä½è¯è¿™ä¸€ç‚¹ã€‚\nè¿™ä¸€éƒ¨åˆ†é“¾è·¯è¾ƒé•¿ï¼Œä»£ç ä¹Ÿå¾ˆå¤šï¼Œå› æ­¤åªå…³æ³¨ä¸¤ä¸ªç‚¹:\næ–‡ä»¶è§¦å‘äº‹ä»¶åï¼Œå“ªäº› group åº”è¯¥æ”¶åˆ°äº‹ä»¶ï¼Œæ˜¯æ€ä¹ˆåˆ¤æ–­çš„ï¼Ÿ äº‹ä»¶æ˜¯æ€ä¹ˆé€šçŸ¥åˆ°ç”¨æˆ·ç©ºé—´çš„ï¼Ÿ ä¸‹é¢æˆ‘ä»¬ä»¥ fsnotify_access ä¸ºä¾‹ï¼Œçœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆé€šçŸ¥åˆ°ç”¨æˆ·ç©ºé—´çš„ï¼š\nfsnoify_access -\u0026gt; fsnotify_file -\u0026gt; fsnotify_parent -\u0026gt; __fsnotify_parent -\u0026gt; fsnotify -\u0026gt; (group-\u0026gt;ops.handle_inode_event)inotify_handle_inode_event -\u0026gt; fsnotify_add_event -\u0026gt; static inline void fsnotify_access(struct file *file) { fsnotify_file(file, FS_ACCESS); } static inline int fsnotify_file(struct file *file, __u32 mask) { ... return fsnotify_parent(path-\u0026gt;dentry, mask, path, FSNOTIFY_EVENT_PATH); } /* Notify this dentry\u0026#39;s parent about a child\u0026#39;s events. */ static inline int fsnotify_parent(struct dentry *dentry, __u32 mask, const void *data, int data_type) { ... return __fsnotify_parent(dentry, mask, data, data_type); notify_child: return fsnotify(mask, data, data_type, NULL, NULL, inode, 0); } è¿™é‡Œé‡ç‚¹å…³æ³¨ fsnotify å‡½æ•°ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨å°±æ˜¯\nint fsnotify(__u32 mask, const void *data, int data_type, struct inode *dir, const struct qstr *file_name, struct inode *inode, u32 cookie) { // ä» inode ç»“æ„ä¸­çš„ xxx_fsnotify_marks è·å–åˆ° fsnotify_mark ä¿¡æ¯ iter_info.marks[FSNOTIFY_ITER_TYPE_SB] = fsnotify_first_mark(\u0026amp;sb-\u0026gt;s_fsnotify_marks); if (mnt) { iter_info.marks[FSNOTIFY_ITER_TYPE_VFSMOUNT] = fsnotify_first_mark(\u0026amp;mnt-\u0026gt;mnt_fsnotify_marks); } if (inode) { iter_info.marks[FSNOTIFY_ITER_TYPE_INODE] = fsnotify_first_mark(\u0026amp;inode-\u0026gt;i_fsnotify_marks); } if (inode2) { iter_info.marks[inode2_type] = fsnotify_first_mark(\u0026amp;inode2-\u0026gt;i_fsnotify_marks); } while (fsnotify_iter_select_report_types(\u0026amp;iter_info)) { // éå† iter_info.marksï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ group å…³å¿ƒè¿™ä¸ªäº‹ä»¶ï¼Œå¦‚æœæœ‰çš„è¯ // å°±å°†äº‹ä»¶æ·»åŠ åˆ° group çš„äº‹ä»¶é˜Ÿåˆ—ä¸­ã€‚ ret = send_to_group(mask, data, data_type, dir, file_name, cookie, \u0026amp;iter_info); // ç»§ç»­éå†ä¸‹ä¸€ä¸ª mark fsnotify_iter_next(\u0026amp;iter_info); } ret = 0; ... } è¿™éƒ¨åˆ†é€»è¾‘è§£æå¾—æ¯”è¾ƒç®€å•ï¼Œä»£ç ä¹Ÿæ¯”è¾ƒå¤šï¼Œåˆæ¬¡è¯»ä¼šæœ‰å¾ˆå¤šé—®é¢˜ï¼Œæ‰€ä»¥å°±æŒæ¡ä¸€ç‚¹ï¼š inode ç»“æ„ä¸­è®°å½•ä¸€ä¸ª i_fsnotify_marks å­—æ®µ, super_block ä¸­ä¹Ÿæœ‰ä¸€ä¸ª s_fsnotify_marks å­—æ®µï¼Œè¿™ä¸¤ä¸ªå­—æ®µéƒ½æ˜¯ fsnotify_mark_connector ç±»å‹ï¼Œfsnotify ç³»ç»Ÿå¯ä»¥é€šè¿‡è¿™ä¸¤ä¸ªå­—æ®µæ¥è·å–åˆ°è¯¥æ–‡ä»¶å¯¹åº”çš„ fsnotify_mark ä¿¡æ¯ã€‚\næœ€ç»ˆï¼Œäº‹ä»¶ fsnotify_insert_event å®Œæˆ event çš„æ’å…¥ï¼Œç„¶åå”¤é†’ç­‰å¾…äº‹ä»¶çš„è¿›ç¨‹ï¼Œå¢åŠ è®¡æ•°ï¼š\n// ç»™ç‰¹å®š group æ–°å¢äº‹ä»¶ int fsnotify_insert_event(struct fsnotify_group *group, struct fsnotify_event *event, int (*merge)(struct fsnotify_group *, struct fsnotify_event *), void (*insert)(struct fsnotify_group *, struct fsnotify_event *)) { int ret = 0; // event é˜Ÿåˆ— struct list_head *list = \u0026amp;group-\u0026gt;notification_list; // ... // è¿™é‡Œçš„åˆ¤æ–­æ˜¯ä¸ºäº†å¤„ç†æº¢å‡ºäº‹ä»¶ï¼Œå¦‚æœäº‹ä»¶é˜Ÿåˆ—å·²ç»æ»¡äº†ï¼Œé‚£ä¹ˆå°±å°†äº‹ä»¶æ”¾åˆ°æº¢å‡ºäº‹ä»¶ä¸­ if (event == group-\u0026gt;overflow_event || group-\u0026gt;q_len \u0026gt;= group-\u0026gt;max_events) { ret = 2; // æº¢å‡ºäº‹ä»¶é˜Ÿåˆ—è¿˜ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆè¯¥äº‹ä»¶å°±ä¸¢å¼ƒ if (!list_empty(\u0026amp;group-\u0026gt;overflow_event-\u0026gt;list)) { return ret; } event = group-\u0026gt;overflow_event; goto queue; } // å¦‚æœäº‹ä»¶é˜Ÿåˆ—ä¸ä¸ºç©ºä¸” merge è¢«æŒ‡å®šï¼Œé‚£ä¹ˆå°±å°è¯•åˆå¹¶äº‹ä»¶ // è¿™é‡Œåˆå¹¶çš„æ„æ€æ˜¯ï¼šå¦‚æœäº‹ä»¶é˜Ÿåˆ—ä¸­å·²ç»æœ‰äº†è¿™ä¸ªäº‹ä»¶ï¼ˆåˆ¤æ–­æœ€åä¸€ä¸ªäº‹ä»¶ï¼‰ï¼Œé‚£ä¹ˆå°±ä¸ç”¨æ·»åŠ  if (!list_empty(list) \u0026amp;\u0026amp; merge) { ret = merge(group, event); if (ret) { return ret; } } queue: // å°†äº‹ä»¶æ·»åŠ åˆ°é˜Ÿå°¾ï¼Œç„¶åå”¤é†’ç­‰å¾…äº‹ä»¶çš„è¿›ç¨‹ï¼Œå¢åŠ è®¡æ•° group-\u0026gt;q_len++; list_add_tail(\u0026amp;event-\u0026gt;list, list); // å”¤é†’ç­‰å¾…äº‹ä»¶çš„è¿›ç¨‹ wake_up(\u0026amp;group-\u0026gt;notification_waitq); } æœ€åå†é‡æ–°æ¢³ç†ä¸‹ inotify çš„äº‹ä»¶é€šçŸ¥æµç¨‹ï¼š\nç³»ç»Ÿè°ƒç”¨è§¦å‘äº‹ä»¶ï¼Œæ¯”å¦‚ read ç³»ç»Ÿè°ƒç”¨è§¦å‘äº† fsnotify_access fsnotify_access ç»è¿‡ä¸€ç³»åˆ—çš„é€»è¾‘åˆ¤æ–­ï¼Œæœ€ç»ˆè°ƒç”¨ fsnotify å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„ä¸»è¦ä½œç”¨æ˜¯ä» inode ç»“æ„ï¼ˆxxx_fsnotify_marksï¼‰å¼€å§‹è¿­ä»£å¾ªç¯è°ƒç”¨ send_to_group send_to_group å‡½æ•°æ£€æŸ¥ group æ˜¯å¦å…³å¿ƒè¿™ä¸ªäº‹ä»¶ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆå°±å°†äº‹ä»¶æ·»åŠ åˆ° group çš„äº‹ä»¶é˜Ÿåˆ—ä¸­ï¼Œå¹¶å”¤é†’ç­‰å¾…äº‹ä»¶çš„è¿›ç¨‹ã€‚ æ€»ç»“ # æœ¬æ–‡ä»ä¸€ä¸ª kratos çš„é—®é¢˜å‡ºå‘ï¼Œåˆ†æäº† fsnotify çš„å®ç°ï¼Œåœ¨ linux ä¸­ fsnotify å…¶å®æ˜¯åŸºäº inotify ç³»ç»Ÿè°ƒç”¨è€Œå®ç°çš„ã€‚inotify æ˜¯ linux VFS çš„ä¸€ä¸ªå­ç³»ç»Ÿï¼Œå®ƒå¯ä»¥ç›‘æ§æ–‡ä»¶ç³»ç»Ÿçš„å˜åŒ–ï¼Œå½“æ–‡ä»¶ç³»ç»Ÿå‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œå†…æ ¸ä¼šå°†è¿™äº›å˜åŒ–é€šçŸ¥ç»™ç”¨æˆ·ç©ºé—´ï¼Œç”¨æˆ·ç©ºé—´å¯ä»¥æ ¹æ®è¿™äº›å˜åŒ–åšä¸€äº›äº‹æƒ…ã€‚\nè¿™é‡Œè¿˜æ˜¯ç•™äº†äº›é—®é¢˜ï¼š\nQ1 å¤šå±‚è½¯é“¾æ¥çš„æƒ…å†µä¸‹ï¼Œinotify æºæ–‡ä»¶çš„æ”¹åŠ¨æ˜¯å¦è¿˜èƒ½è¢«ç›‘å¬åˆ°ï¼Ÿ Q2 æœ¬æ–‡å¼€å¤´è¯´çš„åœºæ™¯èƒ½ä¸èƒ½å®ç°ï¼ˆä¸¤å±‚è½¯é“¾æ¥ï¼Œä¿®æ”¹ç¬¬äºŒå±‚çš„æ—¶å€™æœ‰å˜æ›´äº‹ä»¶ï¼‰ï¼Ÿ å‚è€ƒèµ„æ–™ # https://linux.die.net/man/7/inotify https://github.com/fsnotify/fsnotify "},{"id":17,"href":"/2023/08/22/c%E5%92%8Clua%E4%BA%92%E6%93%8D%E4%BD%9C%E5%AE%9E%E8%B7%B5/","title":"Cå’Œluaäº’æ“ä½œå®è·µ","section":"Posts","content":"ç›¸ä¿¡äº†è§£ redis å’Œ openresty çš„å°ä¼™ä¼´ä»¬éƒ½çŸ¥é“ lua ä»£ç å¯ä»¥åµŒå…¥è¿™ä¸¤ç§ç¨‹åºä¸­è¿è¡Œï¼Œæå¤§çš„æé«˜äº†è½¯ä»¶çš„æ‰©å±•æ€§ï¼›å°¤å…¶æ˜¯ openresty ä¸­ï¼Œé€šè¿‡ä½¿ç”¨ lua æˆ‘ä»¬å¯ä»¥å¾ˆå¿«é€Ÿï¼ˆç›¸æ¯”cï¼‰çš„å®šåˆ¶webæœåŠ¡å™¨ï¼Œæˆ–è€…å¢å¼º nginx çš„åŠŸèƒ½ã€‚é‚£ä¹ˆ lua æ˜¯å¦‚ä½•åµŒå…¥åˆ°è¿™äº›ç¨‹åºä¸­çš„å‘¢ï¼Ÿlua å’Œ c æ˜¯å¦‚ä½•äº’æ“ä½œçš„å‘¢ï¼Ÿ\nä¸‹æ–‡çš„ç›¸å…³ç¯å¢ƒå’Œå·¥å…·ç‰ˆæœ¬ä¸ºï¼šLua 5.4.6; Mac OS 13.4.1 (Darwin Kernel Version 22.5.0) arm64 M2 pro; Apple clang version 14.0.3 (clang-1403.0.22.14.1)\nredis ä¸­çš„ lua # ä¸‹é¢å±•ç¤ºäº†ä¸€æ®µ redis ä¸­æ“ä½œ lua API çš„ä»£ç ï¼š\nè¿™é‡Œå‡ºç°äº†å¾ˆå¤š lua_ å¼€å¤´çš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°éƒ½æ˜¯ lua åº“ä¸­çš„å‡½æ•°ï¼Œredis é€šè¿‡è¿™äº›å‡½æ•°æ¥æ“ä½œ lua ç¯å¢ƒï¼Œ è¿™é‡Œå…ˆä¸å±•å¼€è®²ï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»ã€‚\næ›´å¤šçš„ä»£ç ï¼Œå¦‚ luaRegisterRedisAPI å°±ä¸å±•ç¤ºäº†ï¼Œæœ‰å…´è¶£çš„å¯ä»¥å»çœ‹æºç ã€‚\n// redis-v7.2/src/eval.c#183 /* åˆå§‹åŒ– lua ç¯å¢ƒ * * redis é¦–æ¬¡å¯åŠ¨æ—¶è°ƒç”¨ï¼Œæ­¤æ—¶ setup ä¸º 1, * è¿™ä¸ªå‡½æ•°ä¹Ÿä¼šåœ¨ redis çš„å…¶ä»–ç”Ÿå‘½å‘¨æœŸä¸­è¢«è°ƒç”¨ï¼Œæ­¤æ—¶ setup ä¸º 0ï¼Œä½†æ˜¯è¢«ç®€åŒ–ä¸º scriptingReset è°ƒç”¨ã€‚ */ void scriptingInit(int setup) { lua_State *lua = lua_open(); if (setup) { // é¦–æ¬¡å¯åŠ¨æ—¶ï¼Œåˆå§‹åŒ– lua ç¯å¢ƒ å’Œ ldb (Lua debugger) çš„ä¸€äº›æ•°æ®ç»“æ„ lctx.lua_client = NULL; server.script_disable_deny_script = 0; ldbInit(); } /* åˆå§‹åŒ– lua è„šæœ¬å­—å…¸ï¼Œç”¨äºå­˜å‚¨ sha1 -\u0026gt; lua è„šæœ¬çš„æ˜ å°„ * ç”¨æˆ·ä½¿ç”¨ EVALSHA å‘½ä»¤æ—¶ï¼Œä»è¿™ä¸ªå­—å…¸ä¸­æŸ¥æ‰¾å¯¹åº”çš„ lua è„šæœ¬ã€‚ */ lctx.lua_scripts = dictCreate(\u0026amp;shaScriptObjectDictType); lctx.lua_scripts_mem = 0; /* æ³¨å†Œ redis çš„ä¸€äº› api åˆ° lua ç¯å¢ƒä¸­ */ luaRegisterRedisAPI(lua); /* æ³¨å†Œè°ƒè¯•å‘½ä»¤ */ lua_getglobal(lua,\u0026#34;redis\u0026#34;); /* redis.breakpoint */ lua_pushstring(lua,\u0026#34;breakpoint\u0026#34;); lua_pushcfunction(lua,luaRedisBreakpointCommand); lua_settable(lua, -3); /* redis.debug */ lua_pushstring(lua,\u0026#34;debug\u0026#34;); lua_pushcfunction(lua,luaRedisDebugCommand); lua_settable(lua,-3); /* redis.replicate_commands */ lua_pushstring(lua, \u0026#34;replicate_commands\u0026#34;); lua_pushcfunction(lua, luaRedisReplicateCommandsCommand); lua_settable(lua, -3); lua_setglobal(lua,\u0026#34;redis\u0026#34;); /* æ³¨å†Œä¸€ä¸ªé”™è¯¯å¤„ç†å‡½æ•°ï¼Œç”¨äºåœ¨ lua è„šæœ¬æ‰§è¡Œå‡ºé”™æ—¶ï¼Œæ‰“å°å‡ºé”™ä¿¡æ¯ã€‚ * éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“é”™è¯¯å‘ç”Ÿåœ¨ C å‡½æ•°ä¸­æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ‰“å°å‡ºé”™çš„ lua è„šæœ¬çš„ä¿¡æ¯ï¼Œ * è¿™æ ·æ‰èƒ½å¸®åŠ©ç”¨æˆ·è°ƒè¯• lua è„šæœ¬ã€‚ */ { char *errh_func = \u0026#34;local dbg = debug\\n\u0026#34; \u0026#34;debug = nil\\n\u0026#34; \u0026#34;function __redis__err__handler(err)\\n\u0026#34; \u0026#34; local i = dbg.getinfo(2,\u0026#39;nSl\u0026#39;)\\n\u0026#34; \u0026#34; if i and i.what == \u0026#39;C\u0026#39; then\\n\u0026#34; \u0026#34; i = dbg.getinfo(3,\u0026#39;nSl\u0026#39;)\\n\u0026#34; \u0026#34; end\\n\u0026#34; \u0026#34; if type(err) ~= \u0026#39;table\u0026#39; then\\n\u0026#34; \u0026#34; err = {err=\u0026#39;ERR \u0026#39; .. tostring(err)}\u0026#34; \u0026#34; end\u0026#34; \u0026#34; if i then\\n\u0026#34; \u0026#34; err[\u0026#39;source\u0026#39;] = i.source\\n\u0026#34; \u0026#34; err[\u0026#39;line\u0026#39;] = i.currentline\\n\u0026#34; \u0026#34; end\u0026#34; \u0026#34; return err\\n\u0026#34; \u0026#34;end\\n\u0026#34;; luaL_loadbuffer(lua,errh_func,strlen(errh_func),\u0026#34;@err_handler_def\u0026#34;); lua_pcall(lua,0,0,0); } /* åˆ›å»ºä¸€ä¸ª lua client (æ²¡æœ‰ç½‘ç»œè¿æ¥)ï¼Œç”¨äºåœ¨ lua ç¯å¢ƒä¸­æ‰§è¡Œ redis å‘½ä»¤ã€‚ * è¿™ä¸ªå®¢æˆ·ç«¯æ²¡å¿…è¦åœ¨ scriptingReset() è°ƒç”¨æ—¶é‡æ–°åˆ›å»ºã€‚ */ if (lctx.lua_client == NULL) { lctx.lua_client = createClient(NULL); lctx.lua_client-\u0026gt;flags |= CLIENT_SCRIPT; /* We do not want to allow blocking commands inside Lua */ lctx.lua_client-\u0026gt;flags |= CLIENT_DENY_BLOCKING; } /* Lock the global table from any changes */ lua_pushvalue(lua, LUA_GLOBALSINDEX); luaSetErrorMetatable(lua); /* Recursively lock all tables that can be reached from the global table */ luaSetTableProtectionRecursively(lua); lua_pop(lua, 1); lctx.lua = lua; } é€šè¿‡è¿™éƒ¨åˆ†ä»£ç ï¼Œåº”è¯¥å¯¹äº lua çš„åµŒå…¥å¼ä½¿ç”¨æœ‰äº†ä¸€ä¸ªå¤§æ¦‚çš„å°è±¡ã€‚è¿™é‡Œå¯ä»¥å›ç­”ä»¥ä¸‹çš„é—®é¢˜ï¼š\nlua æ˜¯å¦‚ä½•åµŒå…¥åˆ° redis ä¸­çš„ï¼Ÿ\né€šè¿‡åŒ…å« lua çš„ç›¸å…³åº“ï¼Œç„¶åé€šè¿‡ API æ¥æ“ä½œ lua ç¯å¢ƒã€‚ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š\nåˆå§‹åŒ– lua ç¯å¢ƒï¼Œä¹Ÿå°±æ˜¯ lua_State é€šè¿‡ lua çš„ API æ¥æ“ä½œ lua_Stateï¼Œæ¯”å¦‚æ³¨å†Œ redis çš„ api åˆ° lua ç¯å¢ƒä¸­ redis ä¸­çš„ lua å¯ä»¥ä½¿ç”¨é‚£äº› redis çš„ apiï¼Ÿ\nè¿™éƒ¨åˆ†ä» luaRegisterRedisAPI å‡½æ•°ä¸­å¯ä»¥çœ‹åˆ°ï¼Œredis æ³¨å†Œäº†ä»¥ä¸‹çš„ api åˆ° lua ç¯å¢ƒä¸­ï¼š\nAPI è¯´æ˜ pcall æ‰§è¡Œå‡½æ•°ï¼Œå¦‚æœå‡ºé”™è¿”å›falseå’Œé”™è¯¯ (lua å†…ç½®ï¼Œä½†æ˜¯ redis ç”¨äº†è‡ªå·±çš„å®ç°) redis.call æ‰§è¡Œ redis å‘½ä»¤ redis.pcall æ‰§è¡Œ redis å‘½ä»¤ï¼Œå¦‚æœäº§ç”Ÿå¼‚å¸¸ï¼ˆå¦‚å†…å­˜ä¸è¶³ï¼‰ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ redis.error_reply è¿”å›é”™è¯¯å›å¤çš„è¾…åŠ©å‡½æ•° { err = text } = redis.error_reply(text) redis.status_reply è¿”å›ç®€å•å­—ç¬¦ä¸²å›å¤çš„è¾…åŠ©å‡½æ•° { ok = text } = redis.status_reply(text) redis.sha1hex è¿”å›å…¶å•ä¸ªå­—ç¬¦ä¸²å‚æ•°çš„ SHA1 åå…­è¿›åˆ¶æ‘˜è¦ redis.log æ‰“å°æ—¥å¿— redis.log(redis.LOG_WARNING, \u0026lsquo;Something is terribly wrong\u0026rsquo;) redis.setresp(n) å…è®¸æ‰§è¡Œè„šæœ¬åœ¨ redis.call() å’Œ redis.pcall() è¿”å›çš„å›å¤çš„ Redis åºåˆ—åŒ–åè®® (RESP) ç‰ˆæœ¬ä¹‹é—´åˆ‡æ¢ï¼Œé»˜è®¤2 redis.set_repl è„šæœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­æ§åˆ¶æŒ‡ä»¤æ˜¯å¦ åŒæ­¥/å¤åˆ¶ redis.replicate_commands å°†è„šæœ¬çš„å¤åˆ¶æ¨¡å¼ä» é€å­—å¤åˆ¶(å¤åˆ¶è„šæœ¬) åˆ‡æ¢ä¸º æ•ˆæœå¤åˆ¶(å¤åˆ¶è„šæœ¬ç”Ÿæˆçš„å†™å…¥å‘½ä»¤)ã€‚ä» 7.0 ä»¥åé»˜è®¤æ•ˆæœå¤åˆ¶ã€‚ redis.breakpoint ä½¿ç”¨ Redis Lua è°ƒè¯•å™¨æ—¶ï¼Œæ­¤å‡½æ•°ä¼šè§¦å‘æ–­ç‚¹ redis.debug è¯¥å‡½æ•°åœ¨ Redis Lua è°ƒè¯•å™¨æ§åˆ¶å°ä¸­æ‰“å°å…¶å‚æ•° redis.register_function æ­¤å‡½æ•°åªèƒ½åœ¨ FUNCTION LOAD å‘½ä»¤çš„ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ã€‚è°ƒç”¨æ—¶ï¼Œå®ƒä¼šå‘åŠ è½½çš„åº“æ³¨å†Œä¸€ä¸ªå‡½æ•°ã€‚ math.random ç”Ÿæˆéšæœºæ•° (lua å†…ç½®ï¼Œä½†æ˜¯ redis ç”¨äº†è‡ªå·±çš„å®ç°) math.randomseed è®¾ç½®éšæœºæ•°ç§å­ (lua å†…ç½®ï¼Œä½†æ˜¯ redis ç”¨äº†è‡ªå·±çš„å®ç°) é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›è°ƒè¯•çš„ apiï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚å¯ä»¥å‚è€ƒ REDIS-LUA-API äº†è§£æ›´å¤šã€‚\nredis ä¸­çš„ lua å¯ä»¥ä½¿ç”¨é‚£äº›å˜é‡ï¼Ÿ\nè¿™éƒ¨åˆ†ä» luaRegisterRedisAPI å‡½æ•°ä¸­å¯ä»¥çœ‹åˆ°ï¼Œredis æ³¨å†Œäº†ä»¥ä¸‹çš„å˜é‡åˆ° lua ç¯å¢ƒä¸­ï¼š\nå˜é‡å è¯´æ˜ redis redis çš„å‘½åç©ºé—´ REPL_NONE REPL æ¨¡å¼ï¼Œä¸å¤åˆ¶å‘½ä»¤ REPL_AOF REPL æ¨¡å¼ï¼Œæ‰§è¡Œ lua è„šæœ¬ï¼Œå°†å‘½ä»¤å¤åˆ¶åˆ° AOF æ–‡ä»¶ä¸­ REPL_SLAVE REPL æ¨¡å¼ï¼Œæ‰§è¡Œ lua è„šæœ¬ï¼Œå°†å‘½ä»¤å¤åˆ¶åˆ°ä»èŠ‚ç‚¹ä¸­ REPL_REPLICA REPL æ¨¡å¼ï¼Œæ‰§è¡Œ lua è„šæœ¬ï¼Œå°†å‘½ä»¤å¤åˆ¶åˆ°ä»èŠ‚ç‚¹ä¸­ REPL_ALL REPL æ¨¡å¼ï¼Œæ‰§è¡Œ lua è„šæœ¬ï¼Œå°†å‘½ä»¤å¤åˆ¶åˆ° AOF æ–‡ä»¶ä¸­å’Œä»èŠ‚ç‚¹ä¸­ REDIS_VERSION_NUM redis ç‰ˆæœ¬å·ï¼Œæ¯”å¦‚ 0x00070200 è¡¨ç¤º 7.2.0 REDIS_VERSION redis ç‰ˆæœ¬å·ï¼Œæ¯”å¦‚ 7.2.0 LOG_DEBUG æ—¥å¿—çº§åˆ«ï¼Œdebug LOG_VERBOSE æ—¥å¿—çº§åˆ«ï¼Œverbose LOG_NOTICE æ—¥å¿—çº§åˆ«ï¼Œnotice LOG_WARNING æ—¥å¿—çº§åˆ«ï¼Œwarning lua-json ä¸­çš„ C # lua-json æ˜¯ä¸€ä¸ª lua çš„ json åº“ï¼Œè¿™é‡Œåªæ˜¯ç”¨æ¥å±•ç¤º lua ä¸­è°ƒç”¨ C çš„ä¾‹å­ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥é˜… lua-cjson çš„ä½¿ç”¨æ‰‹å†Œ https://www.kyne.com.au/~mark/software/lua-cjson-manual.html\nä»å®ƒçš„å¸®åŠ©æ‰‹å†Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„ä»£ç ï¼š\n-- æ¨¡å—å®ä¾‹åŒ– local cjson = require \u0026#34;cjson\u0026#34; local cjson2 = cjson.new() local cjson_safe = require \u0026#34;cjson.safe\u0026#34; -- åœ¨ lua å’Œ json ä¹‹é—´è½¬æ¢ text = cjson.encode(value) value = cjson.decode(text) -- è¯»å– lua json ä¸­çš„å€¼ setting = cjson.decode_invalid_numbers([setting]) setting = cjson.encode_invalid_numbers([setting]) keep = cjson.encode_keep_buffer([keep]) depth = cjson.encode_max_depth([depth]) depth = cjson.decode_max_depth([depth]) convert, ratio, safe = cjson.encode_sparse_array([convert[, ratio[, safe]]]) åŒæ—¶åœ¨ make å®‰è£… ä¸€èŠ‚ä¸­, æŒ‡æ˜äº†å¦‚æœéœ€è¦æ‰‹åŠ¨å®‰è£…çš„è¯ï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹çš„å‘½ä»¤ï¼š\nmake cp cjson.so $LUA_MODULE_DIRECTORY å¾ˆæ˜æ˜¾ï¼Œè¿™é‡Œçš„ cjson.so æ˜¯ä¸€ä¸ªå…±äº«åº“ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ lua ä¸­å¦‚æœæƒ³è¦è°ƒç”¨ c çš„æ‰©å±•ï¼Œé‚£ä¹ˆå…±äº«åº“æ˜¯ä¸€ç§æ–¹å¼ã€‚\nè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œlua ä¸­é€šè¿‡ require æ¥å¼•å…¥çš„æ—¶å€™ï¼Œéœ€è¦ä¿è¯ cjson.so åœ¨ lua çš„æœç´¢è·¯å¾„ä¸­ï¼ˆpackage.cpathï¼‰ã€‚\nä¸ºä»€ä¹ˆè¯´åªæ˜¯ä¸€ç§æ–¹å¼å‘¢ï¼Ÿå› ä¸º lua è¿˜æä¾›äº†ä¸€ç§æ–¹å¼ï¼Œé‚£å°±æ˜¯é€šè¿‡ lua çš„ API è®© c ä»£ç ç¼–å†™çš„å‡½æ•°æ³¨å†Œåˆ° lua ç¯å¢ƒä¸­ï¼Œç„¶ååœ¨ c ä¸­æ‰§è¡Œ lua è„šæœ¬ï¼Œå¦‚ä¸‹ï¼š\n#include \u0026lt;stdarg.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;lua.h\u0026gt; #include \u0026lt;lauxlib.h\u0026gt; #include \u0026lt;lualib.h\u0026gt; static int sumForLua(lua_State *lua) { // å¦‚æœç»™å®šè™šæ‹Ÿæ ˆä¸­ç´¢å¼•å¤„çš„å…ƒç´ å¯ä»¥è½¬æ¢ä¸ºæ•°å­—ï¼Œåˆ™è¿”å›è½¬æ¢åçš„æ•°å­—ï¼Œå¦åˆ™æŠ¥é”™ã€‚ double a = luaL_checknumber(lua, 1); double b = luaL_checknumber(lua, 2); // push è®¡ç®—ç»“æœåˆ° lua è™šæ‹Ÿæ ˆä¸­ lua_pushnumber(lua, a+b); /* è¿”å›å€¼ç”¨äºæç¤ºè¯¥Cå‡½æ•°çš„è¿”å›å€¼æ•°é‡ã€‚ * * è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼ŒCå¯ä»¥è¿”å›ç»™Luaå¤šä¸ªç»“æœï¼Œ * é€šè¿‡å¤šæ¬¡è°ƒç”¨lua_push*()ï¼Œä¹‹åreturnè¿”å›ç»“æœçš„æ•°é‡ã€‚ */ return 1; } int main(void) { lua_State *lua = lua_open(); // åˆ›å»º Lua ç¯å¢ƒ luaL_openlibs(lua); // æ‰“å¼€LuaçŠ¶æ€æœº\u0026#34;L\u0026#34;ä¸­çš„æ‰€æœ‰Luaæ ‡å‡†åº“ã€‚ // æ³¨å†Œ Cå‡½æ•°åˆ° lua ä¸­ csum å‡½æ•° lua_register(lua, \u0026#34;csum\u0026#34;, sumForLua); // æ‰§è¡Œ Lua è„šæœ¬ const char* script = \u0026#34;print(csum(3.14, 2.0))\u0026#34;; if(luaL_dostring(lua, script)) printf(\u0026#34;Failed to invoke.\\n\u0026#34;); lua_close(lua); return 0; } æˆ‘ä»¬è¿˜æ²¡æœ‰ææ¸…æ¥š c æ˜¯å¦‚ä½•ç»™ lua æ‰©å±•çš„ï¼Œå†å›åˆ° lua-cjson çš„æºç ä¸­å»ï¼š\n// https://github.com/mpx/lua-cjson/blob/master/lua_cjson.c#1416 CJSON_EXPORT int luaopen_cjson(lua_State *l) { // local cjson = require \u0026#34;cjson\u0026#34; lua_cjson_new(l); // å¦‚æœç¼–è¯‘æ—¶å®šä¹‰äº† ENABLE_CJSON_GLOBALï¼Œæ³¨å†Œ cjson (table) åˆ°å…¨å±€å˜é‡ä¸­ #ifdef ENABLE_CJSON_GLOBAL lua_pushvalue(l, -1); // #define CJSON_MODNAME \u0026#34;cjson\u0026#34; lua_setglobal(l, CJSON_MODNAME); #endif return 1; } // cjson æ¨¡å—ï¼ˆtableï¼‰çš„åˆå§‹åŒ– static int lua_cjson_new(lua_State *l) { // å‡½æ•°æ³¨å†Œè¡¨, è¿™äº›å‡½æ•°çš„å‡½æ•°åŸå‹éƒ½æ»¡è¶³ï¼š // int (*lua_CFunction) (lua_State *L); return value: number of results // // æ³¨å†Œè¡¨ç»“æ„ä½“ï¼š // typedef struct luaL_Reg { // const char *name; // lua_CFunction func; // } luaL_Reg; // luaL_Reg reg[] = { { \u0026#34;encode\u0026#34;, json_encode }, { \u0026#34;decode\u0026#34;, json_decode }, { \u0026#34;encode_sparse_array\u0026#34;, json_cfg_encode_sparse_array }, { \u0026#34;encode_max_depth\u0026#34;, json_cfg_encode_max_depth }, { \u0026#34;decode_max_depth\u0026#34;, json_cfg_decode_max_depth }, { \u0026#34;encode_number_precision\u0026#34;, json_cfg_encode_number_precision }, { \u0026#34;encode_keep_buffer\u0026#34;, json_cfg_encode_keep_buffer }, { \u0026#34;encode_invalid_numbers\u0026#34;, json_cfg_encode_invalid_numbers }, { \u0026#34;decode_invalid_numbers\u0026#34;, json_cfg_decode_invalid_numbers }, { \u0026#34;new\u0026#34;, lua_cjson_new }, { NULL, NULL } /* ä»¥ NULL, NULL ç»“æŸ */ }; // ... // åˆ›å»ºä¸€ä¸ªæ–°çš„ table, å¹¶ä¸”å°†å…¶å‹å…¥æ ˆä¸­ lua_newtable(l); // ... json_create_config(l); // å°† reg ä¸­çš„å‡½æ•°æ³¨å†Œåˆ° table ä¸­ // void luaL_setfuncs (lua_State *L, const luaL_Reg *l, int nup); // nup = 1 (ä¸ç­‰äº0) è¡¨ç¤ºå°† nup ä½ç½®çš„å€¼å‰¯æœ¬æ¥åˆå§‹åŒ–æ‰€æœ‰çš„å‡½æ•°ï¼Œè¿™äº›å€¼ä¼šå¼¹å‡ºæ ˆã€‚ // å› æ­¤è¿™é‡Œæ˜¯ç»™ reg ä¸­çš„æ‰€æœ‰å‡½æ•°éƒ½éšå¼çš„ä¼ å…¥äº†ä¸€ä¸ª config å‚æ•°, å‡½æ•°å†…éƒ¨å¯ä»¥é€šè¿‡ // int lua_upvalueindex(int i); lua_to* å‡½æ•°æ¥è·å–è¿™ä¸ªå‚æ•°ã€‚ luaL_setfuncs(l, reg, 1); // è®¾ç½® table.null = nil, userdata ä»£è¡¨ Luaä¸­çš„ C å€¼ lua_pushlightuserdata(l, NULL); // void lua_setfield (lua_State *L, int index, const char *k); // table = stack[index]; table[k] = v (stack[-1]), è®¾ç½®å vä¼šä»æ ˆä¸­å¼¹å‡º lua_setfield(l, -2, \u0026#34;null\u0026#34;); // ä¸‹é¢çš„ç±»ä¼¼ï¼Œéƒ½æ˜¯åœ¨è®¾ç½® table ä¸­çš„å­—æ®µ, å¦‚: _NAME, _VERSION lua_pushliteral(l, CJSON_MODNAME); lua_setfield(l, -2, \u0026#34;_NAME\u0026#34;); lua_pushliteral(l, CJSON_VERSION); lua_setfield(l, -2, \u0026#34;_VERSION\u0026#34;); // æ­¤æ—¶æ ˆä¸­è¿˜å‰©ä¸‹ 1 ä¸ª table return 1; } æˆ‘ä»¬æ¥å¼•å…¥ lua-cjson æ¨¡å—æ¥çœ‹çœ‹ï¼š\nè¿™é‡Œå› ä¸ºæˆ‘ä½¿ç”¨çš„æ˜¯ lua 5.4, è€Œ lua-cjson è²Œä¼¼ä¸å…¼å®¹ï¼Ÿ\nè¿™æ ·æˆ‘ä»¬ä¹Ÿå¤§æ¦‚å¼„æ¸…æ¥šäº†ï¼Œå¦‚ä½•ä¸º lua æ‰©å±• c ä»£ç äº†:\nç¼–å†™ä¸€ä¸ª luaopen_xxx å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šåœ¨ lua ä¸­é€šè¿‡ require \u0026ldquo;xxx\u0026rdquo; æ—¶è¢«è°ƒç”¨ï¼› åœ¨ luaopen_xxx å»æ³¨å†Œ c æ¨¡å—æˆ–è€…å‡½æ•°åˆ° lua ç¯å¢ƒä¸­ï¼› å°† c æ‰©å±•ç¼–è¯‘ä¸º so æ–‡ä»¶ï¼Œç„¶åå°† so æ–‡ä»¶æ”¾åˆ° lua çš„æœç´¢è·¯å¾„ä¸­ï¼› lua å’Œ C äº’æ“ä½œçš„åŸºç¡€ # é€šè¿‡ä¸Šè¿°çš„ä¾‹å­ï¼Œå¯¹äº lua å’Œ C äº’æ“ä½œæœ‰äº†ä¸€ä¸ªå¤§æ¦‚çš„å°è±¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬çœ‹åˆ°çš„ä»£ç ä¸­é‚£äº› lua_ å’Œ luaL_ å¼€å¤´çš„å‡½æ•°æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå„ç§ lua_push* å’Œ lua_pop* ä¹‹ç±»çš„å‡½æ•°åˆæ˜¯åšä»€ä¹ˆçš„å‘¢ï¼Ÿ\nåœ¨ PIL çš„ 24.2 å°èŠ‚ä¸­è§£é‡Šåœ¨ Lua å’Œ C API äº¤äº’çš„è¿‡ç¨‹ä¸­ï¼Œä¼šä½¿ç”¨ä¸€æŠ½è±¡æ ˆæ¥ä¼ é€’æ•°æ®ï¼Œè¿™ä¸ªè™šæ‹Ÿæ ˆæ˜¯ä¸€ä¸ª LIFO æ ˆï¼Œå®ƒç”± Lua æ¥ç®¡ç†ï¼ˆæ–¹ä¾¿ lua çš„åƒåœ¾æ”¶é›†å™¨å·¥ä½œï¼‰ã€‚è¯¥æ ˆä¸­çš„æ¯ä¸ªæ§½éƒ½å¯ä»¥ä¿å­˜ä»»ä½• Lua å€¼ã€‚æ¯å½“ä½ æƒ³ä» Lua è¯·æ±‚ä¸€ä¸ªå€¼ï¼ˆä¾‹å¦‚å…¨å±€å˜é‡çš„å€¼ï¼‰æ—¶ï¼Œä½ å°±è°ƒç”¨ Luaï¼Œå®ƒå°†æ‰€éœ€çš„å€¼å‹å…¥å †æ ˆã€‚æ¯å½“ä½ æƒ³å‘ Lua ä¼ é€’ä¸€ä¸ªå€¼æ—¶ï¼Œä½ é¦–å…ˆå°†å€¼å‹å…¥å †æ ˆï¼Œç„¶åè°ƒç”¨ Luaï¼ˆè¿™å°†å¼¹å‡ºè¯¥å€¼ï¼‰ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™šæ‹Ÿæ ˆå¹¶ä¸æ˜¯æ— é™çš„ï¼Œå®ƒçš„å¤§å°å¯ä»¥é€šè¿‡ lua.h ä¸­çš„ LUA_MINSTACK å®šä¹‰çš„ã€‚é€šå¸¸æ¥è¯´è™šæ‹Ÿæ ˆçš„å¤§å°æ˜¯ 20ï¼Œä¸€èˆ¬æƒ…å†µè¶³å¤Ÿä½¿ç”¨äº†ã€‚å¦‚æœä¸ç¡®å®æ ˆç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ int lua_checkstack (lua_State *L, int sz); æ¥æ£€æŸ¥ã€‚\næœ‰äº†è¿™ä¸ªåŸºç¡€æˆ‘ä»¬å°±å¾ˆå®¹æ˜“ç†è§£ï¼Œä¸Šé¢ redis ä¸­çš„æ˜¯å¦‚ä½•å»åˆå§‹åŒ– lua ç¯å¢ƒçš„ã€‚\né‡æ–°è§£è¯» redis ä¸­çš„ lua åˆå§‹åŒ– # ä¸ºäº†æ›´å®¹æ˜“çš„è§£è¯»ï¼Œè¿™é‡ŒæŠŠä¸€äº› lua_ å‡½æ•°åšäº†ç®€å•çš„è¯´æ˜ï¼š\nå‡½æ•°å è¯´æ˜ lua_State *lua_newstate (lua_Alloc f, void *ud); åˆ›å»ºä¸€ä¸ªæ–°çš„ lua ç¯å¢ƒ, lua_open çš„æ›¿ä»£ int lua_getglobal (lua_State *L, const char *name); æŠŠå…¨å±€å˜é‡çš„å€¼å‹å…¥å †æ ˆ, ç­‰ä»·å£°æ˜äº†ä¸€ä¸ª name çš„å…¨å±€å˜é‡ void lua_setglobal (lua_State *L, const char *name); æŠŠå †æ ˆé¡¶éƒ¨çš„å€¼å¼¹å‡ºå¹¶è®¾ç½®ä¸º name å…¨å±€å˜é‡ const char *lua_pushstring (lua_State *L, const char *s); æŠŠä¸€ä¸ªå­—ç¬¦ä¸²å‹å…¥å †æ ˆï¼Œlua ä¼šåˆ›å»º s çš„å‰¯æœ¬æˆ–è€…å¤ç”¨å†…éƒ¨çš„å‰¯æœ¬ void lua_pushcfunction (lua_State *L, lua_CFunction f); æŠŠä¸€ä¸ª C å‡½æ•°å‹å…¥å †æ ˆ void lua_settable (lua_State *L, int index); ç»™ table çš„è®¾å®š kv, ç­‰ä»·äº table[k] = v, table = stack[index], v=stack[-1], k=stack[-2], ä¼šä»æ ˆä¸­å¼¹å‡º k/v // redis-v7.2/src/eval.c#183 void scriptingInit(int setup) { // ... some codes ignored // å£°æ˜å…¨å±€å˜é‡ redis, åŒæ—¶å‹å…¥æ ˆä¸­ lua_getglobal(lua, \u0026#34;redis\u0026#34;); // å¾€è™šæ‹Ÿæ ˆä¸­å‹å…¥ å­—ç¬¦ä¸² \u0026#34;breakpoint\u0026#34; lua_pushstring(lua, \u0026#34;breakpoint\u0026#34;); // å¾€è™šæ‹Ÿæ ˆä¸­å‹å…¥ C å‡½æ•° luaRedisBreakpointCommand lua_pushcfunction(lua, luaRedisBreakpointCommand); // è®¾ç½® redis[\u0026#34;breakpoint\u0026#34;] = luaRedisBreakpointCommand lua_settable(lua, -3); // å°† redis å¼¹å‡ºæ ˆ lua_setglobal(lua, \u0026#34;redis\u0026#34;); // ... some codes ignored } ä¸Šé¢çš„ç‰‡æ®µç­‰ä»·äºä»¥ä¸‹çš„ lua ä»£ç ï¼š\nredis = {} redis[\u0026#34;breakpoint\u0026#34;] = luaRedisBreakpointCommand è¿™æœŸé—´çš„æ ˆç©ºé—´å˜åŒ–å¯ä»¥ç”¨ä¸‹é¢çš„å›¾æ¥è¡¨ç¤ºï¼š\n+----bottom----+ | {} | [1, -3] lua_getglobal(lua, \u0026#34;redis\u0026#34;); +--------------+ | \u0026#34;breakpoint\u0026#34; | [2, -2] lua_pushstring(lua,\u0026#34;breakpoint\u0026#34;); +--------------+ | function | [3, -1] lua_pushcfunction(lua,luaRedisBreakpointCommand); +------top-----+ +---------------------bottom--------------------------+ | {\u0026#34;breakpoint\u0026#34;: luaRedisBreakpointCommand} | [1, -1] lua_settable(lua, -3); +-----------------------top---------------------------+ å¼‚å¸¸å¤„ç† # è™½ç„¶ C è¯­è¨€æ²¡æœ‰æä¾›å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œä½†æ˜¯åœ¨ lua ä¸­æä¾›äº† error å’Œ pcall å‡½æ•°æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œå¤„ç†å¼‚å¸¸ã€‚å› æ­¤åœ¨ lua å’Œ C äº¤äº’çš„è¿‡ç¨‹ä¸­ï¼Œç‰¹æ„æä¾›äº†ä¸€äº›å‡½æ•°æ¥å¤„ç†å¼‚å¸¸ã€‚å¦‚ lua_pcallï¼Œåœ¨è°ƒç”¨æœŸé—´å¦‚æœæ²¡æœ‰å¼‚å¸¸ï¼Œé‚£ä¹ˆ lua_pcall å’Œ lua_call è¡Œä¸ºä¸€è‡´ï¼Œåä¹‹å¦‚æœå‘ç”Ÿäº†å¼‚å¸¸ï¼Œé‚£ä¹ˆ lua_pcall ä¼šæ•è·å¼‚å¸¸ï¼Œå¹¶æŠŠé”™è¯¯å¯¹è±¡ï¼ˆå•ä¸ªå€¼ï¼‰å‹å…¥å †æ ˆï¼Œå¹¶è¿”å›é”™è¯¯ç ã€‚åŒæ—¶ä»å †æ ˆä¸­åˆ é™¤å‡½æ•°å’Œå‚æ•°ã€‚\n// æ™®é€šè°ƒç”¨ void lua_call (lua_State *L, int nargs, int nresults); // å¼‚å¸¸æ•è·è°ƒç”¨ // msgh ç”¨äºæ˜¯å¦ä½¿ç”¨è‡ªå®šä¹‰çš„é”™è¯¯å¤„ç†å‡½æ•°ï¼Œå¦‚æœä¸º 0ï¼Œé‚£ä¹ˆä½¿ç”¨é»˜è®¤çš„é”™è¯¯å¤„ç†å‡½æ•° // å¦åˆ™ï¼Œmsgh ç”¨äºè¯´æ˜ï¼šå¼‚å¸¸æ¶ˆæ¯å¤„ç†å‡½æ•°åœ¨å †æ ˆä¸­çš„ä½ç½® int lua_pcall (lua_State *L, int nargs, int nresults, int msgh); åº”è¯¥è¿˜è®°å¾— redis ä¸­çš„ lua åˆå§‹åŒ–ä»£ç ä¸­æœ‰è¿™ä¹ˆä¸€æ®µï¼š\n// redis-v7.2/src/eval.c#183 void scriptingInit(int setup) { // ... /* æ³¨å†Œä¸€ä¸ªé”™è¯¯å¤„ç†å‡½æ•°ï¼Œç”¨äºåœ¨ lua è„šæœ¬æ‰§è¡Œå‡ºé”™æ—¶ï¼Œæ‰“å°å‡ºé”™ä¿¡æ¯ã€‚ * éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“é”™è¯¯å‘ç”Ÿåœ¨ C å‡½æ•°ä¸­æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ‰“å°å‡ºé”™çš„ lua è„šæœ¬çš„ä¿¡æ¯ï¼Œ * è¿™æ ·æ‰èƒ½å¸®åŠ©ç”¨æˆ·è°ƒè¯• lua è„šæœ¬ã€‚ */ { char *errh_func = \u0026#34;local dbg = debug\\n\u0026#34; \u0026#34;debug = nil\\n\u0026#34; \u0026#34;function __redis__err__handler(err)\\n\u0026#34; \u0026#34; local i = dbg.getinfo(2,\u0026#39;nSl\u0026#39;)\\n\u0026#34; \u0026#34; if i and i.what == \u0026#39;C\u0026#39; then\\n\u0026#34; \u0026#34; i = dbg.getinfo(3,\u0026#39;nSl\u0026#39;)\\n\u0026#34; \u0026#34; end\\n\u0026#34; \u0026#34; if type(err) ~= \u0026#39;table\u0026#39; then\\n\u0026#34; \u0026#34; err = {err=\u0026#39;ERR \u0026#39; .. tostring(err)}\u0026#34; \u0026#34; end\u0026#34; \u0026#34; if i then\\n\u0026#34; \u0026#34; err[\u0026#39;source\u0026#39;] = i.source\\n\u0026#34; \u0026#34; err[\u0026#39;line\u0026#39;] = i.currentline\\n\u0026#34; \u0026#34; end\u0026#34; \u0026#34; return err\\n\u0026#34; \u0026#34;end\\n\u0026#34;; // int luaL_loadbuffer (lua_State *L, const char *buff, size_t sz, const char *name); // åŠ è½½ lua å—ï¼Œä½†æ˜¯ä¸æ‰§è¡Œï¼Œä¼šå°†ç¼–è¯‘åçš„ lua å—å‹å…¥æ ˆä¸­ï¼Œå¦‚æœå‡ºé”™ä¼šå°†é”™è¯¯ä¿¡æ¯å‹å…¥æ ˆä¸­ luaL_loadbuffer(lua, errh_func, strlen(errh_func), \u0026#34;@err_handler_def\u0026#34;); // int lua_pcall (lua_State *L, int nargs, int nresults, int msgh); // æ‰§è¡Œ lua å—ï¼Œå¦‚æœå‡ºé”™ï¼Œpcall ä¼šå°†é”™è¯¯ä¿¡æ¯å‹å…¥æ ˆä¸­ lua_pcall(lua, 0, 0, 0); } // ... } è¿™é‡Œè¿™ä¹ˆåªæ˜¯å®Œæˆäº†å®šä¹‰é”™è¯¯å¤„ç†å‡½æ•°ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ä½¿ç”¨ï¼Œå› ä¸ºéœ€è¦åœ¨ lua_pcall(lua_State *L, int nargs, int nresults, int msgh) é€šè¿‡ msgh æ¥æŒ‡å®šæ‰èƒ½ä½¿ç”¨ã€‚é‚£ä¹ˆå†çœ‹çœ‹ redis ä¸­çš„å…³äº __redis__err__handler çš„ä½¿ç”¨ï¼š\n// redis-v7.2/src/eval.c#472 void evalGenericCommand(client *c, int evalsha) { // ... // å°† __redis__err__handler å‹å…¥æ ˆä¸­ï¼Œå·²ç»åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­é€šè¿‡ lua å—å®šä¹‰æˆäº†å…¨å±€å˜é‡ lua_getglobal(lua, \u0026#34;__redis__err__handler\u0026#34;); // ... // void luaCallFunction(scriptRunCtx* run_ctx, lua_State *lua, robj** keys, size_t nkeys, robj** args, size_t nargs, int debug_enabled) luaCallFunction(\u0026amp;rctx, lua, c-\u0026gt;argv+3, numkeys, c-\u0026gt;argv+3+numkeys, c-\u0026gt;argc-3-numkeys, ldb.active); // ä»æ ˆä¸­ç§»é™¤ __redis__err__handler lua_pop(lua,1); // ... } // redis-v7.2/src/script_lua.c#L1615 void luaCallFunction(scriptRunCtx* run_ctx, lua_State *lua, robj** keys, size_t nkeys, robj** args, size_t nargs, int debug_enabled) { // ... // åˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œç”¨äºå­˜å‚¨ keys luaCreateArray(lua,keys,nkeys); if (run_ctx-\u0026gt;flags \u0026amp; SCRIPT_EVAL_MODE){ // EVALæ¨¡å¼ï¼šKEYS ä»æ ˆä¸­å¼¹å‡ºæˆä¸ºå…¨å±€å˜é‡ KEYS lua_enablereadonlytable(lua, LUA_GLOBALSINDEX, 0); lua_setglobal(lua,\u0026#34;KEYS\u0026#34;); lua_enablereadonlytable(lua, LUA_GLOBALSINDEX, 1); } // ä¸‹åŒï¼Œåˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œç”¨äºå­˜å‚¨ args luaCreateArray(lua,args,nargs); if (run_ctx-\u0026gt;flags \u0026amp; SCRIPT_EVAL_MODE){ lua_enablereadonlytable(lua, LUA_GLOBALSINDEX, 0); lua_setglobal(lua,\u0026#34;ARGV\u0026#34;); lua_enablereadonlytable(lua, LUA_GLOBALSINDEX, 1); } /* æ‰§è¡Œ lua è„šæœ¬ * å¦‚æœæ˜¯ EVAL æ¨¡å¼, é‚£ä¹ˆ lua ä»£ç åº”è¯¥æ²¡æœ‰å‚æ•°ï¼Œç„¶åæ¥å—ä¸€ä¸ªè¿”å›å€¼ï¼Œæ­¤æ—¶ error_handler åœ¨ -2 çš„ä½ç½®ã€‚ * å¦‚æœæ˜¯ FUNCTION æ¨¡å¼ï¼Œé‚£ä¹ˆ lua ä»£ç åº”è¯¥æœ‰ä¸¤ä¸ªå‚æ•°ï¼ˆkeys å’Œ args æ•°ç»„ï¼‰ï¼Œç„¶åæ¥å—ä¸€ä¸ªè¿”å›å€¼ï¼Œ * æ­¤æ—¶ error_handler åœ¨ -4 (stack: error_handler, callback, keys, args) çš„ä½ç½®ã€‚ */ int err; if (run_ctx-\u0026gt;flags \u0026amp; SCRIPT_EVAL_MODE) { err = lua_pcall(lua,0,1,-2); } else { err = lua_pcall(lua,2,1,-4); } // ... } åŠ¨æ‰‹å®è·µ # ä½¿ç”¨ c ç¼–å†™ä¸€ä¸ªç”Ÿæˆ snowflake ID çš„åº“ï¼Œ åŒæ—¶æä¾› lua æ‰©å±•ï¼Œä¸»è¦ä»£ç å¦‚ä¸‹ï¼š\nå®Œæ•´ä»£ç å¯ä»¥åœ¨ yeqown/snowflake/contrib/lua æŸ¥çœ‹\nrequire \u0026#34;snowflake\u0026#34; print(\u0026#34; NAME: \u0026#34; .. snowflake._NAME) print(\u0026#34;VERSION: \u0026#34; .. snowflake._VERSION) print(\u0026#34; AUTHOR: \u0026#34; .. snowflake._AUTHOR) local worker = snowflake.new(1) local id = worker.next_id() print(\u0026#34;generating one id: \u0026#34; .. id .. \u0026#34;\\n\u0026#34;) print(\u0026#34;parsing snowflake id: \u0026#34; .. id) local state = snowflake.parse(id); print(\u0026#34;timestamp: \u0026#34; .. state.timestamp) print(\u0026#34;worker_id: \u0026#34; .. state.worker_id) print(\u0026#34; count: \u0026#34; .. state.count .. \u0026#34;\\n\u0026#34;) print(\u0026#34;generating 10 ids in a batch: \u0026#34;) local ids = worker.next_ids(10) for i, id in ipairs(ids) do print(id) end è¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š\n/* * Usage in lua: * worker = snowflake.new(1?) */ int l_snowflake_new(lua_State *L) { uint64_t worker_id = 0; // ... lua_newtable(L); snowflake_Worker *worker = snowflake_NewWorker(worker_id); // ... lua_pushlightuserdata(L, worker); luaL_Reg snowflake_worker_funcs[] = { {\u0026#34;next_id\u0026#34;, l_snowflake_worker_next_id}, {\u0026#34;next_ids\u0026#34;, l_snowflake_worker_next_ids}, {NULL, NULL}, }; luaL_setfuncs(L, snowflake_worker_funcs, 1); return 1; } /* * Usage in Lua: * snowflake.parse() */ int l_snowflake_parse(lua_State *L) { uint64_t id = (uint64_t) lua_tointegerx(L, -1, NULL); // ... lua_pop(L, -1); const snowflake_IDState *state = snowflake_ParseId((snowflake_ID) id); lua_newtable(L); lua_pushinteger(L, (long long) state-\u0026gt;timestamp); lua_setfield(L, -1, \u0026#34;timestamp\u0026#34;); lua_pushinteger(L, (long long) state-\u0026gt;worker_id); lua_setfield(L, -1, \u0026#34;worker_id\u0026#34;); lua_pushinteger(L, (long long) state-\u0026gt;count); lua_setfield(L, -1, \u0026#34;count\u0026#34;); return 1; } /* * Usage in lua: * local worker = snowflake.new(1) * local id = worker.next_id() */ int l_snowflake_worker_next_id(lua_State *L) { snowflake_Worker *worker = (snowflake_Worker *) lua_touserdata(L, lua_upvalueindex(1)); // ... snowflake_ID id = snowflake_NextId(worker, true); // ... lua_pushinteger(L, (long long) id); return 1; } /* * Usage in Lua: * local worker = snowflake.new(1) * local ids = worker.next_ids(10) */ int l_snowflake_worker_next_ids(lua_State *L) { // ... uint64_t count = (uint64_t) lua_tointegerx(L, -1, NULL); // ... lua_pop(L, -1); snowflake_Worker *worker = (snowflake_Worker *) lua_touserdata(L, lua_upvalueindex(1)); // ... snowflake_ID *ids = malloc(sizeof(snowflake_ID) * count); if (snowflake_NextIds(worker, count, ids, false) \u0026lt;= 0) { lua_pushstring(L, \u0026#34;failed to generate snowflake ids\u0026#34;); lua_error(L); } lua_newtable(L); for (uint64_t i = 0; i \u0026lt; count; i++) { lua_pushinteger(L, (long long) ids[i]); lua_rawseti(L, -2, i + 1); } free(ids); return 1; } int luaopen_snowflake(lua_State *L) { luaL_Reg snowflake_lib[] = { {\u0026#34;new\u0026#34;, l_snowflake_new}, {\u0026#34;parse\u0026#34;, l_snowflake_parse}, {NULL, NULL} }; luaL_newlib(L, snowflake_lib); lua_pushliteral(L, \u0026#34;_AUTHOR\u0026#34;); lua_setfield(L, -2, \u0026#34;yeqown\u0026#34;); lua_pushliteral(L, \u0026#34;lua-snowflake\u0026#34;); lua_setfield(L, -2, \u0026#34;_NAME\u0026#34;); lua_pushliteral(L, \u0026#34;0.1.0\u0026#34;); lua_setfield(L, -2, \u0026#34;_VERSION\u0026#34;); // set snowflake as global variable lua_pushvalue(L, -1); lua_setglobal(L, \u0026#34;snowflake\u0026#34;); return 1; } è¿™é‡Œå°±ä¸å†å±•å¼€è®²è§£äº†ï¼Œé‡Œé¢çš„æ¯ä¸€éƒ¨åˆ†éƒ½æ˜¯å‰é¢è®²è§£çš„å†…å®¹ï¼Œè¿™é‡Œåªæ˜¯åšäº†ä¸€ä¸ªç®€å•çš„æ•´åˆã€‚å½“ç„¶å®é™…æ‰©å±•çš„æ—¶å€™ï¼Œä¸ä¼šè¿™ä¹ˆç®€å•ï¼Œå¯èƒ½éœ€è¦å¤„ç†å¤æ‚çš„æ•°æ®ç»“æ„ï¼Œç¹ççš„æµç¨‹ï¼Œä½†è¿™ä¸åœ¨æœ¬æ–‡çš„è®¨è®ºèŒƒå›´å†…ï¼Œè¯·å–„ç”¨å·¥å…·å’Œå®˜æ–¹æ–‡æ¡£ã€‚\næ€»ç»“ # lua æœ¬èº«å°±æ˜¯ç”± C è¯­è¨€ç¼–å†™çš„ï¼Œå› æ­¤ lua å’Œ C ä¹‹é—´çš„äº¤äº’æ˜¯éå¸¸æ–¹ä¾¿çš„ã€‚è€Œä»–ä»¬äº¤äº’çš„æ ¸å¿ƒæ–¹å¼å°±æ˜¯é€šè¿‡ lua çš„è™šæ‹Ÿæ ˆæ¥ä¼ é€’æ•°æ®ï¼Œç„¶åé€šè¿‡ lua çš„ API æ¥æ“ä½œè™šæ‹Ÿæ ˆã€‚\nå‚è€ƒ # lua.org manual v5.4 C-API å’Œ auxiliary library Programming in Lua Part IV - The C API The Application API "},{"id":18,"href":"/2023/08/17/tcp-%E9%95%BF%E8%BF%9E%E6%8E%A5%E6%9C%8D%E5%8A%A1%E4%BC%98%E9%9B%85%E9%87%8D%E5%90%AF%E7%9A%84%E7%A7%98%E5%AF%86/","title":"Tcp é•¿è¿æ¥æœåŠ¡ä¼˜é›…é‡å¯çš„ç§˜å¯†","section":"Posts","content":"å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªé•¿è¿æ¥æœåŠ¡ï¼Œæˆ‘ä»¬æƒ³è¦å¯¹å®ƒè¿›è¡Œå‡çº§ï¼Œä½†æ˜¯ä¸æƒ³è®©å®¢æˆ·ç«¯å—åˆ°å½±å“åº”è¯¥æ€ä¹ˆåšï¼Ÿè¿™ä¸ªé—®é¢˜å…¶å®æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„é—®é¢˜ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„æ¸¸æˆæœåŠ¡å™¨ï¼Œæˆ‘ä»¬çš„ IM æœåŠ¡å™¨ï¼Œæ¨é€æœåŠ¡å™¨ç­‰ç­‰ï¼Œè¯¸å¦‚æ­¤ç±»ä½¿ç”¨tcpé•¿è¿æ¥çš„æœåŠ¡ï¼Œéƒ½ä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜ã€‚é‚£ä¹ˆæˆ‘ä»¬åº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ\néœ€æ±‚åˆ†æ # æˆ‘ä»¬å¯ä»¥å…ˆæ¥çœ‹ä¸‹è¿™ä¸ªåœºæ™¯ä¸‹çš„éœ€æ±‚ï¼š\nå®¢æˆ·ç«¯å¿…é¡»è¦å¯¹è¿™ä¸ªæ“ä½œæ²¡æœ‰æ„ŸçŸ¥ï¼Œä¹Ÿå°±æ˜¯è¯´å®¢æˆ·ç«¯ä¸éœ€è¦åšä»»ä½•çš„ä¿®æ”¹ï¼Œåœ¨æœåŠ¡å™¨å‡çº§çš„è¿‡ç¨‹ä¸­ä¸éœ€è¦é…åˆã€‚ æœåŠ¡å™¨åœ¨å‡çº§çš„è¿‡ç¨‹ä¸­ï¼Œä¸èƒ½ä¸¢å¤±ä»»ä½•çš„è¿æ¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæœ‰æ–°çš„è¿æ¥è¿›æ¥ï¼Œé‚£ä¹ˆè¿™ä¸ªè¿æ¥å¿…é¡»è¦è¢«æ¥å—ï¼Œå¦‚æœæœ‰æ—§çš„è¿æ¥ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¸èƒ½å¤Ÿè§¦å‘é‡è¿ã€‚ åŸºæœ¬æ€è·¯ # å®ç°æ€è·¯çš„è®¨è®ºèŒƒå›´é™åˆ¶åœ¨ linux æœåŠ¡å™¨ä¸Š\nä¸ºäº†å®ç°ä¸Šè¿°çš„è¦æ±‚ï¼Œé¦–å…ˆåœ¨å‡çº§æµç¨‹ä¸­æˆ‘ä»¬éœ€è¦åšåˆ°ä»¥ä¸‹å‡ ç‚¹ï¼š\næ—§çš„æœåŠ¡å™¨è¿›ç¨‹åœ¨å¤„ç†å®Œè¯·æ±‚å‰ä¸èƒ½é€€å‡ºï¼Œè€Œä¸”ä¸€æ—¦å‡çº§å¼€å§‹å°±ä¸èƒ½å†æ¥å—æ–°çš„è¿æ¥ã€‚ æ—§çš„æœåŠ¡å™¨è¿›ç¨‹åœ¨æ‰€æœ‰è¿æ¥éƒ½å¤„ç†å®Œæ¯•åæ‰èƒ½é€€å‡ºã€‚ æ–°çš„æœåŠ¡å™¨è¿›ç¨‹åœ¨å¯åŠ¨æ—¶éœ€è¦ç»§æ‰¿æ—§çš„æœåŠ¡å™¨è¿›ç¨‹çš„æ‰€æœ‰è¿æ¥ï¼Œæ–°çš„è¿æ¥ä¹Ÿåº”è¯¥è¢«æ–°çš„æœåŠ¡å™¨è¿›ç¨‹æ¥å—ã€‚ æ–°çš„æœåŠ¡å™¨è¿›ç¨‹ä¹Ÿå¿…é¡»ç›‘å¬æ—§çš„æœåŠ¡å™¨è¿›ç¨‹çš„ç›‘å¬ç«¯å£ï¼Œå¦åˆ™æ–°çš„è¿æ¥æ— æ³•è¢«æ¥å—ã€‚ é‚£ä¹ˆé€šè¿‡ Google å’Œ ChatGPT çš„å¸®åŠ©ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ä¸€äº›æ€è·¯ï¼š\næ–°è¿›ç¨‹ç»§æ‰¿æ—§è¿›ç¨‹çš„ï¼ˆç›‘å¬ï¼‰å¥—æ¥å­—ï¼Œè€Œä¸æ˜¯åˆ›å»ºæ–°çš„ã€‚\nä¸ºä»€ä¹ˆä¸åˆ›å»ºæ–°çš„ï¼ˆç›‘å¬ï¼‰å¥—æ¥å­—å‘¢ï¼Ÿåœ¨ linux ä¸­å†…æ ¸ä¼šæŠŠå¤„åœ¨ä¸åŒæ¡æ‰‹é˜¶æ®µçš„TCPè¿æ¥æ”¾åœ¨ä¸åŒçš„é˜Ÿåˆ—ä¸­ï¼ˆåŠè¿æ¥/å…¨è¿æ¥ï¼‰ã€‚æœåŠ¡å™¨çš„ç›‘å¬å¥—æ¥å­—ä¼šæœ‰è‡ªå·±çš„é˜Ÿåˆ—ï¼Œå¦‚æœåˆ›å»ºæ–°çš„å¥—æ¥å­—ï¼Œé‚£ä¹ˆæ—§çš„å¥—æ¥å­—é˜Ÿåˆ—ä¸­çš„è¿æ¥å°±ä¼šä¸¢å¤±ã€‚ä¸ºäº†åšåˆ°å®¢æˆ·ç«¯æ— æ„ŸçŸ¥ï¼Œæˆ‘ä»¬éœ€è¦ç»§æ‰¿æ—§çš„å¥—æ¥å­—ï¼ˆä¸»è¦æ˜¯ä¸ºäº†è¿æ¥é˜Ÿåˆ—ä¸­çš„è¿æ¥ä¸ä¸¢å¤±ï¼‰ã€‚\nåŠè¿æ¥é˜Ÿåˆ—ï¼šå½“å®¢æˆ·ç«¯å‘é€ SYN åŒ…æ—¶ï¼ŒæœåŠ¡å™¨ä¼šæŠŠè¿™ä¸ªè¿æ¥æ”¾åœ¨åŠè¿æ¥é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…æœåŠ¡å™¨çš„ ACK åŒ…ï¼Œè¿™ä¸ªæ—¶å€™è¿æ¥å¤„äºåŠè¿æ¥çŠ¶æ€ã€‚å½“æœåŠ¡å™¨å‘é€ ACK åŒ…æ—¶ï¼Œè¿™ä¸ªè¿æ¥å°±ä¼šä»åŠè¿æ¥é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œæ”¾åˆ°å…¨è¿æ¥é˜Ÿåˆ—ä¸­ï¼Œè¿™ä¸ªæ—¶å€™è¿æ¥å¤„äºå…¨è¿æ¥çŠ¶æ€ã€‚å½“æœåŠ¡å™¨è°ƒç”¨ accept æ—¶ï¼Œå°±ä¼šä»å…¨è¿æ¥é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªè¿æ¥ï¼Œè¿™ä¸ªæ—¶å€™è¿æ¥å¤„äº ESTABLISHED çŠ¶æ€ã€‚\nå®ç°æ–¹å¼ # é‚£ä¹ˆåœ¨ linux ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥å¦‚ä¸‹æ–¹å¼å®ç°ï¼š\né€šè¿‡ fork åˆ›å»ºå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹ç»§æ‰¿çˆ¶è¿›ç¨‹çš„æ‰€æœ‰èµ„æºï¼ŒåŒ…æ‹¬ç›‘å¬å¥—æ¥å­—; å­è¿›ç¨‹é€šè¿‡ exec åŠ è½½æœ€æ–°çš„äºŒè¿›åˆ¶ç¨‹åºæ‰§è¡Œï¼Œè¿™æ ·å°±å®ç°äº†æ–°è¿›ç¨‹ç»§æ‰¿æ—§è¿›ç¨‹çš„ç›‘å¬å¥—æ¥å­—ã€‚ æ–°è¿›ç¨‹å¯åŠ¨å®Œæˆåï¼Œé€šçŸ¥çˆ¶è¿›ç¨‹é€€å‡ºã€‚ çˆ¶è¿›ç¨‹å—åˆ°ä¿¡å·åï¼Œåœæ­¢æ¥å—æ–°çš„è¿æ¥ï¼Œç­‰å¾…æ‰€æœ‰çš„è¿æ¥å¤„ç†å®Œæ¯•åé€€å‡ºã€‚ åœ¨ Go é‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼å®ç°ï¼š\ntype gracefulTcpServer struct { listener *net.TCPListener shutdownChan chan struct{} conns map[net.Conn]struct{} servingConnCount atomic.Int32 serveRunning atomic.Bool } // æ™®é€šå¯åŠ¨æ–¹å¼ func start(port int) (*gracefulTcpServer, error) { ln, err := net.Listen(\u0026#34;tcp\u0026#34;, fmt.Sprintf(\u0026#34;:%d\u0026#34;, port)) // handle error ignored s := \u0026amp;gracefulTcpServer{ listener: ln.(*net.TCPListener), shutdownChan: make(chan struct{}, 1), conns: make(map[net.Conn]struct{}, 16), servingConnCount: atomic.Int32{}, serveRunning: atomic.Bool{}, } return s, nil } // ä¼˜é›…é‡å¯å¯åŠ¨æ–¹å¼ func startFromFork() (*gracefulTcpServer, error) { // ... ignored code // ä»ç¯å¢ƒå˜é‡ä¸­è·å– çˆ¶è¿›ç¨‹çš„å¤„ç†çš„è¿æ¥æ•°ï¼Œç”¨æ¥æ¢å¤è¿æ¥ if nfdStr := os.Getenv(__GRACE_ENV_NFDS); nfdStr == \u0026#34;\u0026#34; { panic(\u0026#34;not nfds env\u0026#34;) } else if nfd, err = strconv.Atoi(nfdStr); err != nil { panic(err) } // restore conn fds, 0, 1, 2 has been used by os.Stdin, os.Stdout, os.Stderr lfd := os.NewFile(3, filepath.Join(tmpdir, \u0026#34;graceful\u0026#34;)) ln, err := net.FileListener(lfd) // handle error ignored s := \u0026amp;gracefulTcpServer{ listener: ln.(*net.TCPListener), shutdownChan: make(chan struct{}, 1), conns: make(map[net.Conn]struct{}, 16), servingConnCount: atomic.Int32{}, serveRunning: atomic.Bool{}, } // ä»çˆ¶è¿›ç¨‹ç»§æ‰¿çš„å¥—æ¥å­—ä¸­æ¢å¤è¿æ¥ for i := 0; i \u0026lt; nfd; i++ { fd := os.NewFile(uintptr(4+i), filepath.Join(tmpdir, strconv.Itoa(4+i))) conn, err := net.FileConn(fd) // handle error ignored go s.handleConn(conn) } return s, nil } func (s *gracefulTcpServer) gracefulRestart() { _ = s.listener.SetDeadline(time.Now()) lfd, err := s.listener.File() // ç»™å­è¿›ç¨‹è®¾ç½® ä¼˜é›…é‡å¯ ç›¸å…³çš„ç¯å¢ƒå˜é‡ os.Setenv(__GRACE_ENV_FLAG, \u0026#34;true\u0026#34;) os.Setenv(__GRACE_ENV_NFDS, strconv.Itoa(len(s.conns))) // å°†çˆ¶è¿›ç¨‹çš„ç›‘å¬å¥—æ¥å­—ä¼ é€’ç»™å­è¿›ç¨‹ files := make([]uintptr, 4, 3+1+len(s.conns)) copy(files[:4], []uintptr{ os.Stdin.Fd(), os.Stdout.Fd(), os.Stderr.Fd(), lfd.Fd(), }) // å°†çˆ¶è¿›ç¨‹çš„å¥—æ¥å­—ä¼ é€’ç»™å­è¿›ç¨‹ for conn := range s.conns { connFd, _ := conn.(*net.TCPConn).File() files = append(files, connFd.Fd()) } procAttr := \u0026amp;syscall.ProcAttr{ Env: os.Environ(), Files: files, Sys: nil, } // æ‰§è¡Œ fork + exec è°ƒç”¨ childPid, err := syscall.ForkExec(os.Args[0], os.Args, procAttr) } func main() { // ... // æ ¹æ®ç¯å¢ƒå˜é‡åˆ¤æ–­æ˜¯ fork è¿˜æ˜¯æ–°å¯åŠ¨ if v := os.Getenv(__GRACE_ENV_FLAG); v != \u0026#34;\u0026#34; { s, err = startFromFork() } else { s, err = start(*port) } go s.serve() // å¤„ç†ä¿¡å·ï¼Œå¦‚æœæ˜¯ SIGHUP ä¿¡å·ï¼Œåˆ™æ‰§è¡Œ gracefulRestart æ–¹æ³•åå†é€€å‡º s.waitForSignals() } å®Œæ•´ä»£ç å¯ä»¥åœ¨ https://github.com/yeqown/playground/golang/tcp-graceful-restart ä¸­æ‰¾åˆ°ã€‚\nsyscall.ForkExec # é€šè¿‡è¿½è¸ª syscall.ForkExec çš„æºç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒçš„å®ç°ä¸»ä½“æ˜¯ forkAndExecInChild, å®ƒçš„å®ç°å¦‚ä¸‹ï¼š\nfunc forkAndExecInChild(argv0 *byte, argv, envv []*byte, chroot, dir *byte, attr *ProcAttr, sys *SysProcAttr, pipe int) (pid int, err Errno) { // ... some ignored codes fd := make([]int, len(attr.Files)) nextfd = len(attr.Files) for i, ufd := range attr.Files { if nextfd \u0026lt; int(ufd) { nextfd = int(ufd) } fd[i] = int(ufd) } nextfd++ // è°ƒç”¨ fork runtime_BeforeFork() r1, _, err1 = rawSyscall(abi.FuncPCABI0(libc_fork_trampoline), 0, 0, 0) if err1 != 0 { runtime_AfterFork() return 0, err1 } // fork çš„å‡½æ•°åŸå‹: pid_t fork(void); // è°ƒç”¨æˆåŠŸåï¼Œçˆ¶è¿›ç¨‹è¿”å›å­è¿›ç¨‹çš„ pidï¼Œå­è¿›ç¨‹è¿”å› 0ã€‚æ‰€ä»¥è¿™é‡Œé€šè¿‡ r1 çš„å€¼æ¥åˆ¤æ–­æ˜¯çˆ¶è¿›ç¨‹è¿˜æ˜¯å­è¿›ç¨‹ // å¦‚æœæ˜¯çˆ¶è¿›ç¨‹ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œå°±è¿”å›äº†ï¼Œå­è¿›ç¨‹ä¼šç»§ç»­æ‰§è¡Œä¸‹é¢çš„ä»£ç ã€‚ if r1 != 0 { runtime_AfterFork() return int(r1), 0 } // è°ƒç”¨ç³»ç»Ÿè°ƒç”¨æ¥è®¾ç½® å­è¿›ç¨‹ çš„å„ç§å±æ€§ï¼š // ä¼šè¯IDã€è¿›ç¨‹ç»„IDã€ç”¨æˆ·IDã€ç»„IDã€å·¥ä½œç›®å½•ã€æ˜¯å¦å‰å°è¿è¡Œç­‰ç­‰ã€‚ // æ‰¾åˆ° fd[i] \u0026lt; i å¹¶ä¸”æŠŠä»–ä»¬ç§»åˆ° len(fd) ä¹‹åï¼Œè¿™æ ·åœ¨åé¢çš„ dup2 ä¸­å°±ä¸ä¼šè¢« â€œè¸©è¸â€ã€‚ // è¸©è¸ï¼šä¸€ä¸ªå˜é‡æˆ–è€…èµ„æºè¢«æ— æ„ä¸­ï¼ˆé€šå¸¸æ˜¯æ„å¤–åœ°ï¼‰è¦†ç›–æˆ–ä¿®æ”¹çš„æƒ…å†µã€‚ for i = 0; i \u0026lt; len(fd); i++ { if fd[i] \u0026gt;= 0 \u0026amp;\u0026amp; fd[i] \u0026lt; i { if nextfd == pipe { // don\u0026#39;t stomp on pipe nextfd++ } if runtime.GOOS == \u0026#34;openbsd\u0026#34; { _, _, err1 = rawSyscall(dupTrampoline, uintptr(fd[i]), uintptr(nextfd), O_CLOEXEC) } else { _, _, err1 = rawSyscall(dupTrampoline, uintptr(fd[i]), uintptr(nextfd), 0) if err1 != 0 { goto childerror } _, _, err1 = rawSyscall(abi.FuncPCABI0(libc_fcntl_trampoline), uintptr(nextfd), F_SETFD, FD_CLOEXEC) } if err1 != 0 { goto childerror } fd[i] = nextfd nextfd++ } } // è°ƒç”¨ dup2 æ¥å¤åˆ¶çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¹Ÿå°±æ˜¯ gracefulTcpServer.gracefulRestart ä¸­ä¼ é€’ç»™å­è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦ for i = 0; i \u0026lt; len(fd); i++ { // ... some ignored codes // åŸºæœ¬åªæœ‰ 0ï¼Œ1ï¼Œ2 ä¼šè§¦å‘è¿™é‡Œçš„é€»è¾‘ if fd[i] == i { // dup2(i, i) won\u0026#39;t clear close-on-exec flag on Linux, // probably not elsewhere either. _, _, err1 = rawSyscall(abi.FuncPCABI0(libc_fcntl_trampoline), uintptr(fd[i]), F_SETFD, 0) if err1 != 0 { goto childerror } continue } // å…¶ä»–çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç›‘å¬å¥—æ¥å­— + è¿æ¥å¥—æ¥å­—é‡‡ç”¨ dup2 æ¥å¤åˆ¶ // è¿™æ ·çˆ¶è¿›ç¨‹é€€å‡ºåï¼Œå­è¿›ç¨‹è¿˜å¯ä»¥ç»§ç»­ä½¿ç”¨è¿™äº›å¥—æ¥å­— _, _, err1 = rawSyscall(abi.FuncPCABI0(libc_dup2_trampoline), uintptr(fd[i]), uintptr(i), 0) if err1 != 0 { goto childerror } } // ... some ignored codes // è°ƒç”¨ execve ç³»ç»Ÿè°ƒç”¨æ¥æ‰§è¡Œæ–°çš„ç¨‹åº _, _, err1 = rawSyscall(abi.FuncPCABI0(libc_execve_trampoline), uintptr(unsafe.Pointer(argv0)), uintptr(unsafe.Pointer(\u0026amp;argv[0])), uintptr(unsafe.Pointer(\u0026amp;envv[0]))) childerror: // send error code on pipe rawSyscall(abi.FuncPCABI0(libc_write_trampoline), uintptr(pipe), uintptr(unsafe.Pointer(\u0026amp;err1)), unsafe.Sizeof(err1)) for { rawSyscall(abi.FuncPCABI0(libc_exit_trampoline), 253, 0, 0) } } ç•™ä¸ªé—®é¢˜ï¼šè¿™é‡Œä¸ºä»€ä¹ˆè¦å¯¹ fd[i] æ•°ç»„è¿›è¡Œå¤„ç†å‘¢ï¼Ÿè¿™äº›å¤„ç†çš„æ•ˆæœæ˜¯ä»€ä¹ˆï¼Ÿ\nåæ–‡æœ‰ç­”æ¡ˆå“¦\nä¸€äº›ç³»ç»Ÿè°ƒç”¨ # åœ¨æ¢ç©¶ go åº•å±‚ fork + exec çš„å®ç°æ—¶ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸€äº›ç³»ç»Ÿè°ƒç”¨ï¼Œé‚£ä¹ˆæ¯ä¸ªç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°åŸå‹å’Œä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ\nç³»ç»Ÿè°ƒç”¨ å‡½æ•°åŸå‹ è¯´æ˜ fork pid_t fork(void); åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„æ‰€æœ‰èµ„æºï¼ŒåŒ…æ‹¬æ–‡ä»¶æè¿°ç¬¦ã€å†…å­˜ã€ä¿¡å·å¤„ç†ç­‰ç­‰ã€‚ execve int execve(const char *filename, char *const argv[], char *const envp[]); æ‰§è¡Œä¸€ä¸ªæ–°çš„ç¨‹åºï¼Œè¿™ä¸ªç¨‹åºä¼šæ›¿æ¢å½“å‰è¿›ç¨‹çš„å†…å­˜ç©ºé—´ï¼Œä½†æ˜¯ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦ã€ä¿¡å·å¤„ç†ç­‰ç­‰ã€‚å¦‚æœæˆåŠŸè¿™ä¸ªå‡½æ•°ä¸ä¼šè¿”å›ï¼Œå¦åˆ™è¿”å›é”™è¯¯æ ‡å¿— dup int dup(int oldfd); å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦ï¼Œoldfd æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œdup ä¼šæŠŠ oldfd å¤åˆ¶åˆ°å½“å‰è¿›ç¨‹ä¸­ï¼Œè¿”å›æ–°çš„æ–‡ä»¶æè¿°ç¬¦ã€‚ dup2 int dup2(int oldfd, int newfd); å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦ï¼Œoldfd å’Œ newfd éƒ½æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œdup2 ä¼šæŠŠ oldfd å¤åˆ¶åˆ° newfdï¼Œå¦‚æœ newfd å·²ç»æ‰“å¼€ï¼Œé‚£ä¹ˆä¼šå…ˆå…³é—­ newfdã€‚ fcntl int fcntl(int fd, int cmd, ... /* arg */ ); å¯¹æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œå„ç§æ“ä½œï¼Œæ¯”å¦‚è®¾ç½®æ–‡ä»¶æè¿°ç¬¦çš„å±æ€§ã€è·å–æ–‡ä»¶æè¿°ç¬¦çš„å±æ€§ç­‰ç­‰ã€‚ close int close(int fd); å…³é—­æ–‡ä»¶æè¿°ç¬¦ã€‚ tableflip æºç åˆ†æ # cloudflare/tableflip æ˜¯ä¸€ä¸ª Go çš„åº“ï¼Œç”¨æ¥å®ç° tcp é•¿è¿æ¥æœåŠ¡çš„ä¼˜é›…é‡å¯ã€‚å®ƒçš„æºç å¯ä»¥åœ¨ https://github.com/cloudflare/tableflip ä¸­æ‰¾åˆ°ã€‚\nå¦‚ä¸‹æ˜¯ tableflip ä½œä¸ºä¸€ä¸ªåº“çš„ä½¿ç”¨æ–¹å¼ï¼š\nfunc main() { upg, _ := tableflip.New(tableflip.Options{}) defer upg.Stop() go func() { sig := make(chan os.Signal, 1) signal.Notify(sig, syscall.SIGHUP) for range sig { upg.Upgrade() } }() // Listen must be called before Ready ln, _ := upg.Listen(\u0026#34;tcp\u0026#34;, \u0026#34;localhost:8080\u0026#34;) defer ln.Close() // è¿è¡ŒæœåŠ¡ go http.Serve(ln, nil) if err := upg.Ready(); err != nil { panic(err) } \u0026lt;-upg.Exit() } ç»“åˆä¹‹å‰æåˆ°çš„åŸç†ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° tableflip çš„ API è·Ÿæˆ‘ä»¬ä¹‹å‰å®ç°çš„ demo æµç¨‹æ˜¯ç±»ä¼¼çš„ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬åªåˆ†æéƒ¨åˆ†æºç ã€‚\nListen Listen æ˜¯ç”¨äºåˆ›å»ºç›‘å¬å¥—æ¥å­—çš„ï¼Œtableflip é€šè¿‡ä¸€ä¸ª Fds çš„ç»“æ„é›†ä¸­ç®¡ç†äº†å­è¿›ç¨‹ä»çˆ¶è¿›ç¨‹ç»§æ‰¿æ¥çš„æ–‡ä»¶æè¿°ç¬¦ï¼ŒåŒæ—¶ä¹Ÿæ˜¯çˆ¶è¿›ç¨‹å‘å­è¿›ç¨‹å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦çš„æ•°æ®ç»“æ„ï¼š\ntype Upgrader struct { // ... // Upgrader.Listen è°ƒç”¨ä½¿ç”¨çš„åµŒå…¥å­—æ®µ Fds çš„æ–¹æ³• *Fds // ... } // Listen è¿”å›ä»çˆ¶è¿›ç¨‹ç»§æ‰¿æ¥çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¦‚æœæ²¡æœ‰ç»§æ‰¿æ¥çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œé‚£ä¹ˆå°±åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ã€‚ func (f *Fds) Listen(network, addr string) (net.Listener, error) { return f.ListenWithCallback(network, addr, f.newListener) } func (f *Fds) ListenWithCallback(network, addr string, callback func(network, addr string) (net.Listener, error)) (net.Listener, error) { // ä»çˆ¶è¿›ç¨‹ç»§æ‰¿æ¥çš„æ–‡ä»¶æè¿°ç¬¦å°è¯•è·å–ç›‘å¬å¥—æ¥å­— ln, err := f.listenerLocked(network, addr) if err != nil { return nil, err } // å¦‚æœæ‰¾åˆ°é‚£ä¹ˆå°±è¿”å› if ln != nil { return ln, nil } // è°ƒç”¨å›è°ƒå‡½æ•° cllback(f.newListener) æ¥åˆ›å»ºæ–°çš„ç›‘å¬å¥—æ¥å­— // è¿™é‡Œçš„ f.newListener = func(network, addr string) (net.Listener, error) { // f.lc é»˜è®¤æ˜¯ ç©ºçš„ net.ListenConfig, ç­‰ä»·äº net.Listen(network, addr) //\treturn f.lc.Listen(context.Background(), network, addr) // } ln, err = callback(network, addr) if err != nil { return nil, fmt.Errorf(\u0026#34;can\u0026#39;t create new listener: %s\u0026#34;, err) } if _, ok := ln.(Listener); !ok { ln.Close() return nil, fmt.Errorf(\u0026#34;%T doesn\u0026#39;t implement tableflip.Listener\u0026#34;, ln) } // åŠ å…¥åˆ°æ–‡ä»¶æè¿°ç¬¦é›†åˆä¸­ err = f.addListenerLocked(network, addr, ln.(Listener)) if err != nil { ln.Close() return nil, err } return ln, nil } Upgrade Upgrade æ˜¯è§¦å‘ä¼˜é›…é‡å¯çš„å…¥å£ï¼Œä¸»è¦æ˜¯å‘é€ä¸€ä¸ªå‡çº§ä¿¡å·ï¼Œè€Œ upgrade ä¿¡å·çš„å¤„ç†é€»è¾‘åœ¨ upgrader.run ä¸­å¤„ç†çš„ï¼š\nfunc (u *Upgrader) Upgrade() error { // éœ€è¦æ³¨æ„çš„æ˜¯ upgradeC æ˜¯ä¸€ä¸ª chan chan error ç±»å‹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒæ˜¯ä¸€ä¸ª chan çš„ chan response := make(chan error, 1) // è¿™é‡Œäº‹å…ˆæ£€æŸ¥ä¸‹å½“å‰è¿›ç¨‹æ˜¯å¦å¤„äº é€€å‡º/å‡çº§ çŠ¶æ€ select { case \u0026lt;-u.stopC: return errors.New(\u0026#34;terminating\u0026#34;) case \u0026lt;-u.exitC: return errors.New(\u0026#34;already upgraded\u0026#34;) case u.upgradeC \u0026lt;- response: } // é˜»å¡åœ¨è¿™é‡Œï¼Œç­‰å¾…å‡çº§ç»“æœ return \u0026lt;-response } func (u *Upgrader) run() { // ... some ignored codes for { select { case \u0026lt;-parentExited: // ... case \u0026lt;-processReady: // ... case \u0026lt;-u.stopC: u.Fds.closeAndRemoveUsed() return case request := \u0026lt;-u.upgradeC: // ä¸€äº›å¼‚å¸¸æƒ…å†µæ£€æµ‹ // æ‰§è¡Œå‡çº§ file, err := u.doUpgrade() request \u0026lt;- err if err == nil { // å‘Šè¯‰å­è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹å·²ç»é€€å‡º u.exitFd \u0026lt;- neverCloseThisFile{file} u.Fds.closeUsed() return } } } } func (u *Upgrader) doUpgrade() (*os.File, error) { // å¯åŠ¨å­è¿›ç¨‹ // u.env ä¸»è¦æ˜¯å¯¹ startChild éœ€è¦çš„ä¸€äº›è°ƒç”¨çš„æŠ½è±¡é›†åˆï¼Œä¸ºäº†é€‚åº”ä¸åŒçš„å¹³å° // u.Fds.copy() æ˜¯å¤åˆ¶ä¸€ä»½çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œè¿™æ ·å­è¿›ç¨‹å°±å¯ä»¥ç›´æ¥ä½¿ç”¨çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦ child, err := startChild(u.env, u.Fds.copy()) if err != nil { return nil, fmt.Errorf(\u0026#34;can\u0026#39;t start child: %s\u0026#34;, err) } // æ›´å¤šçš„ä¿¡å·å¤„ç†ï¼Œé€€å‡º/å‡çº§ ç­‰ç­‰ } func startChild(env *env, passedFiles map[fileName]*file) (*child, error) { // å¼€å¯ä¸€ä¸ªç®¡é“ï¼Œç”¨æ¥é€šçŸ¥çˆ¶è¿›ç¨‹å­è¿›ç¨‹å·²ç»å‡†å¤‡å¥½äº† // æ‰€ä»¥ readyR æ˜¯çˆ¶è¿›ç¨‹ç”¨æ¥è¯»å–çš„ï¼ŒreadyW æ˜¯å­è¿›ç¨‹ç”¨æ¥å†™å…¥çš„ï¼Œå› æ­¤ readyW ä¹Ÿéœ€è¦ä¼ é€’ç»™å­è¿›ç¨‹ readyR, readyW, err := os.Pipe() if err != nil { return nil, fmt.Errorf(\u0026#34;pipe failed: %s\u0026#34;, err) } // ä¼ é€’æ–‡ä»¶æè¿°ç¬¦çš„åå­— namesR, namesW, err := os.Pipe() if err != nil { readyR.Close() readyW.Close() return nil, fmt.Errorf(\u0026#34;pipe failed: %s\u0026#34;, err) } // fds å’Œ fdNames ä¿è¯ç›¸åŒçš„é¡ºåºè®°å½• passedFiles ä¸­çš„æ–‡ä»¶æè¿°ç¬¦ fds := []*os.File{os.Stdin, os.Stdout, os.Stderr, readyW, namesR} var fdNames [][]string for name, file := range passedFiles { nameSlice := make([]string, len(name)) copy(nameSlice, name[:]) fdNames = append(fdNames, nameSlice) fds = append(fds, file.File) } // ä¼ é€’ç¯å¢ƒå˜é‡ï¼ŒsentinelEnvVar=yes ä¹Ÿå°±æ˜¯å‘Šè¯‰æ–°çš„å­è¿›ç¨‹ï¼Œè¿™æ˜¯ä¸€ä¸ªå‡çº§çš„å­è¿›ç¨‹ // åœ¨ tableflip.New \u0026gt; newUpgrader \u0026gt; newParent çš„å¼€å§‹å¤„å¯ä»¥çœ‹åˆ° // è¿™ä¸ªå˜é‡å†³å®šäº† Upgrader ä¸­çš„ parent å­—æ®µæ˜¯å¦æœ‰å€¼ï¼Œå¦‚æœæœ‰å€¼ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸€ä¸ªä¼˜é›…å‡çº§çš„å­è¿›ç¨‹ sentinel := fmt.Sprintf(\u0026#34;%s=yes\u0026#34;, sentinelEnvVar) var environ []string for _, val := range env.environ() { if val != sentinel { environ = append(environ, val) } } environ = append(environ, sentinel) // å‡†å¤‡å¥½æ–°çš„å­è¿›ç¨‹çš„ command, args æ–‡ä»¶æè¿°ç¬¦ï¼Œç¯å¢ƒå˜é‡åå°±å¯ä»¥å¯åŠ¨å­è¿›ç¨‹äº† // env.newProc æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œç”¨æ¥åˆ›å»ºå­è¿›ç¨‹ // é»˜è®¤ä½¿ç”¨ newOSProcess å…¶ä¸­æ ¸å¿ƒè¿˜æ˜¯è°ƒç”¨ syscall.StartProcess æ¥åˆ›å»ºå­è¿›ç¨‹\t// syscall.StartProcess ä¸ syscall.ForkExec æ˜¯ä¸€æ ·çš„ proc, err := env.newProc(os.Args[0], os.Args[1:], fds, environ) if err != nil { // fork/exec æ‰§è¡Œå¤±è´¥ï¼Œé‚£ä¹ˆé‡Šæ”¾ä¹‹å‰åˆ›å»ºçš„èµ„æº // ... return } // åç»­ï¼Œå­è¿›ç¨‹å¯åŠ¨æˆåŠŸåå°±ä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œäº†ï¼Œå› æ­¤è¿™é‡Œçš„ä»£ç éƒ½æ˜¯åœ¨çˆ¶è¿›ç¨‹ä¸­æ‰§è¡Œçš„ // ä¹Ÿå°±æ˜¯è¯´ï¼Œçˆ¶è¿›ç¨‹ä¼šæƒ³å­è¿›ç¨‹ä¼ é€’ä¸€äº›æ•°æ®ï¼ˆfdNamesï¼‰ç„¶åç­‰å¾…äº†æ¥è‡ªå­è¿›ç¨‹çš„ä¿¡å· exited := make(chan struct{}) result := make(chan error, 1) ready := make(chan *os.File, 1) c := \u0026amp;child{ // ... } go c.writeNames(fdNames) go c.waitExit(result, exited) go c.waitReady(ready) return c, nil } é€šè¿‡è¿™éƒ¨åˆ†ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° tableflip çš„å®ç°æ–¹å¼è·Ÿæˆ‘ä»¬ä¹‹å‰çš„ demo æ˜¯ç±»ä¼¼çš„ï¼Œåªä¸è¿‡å®ƒæŠŠä¸€äº›ç»†èŠ‚å°è£…äº†èµ·æ¥ï¼ŒåŒæ—¶ä¹Ÿæä¾›äº†ä¸€äº›é¢å¤–çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼š\nå‘é€ fdNames ç»™å­è¿›ç¨‹ çˆ¶è¿›ç¨‹ç­‰å¾…å­è¿›ç¨‹çš„ ready ä¿¡å· å­è¿›ç¨‹ç­‰å¾…çˆ¶è¿›ç¨‹çš„ exited ä¿¡å· ç­‰ç­‰ Ready Ready ä½¿ç”¨æ¥é€šçŸ¥çˆ¶è¿›ç¨‹å­è¿›ç¨‹å·²ç»å‡†å¤‡å¥½äº†ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯åœ¨å­è¿›ç¨‹ä¸­è°ƒç”¨çš„ï¼š\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œéœ€è¦åœ¨è¿›ç¨‹çœŸæ­£çš„å¯ä»¥æ¥å—è¯·æ±‚åæ‰è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå¦åˆ™å¯èƒ½ä¼šå‡ºç°çˆ¶è¿›ç¨‹é€€å‡ºåï¼Œæ–°è¿æ¥æ— æ³•å¤„ç†çš„æƒ…å†µã€‚\nfunc (u *Upgrader) Ready() error { u.readyOnce.Do(func() { u.Fds.closeInherited() close(u.readyC) }) // some ignored codes // å¦‚æœæ²¡æœ‰çˆ¶è¿›ç¨‹ï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å›ï¼ˆparent == nil æ„å‘³ç€ä¼˜é›…å‡çº§è¿›ç¨‹æ¥çš„ï¼‰ if u.parent == nil { return nil } // é€šçŸ¥çˆ¶è¿›ç¨‹å­è¿›ç¨‹å·²ç»å‡†å¤‡å¥½äº†, çˆ¶è¿›ç¨‹å¯ä»¥é€€å‡ºäº† // è¿™é‡Œå…¶å®å°±æ˜¯åˆ›å»ºå­è¿›ç¨‹æ—¶å¼€è¾Ÿçš„ ready ç®¡é“çš„ write ç«¯å†™å…¥ç‰¹å®šçš„ä¿¡å·æ•°æ® (notifyReady) return u.parent.sendReady() } tableflip çš„æºç è¿˜æœ‰å¾ˆå¤šç»†èŠ‚ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€åˆ†æäº†ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è‡ªå·±çœ‹çœ‹ï¼Œä½†æˆ‘ä»¬å¯ä»¥å‘ç°åº•å±‚å®ç°çš„æ€è·¯æ˜¯ä¸€æ ·çš„ã€‚è¿™é‡Œç•™ä¸‹ä¸€äº›é—®é¢˜ï¼š\ntableflip åœ¨å¯åŠ¨å­è¿›ç¨‹æ—¶æ‹·è´äº† Fds, ä½†æ˜¯çºµè§‚ä»£ç å¥½åƒæ²¡æœ‰è€ƒè™‘å·²ç»å»ºç«‹çš„è¿æ¥ï¼Œé‚£èƒ½å¦å®ç°è¿æ¥çš„ç»§æ‰¿å‘¢ï¼Ÿ å¦‚æœè¯´è¿›ç¨‹ä¸­æœ‰ä¸€ä¸ªåµŒå…¥å¼æ•°æ®åº“ï¼Œåªå…è®¸å•è¿›ç¨‹è®¿é—®ï¼Œè¿™æ—¶å€™åœ¨ tableflip ä¸­ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µï¼Ÿåº”è¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ syscall çš„ä¸€äº›ç»†èŠ‚ # é€šè¿‡å‰æ–‡çš„è®²è¿°ï¼Œæˆ‘ä»¬äº†è§£åˆ°äº†å®ç°ä¼˜é›…é‡å¯è¿‡ç¨‹ä¸­çš„ä¸€äº›ç»†èŠ‚ï¼Œä½†æ›´æ·±å…¥çš„äº†è§£è¿˜éœ€è¦æˆ‘ä»¬å»çœ‹ä¸€ä¸‹ fork å’Œ exec çš„ä¸€äº›ç»†èŠ‚ã€‚ä¸‹é¢å°±å¯¹ fork å’Œ exec çš„ç®€å•åœ°åˆ†æä¸€ä¸‹ã€‚\nfork(2) # fork(2) Linux manual page\n#include \u0026lt;unistd.h\u0026gt; pid_t fork(void); é€šå¸¸æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹çš„ä»£ç å°±å¯ä»¥å¿«é€Ÿçš„åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼š\n#include\u0026lt;sys/types.h\u0026gt; #include\u0026lt;unistd.h\u0026gt; #include\u0026lt;stdio.h\u0026gt; #include\u0026lt;stdlib.h\u0026gt; int main() { pid_t pid = fork(); // åˆ›å»ºå­è¿›ç¨‹ if (pid \u0026lt; 0) { perror(\u0026#34;fork error\u0026#34;); exit(1); } if (pid != 0) { // çˆ¶è¿›ç¨‹ printf(\u0026#34;this is parent process, PID is %d.\\n\u0026#34;, getpid()); exit(0); } // å­è¿›ç¨‹ printf(\u0026#34;this is child process %d, PID is %d.\\n\u0026#34;, i, getpid()); } æˆ‘ä»¬çŸ¥é“åœ¨ linux å†…æ ¸ä¸­ï¼Œè¿›ç¨‹çš„æ ¸å¿ƒç»“æ„ä½“æ˜¯ task_struct å¦‚ä¸‹ï¼š\n// linux-6.4/include/linux/sched.h#739 struct task_struct { //... /* Filesystem information: */ struct fs_struct\t*fs; /* è®°å½•äº†è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ */ struct files_struct\t*files; //... } struct files_struct { //... // ä¿å­˜äº†è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦, æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„çš„ä¸‹æ ‡å°±æ˜¯æ–‡ä»¶æè¿°ç¬¦ fd struct file __rcu * fd_array[NR_OPEN_DEFAULT]; } åœ¨ fork çš„è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡è°ƒç”¨ copy_process æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œè¿™ä¸ªå‡½æ•°çš„å®ç°å¦‚ä¸‹ï¼š\n// linux-6.4/kernel/fork.c#2246 __latent_entropy struct task_struct *copy_process( struct pid *pid, int trace, int node, struct kernel_clone_args *args) { struct task_struct *p; // æ‹·è´è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ retval = copy_files(clone_flags, p, args-\u0026gt;no_files); } ç°åœ¨æˆ‘ä»¬çŸ¥é“ fork ç¡®å®ä¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦äº†ï¼Œé‚£ä¹ˆåœ¨å­è¿›ç¨‹é‡Œè¯¥æ€ä¹ˆä½¿ç”¨å‘¢ï¼Ÿåº”è¯¥è¿˜è®°å¾—æˆ‘ä»¬æ˜¯æ€ä¹ˆæ¢å¤ç›‘å¬å¥—æ¥å­—çš„å§ï¼š\nlistenFile := os.NewFile(3, \u0026#34;/tmp/graceful\u0026#34;) ln, err := net.FileListener(listenFile) å…¶å®è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çŸ¥é“å¯¹åº”çš„æ˜¯ fd ä¹Ÿå°±æ˜¯ files_struct ä¸­ fd_array çš„æ•°ç»„ä¸‹æ ‡ï¼Œfork ä¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„ files_structï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆæ˜¯3å‘¢ï¼Ÿå…¶å®é€šè¿‡æ–­ç‚¹è°ƒè¯•æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œç›‘å¬å¥—æ¥å­—çš„ fd å¹¶ä¸æ˜¯ 3 è€Œæ˜¯ 10ï¼ˆæˆ‘æœ¬åœ°ï¼‰ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆåœ¨æ–°è¿›ç¨‹é‡Œé¢æ˜¯ 3 å‘¢ï¼Ÿè¿™å°±éœ€è¦å›åˆ° forkAndExecInChild ä¸­å¯¹äº fd æ•°ç»„çš„å¤„ç†äº†ï¼Œä¼šé‡æ–°æ’åˆ— fd çš„é¡ºåºï¼Œå¹¶ä¸”é€šè¿‡ dup2 ç³»ç»Ÿè°ƒç”¨ä½¿å¾— fd[i] = iã€‚\nä¹Ÿå°±æ˜¯è¯´å‡å¦‚æˆ‘ä¼ å…¥çš„ fd æ•°ç»„ä¸ºï¼š[0, 1, 2, 4, 5]ï¼Œåœ¨ç»è¿‡å¤„ç†åè¿›ç¨‹ä¸­çš„ fd_array å°±ä¼šå˜æˆ [0, 1, 2, 3ï¼ˆdup 4ï¼‰, 4(dup 5)]\nexecve(2) # execve(2) Linux manual page\n#include \u0026lt;unistd.h\u0026gt; int execve(const char *pathname, char *const _Nullable argv[], char *const _Nullable envp[]); execve ä¼šæ‰§è¡Œä¸€ä¸ªæ–°çš„ç¨‹åºï¼Œè¿™ä¸ªç¨‹åºä¼šæ›¿æ¢å½“å‰è¿›ç¨‹çš„å†…å­˜ç©ºé—´ï¼Œä½†æ˜¯ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦ã€ä¿¡å·å¤„ç†ç­‰ç­‰ã€‚å¦‚æœæˆåŠŸè¿™ä¸ªå‡½æ•°ä¸ä¼šè¿”å›ï¼Œå¦åˆ™è¿”å›é”™è¯¯æ ‡å¿—ã€‚\nä»£ç å°±ä¸è´´äº†ï½ è·Ÿæœ¬æ–‡çš„è”ç³»åœ¨äºå¯ä»¥å®ç°ä¼˜é›…å‡çº§ï¼šè§¦å‘å‡çº§å‰ï¼Œå…ˆæ›¿æ¢è€çš„äºŒè¿›åˆ¶æ–‡ä»¶åï¼Œå¾…å­è¿›ç¨‹é‡æ–°æ‰§è¡Œæ—¶ï¼Œå°±å®ç°å‡çº§äº†ã€‚\nå°ç»“ # tcp é•¿è¿æ¥æœåŠ¡çš„ä¼˜é›…é‡å¯ï¼Œå…¶å®å°±æ˜¯é€šè¿‡ fork + exec çš„æ–¹å¼æ¥å®ç°çš„ã€‚åœ¨å¯åŠ¨å­è¿›ç¨‹æ—¶ï¼Œå¯ä»¥å¤åˆ¶çˆ¶è¿›ç¨‹çš„ç›¸å…³å¥—æ¥å­—ï¼Œé€šè¿‡ä¸€äº›æ‰‹æ®µåœ¨å­è¿›ç¨‹ä¸­æ¢å¤è¿™äº›å¥—æ¥å­—ï¼Œè¿™æ ·å­è¿›ç¨‹å°±å¯ä»¥ç»§ç»­ä½¿ç”¨çˆ¶è¿›ç¨‹çš„å¥—æ¥å­—ï¼Œä»è€Œå®ç°äº†å®¢æˆ·ç«¯æ— æ„ŸçŸ¥çš„ä¼˜é›…é‡å¯ã€‚\nå‚è€ƒæ–‡çŒ® # Graceful upgrades in Go "},{"id":19,"href":"/2023/08/15/cloudflare-tunnel-%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0/","title":"Cloudflare Tunnel ä½¿ç”¨ç¬”è®°","section":"Posts","content":"Cloudflare è‡ªä¸ç”¨å¤šè¯´ï¼ŒTunnel æ˜¯ Cloudflare æä¾›çš„ä¸€é¡¹åŠŸèƒ½ï¼Œå¯ä»¥å°†æœ¬åœ°çš„æœåŠ¡é€šè¿‡ Cloudflare çš„ç½‘ç»œæš´éœ²åˆ°å…¬ç½‘ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°å†…ç½‘ç©¿é€ï¼ŒåŒæ—¶è¿˜å¯ä»¥é€šè¿‡ Cloudflare çš„ç½‘ç»œåŠ é€ŸæœåŠ¡ï¼Œæé«˜è®¿é—®é€Ÿåº¦ã€‚\nåˆè¯† Cloudflare Tunnel # æœ€å¼€å§‹æ¥è§¦ Cloudflare Tunnel æ˜¯åœ¨ Twitter ä¸Šçœ‹åˆ°ä¸€ä¸ªé¡¹ç›®cloudflare-tunnel-ingress-controller ï¼Œè¿™ä¸ªé¡¹ç›®æ˜¯ä¸€ä¸ª Kubernetes çš„ Ingress Controllerï¼Œå¯ä»¥å°† Kubernetes ä¸­çš„æœåŠ¡é€šè¿‡ Cloudflare Tunnel æš´éœ²åˆ°å…¬ç½‘ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°å†…ç½‘ç©¿é€ï¼Œä¹Ÿå°±æ˜¯è¯´å±€åŸŸç½‘æ­å»ºçš„æœåŠ¡å¯ä»¥é€šè¿‡ Cloudflare çš„ç½‘ç»œæš´éœ²åˆ°å…¬ç½‘ã€‚\nç†Ÿæ‚‰å†…ç½‘ç©¿é€çš„å°ä¼™ä¼´ï¼Œåº”è¯¥å¯¹è¿™ä¸­ä¸œè¥¿å¾ˆç†Ÿæ‚‰ï¼Œä¹Ÿæ²¡ä»€ä¹ˆå¥½è¯´çš„ã€‚\nå‰æ # ä¸€ä¸ª Cloudflare è´¦å· ä¸€ä¸ªåŸŸå cloudfalred # Mac ä¸Šå¯ä»¥é€šè¿‡ brew install cloudflared å®‰è£…ï¼Œå®‰è£…å®Œæˆåï¼Œå¯ä»¥é€šè¿‡ cloudflared -v æŸ¥çœ‹ç‰ˆæœ¬ã€‚\n$ cloudflared -v cloudflared version 2023.7.3 (built 2023-07-25T20:51:49Z) å‚è€ƒ cloudflared å®˜æ–¹æ–‡æ¡£ å®‰è£…ã€‚\n$ cloudflared login ä½¿ç”¨ # æˆ‘çš„ä½¿ç”¨åœºæ™¯é™¤äº†æœ€å¼€å§‹æåˆ°çš„ Kubernetes Ingress Controller ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå°±æ˜¯å°†å±€åŸŸç½‘å†…çš„å¼€å‘æœºé€šè¿‡ Cloudflare Tunnel æš´éœ²åˆ°å…¬ç½‘ï¼Œæ–¹ä¾¿è¿œç¨‹å¼€å‘ã€‚\nåˆ›å»º Tunnel åœ¨ Cloudflare æ“ä½œé¢æ¿ä¸­ï¼Œé€‰æ‹© Zero Trust (Dashboard) \u0026gt; Access \u0026gt; Tunnels å°±å¯ä»¥å¼€å§‹åˆ›å»º tunnelã€‚æ ¹æ®æµç¨‹ä¸€æ­¥æ­¥æ‰§è¡Œå³å¯ã€‚\nåˆ›å»ºæœŸé—´ä¼šè®©ä½ åœ¨æœ¬åœ°å¼€å¯ä¸€ä¸ª cloudflared æœåŠ¡\nsudo cloudflared service install tunnel-run-token è¿œç¨‹ç™»å½• åˆ›å»ºå®Œ tunnel åï¼Œè¿™æ—¶å€™æˆ‘ä»¬åªæœ‰ä¸€ä¸ªå…¬ç½‘çš„åœ°å€, å¦‚ ssh.example.com`` è¿™æ—¶å€™ç›´æ¥ä½¿ç”¨ ssh username@ssh.example.com` æ˜¯æ— æ³•ç™»å½•çš„ã€‚éœ€è¦ä½¿ç”¨ cloudflared ä½œä¸º ssh çš„ä»£ç†ã€‚\nssh -o \u0026#34;ProxyCommand cloudflared access ssh --hostname %h\u0026#34; username@ssh.example.com è¿™æ ·å°±å¯ä»¥ç™»å½•åˆ°è¿œç¨‹çš„æœºå™¨äº†ã€‚\næ–‡ä»¶ä¼ è¾“ å…‰æ˜¯èƒ½å¤Ÿç™»å½•ä¸Šæœºå™¨è¿˜ä¸æ»¡è¶³æ—¥å¸¸çš„è¿œç¨‹å¼€å‘å·¥ä½œï¼Œå¾€å¾€æˆ‘ä»¬è¿˜éœ€è¦åœ¨æœ¬åœ°å’Œè¿œç¨‹æœºå™¨ä¹‹é—´ä¼ è¾“æ–‡ä»¶ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ scp å‘½ä»¤ï¼Œä½†ä¹Ÿä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œéœ€è¦ä½¿ç”¨ cloudflared ä½œä¸ºä»£ç†ã€‚åŒæ ·çš„ï¼Œ\n# ä¸‹è½½æ–‡ä»¶ scp -o \u0026#34;ProxyCommand cloudflared access ssh --hostname %h\u0026#34; username@ssh.example.com:/path/to/file . å°ç»“ # cloudflared çš„åŠŸèƒ½è¿œä¸æ­¢æ­¤ï¼Œè¿™é‡Œä»…ä»…æ¶‰åŠåˆ° ssh çš„éƒ¨åˆ†ï¼Œåé¢å†æœ‰æ›´å¤šåœºæ™¯å†è¡¥å……ã€‚\n"},{"id":20,"href":"/2022/07/25/%E5%9C%A8parent-shell%E4%B8%AD%E6%89%A7%E8%A1%8C%E5%86%85%E7%BD%AE%E5%91%BD%E4%BB%A4%E7%9A%84%E6%96%B9%E6%B3%95/","title":"åœ¨Parent Shellä¸­æ‰§è¡Œå†…ç½®å‘½ä»¤çš„æ–¹æ³•","section":"Posts","content":" èƒŒæ™¯ # æœ€è¿‘åœ¨ä¸º å¤§ä»“é¡¹ç›®(Monorepo) åˆ¶ä½œä¸€ä¸ªè„šæ‰‹æ¶ï¼Œå…¶ä¸­æ„æ€äº†ä¸€ä¸ªè‡ªåŠ¨æ›¿ç”¨æˆ·åˆ‡æ¢å·¥ä½œè·¯å¾„çš„å·¥å…·ï¼ˆä»£ç æ˜¯é€šè¿‡æ¨¡æ¿åˆå§‹åŒ–çš„ï¼Œåœ¨ç»“æ„ä¸ŠåŸºæœ¬ä¸€è‡´ï¼Œä½†æ˜¯ä»£ç æ–‡ä»¶è¾ƒæ·±ï¼Œæƒ³è¦åœ¨terminalå»å’Œæ–‡ä»¶äº¤äº’æ—¶ï¼Œåªèƒ½ä½¿ç”¨ cd å‘½ä»¤ï¼Œè´¹æ—¶è´¹åŠ›ï¼‰ï¼Œå› æ­¤æˆ‘æœŸæœ›ä¸€ä¸ªå°å·¥å…·ï¼Œèƒ½æ¯”è¾ƒæ–¹ä¾¿çš„å¸®æˆ‘è·³è½¬åˆ°ç›®æ ‡è·¯å¾„ã€‚é¢„æœŸçš„ä½¿ç”¨æ•ˆæœå¦‚ä¸‹ï¼š\nè¿™ä¸ªå‘½ä»¤æ‰§è¡Œåï¼Œä½ å¯ä»¥ä»å½“å‰è·¯å¾„ï¼ˆä»»æ„è·¯å¾„ï¼‰è·³è½¬åˆ°ç›®æ ‡è·¯å¾„ï¼Œé‚£æˆ‘å°±ä¸ç”¨è®°æˆ‘åº”è¯¥å…ˆè·³è½¬åˆ°æ ¹ç›®å½•å†å‰å¾€ç›®æ ‡ç›®å½•äº†ï¼Œå°‘æ•²å‡»å¾ˆå¤šæ¬¡ tabã€‚\nPS: åç»­è®¡åˆ’ç»™è¿™ä¸ªå‘½ä»¤æ‰©å±•ä¸€ä¸‹å†å²è®°å½•ï¼Œå¯ä»¥é€šè¿‡ç­›é€‰åŒ¹é…å†å²å¿«é€Ÿè¡¥å…¨å‘½ä»¤ï¼Œæé«˜æ•ˆç‡ã€‚\nchdiræ²¡ä½œç”¨ï¼Ÿ # è¿™ä¸ªå°å·¥å…·æ˜¯é€šè¿‡Goæ¥ç¼–å†™çš„ï¼Œæˆ‘ä»æ–‡æ¡£ä¸­çœ‹åˆ° os.Chdir è¿™ä¸ªè°ƒç”¨, å› æ­¤ç”¨å®ƒæ¥è¯•è¯•ï¼š\n// Chdir changes the current working directory to the named directory. // If there is an error, it will be of type *PathError. func Chdir(dir string) error ç»“æœæˆ‘å‘ç°æ²¡æœ‰æ•ˆæœï¼Œé€šè¿‡ os.Getwd() å´èƒ½çœ‹åˆ°å½“å‰è·¯å¾„å·²ç»è¢«æ”¹å˜äº†ã€‚è¿™ä¸ªåˆ‡æ¢çš„éœ€æ±‚è¿˜æ²¡è§£å†³ï¼Œæˆ‘å´äº§ç”Ÿäº†å‡ ä¸ªæ–°çš„ç–‘é—®ï¼š\ncd å‘½ä»¤æ€ä¹ˆå®ç°çš„ï¼Ÿ chdir ç³»ç»Ÿè°ƒç”¨çš„ä½¿ç”¨å’ŒåŸç†ï¼Ÿ é€šè¿‡æ‰§è¡Œå¦‚ä¸‹çš„å‘½ä»¤ï¼Œä¼šå‘ç° cd å‘½ä»¤å¹¶ä¸æ˜¯é€šè¿‡ä¸€ä¸ªç‹¬ç«‹çš„å¯æ‰§è¡Œæ–‡ä»¶æ¥å®ç°çš„ï¼Œè€Œæ˜¯å†…ç½®åœ¨ bash ç­‰ shell ç¨‹åºä¸­ï¼Œå…¶æ¬¡é€šè¿‡æŸ¥é˜…èµ„æ–™å¯ä»¥å‘ç° å¤§éƒ¨åˆ†Linuxå‘è¡Œç‰ˆéƒ½éƒ¨åˆ†ç¬¦åˆ POSIX æ ‡å‡†ã€‚å¦‚æœå†æ£€ç´¢ä¸€ä¸‹shellç¨‹åºçš„åŸç†ï¼Œæˆ‘ä»¬ä¼šå¾—å‡ºå¦‚ä¸‹çš„ç»“è®ºï¼š\n$ which cd cd: shell built-in command shell ç¨‹åºåœ¨æ‰§è¡Œå†…å»ºå‘½ä»¤æ—¶ï¼Œæ˜¯é€šè¿‡è°ƒç”¨å†…éƒ¨çš„å‡½æ•°çš„æ‰§è¡Œã€‚è€Œéå†…å»ºçš„å‘½ä»¤ï¼ˆå¦‚ git / gcc / gdbï¼‰éƒ½æ˜¯é€šè¿‡ fork ä¸€ä¸ªè¿›ç¨‹æ¥æ‰§è¡Œï¼›cd å‘½ä»¤æ˜¯é€šè¿‡ chdir [IEEE Std 1003.1-1988] ç³»ç»Ÿè°ƒç”¨å®ç°çš„ï¼›chdir åœ¨ \u0026lt;uinstd.h\u0026gt; å¤´æ–‡ä»¶ä¸­å®šä¹‰ï¼›\nè¯´äººè¯ï¼šåœ¨å¦ä¸€ä¸ªè¿›ç¨‹é‡Œæ‰§è¡Œ chdir ç³»ç»Ÿè°ƒç”¨ï¼Œåªä¼šå½±å“å½“å‰è¿›ç¨‹è€Œä¸æ˜¯å½±å“å…¶ä»–çš„è¿›ç¨‹ï¼ˆåŒ…æ‹¬çˆ¶è¿›ç¨‹ï¼‰ã€‚\nPOSIX: is a family of standards specified by the IEEE Computer Society for maintaining compatibility between operating systems.POSIX defines both the system- and user-level application programming interfaces (API), along with command line shells and utility interfaces, for software compatibility (portability) with variants of Unix and other operating systems.\nè§£å†³æ–¹æ¡ˆ # é‚£ä¹ˆèµ°ç¼–ç¨‹è¯­è¨€æä¾›çš„ç³»ç»Ÿè°ƒç”¨è¿™æ¡è·¯å·²ç»ä¸è¡Œäº†ï¼Œé‚£ä¹ˆåº”è¯¥å’‹åŠå‘¢ï¼Ÿåœ¨stackoverflow ä¸Šæœç´¢è‰¯ä¹…ï¼Œæ”¶é›†åˆ°å¦‚ä¸‹çš„æ–¹æ³•ï¼š\ngdb attach åˆ°è¿›ç¨‹ä¸Šï¼Œå†æ‰§è¡Œ chdir ç³»ç»Ÿè°ƒç”¨ é€šè¿‡ bash è„šæœ¬æ‰§è¡Œ source å‘½ä»¤ æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ ioctl å’Œ terminal-session çš„ tty æ–‡ä»¶äº¤äº’ é€šè¿‡ alias æ¥å®ç°: pcd=cd $(program command)) å…¶ä¸­å„ç§æ–¹æ³•å°è¯•çš„è¿‡ç¨‹å°±ç•¥å»ä¸è¯´ï¼Œæœ€ç»ˆé‡‡ç”¨äº†ç¬¬ä¸‰ç§éå¸¸å¥½ç”¨ï¼Œä¸‹é¢æä¾›ä¸€ä¸ªå° demo ä»¥ä¾›ä½¿ç”¨ï¼š\n#include \u0026lt;unistd.h\u0026gt; #include \u0026lt;sys/ioctl.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;fcntl.h\u0026gt; int injectCmd(int fd, char* cmd) { int i = 0; while (cmd[i] != \u0026#39;\\0\u0026#39;) { int ret = ioctl(fd, TIOSTI, \u0026amp;cmd[i++]) if (ret != 0) return ret; } return 0; } /* getty help get terminal session tty filename, you can open the fie * and get the file descriptor to call injectCmd. */ char* getty() { const int STDOUT = 1; return ttyname(STDOUT); } void main() { char * ttyfile = getty(); int fd = open(ttyfile, \u0026#34;w\u0026#34;); if (fd == -1) { perror(\u0026#34;open ttyfile failed\u0026#34;); return -1; } injectCmd(fd, \u0026#34;echo \u0026#39;hello world\u0026#39;\u0026#34;); } åœ¨ go é‡Œå¯ä»¥ç›´æ¥ä½¿ç”¨ syscall åŒ…æˆ–è€… cgo æ¥æ‰§è¡Œï¼ŒåŸç†æ˜¯æ˜¯ä¸€è‡´çš„ï¼Œä¸è¿‡å¤šèµ˜è¿°ã€‚\nå‚è€ƒæ–‡çŒ® # https://pubs.opengroup.org/onlinepubs/009696799/basedefs/unistd.h.html https://stackoverflow.com/questions/2375003/how-do-i-set-the-working-directory-of-the-parent-process/65406229#65406229 https://en.wikipedia.org/wiki/Process_isolation "},{"id":21,"href":"/2022/01/27/%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%B3%BB%E7%BB%9F/","title":"è®¾è®¡ä¸€ä¸ªåˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ","section":"Posts","content":" éœ€æ±‚å’ŒèƒŒæ™¯åˆ†æ # ä¸€æåˆ°å®šæ—¶ä»»åŠ¡çš„ä½¿ç”¨åœºæ™¯ï¼Œæˆ‘ä»¬è‚¯å®šèƒ½æƒ³åˆ°å¾ˆå¤šåœºæ™¯ï¼Œæ¯”å¦‚ï¼š\næ¯å¤©æ™šä¸Š12ç‚¹æ‰§è¡Œä¸€æ¬¡æ¸…ç†æ•°æ®çš„ä»»åŠ¡ æ¯å¤©å‡Œæ™¨1ç‚¹ç»™ç¬¦åˆæ¡ä»¶çš„ç”¨æˆ·å‘é€æ¨å¹¿é‚®ä»¶ æ¯ä¸ªæœˆ10å·ç»“ç®—å·¥èµ„ æ¯éš”5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æœåŠ¡å™¨çš„çŠ¶æ€ æ¯å¤©æ ¹æ®ç”¨æˆ·çš„é…ç½®ï¼Œç»™ç”¨æˆ·å‘é€ç«™å†…æ¶ˆæ¯æé†’ \u0026hellip; ä»å¸¸è§çš„åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æç‚¼å‡ºä¸€äº›å®šæ—¶ä»»åŠ¡çš„ç‰¹ç‚¹ï¼š\nåºå· ç‰¹ç‚¹ è¯´æ˜ 1 å®šæ—¶ æ‰§è¡Œæ—¶é—´æœ‰è§„åˆ™ 2 å¯é  å¯ä»¥å»¶è¿Ÿæ‰§è¡Œï¼Œä½†ä¸èƒ½ä¸æ‰§è¡Œï¼›å¯ä»¥ä¸æ‰§è¡Œï¼Œä½†æ˜¯ä¸èƒ½å¤šæ‰§è¡Œ 3 å¹¶å‘ï¼ˆå¯èƒ½ï¼‰ æŸäº›åœºæ™¯ä¸‹ï¼Œå¯ä»¥è¿è¡Œå¤šä¸ª cron è¿›ç¨‹æ¥æé«˜æ‰§è¡Œæ•ˆç‡ 4 å¯æ‰§è¡Œ è¿™ä¸ªæœ‰ç‚¹åºŸè¯äº†ï¼Œä½†æ˜¯è¿™ä¸ªå…³ç³»åˆ° cronjob çš„è®¾è®¡ï¼Œå› æ­¤åœ¨è¿™é‡Œè¿˜æ˜¯æå‡ºæ¥ ä½†æ˜¯ä½œä¸ºä¸€ä¸ªç³»ç»Ÿæ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦æ›´å¤šçš„åŠŸèƒ½æ¥æå‡ç”¨æˆ·ä½“éªŒï¼Œä¿è¯å¹³å°çš„å¯é å’Œç¨³å®šã€‚æˆ‘ä»¬è®¾æƒ³ä¸‹ä»¥ä¸‹çš„åœºæ™¯ï¼š\nå®šæ—¶ä»»åŠ¡å·²ç»è§¦å‘äº†ï¼Œä½†æ˜¯æœ‰æ²¡æœ‰æ‰§è¡Œï¼Œæ‰§è¡Œç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ å¦‚æœä¸€ä¸ªå®šæ—¶ä»»åŠ¡é•¿æ—¶é—´è¿è¡Œï¼Œé‚£ä¹ˆå®ƒæ­£å¸¸å—ï¼Ÿ ä¸€ä¸ªå®šæ—¶ä»»åŠ¡è¿˜åœ¨è¿è¡Œï¼Œä½†æ˜¯ä¸‹ä¸€ä¸ªè§¦å‘æ—¶æœºåˆåˆ°æ¥äº†ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ å¦‚æœæœåŠ¡å™¨èµ„æºå·²ç»å¤„äºé«˜ä½ï¼Œé‚£ä¹ˆè¦è¢«è§¦å‘çš„ä»»åŠ¡è¿˜è§¦å‘å—ï¼Ÿ \u0026hellip; æœ€åï¼ŒåŸºæœ¬çš„è®¿é—®æ§åˆ¶ï¼Œæƒé™åˆ†é…å’ŒAPIè®¾è®¡ï¼Œè¿™äº›éƒ½æ˜¯ç³»ç»ŸåŠŸèƒ½çš„ä¸€éƒ¨åˆ†ï¼Œä½†ä¸ä½œä¸ºæœ¬æ–‡çš„é‡ç‚¹è€ƒè™‘å¯¹è±¡ã€‚\nä¸€äº›æ¦‚å¿µ # åˆ°è¿™é‡Œæˆ‘ä»¬å¯ä»¥æå–ä¸€äº›æ¦‚å¿µï¼Œæ¥å¸®åŠ©æˆ‘ä»¬è®¾è®¡ä¸€ä¸ªç³»ç»Ÿï¼š\nåºå· åè¯ è§£é‡Š 1 CronJob å®šæ—¶ä»»åŠ¡å®ä¾‹ï¼Œæè¿°å®šæ—¶ä»»åŠ¡èµ„æºçš„ä¸€ä¸ªå®ä½“ 2 Job æ‰§è¡Œä¸­çš„å®šæ—¶ä»»åŠ¡ 3 Scheduler è°ƒåº¦å™¨ï¼Œè´Ÿè´£è§¦å‘ CronJob æ‰§è¡Œå’Œç›‘æ§ Job çš„æ‰§è¡ŒçŠ¶æ€ï¼›æˆ–è®¸è¿˜ä¼šå­˜å‚¨ä¸€äº› CronJob çš„çŠ¶æ€ 4 JobRuntime job è¿è¡Œæ—¶ï¼Œå‡†å¤‡ Job è¿è¡Œæ—¶éœ€è¦çš„èµ„æº; å¯ä»¥å‚è€ƒ k8s CRI è¿™é‡Œ JobRuntime æ˜¯æŠ½è±¡åŒ–çš„æ¦‚å¿µï¼Œå› ä¸º Job å¯ä»¥æ˜¯k8sä¸Šçš„PODï¼Œä¹Ÿå¯ä»¥æ˜¯ç‰©ç†æœºçš„è¿›ç¨‹ï¼Œè¿˜å¯ä»¥æ˜¯ä¸€ä¸ªè¿›ç¨‹ä¸­çš„coroutineã€‚\nè¿™å‡ ä¸ªæ¦‚å¿µçš„å…³è”å…³ç³»å¦‚å›¾ï¼š\næ€»ç»“: æŠŠå®šæ—¶ä»»åŠ¡å¹³å°åˆ†ä¸ºäº†è¿è¡Œå‰å’Œè¿è¡Œä¸­ä¸¤ä¸ªé˜¶æ®µï¼Œé€šè¿‡è°ƒåº¦å™¨å±…ä¸­åè°ƒï¼Œè¾¾åˆ°ä¸¤ä¸ªç›®çš„ï¼š\nScheduler ä¸è´Ÿè´£ CronJob çš„è¿è¡Œï¼Œå‡è½» Scheduler çš„èŒè´£ã€‚ JobRuntime æŠ½è±¡åŒ–å¹¶ç‹¬ç«‹è®¾è®¡ï¼Œæ–¹ä¾¿æ‰©å±•ã€‚ å…³é”®ç‚¹ # å†æ€»ç»“ä¸€ä¸‹è®¾è®¡è¿‡ç¨‹ä¸­çš„å…³é”®ç‚¹ï¼Œå¦‚ä¸‹å›¾ã€‚\nå¯ä»¥å…ˆå¿½ç•¥åˆ†å¸ƒå¼ç›¸å…³çš„è¦ç‚¹ï¼ˆlarge scale, reliableï¼‰ï¼Œå…ˆé‡ç‚¹çœ‹ä¸‹åŠŸèƒ½æ€§çš„è¦ç‚¹ã€‚\nCronJob Trackã€Œå®šæ—¶ä»»åŠ¡è·Ÿè¸ªã€\næ„ŸçŸ¥ CronJob çš„çŠ¶æ€ï¼Œå¹¶è®°å½•çŠ¶æ€å˜åŒ–çš„å†å²è®°å½•ï¼Œç”¨äºè¾…åŠ© scheduler å®ç°ä¸€äº›ç­–ç•¥è°ƒåº¦ã€‚åŒæ—¶ä¹Ÿèƒ½æä¾›ä¸€äº› CronJob çš„è¿è¡Œæ•°æ®ï¼Œå¸®åŠ©ç”¨æˆ·è°ƒè¯•å’Œäº†è§£ CronJob çš„å¥åº·çŠ¶å†µã€‚\nIdempotentã€Œå¹‚ç­‰ä¿è¯ã€\næŸäº›å®šæ—¶ä»»åŠ¡å¯¹æ‰§è¡Œæ¬¡æ•°æ˜¯æœ‰è¦æ±‚çš„ï¼Œä½œä¸ºæä¾›æœåŠ¡çš„å¹³å°æ¥è¯´ï¼Œéœ€è¦å°½æœ€å¤§åŠªåŠ›ä¿è¯ä»»åŠ¡æ‰§è¡Œã€‚å› æ­¤æå‡ºä¸€äº› â€œå¹‚ç­‰çº§åˆ«â€ ä¾›ä¸åŒçš„å®šæ—¶ä»»åŠ¡ä½¿ç”¨ã€‚\nåªæ‰§è¡Œä¸€æ¬¡ã€‚ä¸€ä¸ª \u0026ldquo;CronJob\u0026rdquo; ä¸€å®šä¼šè§¦å‘ä¸€æ¬¡ï¼Œä½†æ˜¯è¿™ä¸ªæ¯”è¾ƒéš¾ä¿è¯ã€‚ æœ€å¤šä¸€æ¬¡ã€‚å¯ä»¥ä¸è§¦å‘ï¼Œä½†æ˜¯ä¸èƒ½è§¦å‘å¤šæ¬¡ã€‚ å¯ä»¥é‡å¤æ‰§è¡Œã€‚å¯ä»¥è§¦å‘å¤šæ¬¡ã€‚ Realtimeã€Œå®æ—¶æ€§ã€\nCronJob å¯¹äºæ‰§è¡Œçš„æ—¶æœºä¹Ÿæœ‰è¦æ±‚ï¼Œå¦‚æœ CronJob è¦æ±‚1åˆ†é’Ÿå†…æ‰§è¡Œå®Œæ¯•ï¼Œå¦‚æœ1åˆ†é’Ÿåå†è¿è¡Œä¼šå¯¼è‡´æ—¶æ•ˆæ€§çš„é—®é¢˜ï¼Œé‚£ä¹ˆå¹³å°ä¹Ÿåº”è¯¥è€ƒè™‘ç›¸å…³çš„è®¾è®¡ã€‚\nFault Toleranceã€Œå®¹é”™è®¾è®¡ã€\nCronJob å¯èƒ½ä¼šå› ä¸ºä¸€äº›å¤–éƒ¨å› ç´  â€œæ‰§è¡Œå¤±è´¥â€ æˆ–è€… â€œè¶…æ—¶â€ï¼Œè¿™æ—¶å€™éœ€è¦æä¾›ä¸€äº›å®¹é”™æœºåˆ¶ï¼Œæ¯”å¦‚ï¼šå¤±è´¥é‡è¯•ï¼Œè¶…æ—¶å…³é—­ã€‚\nCocurrencyã€Œå¹¶å‘æ§åˆ¶ã€\nå¥½æ¯”äºï¼Œk8s ä¸­ Deployment ä½œä¸ºä¸€ä¸ªæ— çŠ¶æ€æœåŠ¡ï¼Œå¯ä»¥è¿è¡Œå¤šä¸ªå‰¯æœ¬ä»¥æé«˜æ•ˆç‡ï¼›ä½†æ˜¯ç›¸å¯¹çš„ï¼ŒStatefule Set ä½œä¸ºæœ‰çŠ¶æ€çš„åº”ç”¨ï¼ŒPODä¸èƒ½éšæ„çš„æ‰©å®¹ï¼Œæ‰€ä»¥éœ€è¦æä¾›ä¸€äº›å¹¶å‘æ§åˆ¶æœºåˆ¶ï¼Œä¸¥æ ¼çš„é™åˆ¶ CronJob çš„å¹¶å‘æ•°é‡ã€‚\nPre-Allocatedã€Œé¢„åˆ†é…ã€\nåŒæ ·çš„ï¼ŒæŸäº› CronJob çš„ä¼˜å…ˆçº§æ¯”è¾ƒé«˜ï¼Œè¦ä¿è¯è¿™äº›ä»»åŠ¡ä¸€ç›´ç¨³å®šè¿è¡Œã€‚é‚£ä¹ˆéœ€è¦æä¾›ä¸€äº›é¢„åˆ†é…æœºåˆ¶ï¼Œå¯ä»¥é¿å…å†ç³»ç»Ÿèµ„æºå¤„äºé«˜ä½çš„æ—¶å€™ï¼Œè¿™äº› CronJob è¿˜èƒ½ç»§ç»­è¢«è°ƒåº¦è¿è¡Œã€‚\næ€»ç»“ï¼š è¿™äº›è¦ç‚¹ä½“ç°åœ¨è®¾è®¡ä¸Šå°±æ˜¯ï¼ŒSchuduler å¯¹ CronJob çš„è°ƒåº¦æ§åˆ¶ï¼Œæ¥è‡ªäº CronJob çš„é…ç½®å’Œè¿è¡ŒçŠ¶æ€ã€‚CronJob Configuration åŒ…å«ä¸€äº›è¾…åŠ©è°ƒåº¦æ§åˆ¶çš„é…ç½®ï¼Œå¦‚ï¼š\n{ // ... \u0026#34;concurrency\u0026#34;: 1, // 1 è¡¨ç¤ºè¿™ä¸ª CronJob åªèƒ½æœ‰ä¸€ä¸ªè¿è¡Œä¸­çš„ Job å®ä¾‹ã€‚ \u0026#34;preAllocated\u0026#34;: true, // true è¡¨ç¤ºè¿™ä¸ª CronJob å¯ä»¥è¢«é¢„åˆ†é…ï¼Œè¿™æ ·å¯ä»¥é¿å…ç³»ç»Ÿèµ„æºè¢«å æ»¡ï¼Œå¯¼è‡´è¿™ä¸ª CronJob æ— æ³•è°ƒåº¦ã€‚ \u0026#34;idempotent\u0026#34;: \u0026#34;onceMost\u0026#34;, // [onceOnly, onceMost, unlimit] \u0026#34;faultTolerance\u0026#34;: { \u0026#34;maxStartupRetries\u0026#34;: 3, // æœ€å¤§å¯åŠ¨å¤±è´¥é‡è¯•æ¬¡æ•° \u0026#34;maxFailureRetries\u0026#34;: 3, // æœ€å¤§æ‰§è¡Œå¤±è´¥é‡è¯•æ¬¡æ•° \u0026#34;maxFailureRetriesSeconds\u0026#34;: \u0026#34;60s\u0026#34;, // æœ€å¤§æ‰§è¡Œå¤±è´¥é‡è¯•é—´éš” \u0026#34;activeDeadlineSeconds\u0026#34;: \u0026#34;120s\u0026#34;, // æœ€å¤§æ‰§è¡Œæ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´å°±ä¼šè¢«è®¤ä¸ºæ˜¯å¤±è´¥ }, // å®¹é”™é…ç½® // ... \u0026#34;resourceLimit\u0026#34;: { \u0026#34;cpu\u0026#34;: \u0026#34;0.1\u0026#34;, // CPU é™åˆ¶ \u0026#34;memory\u0026#34;: \u0026#34;128Mi\u0026#34;, // å†…å­˜é™åˆ¶ }, // èµ„æºé™åˆ¶ } å‘åˆ†å¸ƒå¼æ¼”è¿› # åˆ°ç›®å‰ä¸ºæ­¢ï¼Œè¿™ä¸ªå®šæ—¶ä»»åŠ¡ç³»ç»Ÿçš„åŠŸèƒ½å·²ç»å·®ä¸å¤šäº†ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯æ„å‘³ç€è¿™æ ·çš„è®¾è®¡å·²ç»æ»¡è¶³éœ€æ±‚äº†ï¼Ÿå½“ç„¶æ²¡æœ‰ï¼Œæ¯”å¦‚ï¼š\nå•ä¸ªæœåŠ¡å™¨è¦æ‰¿æ‹… äº¤äº’ ã€è°ƒåº¦ ã€æ‰§è¡Œ çš„å‹åŠ›ï¼Œé‚£ä¹ˆå®ƒèƒ½æ‰¿è½½çš„å®šæ—¶ä»»åŠ¡æ•°é‡åŠ¿å¿…ä¼šè¢«é™åˆ¶ã€‚ åŒæ ·ï¼Œå¦‚æœè¿™ä¸€å°æœºå™¨å‡ºç°é—®é¢˜ï¼Œé‚£ä¹ˆä¸æ˜¯å°±å¯¼è‡´æ‰€æœ‰çš„å®šæ—¶ä»»åŠ¡éƒ½æ— æ³•æ­£å¸¸è¿è¡Œï¼Œå½±å“æ•´ä¸ªç³»ç»Ÿçš„è¿è¡Œã€‚ åŒæ ·ï¼Œå¦‚æœæˆ‘ä»¬éœ€æ±‚çš„æ˜¯ä¸€ä¸ª PasS å¹³å°ï¼Œå•æœºä¸å¯èƒ½ é‚»è¿‘ æ‰€æœ‰çš„ç”¨æˆ·ï¼Œé‚£ä¹ˆç”¨æˆ·è¯·æ±‚å°±å¾ˆå¯èƒ½ç»è¿‡ä¸€äº›ä½ä¿—å’Œæ‹¥å µçš„ç½‘ç»œé“¾è·¯ã€‚ \u0026hellip; ç®€å•çš„è¯´å°±æ˜¯å•ç‚¹é—®é¢˜ï½ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ åˆ†å¸ƒå¼ è®¾è®¡ã€‚\né‚£ä¹ˆæ€ä¹ˆæŠŠå®ƒæ¼”è¿›æˆä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå‘¢ï¼Ÿ\né¦–å…ˆåº”ç”¨ CAP ç†è®ºï¼Œæˆ‘ä»¬å¯ä»¥å…ˆç¡®è®¤è¿™ä¸ªç³»ç»Ÿåº”è¯¥æ˜¯ CP è¿˜æ˜¯ AP ç³»ç»Ÿå‘¢ï¼Ÿå¯¹äºå®šæ—¶ä»»åŠ¡ç³»ç»Ÿï¼Œé«˜å¯ç”¨ä¸æ˜¯æœ€é‡è¦çš„ï¼Œåè€Œæ˜¯å¯é æ€§éå¸¸é‡è¦ã€‚é‚£ä¹ˆå¯é æ€§æ˜¯æ€ä¹ˆä½“ç°çš„å‘¢ï¼Ÿ\nå®šæ—¶ä»»åŠ¡ä¸ä¼šå› ä¸ºæŸäº›èŠ‚ç‚¹å®•æœºè€Œä¸æ‰§è¡Œ å¼ºè°ƒäº†æœ€å¤šè¿è¡Œä¸€æ¬¡ï¼Œä¹Ÿä¸ä¼šè¢«åå¤è°ƒåº¦æ‰§è¡Œ å› ä¸ºç³»ç»Ÿå¼‚å¸¸è€Œæœªè¢«æ‰§è¡Œï¼Œå¯ä»¥è¢«é‡æ–°è°ƒåº¦æ‰§è¡Œ \u0026hellip; å› æ­¤ï¼Œæˆ‘ä»¬ä¸éœ€è¦è¿™ä¸ªç³»ç»Ÿæœ‰éå¸¸é«˜çš„å¯ç”¨æ€§ï¼Œå¶å°”ä¸å¯ç”¨æ˜¯å¯ä»¥æ¥å—çš„ï¼ˆè¿™æ˜¯ç”±å®šæ—¶ä»»åŠ¡çš„æ€§è´¨å†³å®šçš„ï¼‰ã€‚\nå¯¹ä¸€è‡´æ€§çš„æ€è€ƒ # æ€è€ƒä¸‹ï¼Œè¿™é‡Œæ˜¯å¦éœ€è¦ä¸€è‡´æ€§ï¼Ÿå¦‚æœéœ€è¦ï¼Œé‚£ä¹ˆæ˜¯å¼ºä¸€è‡´è¿˜æ˜¯æœ€ç»ˆä¸€è‡´å‘¢ï¼Ÿ æŒ‰ç…§æˆ‘ç›®å‰çš„ç†è§£ï¼Œåˆ†å¸ƒå¼åˆ†ä¸ºä¸¤ç§ï¼ˆæ— çŠ¶æ€å’Œæœ‰çŠ¶æ€ï¼‰ï¼Œé’ˆå¯¹æœ‰çŠ¶æ€çš„æœåŠ¡ï¼Œå¯èƒ½éœ€è¦å¼ºä¸€è‡´æ€§ï¼Œä¹Ÿå¯èƒ½æœ€ç»ˆä¸€è‡´å°±èƒ½æ»¡è¶³æœåŠ¡æ­£å¸¸è¿è¡Œçš„éœ€æ±‚äº†ã€‚\nè¿™é‡Œæˆ‘ä»¬åˆ†ä¸ºå‡ ä¸ªé—®é¢˜æ¥ä¸€æ­¥æ­¥ç†è§£ï¼š\nåˆ†å¸ƒå¼è®¾è®¡ä¹‹åï¼Œå¯¹å®šæ—¶ä»»åŠ¡ç³»ç»Ÿå¸¦æ¥çš„é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ æŒ‰ç…§æˆ‘ä»¬ä¸Šé¢çš„æŠ½è±¡ï¼Œæ€ä¹ˆç¡®å®šç”±å“ªä¸ªèŠ‚ç‚¹æ¥æ‰¿æ‹… scheduler çš„èŒè´£ï¼Ÿ\u0026ndash; é€‰ä¸»ç®—æ³• å¦‚æœ scheduler å®•æœºï¼Œåº”è¯¥ç”±è°æ¥æ¥æ›¿å®ƒçš„å·¥ä½œï¼Ÿ\u0026ndash; é€‰ä¸»ç®—æ³• æ¥æ›¿è€…å¦‚ä½•â€œæ­£ç¡®çš„ç»§ç»­â€ï¼ˆå´©æºƒæ—¶ï¼Œè¢«è°ƒåº¦æœªç»“æŸçš„å’Œè°ƒåº¦ä¸­çš„ä»»åŠ¡å¦‚ä½•å¤„ç†ï¼‰ï¼Ÿ\u0026ndash; é›†ç¾¤çŠ¶æ€ å¦‚æœé›†ç¾¤æ•´ä½“å´©æºƒï¼Œé‚£ä¹ˆä¸‹æ¬¡é›†ç¾¤é‡å¯æ—¶ï¼Œå¦‚ä½•å¼¥è¡¥å®•æœºæœŸé—´çš„ä»»åŠ¡æ‰§è¡Œï¼Ÿ\u0026ndash; é›†ç¾¤çŠ¶æ€ åˆ†å¸ƒå¼é›†ç¾¤æœ‰å“ªäº› çŠ¶æ€ ï¼Ÿ ä»»åŠ¡é˜Ÿåˆ—ï¼ˆè°ƒåº¦å™¨ï¼‰ è°ƒåº¦ä¸­/æ‰§è¡Œä¸­çš„ä»»åŠ¡ï¼ˆè°ƒåº¦å™¨ï¼‰ é›†ç¾¤ä¸­èŠ‚ç‚¹æ¸…å•å’ŒèŠ‚ç‚¹çŠ¶æ€ é›†ç¾¤æ—¶é—´/ä¸Šä¸€æ¬¡è°ƒåº¦æ—¶é—´æˆ³ï¼ˆè°ƒåº¦å™¨ï¼‰ \u0026hellip; ç­‰ç­‰è·Ÿè¿è¡Œç›¸å…³çš„æ•°æ® é€šè¿‡ä¸Šé¢çš„QAï¼Œå†æ¥æ€è€ƒä¸‹åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡å¹³å°å¯¹äºä¸€è‡´æ€§çš„è¦æ±‚ã€‚å¦‚æœä½ æŠŠæ•´ä¸ªç³»ç»Ÿçš„çŠ¶æ€æˆ–è€…æ—¥å¿—ï¼Œæ”¾åœ¨å¤–éƒ¨çš„å­˜å‚¨ç³»ç»Ÿä¸­ï¼Œé‚£ä¹ˆå¯¹äºå®šæ—¶ä»»åŠ¡å¹³å°ä¹Ÿæ²¡æœ‰ç‰¹åˆ«çš„ä¸€è‡´æ€§è¦æ±‚ï¼Œå› ä¸ºå·²ç»ç”±å¤–éƒ¨å­˜å‚¨ç³»ç»Ÿæ¥ç»´æŠ¤äº†ã€‚ä½†æ˜¯å¦‚æœæ˜¯ä¿æŒåœ¨ç³»ç»Ÿå†…éƒ¨ï¼Œé‚£ä¹ˆå°±æœ‰è¦æ±‚äº†ï¼Œå¦‚æœè¯´ç³»ç»Ÿä¸­å„ä¸ªèŠ‚ç‚¹å¯¹äºé›†ç¾¤çš„çŠ¶æ€å­˜å‚¨ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆä¸€æ—¦æ‰§è¡Œè°ƒåº¦ä»»åŠ¡çš„èŠ‚ç‚¹å®•æœºï¼Œå…¶ä»–èŠ‚ç‚¹æ‰§è¡Œè°ƒåº¦æ—¶ä¸Šï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´å®šæ—¶ä»»åŠ¡çš„è°ƒåº¦å‡ºç°ä¸ä¸€è‡´ï¼Œè¿™å°±æ˜¯ä¸€è‡´æ€§çš„é—®é¢˜ã€‚\næŒ‰ç…§æˆ‘ä»¬çš„åˆ†æï¼Œè®¾è®¡çš„åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿç®—æ˜¯ä¸€ä¸ª CP ç³»ç»Ÿã€‚å› æ­¤åœ¨è®¾è®¡çš„æ—¶å€™ï¼ˆæš‚å®šä¸ºé›†ç¾¤å†…éƒ¨ç»´æŠ¤çŠ¶æ€ï¼‰ï¼Œæˆ‘ä»¬é€šè¿‡å¼•å…¥ä¸€è‡´æ€§åè®®æ¥è§£å†³ä¸€è‡´æ€§é—®é¢˜ã€‚å¦‚æœä½ å­¦ä¹ è¿‡åˆ†å¸ƒå¼ç†è®ºï¼Œäº¦æˆ–è€…å­¦ä¹ è¿‡ä¸€äº›åˆ†å¸ƒå¼è½¯ä»¶ï¼Œå¦‚ k8s / etcd / consul ç­‰ç­‰ï¼Œå°±åº”è¯¥çŸ¥é“ Raft å’Œ Paxos è¿™ä¸¤ä¸ªä¸€è‡´æ€§åè®®ã€‚\nRaft æˆ–è€… Paxos æ˜¯é€šè¿‡ Leader-Follower çš„æ–¹å¼æ¥å®ç°å¼ºä¸€è‡´æ€§ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¼•å…¥ Raft ä¹‹åå°±æœ‰å¦‚ä¸‹çš„æ¶æ„ï¼š\nè‡³æ­¤ï¼Œæ•´ä¸ªåˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡çš„æ¡†æ¶å·²ç»æˆå‹ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹è®¾è®¡å®šæ—¶ä»»åŠ¡çš„è°ƒåº¦å™¨äº†ã€‚\nå®šæ—¶ä»»åŠ¡çš„è°ƒåº¦å™¨ # æ€è€ƒä¸‹ï¼Œè°ƒåº¦å™¨çš„èŒè´£æ˜¯ä»€ä¹ˆï¼Ÿ\nè°ƒåº¦å™¨çš„èŒè´£è¯´ç®€å•ç‚¹å°±æ˜¯ï¼Œåœ¨ç¡®å®šåœ¨ä»€ä¹ˆæ—¶é—´åœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šè¿è¡ŒæŸä¸ªå®šæ—¶ä»»åŠ¡ã€‚æ—¶é—´æ ¹æ®cronè§„åˆ™å’Œcronä»»åŠ¡é…ç½®çš„ç­–ç•¥æ¥ç¡®å®šï¼Œè€ŒèŠ‚ç‚¹æ˜¯ç”±è°ƒåº¦å™¨æ ¹æ®æ¯ä¸ªèŠ‚ç‚¹çš„èµ„æºè´Ÿè½½åŒæ—¶é…åˆcronä»»åŠ¡é…ç½®çš„ç­–ç•¥æ¥ç¡®å®šã€‚\nä½†æ˜¯ï¼Œåªæ˜¯è¿™æ ·è€Œå·²å—ï¼Ÿåˆ«å¿˜äº†ç°åœ¨å·²ç»æ˜¯ä¸ªåˆ†å¸ƒå¼é›†ç¾¤äº†ï¼Œè°ƒåº¦å™¨æ˜¯ç”±leaderèŠ‚ç‚¹æ¥è¿è¡Œçš„ã€‚å¦‚æœleadershipå‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆæ¥æ›¿è€…è¿˜åº”è¯¥æ£€æŸ¥ä¸Šä¸€ä»»æ­£åœ¨å¤„ç†çš„äº‹æƒ…ï¼Œå¹¶ä¸”æŠŠå®ƒæ¥ç€åšã€‚ä¸¾ä¸ªä¾‹å­ï¼š\nAã€Bã€C ä¸‰ä¸ªèŠ‚ç‚¹ï¼ŒAä½œä¸ºç¬¬ä¸€ä»»leaderï¼ŒAæ­£åœ¨å¤„ç†ä»»åŠ¡1ä¸”å°šæœªåˆ†é…åˆ°å…·ä½“èŠ‚ç‚¹æ‰§è¡Œã€‚è¿™æ—¶Aå®•æœºäº†ï¼ŒBä½œä¸ºæ¥æ›¿è€…ï¼Œé‚£ä¹ˆBæˆä¸ºleaderåè¿è¡Œè°ƒåº¦å™¨ï¼Œé¦–å…ˆè¦åšçš„æ˜¯å°±æ˜¯é‡å»ºè°ƒåº¦çŠ¶æ€ä¹Ÿå°±æ˜¯é›†ç¾¤çŠ¶æ€ï¼Œå¹¶æ ¹æ®é›†ç¾¤çŠ¶æ€æ¥ç»§ç»­è°ƒåº¦ã€‚é‚£ä¹ˆæ€ä¹ˆé‡å»ºï¼Ÿ\nåŠ è½½æ‰€æœ‰çš„å®šæ—¶ä»»åŠ¡ï¼Œé‡å»ºæ—¶é—´è½®æˆ–è€…å®šæ—¶å™¨ã€‚ æ£€æŸ¥ â€œè¿è¡Œä¸­é˜Ÿåˆ—â€ æ£€æŸ¥ â€œå¾…è°ƒåº¦é˜Ÿåˆ—â€ æ£€æŸ¥ â€œé‡è¯•é˜Ÿåˆ—â€ å…¶ä»–æ•°æ®åŠ è½½ï¼ˆè°ƒåº¦æ—¶é—´ï¼‰ é˜Ÿåˆ—ä¸ºç©ºï¼Œå½“ç„¶æ˜¯æœ€ç®€å•çš„çŠ¶å†µï¼Œå¤æ‚çš„å°±æ˜¯é˜Ÿåˆ—ä¸ä¸ºç©ºæƒ…å†µä¸‹æ€ä¹ˆå¤„ç†ï¼Ÿè¿è¡Œä¸­ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆæ¢å¤ç»“æœåŒæ­¥åç¨‹ï¼›å¾…è°ƒåº¦ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆæ ¹æ®è°ƒåº¦ç®—æ³•å’Œä»»åŠ¡é…ç½®çš„ç­–ç•¥æ¥è°ƒåº¦ï¼›é‡è¯•é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆæ ¹æ®è°ƒåº¦ç®—æ³•å’Œä»»åŠ¡é…ç½®çš„ç­–ç•¥æ¥è°ƒåº¦ã€‚\nä»»åŠ¡é…ç½®çš„ç­–ç•¥ï¼Œå¦‚ä¸èƒ½å¹¶å‘ï¼›å¯ä»¥é‡è¯•ï¼›æœ€æ™šè°ƒåº¦æ—¶é—´ç­‰ç­‰ï¼Œéƒ½ä¼šå‚ä¸è°ƒåº¦ç®—æ³•ã€‚\nç”¨ä»£ç æ¥æè¿°çš„è¯ï¼Œå°±æ˜¯ï¼š\ndef schedule(self): if leadership_changed: # cluster first run or leadership changed self.start_cron_timer() self.rebuild_wait_scheduled_queue() self.rebuild_retry_queue() self.rebuild_running_queue() for True: job = self.get_from_wait_schduled_or_retry_queue() if job is None: backoff_delay() continue node_id = self.match_node(job) # build cronjob\u0026#39;s RunContext, put it into running queue and # start a coroutine to synchroize the cronjob\u0026#39;s running result. self.schedule_to_node(node_id, job) å®šæ—¶ä»»åŠ¡è¿è¡Œæ—¶ # ä»»åŠ¡è¿è¡Œæ—¶æ˜¯ä¸ºäº†æ–¹ä¾¿æŠ½è±¡å’Œæ‰©å±•è€Œæ¥çš„ä¸€ä¸ªæ¦‚å¿µï¼Œå®ƒçš„èŒè´£æ˜¯æ¥å—Leaderä»»åŠ¡è°ƒåº¦è¯·æ±‚ï¼Œè¿è¡Œå®šæ—¶ä»»åŠ¡å¹¶ä¸”åŒæ­¥è¿è¡Œç»“æœã€‚ä½†è¿è¡Œæ—¶ä¸ä¸€å®šæ˜¯è¦é›†ç¾¤å†…çš„æœåŠ¡å™¨æ¥æ‹…ä»»ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤–éƒ¨çš„ç³»ç»Ÿï¼Œå¦‚ï¼šk8s, containerd, docker, etcï¼Œå†…éƒ¨åªéœ€è¦æŠŠå¤–éƒ¨ç³»ç»ŸåŒ…è£…æˆç¬¦åˆè¿è¡Œæ—¶è¦æ±‚çš„èµ„æºå³å¯ã€‚\nè¿™é‡Œï¼Œæˆ‘ä»¬å‡å®šå®šæ—¶ä»»åŠ¡çš„èµ„æºç±»å‹ä¸ºå®¹å™¨é•œåƒï¼Œè¿è¡Œç¯å¢ƒè‡ªç„¶å°±æ˜¯å®¹å™¨è¿è¡Œæ—¶ã€‚é‚£ä¹ˆå®šæ—¶ä»»åŠ¡çš„è¿è¡Œæ—¶ï¼Œå°±åªéœ€è¦åŒ…è£…ä¸€ä¸‹k8sçš„APIæˆ–è€…å®šä¹‰CRDå³å¯ã€‚\ntype JobRuntime interface { // running job RunJobAsync(ctx context.Context, job *Job, resultCh chan\u0026lt;- *JobResult) (err error) // cancel job (timeout, etc) CancelJob(job *Job, reason Reason) (err error) // query job\u0026#39;s status (running, success, failed, etc) QueryJobResult(job *Job) (result *JobResult, err error) } å› ä¸ºè¿è¡Œæ—¶ä¹Ÿç®—ä¸€ä¸ªæ— çŠ¶æ€èŠ‚ç‚¹ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰å¤ªå¤šçš„è®¾è®¡è¦ç´ ã€‚\nKubernetes CronJob # å¦‚æœå¯¹k8sç¨å¾®äº†è§£ä¸€ç‚¹ï¼Œè‚¯å®šä¼šå¥½å¥‡ï¼Œä¸ºå•¥ä¸ç›´æ¥ä½¿ç”¨k8sçš„cronjobæ¥æ»¡è¶³å®šæ—¶ä»»åŠ¡ç³»ç»Ÿçš„ä½¿ç”¨åœºæ™¯å‘¢ï¼Ÿå½“ç„¶æ˜¯å¯ä»¥çš„ï¼Œåªæ˜¯è¿™é‡Œçš„ä¸»è¦ç›®çš„æ˜¯ä»å¤´æ¢³ç†ä¸€ä¸ªï¼ˆåˆ†å¸ƒå¼ï¼‰å®šæ—¶ä»»åŠ¡ç³»ç»Ÿçš„åŠŸèƒ½å’Œè®¾è®¡ã€‚åœ¨ä¸€èˆ¬åœºæ™¯ä¸‹ k8s cronjob å·²ç»èƒ½å¤Ÿæ»¡è¶³ä½¿ç”¨äº†ï¼Œåªæœ‰ä¸ªåˆ«åœºæ™¯ä¸èƒ½ç›´æ¥æ”¯æŒï¼š\né¢„åˆ†é…ï¼ˆä¼˜å…ˆä¿è¯é‡è¦çš„å®šæ—¶ä»»åŠ¡èµ„æºï¼‰ å¹‚ç­‰ä¿è¯ï¼ˆå¹¶å‘/å¹‚ç­‰ç²¾ç»†æ§åˆ¶ï¼‰ å®æ—¶æ€§ï¼ˆè¶…æ—¶é€€å‡ºï¼Œè¿‡æ—¶ä¸å¯åŠ¨ï¼‰ spec.startingDeadlineSeconds å¼‚å¸¸å‘Šè­¦ å¦å¤–å°±æ˜¯åœ¨ä½¿ç”¨ä¸Šæ²¡æœ‰é‚£ä¹ˆâ€œæ–¹ä¾¿â€ï¼ˆè¿ç»´å¯ä¸ä¸€å®šä¼šè®©å¼€å‘ç›´æ¥æ¥è§¦k8s~ï¼‰ã€‚\nå…³äº CronJob çš„è¯¦ç»†æ§åˆ¶å¯ä»¥å‚è§ https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/cron-job-v1/#CronJobSpec\nä¸ªäººä»¥ä¸ºï¼Œä¸­å°å‹å…¬å¸æ²¡å¿…è¦èŠ±è´¹å¤§ç²¾åŠ›å»å¼€å‘åˆ†åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿï¼Œåªéœ€è¦åœ¨k8sçš„ CronJob/Job çš„åŸºç¡€ä¸Šç¨å¾®åŒ…è£…ä¸€ä¸‹è‡ªå·±çš„æ§åˆ¶æ¨¡å—å°±èƒ½æ»¡è¶³è¦æ±‚ã€‚\næ€»ç»“ # å®šæ—¶ä»»åŠ¡ç³»ç»Ÿæ˜¯æœ€å¸¸ç”¨çš„æœåŠ¡ä¹‹ä¸€ï¼Œå®ç°æ–¹å¼å¯å¤§å¯å°ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨linux crontab æœåŠ¡ã€‚æœ¬æ–‡åœ¨ä¸ä¾èµ–ä»»ä½•æœåŠ¡çš„å‰æä¸‹ï¼Œæ¥è®¾è®¡ä¸€ä¸ªåˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç³»ç»Ÿï¼Œä»åŠŸèƒ½åˆ°æ¶æ„ä¸€ä¸€æ¢³ç†ã€‚å½“ç„¶ï¼Œæ–‡ä¸­æåˆ°çš„åŠŸèƒ½æ¸…å•ä¸ä¸€å®šå…¨ï¼Œåªæ˜¯ç«™åœ¨æˆ‘çš„è§’åº¦çœ‹åˆ°çš„å¿…è¦æåŠçš„é€šç”¨åŠŸèƒ½ã€‚æ¶æ„ä¹Ÿä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„åœºæ™¯å’Œç›®çš„æ¥è®¾è®¡ï¼Œåªè¦è¾¾åˆ°ç›®çš„å³å¯ã€‚\næ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿å‹˜è¯¯æŒ‡æ­£ã€‚\nå‚è€ƒæ–‡çŒ® # https://xargin.com/google-cron-design/ https://queue.acm.org/detail.cfm?id=2745840 https://kubernetes.io/zh/docs/concepts/workloads/controllers/cron-jobs/ "},{"id":22,"href":"/2022/01/25/protoc-gen-fieldmask%E6%8F%92%E4%BB%B6/","title":"protoc-gen-fieldmaskæ’ä»¶","section":"Posts","content":" èƒŒæ™¯ # gRPC ä½œä¸ºæœåŠ¡ç«¯çš„å¸¸ç”¨æ¡†æ¶ï¼Œå®ƒé€šè¿‡ protocol-buffers è¯­è¨€æ¥å®šä¹‰æœåŠ¡ï¼ŒåŒæ—¶ä¹Ÿçº¦å®šäº†è¯·æ±‚å’Œå“åº”çš„æ ¼å¼ï¼Œè¿™æ ·åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´å°±å¯ä»¥é€šè¿‡ protoc ç”Ÿæˆçš„ä»£ç ç›´æ¥è¿è¡Œè€Œä¸ç”¨è€ƒè™‘ç¼–ç ä¼ è¾“é—®é¢˜äº†ã€‚\nä½†æ˜¯ï¼Œå¯èƒ½ä¼šé‡åˆ°è¿™æ ·çš„åœºæ™¯ï¼š\nRPC å“åº”ä¸­ æ— ç”¨çš„å­—æ®µè¿‡å¤š , æµªè´¹å¸¦å®½å’Œæ— æ•ˆè®¡ç®—ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nè¿™é‡Œçš„æ— ç”¨å­—æ®µæ˜¯æŒ‡ï¼Œåœ¨å“åº”ä¸­ï¼Œæ²¡æœ‰ç”¨åˆ°çš„å­—æ®µï¼Œè¿™äº›å­—æ®µå¯ä»¥å¿½ç•¥æ‰ï¼Œä¸ä¼šå½±å“å®¢æˆ·ç«¯çš„ä½¿ç”¨ã€‚\næˆ–è®¸ æ‹†åˆ†æ¥å£ æ˜¯ä¸€ä¸ªå¥½çš„åŠæ³•ï¼Œä½†æ˜¯å¯èƒ½ä¼šå› ä¸ºè¿™æ ·é‚£æ ·çš„åŸå› ï¼ˆä¿¡æ¯ç²’åº¦é™ä½å¯¼è‡´æ¥å£å¤ªå¤šäº†ï¼Œæœ‰äº›åœ°æ–¹å°±æ˜¯éœ€è¦èšåˆä¿¡æ¯ï¼›ç»†ç²’åº¦çš„APIè®¾è®¡åŒæ—¶ä¼šå¯¼è‡´ä»£ç é‡å¤å¢åŠ ï¼‰ï¼Œå¯èƒ½æ— æ³•æ¨åŠ¨æ‹†åˆ†æ”¹é€ ã€‚åŒæ—¶å¦‚æœæ²¡æœ‰æ‹†åˆ†æ ‡å‡†ï¼Œäº¦æˆ–å›¢é˜Ÿå†…æˆå‘˜ä¸èƒ½ä¸¥æ ¼éµå®ˆæ ‡å‡†ï¼Œé‚£ä¹ˆæ‹†åˆ†ä¹Ÿåªæ˜¯é‡å¤é—®é¢˜è€Œå·²ã€‚\nRPC å¢é‡æ›´æ–°æ—¶ï¼Œå¦‚ä½•åˆ¤æ–­é›¶å€¼å­—æ®µæ˜¯å¦éœ€è¦æ›´æ–°ï¼Ÿ\nå¯¹äº unset å’Œ zero value ä¸å¥½åŒºåˆ†çš„è¯­è¨€ä¸­ï¼ˆæ¯”å¦‚ï¼šgoï¼‰ï¼Œåœ¨æä¾›æœåŠ¡çš„ä¸€æ–¹é‡åˆ° å¢é‡æ›´æ–° çš„åœºæ™¯æ—¶å°±ä¼šé‡åˆ°è¿™æ ·çš„æƒ…å†µï¼š\nå¯¹äºè¿™ç§æƒ…å†µå½“ç„¶å¯ä»¥ä¹Ÿæœ‰ä¸€äº›æ–¹æ³•æ¥è§£å†³ï¼Œæ¯”å¦‚ï¼šä½¿ç”¨æŒ‡é’ˆæ¥å®šä¹‰æ•°æ®åŸºæœ¬ç±»å‹ï¼Œé‚£ä¹ˆåœ¨ä½¿ç”¨çš„æ—¶å€™å¦‚æœåˆ¤å®šä¸º nil å°±è¯´æ˜æ²¡æœ‰è®¾ç½®ï¼Œå¦‚æœä¸ä¸º nil ä¸”ä¸ºé›¶å€¼ï¼Œé‚£ä¹ˆå°±è¯´æ˜ä¹Ÿæ˜¯éœ€è¦æ›´æ–°çš„ã€‚ä¸è¿‡è¿™æ ·è§£å†³çš„ç¼ºç‚¹å°±æ˜¯ï¼Œnil refference panic çš„æ¦‚ç‡åˆå¢åŠ äº†ï¼Œåœ¨ä½¿ç”¨æ—¶ä¹Ÿç¨å¾®éº»çƒ¦äº†ä¸€ç‚¹ã€‚\nÂ·\nè§£å†³æ–¹æ¡ˆ # å…¶å®æˆ‘ä»¬åœ¨æ€è€ƒä¸Šè¿°ä¸¤ç§åœºæ™¯çš„æ—¶å€™ï¼ŒæŠŠ å®¢æˆ·ç«¯ å’Œ æœåŠ¡ç«¯ çš„è§’è‰²æå–å‡ºæ¥ï¼Œå°±ä¼šå‘ç°è¿™ä¸¤ä¸ªåœºæ™¯éƒ½æ˜¯ä» æœåŠ¡ç«¯ çš„è§†è§’é‡åˆ°çš„é—®é¢˜ï¼Œä¸¤ä¸ªåœºæ™¯éƒ½æ˜¯ç±»ä¼¼çš„ï¼š\nå®¢æˆ·ç«¯éœ€è¦å“ªäº›å­—æ®µï¼ŒæœåŠ¡ç«¯ä¸çŸ¥é“ å®¢æˆ·ç«¯æ›´æ–°äº†å“ªäº›å­—æ®µï¼ŒæœåŠ¡ç«¯ä¹Ÿä¸çŸ¥é“ ä½†æ˜¯ï¼Œå…¶å®å®¢æˆ·ç«¯æ˜¯çŸ¥é“çš„ï¼Œå› æ­¤è®©å®¢æˆ·ç«¯æŠŠè¿™éƒ¨åˆ†ä¿¡æ¯ä¼ é€’ç»™æœåŠ¡ç«¯å°±è¡Œäº†ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥ç”¨ FieldMask å­—æ®µï¼Œç”¨æ¥ä¼ é€’å®¢æˆ·ç«¯éœ€è¦çš„å­—æ®µï¼ŒæœåŠ¡ç«¯å°±åªè¿”å›éœ€è¦çš„å­—æ®µï¼›å®¢æˆ·ç«¯çš„å‘Šè¯‰æœåŠ¡ç«¯éœ€è¦å“ªäº›å­—æ®µï¼ŒæœåŠ¡ç«¯å°±æ›´æ–°å“ªäº›å­—æ®µã€‚\nä½†æ˜¯ FieldMask åªæ˜¯ä¸€ä¸ªå®šä¹‰ï¼Œåœ¨å…·ä½“çš„ä½¿ç”¨åœºæ™¯ä¸­è¿˜éœ€è¦å¼€å‘è€…è‡ªå·±ç¼–å†™ä¸€äº›è¾…åŠ©æ–¹æ³•ï¼Œæ¥å®ç°åŠŸèƒ½ã€‚é‚£ä¹ˆæ˜¯ä¸æ˜¯å¯ä»¥æä¾›ä¸€ä¸ªæ’ä»¶ï¼Œè®©å¼€å‘è€…å¯ä»¥åªç¼–å†™ proto æ–‡ä»¶ï¼Œä¾¿å¯ä»¥è‡ªåŠ¨ç”Ÿæˆä¸€äº›è¾…åŠ©æ–¹æ³•å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œé¢„è§ˆæ•ˆæœå¦‚ä¸‹ï¼š\nmessage UserInfoRequest { string user_id = 1; google.protobuf.FieldMask field_mask = 2 [ (fieldmask.option.Option).in = {gen: true}, (fieldmask.option.Option).out = {gen: true, message:\u0026#34;UserInfoResponse\u0026#34;} ]; } message Address { string country = 1; string province = 2; } message UserInfoResponse { string user_id = 1; string name = 2; string email = 3;Â· Address address = 4; } message NonEmpty {} service UserInfo { rpc GetUserInfo(UserInfoRequest) returns (UserInfoResponse) {} rpc UpdateUserInfo(UserInfoRequest) returns (NonEmpty) {} } ç”Ÿæˆçš„ä»£ç å¦‚ä¸‹ï¼š\nå› ä¸ºç¯‡å¹…æœ‰é™ï¼Œå¯¹ä»£ç è¿›è¡Œäº†åˆ å‡ï¼Œå¦‚æœéœ€è¦æŸ¥é˜…å®Œæ•´ä»£ç è¯·å‚è§ github.com/yeqown/protoc-gen-fieldmask/examples/pb/user.pb.fm.go\n// FieldMask å…¬å…±éƒ¨åˆ†ä»£ç  // FieldMaskWithMode æ ¹æ®ä¸åŒçš„æ¨¡å¼å†³å®šä¸åŒçš„ä½¿ç”¨å§¿åŠ¿ï¼ˆFilter å’Œ Pruneï¼‰ func (x *UserInfoRequest) FieldMaskWithMode(mode pbfieldmask.MaskMode) *UserInfoRequest_FieldMask { fm := \u0026amp;UserInfoRequest_FieldMask{ maskMode: mode, maskMapping: make(map[string]struct{}, len(x.FieldMask.GetPaths())), } for _, path := range x.FieldMask.GetPaths() { fm.maskMapping[path] = struct{}{} } return fm } // Filter æ¨¡å¼ä¸‹ï¼ŒåŒ…å«åœ¨ FieldMask ä¸­çš„å­—æ®µä»£è¡¨ ä¿ç•™ / æ›´æ–°ã€‚ func (x *UserInfoRequest) FieldMask_Filter() *UserInfoRequest_FieldMask { return x.FieldMaskWithMode(pbfieldmask.MaskMode_Filter) } // Prune æ¨¡å¼ä¸‹ï¼ŒåŒ…å«åœ¨ FieldMask çš„å­—æ®µä»£è¡¨éœ€è¦ å»é™¤ / ä¸æ›´æ–°ã€‚ func (x *UserInfoRequest) FieldMask_Prune() *UserInfoRequest_FieldMask { return x.FieldMaskWithMode(pbfieldmask.MaskMode_Prune) } // UserInfoRequest_FieldMask provide provide helper functions to deal with FieldMask. type UserInfoRequest_FieldMask struct { maskMode pbfieldmask.MaskMode maskMapping map[string]struct{} } // å¢é‡æ›´æ–°çš„æœåŠ¡éƒ¨åˆ†ä»£ç  (fieldmask.option.Option).in = {gen: true} æ§åˆ¶ç”Ÿæˆ func (x *UserInfoRequest) MaskIn_UserId() *UserInfoRequest {} func (x *UserInfoRequest_FieldMask) MaskedIn_UserId() bool {} // å“åº”å­—æ®µè£å‰ªéƒ¨åˆ†ä»£ç  (fieldmask.option.Option).out = {gen: true, message:\u0026#34;UserInfoResponse\u0026#34;} æ§åˆ¶ç”Ÿæˆ func (x *UserInfoRequest) MaskOut_UserId() *UserInfoRequest {} func (x *UserInfoRequest) MaskOut_Name() *UserInfoRequest {} func (x *UserInfoRequest_FieldMask) MaskedOut_UserId() bool {} func (x *UserInfoRequest_FieldMask) MaskedOut_Name() bool {} // Mask æ ¹æ® FieldMask å’Œ mode æ¥è£å‰ªå“åº”å­—æ®µã€‚ func (x *UserInfoRequest_FieldMask) Mask(m *UserInfoResponse) *UserInfoResponse { switch x.maskMode { case pbfieldmask.MaskMode_Filter: x.filter(m) case pbfieldmask.MaskMode_Prune: x.prune(m) } return m } func (x *UserInfoRequest_FieldMask) filter(m proto.Message) { if len(x.maskMapping) == 0 { return } pr := m.ProtoReflect() pr.Range(func(fd protoreflect.FieldDescriptor, _ protoreflect.Value) bool { _, ok := x.maskMapping[string(fd.Name())] if !ok { pr.Clear(fd) return true } return true }) } func (x *UserInfoRequest_FieldMask) prune(m proto.Message) { if len(x.maskMapping) == 0 { return } pr := m.ProtoReflect() pr.Range(func(fd protoreflect.FieldDescriptor, _ protoreflect.Value) bool { _, ok := x.maskMapping[string(fd.Name())] if !ok { return true } pr.Clear(fd) return true }) } åˆäº†ä¸Šè¿°çš„è¾…åŠ©ä»£ç ï¼Œå› æ­¤æˆ‘ä»¬å°±å¯ä»¥åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç›´æ¥ä½¿ç”¨äº†ï¼š\nå®¢æˆ·ç«¯ä¾§ï¼š\nfunc main() { maskedReq := \u0026amp;pb.UserInfoRequest{ UserId: \u0026#34;1\u0026#34;, } maskedReq. MaskOut_Email(). // masking email field in response MaskOut_Address() // masking address field in response } æœåŠ¡ç«¯ä¾§ï¼š\n// å“åº”è£å‰ªç¤ºä¾‹ func (u userServer) GetUserInfo( ctx context.Context, request *pb.UserInfoRequest, ) (*pb.UserInfoResponse, error) { // FieldMask_Filter means that the fields are included in the response, // otherwise they are omitted. // FieldMask_Prune means masked fields are not included in the response, // otherwise they are included. fm := request.FieldMask_Filter() // fm2 := request.FieldMask_Prune() fmt.Printf(\u0026#34;userServer.GetUserInfo is called: %v\\n\u0026#34;, request.String()) resp := \u0026amp;pb.UserInfoResponse{ UserId: \u0026#34;69781\u0026#34;, Name: \u0026#34;yeqown\u0026#34;, Email: \u0026#34;yeqown@gmail.com\u0026#34;, Address: nil, } // judge if the field masked or not, avoid unnecessary call or calculation. if fm.MaskedOut_Address() { // filter more, so the address field should be included. resp.Address = \u0026amp;pb.Address{ Country: \u0026#34;China\u0026#34;, Province: \u0026#34;Sichuan\u0026#34;, } } // filter the field masked out. _ = fm.Mask(resp) return resp, nil } // å¢é‡æ›´æ–°ç¤ºä¾‹ func (u userServer) UpdateUserInfo(ctx context.Context, request *pb.UserInfoRequest) (*pb.NonEmpty, error) { // FieldMask_Filter means that the fields are expected to update, // otherwise they are ignored. // FieldMask_Prune means masked fields are ignored to update, // otherwise they are expected to update. fm := request.FieldMask_Filter() // fm2 := request.FieldMask_Prune() fmt.Printf(\u0026#34;userServer.UpdateUserInfo is called: %v\\n\u0026#34;, request.String()) if fm.MaskedIn_UserId() { // userId want to be updated, so you should use request.UserId to update. fmt.Println(\u0026#34;userId want to be updated.\u0026#34;) } return new(pb.NonEmpty), nil } å…³äº PG* çš„ä¸€äº›æ€»ç»“ # PG* å°±æ˜¯ protoc-gen-star çš„ç¼©å†™ï¼Œæ˜¯ä¸€ä¸ªé«˜æ•ˆå¼€å‘ protoc æ’ä»¶çš„ go è¯­è¨€åº“ã€‚\nprotoc-gen-fieldmask å°±æ˜¯ä»¥å®ƒä¸ºåŸºç¡€å¼€å‘çš„ä¸€ä¸ªæ’ä»¶ï¼ˆPGVä¹Ÿæ˜¯ï¼‰ã€‚æ¯”è¾ƒæ—©ä»¥å‰å°±çŸ¥é“äº†è¿™ä¹ˆä¸ªåº“çš„å­˜åœ¨ï¼Œä½†æ˜¯ä½†æ˜¯å¹¶æ²¡æœ‰ä»€ä¹ˆå¥½çš„ç‚¹å­ï¼Œä¹Ÿå°±ä¸€ç›´æ²¡æœ‰å®è·µè¿‡ï¼Œè¿™æ¬¡å°±é¡ºä¾¿å­¦ä¹ äº†ä¸€ä¸‹è¿™ä¸ªåº“çš„ä¸€äº›ç”¨æ³•ï¼š\nåŸºæœ¬åŸç†\næ‰€æœ‰çš„æ’ä»¶éƒ½æ˜¯é…åˆ protoc ä¸€èµ·å·¥ä½œçš„ï¼Œprotoc ä¼šå¤„ç†æºä»£ç ç„¶åç”Ÿæˆä¸€ä¸ª CodeGeneratorRequest çš„è¯·æ±‚ï¼Œè°ƒç”¨æ’ä»¶ï¼Œæ’ä»¶å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œç”Ÿæˆä¸€ä¸ª CodeGeneratorResponse çš„å“åº”ï¼Œprotoc ä¼šå¤„ç†è¿™ä¸ªå“åº”å¹¶ç”Ÿæˆæ–‡ä»¶ã€‚\næ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š\nfoo.proto â†’ protoc â†’ CodeGeneratorRequest â†’ protoc-gen-myplugin â†’ CodeGeneratorResponse â†’ protoc â†’ foo.pb.go\nåŸºæœ¬ç”¨æ³•\nprotoc-gen-star æŠ½è±¡äº†ä¸€ä¸ª Module, å¹¶æä¾›ä¸€ä¸ªä¸€ç³»åˆ—çš„è¾…åŠ©æ–¹æ³•ï¼Œå› æ­¤ä½ éœ€è¦åšçš„äº‹å°±æ˜¯å®ç°è¿™ä¸ª Moduleã€‚é‚£ä¹ˆå¦‚ä½•å®ç°å‘¢ï¼Ÿ\n// Module describes the interface for a domain-specific code generation module // that can be registered with the PG* generator. type Module interface { // The Name of the Module, used when establishing the build context and used // as the base prefix for all debugger output. Name() string // InitContext is called on a Module with a pre-configured BuildContext that // should be stored and used by the Module. InitContext(c BuildContext) // Execute is called on the module with the target Files as well as all // loaded Packages from the gatherer. The module should return a slice of // Artifacts that it would like to be generated. Execute(targets map[string]File, packages map[string]Package) []Artifact } é‡ç‚¹å°±æ˜¯ Execute æ–¹æ³•ï¼Œåœ¨å…¶ä¸­éå†æ‰€æœ‰æ–‡ä»¶çš„ ASTï¼Œè¯†åˆ«ä½ çš„æ’ä»¶éœ€è¦å¤„ç†çš„ç‰¹å¾ï¼Œç„¶åå‡†å¤‡å¥½ä¸€ä¸ª Artifactï¼Œç„¶åè¿”å›è¿™ä¸ª Artifactã€‚\nArtifact å°±æ˜¯é¢„æœŸç”Ÿæˆçš„ æ–‡ä»¶å¯¹è±¡ï¼Œåœ¨ protoc-gen-star ä¸­ï¼Œå®ƒå¯ä»¥æ˜¯é€šè¿‡æ¨¡æ¿ç”Ÿæˆï¼Œä¹Ÿå¯ä»¥å°±æ˜¯å®Œæ•´çš„æ–‡ä»¶å†…å®¹ã€‚\nå¦‚ä½•è°ƒè¯•ä½ çš„æ’ä»¶\nåœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œè°ƒè¯•/æµ‹è¯•ç¯èŠ‚å¿…ä¸å¯å°‘ï¼Œé‚£ä¹ˆå¯¹äºä¾èµ–äº protoc ç¼–è¯‘çš„æ’ä»¶è¯¥æ€ä¹ˆè°ƒè¯•å‘¢ï¼Ÿå°¤å…¶æ˜¯æ€ä¹ˆæ–­ç‚¹è°ƒè¯•å‘¢ï¼Ÿ\næ—¥å¿—è°ƒè¯• protoc-gen-star å·²ç»åœ¨ ModuleBase ä¸­å†…ç½®äº†æ—¥å¿—è®°å½•ï¼Œåªéœ€è¦è°ƒç”¨ ModuleBase.Debugf æˆ–è€… ModuleBase.Logf æ–¹æ³•å³å¯ã€‚\nIDE æ–­ç‚¹è°ƒè¯• å…‰æœ‰æ—¥å¿—å¯ä¸å¤Ÿï¼Œæƒ³è¦è¿½è¸ªæŸä¸ªå˜é‡çš„å€¼ï¼Œæ‰“æ—¥å¿—å¯èƒ½ä¼šè®©ä½ å´©æºƒã€‚æˆ‘ä»¬å¾—æƒ³åŠæ³•ï¼Œå¯ä»¥åœ¨IDEä¸­è°ƒè¯•è‡ªå·±çš„æ’ä»¶ã€‚æƒ³è¦æ–­ç‚¹è°ƒè¯•ï¼Œé‚£ä¹ˆå°±ä¸èƒ½ä¾èµ– protoc, å¿…é¡»å¾—è®©æ’ä»¶å¯ä»¥ç‹¬ç«‹è¿è¡Œï¼Œè¿™æ ·æ‰èƒ½è°ƒè¯•ã€‚\nå›é¡¾ä¸€ä¸‹å‰é¢çš„åŸºæœ¬åŸç†ï¼Œæˆ‘ä»¬çš„æ’ä»¶å…¶å®æ˜¯ä¾èµ– CodeGeneratorRequestï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬å¯ä»¥æ„é€ ä¸€ä¸ª CodeGeneratorRequestï¼Œé‚£ä¹ˆå°±å¯ä»¥æ„å»ºä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œç”¨æ¥è°ƒè¯•è¿è¡Œäº†ã€‚proto-gen-star å·²ç»æä¾›äº†ä¸€ä¸ª protoc-gen-debug æ¥ç”Ÿæˆ CodeGeneratorRequestã€‚\nprotoc \\ -I=./examples/pb \\ -I=./proto \\ --plugin=protoc-gen-debug=/usr/local/bin/proto-gen-debug \\ --debug_out=\u0026#34;./internal/module/debugdata:.\u0026#34; \\ ./examples/pb/user.proto å†ç¼–å†™ä¸€ä¸ªç±»ä¼¼çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå°±å¯ä»¥åœ¨IDEä¸­è°ƒè¯•äº†è‡ªå·±çš„æ’ä»¶äº†ã€‚\nfunc (m *moduleTestSuite) Test_ForDebug() { // please look up the README at repository root directory to see how to // generate the `debugdata` and code_generator_request binary. req, err := os.Open(\u0026#34;./debugdata/code_generator_request.pb.bin\u0026#34;) m.NoError(err) fs := afero.NewMemMapFs() res := \u0026amp;bytes.Buffer{} pgs.Init( pgs.ProtocInput(req), // use the pre-generated request pgs.ProtocOutput(res), // capture CodeGeneratorResponse pgs.FileSystem(fs), // capture any custom files written directly to disk pgs.MutateParams(mutateLangParam(\u0026#34;go\u0026#34;)), // mutate params ). RegisterModule(m.module). Render() } æ€»ç»“ # FieldMask åœ¨å±è”½å­—æ®µåŠŸèƒ½ä¸Šç±»ä¼¼ GraphQL çš„åŠŸèƒ½ï¼Œä½†æ˜¯å®ç°æœºç†æ›´åŠ ç®€å•ï¼Œæ›´åŠ çµæ´»ï¼›æœ€é‡è¦çš„æ˜¯ï¼ŒgRPC çš„ä½¿ç”¨èŒƒå›´æ›´å¹¿ï¼Œæ›´å¤šçš„è¢«å¾®æœåŠ¡åœºæ™¯ä¸­ä½¿ç”¨ã€‚\næ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿å‹˜è¯¯æŒ‡æ­£ğŸ™ã€‚\nå‚è€ƒèµ„æ–™ # go.dev fieldmaskpb protoc-gen-fieldmask protoc-gen-star "},{"id":23,"href":"/2021/12/15/Sentry-OpenTelemetry%E5%89%8D%E5%90%8E%E7%AB%AF%E5%85%A8%E9%93%BE%E8%B7%AF%E6%89%93%E9%80%9A%E6%80%BB%E7%BB%93/","title":"Sentry+OpenTelemetryå‰åç«¯å…¨é“¾è·¯æ‰“é€šæ€»ç»“","section":"Posts","content":"è‡ªä»å¾®æœåŠ¡å¤§è¡Œå…¶é“ï¼Œå®¹å™¨åŒ–å’Œk8sç¼–æ’ä¸€ç»Ÿå¤©ä¸‹ä¹‹åï¼Œ\u0026ldquo;å¯è§‚æµ‹æ€§\u0026rdquo; ä¾¿è¢«æå‡ºæ¥ã€‚è¿™ä¸ªæ¦‚å¿µæ˜¯æŒ‡ï¼Œå¯¹äºåº”ç”¨æˆ–è€…å®¹å™¨çš„è¿è¡ŒçŠ¶å†µçš„æŒæ§ç¨‹åº¦ï¼Œå…¶ä¸­åˆ†ä¸ºäº†ä¸‰ä¸ªæ¨¡å—ï¼šMetricsã€Tracingã€Loggingã€‚Metrics æŒ‡åº”ç”¨é‡‡é›†çš„æŒ‡æ ‡ï¼›Tracing æŒ‡åº”ç”¨çš„è¿½è¸ªï¼›Logging æŒ‡åº”ç”¨çš„æ—¥å¿—ã€‚\næ—¥å¿—è‡ªä¸ç”¨å¤šè¯´ï¼Œè¿™æ˜¯æœ€åŸå§‹çš„è°ƒè¯•å’Œæ•°æ®é‡‡é›†èƒ½åŠ›ã€‚Metrics æ¯”è¾ƒç«çš„æ–¹æ¡ˆå°±æ˜¯ Prometheus + Grafanaï¼Œæ€è·¯å°±æ˜¯é€šè¿‡åº”ç”¨å†…åŸ‹å…¥SDKï¼Œé€‰æ‹© Pull æˆ–è€… Push çš„æ–¹å¼å°†æ•°æ®æ”¶é›†åˆ° prometheus ä¸­ï¼Œç„¶åé€šè¿‡ Grafana å®ç°å¯è§†åŒ–ï¼Œå½“ç„¶è¿™ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹å°±æ­¤ç•¥è¿‡ã€‚\nTracing ä¹Ÿå¹¶ä¸æ˜¯å¯è§‚æµ‹æ€§æå‡ºåæ‰è¯ç”Ÿçš„æ¦‚å¿µï¼Œåœ¨å¾®æœåŠ¡åŒ–çš„è¿›ç¨‹ä¸­å°±å·²ç»æœ‰Googleçš„Dapperè½åœ°å®è·µï¼Œå¹¶æ…¢æ…¢å½¢æˆ OpenTracing è§„èŒƒï¼Œè¿™ä¸€è§„èŒƒåˆè¢«å¤šå®¶ç¬¬ä¸‰æ–¹æ¡†æ¶æ‰€æ”¯æŒï¼Œå¦‚ Jaegerã€Zipkin ç­‰ã€‚OpenTelemetry å°±æ˜¯ç»“åˆäº† OpenTracing + OpenCensus è§„èŒƒï¼Œçº¦å®šå¹¶æä¾›å®Œæˆçš„å¯è§‚æµ‹æ€§å¥—ä»¶ï¼Œåªæ˜¯ç›®å‰ï¼ˆ2021-12-15ï¼‰ç¨³å®šä¸‹æ¥çš„åªæœ‰ Tracing è¿™ä¸€éƒ¨åˆ†è€Œå·²ã€‚å¯¹ OpenTelemetry å‘å±•å†å²æ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œäº†è§£ã€‚\næ•ˆæœé¢„è§ˆ # é“¾è·¯æ€»è§ˆï¼ŒåŒ…å«äº†å‰ç«¯é¡µé¢çš„ç”Ÿå‘½å‘¨æœŸ + æ•´ä¸ªäº†é“¾è·¯é‡‡é›†åˆ°çš„Spanèšåˆã€‚\nå‰ç«¯é¡µé¢æŒ‡æ ‡é‡‡é›†æ¦‚è§ˆï¼ŒåŒ…å«äº†è¯¥é¡µé¢ç”Ÿå‘½å‘¨æœŸå†…çš„åŠ¨ä½œå’Œæ—¥å¿—ç­‰ã€‚\næœåŠ¡ç«¯é“¾è·¯ç»†èŠ‚ï¼ŒåŒ…å«äº†æœåŠ¡ç«¯é“¾è·¯é‡‡é›†çš„æ ‡ç­¾å’Œæ—¥å¿—ï¼ˆäº‹ä»¶ï¼‰ç­‰ä¿¡æ¯ã€‚\npropagationå…¼å®¹jaegeræ•ˆæœï¼Œä¿è¯jaegerä¾§é“¾è·¯å®Œæ•´ï¼Œä½¿ç”¨ä¸€è‡´çš„ traceIdæ£€ç´¢ã€‚å› ä¸ºæœåŠ¡ä¾§ sentry æ˜¯æ¸è¿›æ›´æ–°çš„ï¼Œå› æ­¤æ²¡æœ‰æ¥å…¥çš„åº”ç”¨å¹¶ä¸ä¼šå±•ç¤ºåœ¨sentryä¾§ï¼Œ ç­‰åˆ°å®Œå…¨æ›´æ–°åå°±ä¼šå®Œæ•´ã€‚\nèƒŒæ™¯ # ç›®å‰è¿è¡Œä¸­çš„é“¾è·¯è¿½è¸ªç»„ä»¶æ˜¯é‡‡ç”¨ opentracing + jaeger å®ç°ï¼Œè¿™å¥—æ–¹æ¡ˆå”¯äºŒçš„ä¸è¶³å°±æ˜¯ï¼š\nopentracing å·²ç»è¢« opentelemetry å…¼å®¹ï¼Œä¸” opentelemetry åœ¨å¯è§‚æµ‹æ€§ä¸Šæ›´å…¨é¢ï¼Œæ›´çµæ´»ã€‚ æµè§ˆå™¨ä¾§æ”¯æŒä¸å®Œå–„ï¼ˆå¯ä»¥å‚è§ https://github.com/jaegertracing/jaeger-client-javascript ï¼‰ã€æ°æ°æˆ‘å¸æœ‰è¿™æ–¹é¢çš„éœ€æ±‚ ğŸ¤ªã€‘ã€‚ å‰ç«¯é‡‡ç”¨ sentry æ¥é‡‡é›†å‰ç«¯é¡µé¢æ•°æ®ï¼ˆAPP + WEB éƒ½æ”¯æŒå¾ˆå¥½ï¼‰ï¼Œå› æ­¤æ‰æœ‰äº†è¿™ä¹ˆä¸€ä¸ª å‰åç«¯é“¾è·¯æ‰“é€šçš„éœ€æ±‚ã€‚\nç»è¿‡è°ƒç ”ï¼Œæˆ‘å‘ç° sentry ä¹Ÿå¹¶ä¸å®Œç¾ï¼Œè¯¦æƒ…å‚è§ é™„å½•/sentryä½œä¸ºé“¾è·¯é‡‡é›†ç»„ä»¶çš„ä¼˜ç¼ºç‚¹\næœ€å¼€å§‹çš„éœ€æ±‚ç›®æ ‡æ˜¯åç«¯ç›¸å…³ Tracing SDK å…¨éƒ¨ä½¿ç”¨sentryæ›¿æ¢ï¼Œä½†æ˜¯ç»“åˆä¸Šè¿°å¯¹äºsentryçš„è°ƒç ”ï¼Œå‘ç°ç›´æ¥æ¥å…¥sentryå¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ï¼š\nç›¸å…³çš„ Tracing æ¦‚å¿µæ²¡æœ‰è¢«æˆ‘ä¸ªäººå’Œç¤¾åŒºæ¥å—ï¼Œç¤¾åŒºå†…ä¸»æµçš„è¿˜æ˜¯ OpenTracing å’Œ OpenTeletemetry è§„èŒƒï¼Œè€Œä¸”è¿™ä¸¤ä¸ªè§„èŒƒéƒ½æ˜¯ç›¸äº’å…¼å®¹çš„ï¼ˆä¸ªäººè®¤ä¸ºï¼šOpenTelemetry å¤§æœ‰ä¸€ç»Ÿå¯è§‚æµ‹æ€§çš„è¶‹åŠ¿ï¼Œä»–ä»¬ç«‹é¡¹ä¹Ÿæ˜¯æœç€è¿™ä¸ªæ–¹å‘å‰è¿›ï¼‰ã€‚ å®˜æ–¹go-SDKæ´»è·ƒåº¦ä½ä¹æƒ³è±¡ï¼Œå‚è§ https://github.com/getsentry/sentry-go/issues/387 æˆªæ­¢æœ¬æ–‡æ—¶ï¼ˆsince 2021-10-22ï¼‰ä»ç„¶æ²¡æœ‰ä»»ä½•å›å¤ï¼Œè¿›ä¸€æ­¥é˜»æ­¢æˆ‘ç›´æ¥ä½¿ç”¨sentryã€‚ è°ƒç ” OpenTelemetry åœ¨ç ”ç©¶å®ƒçš„æ¶æ„è®¾è®¡æ—¶ï¼Œå‘ç°å…¶è®¾è®¡ä¸­åŒ…å«äº†ä¸€ä¸ª Collectorï¼ˆè¯¦ç»†ä»‹ç»å‚è§ é™„å½•/OpenTelemetryä¸­çš„æ¦‚å¿µï¼‰ ã€‚ä»ç¤ºæ„å›¾æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œå®ƒçš„ä½œç”¨è¿‘ä¼¼äº Jaeger Collector / Agentï¼Œä½†æ˜¯ç›¸æ¯”äº Jaeger å®ƒæ›´å¼€æ”¾ï¼Œæ”¯æŒå¤šç§ Vendor (Jaeger / Zipkin ç­‰ç­‰)ï¼Œæ›´åŠ çµæ´»ã€‚ å¦‚æœæ›¿æ¢äº† sentry åŠ å…¥æ˜¯ä¸æ˜¯ä»¥åè¿˜å¯èƒ½æ›´æ¢æ–°çš„é‡‡é›†ç»„ä»¶ï¼ŒæœåŠ¡è¿™ä¹ˆå¤šå†æ¥æ¢ä¸€éè¿˜æ˜¯è´¹æ—¶è´¹åŠ› æ–¹æ¡ˆæè¿° # é‚£ä¹ˆåŸºäºä»¥ä¸Šçš„è€ƒè™‘ï¼Œè®¾è®¡äº†å¦‚ä¸‹çš„æ”¹é€ æ–¹æ¡ˆï¼ˆä¹Ÿå¯ä»¥ç†è§£ä¸ºæ–°çš„å®æ–½æ–¹æ¡ˆï¼Œæ¯•ç«Ÿå‡ºäº†å…¼å®¹ä¹Ÿä¸ä¼šè€ƒè™‘ä»¥å‰æ€ä¹ˆç”¨çš„ğŸ¤ªï¼‰ï¼š\nåœ¨åº”ç”¨ä¾§ Tracing SDK å…¨éƒ¨æ›¿æ¢ä¸º otel SDKï¼ˆåé¢ç»è¿‡è€ƒè™‘ï¼Œè¿˜æ˜¯è‡ªå·±åšäº†ä¸€ä¸ªé˜²è…çš„ Tracing APIå°è£…ï¼‰ã€‚ ä¸ºäº†ä¿è¯æ¸è¿›æ›´æ–°æœåŠ¡ç«¯é“¾è·¯é‡‡é›†çš„åŒæ—¶ï¼Œåœ¨Jaeger Dashboradä¸­çš„é“¾è·¯ä¸æ–­ï¼Œåœ¨ propagator å®ç° otel åˆ° jaeger çš„è½¬æ¢ã€‚ è‡ªå·±å®ç°ä¸€ä¸ª Sentry Trace Exporter, å°†å®¢æˆ·ç«¯ä¸ŠæŠ¥çš„é“¾è·¯ï¼Œå†æŠ•é€’åˆ° sentryã€‚ Collector é…ç½® exporter æ—¶ï¼ŒåŒæ—¶ä¸ŠæŠ¥åˆ° sentry å’Œ jaeger ç›¸åº”çš„å®è·µï¼Œæˆ‘å·²ç»æ”¾äº†ä¸€ä»½åœ¨ github ä¸Šï¼Œè¯·æŸ¥çœ‹ï¼šhttps://github.com/yeqown/opentelemetry-quake\næœŸé—´é‡åˆ°çš„é—®é¢˜ # æ€ä¹ˆè°ƒç ”ï¼Œäº§å‡ºæ–¹æ¡ˆï¼Ÿ\nåˆšå¼€å§‹æ¥åˆ°éœ€æ±‚ï¼Œæˆ‘ç¬¬ä¸€æ—¶é—´åœ¨è´¨ç–‘éœ€æ±‚çš„å¿…è¦æ€§ï¼Œç°åœ¨çš„é“¾è·¯é‡‡é›†å¥½å¥½çš„ä¸ºå•¥éè¦æ¢æˆå¦ä¸€ç§ï¼Ÿä¹Ÿæ²¡æœ‰å¥½çš„æƒ³æ³•ï¼Œæ¯•ç«Ÿå¯¹äº sentry å’Œ opentelemetry è®¤çŸ¥éƒ½ä¸å¤Ÿã€‚é€šè¿‡æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œå°¤å…¶æ˜¯ opentelemetry çš„è®¾è®¡ï¼Œæ‰æ‰¾åˆ°äº†è¿™ä¹ˆä¸€ä¸ªç°é˜¶æ®µå¾ˆæ»¡æ„çš„è§£å†³æ–¹æ¡ˆã€‚\nè°ƒç ” = å¤šçœ‹æ–‡æ¡£å’Œåˆ«äººçš„æœ€ä½³å®è·µã€‚åªæœ‰ä½ äº†è§£å¤Ÿå¤šï¼Œä½ æ‰èƒ½ç«™å¾—æ›´é«˜ï¼Œæ›´å®¹æ˜“è€ƒè™‘é—®é¢˜ã€‚\næ–¹æ¡ˆ = ä½ éœ€è¦çš„æ˜¯ä»€ä¹ˆï¼Œå°±ç”¨ç°æˆçš„å·¥å…·æ¥ç»„åˆï¼Œå¦‚æœå®åœ¨æ²¡æœ‰é‚£ä¹ˆæ˜¯ä¸æ˜¯å¯ä»¥è‡ªå·±å®ç°ï¼Ÿ\næ€ä¹ˆå®šåˆ¶è‡ªå·±çš„ Trace Exporterï¼Ÿ\nä¸»è¦è¿˜æ˜¯å‚è€ƒ https://github.com/open-telemetry/opentelemetry-collector-contrib ä»“åº“ä¸­çš„å®ç°ã€‚Collector è®¾è®¡æ—¶å·²ç»è€ƒè™‘äº†ç”¨æˆ·è‡ªå®šä¹‰ï¼Œæ‰€ä»¥æŒ‰ç…§å®˜æ–¹çš„çº¦å®šå¼€å‘å³å¯ï¼Œè‡³äº sentryexporter åœ¨å®˜æ–¹ä»“åº“å·²ç»å­˜åœ¨äº†ï¼Œæ‰€ä»¥æˆ‘åªæ˜¯å®šåˆ¶åŒ–äº†ä¸€ä¸‹ã€‚ï¼ˆä¸ºäº†åŠ æ·±ç†è§£ï¼Œæˆ‘å…¶å®åˆä»å¤´æ’¸äº†ä¸€é ğŸ¤“ï¼‰\nè¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä½ çš„collectoréœ€è¦ä½¿ç”¨ç‰¹å®šçš„æ’ä»¶ï¼Œé‚£ä¹ˆéœ€è¦ä½¿ç”¨å®˜æ–¹çš„ github.com/open-telemetry/opentelemetry-collector/cmd/builder æ¥è‡ªå·±å®šåˆ¶ç¼–è¯‘ collector, è¿™ä¸€ç‚¹ä¹Ÿå¯ä»¥åœ¨æˆ‘æä¾›çš„å®è·µä»£ç ä¸­æ‰¾åˆ°ã€‚\nCollector å’Œ Agent çš„å·®å¼‚ï¼Ÿ\nå¯ä»¥ç®€å•ç†è§£ä¸ºï¼šä¸­å¿ƒåŒ–å’Œåˆ†å¸ƒå¼éƒ¨ç½²çš„åŒºåˆ«ï¼Œåœ¨å®ç°ä¸Šå¹¶æ²¡æœ‰åŒºåˆ«ã€‚è‡³äºä½ åº”è¯¥ä½¿ç”¨å“ªç§éƒ¨ç½²æ–¹å¼ï¼Œå½“ç„¶è§†ä½ çš„é›†ç¾¤è§„æ¨¡è€Œå®šï¼Œå¦‚æœåªæœ‰ä¸åˆ°100ä¸ªæœåŠ¡å®ä¾‹ï¼Œä¸ªäººè§‰å¾—ä»…ä»…collectorè¶³ä»¥ï¼Œç›´åˆ°ä¸è¶³ä»¥æ‰¿è½½ã€‚åä¹‹ï¼Œå¦‚æœä½ é›†ç¾¤ä¸­èŠ‚ç‚¹ä¼—å¤šï¼ŒæœåŠ¡å®ä¾‹ä¹Ÿä¼—å¤šï¼Œé‚£ä¹ˆæœ€å¥½ä¸€å¼€å§‹å°±ä¸Šagentã€‚\nk8s ä¸­å¦‚ä½•ä»¥ agent æ–¹å¼éƒ¨ç½² collectorï¼Ÿ\nå®˜æ–¹ä¹Ÿå·²ç»æä¾›äº†æ ·ä¾‹ä»£ç ï¼Œå¯ä»¥å‚è€ƒ github.com/open-telemetry/opentelemetry-collector/examples/k8s/otel-config.yamlã€‚å¤§è‡´æ€è·¯ä¸ºï¼šé€šè¿‡DaemonSet åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ª Collector å®ä¾‹ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæƒ³è¦é…ç½® NODE_IP:PORT çš„æ–¹å¼è®©è¯¥èŠ‚ç‚¹ä¸Šçš„æœåŠ¡ç›´è¿ agentï¼Œé‚£ä¹ˆéœ€è¦åœ¨ otel-config.yaml ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š\napiVersion: apps/v1 # .... template: metadata: labels: app: opentelemetry component: otel-agent spec: hostNetwork: true # å¢åŠ è¿™ä¸€è¡Œ dnsPolicy: ClusterFirstWithHostNet # å¢åŠ è¿™ä¸€è¡Œ containers: # ... å½“ç„¶ä¸æ­¢è¿™ä¹ˆä¸€ç§æ–¹å¼ï¼Œæ¯”å¦‚è¿˜å¯ä»¥ä½¿ç”¨ hostPort, è§†ä½ çš„k8sé›†ç¾¤é…ç½®è€Œå®šã€‚\né™„å½• # sentryä½œä¸ºé“¾è·¯é‡‡é›†ç»„ä»¶çš„ä¼˜ç¼ºç‚¹ # ä»…ä»£è¡¨ä¸ªäººçœ‹æ³•ï¼Œå¯èƒ½å¯¹äº sentry ç†è§£ä¸åˆ°ä½ï¼Œè¯·è‡ªè¡ŒæŒ‰ç…§è‡ªå·±çš„ç†è§£æ¥çœ‹ã€‚\nç¼ºç‚¹:\nsentry çš„ä¸»è¦åœºæ™¯å¹¶ä¸æ˜¯åœ¨äºé“¾è·¯é‡‡é›†ï¼Œè€Œæ˜¯åœ¨äºå‰ç«¯é¡µé¢é‡‡é›†ï¼ˆé¡µé¢åŠ è½½/è·¯å¾„/æ—¥å¿—ï¼‰ï¼ŒåŒ…æ‹¬é¡µé¢å¼‚å¸¸æ•°æ®ï¼›ä¸»è¦æ ¹æ®åœ¨äºå®ƒç‹¬æœ‰ï¼ˆæˆ–è®¸ï¼‰çš„é“¾è·¯é‡‡é›†æ¦‚å¿µã€‚å…¶ä¸­å¸¸è§çš„å¦‚ä¸‹ï¼š\næ¦‚å¿µ å®šä¹‰ OpenTracingä¸­çš„æ˜ å°„ å­˜åœ¨çš„é—®é¢˜ Trace å¯ä»¥é€šè¿‡ TraceId æ ‡è¯†çš„ä¸€æ¡é“¾è·¯ Trace å‰ç«¯ Trace/Page ä¸ Trace/Req å‡ºå…¥ Span å¯ä»¥é€šè¿‡ SpanId æ ‡è¯†çš„ä¸€ä¸ªå•å…ƒ Span - Trasnaction Trace åœ¨è¿›ç¨‹å†… Span çš„é›†åˆ - ç‹¬æœ‰çš„æ¦‚å¿µ Scope Trace çš„ä¸Šä¸‹æ–‡ (åŒ…å«ç”¨æˆ·ï¼ŒRequestç­‰) åªèƒ½ç”¨ SpanContext ã€å¹¶ä¸å‡†ç¡®ã€‘ ç›¸æ¯” SpanContext åŒ…å«çš„ä¿¡æ¯è¿‡äºå¤ªå¤šäº† Hub åº”ç”¨ä¾§ Tracer Tracer - ä¸ªäººè§‰å¾—ï¼Œæ­£æ˜¯ sentry è‡ªå·±çš„å®šä½å¹¶ä¸ç€é‡äºåç«¯æœåŠ¡çš„é“¾è·¯é‡‡é›†ï¼Œæ‰ä¼šå¦‚æ­¤è®¾è®¡ã€‚\nä¼˜ç‚¹:\nå·²ç»æ”¯æŒå‰åç«¯é“¾è·¯æ‰“é€šï¼Œé›†æˆå±•ç¤ºå‰ç«¯é¡µé¢ä¸Šå‘ç”Ÿçš„ä¸€åˆ‡è¡Œä¸ºã€‚ å•ç‹¬å¯¹å¼‚å¸¸è¿›è¡Œé‡‡é›†å’Œå±•ç¤ºã€‚ OpenTelemetryä¸­çš„æ¦‚å¿µ # é“¾è·¯é‡‡é›†åŸºæœ¬çš„æ¦‚å¿µå°±ä¸å¤šä»‹ç»äº†ï¼Œäº†è§£è¿‡ OpenTracing ä¹‹åï¼Œä¼šå‘ç°å¤§åŒå°å¼‚\nè¿™é‡Œåªæ˜¯ç½—åˆ—äº† Tracing ç›¸å…³çš„æ¦‚å¿µï¼š\næ¦‚å¿µ å®šä¹‰ åŠŸèƒ½ TracerProvider Tracer æ³¨å†Œä¸­å¿ƒ å¯ä»¥ç”¨äºåŒºåˆ†ä¸åŒ Lib Propagator è´Ÿè´£è§£æå’Œæ³¨å…¥ trace header è·¨è¿›ç¨‹ä¼ é€’ otel SDK OpenTelemetry å®¢æˆ·ç«¯ SDK è¯­è¨€ç›¸å…³çš„APIï¼Œè´Ÿè´£é“¾è·¯çš„é‡‡é›†å’Œä¸ŠæŠ¥ otel Collector é“¾è·¯é‡‡é›†åç«¯ç»„ä»¶ æ”¶é›†å®¢æˆ·ç«¯ä¸ŠæŠ¥çš„é“¾è·¯ä¿¡æ¯ otel Agent ä¸Collectorç›¸åŒï¼Œåªæ˜¯ä»¥Agentæ¨¡å¼éƒ¨ç½² k8s ä¸­é‡‡ç”¨ DaemonSet éƒ¨ç½²æ–¹å¼ï¼Œå¢åŠ éƒ¨ç½²å®¹é”™èƒ½åŠ›ï¼Œå‡å°‘ä¸ŠæŠ¥æ—¶å»¶ Exporter (Span) SDK å¤„ç† span çš„ç»„ä»¶ ç”¨äºå®¢æˆ·ç«¯è‡ªå®šä¹‰spanæ•°æ®åŠ å·¥å¤„ç†ï¼ˆå¦‚å®¢æˆ·ç«¯ç›´æ¥ä¸ŠæŠ¥é“¾è·¯åˆ°Vendorï¼‰ Exporter (Trace) Collector ä¸­å¤„ç†Traceçš„ç»„ä»¶ ä¸ Span Exporter ç±»ä¼¼ï¼Œä½†å·¥ä½œåœ¨ Collector ä¸­ï¼Œå¤„ç†è¢« Collector æ”¶é›†å½’çº³çš„é“¾è·¯æ•°æ® Reciever Collector ä¸­å¤„ç†Traceçš„ç»„ä»¶ ä¸ Span Exporter ç±»ä¼¼ï¼Œä½†å·¥ä½œåœ¨ Collector ä¸­ï¼Œå¤„ç†è¢« Collector æ”¶é›†å½’çº³çš„é“¾è·¯æ•°æ® å‰æ–‡æåˆ°çš„ OpenTelemetry çš„å¼€æ”¾èƒ½åŠ›ï¼Œä» Collector å’Œ Exporter ä¹Ÿèƒ½çœ‹å¾—å‡ºæ¥ã€‚\næ€»ç»“ # å¯¹äº sentry å¹¶æ²¡æœ‰è¿‡å¤šçš„ä»‹ç»ï¼Œå› ä¸ºä»åç«¯çš„è§’åº¦çœ‹è¿‡å»ï¼Œé€šè¿‡æ”¹é€ æ–¹æ¡ˆè®¾è®¡ï¼Œsentry å°±åªæ˜¯å…¶ä¸­çš„ä¸€ç§ vendor è€Œå·²ï¼Œå¹¶ä¸ä¼šå¯¹æˆ‘ä»¬çš„é“¾è·¯é‡‡é›†äº§ç”Ÿå½±å“ã€‚å°±ç®—ä»¥åå‰ç«¯æƒ³è¦è¯•éªŒå¦ä¸€ç§æ–¹æ¡ˆï¼Œé‚£æˆ‘ä»¬ä¹Ÿåªéœ€è¦æ”¯æŒå¤šä¸€ç§ vendor å³å¯ã€‚å¼ºçƒˆå»ºè®®äº†è§£ OpenTelemetry çš„ç›¸å…³æ¦‚å¿µï¼Œä»¥åä¸€å®šç”¨å¾—ä¸Šã€‚\næ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿å‹˜è¯¯æŒ‡æ­£ğŸ™ã€‚\nå‚è€ƒ # https://opentelemetry.io/ https://sentry.io/ https://github.com/yeqown/opentelemetry-quake "},{"id":24,"href":"/2020/09/27/WebSocket-Implemention-With-Go/","title":"WebSocket Implemention With Go","section":"Posts","content":" ä»€ä¹ˆæ˜¯WSåè®® # The WebSocket Protocol enables two-way communication between a client running untrusted code in a controlled environment to a remote host that has opted-in to communications from that code. The security model used for this is the origin-based security model commonly used by web browsers. The protocol consists of an opening handshake followed by basic message framing, layered over TCP.\nThe goal of this technology is to provide a mechanism for browser-based applications that need two-way communication with servers that does not rely on opening multiple HTTP connections (e.g., using XMLHttpRequest or \u0026lt;iframe\u0026gt;s and long.polling). - æ‘˜è‡ª RFC6455 Abstract.\nç”¨å¤§ç™½è¯å°±æ˜¯ï¼š â€œåŸºäºTCPä¼ è¾“åè®®æ„å»ºçš„å…¨åŒå·¥ï¼Œç”¨äºWebæµè§ˆå™¨å’ŒæœåŠ¡ç«¯è¿›è¡Œé€šä¿¡çš„åº”ç”¨å±‚åè®®â€ã€‚é‚£ä¹ˆåŒå±äºåº”ç”¨å±‚åè®®ï¼ŒWebSocketå’ŒHTTPä¹‹é—´æœ‰ä½•å¼‚åŒï¼Ÿ\nç‰¹ç‚¹ HTTP WebSocket OSI Layer 7 7 é€šä¿¡æ¨¡å¼ å•å·¥/åŠåŒå·¥/å…¨åŒå·¥ï¼Œå–å†³äºHTTPç‰ˆæœ¬ å…¨åŒå·¥ å·¥ä½œç«¯å£ 80/443 80/443ä½œä¸ºé»˜è®¤ï¼Œä½†ä¸é™äº æ˜¯å¦æ”¯æŒSSL æ˜¯ æ˜¯ ä¼ è¾“åè®® TCP TCP æ•°æ®æ ¼å¼ JSON / TEXT / Binary Stream ç­‰ JSON / TEXT / Binary Stream ç­‰ åè®®Schema http/https ws/wss æœ€æ–°ç‰ˆæœ¬ 3 13 ä¸ºä»€ä¹ˆè¦ç”¨WSåè®® # æƒ³ä¸€ä¸‹ï¼Œè‡ªå·±ä¼šåœ¨ä»€ä¹ˆåœºæ™¯ä¸‹è€ƒè™‘WebSocketè€Œä¸æ˜¯HTTPåè®®å°±æ˜ç™½äº†ã€‚åœ¨æ²¡æœ‰ WebSocket ä¹‹å‰ï¼Œäº†å®ç°å³æ—¶é€šä¿¡æœ‰ä»¥ä¸‹å‡ ç§æ–¹æ¡ˆï¼š\nShort Polling Long Polling Streaming SSE (Server Sent Event) è¿™éƒ¨åˆ†çš„æ¼”è¿›å¯ä»¥é˜…è¯» https://halfrost.com/websocket/ æœ¬æ–‡ä¹Ÿå¤šæœ‰å‚è€ƒã€‚\nå®ç° # æœ¬æ–‡çš„ä¸»è¦ç›®æ ‡æ˜¯ä¸ºäº†ä»‹ç»å¦‚ä½•ä½¿ç”¨Goå®ç°WebSocketåè®®ï¼Œå› æ­¤æœ€å¥½æ˜¯å…·å¤‡ä»¥ä¸‹èƒ½åŠ›ï¼š\nä¼šä½¿ç”¨ Wireshark æˆ–è€… tcpdump ç†Ÿç»ƒä½¿ç”¨ Go è¯­è¨€å¼€å‘ èƒ½è¯»æ‡‚RFC6455çš„è‹±è¯­èƒ½åŠ›ï¼Œå½“ç„¶ä½ ç”¨ç¿»è¯‘ä¹Ÿå¯ä»¥ï¼Œè‡³å°‘åˆ«å› ä¸ºç¿»è¯‘é”™è¯¯è€Œæ— æ³•ç»§ç»­ï½ å¯¹TCPæœ‰ä¸€å®šç†è§£ é˜…è¯»RFC6455ï¼Œé˜…è¯»RFC6455ï¼Œé˜…è¯»RFC6455ï¼ï¼ï¼ è¿™æ˜¯ä¸€åˆ‡çš„èµ·ç‚¹ï¼Œæ²¡å¿…è¦æ€¥äºåŠ¨æ‰‹ã€‚\n1. ç†è§£WebSocketçš„åè®®å¸§å’Œå·¥ä½œæµç¨‹ # æ•´ä½“æµç¨‹ï¼š\næ—¶åºå›¾ï¼š\nåè®®å¸§ï¼š\nåè®®å¸§ æ˜¯æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œç†è§£äº†åè®®å¸§å°±ç›¸å½“äºå®Œæˆäº†50%ï¼Œä½™ä¸‹çš„å°±æ˜¯æ’¸ä»£ç äº†\u0026hellip; åè®®å¸§ä¸»è¦åŒ…æ‹¬äº†ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š\nå¤´éƒ¨ FIN [1bit] æŒ‡ç¤ºè¯¥å¸§æ˜¯ä¸æ˜¯æ¶ˆæ¯åˆ†ç‰‡çš„æœ€åä¸€å¸§ã€‚åˆ†ç‰‡-ä¼ é€é—¨ RSV ä¿ç•™ä½ [3bit] MASK æ˜¯å¦ä½¿ç”¨æ©ç  [1bit] PAYLOAD LEN æ•°æ®éƒ¨åˆ†çš„é•¿åº¦ [7bit] å¦‚æœç­‰äº 126/127ï¼ˆ7bit=128-1ï¼‰åˆ™è¯´æ˜å¯ç”¨ PAYLOAD LEN EXTï¼ˆ1/2ï¼‰ éƒ¨åˆ†æ¥è¡¨æ˜æ•°æ®éƒ¨åˆ†çš„é•¿åº¦ã€‚ PAYLOAD LEN EXT ä»…å½“ PAYLOAD LEN æ— æ³•è¡¨ç¤ºæ•°æ®éƒ¨åˆ†çš„é•¿åº¦æ—¶å¯ç”¨ [16bit/64bit] MASKING KEY æ©ç  [0/32bit] å–å†³æ˜¯MASKæ˜¯å¦è®¾ç½®ã€‚æ©ç -ä¼ é€ä»¬ æ•°æ®, é•¿åº¦ç­‰äº Payload Lenæˆ–è€…Payload Len Extï¼Œè¯·å¿½ç•¥å›¾ä¸­ä¸€ä¸ªbitä¸€ä¸ªå­—ç¬¦\u0026hellip; å¦‚æœè®¤çœŸçœ‹å›¾çš„è¯å’Œçœ‹è¿‡RFC6455ä¹‹åï¼Œä½ å°±ä¼šå‘ç°æ•°æ®éƒ¨åˆ†çš„çœŸå®é•¿åº¦ï¼Œå…¶å®åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š\nPayload Len çš„å€¼ï¼Œå°äº 126æ—¶ï¼Œæ²¡æœ‰æ‰©å±•çš„Payload Len Extéƒ¨åˆ†ï¼Œå€¼æœ¬èº«è¡¨è¾¾æ•°æ®éƒ¨åˆ†çš„é•¿åº¦ Payload Len çš„å€¼ï¼Œç­‰äº 126æ—¶ï¼ŒPayload Len Ext1 å¯ç”¨ï¼Œé•¿åº¦16bit Payload Len çš„å€¼ï¼Œç­‰äº 127æ—¶ï¼ŒPayload Len Ext2 å¯ç”¨ï¼Œé•¿åº¦64bit 2. åè®®å¸§frameçš„åŸºæœ¬å¤„ç† # çœ‹è¿‡åè®®å¸§ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ•°æ®å¸§çš„å¤„ç†ï¼Œè¿™éƒ¨åˆ†éœ€è¦çš„å°±æ˜¯ç¼–ç çŸ¥è¯†äº†ã€‚é‚£ä¹ˆåœ¨Goé‡Œé¢å¦‚ä½•å»è¡¨è¾¾ä¸€ä¸ªå¸§å‘¢ï¼Ÿä¸€ä¸ªå¸§åœ¨TCPçœ¼é‡Œå°±æ˜¯å­—èŠ‚æµï¼Œå‘é€çš„æ—¶å€™æ˜¯ï¼Œæ¥æ”¶çš„æ—¶å€™ä¹Ÿæ˜¯ï¼Œå› æ­¤å¸§çš„ä¸»è¦å·¥ä½œå°±æ˜¯ï¼šå°†åè®®æ•°æ®æŒ‰ç…§æŒ‡å®šçš„æ ¼å¼å¡åˆ°å­—èŠ‚æµé‡Œé¢å»ï¼Œäº¦æˆ–è€…æ˜¯ä»å­—èŠ‚æµä¸­è§£æåˆ°æˆ‘ä»¬ç”¨äºè¡¨è¾¾çš„æ•°æ®ç»“æ„ä¸­å»ã€‚å°±åƒä¸€ä¸ªç¿»è¯‘å®˜ï¼ŒæŒ‰ç…§ç‰¹å®šçš„è¯­æ³•æ¥å›ç¿»è¯‘ã€‚\n// Frame è¿™é‡Œä½¿ç”¨uint16æ¥æ‰¿è½½ï¼Œåªæ˜¯å› ä¸ºç»Ÿä¸€ï¼Œæ–¹ä¾¿è®¡ç®—ç§»ä½ï¼Œå› ä¸ºæ•´ä¸ªå¤´éƒ¨æœ€é‡è¦çš„éƒ¨åˆ†å°±æ˜¯16bitçš„é•¿åº¦ã€‚ type Frame struct { Fin uint16 // 1 bit RSV1 uint16 // 1 bit, 0 RSV2 uint16 // 1 bit, 0 RSV3 uint16 // 1 bit, 0 OpCode OpCode // 4 bits Mask uint16 // 1 bit // Payload length: 7 bits, 7+16 bits, or 7+64 bits // // if PayloadLen = 0 - 125, actual_payload_length = PayloadLen // if PayloadLen = 126, actual_payload_length = PayloadExtendLen[:16] // if PayloadLen = 127, actual_payload_length = PayloadExtendLen[:] PayloadLen uint16 // 7 bits PayloadExtendLen uint64 // 64 bits MaskingKey uint32 // 32 bits Payload []byte // no limit by RFC6455 } ç¿»è¯‘çš„éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š\nè¿™é‡Œå¯¹äº â€œå¤§å°ç«¯åºâ€ æ²¡æœ‰æ¦‚å¿µçš„ï¼Œå¯ä»¥å…ˆè‡ªè¡ŒæŸ¥é˜…èµ„æ–™ã€‚\n// å°†å¸§ç¿»è¯‘åˆ°å­—èŠ‚æµ func encodeFrameTo(frm *Frame) []byte { buf := make([]byte, 2, minFrameHeaderSize+8) var ( part1 uint16 // from FIN to PayloadLen ) part1 |= frm.Fin \u0026lt;\u0026lt; finOffset part1 |= frm.RSV1 \u0026lt;\u0026lt; rsv1Offset part1 |= frm.RSV2 \u0026lt;\u0026lt; rsv2Offset part1 |= frm.RSV3 \u0026lt;\u0026lt; rsv3Offset part1 |= uint16(frm.OpCode) \u0026lt;\u0026lt; opcodeOffset part1 |= frm.Mask \u0026lt;\u0026lt; maskOffset part1 |= frm.PayloadLen \u0026lt;\u0026lt; payloadLenOffset // start from 0th byte // fill part1 into 2 byte binary.BigEndian.PutUint16(buf[:2], part1) // FIXED: fill payloadExtendLen into 8 byte switch frm.PayloadLen { case 126: payloadExtendBuf := make([]byte, 2) binary.BigEndian.PutUint16(payloadExtendBuf[:2], uint16(frm.PayloadExtendLen)) buf = append(buf, payloadExtendBuf...) case 127: payloadExtendBuf := make([]byte, 8) binary.BigEndian.PutUint64(payloadExtendBuf[:8], frm.PayloadExtendLen) buf = append(buf, payloadExtendBuf...) } // FIXED: if not mask, then no set masking key if frm.Mask == 1 { // fill fmtMaskingKey into 4 byte maskingKeyBuf := make([]byte, 4) binary.BigEndian.PutUint32(maskingKeyBuf[:4], frm.MaskingKey) buf = append(buf, maskingKeyBuf...) } // header done, start writing body buf = append(buf, frm.Payload...) return buf } // è§£æå¸§çš„å¤´éƒ¨ï¼ˆ16bitï¼‰ä¿¡æ¯ï¼Œå› ä¸ºWebSocketåè®®å¸§ä¸­ï¼šPayloadLen æ˜¯å˜é•¿ï¼Œ // MaskingKey ä¹Ÿæ˜¯æœ‰æˆ–è€…æ²¡æœ‰ï¼Œä½†æ˜¯éƒ½å¯ä»¥é€šè¿‡16bitçš„æ•°æ®æ¥è·å¾—å‡†ç¡®çš„ç»“æœã€‚ // è§£æè¿‡ç¨‹ä¹Ÿå°±æ˜¯å†™å…¥çš„é€†å‘æ“ä½œã€‚ func parseFrameHeader(header []byte) *Frame { var ( frm = new(Frame) part1 = binary.BigEndian.Uint16(header[:2]) ) frm.Fin = (part1 \u0026amp; finMask) \u0026gt;\u0026gt; finOffset frm.RSV1 = (part1 \u0026amp; rsv1Mask) \u0026gt;\u0026gt; rsv1Offset frm.RSV2 = (part1 \u0026amp; rsv2Mask) \u0026gt;\u0026gt; rsv2Offset frm.RSV3 = (part1 \u0026amp; rsv3Mask) \u0026gt;\u0026gt; rsv3Offset frm.OpCode = OpCode((part1 \u0026amp; opcodeMask) \u0026gt;\u0026gt; opcodeOffset) frm.Mask = (part1 \u0026amp; maskMask) \u0026gt;\u0026gt; maskOffset frm.PayloadLen = (part1 \u0026amp; payloadLenMask) \u0026gt;\u0026gt; payloadLenOffset return frm } 3. WebSocketé“¾æ¥çš„å®šä¹‰ # Conn æ˜¯å¯¹TCPé“¾æ¥çš„å°è£…å†é…åˆä¸Šåè®®ï¼Œæ¥å¯¹å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„æä¾›åŠŸèƒ½ã€‚å…¶ä¸­æˆ‘ä¸ªäººè§‰å¾—æœ€é‡è¦çš„åŠŸèƒ½æ˜¯ï¼šå¦‚ä½•ä»TCPå­—èŠ‚æµä¸­è¯»åˆ°ä¸€ä¸ªå®Œæ•´çš„WebSocketæ¶ˆæ¯ Conn.ReadMessage()ã€‚\ntype Conn struct { conn net.Conn // åº•å±‚TCPé“¾æ¥ bufRD *bufio.Reader // è¯» bufWR *bufio.Writer // å†™ // çœç•¥éƒ¨åˆ†ä¸æ˜¯ç‰¹åˆ«é‡è¦çš„å­—æ®µ } // æ„é€ websocket.Conn func newConn(netconn net.Conn, isServer bool) (*Conn, error) { c := Conn{ conn: netconn, bufRD: bufio.NewReaderSize(netconn, 65535), // 65535B = 64KB bufWR: bufio.NewWriter(netconn), } return \u0026amp;c, nil } // ReadMessage . it will block to read message func (c *Conn) ReadMessage() (mt MessageType, msg []byte, err error) { frm, err := c.readFrame() if err != nil { debugErrorf(\u0026#34;Conn.ReadMessage failed to c.readFrame, err=%v\u0026#34;, err) return NoFrame, nil, err } mt = MessageType(frm.OpCode) // æ ¹æ®è¯»åˆ°çš„å¸§åˆ¤æ–­æ˜¯å¦è¿˜æœ‰åç»­çš„å¸§ï¼Œå¦‚æœæœ‰åˆ†ç‰‡ï¼Œé‚£å°±è¯»å®Œå°†payloadç»„è£…åˆ°ä¸€èµ·ã€‚ buf := bytes.NewBuffer(nil) buf.Write(frm.Payload) for !frm.isFinal() { if frm, err = c.readFrame(); err != nil { debugErrorf(\u0026#34;Conn.ReadMessage failed to c.readFrame, err=%v\u0026#34;, err) return NoFrame, nil, err } buf.Write(frm.Payload) } msg = buf.Bytes() return } // ä»ç¼“å†²åŒºè¯»å–æŒ‡å®šå­—èŠ‚æ•°é‡çš„æ•°æ® func (c *Conn) read(n int) ([]byte, error) { p, err := c.bufRD.Peek(n) if err == io.EOF { err = ErrUnexpectedEOF return nil, err } _, _ = c.bufRD.Discard(len(p)) return p, err } func (c *Conn) readFrame() (*Frame, error) { // é˜»å¡åœ°è¯»2Byteçš„æ•°æ® p, err := c.read(2) if err != nil { debugErrorf(\u0026#34;Conn.readFrame failed to c.read(header), err=%v\u0026#34;, err) return nil, err } // è§£æWebSocketå¸§å¤´éƒ¨ frmWithoutPayload := parseFrameHeader(p) logger.Debugf(\u0026#34;Conn.readFrame got frmWithoutPayload=%+v\u0026#34;, frmWithoutPayload) var ( payloadExtendLen uint64 // this could be non exist remaining uint64 ) // æ ¹æ®PayloadLenæ¥è¯»å–ä¸åŒå­—èŠ‚æ•°çš„æ‰©å±•é•¿åº¦ // 126 -\u0026gt; 2B // 127 -\u0026gt; 8B switch frmWithoutPayload.PayloadLen { case 126: // has 16bit + 32bit = 6B p, err = c.read(2) if err != nil { debugErrorf(\u0026#34;Conn.readFrame failed to c.read(2) payloadlen with 16bit, err=%v\u0026#34;, err) return nil, err } payloadExtendLen = uint64(binary.BigEndian.Uint16(p[:2])) remaining = payloadExtendLen case 127: // has 64bit + 32bit = 12B p, err = c.read(8) if err != nil { debugErrorf(\u0026#34;Conn.readFrame failed to c.read(8) payloadlen with 16bit, err=%v\u0026#34;, err) return nil, err } payloadExtendLen = binary.BigEndian.Uint64(p[:8]) remaining = payloadExtendLen default: remaining = uint64(frmWithoutPayload.PayloadLen) } frmWithoutPayload.PayloadExtendLen = payloadExtendLen // get masking key if frmWithoutPayload.Mask == 1 { // only 32bit masking key to read p, err = c.read(4) if err != nil { debugErrorf(\u0026#34;Conn.readFrame failed to c.read(header), err=%v\u0026#34;, err) return nil, err } frmWithoutPayload.MaskingKey = binary.BigEndian.Uint32(p) } // çœç•¥frameæ ¡éªŒè¿‡ç¨‹ // è¯»å–payloadæ•°æ®å¹¶å¡«å……åˆ°frameä¸­å» var ( payload = make([]byte, 0, remaining) ) logger.Debugf(\u0026#34;Conn.readFrame c.read(%d) into payload data\u0026#34;, remaining) for remaining \u0026gt; 65535 { // true: bufio.Reader can read 65535 byte as most at once p, err := c.read(65535) if err != nil { debugErrorf(\u0026#34;Conn.readFrame failed to c.read(payload), err=%v\u0026#34;, err) return nil, err } payload = append(payload, p...) remaining -= 65535 } // è¯»å–å‰©ä½™éƒ¨åˆ†çš„payload p, err = c.read(int(remaining)) if err != nil { debugErrorf(\u0026#34;Conn.readFrame failed to c.read(payload), err=%v\u0026#34;, err) return nil, err } payload = append(payload, p...) frmWithoutPayload.setPayload(payload) // å¤„ç†ping pong close å¸§ switch frmWithoutPayload.OpCode { case opCodeText, opCodeBinary, opCodeContinuation: // pass case opCodePing: err = c.replyPing(frmWithoutPayload) case opCodePong: err = c.replyPong(frmWithoutPayload) case opCodeClose: err = c.handleClose(frmWithoutPayload) } return frmWithoutPayload, err } 4. æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„å®šä¹‰ # åˆ°è¿™ä¸€æ­¥ï¼Œå·²ç»æŠŠåº•å±‚çš„å·¥ä½œéƒ½å®Œæˆäº†ï¼šå®šä¹‰åè®®å¸§ï¼Œåè®®å¸§ç¿»è¯‘ï¼ŒConnçº¦å®šå’Œå°è£…ç­‰å·¥ä½œã€‚ç°åœ¨å¯ä»¥å¼€å§‹è®¾è®¡å’Œå®ç°é¡¶å±‚APIäº†ã€‚ æœåŠ¡ç«¯APIï¼Œæˆ‘å‚è€ƒäº†gorilla/websocketï¼Œå®šä¹‰äº†ä¸€ä¸ª Upgrader æ¥å°†HTTPå‡çº§åˆ° Websocketã€‚\n// Upgrader std.HTTP / fasthttp / gin etc type Upgrader struct { CheckOrigin func(req *http.Request) bool Timeout time.Duration } // å‡çº§åè®®ã€‚å¦‚æœé‡åˆ°äº†hijacké”™è¯¯ï¼Œå¯ä»¥çœ‹è¿™é‡Œçš„è¿æ¥ï¼Œå¸Œæœ›æœ‰æ‰€å¸®åŠ© // https://stackoverflow.com/questions/32657603/why-do-i-get-the-error-message-http-response-write-on-hijacked-connection // func (ug Upgrader) Upgrade(w http.ResponseWriter, req *http.Request, fn func(conn *Conn)) error { // è®¾ç½®è¶…æ—¶ä¸Šä¸‹æ–‡ ctx, cancel := context.WithTimeout(req.Context(), timeout) req = req.WithContext(ctx) defer cancel() // RFC6455 å®Œæˆæ¡æ‰‹æ£€æŸ¥ // almost checking is about headers if err := ug.handshakeCheck(w, req); err != nil { debugErrorf(\u0026#34;Upgrader.Upgrade failed to ug.handshakeCheck, err=%v\u0026#34;, err) return ug.returnError(w, http.StatusBadRequest, err.Error()) } // !!! é‡è¦ï¼Œè·å–HTTPå¯¹åº”çš„åº•å±‚TCPé“¾æ¥ h := w.(http.Hijacker) netconn, brw, err = .Hijack() if err != nil { debugErrorf(\u0026#34;Upgrader.Upgrade failed to h.Hijack, err=%v\u0026#34;, err) _ = ug.returnError(w, http.StatusInternalServerError, err.Error()) return nil } // çœç•¥è¯·æ±‚å¤´å¤„ç† ... // å‘é€HTTPå“åº” if err = hackHandshakeResponse(brw.Writer, respHeaders, \u0026#34;101\u0026#34;); err != nil { return err } // å¯åŠ¨ä¸€ä¸ªgoroutineæ¥å¤„ç†è¯¥é“¾æ¥çš„æ¶ˆæ¯ï¼ŒConnPool / Reactor çš„å®ç°ï¼Œå¯ä»¥åœ¨è¿™é‡Œè°ƒæ•´ conn, _ := newConn(netconn, true) go func() { defer func() { if err, ok := recover().(error); ok { logger.Errorf(\u0026#34;Upgrader.Upgrade fn panic: err=%v\u0026#34;, err) debug.PrintStack() } }() fn(conn) }() return nil } å®¢æˆ·ç«¯çš„è¯å°±æ›´ç®€å•äº†ï¼Œå»ºç«‹ä¸€ä¸ªTCPè¿æ¥ï¼Œå‘æœåŠ¡ç«¯å‘èµ·HTTPå‡çº§åˆ°Websocketçš„è¯·æ±‚ï¼Œç­‰æ¡æ‰‹é€šè¿‡é‚£ä¹ˆè¿æ¥å°±å»ºç«‹å®Œæˆäº†ï¼Œå°±å¯ä»¥å¯¹websocket.Connè¿›è¡Œè¯»å†™æ“ä½œäº†ã€‚\n5. å»ºé“¾å’Œæ¡æ‰‹ # åœ¨ä¸Šä¸€å°èŠ‚å·²ç»å¸¦è¿‡äº†è¿™éƒ¨åˆ†ï¼Œè¿™é‡Œé‡ç‚¹æƒ³è¦ä»‹ç»ä¸‹httpè¯·æ±‚åˆ°websocketçš„å‡çº§è¿‡ç¨‹ã€‚æœåŠ¡ç«¯ä¾‹å­å¦‚ä¸‹ï¼š\nfunc main() { http.HandleFunc(\u0026#34;/echo\u0026#34;, echo) if err := http.ListenAndServe(\u0026#34;:8080\u0026#34;, nil); err != nil { log.Fatal(err) } } func echo(w http.ResponseWriter, req *http.Request) { websocketHdl := func(conn *websocket.Conn) { for { // è¯»æ¶ˆæ¯ mt, message, err := conn.ReadMessage() // å‘é€æ¶ˆæ¯ err = conn.SendMessage(string(message)) } log.Info(\u0026#34;conn finished\u0026#34;) } // è°ƒç”¨ upgrader å‡çº§ï¼Œå¹¶è°ƒç”¨è¿æ¥å¤„ç†æ–¹æ³• - goroutine ä¿æŒ err := upgrader.Upgrade(w, req, websocketHdl) if err != nil { log.Errorf(\u0026#34;upgrade error, err=%v\u0026#34;, err) return } log.Infof(\u0026#34;conn upgrade done\u0026#34;) } ç”±ä¸Šè¿°ä»£ç æˆ‘ä»¬å¯ä»¥æ˜ç™½ï¼Œæ‰€è°“çš„å‡çº§è¿‡ç¨‹æ˜¯ä½¿ç”¨HTTPåè®®æ¥å®Œæˆï¼Œå¯¹äºæœåŠ¡ç«¯æ›´å‹å¥½ï¼Œå¾ˆå®¹æ˜“åœ¨ç°æœ‰çš„HTTPæœåŠ¡ä¸­åŠ ä¸Šä¸€ä¸ªWebSocketæœåŠ¡ã€‚æ¡æ‰‹ - ä¼ é€é—¨ã€‚ç”¨å¤§ç™½è¯æè¿°å°±æ˜¯ï¼š\nå®¢æˆ·ç«¯é€šè¿‡ schema://host:port/path/to/websocket è¿™æ ·ä¸€ä¸ªåœ°å€æ‰¾åˆ°æœåŠ¡ç«¯ [å»ºç«‹TCPè¿æ¥] å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ªHTTPè¯·æ±‚ï¼ˆæºå¸¦ç‰¹æ®Šçš„è¯·æ±‚å¤´ï¼‰[å®¢æˆ·ç«¯å‘èµ·æ¡æ‰‹] æœåŠ¡ç«¯é€šè¿‡éªŒè¯åå°†è¯¥è¿æ¥è½¬æ¢ä¸ºwebsocketè¿æ¥ä¿æŒåœ¨æœåŠ¡ç«¯ [æœåŠ¡ç«¯æ¡æ‰‹æ£€æŸ¥å’Œå‡çº§] æœåŠ¡ç«¯æ¡æ‰‹å®Œæˆåï¼ŒåŒæ—¶å‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªHTTPå“åº”ï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰[æœåŠ¡ç«¯å‘é€å“åº”] å®¢æˆ·ç«¯æ ¹æ®æœåŠ¡ç«¯çš„å“åº”å¤„ç†è¯¥è¿æ¥ [å®¢æˆ·ç«¯å¤„ç†å“åº”] æ¡æ‰‹å®Œæˆ 6. å®Œå–„ç»†èŠ‚ # å‰é¢å‡ æ­¥å®Œæˆï¼ŒWebSocketçš„æ¡†æ¶å°±å·²ç»æˆå‹äº†ï¼Œå‰©ä¸‹çš„å·¥ä½œå°±æ˜¯æ ¹æ®åè®®å®Œå–„ã€‚æ¯”å¦‚å¯¹å…³é—­å¸§çš„å¤„ç†ï¼ŒPing/Pongå¸§çš„å¤„ç†ç­‰ç­‰ã€‚è¿™é‡Œç®€å•ä¸¾ä¾‹è¯´æ˜ Ping / Pong çš„å¤„ç†ã€‚\nfunc (c *Conn) readFrame() (*Frame, error) { // ignore cases // handle with close, ping, pong frame switch frmWithoutPayload.OpCode { // ignore cases ... case opCodePing: err = c.replyPing(frmWithoutPayload) case opCodePong: err = c.replyPong(frmWithoutPayload) // ignore some cases ... } return frmWithoutPayload, err } // Ping conn send a ping packet to another side. func (c *Conn) Ping() (err error) { return c.sendControlFrame(opCodePing, []byte(\u0026#34;ping\u0026#34;)) } // replyPing work for Conn to reply ping packet. frame MUST contains 125 Byte or- // less payload. func (c *Conn) replyPing(frm *Frame) (err error) { return c.pong(frm.Payload) } // pong . func (c *Conn) pong(pingPayload []byte) (err error) { return c.sendControlFrame(opCodePong, pingPayload) } // replyPong frame MUST contains same payload with PING frame payload func (c *Conn) replyPong(frm *Frame) (err error) { // if receive pong frame, try to call pongHandler if c.pongHandler != nil { c.pongHandler(string(frm.Payload)) } return nil } æ€»ç»“ # å®ç°WebSocketåè®®å¹¶æ²¡æœ‰ä»€ä¹ˆéš¾ç‚¹ï¼Œåªè¦ä½ è¯»å®ŒRFC6455å°±è¡Œäº†ï¼ŒåŠ¨æ‰‹å»å®ç°åªæ˜¯ä¸ºäº†åŠ æ·±è®¤è¯†ï¼Œå°¤å…¶æ˜¯å¯¹äºç½‘ç»œå’Œåè®®çš„è®¤è¯†ã€‚å®ç°èµ·æ¥ç®€å•å¦å¤–ä¸€ä¸ªåŸå› æ˜¯å› ä¸ºæ¯•ç«Ÿæ˜¯åº”ç”¨å±‚åè®®ï¼ŒåŸºäºTCPå¯é ä¼ è¾“ã€‚ä¼ è¾“å±‚åè®®å¯¹æˆ‘ä»¬å±è”½äº†å¤§é‡çš„ç½‘ç»œç»†èŠ‚é—®é¢˜ï½ï¼Œå¦‚æœæƒ³è¦æŒ‘æˆ˜è‡ªå·±ï¼Œå¯ä»¥å°è¯•å®ç°TCPæˆ–è€…UDPğŸ¶ã€‚\næ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿å‹˜è¯¯æŒ‡æ­£ğŸ™ã€‚\nå‚è€ƒèµ„æ–™ # https://tools.ietf.org/html/rfc6455 https://halfrost.com/websocket/ https://github.com/yeqown/websocket "},{"id":25,"href":"/2020/09/22/Kubernetes%E4%B8%ADgRPC-Load-Balancing%E5%88%86%E6%9E%90%E5%92%8C%E8%A7%A3%E5%86%B3/","title":"Kubernetesä¸­gRPC Load Balancingåˆ†æå’Œè§£å†³","section":"Posts","content":" èƒŒæ™¯ # ç¬¬ä¸€æ¬¡ï¼Œçº¿ä¸Šé‡åˆ°å¤§é‡æ¥å£RTè¶…è¿‡10sè§¦å‘äº†ç³»ç»Ÿå‘Šè­¦ï¼Œè¿ç»´åé¦ˆk8sé›†ç¾¤æ— å¼‚å¸¸ï¼Œè´Ÿè½½æ— æ˜æ˜¾ä¸Šå‡ã€‚å°†æŠ¥è­¦æ¥å£ç›¸å…³çš„æœåŠ¡é‡å¯ä¸€ç•ªåå‘ç°å¹¶æ— æ”¹å–„ã€‚ä½†æ˜¯å¼€å‘äººå‘˜ä½¿ç”¨é“¾è·¯è¿½è¸ªç³»ç»Ÿå‘ç°ï¼Œæ¯”è¾ƒæ…¢çš„è¯·æ±‚æ€»æ˜¯æŸä¸ªgRPCæœåŠ¡ä¸­çš„å‡ ä¸ªPODå¯¼è‡´ï¼Œç”±å…¶ä»–PODå¤„ç†çš„è¯·æ±‚å¹¶ä¸ä¼šå‡ºç°è¶…æ—¶å‘Šè­¦ã€‚\nç¬¬äºŒæ¬¡ï¼ŒåŒæ ·é‡åˆ°æ¥å£RTè¶…è¿‡é˜ˆå€¼è§¦å‘å‘Šè­¦ï¼Œä»k8sä¸­æŸ¥åˆ°æŸä¸ªgRPCæœåŠ¡ï¼ˆå…³é”®æœåŠ¡ï¼‰é‡å¯æ¬¡æ•°å¼‚å¸¸ï¼ŒæŸ¥çœ‹é‡å¯åŸå› æ—¶å‘ç°æ˜¯OOM Killedï¼ŒOOM killedå¹¶ä¸æ˜¯è´Ÿè½½ä¸å‡è¡¡ç›´æ¥å¯¼è‡´çš„ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€å®šçš„å…³ç³»ï¼Œè¿™ä¸ªåé¢å†è¯´ã€‚å‰ä¸¤æ¬¡ç”±äºç›‘æ§ä¸å¤Ÿå®Œå–„ï¼ˆäºæˆ‘è€Œè¨€ï¼Œè¿ç»´çš„å¾ˆå¤šé¢æ¿éƒ½æ²¡æœ‰æƒé™ï¼Œæ²¡åŠæ³•æ’æŸ¥ï¼‰ã€‚æœŸé—´åˆ©ç”¨pprofåˆ†æäº†è¯¥æœåŠ¡å†…å­˜æ³„æ¼ç‚¹ï¼Œå¹¶ä¿®å¤ä¸Šçº¿è§‚å¯Ÿã€‚ç»è¿‡ç¬¬äºŒæ¬¡é—®é¢˜å¹¶è§£å†³ä¹‹åï¼Œçº¿ä¸Šè¶…æ—¶å‘Šè­¦æ¢å¤æ­£å¸¸æ°´å¹³ï¼Œä½†æ˜¯è¯¥ deployment ä¸‹çš„å‡ ä¸ªPODå ç”¨èµ„æºï¼ˆMem / CPU / Network-IOï¼‰ï¼Œå·®è·ç”šå¤§ã€‚\nç¬¬äºŒå¼ å›¾æ˜¯è¿ç»´ç¬¬ä¸€æ¬¡å‘ç°è¯¥æœåŠ¡OOM killed ä¹‹åè°ƒæ•´äº†å†…å­˜ä¸Šé™ä» 512MB =\u0026gt; 1Gï¼Œç„¶è€Œåªæ˜¯è®©å®ƒæ­»å¾—æ…¢ä¸€ç‚¹è€Œå·²ã€‚ ä»ä¸Šé¢ä¸¤å¼ å›¾èƒ½å¤ŸçŸ³é”¤çš„æ˜¯è¯¥æœåŠ¡ä¸€å®šå­˜åœ¨å†…å­˜æ³„æ¼ã€‚Goé¡¹ç›®å†…å­˜å ç”¨çš„åˆ†æï¼Œæˆ‘æ€»ç»“äº†å¦‚ä¸‹çš„æ’æŸ¥æ­¥éª¤ï¼š\n1. ä»£ç æ³„æ¼ï¼ˆpprofï¼‰ï¼ˆå¯èƒ½åŸå›  goroutineæ³„æ¼ï¼›é—­åŒ…ï¼‰ 2. Go Runtime + Linux å†…æ ¸ï¼ˆRSSè™šé«˜å¯¼è‡´OOMï¼‰https://github.com/golang/go/issues/23687 3. é‡‡é›†æŒ‡æ ‡ä¸æ­£å¸¸ï¼ˆcontainer_memory_working_set_bytesï¼‰ 2ï¼Œ3 æ˜¯åŸºäºç¬¬1ç‚¹èƒ½åŸºæœ¬æ’é™¤ä»£ç é—®é¢˜çš„åç»­æ­¥éª¤ã€‚ è§£å†³å’Œæ’æŸ¥æ‰‹æ®µï¼š 1. pprof é€šè¿‡heap + goroutine æ˜¯å¦å¼‚å¸¸ï¼Œæ¥å®šä½æ³„æ¼ç‚¹ è¿è¡Œ`go tool pprof`å‘½ä»¤æ—¶åŠ ä¸Š--nodefration=0.05å‚æ•°ï¼Œè¡¨ç¤ºå¦‚æœè°ƒç”¨çš„å­å‡½æ•°ä½¿ç”¨çš„CPUã€memoryä¸è¶…è¿‡ 5%ï¼Œå°±å¿½ç•¥å®ƒã€‚ 2. ç¡®è®¤goç‰ˆæœ¬å’Œå†…æ ¸ç‰ˆæœ¬ï¼Œç¡®è®¤æ˜¯å¦å¼€å¯äº†MADV_FREEï¼Œå¯¼è‡´RSSä¸‹é™ä¸åŠæ—¶(1.12+ å’Œ linuxå†…æ ¸ç‰ˆæœ¬å¤§äº 4.5)ã€‚ 3. RSS + Cache å†…å­˜æ£€æŸ¥ \u0026gt; Cache è¿‡å¤§çš„åŸå›  https://www.cnblogs.com/zh94/p/11922714.html // IOå¯†é›†ï¼šæ‰‹åŠ¨é‡Šæ”¾æˆ–è€…å®šæœŸé‡å¯ æŸ¥çœ‹æœåŠ¡å™¨å†…å­˜ä½¿ç”¨æƒ…å†µï¼š `free -g` æŸ¥çœ‹è¿›ç¨‹å†…å­˜æƒ…å†µï¼š `pidstat -rI -p 13744` æŸ¥çœ‹è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ï¼š `lsof -p 13744` æŸ¥çœ‹å®¹å™¨å†…çš„PIDï¼š `docker inspect --format \u0026#34;{{ .State.Pid}}\u0026#34; 6e7efbb80a9d` æŸ¥çœ‹è¿›ç¨‹æ ‘ï¼Œæ‰¾åˆ°ç›®æ ‡: `pstree -p 13744` å‚è€ƒï¼šhttps://eddycjy.com/posts/why-container-memory-exceed/ é€šè¿‡ä¸Šè¿°æ­¥éª¤ï¼Œæˆ‘å‘ç°äº†è¯¥PODè¢«OOM killedè¿˜æœ‰å¦ä¸€ä¸ªå…ƒå‡¶å°±æ˜¯ï¼Œæ—¥å¿—æ–‡ä»¶å ç”¨ã€‚è¿™é‡Œå°±ä¸è¿‡å¤šçš„è¯¦è¿°äº†ï¼Œæœç´¢æ–¹å‘æ˜¯ â€œä¸€ä¸ªè¿è¡Œä¸­ç¨‹åºåœ¨å†…å­˜ä¸­å¦‚ä½•ç»„ç»‡ + Cacheå†…å­˜æ˜¯ç”±å“ªäº›éƒ¨åˆ†æ„æˆçš„â€ã€‚è¿™éƒ¨åˆ†è¦è¾¾åˆ°çš„ç›®æ ‡æ˜¯ï¼šä¸€ä¸ªç¨‹åºè¿è¡Œèµ·æ¥å®ƒä¸ºä»€ä¹ˆå ç”¨äº†è¿™ä¹ˆäº›å†…å­˜ï¼Œè€Œä¸æ˜¯æ›´å¤šæˆ–è€…æ›´å°‘ã€‚\né—®é¢˜åˆ°æ­¤å¹¶æ²¡æœ‰ç»“æŸï¼ŒOOM Killed åªæ˜¯é›†ç¾¤ä¸­å‘ç°çš„æœ€æ˜¾çœ¼çš„é—®é¢˜ã€‚è¿™é‡Œè¿˜æœ‰å‡ ä¸ªç–‘ç‚¹ï¼š\næœåŠ¡å¤§é‡è¶…æ—¶ï¼Œè€Œè¿ç»´èµ„æºå´æ²¡æœ‰å¼‚å¸¸ï¼Œæ•´ä½“çš„è¯·æ±‚é‡æ²¡æœ‰å¤§å¹…åº¦ä¸Šæ¶¨ï¼Ÿ ä¸ºä»€ä¹ˆé‡å¯ä¸èƒ½è®©ç³»ç»Ÿæ¢å¤ï¼Ÿ OOM Killedæ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´çš„ï¼Ÿï¼ˆgoé¡¹ç›® / å†…å­˜é™åˆ¶ 1GB / è¿‘åº•å±‚æ•°æ®æœåŠ¡ï¼Œä¸»è¦å’ŒDBæ‰“äº¤é“ï¼‰é™¤å†…å­˜æ³„æ¼è¿˜æœ‰ä»€ä¹ˆä¼šå¯¼è‡´æœåŠ¡å†…å­˜å ç”¨ä¸Šå‡ï¼Ÿ åŒä¸€ä¸ª Deployment çš„ Pods åœ¨ä¸€ä¸ª Service ä¸‹å¯¹å¤–æä¾›æœåŠ¡ï¼Œä¸ºä»€ä¹ˆå ç”¨çš„èµ„æºå¹¶ä¸æ˜¯è¿‘ä¹ç›¸ç­‰çš„ï¼Ÿ çŒœæƒ³å’ŒéªŒè¯ # ä¸Šé¢è¯´äº†é‚£ä¹ˆå¤šå’ŒgRPC å’Œ k8s Service æœ‰åŠæ¯›é’±å…³ç³»å—ï¼Ÿæœ‰åŠæ¯›é’±ã€‚\nå…¶å®å‘ç°gRPCè´Ÿè½½ä¸å‡è¡¡å¾ˆç®€å•ï¼Œä»ä¸Šé¢çš„ç–‘æˆ–è€…çœ‹ä¸€çœ‹k8sèµ„æºç›‘æ§é¢æ¿ï¼Œå°±èƒ½çœ‹çš„å‡ºæ¥åŒä¸€ä¸ªserviceä¸­çš„ä¸åŒPODè´Ÿè½½ä¸ä¸€æ ·ï¼Œå› ä¸ºæœ‰è´Ÿè½½æ‰æœ‰å‹åŠ›ï¼Œæœ‰è´Ÿè½½æ‰éœ€è¦æ¶ˆè€—èµ„æºã€‚å½“ç„¶å› ä¸ºä¸ªåˆ«PODè´Ÿè½½æå¤§å¯¼è‡´å†…å­˜æ³„æ¼é—®é¢˜çªå‡ºï¼Œæ—¥å¿—æ–‡ä»¶ä¸Šå‡å¿«OOM killedé¢‘ç¹ã€‚\nçŸ¥é“ä¸Šè¿°çš„ç°è±¡ä¹‹åï¼Œé‚£ä¹ˆå°±å¯ä»¥çŒœæƒ³äº†ï¼Œä¸ºä»€ä¹ˆè´Ÿè½½ä¸å‡è¡¡å‘¢ï¼Ÿç°åˆ—ä¸¾ä»¥ä¸‹çš„å…³é”®ç‚¹ï¼š\nè¯¥æœåŠ¡æ˜¯ä¸€ä¸ªåŸºäºgRPC-goç¼–å†™çš„æœåŠ¡ç«¯ã€‚ gRPCä½¿ç”¨çš„åº”ç”¨å±‚åè®®æ˜¯http2ã€‚ http2æœ€å¤§çš„ç‰¹ç‚¹æ˜¯é•¿é“¾æ¥ã€‚ è¯¥æœåŠ¡æ˜¯åŸºäºäº†k8s Serviceæ¥å¯¹å†…éƒ¨åº”ç”¨æä¾›æœåŠ¡ã€‚ k8s Service è‡ªå¸¦L4è´Ÿè½½å‡è¡¡ï¼ˆè½®è¯¢ï¼‰ã€‚ k8s çš„è´Ÿè½½å‡è¡¡æ˜¯åŸºäº iptables å®ç°çš„ã€‚ iptables æ˜¯é€šè¿‡ä¿®æ”¹ netfilter è§„åˆ™æ¥å®ç°çš„ï¼ˆè¿™é‡Œå¯ä»¥ç®€å•ç†è§£ä¸ºï¼šk8sçš„è´Ÿè½½å‡è¡¡æ˜¯æ— æ³•æ„ŸçŸ¥æœåŠ¡çš„è´Ÿè½½å‹åŠ›çš„ï¼‰ã€‚ è¯´äº†ä¸Šé¢è¿™äº›ï¼Œå†æ¥ç†ä¸€ç†æ•´ä¸ªç³»ç»Ÿçš„è¯·æ±‚å¤„ç†æµç¨‹ã€‚\nSLB =\u0026gt; k8s é›†ç¾¤ (nginx) ==\u0026gt; APIæœåŠ¡ (k8s Service) ... gRPC-Client == || gRPC Server \u0026lt;== gRPC-Client ... gRPC-Server (k8s Service) \u0026lt;==|| åˆ°è¿™é‡Œï¼Œç»“åˆæœ€å¼€å§‹çš„èƒŒæ™¯ä¸­æåˆ°çš„â€œè´Ÿè½½ä¸å‡è¡¡â€ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥å¾—å‡ºç»“è®ºï¼šâ€œä¸€ä¸ªè¯·æ±‚ç¡®å®šäº†ç”±æŸä¸ªAPIæœåŠ¡å¤„ç†ä¹‹åï¼Œåç»­è°ƒç”¨çš„PODå‡ ä¹æ˜¯ç¡®å®šçš„â€ã€‚é‚£ä¹ˆè¿™ç§ç¡®å®šæ€§æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Œæ˜æ˜k8sæœ‰è‡ªå·±çš„L4è´Ÿè½½å‡è¡¡ï¼Ÿ\nä¸ä¼šå§ï¼Œä¸ä¼šå§ï¼Œä½ ç«Ÿç„¶æ‰çŸ¥é“L4å±‚è´Ÿè½½å‡è¡¡å¯¹é•¿è¿æ¥æ²¡æœ‰æ„ä¹‰ã€‚\nå› ä¸ºL4è´Ÿè½½å‡è¡¡æ˜¯è®©å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç›´æ¥è¿æ¥ï¼Œè€Œä¸æ˜¯é€šè¿‡è‡ªå·±è½¬å‘ã€‚é‚£è¿æ¥ä¸Šäº†ä¹‹ååˆæ²¡æœ‰é‡æ–°è¿æ¥ï¼Œé‚£ä¹ˆè‡ªç„¶è¯¥å®¢æˆ·ç«¯çš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šäº¤ç»™è¿æ¥ä¸Šçš„æœåŠ¡ç«¯å¤„ç†ï¼Œè€Œä¸æ˜¯å…¶ä»–çš„æœåŠ¡ç«¯äº†ã€‚å› æ­¤ï¼Œç³»ç»Ÿä¸­çš„å¤§å¤šæ•°å®¢æˆ·ç«¯åœ¨å¯åŠ¨æ—¶ï¼Œå¦‚æœè¢«k8sçš„è´Ÿè½½å‡è¡¡åˆ†é…åˆ°äº†å‡ ä¹åŒä¸€ä¸ªæœåŠ¡ç«¯PODä¸Šï¼Œé‚£ä¹ˆè¿™ä¸ªæœåŠ¡ç«¯PODè‡ªç„¶ä¼šå¤„ç†å¤§éƒ¨åˆ†è¯·æ±‚ï¼Œç›¸æ¯”å…¶ä»–æœåŠ¡å®ƒçš„è´Ÿè½½è‡ªç„¶ä¼šé«˜å‡ºå¾ˆå¤šã€‚è¿™ä¹Ÿè§£é‡Šäº† 1 å’Œ 4 ç–‘é—®ã€‚\nå¯¹äºç–‘é—® 2 â€œä¸ºä»€ä¹ˆé‡å¯ä¹Ÿä¸è¡Œå‘¢ï¼Ÿâ€ è¿™ä¸ªé—®é¢˜ç­‰ä»·äº â€œä¸ºä»€ä¹ˆk8sä¼šæŠŠå®¢æˆ·ç«¯åˆ†é…å¾—ä¸å‡åŒ€å‘¢ï¼Ÿâ€\nè¿™é‡Œè¯´çš„é‡å¯ä¸è¡Œæ˜¯æŒ‡ç›²ç›®é‡å¯ï¼Œæ²¡æœ‰ç­–ç•¥å’Œä¼˜å…ˆçº§ã€‚å¤§å¤šæ•°äººç†è§£çš„é‡å¯ï¼Œå¤šåŠä¼šæ˜¯åªé‡å¯æœ‰é—®é¢˜çš„æœåŠ¡ã€‚äº‹å®ä¸Šä¹Ÿæ˜¯è¿™æ ·æ“ä½œçš„ã€‚æ—¢ç„¶çŸ¥é“æ˜¯k8sè®©æœåŠ¡ç«¯PODè´Ÿè½½ä¸å‡è¡¡ï¼Œè¿›è€Œå¯¼è‡´æ¥å£å“åº”æ…¢ï¼Œé‚£ä¹ˆé‡å¯çš„ç›®çš„æ˜¯è®©â€œè¯·æ±‚å°½å¯èƒ½çš„å‡åŒ€ä¸€äº›â€ã€‚é‚£ä¹ˆé¦–å…ˆé‡å¯æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯é‡å¯å®Œæˆåå†é‡å¯ä¾èµ–è¯¥æœåŠ¡çš„å®¢æˆ·ç«¯ï¼Œä¾èµ–çš„æœ€åº•ç«¯ä¾æ¬¡å¾€ä¸Šé‡å¯ã€‚\nk8s L4è½®è¯¢è´Ÿè½½å‡è¡¡å­˜åœ¨çš„é—®é¢˜æ˜¯ï¼šæœåŠ¡æ²¡æœ‰å®Œå…¨éƒ¨ç½²æˆ–é‡å¯å®Œæˆï¼ˆæ»šåŠ¨æ›´æ–°ï¼‰ï¼Œè¿™æ—¶å€™å®¢æˆ·ç«¯é€šè¿‡serviceå‘ç°çš„åªæœ‰å…¶ä¸­çš„éƒ¨åˆ†PODè€Œä¸æ˜¯å…¨éƒ¨ï¼Œå½“ç„¶ä¼šè®©ååŠ å…¥çš„æœåŠ¡åˆ†é…åˆ°è¾ƒå°‘çš„å®¢æˆ·ç«¯è¿æ¥ã€‚\nè§£å†³åŠæ³• # çŸ¥é“äº†é—®é¢˜åœ¨å“ªå„¿ï¼Œé‚£ä¹ˆè§£å†³æ€è·¯å°±å¾ˆæ˜ç¡®äº†ã€‚æ­£å¦‚æ ‡é¢˜ä¸­è¯´çš„ä¸€æ · â€œgRPC LoadBalancingâ€ï¼Œè¿™é‡Œéœ€è¦æ‰¾åˆ°ä¸€ç§èƒ½å¤Ÿå°†gRPCè¿æ¥è´Ÿè½½å‡è¡¡çš„æ‰‹æ®µã€‚è¿™é‡Œæå‡ºä»¥ä¸‹ä¸‰ç§è§£å†³åŠæ³•ï¼š\nåºå· æ–¹æ¡ˆ æè¿° ä¼˜ç¼ºç‚¹ 1 é›†ä¸­LB æœåŠ¡ç«¯LB å®¢æˆ·ç«¯æ— æ„ŸçŸ¥ï¼›å­˜åœ¨å•ç‚¹é—®é¢˜ 2 å®¢æˆ·ç«¯LB gRPC resolver + LB å®¢æˆ·ç«¯è‡ªå®šä¹‰LBç­–ç•¥ï¼›éœ€è¦æ³¨å†Œä¸­å¿ƒæˆ–è€…å¯¹æ¥k8sçš„APIä»¥è·å–æœåŠ¡åˆ—è¡¨;ä¸å¥½å‡çº§ 3 Service Mesh linkerdä¹‹ç±»çš„ç»„ä»¶ æœåŠ¡ç«¯å®¢æˆ·ç«¯æ— æ„ŸçŸ¥ï¼›å¢åŠ å»¶è¿Ÿ è¿™é‡Œæ¨èçš„åªæœ‰ä¸¤ç§ï¼ˆè§†ä½“é‡çš„æŠ€æœ¯æ ˆè€Œå®šï¼‰ï¼š å®¢æˆ·ç«¯LB å’Œ Service Meshã€‚\nService Meshè‡ªä¸ç”¨å¤šè¯´ï¼Œå› ä¸ºæ”¹é€ ç®€å•æ— ä»£ç å…¥ä¾µï¼Œç»´æŠ¤æˆæœ¬çš„è¯å°±è§äººè§æ™ºäº†ã€‚ å®¢æˆ·ç«¯LBæœ€å¤§çš„ç¼ºç‚¹å°±æ˜¯â€œä¸å¥½å‡çº§ï¼Œä»£ç å…¥ä¾µâ€ï¼Œä½†ä»gRPCè¿™ä¸€å¥—æ–¹æ¡ˆå‡ºå‘ï¼Œå®¢æˆ·ç«¯æœåŠ¡å‘ç°å’ŒLBéƒ½å·²ç»è¢«é›†æˆåˆ°äº†gRPCï¼ˆResolver + LB Policyï¼‰é‡Œï¼Œåªéœ€è¦æä¾›è‡ªå·±çš„æ–¹æ¡ˆå¹¶æ³¨å†Œåˆ°gRPCå°±è¡Œäº†ï¼Œç›¸æ¯”å…¶ä»–ä¸¤ç§æ›´åŠ å¯æ§ã€‚\nè¿™é‡Œä½¿ç”¨äº†linkerdæ¥å°è¯•è§£å†³é—®é¢˜ï¼Œä¸‹å›¾æ˜¯ä½¿ç”¨äº†linkerdä¹‹åçš„ç›‘æ§ï¼š\nå› ä¸ºè¿˜å¤„äºæµ‹è¯•ç¯å¢ƒè§‚å¯Ÿé˜¶æ®µï¼Œå› æ­¤æ•°æ®æŒ‡æ ‡ä¸æ˜¯ç‰¹åˆ«é«˜ï¼Œä¹Ÿæ²¡æœ‰é‚£ä¹ˆæ˜æ˜¾ã€‚\nä»ä¸Šå›¾å¯ä»¥å‘ç°ï¼Œä¸¤ä¸ªPODåŸºæœ¬ä¸Šåšåˆ°çš„æ³¢å³°æ³¢è°·åŒæ­¥ï¼Œè€Œä¸æ˜¯æˆ‘å·²åŸåœ°çˆ†ç‚¸ï¼Œä½ è¿˜å¿«æ´»é€é¥ã€‚\nå®¢æˆ·ç«¯LBæˆ‘ä¹Ÿåœ¨å°è¯•ï¼Œæœ‰ä¸¤ä¸ªæ–¹å‘ï¼š\nå®¢æˆ·ç«¯ä½¿ç”¨k8s APIè·å–æœåŠ¡åˆ—è¡¨ç”šè‡³è´Ÿè½½ï¼Œä»¥å®ç° æœåŠ¡å‘ç° + åŸºäºè´Ÿè½½çš„LBç­–ç•¥ã€‚ ä½¿ç”¨é¢å¤–çš„æœåŠ¡æ³¨å†Œå’Œå‘ç°ä¸­å¿ƒï¼Œè®°å½•æœåŠ¡è´Ÿè½½æŒ‡æ ‡ï¼Œå®¢æˆ·ç«¯åªéœ€è¦å®ç°LBç­–ç•¥å³å¯ã€‚ æ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿å‹˜è¯¯æŒ‡æ­£ğŸ™\nå‚è€ƒæ–‡çŒ® # https://github.com/yeqown/k8s-grpc-lb-solutions https://www.youtube.com/watch?v=F2znfxn_5Hg https://linkerd.io/2/overview/ https://github.com/grpc/grpc/blob/master/doc/load-balancing.md "},{"id":26,"href":"/2020/08/12/%E8%BF%91%E6%9C%9F%E4%BD%BF%E7%94%A8Docker%E6%89%93%E5%8C%85%E9%95%9C%E5%83%8F%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/","title":"è¿‘æœŸä½¿ç”¨Dockeræ‰“åŒ…é•œåƒé‡åˆ°çš„é—®é¢˜æ€»ç»“","section":"Posts","content":" èƒŒæ™¯ # åœ¨ github.com/yeqown/goreportcard é¡¹ç›®ä¸­æˆ‘æ”¹é€ äº† goreportcardã€‚ åç»­ä¸ºäº†æ–¹ä¾¿éƒ¨ç½²ï¼Œæˆ‘å‡†å¤‡å°†å…¶æ‰“åŒ…æˆä¸ºdockeré•œåƒå¹¶ä¸Šä¼ åˆ° DockerHubã€‚æœŸé—´é‡åˆ°äº†ä¸‹é¢çš„é—®é¢˜ï¼Œå¹¶ä¸€ä¸€è§£å†³ï¼Œè¿™é‡Œåšä¸€ä¸ªè®°å½•å¸®åŠ©ä»¥åé‡åˆ°ç±»ä¼¼çš„é—®é¢˜å¯ä»¥å¿«é€Ÿè§£å†³ã€‚\nåˆæœŸçš„ç›®æ ‡æ˜¯ï¼šå°†goreportcardå’Œgolangci-lintç¼–è¯‘å¥½ï¼Œå°½å¯èƒ½è¾ƒå°é•œåƒçš„ä½“ç§¯ã€‚å› æ­¤ç¬¬ä¸€æ¬¡å°è¯•ï¼Œæˆ‘ä½¿ç”¨äº†åˆ†é˜¶æ®µç¼–è¯‘ï¼Œç”¨golang:1.14.1ç¼–è¯‘ï¼Œalpineæ¥å‘å¸ƒã€‚\nåŸºæœ¬ Dockerfile å¦‚ä¸‹ï¼š\n# building stage FROM golang:1.14-alpine3.11 as build WORKDIR /tmp/build COPY . . RUN export GOPROXY=\u0026#34;https://goproxy.cn,direct\u0026#34; \\ \u0026amp;\u0026amp; go mod download \\ \u0026amp;\u0026amp; go build -o app ./cmd/goreportcard-cli/ \\ \u0026amp;\u0026amp; go get github.com/golangci/golangci-lint \u0026amp;\u0026amp; go install github.com/golangci/golangci-lint/cmd/golangci-lint # release stage FROM golang:1.14-alpine3.11 as release WORKDIR /app/goreportcard COPY --from=build /tmp/build/app . COPY --from=build /tmp/build/tpl ./tpl COPY --from=build /tmp/build/assets ./assets # FIXED: ä¸èƒ½ä½¿ç”¨golangci-lint, `File not found` é”™è¯¯ COPY --from=build /go/bin/golangci-lint /usr/local/bin EXPOSE 8000 ENTRYPOINT [\u0026#34;./app\u0026#34;, \u0026#34;start-web\u0026#34;, \u0026#34;\u0026amp;\u0026#34;] é—®é¢˜æ¸…å•å’Œè§£å†³æ–¹æ¡ˆ # ç”±äºå¹¶ä¸æ˜¯æ‰€æœ‰çš„é—®é¢˜éƒ½å’ŒDockeræœ‰å…³ï¼Œå› æ­¤æˆ‘ä¼šä½¿ç”¨ [åˆ†ç±»] åœ¨æ ‡é¢˜ä¸Šæ³¨æ˜ã€‚\n0. å¦‚ä½•è°ƒè¯•Dockeræ‰“åŒ…è¿‡ç¨‹ [Docker] # åœ¨Dockeræ‰“åŒ…è¿‡ç¨‹ä¸­ä¼šæœ‰å¦‚ä¸‹å­—æ ·ï¼Œå…¶ä¸­---\u0026gt; 5d5cac8457ad å­—æ ·å°±æ˜¯ä¸€ä¸ªå¯ä»¥è¿è¡Œçš„é•œåƒï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°è¯•è¿è¡Œè¿™ä¸ªé•œåƒæ¥è·å–æˆ‘ä»¬æƒ³è¦çš„ä¿¡æ¯ï¼Œ è€Œä¸ç”¨åœ¨ Dockerfile ä¸­é€šè¿‡ echo æ¥DebugğŸ¶ã€‚\ndocker build -t goreportcard:v1.0.0 . Sending build context to Docker daemon 12.08MB Step 1/13 : FROM golang:1.14-alpine3.11 as build ---\u0026gt; 5d5cac8457ad Step 2/13 : WORKDIR /tmp/build ---\u0026gt; Using cache ---\u0026gt; c57b9255d5fb Step 3/13 : COPY . . è¿è¡Œæ‰“åŒ…è¿‡ç¨‹ä¸­çš„é•œåƒ\ndocker run -it c57b9255d5fb 1 golangci-lint ç¼–è¯‘å¥½åå¤åˆ¶åˆ° alpineä¸­æ— æ³•è¿è¡Œï¼Ÿ[Go] # é‡åˆ°è¿™ä¸ªé—®é¢˜çš„æ—¶å€™ï¼Œæç¤ºé”™è¯¯ä¿¡æ¯å¤§è‡´ä¸ºFile or Path not foundï¼Œä½†åŒæ—¶ goreportcard æ˜¯å¯ä»¥è¿è¡Œï¼Œè¿™ä¸¤è€…æ˜¯åœ¨ç›¸åŒåœ°ç¯å¢ƒä¸‹ç¼–è¯‘å‡ºæ¥çš„ã€‚ å› æ­¤è‚¯å®šæ˜¯ç¼–è¯‘çš„æ—¶å€™å­˜åœ¨å·®å¼‚ï¼Œåˆæ­¥åˆ¤æ–­ä¸ºCGO_ENABLEDï¼ŒGOOSï¼ŒGOARCHä¸‰ä¸ªå˜é‡ï¼Œé€šè¿‡æœç´¢å’Œå°è¯•æœ€ç»ˆç»Ÿä¸€å¢åŠ è¿™ä¸‰ä¸ªç¯å¢ƒå˜é‡è§£å†³é—®é¢˜ã€‚\n\u0026amp;\u0026amp; export CGO_ENABLED=0 \\ \u0026amp;\u0026amp; export GOARCH=amd64 \\ \u0026amp;\u0026amp; export GOOS=linux \\ 2. golangci-lint éœ€è¦Goå¯æ‰§è¡Œæ–‡ä»¶? [Go] # // TODO:\n3. go get éœ€è¦ git / ssh å®¢æˆ·ç«¯ï¼Ÿ [Go] # // TODO:\n4. åœ¨ alpine ä¸­å¦‚ä½•å®‰è£…é¢„ç¼–è¯‘å¥½çš„è½¯ä»¶ï¼Œå¦‚gitï¼Ÿ [Docker] # è¿™ä¸ªæ˜¯åœ¨gitçš„ linuxå®‰è£…å¸®åŠ© é‡Œæ‰¾åˆ°çš„ğŸ˜‚ï¼Œä¹Ÿä¸çŸ¥é“ä¸ºå•¥ï¼Œåªèƒ½å¤¸ä¸‹gitå¯çœŸä¸“ä¸š\napk add git 5. åœ¨ alpine ä¸­å®‰è£…è½¯ä»¶ç‰¹åˆ«æ…¢ï¼Œå¦‚ä½•è§£å†³ï¼Ÿ [Docker] # sed -i \u0026#39;s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g\u0026#39; /etc/apk/repositories 6. é•œåƒä¸­ go get æ€ä¹ˆä½¿ç”¨å®¿ä¸»çš„ç¼“å­˜ï¼Ÿ [Go+Docker] # æŠŠå®¿ä¸»æœºçš„ path/go/pkg æŒ‚è½½åˆ° /go/pkgï¼Œè¿™é‡Œé»˜è®¤ä½¿ç”¨çš„æ˜¯goçš„å®¹å™¨é•œåƒã€‚\n7. could not import C (no metadata for C) [Go] # https://github.com/golangci/golangci-lint/issues/602\n"},{"id":27,"href":"/2020/08/06/opentracing%E5%AE%9E%E6%88%98/","title":"Opentracingå®æˆ˜","section":"Posts","content":" èƒŒæ™¯ # åœ¨æ²¡æœ‰é“¾è·¯è¿½è¸ªç³»ç»Ÿçš„æƒ…å†µä¸‹ï¼Œå¦‚æœåªè¦å°‘æ•°å‡ ä¸ªæœåŠ¡ï¼Œæˆ–è®¸è¿˜å¯ä»¥é€šè¿‡æ—¥å¿—æ¥æ’æŸ¥å®šä½é—®é¢˜ã€‚ä½†æ˜¯å¦‚æœæœåŠ¡ä¸€æ—¦è¶…è¿‡10ä¸ªï¼Œé‚£ä¹ˆå†æƒ³é€šè¿‡æ—¥å¿—æ¥å®šä½åˆ†æé—®é¢˜å°†æ— æ¯”ç¹çã€‚ å› ä¸ºï¼Œä½ å…ˆè¦ä»å¤§é‡çš„æ—¥å¿—ä¸­åˆ ç­›é€‰å‡ºæŸæ¬¡è¯·æ±‚çš„æ—¥å¿—æ•°æ®ï¼Œæ‰èƒ½è¿›è¡Œåç»­çš„å®šä½åˆ†æã€‚ å€˜è‹¥æ—¥å¿—ç³»ç»Ÿä¹Ÿä¸å¤Ÿå®Œå–„ï¼Œæ—¥å¿—å¯¹äºè°ƒè¯•æ¯«æ— å¸®åŠ©ï¼Œé‚£åˆå¾—é€€å›åˆ°æœ€åŸå§‹çš„æ–¹å¼ï¼Œé€šè¿‡ä»£ç æ–­ç‚¹å’Œå¢åŠ æ—¥å¿—ï¼Œç­‰å¾…é—®é¢˜å¤ç°ï¼Œæˆ–è€…é€šè¿‡è‚‰çœ¼æ£€æŸ¥ä»£ç ã€‚ ä¸æ˜¯è¯´è¿™ç§æ–¹å¼ä¸è¡Œï¼Œè€Œæ˜¯å¤§éƒ¨åˆ†çš„ç¨‹åºå‘˜çš„ä¸šåŠ¡éœ€æ±‚æ¯”è¾ƒç´§å¼ ï¼Œè¿™æ ·çš„æ’æŸ¥æ‰‹æ®µæ•ˆç‡å’Œæ”¶ç›Šè¿œè¿œè¾¾ä¸åˆ°è¦æ±‚ï¼ˆå¦‚æœä½ æœ‰æ—¶é—´ï¼Œå½“æˆ‘æ²¡è¯´ ğŸ¶ï¼‰ã€‚\nåœ¨å®é™…åœºæ™¯ä¸­ï¼Œæˆ‘ä¹Ÿé‡åˆ°äº†è¿™æ ·çš„é—®é¢˜ï¼š\næ—¥å¿—ç³»ç»Ÿé‡ŒåŒ…å«äº†è¿‡å°‘çš„ä¿¡æ¯ï¼Œå¯¹äºè°ƒè¯•å‡ ä¹æ²¡æœ‰å¸®åŠ© (å‡ ä¹åªæœ‰é”™è¯¯æ—¥å¿—ï¼Œç¼ºå°‘è¾“å‡ºä¸Šä¸‹æ–‡çš„æ—¥å¿—)ã€‚ æœåŠ¡è°ƒç”¨å¤æ‚ï¼Œä¸€ä¸ªè¯·æ±‚å¤±è´¥ï¼Œåªèƒ½é€è¿‡é”™è¯¯ç å’Œé”™è¯¯ä¿¡æ¯è¿›è¡Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨è°ƒç”¨å¤±è´¥çš„æƒ…å†µã€‚ è°ƒç”¨é“¾è·¯å¤æ‚çš„æƒ…å†µä¸‹ï¼Œæƒ³è¦å¯¹æŸä¸ªè¯·æ±‚è¿›è¡Œä¼˜åŒ–ï¼Œæ— ä»ä¸‹æ‰‹ã€‚ è¿™é‡Œåªåˆ—ä¸¾äº†è·Ÿtraceç›¸å…³çš„ä¸€äº›åŸå§‹åœºæ™¯ï¼Œå½“ç„¶ä»ä¸Šé¢çš„æè¿°ä¸­è¿˜èƒ½å‘ç°æ—¥å¿—ç³»ç»Ÿä¸å¤Ÿå®Œå–„ï¼Œå¯¹è°ƒè¯•ä¸å‹å¥½ï¼Œä¸è¿‡è¿™é‡Œé¦–è¦è§£å†³çš„é—®é¢˜æ˜¯é“¾è·¯è¿½è¸ªé—®é¢˜ã€‚\nå¦‚æœå¯¹è·¯é“¾è·¯è¿½è¸ªæ²¡æœ‰æ¦‚å¿µï¼Œè¿˜æœ›è‡ªè¡ŒæŸ¥é˜…èµ„æ–™ï¼Œè¿™é‡Œä¸ä¼šè¿‡å¤šä»‹ç»ï½\nOpentracing # æ³¨æ„ï¼šOpentracing æ˜¯ä¸€å¥—æ ‡å‡†æ¥å£ï¼Œè€Œä¸æ˜¯å…·ä½“å®ç°ã€‚\nè¿™é‡Œå°±å®æˆ˜opentracing + jaeger çš„é“¾è·¯è¿½è¸ªæ–¹æ¡ˆã€‚å…¶ä¸­ opentracing æ˜¯ä¸€å¥—æ ‡å‡†æ¥å£ï¼Œè€Œjaegeræ˜¯åŒ…å«äº† opentracing çš„å®ç°çš„ä¸€å¥—å·¥å…·ã€‚ Traceé“¾è·¯ç®€å•ç¤ºä¾‹å¦‚ä¸‹ï¼š\nTrace # æè¿°åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ä¸€æ¬¡\u0026quot;äº‹åŠ¡\u0026quot;ã€‚\nSpan # è¡¨ç¤ºå·¥ä½œæµçš„ä¸€éƒ¨åˆ†çš„å‘½åå’Œå®šæ—¶æ“ä½œã€‚å¯ä»¥æ¥å—æ ‡ç­¾(Tag Key:Value)ï¼Œä»¥åŠé™„åŠ åˆ°ç‰¹å®šspanå®ä¾‹çš„æ ‡æ³¨(Annotation)ï¼Œå¦‚æ—¶é—´æˆ³å’Œç»“æ„åŒ–æ—¥å¿—ã€‚\nSpanContext # è¿½è¸ªä¼´éšåˆ†å¸ƒå¼äº‹åŠ¡çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å®ƒé€šè¿‡ç½‘ç»œæˆ–é€šè¿‡æ¶ˆæ¯æ€»çº¿å°†æœåŠ¡ä¼ é€’ç»™æœåŠ¡çš„æ—¶é—´ã€‚spanä¸Šä¸‹æ–‡åŒ…å«TraceIdã€SpanIdå’Œè¿½è¸ªç³»ç»Ÿéœ€è¦ä¼ æ’­åˆ°ä¸‹æ¸¸æœåŠ¡çš„å…¶ä»–æ•°æ®ã€‚\nå®æˆ˜ # è¿™é‡Œæˆ‘å‡†å¤‡çš„æ˜¯ Go é¡¹ç›®ï¼ŒæœåŠ¡ä¹‹é—´é€šè¿‡gRPCé€šä¿¡ã€‚é“¾è·¯å¦‚ä¸‹ï¼š\n+-- process internal trace2 | +---\u0026gt; process internal trace1 | | +---\u0026gt; server-b trace(gRPC) entry(HTTP) ---\u0026gt; server-a trace--gRPC--| +---\u0026gt; server-c trace(gRPC) | +----\u0026gt; process internal trace3 ä»ä¸Šå›¾ä¸­å¯ä»¥æ˜ç¡®ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯ï¼šå®è·µè·¨æœåŠ¡è°ƒç”¨å’ŒæœåŠ¡å†…éƒ¨è°ƒç”¨çš„é“¾è·¯è¿½è¸ªï¼Œé…åˆjaegeræˆ‘ä»¬è¿˜å¯ä»¥å°†é“¾è·¯ä¿¡æ¯å¯è§†åŒ–ã€‚\næˆ‘æœ‰äº†æœåŠ¡ï¼Œæ€ä¹ˆå®æ–½è½åœ°ï¼Ÿ # ä¸ºäº†å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘æŠŠè¿™ä¸ªé—®é¢˜ç»“åˆopentracingçš„æ¦‚å¿µå†åˆ†è§£ä¸€ä¸‹ï¼š\nParentSpan ä»å“ªå„¿æ¥ï¼Ÿ ChildSpanç”±ParentSpanåˆ›å»ºï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼Ÿ é“¾è·¯Tracerä»å“ªå„¿æ¥ï¼Ÿ Traceä¿¡æ¯æ€ä¹ˆä¼ é€’ï¼Ÿ é“¾è·¯ä¿¡æ¯å¦‚ä½•æœé›†ï¼Ÿ Parent-Span ä»å“ªå„¿æ¥ï¼Ÿé“¾è·¯ä»å“ªé‡Œå¼€å§‹ã€‚ # åœ¨ä¸Šè¿°çš„å®è·µç›®æ ‡ä¸­ï¼Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ªå…¥å£æœåŠ¡ï¼Œé‚£ä¹ˆå¾ˆæ˜æ˜¾æ¯ä¸€æ¬¡çš„\u0026quot;äº‹åŠ¡\u0026quot;éƒ½æ˜¯åœ¨è¿™ä¸ªå…¥å£ï¼ˆhttp entryï¼‰å¼€å¯çš„ã€‚æˆ‘å†™äº†å¦‚ä¸‹çš„ä¸­é—´ä»¶ï¼ˆåŸºäºginï¼‰ã€‚\n// è¿™ä¸ªå®šä¹‰æ˜¯å› ä¸ºopentracingæ²¡æœ‰å®šä¹‰è·å–traceId å’ŒspanIdçš„æ–¹æ³•ï¼Œè€Œæˆ‘åˆå®è·µäº† zipkin å’Œ jaeger type getTraceID func(spCtx opentracing.SpanContext) string // get trace info from header, if not then create an new one func Opentracing(getTraceIdFromSpanContext getTraceID) gin.HandlerFunc { return func(c *gin.Context) { // prepare work ... // è¿™é‡Œé¦–å…ˆå°è¯•ä»å®¢æˆ·ç«¯è¯·æ±‚ä¸­è·å–åˆ°traceé“¾è·¯ä¿¡æ¯ï¼Œå¦‚æœè·å–åˆ°åˆ™åˆ›å»ºchild span. carrier := opentracing.HTTPHeadersCarrier(c.Request.Header) clientSpCtx, err := tracer.Extract(opentracing.HTTPHeaders, carrier) if err != nil { log.Printf(\u0026#34;could not extract trace data from http header, err=%v\\n\u0026#34;, err) } // derive a span or create an root span sp = tracer.StartSpan( c.Request.RequestURI, opentracing.ChildOf(clientSpCtx), ) defer sp.Finish() // do some work // ... // å°†å«æœ‰spançš„ context.Context è®¾ç½®åˆ° gin.Context ç”¨äºä¼ é€’span ctx = opentracing.ContextWithSpan(c.Request.Context(), sp) c.Set(_traceContextKey, ctx) traceId := getTraceIdFromSpanContext(sp.Context()) c.Header(\u0026#34;X-Trace-Id\u0026#34;, traceId) // continue process request c.Next() // do some work // ... } } Child-Spanä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼Ÿ # å…¶å®åœ¨ä¸Šè¿°çš„ä¸­é—´ä»¶é‡Œå·²ç»æœ‰äº†ä½“ç°ï¼ˆè·¨æœåŠ¡è°ƒç”¨æ—¶ï¼‰ã€‚è¿™é‡Œä¸»è¦æœ‰ä¸¤ç§åœºæ™¯ï¼šè·¨æœåŠ¡è°ƒç”¨ï¼ŒæœåŠ¡å†…éƒ¨è°ƒï¼Œè¿™ä¸¤ç§çš„åŒºåˆ«åœ¨äºæ˜¯å¦æ˜¯åŒä¸€ä¸ªè¿›ç¨‹ã€‚ é’ˆå¯¹è·¨æœåŠ¡è°ƒç”¨ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†gRPCæ¥é€šä¿¡ï¼Œé‚£ä¹ˆåˆ›å»ºçš„æ—¶æœºå°±åœ¨äºgRPCå®¢æˆ·ç«¯å‘èµ·è°ƒç”¨æ—¶ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªchildSpanå¹¶ä¼ é€’ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯éœ€è¦è§£æåˆ°è¯¥spanå¹¶åœ¨å½“æ¬¡è¯·æ±‚ä¸­ä½¿ç”¨ã€‚ è€Œå¯¹äºæœåŠ¡å†…éƒ¨çš„è°ƒç”¨ï¼Œç›¸è¾ƒè€Œè¨€ä¼šæ›´ç®€å•ä¸€ç‚¹ï¼Œç›´æ¥ä½¿ç”¨è¯¥spanåˆ›å»ºchildSpanå°±å¥½äº†ã€‚\nè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€èˆ¬æ¥è¯´åœ¨Goå¼€å‘è¿‡ç¨‹ä¸­æ¨èä½¿ç”¨Contextä½œä¸ºå‡½æ•°è°ƒç”¨çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œopentracingä¹Ÿè€ƒè™‘äº†è¿™ä¸€ç‚¹ï¼Œå¦‚ä¸‹ï¼š å®˜æ–¹æä¾›äº†å¯¹åº”çš„æ–¹æ³•ï¼Œæ¥å¸®åŠ©ä½¿ç”¨è€…æŠŠspanå’Œcontext.Contextä¸€èµ·ä½¿ç”¨ã€‚\n// ContextWithSpan returns a new `context.Context` that holds a reference to // the span. If span is nil, a new context without an active span is returned. func ContextWithSpan(ctx context.Context, span Span) context.Context { if span != nil { if tracerWithHook, ok := span.Tracer().(TracerContextWithSpanExtension); ok { ctx = tracerWithHook.ContextWithSpanHook(ctx, span) } } return context.WithValue(ctx, activeSpanKey, span) } // SpanFromContext returns the `Span` previously associated with `ctx`, or // `nil` if no such `Span` could be found. // // NOTE: context.Context != SpanContext: the former is Go\u0026#39;s intra-process // context propagation mechanism, and the latter houses OpenTracing\u0026#39;s per-Span // identity and baggage information. func SpanFromContext(ctx context.Context) Span { val := ctx.Value(activeSpanKey) if sp, ok := val.(Span); ok { return sp } return nil } åœ¨ä¸­é—´ä»¶é‚£é‡Œï¼Œæˆ‘ä»¬å·²ç»æŠŠ context.Context è®¾ç½®åˆ°äº† gin.Context ä¸­å»äº†ï¼Œå› æ­¤åœ¨åç»­çš„ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒä» gin.Context å–å‡ºå¹¶ä¼ é€’ã€‚\n// traceHdl is a trace handler from HTTP request func traceHdl(c *gin.Context) { // get root Context from request // TODO: try to use c.Request.WithContext() to set context ctx, ok := c.Get(x.GetTraceContextKey()) if !ok { panic(\u0026#34;impossible\u0026#34;) } // ctxåœ¨æœåŠ¡å†…éƒ¨ä¼ é€’ï¼Œctxå«æœ‰spanä¿¡æ¯ if err := clientCall(ctx.(context.Context)); err != nil { c.JSON(http.StatusInternalServerError, gin.H{\u0026#34;message\u0026#34;: err.Error()}) return } // response to client c.JSON(http.StatusOK, gin.H{\u0026#34;message\u0026#34;: \u0026#34;traceHdl done\u0026#34;}) } func clientCall(ctx context.Context) error { // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨äº†gRPCæ¥åšè·¨æœåŠ¡çš„è°ƒç”¨ï¼Œå¯¹äºctxçš„å¤„ç†ï¼Œæ˜¯é€šè¿‡interceptorå®ç°çš„ã€‚ // è¿™éƒ¨åˆ†ä»£ç ä¼šåœ¨åé¢è´´ä¸Šï¼Œä½†æ˜¯é€»è¾‘ä¹Ÿè·Ÿç±»ä¼¼ï¼Œåªæ˜¯å¤šäº†éœ€è¦é€‚é…gRPCæ•°æ®ä¼ é€’çš„è§„åˆ™ã€‚ _, err := serverAConn.PingA(ctx, \u0026amp;pb.PingAReq{ Now: time.Now().Unix(), From: \u0026#34;client\u0026#34;, }) if err != nil { return err } // è¿™é‡Œæ¼”ç¤ºè¿›ç¨‹å†…é“¾è·¯ return processInternalTrace1(ctx) } // internal process trace example 1 func processInternalTrace1(ctx context.Context) error { ctx2, sp := x.StartSpanFromContext(ctx) defer sp.Finish() println(\u0026#34;processInternalTrace1 called\u0026#34;) // do some ops time.Sleep(10 * time.Millisecond) return processInternalTrace2(ctx2) } gRPC interceptor å®ç°å¦‚ä¸‹ï¼šæœåŠ¡ç«¯å·¥ä½œå†…å®¹ç›¸ä¼¼ï¼Œåªæ˜¯ä»injectæ“ä½œå˜æˆäº†extractã€‚\n// client interceptor func OpenTracingClientInterceptor(tracer opentracing.Tracer, optFuncs ...Option) grpc.UnaryClientInterceptor { otgrpcOpts := newOptions() otgrpcOpts.apply(optFuncs...) return func( ctx context.Context,m ethod string, req, resp interface{}, cc *grpc.ClientConn, invoker grpc.UnaryInvoker, opts ...grpc.CallOption, ) error { var err error var parentCtx opentracing.SpanContext if parent := opentracing.SpanFromContext(ctx); parent != nil { parentCtx = parent.Context() } // ... clientSpan := tracer.StartSpan( method, opentracing.ChildOf(parentCtx), ext.SpanKindRPCClient, gRPCComponentTag, ) defer clientSpan.Finish() // æ³¨å…¥ ctx = injectSpanContext(ctx, tracer, clientSpan) // ... // è°ƒç”¨ err = invoker(ctx, method, req, resp, cc, opts...) // ...\treturn err } } func injectSpanContext(ctx context.Context, tracer opentracing.Tracer, clientSpan opentracing.Span) context.Context { md, ok := metadata.FromOutgoingContext(ctx) if !ok { md = metadata.New(nil) } else { md = md.Copy() } mdWriter := metadataReaderWriter{md} err := tracer.Inject(clientSpan.Context(), opentracing.HTTPHeaders, mdWriter) // We have no better place to record an error than the Span itself :-/ if err != nil { clientSpan.LogFields(log.String(\u0026#34;event\u0026#34;, \u0026#34;Tracer.Inject() failed\u0026#34;), log.Error(err)) } return metadata.NewOutgoingContext(ctx, md) } è‡³æ­¤æˆ‘ä»¬å°±ä»‹ç»å®Œäº†ï¼ŒæœåŠ¡é—´ï¼ˆgRPCï¼‰è°ƒç”¨å’ŒæœåŠ¡å†…ï¼ˆcontextï¼‰è°ƒç”¨çš„childSpançš„åˆ›å»ºå’Œä¼ é€’ã€‚\né“¾è·¯Tracerä»å“ªå„¿æ¥ï¼Ÿ # å…ˆè¯´Traceræœ‰ä»€ä¹ˆç”¨ï¼ŒTraceræ˜¯ç”¨æ¥ç®¡ç†Spançš„ç»Ÿç­¹è€…ï¼Œè´Ÿè´£åˆ›å»ºspanå’Œä¼ æ’­spanã€‚\n// Tracerè´Ÿè´£åˆ›å»ºspanå’Œä¼ æ’­span type Tracer interface { // Create, start, and return a new Span with the given `operationName` and // incorporate the given StartSpanOption `opts`. (Note that `opts` borrows // from the \u0026#34;functional options\u0026#34; pattern, per // http://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis) // // A Span with no SpanReference options (e.g., opentracing.ChildOf() or // opentracing.FollowsFrom()) becomes the root of its own trace. // // Examples: // // var tracer opentracing.Tracer = ... // // // The root-span case: // sp := tracer.StartSpan(\u0026#34;GetFeed\u0026#34;) // // // The vanilla child span case: // sp := tracer.StartSpan( // \u0026#34;GetFeed\u0026#34;, // opentracing.ChildOf(parentSpan.Context())) // // // All the bells and whistles: // sp := tracer.StartSpan( // \u0026#34;GetFeed\u0026#34;, // opentracing.ChildOf(parentSpan.Context()), // opentracing.Tag{\u0026#34;user_agent\u0026#34;, loggedReq.UserAgent}, // opentracing.StartTime(loggedReq.Timestamp), // ) // StartSpan(operationName string, opts ...StartSpanOption) Span // Inject() takes the `sm` SpanContext instance and injects it for // propagation within `carrier`. The actual type of `carrier` depends on // the value of `format`. // // OpenTracing defines a common set of `format` values (see BuiltinFormat), // and each has an expected carrier type. // // Other packages may declare their own `format` values, much like the keys // used by `context.Context` (see https://godoc.org/context#WithValue). // // Example usage (sans error handling): // // carrier := opentracing.HTTPHeadersCarrier(httpReq.Header) // err := tracer.Inject( // span.Context(), // opentracing.HTTPHeaders, // carrier) // // NOTE: All opentracing.Tracer implementations MUST support all // BuiltinFormats. // // Implementations may return opentracing.ErrUnsupportedFormat if `format` // is not supported by (or not known by) the implementation. // // Implementations may return opentracing.ErrInvalidCarrier or any other // implementation-specific error if the format is supported but injection // fails anyway. // // See Tracer.Extract(). Inject(sm SpanContext, format interface{}, carrier interface{}) error // Extract() returns a SpanContext instance given `format` and `carrier`. // // OpenTracing defines a common set of `format` values (see BuiltinFormat), // and each has an expected carrier type. // // Other packages may declare their own `format` values, much like the keys // used by `context.Context` (see // https://godoc.org/golang.org/x/net/context#WithValue). // // Example usage (with StartSpan): // // // carrier := opentracing.HTTPHeadersCarrier(httpReq.Header) // clientContext, err := tracer.Extract(opentracing.HTTPHeaders, carrier) // // // ... assuming the ultimate goal here is to resume the trace with a // // server-side Span: // var serverSpan opentracing.Span // if err == nil { // span = tracer.StartSpan( // rpcMethodName, ext.RPCServerOption(clientContext)) // } else { // span = tracer.StartSpan(rpcMethodName) // } // // // NOTE: All opentracing.Tracer implementations MUST support all // BuiltinFormats. // // Return values: // - A successful Extract returns a SpanContext instance and a nil error // - If there was simply no SpanContext to extract in `carrier`, Extract() // returns (nil, opentracing.ErrSpanContextNotFound) // - If `format` is unsupported or unrecognized, Extract() returns (nil, // opentracing.ErrUnsupportedFormat) // - If there are more fundamental problems with the `carrier` object, // Extract() may return opentracing.ErrInvalidCarrier, // opentracing.ErrSpanContextCorrupted, or implementation-specific // errors. // // See Tracer.Inject(). Extract(format interface{}, carrier interface{}) (SpanContext, error) } ä¹‹å‰å·²ç»æåˆ°äº†äº†opentracingæ˜¯ä¸€å¥—æ¥å£ï¼Œé‚£ä¹ˆå…·ä½“çš„å®ç°æ˜¯åœ¨å…¶ä»–çš„å·¥å…·ä¸­å®Œæˆçš„ï¼Œå¦‚jaegerã€‚åˆ›å»ºçš„æ—¶å€™å°±éœ€è¦jaegerçš„æ”¯æŒäº†ï¼Œå¦‚ä¸‹ï¼š\n// ä½¿ç”¨jaegeræ¥åˆ›å»ºä¸€ä¸ªtracerï¼Œå¹¶æ³¨å…¥åˆ°opentracingå…¨å±€ä¸­å» func BootTracerWrapper(localServiceName string, hostPort string) error { tracer, err := xjaeger.BootJaegerTracer(localServiceName, hostPort) if err != nil { return errors.Wrap(err, \u0026#34;BootTracerWrapper.BootZipkinTracer\u0026#34;) } // æ³¨å…¥åˆ°å…¨å±€åï¼Œå°±å¯ä»¥é€šè¿‡ opentracing.GlobalTracer() æ¥ä½¿ç”¨ traceräº† opentracing.SetGlobalTracer(tracer) return nil } func BootJaegerTracer(localServiceName, hostPort string) (opentracing.Tracer, error) { cfg := \u0026amp;config.Configuration{ Sampler: \u0026amp;config.SamplerConfig{ Type: jaeger.SamplerTypeConst, Param: 1, }, ServiceName: localServiceName, // æœåŠ¡å Reporter: \u0026amp;config.ReporterConfig{ LogSpans: true, CollectorEndpoint: _jaegerRecorderEndpoint, }, // é“¾è·¯æœé›†é…ç½® } tracer, _, err := cfg.NewTracer( config.Logger(jaegerlog.StdLogger), config.ZipkinSharedRPCSpan(true), ) if err != nil { return nil, errors.Wrap(err, \u0026#34;BootJaegerTracer\u0026#34;) } return tracer, nil } Traceä¿¡æ¯æ€ä¹ˆä¼ é€’ï¼Ÿ # åœ¨ Child-Spanä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼Ÿ ä¸­æåˆ°äº† Inject, Extract æ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•å°±æ˜¯ç”¨æ¥è¾…åŠ©Traceä¿¡æ¯ä¼ é€’çš„æ–¹æ³•ï¼Œ å…·ä½“çš„å®ç°ä¹Ÿæ˜¯åœ¨jaegerä¸­å®ç°çš„ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ä»£ç ã€‚\né“¾è·¯ä¿¡æ¯å¦‚ä½•æœé›†ï¼Ÿ # åœ¨ #é“¾è·¯Tracerä»å“ªå„¿æ¥ å·²ç»æåˆ°äº†jaegeråœ¨åˆ›å»ºtraceræ—¶å¯ä»¥æŒ‡å®šæœé›†å™¨çš„é…ç½®ï¼Œ å› æ­¤ä¸ŠæŠ¥åŠ¨ä½œä¼šåœ¨jaegerä¸­å®Œæˆï¼Œä½†æ˜¯è¦æ³¨æ„çš„æ˜¯ï¼Œæ˜¾å¼è°ƒç”¨ sp.Finish() æ‰ä¼šè§¦å‘ä¸ŠæŠ¥åŠ¨ä½œã€‚\næ€»ç»“ # æœ€ç»ˆå®æˆ˜ç»“æœæˆªå›¾å¦‚ä¸‹ï¼š å›¾ä¸­åŒ…å«äº†è°ƒç”¨é“¾è·¯å±‚çº§å…³ç³»ï¼Œæ¯ä¸ªç¯èŠ‚çš„è€—æ—¶æƒ…å†µï¼Œè¯·æ±‚çš„å…¥å‚å’Œç»“æœæ•°æ®ï¼ˆå¼‚å¸¸ä¿¡æ¯ï¼Œå¦‚æœ‰ï¼‰ç­‰ã€‚åŒæ—¶è¿˜æ”¯æŒè‡ªå®šä¹‰ï¼ˆTag å’Œ Annotation åŠŸèƒ½ï¼‰ï¼Œ å¦‚æœè¿˜æƒ³è¦æ›´å¤šçš„ä¿¡æ¯ï¼Œé‚£ä¹ˆæ¨èä½¿ç”¨è¿™ä¸¤ä¸ªåŠŸèƒ½ç»„åˆæ¥æ»¡è¶³éœ€æ±‚ã€‚\nå†å¤šçš„æ¡ˆä¾‹å’Œæ–‡æ¡£ï¼Œéƒ½æ²¡æœ‰è‡ªå·±ä¸Šæ‰‹å®è·µçš„æ•ˆæœå¥½ï¼Œå»ºè®®å®é™…è¿è¡Œå¹¶æŸ¥é˜…opentracingæºç ã€‚æ‰€æœ‰çš„ä»£ç å‡å¯åœ¨ https://github.com/yeqown/opentracing-practice ä¸­æ‰¾åˆ°ã€‚\næ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿å‹˜è¯¯æŒ‡æ­£ğŸ™ã€‚\nå‚è€ƒæ–‡çŒ® # https://opentracing.io/docs/overview/ https://github.com/opentracing/opentracing-go https://github.com/uber/jaeger-client-go https://github.com/yeqown/opentracing-practice "},{"id":28,"href":"/2020/04/13/channel-in-Go%E5%B0%8F%E7%BB%93/","title":"Channel in Goå°ç»“","section":"Posts","content":"åœ¨å…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œå¦‚æœæƒ³è¦åœ¨çº¿ç¨‹ä¸­é€šä¿¡ï¼Œæœ€å¸¸ç”¨çš„æ‰‹æ®µæ˜¯å…±äº«å†…å­˜ã€‚ç„¶è€Œè€ƒè™‘åˆ°çº¿ç¨‹å†²çªé—®é¢˜ï¼Œä¸å¾—ä¸è€ƒè™‘åŠ é”ï¼Œä»¥ä¿è¯å¹¶å‘å®‰å…¨ï¼ŒåŠ é”ä¹Ÿä¸€å®šä¼šå¸¦æ¥é¢å¤–çš„å¼€é”€ï¼Œå¯¹æ€§èƒ½äº§ç”Ÿå½±å“ã€‚\nCSPæ¨¡å‹ # åœ¨ Go è¯­è¨€ä¸­ä¹Ÿèƒ½ä½¿ç”¨å…±äº«å†…å­˜åŠ äº’æ–¥é”è¿›è¡Œé€šä¿¡ï¼Œä½†æ˜¯ Go è¯­è¨€æä¾›äº†ä¸€ç§ä¸åŒçš„å¹¶å‘æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯é€šä¿¡é¡ºåºè¿›ç¨‹ï¼ˆCommunicating sequential processesï¼ŒCSPï¼‰1ã€‚Goroutine å’Œ Channel åˆ†åˆ«å¯¹åº” CSP ä¸­çš„å®ä½“å’Œä¼ é€’ä¿¡æ¯çš„åª’ä»‹ï¼ŒGo è¯­è¨€ä¸­çš„ Goroutine ä¼šé€šè¿‡ Channel ä¼ é€’æ•°æ®ã€‚\nä½¿ç”¨ç¤ºä¾‹ # åœ¨ä½¿ç”¨ä¹‹å‰ï¼Œéœ€è¦å¯¹channelæœ‰ä¸ªæ•´ä½“çš„å°è±¡ï¼š\nFIFO (First In First Out) åˆ†ä¸ºæœ‰ç¼“å†²å’Œæ— ç¼“å†²ä¸¤ç§ åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¼šé˜»å¡ï¼ˆæ— ç¼“å†²æ—¶ï¼Œåªæ“ä½œè¯»æˆ–å†™ï¼›æœ‰ç¼“å†²å·²æ»¡æ—¶ï¼Œåªæ“ä½œè¯»æˆ–è€…å†™ï¼‰ æ¥å—è€…å’Œå‘é€è€…éƒ½æ˜¯goroutine å‚è€ƒä¸‹å›¾ï¼š\nfunc main() { // Q: æœ‰ç¼“å†²å’Œæ— ç¼“å†²åœ¨ä½¿ç”¨ä¸Šæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ // ch := make(chan int) // æ— ç¼“å†² ch := make(chan int, 1) // æœ‰ç¼“å†²ï¼Œå¤§å°ä¸º1 // å‘é€ ch \u0026lt;- 1 fmt.Println(\u0026lt;-ch) } æ³¨æ„äº‹é¡¹ # åœ¨ä½¿ç”¨channelæ—¶ï¼Œéœ€è¦æ³¨æ„ä¸€ä¸‹äº‹é¡¹ï¼š\næ“ä½œ\\CHçŠ¶æ€ chä¸ºç©º chå·²å…³é—­ chæ­£å¸¸ å‘é€ ch \u0026lt;- æ­»é” panic æˆåŠŸæˆ–é˜»å¡ æ¥æ”¶ \u0026lt;-ch æ­»é” æˆåŠŸæˆ–ç©ºå€¼ æˆåŠŸæˆ–é˜»å¡ å…³é—­ close(ch) panic panic æˆåŠŸ Q: è¿™é‡Œè€ƒè™‘ä¸‹å¦‚ä½•ä¼˜é›…çš„å…³é—­channel (é¿å…panic)?\n// A: ä»£ç ä¸Šä»å‘é€ç«¯æ§åˆ¶channelçš„å…³é—­ï¼ŒåŒæ—¶ä¸ºäº†é¿å…é‡å¤å…³é—­ï¼Œä½¿ç”¨sync.Onceæ¥ååŠ©ã€‚ // create ch := make(chan int, 233) // sending ch \u0026lt;- 1 // close from sender once.Do(close(ch)) Make è¯¦è§£ # channelé€šè¿‡makeå…³é”®å­—åˆ›å»ºï¼Œå¹¶åˆ†é…ç¼“å†²åŒºå¤§å°ã€‚\n// runtime/chan.go#makechan func makechan(t *chantype, size int) *hchan { elem := t.elem // ... // elem.size * size æ˜¯å¦æº¢å‡º mem, overflow := math.MulUintptr(elem.size, uintptr(size)) if overflow || mem \u0026gt; maxAlloc-hchanSize || size \u0026lt; 0 { panic(plainError(\u0026#34;makechan: size out of range\u0026#34;)) } // Hchan does not contain pointers interesting for GC when elements stored in buf do not contain pointers. // buf points into the same allocation, elemtype is persistent. // SudoG\u0026#39;s are referenced from their owning thread so they can\u0026#39;t be collected. // TODO(dvyukov,rlh): Rethink when collector can move allocated objects. // å¤§æ„æ˜¯æ˜¯è¯´ï¼Œå½“å­˜å‚¨åœ¨bufçš„å…ƒç´ ä¸­ä¸åŒ…å«æŒ‡é’ˆæ—¶ï¼Œgcå¯¹æ­¤ä¸æ„Ÿå…´è¶£ï¼Ÿï¼ˆç•™å‘ï¼‰å› æ­¤æ‰ä¼šå°†bufå’Œhchanåˆ†é…åœ¨åŒä¸€ç‰‡å†…å­˜ç©ºé—´ã€‚ var c *hchan switch { case mem == 0: // æ— ç¼“å†²ï¼ˆåªåˆ†é…hchanï¼‰ c = (*hchan)(mallocgc(hchanSize, nil, true)) c.buf = c.raceaddr() case elem.ptrdata == 0: // ä¸å«æŒ‡é’ˆï¼ˆhchanå’Œç¼“å†²åŒºåœ¨ä¸€èµ·ï¼‰ c = (*hchan)(mallocgc(hchanSize+mem, nil, true)) // bufçš„èµ·å§‹åœ°å€ = åŸºåœ°å€ + hchanç»“æ„ä½“å¤§å°åç§»é‡ c.buf = add(unsafe.Pointer(c), hchanSize) default: // æœ‰ç¼“å†²ï¼Œå«æŒ‡é’ˆï¼ˆhchanå’Œç¼“å†²åŒºä¸åœ¨ä¸€èµ·ï¼‰ c = new(hchan) c.buf = mallocgc(mem, elem, true) } c.elemsize = uint16(elem.size) c.elemtype = elem c.dataqsiz = uint(size) // ... return c } Close è¯¦è§£ # close(ch) å¯ä»¥å…³é—­channelã€‚å·²ç»å…³é—­çš„channelä¸å¯ä»¥å‘é€ï¼Œä¹Ÿä¸èƒ½å†è¢«å…³é—­ï¼Œä½†æ˜¯è¿˜èƒ½æ¥æ”¶ã€‚å¦‚æœç¼“å†²æ•°æ®è¢«å¤„ç†å®Œé‚£ä¹ˆä¼šæ¥å—åˆ°ç©ºå€¼ã€‚\n// runtime/chan.go#closechan func closechan(c *hchan) { if c == nil { // å¦‚æœchannelä¸ºç©ºï¼Œåˆ™ä¼šè§¦å‘panic panic(plainError(\u0026#34;close of nil channel\u0026#34;)) } lock(\u0026amp;c.lock) if c.closed != 0 { // å…³é—­å·²ç»å…³é—­çš„channelï¼Œä¹Ÿä¼šè§¦å‘panic unlock(\u0026amp;c.lock) panic(plainError(\u0026#34;close of closed channel\u0026#34;)) } // ... // è®¾ç½®å·²å…³é—­æ ‡å¿—ä½ c.closed = 1 var glist gList // é‡Šæ”¾æ‰€æœ‰çš„recvqä¸­çš„g for { sg := c.recvq.dequeue() if sg == nil { break } // æ¸…ç©ºæ•°æ® if sg.elem != nil { typedmemclr(c.elemtype, sg.elem) sg.elem = nil } if sg.releasetime != 0 { sg.releasetime = cputicks() } gp := sg.g gp.param = nil // ... glist.push(gp) } // é‡Šæ”¾æ‰€æœ‰çš„sendqä¸­çš„g for { // ... ä¸æ¥å—è€…å¤„ç†ç±»ä¼¼ } unlock(\u0026amp;c.lock) // è®©æ‰€æœ‰çš„è¯»/å†™gå°±ç»ª for !glist.empty() { gp := glist.pop() gp.schedlink = 0 goready(gp, 3) } } Send è¯¦è§£ # å‘channelå‘é€æœ€å¸¸è§çš„å°±æ˜¯å¦‚ä¸‹2ç§æ–¹å¼ï¼š\n// case 1 ch \u0026lt;- val // case 2 select { case ch \u0026lt;- 2: // foo default: // bar } åœ¨ç¼–è¯‘æ—¶éƒ½ä¼šè¢«å˜æˆæˆè°ƒç”¨func chansend(c *hchan, ep unsafe.Pointer, block bool, callerpc uintptr) boolçš„å‡½æ•°ï¼Œä½†æ˜¯ä¸¤è€…åœ¨å¯¹blockçš„èµ‹å€¼ä¸Šå¹¶ä¸ç›¸åŒï¼Œå¦‚ä¸‹ï¼š\n// case 1 func chansend1(c *hchan, elem unsafe.Pointer) { chansend(c, elem, true, getcallerpc()) } // case 2 func selectnbsend(c *hchan, elem unsafe.Pointer) (selected bool) { return chansend(c, elem, false, getcallerpc()) } ä¹Ÿå°±æ˜¯è¯´åœ¨case2ä¸­ï¼Œchannelå‘é€å¹¶ä¸ä¼šé˜»å¡å½“å‰çš„goroutineï¼Œå°±ç®—æ˜¯æ— ç¼“å†²ï¼Œæˆ–è€…ç¼“å†²å·²æ»¡çš„æƒ…å†µã€‚\nå‘é€æœŸé—´å¤„ç†æµç¨‹ï¼Œå¦‚ä¸‹å›¾ï¼š\nRecv è¯¦è§£ # ä»channelä¸­æ¥æ”¶æ•°æ®ï¼Œä¹Ÿæœ‰ä¸¤ç§æ–¹å¼ (æ™®é€šç”¨æ³•å’Œéé˜»å¡ç”¨æ³•)ï¼š\n// case 1 val := \u0026lt;- ch // case 2 select { case val := \u0026lt;- ch: // foo default: // bar } // æ­¤å¤–æ¥æ”¶ï¼Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªå‚æ•°ï¼Œokè¡¨ç¤ºå·²æ¥æ”¶ val, ok := \u0026lt;- ch åœ¨ç¼–è¯‘æ—¶éƒ½ä¼šè¢«å˜æˆæˆè°ƒç”¨func chanrecv(c *hchan, ep unsafe.Pointer, block bool) (selected, received bool)çš„å‡½æ•°ï¼ŒåŒæ ·çš„ä¸¤è€…åœ¨å¯¹blockçš„èµ‹å€¼ä¸Šå¹¶ä¸ç›¸åŒï¼Œå¦‚ä¸‹ï¼š\n// case 1 func chanrecv1(c *hchan, elem unsafe.Pointer) { chanrecv(c, elem, true) } // å¤šè¿”å›å€¼ func chanrecv2(c *hchan, elem unsafe.Pointer) (received bool) { _, received = chanrecv(c, elem, true) return } // case 2 func selectnbrecv(elem unsafe.Pointer, c *hchan) (selected bool) { selected, _ = chanrecv(c, elem, false) return } // å¤šè¿”å›å€¼ func selectnbrecv2(elem unsafe.Pointer, received *bool, c *hchan) (selected bool) { // TODO(khr): just return 2 values from this function, now that it is in Go. selected, *received = chanrecv(c, elem, false) return } ç›¸è¾ƒäºsendåœºæ™¯ï¼Œrecvåœºæ™¯ç¨å¾®å¤æ‚ä¸€äº›ï¼Œä½†æ˜¯å¤§ä½“æµç¨‹ä¸Šä¿æŒä¸€è‡´ï¼Œå¦‚ä¸‹å›¾ï¼š\nç®€å•æ€»ç»“çš„è¯´ï¼Œå°±æ˜¯recvä¸ºäº†å®ç°åœ¨å‘é€è€…é˜»å¡çš„åœºæ™¯ä¸‹çš„FIFOï¼Œåšäº†ç‰¹æ®Šå¤„ç†ã€‚\nä½¿ç”¨åœºæ™¯å’Œæ¨¡å¼ # ä¸‹é¢åˆ—ä¸¾äº†ä¸€äº›æ¯”è¾ƒå¸¸ç”¨çš„channelä½¿ç”¨æ¨¡å¼åŠç›¸å…³åœºæ™¯ã€‚è¿™é‡Œä¸»è¦å‚è€ƒäº†advanced-go-programming-bookã€‚\nå¦‚æœ‰é—æ¼ï¼Œæ•¬è¯·è¡¥å……\nSynchronous # ä¸€èˆ¬æ¥è¯´åœ¨éœ€è¦åŒæ­¥goroutineçš„åœºæ™¯ä¸‹ï¼Œä¼šä½¿ç”¨sync.Mutexæˆ–è€…sync.WaitGroupæ¥åŒæ­¥ã€‚è¿™é‡Œç”¨channelæ¥å®ç°ä¸€ä¸‹goroutineåŒæ­¥ã€‚\nfunc main() { done := make(chan int, 1) go func(){ println(\u0026#34;i\u0026#39;m running\u0026#34;) done \u0026lt;- 1 }() // å¦‚æœæœ‰å¤šä¸ªgoroutine, å¯ä»¥å¯¹doneæ¥æ”¶è®¡æ•°ï¼Œæˆ–è€…æ£€æµ‹goroutineå…³é—­æ¥åˆ¤æ–­åŒæ­¥å®Œæˆ \u0026lt;-done println(\u0026#34;main goroutine done\u0026#34;) } Producer-Consumer # func Producer(ch chan int) { for { ch \u0026lt;- 1 } } func Consumer(ch chan int) { for { v \u0026lt;- ch println(v) } } func main() { ch := make(chan int, 2) go Producer(ch) go Producer(ch) go Consumer(ch) go Consumer(ch) select{} } Pub-Sub # å‘å¸ƒè®¢é˜…ä¸ç”Ÿäº§è€…æ¶ˆè´¹è€…ç±»ä¼¼ï¼Œå”¯ä¸€åŒºåˆ«åœ¨äºå‘å¸ƒè®¢é˜…æ¨¡å‹ä¸­ï¼Œå‘å¸ƒè€…ä¸å…³å¿ƒæœ‰å¤šå°‘ä¸ªè®¢é˜…è€…å³æ¯ä¸ªè®¢é˜…è€…éƒ½åº”è¯¥æ”¶åˆ°æ¶ˆæ¯ï¼Œè€Œåœ¨ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ä¸­ï¼Œæ¶ˆè´¹è€…æ˜¯é›†ç¾¤æ¶ˆè´¹ï¼ˆé›†ç¾¤æ¶ˆè´¹æ˜¯è¯´æ¯ä¸€æ¡æ¶ˆæ¯åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹ï¼‰ã€‚ä½¿ç”¨channelä¹Ÿå¯ä»¥å¾ˆç®€å•çš„å®ç°Pub/Subè¿™ç§æ¨¡å‹:\ntype topic struct{ chPub chan int chSub []chan int bufsize int } func newTopic(bufsize int) *topic { return \u0026amp;topic{ bufsize: bufsize, chPub: make(chan int, bufsize), chSub: make([]chan int, 0, 5), } } // è¿™é‡Œä¸æ˜¯å¹¶å‘å®‰å…¨çš„ï¼ï¼ï¼ func (t *topic) Sub() chan int { ch := make(chan int, t.bufsize) t.chSub = append(t.chSub, ch) return ch } func (t *topic) Pub(v int) { t.chPub \u0026lt;- v // åˆ†å‘ go func() { v2 := \u0026lt;- t.chPub for idx := range t.chSub { t.chSub[idx] \u0026lt;- v2 } }() } // Qï¼šå¦‚ä½•å®ç°topicçš„å…³é—­æ–¹æ³• func main() { topic := newTopic(topic) // å¼€å¯5ä¸ªè®¢é˜… for i := 0; i \u0026lt; 5; i++ { go func() { ch := topic.Sub() for v := range ch { println(\u0026#34;recv topic\u0026#34;, v) } }() } // å‘å¸ƒæ¶ˆæ¯ for v := 10; v \u0026lt; 100; v++{ topic.Pub(v) time.Sleep(100 *time.Millisecond) } } Concurrent Pool # å¹¶å‘æ§åˆ¶ä¹Ÿæ˜¯channelçš„é‡è¦åº”ç”¨åœºæ™¯ï¼Œåˆ©ç”¨channelä¼šé˜»å¡çš„ç‰¹æ€§ï¼Œå¾—ä»¥æ§åˆ¶æœ€å¤§goroutineæ•°ã€‚åœ¨Webåº”ç”¨ä¸­å¯ä»¥ç”¨äºå®ç°é™æµã€‚ä¸‹é¢å®ç°çš„æ–¹å¼ï¼Œç±»ä¼¼ä¸ä»¤ç‰Œæ¡¶ï¼Œå¦å¤–æ¨èä¸€ä¸ªchanpoolçš„å®ç°ä»¥ä¾›å‚è€ƒã€‚\ntype obj int func factory() obj { return \u0026#34;newobj\u0026#34; } type pool struct { ch chan obj } func newpool() pool { p := pool{ ch: make(chan obj, 10), } for i := 0; i \u0026lt; 10; i++ { p.put(obj(i)) } } // éœ€è¦å¢åŠ å¹¶å‘å®‰å…¨ï¼ï¼ï¼ func (p pool) put(obj obj) { p.ch \u0026lt;- obj } // éœ€è¦å¢åŠ å¹¶å‘å®‰å…¨ï¼ï¼ï¼ func (p pool) get() obj { v := \u0026lt;- p.ch return v } func main() { pool := newpool() go func() { for { println(\u0026#34;num of running g:\u0026#34;, runtime.NumGoroutine()) time.Sleep(100 * time.Millisecond) } }() for i := 0; i \u0026lt; 100; i++ { obj := pool.get() go func() { defer pool.put(obj) // do some work time.Sleep(100 *time.Millisecond)\t}() } } // num of running g: 12 // num of running g: 12 // num of running g: 12 // num of running g: 12 // num of running g: 12 // num of running g: 12 // num of running g: 12 // num of running g: 12 // num of running g: 12 // num of running g: 12 æ€»ç»“ # æŒæ¡channelçš„åŸç†ï¼Œèƒ½å¸®åŠ©æˆ‘ä»¬åœ¨å®é™…åº”ç”¨ä¸­å¿«é€Ÿå®šä½å’Œåˆ†æå¹¶å‘å¸¦æ¥çš„é—®é¢˜ã€‚ä¹Ÿèƒ½åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œåˆç†åˆ©ç”¨channelã€‚\næ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿å‹˜è¯¯æŒ‡æ­£ğŸ™ã€‚\nå‚è€ƒ # https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-channel/ https://github.com/golang/go/tree/release-branch.go1.14 https://github.com/eapache/channels https://colobu.com/2018/03/26/channel-patterns/ https://juejin.im/post/5decff136fb9a016544bce67 https://chai2010.cn/advanced-go-programming-book/ch1-basic/ch1-06-goroutine.html "},{"id":29,"href":"/2020/04/02/%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81%E6%9E%B6%E6%9E%84-based-GOIM/","title":"æ¶ˆæ¯æ¨é€æ¶æ„-Based-GOIM","section":"Posts","content":" æœ¬æ–‡çš„é‡ç‚¹ï¼Œä¸»è¦æ¢³ç†äº†GOIMçš„æ¶æ„ï¼Œæ¶ˆæ¯æµè½¬å’Œæ¶ˆæ¯å¤„ç†ã€‚æœ¬æ–‡æ²¡æœ‰æåˆ°Cometçš„å…·ä½“é€»è¾‘ï¼Œå¥—æ¥å­—ç¼–ç¨‹å’ŒRingBufferç­‰ï¼Œä½†æ˜¯Cometçš„å¤æ‚åº¦è¿œé«˜äºå…¶ä»–ä¸¤ä¸ªç½‘å…ƒï¼Œå› æ­¤å¼ºçƒˆå»ºè®®é˜…è¯»Cometæºç ï¼Œåº”è¯¥ä¼šå¯¹Goç½‘ç»œç¼–ç¨‹æœ‰æ›´å¤šè®¤è¯†ã€‚\nGOIM æ˜¯Goå®ç°çš„æ¶ˆæ¯æ¨é€çš„åˆ†å¸ƒå¼æœåŠ¡ï¼Œæ˜“äºæ‰©å®¹ä¼¸ç¼©ï¼Œä½¿ç”¨äº†bilibili/discoveryæ¥æ”¯æŒæœåŠ¡å‘ç°ã€‚ç›¸è¾ƒäºæˆ‘ä¹‹å‰ç”¨Socket.IOåšçš„ä¿¡ä»¤æœåŠ¡ï¼Œä¼˜ç‚¹åœ¨äºæ›´ä¼˜é›…çš„æ‰©å®¹ï¼Œå°†è¿æ¥å±‚å’Œé€»è¾‘å±‚åˆ†ç¦»ï¼ŒèŒè´£æ›´æ¸…æ™°ã€‚å½“ç„¶ç¼ºç‚¹ä¹Ÿæœ‰ï¼ˆæ²¡æœ‰å’Œå…·ä½“å®ç°è§£è€¦ï¼Œå¦‚MQçš„é€‰å‹ï¼Œå¯¼è‡´ä¸å¤Ÿçµæ´»ï¼›å®¢æˆ·ç«¯éå…¨åŒå·¥é€šä¿¡ï¼ŒTCPåˆ©ç”¨ç‡åä½ï¼Œè¿™ç‚¹å¹¶ä¸å…¨æ˜¯ç¼ºç‚¹ï¼Œå¥½å¤„æ˜¯ï¼šæ¶ˆæ¯æµè½¬æ¸…æ™°ï¼ŒèŒè´£éå¸¸æ˜ç¡®ï¼‰ï¼Œè¿™éƒ¨åˆ†å¯ä»¥è‡ªå·±åšå®šåˆ¶ï¼ˆæœ€åçš„å‚è€ƒæ–‡çŒ®2ä¸­è®²å¾ˆå¤šï¼‰ã€‚\næ¶æ„å›¾ # æ€»çš„æ¥è¯´ï¼Œæ•´ä¸ªåº”ç”¨çš„æ¶æ„å¦‚ä¸‹\nè¿™é‡Œçœç•¥äº†å…¶ä¸­ç”¨äºæœåŠ¡å‘ç°çš„â€œbilibili/discoveryâ€ã€‚åœ¨æ•´ä¸ªGOIMä¸­ç”¨åˆ°æœåŠ¡å‘ç°çš„ä¸»è¦æ˜¯gRPCå’Œæ¶ˆæ¯æ¨é€å…³ç³»æŸ¥æ‰¾ã€‚\nå¦‚ä¸Šå›¾ï¼š\nCometè´Ÿè´£å»ºç«‹å’Œç»´æŒå®¢æˆ·ç«¯çš„é•¿è¿æ¥ï¼› Jobè´Ÿè´£æ¶ˆæ¯çš„åˆ†å‘ï¼› Logicæä¾›ä¸‰ç§çº¬åº¦çš„æ¶ˆæ¯ï¼ˆå…¨å±€ï¼ŒROOMï¼Œç”¨æˆ·ï¼‰æŠ•é€’ï¼Œè¿˜åŒ…æ‹¬ä¸šåŠ¡é€»è¾‘ï¼ŒSessionç®¡ç†ã€‚ æ¶ˆæ¯æµè½¬ # ä»ä¸Šè¿°çš„æ¶æ„å›¾ä¸­å¯ä»¥çŸ¥é“ï¼Œæ¶ˆæ¯æ˜¯é€šè¿‡HTTPè°ƒç”¨Logicäº§ç”Ÿçš„ï¼Œç„¶åç”¨MQæ¥ä¸­è½¬ï¼ˆå­˜å‚¨ï¼Œå‰Šå³°ï¼‰ï¼›æ¯ä¸ªJobæˆå‘˜éƒ½ä»ç»™é˜Ÿåˆ—ä¸­æ¶ˆè´¹æ¶ˆæ¯ï¼ŒæŠ•é€’ç»™ä¸€ä¸ªæˆ–è€…å¤šä¸ªCometï¼Œç”±Cometå°†æ¶ˆæ¯å‘é€ç»™å®¢æˆ·ç«¯ã€‚\nç”Ÿæˆæ¶ˆæ¯ # ç›®å‰åœ¨Githubä¸Šçš„GOIMç‰ˆæœ¬ï¼Œæ¶ˆæ¯ï¼ˆé™¤é‰´æƒ/å¿ƒè·³ç­‰åŸºç¡€æ•°æ®åŒ…å¤–ï¼‰ç”Ÿæˆéƒ½æ˜¯ç”±Logicå®Œæˆç¬¬ä¸€æ‰‹å¤„ç†ï¼ŒLogicæä¾›äº†HTTPæ¥å£ä»¥æ”¯æŒæ¶ˆæ¯å‘é€èƒ½åŠ›ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªçº¬åº¦ï¼šç”¨æˆ·ï¼Œæˆ¿é—´ï¼Œå…¨åº”ç”¨å¹¿æ’­ï¼Œå¦‚ä¸‹ï¼š\ncurl -d \u0026#39;mid message\u0026#39; http://api.goim.io:3111/goim/push/mids?operation=1000\u0026amp;mids=123 curl -d \u0026#39;room message\u0026#39; http://api.goim.io:3111/goim/push/room?operation=1000\u0026amp;type=live\u0026amp;room=1000 curl -d \u0026#39;broadcast message\u0026#39; http://api.goim.io:3111/goim/push/all?operation=1000 åœ¨LogicæœåŠ¡ä¸­ä¼šé€šè¿‡å¤„ç†ï¼Œå°†æ¶ˆæ¯å¤„ç†æˆ**é™„#æ¶ˆæ¯æ ¼å¼#ä»»åŠ¡é˜Ÿåˆ—æ¶ˆæ¯**çš„æ ¼å¼ï¼Œç„¶åæŠ•é€’åˆ°MQä¸­ã€‚å…¶ä¸­ä¸‰ç§çº¬åº¦çš„æ¶ˆæ¯å¤„ç†ç¨æœ‰ä¸åŒï¼š\nç”¨æˆ·\n// goim/internal/logic/push.go // mid =\u0026gt; []PushMsg{op, server, keys, msg} func (l *Logic) PushMids(c context.Context, op int32, mids []int64, msg []byte) (err error) { // æ ¹æ®ç”¨æˆ·IDè·å–æ‰€æœ‰çš„ key:server å¯¹åº”å…³ç³»ï¼›åœ¨redisä¸­æ˜¯ä¸€ä¸ªhash keyServers, _, err := l.dao.KeysByMids(c, mids) // ... keys := make(map[string][]string) for key, server := range keyServers { // ... keys[server] = append(keys[server], key) } for server, keys := range keys { // é€šè¿‡DAOç»„è£…PushMsgæŠ•é€’ç»™MQ if err = l.dao.PushMsg(c, op, server, keys, msg); err != nil { return } } return } æˆ¿é—´ æ²¡ä»€ä¹ˆç‰¹åˆ«çš„å¤„ç†\n// goim/internal/logic/push.go func (l *Logic) PushRoom(c context.Context, op int32, typ, room string, msg []byte) (err error) { return l.dao.BroadcastRoomMsg(c, op, model.EncodeRoomKey(typ, room), msg) } // // goim/internal/logic/dao func (d *Dao) BroadcastRoomMsg(c context.Context, op int32, room string, msg []byte) (err error) { pushMsg := \u0026amp;pb.PushMsg{ Type: pb.PushMsg_ROOM, Operation: op, Room: room, Msg: msg, } b, err := proto.Marshal(pushMsg) // ... if err := d.nsqProducer.Publish(d.c.Nsq.Topic, b); err != nil { log.Errorf(\u0026#34;PushMsg.send(push pushMsg:%v) error(%v)\u0026#34;, pushMsg, err) } return } å¹¿æ’­ æ²¡ä»€ä¹ˆç‰¹åˆ«çš„å¤„ç†\n// goim/internal/logic/push.go func (l *Logic) PushAll(c context.Context, op, speed int32, msg []byte) (err error) { return l.dao.BroadcastMsg(c, op, speed, msg) } // goim/internal/logic/dao func (d *Dao) BroadcastMsg(c context.Context, op, speed int32, msg []byte) (err error) { pushMsg := \u0026amp;pb.PushMsg{ Type: pb.PushMsg_BROADCAST, Operation: op, Speed: speed, // è¿™é‡Œéœ€è¦å»åˆ°Jobæ‰çŸ¥é“speedçš„å…·ä½“åŠŸæ•ˆ Msg: msg, } b, err := proto.Marshal(pushMsg) if err != nil { return } if err := d.nsqProducer.Publish(d.c.Nsq.Topic, b); err != nil { log.Errorf(\u0026#34;PushMsg.send(push pushMsg:%v) error(%v)\u0026#34;, pushMsg, err) } return } å°ç»“ï¼š\né’ˆå¯¹ç”¨æˆ·å•å‘æ—¶ï¼Œä¼šè·å–åˆ°å…·ä½“çš„severå’Œkeysç»„è£…åˆ°PushMsg æˆ¿é—´æ¶ˆæ¯ï¼Œæ²¡æœ‰serverå’Œkeys, ä½†æ˜¯å¤šä¸€ä¸ªroomæ˜¯é€šè¿‡typå’ŒroomIDç»„è£…è€Œæˆçš„ â€œlive://1000â€ å¹¿æ’­æ¶ˆæ¯ï¼Œé™¤äº†æ¶ˆæ¯ä½“ä¹‹å¤–ï¼Œå¦å¤–æœ‰ä¸€ä¸ªspeedå­—æ®µ ä¼ è¾“æ¶ˆæ¯ # ç”±Logicå¤„ç†å¥½çš„æ¶ˆæ¯ä¼šæ”¾åœ¨MQä¸­ï¼ŒJobä»»åŠ¡ä¼šè‡ªåŠ¨æ¶ˆè´¹æ¶ˆæ¯ï¼Œç„¶åé€šè¿‡gRPCè°ƒç”¨Cometå•å…ƒã€‚ç›¸æ¯”å…¶ä»–ä¸¤ä¸ªç½‘å…ƒï¼ŒJobå°±ç®€å•å¤šäº†ã€‚ä»MQä¸­æ¶ˆè´¹åˆ°æ¶ˆæ¯åä¼šè°ƒç”¨c.job.push(ctx, pushMsg)ã€‚\n// job å‘é€æ¶ˆæ¯ï¼ˆæ™®é€šæ¶ˆæ¯ï¼Œæˆ¿é—´æ¶ˆæ¯ï¼Œå¹¿æ’­ï¼‰ func (j *Job) push(ctx context.Context, pushMsg *pb.PushMsg) (err error) { switch pushMsg.Type { case pb.PushMsg_PUSH: err = j.pushKeys(pushMsg.Operation, pushMsg.Server, pushMsg.Keys, pushMsg.Msg) case pb.PushMsg_ROOM: // è·å–ä¸€ä¸ªjobä¸­çš„Roomç¼“å­˜ï¼Œç”¨äºæˆ¿é—´å†…â€œå®šæ—¶ï¼Œå®šé‡â€å‘é€æ¶ˆæ¯ï¼Œå‡å°‘è¯·æ±‚æ¬¡æ•° // è¿™é‡Œè°ƒç”¨çš„Pushå¹¶ä¸ä¼šç«‹å³å‘é€ï¼Œè€Œæ˜¯æ”¾åœ¨Room.protoè¿™ä¸ªchannelä¸­ // å®é™…æ”¾æ¾æ˜¯ç”±Room.pushprocæ¥å®šæ—¶ err = j.getRoom(pushMsg.Room).Push(pushMsg.Operation, pushMsg.Msg) case pb.PushMsg_BROADCAST: err = j.broadcast(pushMsg.Operation, pushMsg.Msg, pushMsg.Speed) default: err = fmt.Errorf(\u0026#34;no match push type: %s\u0026#34;, pushMsg.Type) } return } // æ ¹æ®serverIDå‘é€ç»™ç‰¹å®šçš„CometæœåŠ¡ï¼Œé¿å…å¹¿æ’­ // cometServers æ˜¯ç”±discoveryæœåŠ¡å‘ç°ç»´æŠ¤çš„cometåˆ—è¡¨ã€‚ func (j *Job) pushKeys(operation int32, serverID string, subKeys []string, body []byte) (err error) { buf := bytes.NewWriterSize(len(body) + 64) p := \u0026amp;comet.Proto{ Ver: 1, Op: operation, Body: body, } p.WriteTo(buf) p.Body = buf.Buffer() p.Op = comet.OpRaw var args = comet.PushMsgReq{ Keys: subKeys, ProtoOp: operation, Proto: p, } if c, ok := j.cometServers[serverID]; ok { if err = c.Push(\u0026amp;args); err != nil { log.Errorf(\u0026#34;c.Push(%v) serverID:%s error(%v)\u0026#34;, args, serverID, err) } log.Infof(\u0026#34;pushKey:%s comets:%d\u0026#34;, serverID, len(j.cometServers)) } return } // å¤„ç†æˆä¸€ä¸ªBroadcastReq,å¹¶å¹¿æ’­ç»™æ‰€æœ‰çš„Comet func (j *Job) broadcast(operation int32, body []byte, speed int32) (err error) { // ... ä¸pushKeysä¸€è‡´ï¼Œç”Ÿæˆä¸€ä¸ªp comets := j.cometServers // å¦‚ speed = 64, len(comets) = 2, speed = 32 speed /= int32(len(comets)) var args = comet.BroadcastReq{ ProtoOp: operation, Proto: p, Speed: speed, // æ˜¯è¢«ä¼ é€’ç»™Cometå¤„ç†ï¼Œç»§ç»­è·Ÿè¸ª } for serverID, c := range comets { if err = c.Broadcast(\u0026amp;args); err != nil { log.Errorf(\u0026#34;c.Broadcast(%v) serverID:%s error(%v)\u0026#34;, args, serverID, err) } } log.Infof(\u0026#34;broadcast comets:%d\u0026#34;, len(comets)) return } æˆ¿é—´æ¶ˆæ¯å¤„ç†ï¼š\ngetRoom(roomID) -\u0026gt; room.Push() -\u0026gt; p -\u0026gt; room.proto | | ---\u0026gt; NewRoom(batch, duration) | |--------------------------------------------| | ---\u0026gt; go room.pushproc() -\u0026gt; p \u0026lt;- room.proto | // goim/internal/job/room.go type Room struct { c *conf.Room // å…³äºæˆ¿é—´çš„é…ç½® job *Job // ç»‘å®šjobï¼Œä¸ºäº†è¿½æº¯Roomæ‰€å±çš„Job id string // æˆ¿é—´ID proto chan *comet.Proto // æœ‰ç¼“å†²channel } // pushproc merge proto and push msgs in batch. // é»˜è®¤batch = 20, sigTime = 1s func (r *Room) pushproc(batch int, sigTime time.Duration) { var ( n int last time.Time p *comet.Proto buf = bytes.NewWriterSize(int(comet.MaxBodySize)) // 4096B = 4KB ) // è®¾ç½®äº†ä¸€ä¸ªå®šæ—¶å™¨,åœ¨ä¸€å®šæ—¶é—´åå¾€room.protoæ”¾é€ä¸€ä¸ªroomReadyProtoä¿¡å·ã€‚ td := time.AfterFunc(sigTime, func() { select { case r.proto \u0026lt;- roomReadyProto: default: } }) defer td.Stop() for { if p = \u0026lt;-r.proto; p == nil { // å¦‚æœåˆ›å»ºäº†roomï¼Œä½†æ˜¯è¯»åˆ°ç©ºåŒ… break // exit } else if p != roomReadyProto { // è¯»å–room.proto å¦‚æœæ˜¯æ­£å¸¸çš„æ•°æ®åŒ…ï¼Œåˆ™åˆå¹¶åˆ°bufä¸­å»,å¦‚æœæ»¡äº†æ€ä¹ˆåŠï¼Ÿ p.WriteTo(buf) // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªæ•°æ®åŒ…ï¼Œåˆ™é‡ç½®å®šæ—¶å™¨ï¼Œå¹¶ç»§ç»­è¯»å–åç»­æ•°æ®åŒ… if n++; n == 1 { last = time.Now() td.Reset(sigTime) continue } else if n \u0026lt; batch { // åç»­çš„æ•°æ®åŒ…ï¼Œä¸ä¼šé‡ç½®å®šæ—¶å™¨ï¼Œä½†æ˜¯å¦‚æœæ—¶é—´ä»åœ¨ç¬¬ä¸€ä¸ªæ•°æ®åŒ…çš„ sigTime æ—¶é—´é—´éš”å†… // ç®€å•è¯´ï¼Œå®šæ—¶å™¨è¿˜æ²¡åˆ°æ—¶é—´ if sigTime \u0026gt; time.Since(last) { continue } } // ç´¯è®¡çš„æ•°æ®åŒ…æ•°é‡å·²ç»è¶…è¿‡äº†batch, æ‰§è¡Œå‘é€åŠ¨ä½œ } else { // å®šæ—¶å™¨åˆ°è¯»åˆ°äº†roomReadyProto // å¦‚æœbufå·²ç»è¢«é‡ç½®äº†ï¼Œåˆ™è·³å‡ºå¾ªç¯æ‰§è¡Œæ¸…ç†åŠ¨ä½œï¼›å¦åˆ™æ‰§è¡Œå‘é€æ¶ˆæ¯\tif n == 0 { break } } // å‘é€æˆ¿é—´å†…çš„æ¶ˆæ¯ _ = r.job.broadcastRoomRawBytes(r.id, buf.Buffer())\tbuf = bytes.NewWriterSize(buf.Size()) n = 0 // å¦‚æœé…ç½®äº†æˆ¿é—´æœ€å¤§é—²ç½®æ—¶é—´ï¼Œåˆ™é‡æ–°è®¾å®šå®šæ—¶å™¨ // ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ¿é—´è¢«åˆ›å»ºåï¼Œå¤„ç†å®Œäº†è¯¥æˆ¿é—´çš„æ¶ˆæ¯ï¼Œå¹¶ä¸æ˜¯ç›´æ¥è·³å‡ºå¾ªç¯æ¸…ç†æˆ¿é—´ // è€Œæ˜¯ï¼Œä¼šé˜»å¡ç­‰å¾…ä¸‹ä¸€æ¬¡çš„æ¶ˆæ¯å†æ¥ï¼Œå¦‚æœåœ¨ â€œ1m / r.c.Idleâ€ æ—¶é—´å†…æ²¡æœ‰æ¥ï¼Œåˆ™ä¼šè·³å‡ºå¾ªç¯æ¸…ç†æ‰è¯¥æˆ¿é—´ // å¦‚æœåœ¨ â€œ1m / r.c.Idleâ€ å†…æœ‰æ¶ˆæ¯ï¼Œåˆ™ä¼šé‡æ–°è®¾å®šå®šæ—¶å™¨ä¸ºsigTimeï¼Œå¹¶ä¸ºprotoè®¡æ•° if r.c.Idle != 0 { td.Reset(time.Duration(r.c.Idle)) // é»˜è®¤15åˆ†é’Ÿ } else { td.Reset(time.Minute) } } // æ¸…ç†åŠ¨ä½œ r.job.delRoom(r.id) } æ€»ç»“å¦‚ä¸‹å›¾ï¼š\nå°ç»“ï¼š\né’ˆå¯¹ç”¨æˆ·å•å‘æ—¶ï¼Œä¼šç›´æ¥å‘é€åˆ°å¯¹åº”çš„cometæœåŠ¡ï¼Œæ ¹æ®keyå†å»ç»™ç‰¹å®šçš„channelå‘é€æ¶ˆæ¯ æˆ¿é—´æ¶ˆæ¯ï¼Œè¿™ä¸ªä¼šç‰¹æ®Šä¸€äº›ï¼ŒJobæŒæœ‰ä¸€ä¸ªç‰¹æ®Šçš„Roomç»“æ„ï¼Œç”¨äºåˆå¹¶å‘é€åˆ°è¯¥æˆ¿é—´çš„æ¶ˆæ¯ï¼Œå®šæ—¶å®šé‡å‘é€æˆ¿é—´æ¶ˆæ¯ï¼ˆå¥½å¤„æ˜¯ï¼Œå‡å°‘äº†gRPCè°ƒç”¨æ¬¡æ•°é™ä½ç³»ç»Ÿè´Ÿè½½ï¼Œç¼ºç‚¹å¢åŠ æ—¶æ¶ˆæ¯å»¶è¿Ÿï¼‰ å¹¿æ’­æ¶ˆæ¯ï¼Œå°†æ¶ˆæ¯å°è£…åˆ°BroadcastPushReqä¸­ï¼Œç„¶åç›´æ¥å‘é€ç»™æ‰€æœ‰çš„Comet æŠ•é€’æ¶ˆæ¯ # Cometæ¥æ”¶åˆ°Jobå•å…ƒçš„gRPCè°ƒç”¨ä¹‹åï¼Œä¼šå°†æ¶ˆæ¯é€šè¿‡Websocketå¥—æ¥å­—æŒ‰ç…§GOIMçº¦å®šçš„åè®®æ ¼å¼å‘é€ç»™æŒ‡å®šå®¢æˆ·ç«¯ã€‚ä»Jobé‚£è¾¹ä¼ è¾“è¿‡æ¥çš„æ¶ˆæ¯ï¼Œä¾æ—§æ˜¯åˆ†ä¸ºç”¨æˆ·æ¶ˆæ¯ï¼Œæˆ¿é—´æ¶ˆæ¯ï¼Œå…¨å±€æ¶ˆæ¯ã€‚è¿™é‡Œå¾—å…ˆè¯´æ˜ä¸‹Cometæ˜¯å¦‚ä½•ç®¡ç†ç”¨æˆ·ç«¯çš„é•¿è¿æ¥ï¼Œå¦‚ä¸‹å›¾ï¼š\nBucketæ˜¯åœ¨ä¸€ä¸ªç®¡ç†Channelå’ŒRoomçš„æ•°æ®ç»“æ„ï¼Œå®ƒçš„ä½œç”¨åœ¨äºä½¿ç”¨äº†hashæ¥å°†Channelåšåˆ†ç‰‡ç®¡ç†ï¼Œç›¸è¾ƒäºé›†ä¸­ç®¡ç†ï¼Œè¿™æ ·channelåˆ†å¸ƒåœ¨ä¸åŒçš„bucketä¸­è€Œä¸æ˜¯ä¸€ä¸ªmapï¼Œå¯ä»¥é™ä½å†²çªï¼Œå‡å°é”çš„ç²’åº¦ã€‚\næœ‰äº†ä¸Šè¿°ç»“æ„ï¼Œé‚£ä¹ˆæ¶ˆæ¯å‘é€åœ¨å¿½ç•¥ä¼ è¾“å±‚çš„æƒ…å†µä¸‹ï¼š\né’ˆå¯¹ç”¨æˆ·å•å‘\nè°ƒç”¨é“¾è·¯ä¸ºï¼šcomet.Bucket(key).Channel(key).Push(proto)ï¼Œè¿™é‡ŒPushä¹Ÿåªæ˜¯å°†protoæ”¾åœ¨äº†channelçš„é˜Ÿåˆ—ä¸­ï¼ˆ10ç¼“å†²ï¼‰ï¼Œæ¶ˆæ¯çš„ä¸‹å‘åœ¨goim/internal/comet/server_websocket.go#dispatchWebsocketã€‚\næˆ¿é—´æ¶ˆæ¯\nåœ¨Cometå†…éƒ¨éå†Bucketså¹¶è°ƒç”¨Bucket.BroadcastRoom()ï¼Œä½†æ˜¯è¿™é‡Œä¹Ÿåªæ˜¯æŠŠæ¶ˆæ¯æ”¾åˆ°äº†â€œæŸå¤„â€ï¼Œå¹¶æ²¡æœ‰ç›´æ¥å‘é€ã€‚å®é™…å‘é€ä»£ç åœ¨goim/internal/comet/bucket.go#roomprocã€‚\n// BroadcastRoom broadcast a message to specified room func (b *Bucket) BroadcastRoom(arg *grpc.BroadcastRoomReq) { // è¿™é‡Œå–æ¨¡é€‰ä¸­ä¸€ä¸ªgoroutineæ¥æ‰§è¡Œä»»åŠ¡ num := atomic.AddUint64(\u0026amp;b.routinesNum, 1) % b.c.RoutineAmount // b.routines æ˜¯ b.c.RoutineAmount æ•°é‡çš„ æœ‰ b.c.RoutineSize ç¼“å†²å¤§å°çš„ chan *grpc.BroadcastRoomReq b.routines[num] \u0026lt;- arg } // åœ¨åˆ›å»ºBucketæ—¶ï¼Œä¾¿å¼€å¯äº†goroutineæ¥å¤„ç† func (b *Bucket) roomproc(c chan *grpc.BroadcastRoomReq) { for { arg := \u0026lt;-c if room := b.Room(arg.RoomID); room != nil { room.Push(arg.Proto) } } } // éå†æˆ¿é—´å†…çš„channelçš„é“¾è¡¨ï¼Œå°†æ¶ˆæ¯æ”¾åˆ°channelçš„å‘é€é˜Ÿåˆ—ä¸­ï¼Œåˆå›åˆ°äº†channelæ¶ˆæ¯å•å‘çš„é€»è¾‘ã€‚ func (r *Room) Push(p *grpc.Proto) { r.rLock.RLock() for ch := r.next; ch != nil; ch = ch.Next { _ = ch.Push(p) } r.rLock.RUnlock() } å¹¿æ’­æ¶ˆæ¯\nåœ¨Cometå†…éƒ¨éå†Bucketså¹¶å‘Bucketä¸­çš„æ‰€æœ‰Channelå‘é€æ¶ˆæ¯ã€‚è¿™é‡Œç»ˆäºç”¨åˆ°äº†speedï¼Œä¸Šæ–‡æåˆ°è¿‡ï¼Œå¦‚æœè®¾å®šspeed = 64ï¼Œ len(comets) = 2, é‚£ä¹ˆè¿™é‡Œç”¨åˆ°çš„ speed = 32ã€‚\n// Broadcast broadcast msg to all user. func (s *server) Broadcast(ctx context.Context, req *pb.BroadcastReq) (*pb.BroadcastReply, error) { if req.Proto == nil { return nil, errors.ErrBroadCastArg } go func() { for _, bucket := range s.srv.Buckets() { bucket.Broadcast(req.GetProto(), req.ProtoOp) if req.Speed \u0026gt; 0 { //è¯¥bucket // æœ‰0ä¸ªchannelæ—¶ï¼Œt = 0 / 32 = 0 // æœ‰2ä¸ªchannelæ—¶, t = 2 / 32 = 0.0625 // æœ‰32ä¸ªchannelæ—¶, t = 32 / 32 = 1 // æœ‰64ä¸ªchannelæ—¶ï¼Œt = 64 / 32 = 2 // ç”±æ­¤å¯å¾—ï¼Œï¼ˆcometï¼‰speed çš„å«ä¹‰æ˜¯ æ¯ä¸ªbucketæ¯ç§’æœ€å¤šå‘é€çš„æ¶ˆæ¯æ•°é‡ t := bucket.ChannelCount() / int(req.Speed) time.Sleep(time.Duration(t) * time.Second) } } }() return \u0026amp;pb.BroadcastReply{}, nil } // å¹¿æ’­ï¼Œç›´æ¥ä»bucket.chsä¸­éå† func (b *Bucket) Broadcast(p *grpc.Proto, op int32) { var ch *Channel b.cLock.RLock() for _, ch = range b.chs { // å¦‚æœä¸åœ¨è¯¥channelçš„ç›‘å¬é˜Ÿåˆ—ä¸­ï¼Œé‚£ä¹ˆè¯¥æ¶ˆæ¯ä¸ä¼šå‘ç»™è¯¥å®¢æˆ·ç«¯ // è¿™ä¸ªç›‘å¬é˜Ÿåˆ—ï¼Œæ˜¯åœ¨å»ºç«‹è¿æ¥æ˜¯å‘é€çš„ â€œacceptsâ€ å­—æ®µä¸­å–å¾—çš„ // è­¬å¦‚accpets = [1000, 1001, 1002], ä½†æ˜¯op = 1003ï¼Œ é‚£ä¹ˆå°±ä¸ä¼šå‘é€ // // å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªopæ˜¯ä»BroadcastReq.ProtoOpå–å¾—ï¼ŒBroadcastReq.ProtoOpåˆæ˜¯ä»pushMsg.Operationå–å¾— // ä¹Ÿå°±æ˜¯è¯´ op = grpc.BroadcastReq.ProtoOp = proto.Op = PushMsg.Operation = ä»å‘é€æ¶ˆæ¯æ¥å£äº§ç”Ÿã€‚ // if !ch.NeedPush(op) { continue } _ = ch.Push(p) } b.cLock.RUnlock() } å°ç»“ï¼š\né’ˆå¯¹ç”¨æˆ·å•å‘æ—¶ï¼Œç›´æ¥åˆ©ç”¨keyå®šä½åˆ°Bucketå’ŒChannelï¼Œå°†æ¶ˆæ¯æ”¾åˆ°é˜Ÿåˆ—ä¸­ã€‚ æˆ¿é—´æ¶ˆæ¯ï¼Œå°†æ¶ˆæ¯åˆ†é…åˆ°æˆ¿é—´åç¨‹ä¹‹ä¸€çš„é˜Ÿåˆ—ä¸­ï¼Œåœ¨è¯¥åç¨‹ä¸­ä¼šæŒç»­ä¸æ–­çš„æ¶ˆè´¹æ¶ˆè´¹æ¶ˆæ¯å¹¶å¤„ç†ï¼Œå¤„ç†åŠ¨ä½œæ˜¯å°†æ¶ˆæ¯åˆ†å‘åˆ°Channelçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆbuffered chanï¼‰ä¸Šã€‚ å¹¿æ’­æ¶ˆæ¯ï¼Œç›´æ¥ä½¿ç”¨äº†bucketçš„chséå†ï¼Œæ¥ä¸ºæ¯ä¸€ä¸ªChannelæ¨é€ä¸€æ¡æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸Šã€‚ é™„ # è¿™é‡Œä¼šå±•ç¤ºGOIMä¸­å¿…è¦çš„æ•°æ®ç»“æ„ï¼Œå¸®åŠ©ç†è§£GOIMä¸­çš„æ•°æ®æµè½¬è¿‡ç¨‹ã€‚ è¿™é‡Œä¼šå‡ºç°å‡ ä¸ªåè¯ï¼š\nserver: cometæœåŠ¡çš„hostname (string) mid: ç”¨æˆ·åœ¨ä¸šåŠ¡ä¸­çš„ID (int64) key: ç”¨æˆ·åœ¨GOIMä¸­çš„å”¯ä¸€ID (string) Sessionç»“æ„ # Sessionç”±Redisç®¡ç†ï¼Œç»´æŒäº†å®¢æˆ·ç«¯MIDï¼ŒServerï¼ŒKeyçš„å…³ç³»ï¼Œè¿™éƒ¨åˆ†æ˜¯åœ¨Logicä¸­gRPCæœåŠ¡çš„Connectæ–¹æ³•ä¸­è®¾ç½®ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n// goim/internal/logic/conn.go func (l *Logic) Connect(c context.Context, server, cookie string, token []byte) (mid int64, key, roomID string, accepts []int32, hb int64, err error) { var params struct { Mid int64 `json:\u0026#34;mid\u0026#34;` // ç”¨æˆ·ID Key string `json:\u0026#34;key\u0026#34;` // å®¢æˆ·ç«¯æ ‡è¯†åˆ«ï¼Œå¦‚æœä¸ºç©ºåˆ™è‡ªåŠ¨ç”ŸæˆUUID RoomID string `json:\u0026#34;room_id\u0026#34;` // å®¢æˆ·ç«¯åŠ å…¥æˆ¿é—´ Platform string `json:\u0026#34;platform\u0026#34;`// å®¢æˆ·ç«¯æ‰€åœ¨å¹³å° Accepts []int32 `json:\u0026#34;accepts\u0026#34;` // ç›‘å¬æˆ¿é—´ } if err = json.Unmarshal(token, \u0026amp;params); err != nil { log.Errorf(\u0026#34;json.Unmarshal(%s) error(%v)\u0026#34;, token, err) return } mid = params.Mid roomID = params.RoomID accepts = params.Accepts hb = int64(l.c.Node.Heartbeat) * int64(l.c.Node.HeartbeatMax) if key = params.Key; key == \u0026#34;\u0026#34; { key = uuid.New().String() } if err = l.dao.AddMapping(c, mid, key, server); err != nil { log.Errorf(\u0026#34;l.dao.AddMapping(%d,%s,%s) error(%v)\u0026#34;, mid, key, server, err) } log.Infof(\u0026#34;conn connected key:%s server:%s mid:%d token:%s\u0026#34;, key, server, mid, token) return } // goim/internal/logic/dao/redis.go // func (d *Dao) AddMapping(c context.Context, mid int64, key, server string) (err error) { // ... if mid \u0026gt; 0 { if err = conn.Send(\u0026#34;HSET\u0026#34;, keyMidServer(mid), key, server); err != nil { log.Errorf(\u0026#34;conn.Send(HSET %d,%s,%s) error(%v)\u0026#34;, mid, server, key, err) return } if err = conn.Send(\u0026#34;EXPIRE\u0026#34;, keyMidServer(mid), d.redisExpire); err != nil { log.Errorf(\u0026#34;conn.Send(EXPIRE %d,%s,%s) error(%v)\u0026#34;, mid, key, server, err) return } // ... } if err = conn.Send(\u0026#34;SET\u0026#34;, keyKeyServer(key), server); err != nil { log.Errorf(\u0026#34;conn.Send(HSET %d,%s,%s) error(%v)\u0026#34;, mid, server, key, err) return } if err = conn.Send(\u0026#34;EXPIRE\u0026#34;, keyKeyServer(key), d.redisExpire); err != nil { log.Errorf(\u0026#34;conn.Send(EXPIRE %d,%s,%s) error(%v)\u0026#34;, mid, key, server, err) return } // ... } ä»AddMappingæ–¹æ³•ä¸­ï¼Œæ€»ç»“ä¸‹å¾—åˆ°ï¼š\nå¦‚æœ(mid=1, key=69dafe8b58066478aea48f3d0f384820,server=comet.001) mid_1 = {69dafe8b58066478aea48f3d0f384820: comet.001} key_69dafe8b58066478aea48f3d0f384820 = \u0026quot;comet.001\u0026quot; ä¹Ÿå°±æ˜¯è¯´ï¼ŒåŒä¸€ä¸ªç”¨æˆ·å¯ä»¥åœ¨å¤šä¸ªåœ°æ–¹åŒæ—¶è¿å…¥ç³»ç»Ÿï¼›åŒæ—¶ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼ŒSessionç®¡ç†å¹¶ä¸åŒ…æ‹¬ç”¨æˆ·æ‰€åœ¨çš„æˆ¿é—´ï¼Œç”¨æˆ·éœ€è¦æ¥å—å“ªäº›æˆ¿é—´çš„æ¶ˆæ¯ï¼Œè¿™éƒ¨åˆ†æ˜¯åœ¨æ˜¯åœ¨Logic.Connectå¤„ç†å¥½äº†ä¹‹åé€šè¿‡gRPCå“åº”ï¼Œäº¤ç»™Cometå¤„ç†çš„ã€‚\n// goim/internal/comet/server_websocket.go func (s *Server) ServeWebsocket(conn net.Conn, rp, wp *bytes.Pool, tr *xtime.Timer) { // ... if p, err = ch.CliProto.Set(); err == nil { if ch.Mid, ch.Key, rid, accepts, hb, err = s.authWebsocket(ctx, ws, p, req.Header.Get(\u0026#34;Cookie\u0026#34;)); err == nil { ch.Watch(accepts...) // ç›‘å¬æˆ¿é—´åˆ—è¡¨ b = s.Bucket(ch.Key) // æ ¹æ®ç”¨æˆ·keyé€‰æ‹©ä¸€ä¸ªbucket (å¯¹keyåšcityhashå†å–æ¨¡) err = b.Put(rid, ch) // å°†ç”¨æˆ·IDå’Œè¿æ¥Channelç»´æŠ¤åˆ°Bucketä¸­ if conf.Conf.Debug { log.Infof(\u0026#34;websocket connnected key:%s mid:%d proto:%+v\u0026#34;, ch.Key, ch.Mid, p) } } } // ... } // auth for goim handshake with client, use rsa \u0026amp; aes. func (s *Server) authWebsocket(ctx context.Context, ws *websocket.Conn, p *grpc.Proto, cookie string) (mid int64, key, rid string, accepts []int32, hb time.Duration, err error) { for { if err = p.ReadWebsocket(ws); err != nil { return } if p.Op == grpc.OpAuth { break } else { log.Errorf(\u0026#34;ws request operation(%d) not auth\u0026#34;, p.Op) } } // rid roomID if mid, key, rid, accepts, hb, err = s.Connect(ctx, p, cookie); err != nil { return } p.Op = grpc.OpAuthReply p.Body = nil if err = p.WriteWebsocket(ws); err != nil { return } err = ws.Flush() return } æ¶ˆæ¯æ ¼å¼ # 1 - ä»»åŠ¡é˜Ÿåˆ—æ¶ˆæ¯ï¼š\nä¸ç®¡æ˜¯ä¸ªäººæ¶ˆæ¯ï¼Œè¿˜æ˜¯æˆ¿é—´æ¶ˆæ¯å’Œå¹¿æ’­æ¶ˆæ¯ï¼Œéƒ½æ˜¯ç”¨çš„å¦‚ä¸‹ç»“æ„ï¼›å…¶ä¸­Opå’ŒTypeå¯ä»¥å¸®åŠ©Jobå•å…ƒå¯ä»¥é’ˆå¯¹æ¶ˆæ¯ä¸Šåšå·®å¼‚åŒ–çš„å¤„ç†ã€‚\ntype PushMsg struct { Type PushMsg_Type // æ¶ˆæ¯ç±»å‹ï¼Œä¸ªäººï¼Œæˆ¿é—´å¹¿æ’­ï¼Œå¹¿æ’­ Operation int32 // æŒ‡ä»¤ goim/api/comet/grpc/operation.go Speed int32 // å¹¿æ’­æ—¶ç”¨ TODO: Server string // Cometçš„Hostname, ä¸ªäººæ¶ˆæ¯æ—¶æŒ‡å®š Room string // æˆ¿é—´å· Keys []string // bucket key Msg []byte // æ¶ˆæ¯ä½“ } 2 - GOIMæ¶ˆæ¯åè®®ï¼š\nåŒºåˆ«äºä»»åŠ¡é˜Ÿåˆ—æ¶ˆæ¯ï¼Œè¿™ä¸ªæ¡æ¶ˆæ¯æ˜¯å®¢æˆ·ç«¯å®é™…æ”¶åˆ°çš„æ¶ˆæ¯ï¼ˆå¯¹æ¯”å¯ä»¥å‘ç°ï¼Œå…¶ä¸­åªæœ‰Opå’ŒBodyæ˜¯ä»Logicå•å…ƒä¼ é€’è¿‡æ¥çš„ï¼Œå…¶ä»–å­—æ®µå¾ˆå¤§ä¸€éƒ¨åˆ†ç”¨äºåˆ†æµï¼ˆå®šä½Comet/Bucket/Room/Channelï¼‰ï¼Œæˆ–è€…ç³»ç»Ÿå­—æ®µç”¨äºå·®å¼‚åŒ–å¤„ç†æ¶ˆæ¯ï¼‰ï¼š\ntype Proto struct { Ver int32 // ç‰ˆæœ¬å· Op int32 // æ¶ˆæ¯ç±»å‹ï¼Œå¦‚Pingï¼ŒPong, Text Seq int32 // åºåˆ—å· TODO: Body []byte // æ¶ˆæ¯ä½“ ç­‰äº PushMsg.Msg } æœåŠ¡å‘ç° # æœåŠ¡å‘ç°å¯ä»¥å¸®åŠ©æ•´ä¸ªåº”ç”¨å‘ç°Cometå•å…ƒå’ŒLogicå•å…ƒï¼Œè€ŒJobå•å…ƒå¹¶ä¸éœ€è¦æ³¨å†Œè‡ªå·±ï¼ˆä¸éœ€è¦è¢«å‘ç°ï¼‰ã€‚å½“ç„¶å¯ä»¥æ²¡æœ‰æœåŠ¡å‘ç°åŠŸèƒ½ï¼Œç›´æ¥åœ¨ä»£ç å’Œé…ç½®ä¸­é…ç½®å¥½ï¼ˆComet/Logicï¼‰æœåŠ¡åœ°å€ï¼Œä½†æ˜¯ä¹Ÿå°±å¤±å»äº†åŠ¨æ€æ‰©å®¹çš„èƒ½åŠ›ã€‚å¦å¤–ï¼Œå¦‚æœæ˜¯K8Séƒ¨ç½²ï¼Œè¿™é‡Œçš„æœåŠ¡å‘ç°åŠŸèƒ½å°±æœ‰ç‚¹å†—ä½™äº†ï¼Œå› æ­¤éœ€è¦åšä¸€äº›è°ƒæ•´å†ç”¨K8Séƒ¨ç½²ï¼Œè°ƒæ•´åŒ…æ‹¬ï¼ˆæœåŠ¡æ³¨å†Œå’Œå‘ç°æŠ½è±¡å³äºdiscoveryç»“è€¦ï¼Œå¯é€‰å¼€å¯ï¼›å¯¹äºCometçš„gRPCè°ƒç”¨ï¼Œåœ¨é’ˆå¯¹ç”¨æˆ·å•å‘æ¶ˆæ¯æ—¶ï¼Œéœ€è¦ä»å®šå‘å•æ’­å˜æˆå¹¿æ’­ï¼‰ã€‚\næ€»ç»“ # GOIMå°†æ•´ä¸ªåº”ç”¨èŒè´£ï¼Œåˆ†é…ç»™ä¸‰ä¸ªå•ä¸ªç‹¬ç«‹ç½‘å…ƒæ¥æ‰¿æ‹…ç›¸åº”çš„å·¥ä½œï¼Œè®©æµç¨‹æ›´æ¸…æ™°ï¼Œåº”ç”¨ä¹Ÿæ˜“äºæ‰©å±•ï¼ˆåŠ¨æ€ï¼‰ã€‚ åœ¨ç”¨æˆ·å’Œé•¿è¿æ¥çš„æ˜ å°„ä¸Šï¼Œä½¿ç”¨äº†Keyæ¥åŒºåˆ«åº”ç”¨ç”¨æˆ·å’Œä¸šåŠ¡ç”¨æˆ·ï¼Œå¾—ä»¥æ”¯æŒå•ä¸ªç”¨æˆ·åŒæ—¶ç™»é™†ï¼ˆå¤šå¹³å°ï¼‰çš„åœºæ™¯ï¼›å¦å¤–keyä¹Ÿä½œä¸ºäº†Cometç½‘å…ƒå®šä½ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†ï¼›åˆ©ç”¨äº†bucket + cityhashæ¥é™ä½ç«äº‰ï¼ŒåŠ é€Ÿç”¨æˆ·å®šä½å¹¶å‘é€æ¶ˆæ¯ã€‚ åœ¨æˆ¿é—´æ¶ˆæ¯çš„å¤„ç†ä¸Šï¼Œå‡ºäºæ¶ˆæ¯é¢‘ç¹å’Œä¸šåŠ¡åœºæ™¯çš„è€ƒè™‘ï¼šåœ¨Jobä¸Šä¸ºæˆ¿é—´æ¶ˆæ¯å¢åŠ äº†æ•°æ®åŒ…åˆå¹¶æœºåˆ¶ï¼›åœ¨Cometå±‚ä¸ºæ¯ä¸€ä¸ªBucketéƒ½åˆ›å»ºäº†ä¸€å®šæ•°é‡çš„goroutineæ¥æŒç»­å¤„ç†æˆ¿é—´æ¶ˆæ¯ã€‚è¿™ä¸¤ä¸ªåŠ¨ä½œï¼Œéƒ½èƒ½æé«˜æ•´ä¸ªåº”ç”¨å¯¹äºæˆ¿é—´æ¶ˆæ¯å¤„ç†èƒ½åŠ›ï¼Œæå‡ååé‡ã€‚ ä»Jobç«¯å°†æ¶ˆæ¯åˆ†å‘åˆ°Cometæ—¶ï¼Œé™¤äº†å•ä¸ªç”¨æˆ·çš„æ¶ˆæ¯èƒ½å¤ŸæŒ‡å®šCometä»¥å¤–ï¼Œå…¶ä»–çš„æ¶ˆæ¯éƒ½åªèƒ½å¹¿æ’­ç»™æ‰€æœ‰çš„Cometå¤„ç†ã€‚ æ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿å‹˜è¯¯æŒ‡æ­£ğŸ™ã€‚\nå‚è€ƒæ–‡æ¡£ # https://github.com/Terry-Mao/goim https://juejin.im/post/5cd12fa16fb9a0320b40ec32 "},{"id":30,"href":"/2020/03/29/redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/","title":"Redisä¸»ä»å¤åˆ¶","section":"Posts","content":"redisä¸»ä»å¤åˆ¶æ˜¯é«˜å¯ç”¨æ–¹æ¡ˆä¸­çš„ä¸€éƒ¨åˆ†ï¼Œé‚£ä¸»ä»å¤åˆ¶æ˜¯å¦‚ä½•è¿›è¡Œçš„ï¼Ÿåˆæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿæ€ä¹ˆæ”¯æ’‘äº†redisçš„é«˜å¯ç”¨æ€§ï¼Ÿåœ¨ä¸»ä»æ¨¡å¼ä¸‹Masterå’ŒSlaveèŠ‚ç‚¹åˆ†åˆ«åšäº†å“ªäº›äº‹æƒ…ï¼Ÿ\nredisé«˜å¯ç”¨æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿ # æˆ‘ç†è§£çš„redisé«˜å¯ç”¨çš„ç‰¹ç‚¹æœ‰ï¼š\né«˜QPSï¼Œä¸»ä» =\u0026gt; è¯»å†™åˆ†ç¦» é«˜å®¹é‡ï¼Œé›†ç¾¤åˆ†ç‰‡ =\u0026gt; é«˜å®¹é‡ æ•…éšœè½¬ç§»ï¼Œsentinel =\u0026gt; æ•…éšœè½¬ç§» æ•…éšœæ¢å¤ï¼Œæ•°æ®æŒä¹… =\u0026gt; æ•…éšœæ¢å¤ ï½ è¿™é‡Œæˆ‘ç®€å•çš„ç†è§£ï¼ˆRDB + AOFï¼‰= æ•…éšœæ¢å¤ ä¸»ä»å¤åˆ¶ # redis ä¸»ä»å¤åˆ¶æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼šæ—§ç‰ˆï¼ˆVer2.8-ï¼‰ï¼Œæ–°ç‰ˆï¼ˆVer2.8+ï¼Œå¢åŠ PSYNCå‘½ä»¤æ¥è§£å†³æ—§ç‰ˆä¸­çš„é—®é¢˜ï¼‰\nè®¨è®ºå¤åˆ¶æ—¶éƒ½éœ€è¦è€ƒè™‘ä¸¤ç§åœºæ™¯ï¼š\nåœºæ™¯1ï¼šä»èŠ‚ç‚¹åˆšåˆšä¸Šçº¿ï¼Œéœ€è¦å»åŒæ­¥ä¸»èŠ‚ç‚¹æ—¶ï¼Œè¿™éƒ¨åˆ†å¯ä»¥ç†è§£ä¸º å…¨é‡å¤åˆ¶ã€‚ åœºæ™¯2ï¼šä»èŠ‚ç‚¹æ‰çº¿ï¼Œæ¢å¤ä¸Šçº¿åéœ€è¦åŒæ­¥æ•°æ®ï¼Œä½¿è‡ªå·±å’Œä¸»èŠ‚ç‚¹è¾¾åˆ°ä¸€è‡´çŠ¶æ€ã€‚è¿™éƒ¨åˆ†åœ¨æ—§ç‰ˆå¤åˆ¶é‡Œç­‰ä»·äºå…¨é‡å¤åˆ¶ï¼Œåœ¨æ–°ç‰ˆé‡Œå¯ä»¥ç†è§£ä¸ºå¢é‡å¤åˆ¶ã€‚ å½“ç„¶ä½ è‚¯å®šä¼šæƒ³åˆ°å¦‚æœä¸»èŠ‚ç‚¹æ‰çº¿ï¼Œè¿™æ—¶å€™ä¼šæ€ä¹ˆæ ·ï¼Ÿè¿™ä¸ªåœºæ™¯å½“ç„¶ä¹Ÿåœ¨redisé«˜å¯ç”¨æ–¹æ¡ˆä¸­ï¼Œä¹‹æ—¶ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œå±äºSentinelæœºåˆ¶çš„å†…å®¹äº†ã€‚\næ—§ç‰ˆä¸»ä»å¤åˆ¶ # å‰æ–‡è¯´è¿‡äº†ï¼Œæ—§ç‰ˆä¸»ä»å¤åˆ¶åªæœ‰å…¨é‡å¤åˆ¶ç”¨äºåº”ä»˜ä¸Šè¿°ä¸¤ä¸ªåœºæ™¯ï¼Œå› æ­¤ä¸‹é¢çš„æµç¨‹ä¹Ÿåªæœ‰ä¸€ä»½ï¼š\nä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘é€syncå‘½ä»¤ã€‚ ä¸»æœåŠ¡å™¨åœ¨æ”¶åˆ°syncå‘½ä»¤ä¹‹åï¼Œè°ƒç”¨bgsaveå‘½ä»¤ç”Ÿæˆæœ€æ–°çš„rdbæ–‡ä»¶ï¼Œå°†è¿™ä¸ªæ–‡ä»¶åŒæ­¥ç»™ä»æœåŠ¡å™¨ï¼Œè¿™æ ·ä»æœåŠ¡å™¨è½½å…¥è¿™ä¸ªrdbæ–‡ä»¶ä¹‹åï¼ŒçŠ¶æ€å°±ä¼šå’Œä¸»æœåŠ¡å™¨æ‰§è¡Œbgsaveå‘½ä»¤æ—¶å€™çš„ä¸€è‡´ã€‚ ä¸»æœåŠ¡å™¨å°†ä¿å­˜åœ¨å‘½ä»¤ç¼“å†²åŒºä¸­çš„å†™å‘½ä»¤åŒæ­¥ç»™ä»æœåŠ¡å™¨ï¼Œä»æœåŠ¡å™¨æ‰§è¡Œè¿™äº›å‘½ä»¤ï¼Œè¿™æ ·ä»æœåŠ¡å™¨çš„çŠ¶æ€å°±è·Ÿä¸»æœåŠ¡å™¨å½“å‰çŠ¶æ€ä¸€è‡´äº†ã€‚ å¦‚æœä½ ä¸çŸ¥é“redisä¸­è¿˜æœ‰ä¸ªç¼“å†²åŒºçš„è¯ï¼Œå»ºè®®ç³»ç»Ÿçš„äº†è§£ä¸‹redisä¸­ç¼“å†²åŒºçš„è®¾è®¡ã€‚è¿™é‡Œç¼“å†²åŒºç‰¹æŒ‡å‘½ä»¤ç¼“å†²åŒºï¼Œåé¢è¿˜ä¼šè®²åˆ°å¤åˆ¶ç¼“å†²åŒºã€‚\nä½†æ˜¯è¿™æ ·çš„å®ç°åœ¨ åœºæ™¯2 ä¸‹çš„ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼šå¦‚æœè¯´ä»èŠ‚ç‚¹æ–­çº¿åè¿…é€Ÿä¸Šçº¿ï¼Œè¿™æ®µæ—¶é—´å†…çš„äº§ç”Ÿçš„å†™å‘½ä»¤å¾ˆå°‘ï¼Œå´è¦å…¨é‡å¤åˆ¶ä¸»åº“çš„æ•°æ®ï¼Œä¼ è¾“äº†å¤§é‡é‡å¤æ•°æ®ã€‚\nSYNCå‘½ä»¤äº§ç”Ÿçš„æ¶ˆè€—ï¼š 1. ä¸»èŠ‚ç‚¹ç”ŸæˆRDBï¼Œéœ€è¦æ¶ˆè€—å¤§é‡çš„CPUï¼Œå†…å­˜å’Œç£ç›˜IO 2. ç½‘ç»œä¼ è¾“å¤§é‡å­—èŠ‚æ•°æ®ï¼Œéœ€è¦æ¶ˆè€—ä¸»ä»æœåŠ¡å™¨çš„ç½‘ç»œèµ„æº 3. ä»èŠ‚ç‚¹éœ€è¦ä»RDBæ–‡ä»¶æ¢å¤ï¼Œä¼šé€ æˆé˜»å¡æ— æ³•æ¥å—å®¢æˆ·ç«¯è¯·æ±‚ ä¼˜ç‚¹å°±æ˜¯ï¼šç®€å•æš´åŠ›ã€‚ä¸ªäººçœ‹æ¥åœ¨redisæ¶æ„ä¸­ä¸åˆé€‚çš„ç”¨æ³•ï¼Œä¸ä»£è¡¨è¯´å®é™…åœºæ™¯ä¸­ä¹Ÿä¸€å®šä¸åˆé€‚ï¼Œç®€å•æš´åŠ›ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ä¼˜ç‚¹ã€‚\næ–°ç‰ˆä¸»ä»å¤åˆ¶ # æ–°ç‰ˆçš„ä¸»ä»å¤åˆ¶è·Ÿæ—§ç‰ˆçš„åŒºåˆ«å°±åœ¨äºï¼šå¯¹åœºæ™¯2çš„ä¼˜åŒ–ã€‚\nåœºæ™¯2çš„ç¼ºç‚¹ä¸Šæ–‡å·²ç»æåˆ°è¿‡äº†ï¼Œé‚£ä¹ˆä¼˜åŒ–çš„æ–¹å‘å°±æ˜¯**â€œå°½é‡ä¸ä½¿ç”¨å…¨é‡å¤åˆ¶ï¼›å¢åŠ å¢é‡å¤åˆ¶(PSYNC)çš„åŠŸèƒ½â€**ã€‚ä¸ºæ­¤è¿˜è¦è§£å†³ä¸‹åˆ—é—®é¢˜ï¼š\nå¦‚æœæŸä¸ªä»èŠ‚ç‚¹æ–­çº¿äº†ï¼Œé‡æ–°ä¸Šçº¿è¯¥ä»èŠ‚ç‚¹å¦‚ä½•çŸ¥é“è‡ªå·±æ˜¯å¦åº”è¯¥å…¨é‡è¿˜æ˜¯å¢é‡å¤åˆ¶å‘¢ï¼Ÿ è¯¥ä»èŠ‚ç‚¹æ–­çº¿æ¢å¤åï¼Œåˆæ€ä¹ˆçŸ¥é“è‡ªå·±ç¼ºå¤±äº†å“ªäº›æ•°æ®å‘¢ï¼Ÿ ä¸»èŠ‚ç‚¹åˆå¦‚ä½•è¡¥å¿è¯¥ä»èŠ‚ç‚¹åœ¨æ–­çº¿æœŸé—´ä¸¢å¤±çš„é‚£éƒ¨åˆ†æ•°æ®å‘¢ï¼Ÿæ—§ç‰ˆçš„å¤åˆ¶é™¤äº†RDBï¼Œè¿˜æœ‰ä»å‘½ä»¤ç¼“å†²åŒºä¸­çš„å†™å‘½ä»¤æ¥ä¿æŒæ•°æ®ä¸€è‡´ã€‚ ä¸ºæ­¤æ–°ç‰ˆä¸­ä½¿ç”¨äº†ä»¥ä¸‹æ¦‚å¿µï¼š\nè¿è¡ŒID - runid # æ¯ä¸ªredisæœåŠ¡å™¨éƒ½æœ‰å…¶runidï¼Œrunidç”±æœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶è‡ªåŠ¨ç”Ÿæˆï¼Œä¸»æœåŠ¡å™¨ä¼šå°†è‡ªå·±çš„runidå‘é€ç»™ä»æœåŠ¡å™¨ï¼Œè€Œä»æœåŠ¡å™¨ä¼šå°†ä¸»æœåŠ¡å™¨çš„runidä¿å­˜èµ·æ¥ã€‚ä»æœåŠ¡å™¨redisæ–­çº¿é‡è¿ä¹‹åè¿›è¡ŒåŒæ­¥æ—¶ï¼Œå°±æ˜¯æ ¹æ®runidæ¥åˆ¤æ–­åŒæ­¥çš„è¿›åº¦ï¼š\nå¦‚æœå‰åä¸¤æ¬¡ä¸»æœåŠ¡å™¨runidä¸€è‡´ï¼Œåˆ™è®¤ä¸ºè¿™ä¸€æ¬¡æ–­çº¿é‡è¿è¿˜æ˜¯ä¹‹å‰å¤åˆ¶çš„ä¸»æœåŠ¡å™¨ï¼Œä¸»æœåŠ¡å™¨å¯ä»¥ç»§ç»­å°è¯•éƒ¨åˆ†åŒæ­¥æ“ä½œã€‚ å¦‚æœå‰åä¸¤æ¬¡ä¸»æœåŠ¡å™¨runidä¸ç›¸åŒï¼Œåˆ™å…¨åŒæ­¥æµç¨‹ã€‚ å¤åˆ¶åç§»é‡ - offset # ä¸»ä»èŠ‚ç‚¹ï¼Œåˆ†åˆ«ä¼šç»´æŠ¤ä¸€ä¸ªå¤åˆ¶åç§»é‡ï¼š ä¸»æœåŠ¡å™¨æ¯æ¬¡å‘ä»æœåŠ¡å™¨åŒæ­¥äº†Nå­—èŠ‚æ•°æ®ä¹‹åï¼Œå°†ä¿®æ”¹è‡ªå·±çš„å¤åˆ¶åç§»é‡+Nã€‚ä»æœåŠ¡å™¨æ¯æ¬¡ä»ä¸»æœåŠ¡å™¨åŒæ­¥äº†Nå­—èŠ‚æ•°æ®ä¹‹åï¼Œå°†ä¿®æ”¹è‡ªå·±çš„å¤åˆ¶åç§»é‡+Nã€‚é€šè¿‡å¯¹æ¯”ä¸»ä»èŠ‚ç‚¹çš„åç§»é‡å¾ˆå®¹æ˜“å°±å¯ä»¥å‘ç°ï¼Œä¸»ä»èŠ‚ç‚¹æ˜¯å¦å¤„äºä¸€è‡´çŠ¶æ€ã€‚\nå¤åˆ¶ï¼ˆç§¯å‹ï¼‰ç¼“å†²åŒº - copybuffer # ä¸€ä¸ªå›ºå®šé•¿åº¦ï¼ˆå¯é…ç½®ï¼‰çš„FIFOé˜Ÿåˆ—ï¼Œé»˜è®¤å¤§å° = 1MBï¼›é¢„æµ‹å€¼ = second * write_size_per_secondã€‚å½“ä»èŠ‚ç‚¹é‡æ–°è¿ä¸Šä¸»èŠ‚ç‚¹æ—¶å€™ï¼Œä»èŠ‚ç‚¹ä¼šé€šè¿‡PSYNCå‘½ä»¤å°†è‡ªå·±çš„å¤åˆ¶åç§»é‡ï¼ˆoffsetï¼‰å‘é€ç»™ä¸»æœåŠ¡å™¨ï¼Œä¸»èŠ‚ç‚¹ä¼šæ ¹æ®åç§»é‡ä¼šåˆ¤æ–­è¯¥æ‰§è¡Œä½•ç§åŒæ­¥ï¼š\nå¦‚æœä»èŠ‚ç‚¹offsetä¹‹åçš„æ•°æ®ä»ç„¶å­˜åœ¨å¤åˆ¶ç¼“å†²åŒºä¸­ï¼Œå°±æ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥ã€‚ åä¹‹ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œé‚£ä¹ˆæ‰§è¡Œå®Œå…¨é‡åŒæ­¥ã€‚ å› ä¸ºå¤åˆ¶ç¼“å†²åŒºä¸å¯èƒ½æ— é™å¤§ï¼Œå› æ­¤ä¸ºäº†å°½å¯èƒ½å¤šçš„åˆ©ç”¨éƒ¨åˆ†é‡åŒæ­¥ï¼Œéœ€è¦é’ˆå¯¹çœŸå®åœºæ™¯ä¼°ç®—å‡ºæœ€åˆé€‚çš„å¤åˆ¶ç¼“å†²åŒºå¤§å°ã€‚\nè‡³æ­¤ï¼Œredisæ–°ç‰ˆPSYNCé€šè¿‡ä¸Šè¿°æ¦‚å¿µå’Œæµç¨‹ï¼Œè§£å†³äº†åœºæ™¯2ä¸‹æ—§ç‰ˆå¤åˆ¶ä¸­çš„èµ„æºæµªè´¹é—®é¢˜ï¼Œæµç¨‹å›¾å’Œç¤ºä¾‹å›¾è§ä¸‹æ–‡ã€‚\nç¤ºä¾‹å›¾å¦‚ä¸‹ï¼ŒABCDå››ä¸ªä»èŠ‚ç‚¹ï¼Œå…¶ä¸­Aæ‰§è¡Œéƒ¨åˆ†ä¸­åŒæ­¥ï¼ŒDæ‰§è¡Œäº†å®Œæ•´é‡åŒæ­¥ã€‚\næ€»ç»“ # æ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿å‹˜è¯¯æŒ‡æ­£ğŸ™ã€‚\nå‚è€ƒæ–‡çŒ® # ã€Šredisè®¾è®¡ä¸å®ç°ã€‹ https://zhuanlan.zhihu.com/p/65712373 "},{"id":31,"href":"/2020/01/21/gin%E6%BA%90%E7%A0%81%E7%AE%80%E8%A6%81%E5%88%86%E6%9E%90/","title":"Ginæºç ç®€è¦åˆ†æ","section":"Posts","content":" æ¦‚è¿° # é€šè¿‡æ—¥å¸¸å¯¹ginåœºæ™¯å‡ºå‘ï¼Œæ·±å…¥æºç ï¼Œæ€»ç»“ä»‹ç»ginçš„æ ¸å¿ƒè®¾è®¡ã€‚åŒ…å«ï¼šEngine / HandlerFunc / RouterGroup(Router) / Contextã€‚åœ¨æ—¥å¸¸ä½¿ç”¨ä¸­å¸¸è§çš„å°±ä»¥ä¸Šæ¦‚å¿µï¼Œæ±‡æ€»å¦‚ä¸‹ï¼š\næ¦‚å¿µ è§£é‡Š åº”ç”¨æ„ä¹‰ Engine å¼•æ“ web serverçš„åŸºç¡€æ”¯æŒï¼Œä¹Ÿæ˜¯æœåŠ¡çš„å…¥å£ å’Œ æ ¹çº§æ•°æ®ç»“æ„ RouterGroup(Router) è·¯ç”± ç”¨äºæ”¯æŒgin,RESTè·¯ç”±ç»‘å®šå’Œè·¯ç”±åŒ¹é…çš„åŸºç¡€ï¼Œæºäºradix-treeæ•°æ®ç»“æ„æ”¯æŒ HandlerFunc å¤„ç†å‡½æ•° é€»è¾‘å¤„ç†å™¨å’Œä¸­é—´ä»¶å®ç°çš„å‡½æ•°ç­¾å Context ä¸Šä¸‹æ–‡ å°è£…äº†è¯·æ±‚å’Œå“åº”çš„æ“ä½œï¼Œä¸ºHandlerFuncçš„å®šä¹‰å’Œä¸­é—´ä»¶æ¨¡å¼æä¾›æ”¯æŒ ä»DEMOå¼€å§‹ # type barForm struct { Foo string `form:\u0026#34;foo\u0026#34; binding:\u0026#34;required\u0026#34;` Bar int `form:\u0026#34;bar\u0026#34; binding:\u0026#34;required\u0026#34;` } func (fooHdl FooHdl) Bar(c *gin.Context) { var bform = new(barForm) if err := c.ShouldBind(bform); err != nil { // true: parse form error return } // handle biz logic and generate response structure // c (gin.Context) methods could called to support process-controling c.JSON(http.StatusOK, resp) // c.String() alse repsonse to client } // mountRouters . func mountRouters(engi *gin.Engine) { // use middlewares engi.Use(gin.Logger()) engi.Use(gin.Recovery()) // mount routers group := engi.Group(\u0026#34;/v1\u0026#34;) { fooHdl := demohtp.New() group.GET(\u0026#34;/foo\u0026#34;, fooHdl.Bar) group.GET(\u0026#34;/echo\u0026#34;, fooHdl.Echo) // subGroup := group.Group(\u0026#34;/subg\u0026#34;) // subGroup.GET(\u0026#34;/hdl1\u0026#34;, fooHdl.SubGroupHdl1) // æœ€ç»ˆè·¯ç”±ï¼š\u0026#34;targetURI = /v1/subg/hdl1\u0026#34; } } func main() { engi := gin.New() mountRouters(engi) if err := engi.Run(\u0026#34;:8080\u0026#34;); err != nil { log.Fatalf(\u0026#34;engi exit with err=%v\u0026#34;, err) } } é€šè¿‡ä¸Šè¿°çš„ä»£ç å°±ç®€å•å¼€å¯äº†ä¸€ä¸ªgin serverï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº†å¸¸è§çš„ï¼šè·¯ç”±æ³¨å†Œï¼Œä¸­é—´ä»¶æ³¨å†Œï¼Œè·¯ç”±åˆ†ç»„ï¼ŒæœåŠ¡å¯åŠ¨ã€‚æ ¸å¿ƒæ¦‚å¿µä¹Ÿå°±æ˜¯åˆšåˆšåœ¨ä¸Šæ–‡æåˆ°çš„é‚£å››ä¸ªæ¦‚å¿µã€‚æ¦‚è§ˆæµç¨‹å¦‚ä¸‹å›¾ï¼š\nå¯ä»¥å‚ç…§DEMOä¸­çš„æ–¹æ³•ååœ¨å›¾ä¸­æ£€ç´¢æ”¹æµç¨‹ã€‚\nEngine # // Engine is the framework\u0026#39;s instance, it contains the muxer, middleware and configuration settings. type Engine struct { // è·¯ç”±ç®¡ç† RouterGroup // çœç•¥éå…³å¿ƒå±æ€§ // ... // context pooï¼Œæ”¯æŒcontextå¤ç”¨ï¼Œå‡å°‘å¯¹è±¡åˆ›å»ºæé«˜æ€§èƒ½ã€‚ pool sync.Pool // []methodTreeæ–¹æ³•æ ‘æ ¹èŠ‚ç‚¹é›†åˆ è¿™éƒ¨åˆ†åœ¨è·¯ç”±éƒ¨åˆ†ä¼šè¯¦ç»†ä»‹ç» trees methodTrees } Engineæ˜¯æ ¹å…¥å£ï¼Œå®ƒæŠŠRouterGroupç»“æ„å›¾ä½“åµŒå…¥è‡ªèº«ï¼Œä»¥è·å¾—äº†Groupï¼ŒGETï¼ŒPOSTç­‰è·¯ç”±ç®¡ç†æ–¹æ³•ã€‚ä» Runæ–¹æ³•çš„ä»£ç ï¼š\nå› ä¸ºç›´æ¥å¤åˆ¶ä»£ç å¤ªå¤šäº†ï¼Œæ¨èä¸‹è½½æºç æ¥è·³è½¬ï¼Œæ›´ä¾¿æ·é«˜æ•ˆã€‚\nfunc (engine *Engine) Run(addr ...string) (err error) { defer func() { debugPrintError(err) }() address := resolveAddress(addr) debugPrint(\u0026#34;Listening and serving HTTP on %s\\n\u0026#34;, address) // ä½¿ç”¨çš„æ˜¯æ ‡å‡†åº“çš„httpæœåŠ¡å¯åŠ¨æ–¹æ³• // å¦‚æœçœ‹è¿‡http.ListenAndServeå‡½æ•°ç­¾åï¼Œå°±çŸ¥é“engineå®ç°äº†http.Handleræ–¹æ³•ï¼Œ // ä¹Ÿå°±æ˜¯å®ƒä¸€å®šæœ‰ä¸€ä¸ªServeHTTPæ–¹æ³• err = http.ListenAndServe(address, engine) return } é€šè¿‡å±‚å±‚è·³è½¬æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å›¾ä¸­æ·¡ç´«è‰²éƒ¨åˆ†ä¸­çš„handlerHTTPRequestæ–¹æ³•ï¼Œåœ¨ServeHTTPå‡½æ•°æ—¶ï¼Œengineä¼šä»poolä¸­å–å¾—ä¸€ä¸ªContextå¯¹è±¡ï¼Œå¹¶å‡†å¤‡å¥½Requestå’ŒResponseWriterçš„ç›¸å…³æ•°æ®è®¾ç½®åˆ°Contextä¸­å»ï¼Œæä¾›ç»™æ–¹æ³•é“¾è°ƒç”¨ã€‚\n// è°ƒç”¨ä¸­é—´ä»¶å’Œè¯·æ±‚é€»è¾‘å‡½æ•° func (engine *Engine) handleHTTPRequest(c *Context) { httpMethod := c.Request.Method rPath := c.Request.URL.Path unescape := false if engine.UseRawPath \u0026amp;\u0026amp; len(c.Request.URL.RawPath) \u0026gt; 0 { rPath = c.Request.URL.RawPath unescape = engine.UnescapePathValues } if engine.RemoveExtraSlash { rPath = cleanPath(rPath) } // è¿™é‡Œå¿…é¡»çŸ¥é“ginä½¿ç”¨çš„æ˜¯ â€œåŸºæ•°æ ‘ï¼ˆRadix Treeï¼‰â€ ç”¨äºå­˜å‚¨è·¯ç”± // https://michaelyou.github.io/2018/02/10/%E8%B7%AF%E7%94%B1%E6%9F%A5%E6%89%BE%E4%B9%8BRadix-Tree/ t := engine.trees for i, tl := 0, len(t); i \u0026lt; tl; i++ { if t[i].method != httpMethod { // ä»è¿™é‡Œå¯ä»¥çŸ¥é“ï¼Œengineä¸­çš„methodTrees []methodTreeæ˜¯è¯·æ±‚æ–¹æ³•åˆ†ç»„çš„è·¯ç”±åŒ¹é…æ ‘ã€‚ continue } root := t[i].root // rootæ•°æ®ç»“æ„ï¼ˆradix-treeï¼‰ï¼Ÿå¦‚ä½•æŸ¥æ‰¾ï¼Ÿ value := root.getValue(rPath, c.Params, unescape) // æ‰¾åˆ°è·¯ç”±å¯¹åº”çš„å¤„ç†å‡½æ•° if value.handlers != nil { c.handlers = value.handlers // å¤åˆ¶èŠ‚ç‚¹çš„æ‰€æœ‰handlers c.Params = value.params // è·¯ç”±å‚æ•° c.fullPath = value.fullPath // å…¨è·¯å¾„ c.Next() // ä¾æ¬¡è°ƒç”¨HandlerChainä¸­çš„å‡½æ•° c.writermem.WriteHeaderNow() return } // çœç•¥ï¼Œè¿™éƒ¨åˆ†æµç¨‹æ§åˆ¶ä¹Ÿè‡ªè¡Œé˜…è¯» } // çœç•¥... } ä»ä¸Šè¿°æµç¨‹æˆ‘ä»¬å¯ä»¥æ€»ç»“å¾—åˆ°å›¾ä¸­ç´«è‰²éƒ¨åˆ†è°ƒç”¨é“¾ï¼š\nengine.Run -\u0026gt; http.ListenAndServe -\u0026gt; engine.handleHTTPRequest -\u0026gt; c.Next\nä½†æ˜¯å…¶ä¸­è¿˜æœ‰ä¸æ¸…æ¥šçš„é—®é¢˜ï¼š\nè·¯ç”±æ˜¯é€šè¿‡æ–¹æ³•ç¡®å®šåˆ°è¯¥æ–¹æ³•æ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œå†æŸ¥è¯¢åˆ°è·¯ç”±å¯¹åº”çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆåœ¨radix-treeä¸­æ˜¯å¦‚ä½•è¿›è¡Œè·¯ç”±åŒ¹é…çš„å‘¢ï¼Ÿ c.handlers ç›´æ¥ä»åŒ¹é…åˆ°çš„è·¯ç”±èŠ‚ç‚¹çš„handlerså¤åˆ¶å¾—åˆ°ï¼Œé‚£ä¹ˆä¸­é—´ä»¶æ˜¯å¦‚ä½•æŒ‚åœ¨åˆ°å…¶ä¸­çš„å‘¢ï¼Ÿ è·å–åˆ°c.handlersä¹‹åï¼Œåªè°ƒç”¨äº†ä¸€æ¬¡c.Nextï¼Œé‚£ä¹ˆè¯¥é“¾è·¯æ˜¯å¦‚ä½•ç»§ç»­è°ƒç”¨ä¸‹å»çš„ï¼Ÿ Path Paramæ˜¯å¦‚ä½•è·å–åˆ°ï¼Ÿroot.getValue RouterGroup \u0026amp; MethodTree # è¿™éƒ¨åˆ†æ˜¯é™¤äº†Contextæ¦‚å¿µä¹‹å¤–ç†è§£ginçš„ç¬¬äºŒæ ¸å¿ƒéƒ¨åˆ†ï¼Œæä¾›è·¯ç”±æ³¨å†Œï¼Œè°ƒç”¨é“¾è·¯å‡½æ•°é“¾å¤„ç†ï¼Œè·¯ç”±åˆ†ç»„ï¼Œè·¯ç”±åŒ¹é…åŠŸèƒ½ã€‚åœ¨å¼€å§‹ä¹‹å‰ï¼Œå¿…é¡»çŸ¥é“ginçš„è·¯ç”±æ˜¯ç”±httprouteræä¾›ï¼Œè€ŒhttprouteråŒ…æ˜¯ä½¿ç”¨äº†radix-treeæ¥å®ç°è·¯ç”±ç®¡ç†åŠŸèƒ½ã€‚\n// IRouter defines all router handle interface includes single and group router. type IRouter interface { IRoutes Group(string, ...HandlerFunc) *RouterGroup } // IRoutes defines all router handle interface. type IRoutes interface { Use(...HandlerFunc) IRoutes Handle(string, string, ...HandlerFunc) IRoutes Any(string, ...HandlerFunc) IRoutes GET(string, ...HandlerFunc) IRoutes POST(string, ...HandlerFunc) IRoutes DELETE(string, ...HandlerFunc) IRoutes PATCH(string, ...HandlerFunc) IRoutes PUT(string, ...HandlerFunc) IRoutes OPTIONS(string, ...HandlerFunc) IRoutes HEAD(string, ...HandlerFunc) IRoutes StaticFile(string, string) IRoutes Static(string, string) IRoutes StaticFS(string, http.FileSystem) IRoutes } // RouterGroup is used internally to configure router, a RouterGroup is associated with // a prefix and an array of handlers (middleware). type RouterGroup struct { Handlers HandlersChain // ä¸­é—´ä»¶ basePath string // è·¯ç”±å‰ç¼€ engine *Engine // æŒ‡å‘engineå…¥å£çš„æŒ‡é’ˆ root bool // æ˜¯å¦æ˜¯root } .è·¯ç”±æ³¨å†Œ # é€šè¿‡ä»»æ„ä¸€ä¸ªè·¯ç”±æ³¨å†Œæ–¹æ³•ï¼Œéƒ½å¯ä»¥è¿›å…¥åˆ° func (group *RouterGroup) handle(httpMethod, relativePath string, handlers HandlersChain) IRoutes è¿™ä¸ªæ–¹æ³•ã€‚\n// æŒ‚è½½è·¯ç”±çš„å®é™…å¤„ç†å‡½æ•° func (group *RouterGroup) handle(httpMethod, relativePath string, handlers HandlersChain) IRoutes { // è®¡ç®—æœ€ç»ˆçš„ç»å¯¹è·¯å¾„ base + relativePath // æ³¨æ„baseä¹Ÿæ˜¯ç»å¯¹è·¯å¾„ absolutePath := group.calculateAbsolutePath(relativePath) // åˆå¹¶å¤„ç†å‡½æ•°ï¼Œå°†ä¸­é—´ä»¶å’Œé€»è¾‘å‡½æ•°ç»“åˆåœ¨ä¸€èµ· // ä¸€èˆ¬æ¥è¯´è¿™é‡Œä¼ å…¥çš„handlderæ˜¯é€»è¾‘å‡½æ•° len(handlers) = 1 // åªæœ‰å°‘æ•°çš„handlerä¼šæœ‰è‡ªå·±çš„ä¸­é—´ä»¶å¤„ç†å‡½æ•° len(handlers) \u0026gt; 1 handlers = group.combineHandlers(handlers) // å°†å¤„ç†å¥½çš„ HandlersChain åŠ è½½åˆ°Radix Treeä¸­å» // è¿™ä¹Ÿè¡¨æ˜ï¼Œè¿™é‡Œçš„RouterGroupåªä¼šè½½å¤„ç†è·¯ç”±æ—¶å‘æŒ¥ä½œç”¨ group.engine.addRoute(httpMethod, absolutePath, handlers) return group.returnObj() } engineåœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šè®¾ç½®RouterGroup.basePath = \u0026ldquo;/\u0026rdquo; engineæ˜¯å°†ç›¸åŒè¯·æ±‚æ–¹æ³•æŒ‚è½½åˆ°åŒä¸€æ£µæ ‘ä¸‹\nçœ‹åˆ°è¿™é‡Œå›åˆ°engine.addRouteä¸­å»ï¼Œé€šè¿‡æ·±å…¥å‘ç°å¦‚ä¸‹è°ƒç”¨é“¾ï¼š\nengine.GET -\u0026gt; routergroup.GET -\u0026gt; routergroup.handle -\u0026gt; engine.addRoute -\u0026gt; methodTree.addRoute -\u0026gt; node(radix-tree\u0026rsquo;s node).insertChild\n.è·¯ç”±åˆ†ç»„ # RouterGroupé€šè¿‡Groupå‡½æ•°æ¥è¡ç”Ÿä¸‹ä¸€çº§åˆ«çš„RouterGroupï¼Œä¼šæ‹·è´çˆ¶çº§RouterGroupçš„ä¸­é—´ä»¶ï¼Œé‡æ–°è®¡ç®—basePathã€‚\nfunc (group *RouterGroup) Group(relativePath string, handlers ...HandlerFunc) *RouterGroup { return \u0026amp;RouterGroup{ Handlers: group.combineHandlers(handlers), // åˆå§‹åŒ–æ—¶ï¼Œæ‹·è´çˆ¶äº²èŠ‚ç‚¹çš„ä¸­é—´ä»¶ basePath: group.calculateAbsolutePath(relativePath), // åˆå§‹åŒ–æ—¶ï¼Œè®¡ç®—å­©å­groupçš„ç»å¯¹è·¯å¾„ engine: group.engine, } } .ä¸­é—´ä»¶æŒ‚è½½ # æœ‰ä¸¤ä¸ªåœ°æ–¹æä¾›ç»™ä¸­é—´ä»¶æŒ‚è½½ï¼Œä¸€ä¸ªæ˜¯RouterGroup.Useé›†ä¸­æŒ‚è½½ä¸­é—´ä»¶ï¼›å¦ä¸€ä¸ªåœ°æ–¹æ˜¯æŒ‚è½½ç‰¹å®šè·¯ç”±çš„æ—¶å€™(RouterGroup.GET / POST ç­‰ç­‰)ï¼Œå°†ä¸­é—´ä»¶å’Œé€»è¾‘å¤„ç†å‡½æ•°ä¸€èµ·æŒ‚è½½ã€‚ç¬¬äºŒç§æ–¹å¼åœ¨è·¯ç”±æ³¨å†Œçš„æ—¶å€™å·²ç»è§è¿‡äº†ï¼Œè¿™é‡Œå†è¯´ä¸‹Useæ–¹æ³•ï¼ŒRouterGroup.Handlers = append(RouterGroup.Handlers, middlewareHandlers)ï¼Œè¿™é‡Œåªæ˜¯ç®€å•çš„å°†åæ¥çš„ä¸­é—´ä»¶å¤åˆ¶åˆ°RouterGroupçš„ä¸­é—´ä»¶ä¸Šï¼Œæ²¡æœ‰å…¶ä»–çš„é€»è¾‘ã€‚\n.è·¯ç”±åŒ¹é… # è¿™éƒ¨åˆ†å…¨éƒ½æ˜¯äº¤ç”±radix-treeæ¥è´Ÿè´£çš„éƒ¨åˆ†ã€‚\nHandlerFunc # type HandlerFunc func(*Context) // å¤„ç†å‡½æ•°ç­¾å type HandlersChain []HandlerFunc // å¤„ç†å‡½æ•°é“¾ è¿™éƒ¨åˆ†æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå°±æ˜¯å®šä¹‰äº†å‡½æ•°ç­¾åï¼ŒæŒ‡å®šContextä½œä¸ºä¸Šä¸‹æ–‡ä¼ é€’çš„å…³é”®æ•°æ®ã€‚\nContext # Contextæ˜¯ä¸Šä¸‹æ–‡ä¼ é€’çš„æ ¸å¿ƒï¼Œå®ƒåŒ…æ‹¬äº†è¯·æ±‚å¤„ç†ï¼Œå“åº”å¤„ç†ï¼Œè¡¨å•è§£æç­‰é‡è¦å·¥ä½œã€‚\n// Context is the most important part of gin. It allows us to pass variables between middleware, // manage the flow, validate the JSON of a request and render a JSON response for example. type Context struct { writermem responseWriter // å®ç°äº†http.ResponseWriter å’Œ gin.ResponseWriter Request *http.Request // http.Request, æš´éœ²ç»™handler // gin.ResponseWriter åŒ…å«äº†ï¼š // http.ResponseWriterï¼Œhttp.Hijackerï¼Œhttp.Flusherï¼Œhttp.CloseNotifierå’Œé¢å¤–æ–¹æ³• // æš´éœ²ç»™handlerï¼Œæ˜¯writermmçš„å¤åˆ¶ Writer ResponseWriter Params Params // è·¯å¾„å‚æ•° handlers HandlersChain // è°ƒç”¨é“¾ index int8 // å½“å‰handlerçš„ç´¢å¼• fullPath string engine *Engine // å¯¹engineçš„å¼•ç”¨ Keys map[string]interface{} // c.GET / c.SET çš„æ”¯æŒï¼Œå¸¸ç”¨äºsessionä¼ é€’ã€‚ // Errors is a list of errors attached to all the handlers/middlewares who used this context. Errors errorMsgs // Accepted defines a list of manually accepted formats for content negotiation. Accepted []string // query å‚æ•°ç¼“å­˜ queryCache url.Values // è¡¨å•å‚æ•°ç¼“å­˜, è·ŸqueryCacheä½œç”¨ç±»ä¼¼ formCache url.Values } .è°ƒç”¨é“¾æµè½¬å’Œæ§åˆ¶ # ä»Engineéƒ¨åˆ†å·²ç»çŸ¥é“ï¼Œå½“è·¯ç”±è¢«åŒ¹é…åˆ°ä¹‹åä¼šæ‰§è¡Œä¸€æ¬¡c.Nextï¼ŒNexté€»è¾‘éå¸¸ç®€å•å¦‚ä¸‹ï¼š\nfunc (c *Context) Next() { // ä»c.reset å¯ä»¥çŸ¥é“ c.index == -1 c.index++ for c.index \u0026lt; int8(len(c.handlers)) { c.handlers[c.index](c) // å‘ç”Ÿè°ƒç”¨ c.index++ } } // 63ï¼Œè¿™æ„å‘³è¿™å¦‚æœæœ€å¤§é“¾è·¯è¶…è¿‡äº†63ï¼Œé‚£ä¹ˆé€šè¿‡indexçš„æµç¨‹æ§åˆ¶å°±å‡ºé—®é¢˜äº†ã€‚ const abortIndex int8 = math.MaxInt8 / 2 func (c *Context) Abort() { c.index = abortIndex } è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ä½ åœ¨è°ƒç”¨é“¾ä¸­çš„æŸä¸€ä¸ªhandlerä¸­è°ƒç”¨äº†c.Abortä¹‹ç±»çš„å‡½æ•°ï¼Œè°ƒç”¨é“¾ä¼šç›´æ¥é€€å‡ºä¹Ÿæ˜¯é€šè¿‡c.indexæ¥æ§åˆ¶çš„ã€‚é™¤äº†è°ƒç”¨é“¾æµè½¬ï¼Œåœ¨Contextè¿™ä¸€éƒ¨åˆ†è¿˜æ¯”è¾ƒé‡è¦çš„æ˜¯ï¼Œå‚æ•°çš„è§£æï¼Œå“åº”å¤„ç†ã€‚\n.å‚æ•°è§£æ # å‚æ•°ä¼ é€’ä¸€å…±æœ‰ä¸€ä¸‹å‡ ç§æ–¹å¼ï¼š\nåºå· å‚æ•°ç±»å‹ è§£é‡Š Contextæ”¯æŒ 1 path param åœ¨URIä¸­å°†å‚æ•°ä½œä¸ºè·¯å¾„çš„ä¸€éƒ¨åˆ† c.Param(\u0026ldquo;key\u0026rdquo;) string 2 query param åœ¨URIä¸­ä»¥\u0026quot;?\u0026ldquo;å¼€å§‹çš„ï¼Œ\u0026ldquo;key=value\u0026quot;å½¢å¼çš„éƒ¨åˆ† c.Query(\u0026ldquo;key\u0026rdquo;) string 3 body [form; json; xmlç­‰ç­‰] æ ¹æ®è¯·æ±‚å¤´Content-Typeåˆ¤å®šæˆ–æŒ‡å®š c.Bindç±»ä¼¼å‡½æ•° // Content-Type MIME of the most common data formats. const ( MIMEJSON = \u0026#34;application/json\u0026#34; MIMEHTML = \u0026#34;text/html\u0026#34; MIMEXML = \u0026#34;application/xml\u0026#34; MIMEXML2 = \u0026#34;text/xml\u0026#34; MIMEPlain = \u0026#34;text/plain\u0026#34; MIMEPOSTForm = \u0026#34;application/x-www-form-urlencoded\u0026#34; MIMEMultipartPOSTForm = \u0026#34;multipart/form-data\u0026#34; MIMEPROTOBUF = \u0026#34;application/x-protobuf\u0026#34; MIMEMSGPACK = \u0026#34;application/x-msgpack\u0026#34; MIMEMSGPACK2 = \u0026#34;application/msgpack\u0026#34; MIMEYAML = \u0026#34;application/x-yaml\u0026#34; ) å…³äºç¬¬ä¸‰ç§å‚æ•°è§£ææ˜¯æœ€å¸¸ç”¨çš„ï¼Œä¹Ÿæ˜¯æœ€å¤æ‚çš„éƒ¨åˆ†åŒ…å«çš„å†…å®¹æ¯”è¾ƒå¤šï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚åˆ«å¿˜äº†ï¼Œbindingçš„åŒæ—¶è¿˜æœ‰å‚æ•°æ ¡éªŒæ˜¯åŸºäºâ€œgithub.com/go-playground/validatorâ€å®ç°çš„ã€‚\n.å“åº”å¤„ç† # å¸¸ç”¨çš„å“åº”æ–¹æ³•æœ‰c.String(http.Status, string), c.JSON(http.Status, interface{})\nc.Render(code http.Status, r gin.Render) -\u0026gt; r.Render\n// Render interface is to be implemented by JSON, XML, HTML, YAML and so on. type Render interface { // Render writes data with custom ContentType. Render(http.ResponseWriter) error // WriteContentType writes custom ContentType. WriteContentType(w http.ResponseWriter) } è¿™é‡Œä»¥gin.render.JSONä¸ºä¾‹ï¼š\nè¿™é‡ŒjsonåŒ…å¹¶ä¸æ˜¯ç›´æ¥ä½¿ç”¨çš„æ ‡å‡†åº“jsonï¼Œè€Œæ˜¯ç»è¿‡äº†ä¸€å±‚åŒ…è£…ç”¨äºæ”¯æŒjsoniteræ›¿æ¢jsonã€‚ è¿™ä¸€æ”¯æŒæ˜¯åŸºäºgolangé€‰æ‹©æ€§ç¼–è¯‘å®ç°çš„ã€‚\n// Render (JSON) writes data with custom ContentType. func (r JSON) Render(w http.ResponseWriter) (err error) { if err = WriteJSON(w, r.Data); err != nil { panic(err) } return } // WriteContentType (JSON) writes JSON ContentType. func (r JSON) WriteContentType(w http.ResponseWriter) { writeContentType(w, jsonContentType) } // WriteJSON marshals the given interface object and writes it with custom ContentType. func WriteJSON(w http.ResponseWriter, obj interface{}) error { writeContentType(w, jsonContentType) encoder := json.NewEncoder(w) err := encoder.Encode(\u0026amp;obj) return err } æ€»ç»“ # è¿™é‡ŒçŸ¥è¯†è®²äº†æŠŠginä½œä¸ºAPI Serverå¼€å‘æ—¶å¸¸ç”¨åˆ°çš„ä¸»è¦æµç¨‹å’Œæ•°æ®ç»“æ„ï¼Œå…¶ä¸­æ›´å¤šçš„æµç¨‹æ§åˆ¶éƒ¨åˆ†è¢«çœç•¥äº†ï¼Œå¯ä»¥è‡ªè¡Œç»“åˆä»£ç å’Œæºç é˜…è¯»ã€‚è¿™é‡Œä¸»è¦è§£æäº†ginä¸­å‡½æ•°è°ƒç”¨é“¾è·¯å’Œhandlersæµç¨‹æ§åˆ¶ï¼ŒRadixTreeçš„éƒ¨åˆ†éƒ½è¢«çœç•¥äº†ï¼Œç®—æ³•èœé¸¡ä¸æ•¢ä¹±è¯´ï¼ŒæŒæ¡åå†ç»“åˆginçš„æºç é‡è¯»ã€‚\næ–‡ä¸­ä»£ç åå¤šï¼Œæœ€å¥½æ˜¯ç»“åˆæºç å’Œå›¾ç‰‡é£Ÿç”¨ã€‚\næ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿å‹˜è¯¯æŒ‡æ­£ğŸ™ã€‚\nå‚è€ƒæ–‡çŒ® # https://michaelyou.github.io/2018/02/10/%E8%B7%AF%E7%94%B1%E6%9F%A5%E6%89%BE%E4%B9%8BRadix-Tree/ "},{"id":32,"href":"/2020/01/17/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%8E%92%E6%9F%A5gRPC%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%BD%93%E5%AF%BC%E8%87%B4%E7%9A%84goroutine%E6%B3%84%E6%BC%8F/","title":"ä¸€æ¬¡gRPCä½¿ç”¨ä¸å½“å¯¼è‡´goroutineæ³„æ¼æ’æŸ¥è®°å½•","section":"Posts","content":" ç”±äºä¿ç•™å¿…è¦çš„â€œç½ªè¯â€ï¼Œå› æ­¤æŸäº›å¼‚å¸¸åªèƒ½é€šè¿‡æ–‡å­—æ¥æè¿°äº†ï½\nèƒŒæ™¯ # æ˜¨æ™šä¸Š10ç‚¹å·¦å³ï¼Œå‰ç«¯ç«¥é‹åæ˜ å¼€å‘ç¯å¢ƒæ¥å£å“åº”è¶…æ—¶ï¼Œä½†è¿‡äº†å‡ åˆ†é’Ÿååˆæ¢å¤äº†ï¼Œäºæ˜¯æœ‰äº†è¿™ä¸€ç¯‡æ–‡ç« ã€‚\nå…¶å®å¾ˆä¹…ä»¥å‰å°±å‡ºç°äº†å†…å­˜å ç”¨å¼‚å¸¸çš„æƒ…å†µï½ï¼Œåªæ˜¯å ç”¨å¹¶ä¸é«˜ä¹Ÿå°±æ˜¯50MBå·¦å³ï¼ŒåŠ ä¸Šå½“æ—¶è¿˜å¿™ç€å†™ä¸šåŠ¡éœ€æ±‚å°±æ²¡æœ‰æ€¥ç€åŠ ä¸Špprofæ¥æ£€æŸ¥ã€‚\né¦–å…ˆé€šè¿‡è¿ç»´å¹³å°(k8s based)ç›´è§‚å‘ç°äº†è¯¥podæ•°é‡ä»1å˜æˆäº†2, å†ç»“åˆæ–°å¢podçš„å¯åŠ¨æ—¶é—´ï¼Œæˆ‘å‘ç°è¯¥æ—¶é—´æ­£å¥½æ˜¯å‰ç«¯ç«¥é‹åæ˜ çŠ¶å†µçš„æ—¶é—´èŠ‚ç‚¹ï¼Œç¨åæˆ‘æ£€æŸ¥äº†ä¸‹è¯¥æœåŠ¡çš„èµ„æºé™åˆ¶å¦‚ä¸‹å›¾ï¼š\né‚£ä¹ˆå‰ç«¯ç«¥é‹åæ˜ çš„é—®é¢˜å°±å¾ˆæ˜æ˜¾äº†ï¼Œç”±äºæŸç§åŸå› å¯¼è‡´äº†podå†…å­˜è¶…é™ï¼Œè§¦å‘äº†è¿ç»´å¹³å°å¯¹äºå†…å­˜è¶…é™çš„â€œå®¹å¿æœºåˆ¶â€ã€‚è¡¨ç°ä¸º: æ–°å¢ä¸€ä¸ªpodç”¨äºç¼“è§£æœåŠ¡å‹åŠ›ï¼Œè€æœåŠ¡ç”±äºæ— æ³•ç”³è¯·æ›´å¤šå†…å­˜ä¼šå¯¼è‡´å´©æºƒæˆ–å…¶ä»–å¼‚å¸¸ï¼ˆæ— æ³•å“åº”å®¢æˆ·ç«¯è¯·æ±‚ï¼‰ï¼Œè¿™ä¸åæ˜ çš„æƒ…å†µä¸€è‡´ã€‚\npprofæ’æŸ¥ # çŸ¥é“äº†æœåŠ¡å†…å­˜å¼‚å¸¸ï¼Œæƒ³è¦å…·ä½“å®šä½çš„è¯ï¼Œè¿™æ—¶å€™å°±éœ€è¦pprofä¸Šåœºäº†ã€‚\nå¦‚æœä½ éœ€è¦é‡å¯æœåŠ¡æ‰èƒ½å¼€å¯pprofçš„è¯ï¼Œé‚£ä¹ˆåªèƒ½ç­‰å¾…å¤ç°äº†ã€‚è¿™é‡Œæˆ‘åœ¨å¼€å‘ç¯å¢ƒå’Œæµ‹è¯•ç¯å¢ƒä¸€ç›´å¼€å¯äº†pprofï¼Œå› æ­¤å¯ä»¥ç›´æ¥æ£€æŸ¥ã€‚ä¸ªäººè§‰å¾—ï¼Œè¿™æ ·è¿˜å¯ä»¥å¸®åŠ©å¼€å‘å’Œæµ‹è¯•ï¼Œå®Œæˆæœ€åˆçš„æ€§èƒ½åˆ†æğŸ˜¼ã€‚\nå†…å­˜æ£€æŸ¥ # go tool pprof --http=:8080 https://service.host.com/debug/pprof/heap è¿™ä¸ªå‘½ä»¤æ˜¯åœ¨æœ¬åœ°æ‰“å¼€ä¸€ä¸ªwebæœåŠ¡ï¼Œç›´æ¥å¯è§†åŒ–è¯¥æœåŠ¡çš„å†…å­˜å ç”¨æƒ…å†µã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨:\ngo tool pprof https://service.host.com/debug/pprof/heap ä½¿ç”¨äº¤äº’æ¨¡å¼æ¥åˆ†æã€‚é€šè¿‡è¿™ä¸ªæ­¥éª¤å®šä½åˆ°äº† grpcç›¸å…³çš„åŒ…å†…å­˜å ç”¨å¼‚å¸¸åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š\n50MB+ google.golang.org/grpc/internal/transport.newBufWriter 50MB+ bufio.NewReaderSize http2 ç›¸å…³åº“çš„å ç”¨ä¹Ÿæ¯”è¾ƒå¤š è¿™ä¸€åˆ‡éƒ½æŒ‡å‘äº†æˆ‘ä»¬ä½¿ç”¨çš„gRPCï¼Œå¯æ˜¯ä¸ºå•¥ä½¿ç”¨gRPCä¼šç”¨åˆ°è¿™ä¹ˆâ€œå¤šâ€å†…å­˜å‘¢ï¼Ÿæ¥ç€åˆ†æ\ngoroutineæ£€æŸ¥ # æ‰“å¼€ä¸€çœ‹ https://service.host.com/debug/pprof/ä¸€çœ‹ï¼Œgoroutineå’Œheapå±…â€œé«˜â€(4000+)ä¸ä¸‹ï¼Œè™½ç„¶å¯¹äºåŠ¨è¾„10W+çš„åˆ«äººå®¶çš„æœåŠ¡æ¥è¯´ï¼Œè¿™ç‚¹æ ¹æœ¬ä¸ç®—äº‹ï¼Œä½†åœ¨æˆ‘ä»¬è¿™ç§å°ä½œåŠé‡Œå¯å°±ç®—å¼‚å¸¸äº†ã€‚ç‚¹å¼€çœ‹goroutineæŸ¥çœ‹è¯¦æƒ…ï¼Œæœ‰å››ä¸ªéƒ¨åˆ†çš„goroutineåˆ†åˆ«æœ‰900ä¸ªå·¦å³ï¼Œè¿™é‡Œå°±ç®—åˆæ­¥å®šä½äº†â€œgRPCå®¢æˆ·ç«¯ä½¿ç”¨äº†è¾ƒå¤šçš„goroutineï¼Œä½†æ˜¯å´æ²¡æœ‰æ­£ç¡®çš„ç»“æŸæ‰â€ï¼Œå¦‚ä¸‹å›¾ï¼ˆè¿™æ˜¯è§£å†³åçš„æˆªçš„å›¾ï¼‰ï¼š\npprofæ€»ç»“ # æœåŠ¡ä¸­ä½¿ç”¨çš„gRPCå®¢æˆ·ç«¯å‡ºäº†æŸäº›æ•…éšœï¼Œå¯¼è‡´äº†goroutineæ³„æ¼ï¼Œå¼•å‘äº†OOMï¼ˆOut Of Memoryï¼‰ã€‚å¦‚ä¸‹å›¾ï¼š\nä»£ç æ’æŸ¥ # ä¸Šä¸€æ­¥å·²ç»å®šä½åˆ°æ˜¯gRPCå®¢æˆ·ç«¯çš„é—®é¢˜ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥ä»ä»£ç ä¸Šæ‰‹äº†ã€‚æˆ‘å¿ƒé‡Œå·²ç»æœ‰ä¸€ä¸ªâ€œå«Œç–‘çŠ¯â€äº†ï¼Œå¦‚ä¸‹ï¼š\nvar ( defaultHandler *handler timeout = 5 * time.Second // _ pb.UserServiceClient = \u0026amp;handler{} ) // Init of usersvc.handler func Init(rpcAddr string) error { // ... ç•¥å»ä¸è¡¨ } type handler struct { // rpc configs rpcAddr string client pb.UserServiceClient lastGrpcReqError error } func (h *handler) connectRPC() { if h.client != nil \u0026amp;\u0026amp; h.lastGrpcReqError != nil { // è¿™é‡Œåˆ¤æ–­çš„æœ¬æ„æ˜¯ï¼šå¦‚æœå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥ï¼Œ // æˆ–è€…æœŸé—´å› ä¸ºå¼‚å¸¸æƒ…å†µï¼Œå¯¼è‡´å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯è¿æ¥ä¸­æ–­çš„æƒ…å†µä¸‹å°è¯•é‡è¿ã€‚ // // ä½†æ˜¯å¿½ç•¥äº†gRPCå®ç°ä¸­ï¼Œå¯¹äºå®¢æˆ·ç«¯çš„å¤„ç†ï¼š // 1. grpc.Dail æ˜¯å¼‚æ­¥çš„ // 2. grpc æœ‰è‡ªå·±çš„é‡è¿æœºåˆ¶ // // è¿™ä¸€éƒ¨åˆ†æˆ‘è¿˜æ²¡æœ‰çœ‹å®Œï¼Œå°±ä¸ä¹±å‘è¡¨çœ‹æ³•äº†ã€‚ conn, err := grpc.Dial(h.rpcAddr, grpc.WithInsecure()) if err != nil { logger.Std.Errorf(\u0026#34;could not dial: %s with err: %v\u0026#34;, h.rpcAddr, err) return } logger.Std.Infof(\u0026#34;usersvc.client.connectRPC called\u0026#34;) h.client = pb.NewUserServiceClient(conn) } } // QueryBasicInfoByID based default Handler . func QueryBasicInfoByID(in *pb.ByIDForm) (*pb.BasicInfoResponse, error) { defaultHandler.connectRPC() ctx, cancel := context.WithTimeout(context.Background(), timeout) defer cancel() resp, err := defaultHandler.client.QueryBasicInfoByID(ctx, in) defaultHandler.lastGrpcReqError = err return resp, err } æŠ›å¼€æœ¬æ„ä¸è°ˆï¼Œè¿™æ ·çš„å†™æ³•ä¹Ÿæ˜¯ä¸OKçš„ã€‚ã€‚ã€‚å› ä¸º\nif h.client != nil \u0026amp;\u0026amp; h.lastGrpcReqError != nil { // ç»è¿‡åˆå§‹åŒ–åçš„clientå§‹ç»ˆä¸ç­‰äºnil, é‚£ä¹ˆæ§åˆ¶grpc.Dailçš„å°±åªå‰©ä¸‹äº†err, // è€Œerrçš„å–å€¼æ˜¯æ‰€æœ‰çš„æ–¹æ³•çš„æŠ¥é”™ï¼Œè€Œä¸åªæ˜¯è¿æ¥å¼‚å¸¸ã€‚ // } é‚£ä¹ˆä¿®å¤å·¥ä½œåªéœ€è¦ å»é™¤æ‰è¿™â€œç®€é™‹ç ´çƒ‚â€çš„é‡è¿ å°±è¡Œäº†ï¼šæ³¨é‡Šæ‰æ‰€æœ‰è·ŸconnectRPCå’ŒlastGrpcReqErrorç›¸å…³çš„ä»£ç è¡Œã€‚\nè¿™é‡Œæˆ‘è¿˜åšäº†ä¸€ä¸ªç®€å•çš„æµ‹è¯•ï¼Œå¦‚ä¸‹ï¼š\nconst N = 100 func Test_clientErr(t *testing.T) { profileWriter, _ = os.OpenFile(\u0026#34;./profile.normal.out\u0026#34;, os.O_CREATE|os.O_WRONLY, 0644) heapWriter, _ = os.OpenFile(\u0026#34;./memprofile.normal.out\u0026#34;, os.O_CREATE|os.O_WRONLY, 0644) pprof.StartCPUProfile(profileWriter) defer pprof.StopCPUProfile() for i := 0; i \u0026lt; N; i++ { // Normal err = nil resp, err := QueryBasicInfoByID(\u0026amp;usrpb.ByIDForm{UserId: 1}) // ä¼šè§¦å‘ err = NotFound // resp, err := QueryBasicInfoByID(\u0026amp;usrpb.ByIDForm{UserId: 11}) t.Log(resp, err) } runtime.GC() if err := pprof.WriteHeapProfile(heapWriter); err != nil { t.Error(err) } } // æœªä¿®å¤å‰ï¼Œ100ä¸ªNotFoundé”™è¯¯ // Showing nodes accounting for 8040.19kB, 100% of 8040.19kB total // Showing top 10 nodes out of 26 // flat flat% sum% cum cum% // 5446.66kB 67.74% 67.74% 5446.66kB 67.74% google.golang.org/grpc/internal/transport.newBufWriter // 1056.33kB 13.14% 80.88% 1056.33kB 13.14% bufio.NewReaderSize // 513kB 6.38% 87.26% 513kB 6.38% golang.org/x/net/http2/hpack.newInternalNode // 512.19kB 6.37% 93.63% 512.19kB 6.37% runtime.malg // 512.01kB 6.37% 100% 1025.01kB 12.75% golang.org/x/net/http2/hpack.addDecoderNode // 0 0% 100% 1025.01kB 12.75% golang.org/x/net/http2.(*Framer).ReadFrame // 0 0% 100% 1025.01kB 12.75% golang.org/x/net/http2.(*Framer).readMetaFrame // 0 0% 100% 1025.01kB 12.75% golang.org/x/net/http2/hpack.(*Decoder).Write // 0 0% 100% 1025.01kB 12.75% golang.org/x/net/http2/hpack.(*Decoder).parseFieldLiteral // 0 0% 100% 1025.01kB 12.75% golang.org/x/net/http2/hpack.(*Decoder).parseHeaderFieldRepr // æœªä¿®å¤å‰ 100 normal // Showing nodes accounting for 2208.36kB, 100% of 2208.36kB total // Showing top 10 nodes out of 19 // flat flat% sum% cum cum% // 1184.27kB 53.63% 53.63% 1184.27kB 53.63% runtime/pprof.StartCPUProfile // 512.08kB 23.19% 76.82% 512.08kB 23.19% golang.org/x/net/http2.init // 512.01kB 23.18% 100% 512.01kB 23.18% golang.org/x/net/http2/hpack.addDecoderNode // 0 0% 100% 1184.27kB 53.63% git.class100.com/backend/protobuf/benchmark_test.Test_CallUsergRPC_Normal // 0 0% 100% 512.01kB 23.18% golang.org/x/net/http2.(*Framer).ReadFrame // 0 0% 100% 512.01kB 23.18% golang.org/x/net/http2.(*Framer).readMetaFrame // 0 0% 100% 512.01kB 23.18% golang.org/x/net/http2/hpack.(*Decoder).Write // 0 0% 100% 512.01kB 23.18% golang.org/x/net/http2/hpack.(*Decoder).parseFieldLiteral // 0 0% 100% 512.01kB 23.18% golang.org/x/net/http2/hpack.(*Decoder).parseHeaderFieldRepr // 0 0% 100% 512.01kB 23.18% golang.org/x/net/http2/hpack.(*Decoder).readString // ä¿®å¤åï¼Œ100ä¸ªNotFoundé”™è¯¯ // Showing nodes accounting for 1537.02kB, 100% of 1537.02kB total // Showing top 10 nodes out of 14 // flat flat% sum% cum cum% // 1024.02kB 66.62% 66.62% 1537.02kB 100% golang.org/x/net/http2/hpack.addDecoderNode // 513kB 33.38% 100% 513kB 33.38% golang.org/x/net/http2/hpack.newInternalNode // 0 0% 100% 1537.02kB 100% golang.org/x/net/http2.(*Framer).ReadFrame // 0 0% 100% 1537.02kB 100% golang.org/x/net/http2.(*Framer).readMetaFrame // 0 0% 100% 1537.02kB 100% golang.org/x/net/http2/hpack.(*Decoder).Write // 0 0% 100% 1537.02kB 100% golang.org/x/net/http2/hpack.(*Decoder).parseFieldLiteral // 0 0% 100% 1537.02kB 100% golang.org/x/net/http2/hpack.(*Decoder).parseHeaderFieldRepr // 0 0% 100% 1537.02kB 100% golang.org/x/net/http2/hpack.(*Decoder).readString // 0 0% 100% 1537.02kB 100% golang.org/x/net/http2/hpack.buildRootHuffmanNode // 0 0% 100% 1537.02kB 100% golang.org/x/net/http2/hpack.getRootHuffmanNode åªæ˜¯100ä¸ªé”™è¯¯çš„è§¦å‘å°±èƒ½çœ‹è§å†…å­˜å ç”¨æœ‰æ˜æ˜¾çš„ä¸Šå‡ï¼Œä¿®å¤ç‰ˆæœ¬çš„å†…å­˜å ç”¨ä¹Ÿæ˜¾è‘—ä¸‹é™äº†ã€‚é‡æ–°éƒ¨ç½²æœåŠ¡åï¼Œé€šè¿‡æ£€æŸ¥pprofï¼Œå¦‚ä¸‹å›¾ï¼šgoroutineæ•°é‡ä¹Ÿæ­£å¸¸(4000+ =\u0026gt; 68)äº†ã€‚\nä»å†…å­˜å ç”¨ä¸Šçœ‹ï¼Œä¹Ÿä¸€ç›´å¤„äºæ­£å¸¸çš„èŒƒå›´ï¼ˆå½“ç„¶è¿˜éœ€è¦é•¿æœŸè§‚å¯Ÿï¼‰ï¼š\nä»£ç åˆ†ææ€»ç»“ # è¯¥é—®é¢˜ä¸€ç›´å­˜åœ¨è¯¥æœåŠ¡ä¸­ï¼Œç”šè‡³å½±å“åˆ°äº†å…¶ä¸Šæ¸¸æœåŠ¡ï¼Œä½†æ˜¯ç”±äºç§ç§åŸå› ï¼š\n1. è¿­ä»£è¾ƒå¿«ï¼ŒæœåŠ¡æ›´æ–°é¢‘ç¹ 2. lastGrpcReqErrorè§¦å‘å¹¶ä¸é¢‘ç¹ 3. å†…å­˜è¶…é™è®¾ç½®è¾ƒé«˜ï¼Œæ²¡æœ‰è§¦å‘æŠ¥è­¦ 4. ä¸šåŠ¡é©±åŠ¨ã€‚ã€‚ã€‚ORZ ä¸€ç›´å¾—è¿‡ä¸”è¿‡ï¼Œæ²¡æœ‰å½±å“ä¸šåŠ¡ä¹Ÿå°±æ— æ‰€è°“äº†ï¼Œæƒ³èµ·æ¥ä¸€å¥è¯ï¼Œâ€œæˆ‘ä»¬è¿™ä½“é‡ï¼Œä¸è¦è¿‡æ—©ä¼˜åŒ–æµªè´¹æ—¶é—´ï¼Œå…ˆæŠŠéœ€æ±‚å®ç°å’¯â€ã€‚ä¸è¿‡æˆ‘è§‰çš„æ’æŸ¥è¿™ç§é—®é¢˜è¿˜æ˜¯å¾ˆæœ‰è¶£çš„ï¼Œè‡³å°‘æ¯”å†™ä¸šåŠ¡æœ‰è¶£ã€‚\næ€»ç»“ # ğŸ˜‚pprofæˆ‘ç”¨å¾—ä¹Ÿä¸å¤Ÿç†Ÿç»ƒï¼Œè¿™é‡Œå§‘ä¸”ç®—æ˜¯ä¸€æ¬¡å®è·µäº† ğŸ˜‚ä¿ç•™æ›´å¤šçš„ç½ªè¯ï¼Œæ–¹ä¾¿æ°´ä¸€ç¯‡æ–‡ç« ï¼Œé¿å…â€œå£è¯´æ— å‡­â€ï¼ˆé‚£æˆ‘ä¹Ÿæƒ³ä¸åˆ°ï¼Œæˆ‘ä¼šå†™è¿™ç§æ–‡ç« å•Šï¼‰ ğŸ˜‚ç›‘æ§æ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œä¸€å®šè¦ç›‘æ§å¥½ä½ çš„æœåŠ¡ï¼Œå¹¶åŠæ—¶å‘Šè­¦ ğŸ˜‚pprof ä¹Ÿæ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œæ—©ç‚¹åŸ‹è¿›ä½ çš„æœåŠ¡é‡Œï¼Œé¿å…åˆ°äº†è¦åˆ†æçš„æ—¶å€™å´æ²¡æœ‰æ•°æ®å¯ç”¨äºåˆ†æ ğŸ˜‚7ä¸ªæœˆå¤ªé•¿äº†ï¼Œä»¥è‡³äºæˆ‘éƒ½ä¸æƒ³æ‰¿è®¤è¿™æ˜¯æˆ‘å†™çš„ ğŸ˜‚è¿™é‡Œæ²¡æœ‰å»åˆ†ægRPCçš„å®ç°ç»†èŠ‚ï¼Œå› ä¸ºæˆ‘è¿˜æ²¡æœ‰å¼€å§‹çœ‹ã€‚ã€‚ã€‚å…ˆç•™ä¸ªå‘å§ "},{"id":33,"href":"/2020/01/08/ssh-tunnel%E5%B0%8F%E5%B7%A5%E5%85%B7/","title":"SSH Tunnelå°å·¥å…·","section":"Posts","content":" èƒŒæ™¯ # ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“ä¸å…è®¸ç›´æ¥è®¿é—®ï¼Œä½†æ˜¯åˆç»å¸¸æœ‰éœ€è¦ç›´æ¥æ“ä½œæ•°æ®åº“çš„éœ€æ±‚ğŸ˜‚ã€‚å…ˆä¸è¯´åˆä¸åˆç†ï¼ŒèƒŒæ™¯å°±æ˜¯è¿™ä¸ªèƒŒæ™¯ï¼Œå› æ­¤åªèƒ½é€šè¿‡è·³æ¿æœºæ¥è¿æ¥æ•°æ®åº“ï¼Œä¸€ï¼ˆå°±ï¼‰èˆ¬ï¼ˆæˆ‘ï¼‰æ¥ï¼ˆè€Œï¼‰è¯´ï¼ˆè¨€ï¼‰ä¼šä½¿ç”¨sshéš§é“ï¼Œå°±è½»æ¾èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç„¶é¹…ï¼Œäº‹æƒ…å¹¶ä¸ç®€å•ã€‚è¿™é‡Œé™ˆè¿°ä¸€ä¸‹ï¼š\nç”Ÿäº§ç¯å¢ƒæ•°æ®åº“ä¸è®©ç›´æ¥è®¿é—®ï¼› è·³æ¿æœºä¸Šæ²¡æœ‰å…¬é’¥ï¼Œæ²¡æœ‰æƒé™ï¼› æˆ‘ä¸€æ¬¡å¯èƒ½éœ€è¦å¼€3+ä¸ªéš§é“æ‰èƒ½å¯åŠ¨æœåŠ¡ã€æ•²é‡ç‚¹ã€‘ è§£å†³ # æœ¬ç€â€œæˆ‘ä¸é€ è½®å­ï¼Œè°æ¥é€ è½®å­â€çš„æƒ³æ³•ï¼Œè¿™é‡Œå°±é€ ä¸€ä¸ªå°è½®å­ï¼šç”¨Goæ¥å®ç°SSHéš§é“å¤šå¼€ï¼Œå¹¶æ”¯æŒé…ç½®ã€‚æˆæœé¢„è§ˆï¼š åŸç†ç®€è¦åˆ†æ # å¦‚æœä»£ç†åŸç†æœ‰ç‚¹äº†è§£ï¼Œè¿™é‡Œçš„åŸç†å·®ä¸å¤šæ˜¯ä¸€æ ·çš„ï¼šLocal \u0026lt;-\u0026gt; SSH tunnel \u0026lt;-\u0026gt; Remote Serverï¼Œå¯¹äºéš§é“æ¥è¯´æŠŠLocalçš„è¯·æ±‚ä¼ ç»™Remote, æŠŠRemoteçš„å“åº”å‘Šè¯‰Localã€‚ç›´æ¥ä¸Šä»£ç ï¼š\n// Start . // TODO: support random port by using localhost:0 func (tunnel *SSHTunnel) Start() error { listener, err := net.Listen(\u0026#34;tcp\u0026#34;, tunnel.LocalAddr) if err != nil { return err } defer listener.Close() // tunnel.Local.Port = listener.Addr().(*net.TCPAddr).Port for { conn, err := listener.Accept() if err != nil { return err } logger.Infof(tunnel.name() + \u0026#34; accepted connection\u0026#34;) go tunnel.forward(conn) } } // åˆ›å»ºéš§é“å¹¶ä¼ é€’æ¶ˆæ¯ï¼Œåˆ†åˆ«æœ‰ä¸¤ä¸ªç«¯ç‚¹ï¼Œä¸€ä¸ªæ˜¯æœ¬åœ°éš§é“å£ï¼Œå¦ä¸€ä¸ªæ˜¯è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„éš§é“å£ func (tunnel *SSHTunnel) forward(localConn net.Conn) { // åˆ›å»ºæœ¬åœ°åˆ°è·³æ¿æœºçš„SSHè¿æ¥ serverSSHClient, err := ssh.Dial(\u0026#34;tcp\u0026#34;, tunnel.ServerAddr, tunnel.SSHConfig) if err != nil { logger.Infof(tunnel.name()+\u0026#34; server dial error: %s\u0026#34;, err) return } logger.Infof(tunnel.name()+\u0026#34; connected to server=%s (1 of 2)\u0026#34;, tunnel.ServerAddr) // åˆ›å»ºè·³æ¿æœºåˆ°è¿œç¨‹æœåŠ¡å™¨çš„è¿æ¥ remoteConn, err := serverSSHClient.Dial(\u0026#34;tcp\u0026#34;, tunnel.RemoteAddr) if err != nil { logger.Infof(tunnel.name()+\u0026#34; remote dial error: %s\u0026#34;, err) return } logger.Infof(tunnel.name()+\u0026#34; connected to remote=%s (2 of 2)\u0026#34;, tunnel.RemoteAddr) copyConn := func(writer, reader net.Conn) { _, err := io.Copy(writer, reader) if err != nil { logger.Infof(tunnel.name()+\u0026#34; io.Copy error: %s\u0026#34;, err) } } // local(w) =\u0026gt; è¿œç¨‹(r) go copyConn(localConn, remoteConn) // è¿œç¨‹(w) =\u0026gt; æœ¬åœ°(r) go copyConn(remoteConn, localConn) } ä»£ç ä¸­éœ€è¦æ³¨æ„çš„æ˜¯ï¼š\nfunc forward() { // ... some code ignored // ä¸‹é¢çš„ä»£ç å®ç°äº†æ¶ˆæ¯ä¼ é€’ï¼Œé—®é¢˜ï¼šä¸ºä»€ä¹ˆ`io.Copy + net.Conn`å°±å¯ä»¥å®ç°æ•°æ®çš„æŒç»­ä¼ é€’å‘¢ï¼Ÿ copyConn := func(writer, reader net.Conn) { _, err := io.Copy(writer, reader) if err != nil { logger.Infof(tunnel.name()+\u0026#34; io.Copy error: %s\u0026#34;, err) } } go copyConn(localConn, remoteConn) go copyConn(remoteConn, localConn) } æ€»ç»“ # ä¸Šè¿°åœºæ™¯ä¹Ÿå¯ä»¥é€šè¿‡å†™è„šæœ¬çš„æ–¹å¼æ¥è§£å†³ï¼Œä½†æ¯•ç«Ÿæ¯ä¸ªå¹³å°å¯¹shellæ”¯æŒå¹¶ä¸ä¸€è‡´ï¼Œè¿˜éœ€è¦å®‰è£…sshå·¥å…·ï¼Œå› æ­¤è¿˜æ˜¯é€‰æ‹©äº†é€ è½®å­ã€‚\nio.Copyä¼šä¸€ç›´å¤åˆ¶ç›´åˆ°è¯»åˆ°EOFï¼›TCPåè®®åªæœ‰åœ¨å¤„ç†FINæŠ¥æ–‡æ‰ä¼šå†™å…¥EOFï¼Œå› æ­¤io.Copyä¼šæŒç»­ä¸æ–­çš„åœ¨localå’Œremoteä¹‹é—´å¤åˆ¶æ•°æ®ã€‚\nå‚è€ƒ # https://medium.com/@elliotchance/how-to-create-an-ssh-tunnel-in-go-b63722d682aa https://golang.org/x/crypto/ssh å¦‚ä½•åœ¨shellè„šæœ¬ä¸­å®ç°äº¤äº’ï¼Œè¯·è‡ªè¡Œgoogle æ‰€æœ‰çš„ä»£ç å‡åœ¨ï¼šhttps://github.com/yeqown/infrastructure/tree/master/cmd/tunnel-helper "},{"id":34,"href":"/2019/12/12/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8Bhashtable/","title":"æ•°æ®ç»“æ„ - hashtable","section":"Posts","content":" èƒŒæ™¯ # æœ€è¿‘ä¸€ç›´åœ¨çœ‹ã€Šredisè®¾è®¡ä¸å®ç°ã€‹ï¼Œå…¶ä¸­è®²äº†redisä¸­ä½¿ç”¨åˆ°çš„æ•°æ®ç»“æ„å¦‚ï¼šsds, ziplist, skiplist, hashtable, intset, linkedlistç­‰ã€‚è¯»å®Œç¬¬ä¸€éƒ¨åˆ†ä¹‹åï¼Œå†ç»“åˆgithubä¸Šçš„æºç redisï¼Œæœ¬ç€å¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´çš„ç†å¿µï¼Œä¾¿å‡†å¤‡åŠ¨æ‰‹æ’¸ä¸€éã€‚\nredisä¸­hashtableçš„ç‰¹ç‚¹ # é“¾åœ°å€æ³•è§£å†³hashå†²çªï¼ˆé™¤æ­¤ä»¥å¤–ï¼Œå¸¸è§çš„å†²çªè§£å†³åŠæ³•è¿˜æœ‰ï¼šå†æ•£åˆ—æ³•/å†å“ˆå¸Œæ³•/å»ºç«‹å…¬å…±æº¢å‡ºåŒºï¼‰ ä½¿ç”¨äº†murmur2å“ˆå¸Œå‡½æ•°ã€‚ æ¸è¿›å¼rehashï¼Œrehashè¿‡ç¨‹å¹¶ä¸æ˜¯ä¸€æ­¥åˆ°ä½ï¼Œè€Œæ˜¯åœ¨get/set/del ç­‰æ“ä½œä¸­ï¼Œç©¿æ’ç€å®Œæˆã€‚ è‡ªåŠ¨æ‰©å®¹å’Œè‡ªåŠ¨æ”¶ç¼©ï¼Œé€šè¿‡é˜€å€¼æ¥æ§åˆ¶æ‰©å®¹å’Œæ”¶ç¼©ã€‚ æœ‰2ä¸ªbucketï¼Œå…¶ä¸­0å·bucketæ˜¯æœ€å¸¸ç”¨çš„ï¼Œè€Œ1å·åªä¼šåœ¨rehashè¿‡ç¨‹ä¸­ä½¿ç”¨ï¼Œä¸€æ—¦rehashå®Œæˆï¼Œä¾¿ä¸å†ä½¿ç”¨ã€‚ è§£æå’Œå®ç° # hashtableï¼šæ˜¯æ ¹æ®Keyç›´æ¥è®¿é—®åœ¨å†…å­˜å­˜å‚¨ä½ç½®çš„æ•°æ®ç»“æ„ã€‚å¦‚ä½•æ ¹æ®keyå¾—åˆ°å†…å­˜ä¸­çš„ä½ç½®ï¼Œå°±éœ€è¦ä½¿ç”¨hashå‡½æ•°æ¥ä»æ—ååŠ©äº†ã€‚\nhashå‡½æ•°ï¼šæ˜¯ä¸€ç§ä»ä»»ä½•ä¸€ç§æ•°æ®ä¸­åˆ›å»ºå°çš„æ•°å­—â€œæŒ‡çº¹â€çš„æ–¹æ³•ã€‚ç®€å•çš„è¯´ï¼šhash(input) = 1122334455ã€‚\nè¿™é‡Œé€‰æ‹©äº†golangæ¥å®ç°ï¼›murmur3 hashç®—æ³•ï¼›\næ•°æ®ç»“æ„ # ä¸€å›¾ä»¥è”½ä¹‹ï¼š\n// å¯¹å¤–æš´éœ²çš„hashtable type LinkedDict struct { // 2ä¸ªå­˜å‚¨æ¡¶ï¼Œ0å·æ­£å¸¸ä½¿ç”¨ï¼Œ1å·åœ¨rehashè¿‡ç¨‹ä¸­ä½¿ç”¨ï¼›rehashå®Œæˆä¹‹åï¼Œ1å·èµ‹å€¼ç»™0å·ç„¶åé‡ç½®1å·ã€‚ ht [2]*hashtable // åˆå§‹å€¼ -1ï¼Œè¡¨ç¤ºæ²¡æœ‰åœ¨rehash rehashIdx int } // å­˜å‚¨æ¡¶ type hashtable struct { // åº•å±‚â€œæ•°ç»„â€ table []*dictEntry size int sizemask int used int } // hashtable å…ƒç´ å®šä¹‰ type dictEntry struct { key string value interface{} next *dictEntry } æ–¹æ³•é›† # hashtableå¸¸ç”¨çš„æ–¹æ³•æœ‰ GET/SET/DELETE/ITERï¼Œæ¥ä¸‹æ¥ä¼šåœ¨SETå’ŒDELä¸­ä»‹ç»rehashçš„è¯¦ç»†è¿‡ç¨‹ã€‚\nSET # func (d *LinkedDict) Set(key string, value interface{}) { if d.ht[0].table == nil { d.ht[0].init(InitTableSize) } // isRehashing åˆ¤å®šï¼š`rehashIdx != -1` // needRehash åˆ¤å®š: è£…è½½å› å­ used / size \u0026gt; 1.0 æ—¶è§¦å‘æ‰©å®¹rehash if !d.isRehashing() \u0026amp;\u0026amp; d.needRehash() { // rehashGrowup è¡¨ç¤ºæœ¬æ¬¡rehashæ˜¯éœ€è¦æ‰©å®¹ï¼Œåœ¨é…ç½®ht[1].tableæ—¶ä¼šæ‰©å±•ä¸ºå½“å‰çš„2å€ // åä¹‹åˆ™ä¼šç¼©å‡å†…å­˜ç©ºé—´ // startrehash ä¼šè®¾ç½® rehashIdx = 0, æ ‡å¿—rehashçš„è¿›åº¦ d.startrehash(rehashGrowup) } if d.isRehashing() { // å¦‚æœåœ¨rehashè¿‡ç¨‹ä¸­ï¼Œåˆ™å®Œæˆä¸€éƒ¨åˆ†ä»»åŠ¡: // æ ¹æ®rehashçš„è¿›åº¦rehashIdxï¼Œé€‰æ‹©æ¬ç§» d.ht[0].table[rehashIdx]éƒ¨åˆ†çš„æ•°æ®ï¼Œæ·»åŠ åˆ°d.ht[1]ä¸­ d.steprehash() } // ä¸Šè¿°å·¥ä½œå®Œæˆä¹‹åï¼Œå°±å¯ä»¥è€ƒè™‘æ–°å¢æ•°æ®äº† hashkey := d.hashkey(key) if d.isRehashing() { // å¦‚æœåœ¨rehashè¿‡ç¨‹ä¸­ï¼Œæ¯‹åº¸è€ƒè™‘ï¼Œç›´æ¥æ–°å¢åˆ°d.ht[1]ä¸­ d.ht[1].insert(hashkey, newDictEntry(key, value, nil)) return } // åä¹‹ï¼Œä¸åœ¨rehashè¿‡ç¨‹ä¸­ï¼Œåˆ™ç›´æ¥æ–°å¢åˆ°d.ht[0]ä¸­ d.ht[0].insert(hashkey, newDictEntry(key, value, nil)) return } // æ¸è¿›å¼rehashï¼Œæ ¹æ®rehashIdxç¡®å®šï¼Œè¦æ¬ç§»é‚£ä¸€éƒ¨åˆ†çš„æ•°æ®ã€‚ func (d *LinkedDict) steprehash() { entry := d.ht[0].table[d.rehashIdx] // å¦‚æœrehashIdxæŒ‡å‘çš„ä¾§é“¾ä¸ºç©ºï¼Œåˆ™rehashIdxè‡ªå¢ï¼Œç›´åˆ°æ‰¾åˆ°æœ‰æ•°æ®çš„ä¾§é“¾æˆ–è€…æ•°æ®å‡æ¬ç§»å®Œæˆ for entry == nil { d.rehashIdx++ if d.rehashIdx \u0026gt; d.ht[0].sizemask { d.finishrehash() return } entry = d.ht[0].table[d.rehashIdx] } // å¼€å§‹æ¬ç§»åŠ¨ä½œ // éå†é“¾è¡¨ï¼Œå°†æ‰€æœ‰æ•°æ®ï¼Œæ–°å¢åˆ°d.ht[1]ä¸­ next := entry.next for entry != nil { entry.next = nil d.ht[1].insert(d.hashkey(entry.key), entry) if next == nil { break } entry = next next = next.next } // é‡Šæ”¾d.ht[0].table[rehashIdx]é“¾è¡¨ï¼šé¿å…å¹²æ‰°æŸ¥è¯¢ï¼›é‡Šæ”¾å†…å­˜ d.ht[0].table[d.rehashIdx] = nil d.rehashIdx++ if d.rehashIdx \u0026gt; d.ht[0].sizemask { // æ˜¯å¦å·²ç»ç»“æŸï¼Œå¦‚æœç»“æŸåˆ™ï¼š // d.ht[0] = d.ht[1] // d.ht[1] = newHashTable() // rehashIdx = -1 d.finishrehash() } } // æ–°å¢ä¸€ä¸ªå…ƒç´ åˆ°åˆ°å­˜å‚¨æ¡¶ï¼š // æ ¹æ®hashå‡½æ•°çš„ç»“æœ(hashkey)å¯¹å­˜å‚¨æ¡¶å¤§å°(size)å–æ¨¡å¾—åˆ°ç»“æœ(pos)ï¼›ht.table[pos]å®Œæˆå¯¹é“¾è¡¨çš„æ–°å¢å·¥ä½œã€‚ func (ht *hashtable) insert(hashkey uint64, item *dictEntry) { pos := hashkey % uint64(ht.size) entry := ht.table[pos] last := entry if entry == nil { ht.used++ ht.table[pos] = item return } for entry != nil { if ht.keyCompare(entry.key, item.key) { // å¦‚æœkeyå·²ç»å­˜åœ¨åˆ™è¦†ç›–æ—§å€¼ entry.value = item.value return } last = entry entry = entry.next } ht.used++ last.next = item } æ€»ç»“ï¼š\nrehashIdx ä¸ä»…ç”¨äºæ ‡ç¤ºhashtableæ˜¯å¦åœ¨rehashè¿‡ç¨‹ä¸­ï¼Œä¹Ÿæ ‡ç¤ºäº†rehashçš„è¿›åº¦ï¼› rehashè¿‡ç¨‹ä¸­ï¼Œæ–°å¢å…ƒç´ ç›´æ¥æ–°å¢åˆ°1å·bucketä¸­ï¼› érehashçŠ¶æ€ï¼Œåˆ™æ–°å¢åˆ°0å·bucketä¸­ï¼› ä¾§é“¾æ–°å¢å…ƒç´ è¿‡ç¨‹ï¼Œéœ€æ¯”è¾ƒkeyå€¼æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™æ›´æ–°å¹¶è¿”å›ï¼› rehashè¿‡ç¨‹ä¸­ï¼ŒrehashIdxä¸æ˜¯åªä¼šå¢åŠ 1å•ä½ï¼Œè€Œæ˜¯æ ¹æ®ä¾§é“¾æƒ…å†µæ¥æ›´æ–°ï¼› GET # func (d *LinkedDict) Get(key string) (v interface{}, ok bool) { // åŒä¸ŠSETï¼Œä¸è¿‡å¤šèµ˜è¿° if d.isRehashing() { d.steprehash() } hashkey := d.hashkey(key) v, ok = d.ht[0].lookup(hashkey, key) if !d.isRehashing() { // å¦‚æœä¸åœ¨rehashè¿‡ç¨‹ä¸­ d.ht[0]ä¸­æ£€ç´¢çš„ç»“æœä¾¿æ˜¯æœ€ç»ˆç»“æœ return } else if ok { // å¦‚æœåœ¨rehashè¿‡ç¨‹ä¸­ä¸”å‘½ä¸­ï¼Œä¹Ÿè¿”å›ç»“æœ return v, ok } // åä¹‹ rehashè¿‡ç¨‹ä¸­ï¼Œä½†åœ¨d.ht[0]ä¸­æ²¡æ‰¾åˆ°ï¼Œå´ä¸ä»£è¡¨è¯¥keyçœŸçš„ä¸å­˜åœ¨, è¿˜éœ€è¦åœ¨d.ht[1]ä¸­ç¡®å®š v, ok = d.ht[1].lookup(hashkey, key) return } æ€»ç»“ï¼š\næ¸è¿›rehashè¿‡ç¨‹ä¸SETä¸­ä¸€è‡´ æŸ¥è¯¢åŠ¨ä½œä¹Ÿéœ€è¦æ ¹æ®rehashçŠ¶è€Œå®šï¼šåœ¨rehashä¸­åˆ™éœ€è¦æ£€æŸ¥ht[0]å’Œht[1]ï¼›åä¹‹åªéœ€è¦æ£€æŸ¥rehash[0]å³å¯ï¼› è¿™é‡Œçœç•¥äº†lookupéƒ¨åˆ†çš„ä»£ç ï¼Œæ˜¯å› ä¸ºæŸ¥è¯¢å’Œæ–°å¢åœ¨åŸç†ä¸Šæ˜¯ä¸€è‡´çš„ï¼šå®šä½ -\u0026gt; éå†æ£€æŸ¥ -\u0026gt; æ¯”è¾ƒkey -\u0026gt; åŠ¨ä½œã€‚ DEL # // Del to delete an item in hashtable. func (d *LinkedDict) Del(key string) { if d.ht[0].used == 0 \u0026amp;\u0026amp; d.ht[1].used == 0 { return } // è¿™é‡Œç›¸æ¯”Setï¼ŒåŒºåˆ«åœ¨äºï¼šåˆ¤å®šçš„å†…å®¹ä¸æ˜¯æ˜¯å¦éœ€è¦æ‰©å®¹è€Œæ˜¯ç¼©å®¹ // ç¼©å®¹åˆ¤å®šï¼šd.ht[0]çš„å†…å­˜ç©ºé—´å¤§äºåˆå§‹å€¼4ä¸”â€œå¡«å……ç‡â€å°‘äº 10% // d.ht[0].size \u0026gt; 4 \u0026amp;\u0026amp; (d.ht[0].used*100/d.ht[0].size) \u0026lt; 10 if !d.isRehashing() \u0026amp;\u0026amp; d.needShrink() { d.startrehash(rehashShrink) } if d.isRehashing() { d.steprehash() } hashkey := d.hashkey(key) d.ht[0].del(hashkey, key) if d.isRehashing() { d.ht[1].del(hashkey, key) } } æ€»ç»“ï¼š\nä¸‡å˜ä¸ç¦»å…¶å®—ï¼Œä¸ç®¡æ˜¯SETï¼ŒGETï¼ŒDEL éƒ½æ˜¯å…ˆå®šä½ï¼Œå†ç¡®å®šå…ƒç´ ä½ç½®ï¼Œå†æ‰§è¡Œç›¸åº”çš„åŠ¨ä½œï¼› ç¼©å®¹åˆ¤å®šä¸­ï¼Œå¡«å……ç‡ä¹Ÿç­‰ä»·äºè£…è½½å› å­ï¼› ä»£ç ä¸­æœ‰ä¸ªå–å·§ï¼šå½“ä½¿ç”¨ç‡ä¸º0æ—¶åˆ™ç›´æ¥è¿”å›ï¼Œé¿å…äº†åç»­è°ƒç”¨ï½ ITER # æ­¤éƒ¨åˆ†ä»£ç ç•¥å»ï¼› éå†æ“ä½œä¹Ÿéœ€è¦è§†rehashæƒ…å†µè€Œå®šï¼› æµ‹è¯• # è¿™é‡Œæˆ‘ä½¿ç”¨äº†golangå†…ç½®çš„Mapåšäº†å¯¹æ¯”æµ‹è¯•ï¼Œç»“æœå¦‚ä¸‹ï¼š\nbuiltinMap_1000 cost: 0ms builtinLinkedDict_1000 cost: 0ms getMap_1000 cost: 0ms getLinkedDict_1000 cost: 0ms builtinMap_10000 cost: 4ms builtinLinkedDict_10000 cost: 6ms getMap_10000 cost: 2ms getLinkedDict_10000 cost: 5ms builtinMap_100000 cost: 76ms builtinLinkedDict_100000 cost: 108ms getMap_100000 cost: 56ms getLinkedDict_100000 cost: 131ms builtinMap_1000000 cost: 1053ms builtinLinkedDict_1000000 cost: 1230ms getMap_1000000 cost: 581ms getLinkedDict_1000000 cost: 915ms builtinMap_10000000 cost: 13520ms builtinLinkedDict_10000000 cost: 17137ms getMap_10000000 cost: 8663ms getLinkedDict_10000000 cost: 14271ms å¯è§å·®è·è¿˜æ˜¯éå¸¸å¤§çš„ï¼Œè¿™é‡Œå¤§èƒ†åˆ†æä¸‹å¯¼è‡´è¿™äº›å·®è·çš„åŸå› ï¼š\nKeyç±»å‹ï¼Œé€šè¿‡pprofåˆ†æï¼Œåœ¨hashtable.keyCompareä¸ŠèŠ±è´¹äº†è¾ƒå¤šæ—¶é—´ï¼Œè™½ç„¶å·²ç»é€šè¿‡strings.Compareæ¥åŠ é€Ÿorzï¼›ç›¸æ¯”ä¸‹golangå†…ç½®çš„Mapä½¿ç”¨äº†unsafe.Pointer**pointer to unsafe.ArbitraryType (int)**ä½œä¸ºkeyï¼Œå¹¶é’ˆå¯¹ä¸åŒçš„keyç±»å‹æ¥è®¾è®¡å“ˆå¸Œç®—æ³•ã€‚ bucketï¼ˆæ•°æ®ç»“æ„ï¼‰çš„ä½¿ç”¨ï¼šåœ¨æˆ‘çš„å®ç°ä¸­åªä½¿ç”¨äº†2ä¸ªbucketï¼Œå¸¸ç”¨çš„åªæœ‰1ä¸ªbucketï¼Œåœ¨å®šä½ä¸Šï¼šhashåçš„ç»“æœä½¿ç”¨å–æ¨¡çš„æ–¹æ³•å®šä½ï¼›ç›¸æ¯”ä¹‹ä¸‹ï¼Œmapé‡‡ç”¨äº†å¤šä¸ªbucketï¼Œæ¯ä¸ªbucketåªå­˜æ”¾8ä¸ªå…ƒç´ ï¼Œåœ¨å®šä½ä¸Šï¼šhashåç”¨low bits \u0026amp; bucketMaskå®šä½bucketså’Œhigh 8bitsæ‰¾åˆ°å¯¹åº”çš„ä½ç½®ï¼Œæ•ˆç‡æ›´é«˜ï¼› æ€»ç»“ # å®ç°ä¸€ä¸ªhashtableå¹¶ä¸éš¾ï¼Œéš¾ç‚¹åœ¨äºï¼šhashç®—æ³•çš„é€‰ç”¨ï¼ˆå‡åŒ€åˆ†å¸ƒï¼‰ï¼›å¦‚ä½•é™ä½hashå†²çªï¼ˆrehashæ—¶æœºï¼‰ï¼› å½“å®Œæˆä¸Šè¿°å·¥ä½œçš„æ—¶å€™ï¼Œæˆ‘å†å»é˜…è¯»goå†…ç½®çš„mapçš„å®ç°ä¼šå®¹æ˜“å¾ˆå¤šorzï¼Œä»…ç›¸ä¼¼éƒ¨åˆ†ï¼›mapæ¯”ä¸Šè¿°hashtableçš„å®ç°è¦å¤æ‚å¾—å¤šï¼› æ–‡ä¸­æ‰€æœ‰ä»£ç å‡åœ¨ https://github.com/yeqown/hashtable/blob/master/hashtable.goï¼› å¦‚æœåªæ˜¯æƒ³è¦äº†è§£åŸç†ï¼Œå‚è€ƒèµ„æ–™ä¸­çš„æ¨èæ–‡æ¡£è¶³ä»¥ï¼› å·²ç»å®ç°çš„ç‰ˆæœ¬è¿˜å¯ä»¥ç»§ç»­ä¼˜åŒ–ï¼Œå¹¶è€ƒè™‘å¹¶å‘å®‰å…¨é—®é¢˜ï½ å‚è€ƒèµ„æ–™ # https://en.wikipedia.org/wiki/Hash_table http://redisbook.com/ https://redisbook.readthedocs.io/en/latest/internal-datastruct/dict.html æ¨è https://github.com/cch123/golang-notes/blob/master/map.md æ¨è https://github.com/yeqown/hashtable "},{"id":35,"href":"/2019/12/04/%E5%9F%BA%E4%BA%8Esocket.io%E6%9E%84%E5%BB%BA%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E7%B3%BB%E7%BB%9F/","title":"åŸºäºsocket.ioæ„å»ºå³æ—¶é€šè®¯ç³»ç»Ÿ","section":"Posts","content":" æœ¬æ„åœ¨æ€»ç»“å®ç°socket.io-appè¿‡ç¨‹ä¸­çš„ä¸€äº›çŸ¥è¯†ã€‚\nèƒŒæ™¯ # ç°éœ€è¦æ›¿æ¢å…¬å¸çš„å³æ—¶é€šä¿¡æ¡†æ¶ï¼ˆä¹‹å‰ç”¨çš„æ˜¯é˜¿é‡Œäº‘çš„å¾®æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¼˜ç‚¹åœ¨äºï¼šç®€å•æ˜“æ¥å…¥ï¼Œé—®é¢˜åœ¨äºï¼šå¯¹äºäººæ•°å’Œå®¢æˆ·ç«¯çŠ¶æ€æ„ŸçŸ¥ä¸å¤Ÿå‡†ç¡®ï¼ŒåŸå› åé¢ç»†è¯´ï¼‰ã€‚åœ¨æ¡†æ¶é€‰å‹çš„æ—¶å€™ï¼ŒåŸºäºåº”ç”¨åœºæ™¯ï¼ˆå®¢æˆ·ç«¯æœ‰ï¼šå°ç¨‹åº/nodeJS/æµè§ˆå™¨ï¼‰ï¼Œæœ‰ä¸‰ç§æ–¹æ¡ˆï¼š\næ›¿æ¢MQTTçš„æ¶å­ï¼Œé’ˆå¯¹ç°æœ‰åœºæ™¯ä¸‹çš„é—®é¢˜ï¼Œé€‰ç”¨ä¸€æ¬¾æ›´åŠ å¯æ§çš„MQTTæœåŠ¡ï¼Œå¦‚EMQXã€‚ åŸºäºç°æœ‰çš„æŠ€æœ¯æ ˆï¼Œé€‰æ‹©ä¸€æ¬¾golangå¼€å‘çš„å¼€æºæ¡†æ¶ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œå¼€å‘ï¼Œå¦‚goimã€‚ ä¸€ä¸ªå¤§ä¼—ä¸”ç¨³å®šçš„å¼€æºæ¡†æ¶ï¼Œè¯­è¨€ä¸é™ï¼Œå¦‚socket.ioã€‚ ç»¼åˆä¸€ç³»åˆ—å› ç´ ï¼ˆæŠ€æœ¯ç†Ÿæ‚‰ç¨‹åº¦/staræ•°/æ—¶é—´æˆæœ¬/é‡‘é’±æˆæœ¬/è¿ç»´æˆæœ¬ï¼‰é€‰æ‹©äº†socket.io / JSğŸ¶ï½\nè¿™é‡Œæƒ³æ¨èä¸€ä¸‹goimç»™golangç¨‹åºçŒ¿ã€‚ä¸ªäººçœ‹æ³•ï¼šgoimå¯¹å›¢é˜ŸæŠ€æœ¯æ ˆæ›´å‹å¥½ï¼›å¯¹åˆ†å¸ƒå¼æ›´å‹å¥½ï¼›æ¶æ„åˆç†æ˜“äºæ‰©å±•ï¼›å¦‚æœ‰å…´è¶£å¯ä»¥å»çœ‹ä¸‹ï¼šhttps://juejin.im/post/5cbb9e68e51d456e51614aab @tsingson çš„è§£æï¼Œç»“åˆæºç æ›´å®¹æ˜“ç†è§£ä¸Šæ‰‹ã€‚\nå…³äºsocket.ioçš„ä»‹ç» # æ–‡æ¡£åœ¨æ­¤socket.io\né€šä¿¡æœºåˆ¶åŠç‰¹ç‚¹ # ç‰¹ç‚¹ æ‘˜è¦ å¯ç”¨æ€§ æä¾› long-polling å’Œ WebSocket ä¸¤ç§æ–¹å¼ï¼Œå¯ä»¥è‡ªåŠ¨å‡çº§ï¼ŒåŸºäºengine.io è‡ªåŠ¨é‡è¿ å®¢æˆ·ç«¯ä¼šä¸€ç›´é‡è¿ï¼Œç›´åˆ°å†æ¬¡é“¾æ¥ä¸ŠæœåŠ¡å™¨ æ–­çº¿æ£€æµ‹ å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é€šè¿‡å¿ƒè·³ç»´æŒé•¿é“¾æ¥ äºŒè¿›åˆ¶æ¶ˆæ¯ ä»»æ„è¢«åºåˆ—åŒ–çš„æ•°æ®ç»“æ„éƒ½å¯ä»¥ä¼ è¾“ å¤šè·¯å¤ç”¨ å¯¹ä¸åŒçš„Namespace,å¤ç”¨åº•å±‚é“¾æ¥ å†…ç½®Roomæ¦‚å¿µ ç†è§£ä¸ºèŠå¤©å®¤å’Œå³å¯ åŸºäºwebsocketï¼Œä½†ä¸äº’é€š https://github.com/socketio/socket.io-protocol æ€»ç»“ä¸€ä¸‹ï¼šsocket.io å·²ç»æä¾›äº†å³æ—¶é€šè®¯å¿…è¦çš„åŸºç¡€ï¼Œä¸ç”¨å…³å¿ƒä»»ä½•é€šè®¯ç›¸å…³çš„ç»†èŠ‚ï¼Œå¼€ç®±å³ç”¨ã€‚\nåˆ†å¸ƒå¼ # ç¡®è®¤socket.ioå·²ç»æä¾›äº†é€šè®¯åŸºç¡€ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šå•æœºæ€§èƒ½æœ‰é™ï¼Œå¦‚ä½•æ‰©å±•åˆ°åˆ†å¸ƒå¼å‘¢? socket.ioçš„å¦ä¸€ä¸ªä¼˜ç‚¹adapteræœºåˆ¶è®©socket.ioæ˜“äºæ‰©å±•ï¼Œå®˜æ–¹æä¾›äº†redis-adapteræ¥æ”¯æŒæ¶ˆæ¯åˆ†å‘ã€‚\nBy running socket.io with the socket.io-redis adapter you can run multiple socket.io instances in different processes or servers that can all broadcast and emit events to and from each other.\næ³¨æ„ï¼šredis-adapterä¼šåŒæ­¥æ‰€æœ‰çš„å¹¿æ’­å’Œemitäº‹ä»¶\nconst io = require(\u0026#39;socket.io\u0026#39;)(3000); const redisAdapter = require(\u0026#39;socket.io-redis\u0026#39;); io.adapter(redisAdapter({ host: \u0026#39;localhost\u0026#39;, port: 6379 })); äº‹ä»¶æœºåˆ¶ # å¦‚ä¸‹ï¼š\nvar io = require(\u0026#39;socket.io\u0026#39;)(80); var chat = io .of(\u0026#39;/chat\u0026#39;) .on(\u0026#39;connection\u0026#39;, function (socket) { socket.emit(\u0026#39;event1\u0026#39;, { that: \u0026#39;only\u0026#39; , \u0026#39;/chat\u0026#39;: \u0026#39;will get\u0026#39; }); chat.emit(\u0026#39;event2\u0026#39;, { everyone: \u0026#39;in\u0026#39; , \u0026#39;/chat\u0026#39;: \u0026#39;will get\u0026#39; }); }); var news = io .of(\u0026#39;/news\u0026#39;) .on(\u0026#39;connection\u0026#39;, function (socket) { socket.emit(\u0026#39;item\u0026#39;, { news: \u0026#39;item\u0026#39; }); }); é™¤äº†å†…ç½®ä¿ç•™çš„äº‹ä»¶ï¼ˆconnect message disconnect error ping pongç­‰ï¼‰å¤–ï¼Œå¯ä»¥è‡ªå®šä¹‰ä»»ä½•äº‹ä»¶åï¼Œç”¨äºä¸šåŠ¡é€»è¾‘ã€‚\nè¿™é‡Œåªæ˜¯ç®€å•ä»‹ç»äº†ä¸€ä¸‹socket.ioï¼Œå¯ä»¥å‰å¾€å®˜ç½‘è·å–æ›´å¤šç»†èŠ‚ã€‚\näº‹ä»¶æœºåˆ¶å¯¹ä¸å®¢æˆ·ç«¯çŠ¶æ€å’Œäººæ•°çš„ä½œç”¨ # å‰é¢è¯´è¿‡ä½¿ç”¨é˜¿é‡Œäº‘å¾®æ¶ˆæ¯é˜Ÿåˆ—æ— æ³•å‡†ç¡®è·å–åˆ°å®¢æˆ·ç«¯çŠ¶æ€å’Œæ•°é‡çš„é—®é¢˜ï¼Œåœ¨é˜¿é‡Œäº‘æ–‡æ¡£ä¸­æåˆ°äº†ï¼šå¼‚æ­¥ä¸Šä¸‹çº¿é€šçŸ¥å› ä¸ºé‡‡ç”¨æ¶ˆæ¯è§£è€¦ï¼ŒçŠ¶æ€åˆ¤æ–­æ›´åŠ å¤æ‚ï¼Œä¸”è¯¯åˆ¤å¯èƒ½æ€§æ›´å¤§ï¼Œä½†è¯¥æ–¹æ³•å¯ä»¥åŸºäºäº‹ä»¶åˆ†æå¤šä¸ªå®¢æˆ·ç«¯çš„è¿è¡ŒçŠ¶æ€è½¨è¿¹ã€‚å¼‚æ­¥ä¸Šä¸‹çº¿æ­£æ˜¯ä¹‹å‰ç”¨äºç»Ÿè®¡åœ¨çº¿äººæ•°å’Œå®¢æˆ·ç«¯çŠ¶æ€é€‰æ‹©çš„æ–¹æ¡ˆã€‚åœ¨å®é™…ä½¿ç”¨çš„æ—¶å€™ï¼Œèƒ½å¾ˆç›´è§‚çš„å‘ç°ï¼Œä¸Šä¸‹çº¿æ¶ˆæ¯ä¸èƒ½ä¿è¯æ­£ç¡®çš„é¡ºåºï¼Œè¿™ä¹Ÿå¯¼è‡´äº†è®¡ç®—äººæ•°å’ŒçŠ¶æ€æ—¶å€™å‡ºé”™ï½\nåŸºäºsocket-ioçš„APPè®¾è®¡ # åŸºäºä¸šåŠ¡åœºæ™¯ï¼Œè¦æ±‚appçš„åŠŸèƒ½æœ‰ï¼š\n1. å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å…¨åŒå·¥æ–¹å¼é€šä¿¡ 2. åŒä¸€Namesapceä¸‹ï¼Œç›¸åŒç”¨æˆ·IDä»…èƒ½å­˜åœ¨ä¸€ä¸ª 3. æœåŠ¡ç«¯æ­£å¸¸è§¦å‘ä¸Šçº¿/ä¸‹çº¿ï¼Œç”¨äºç»´ç³»å®¢æˆ·ç«¯çŠ¶æ€ 4. æä¾›RPCè°ƒç”¨æ–¹å¼ï¼Œç”¨äºä¸šåŠ¡æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯äº¤äº’ 5. æä¾›å®¢æˆ·ç«¯é‰´æƒï¼Œéæ³•å®¢æˆ·ç«¯å’Œæœªé‰´æƒå®¢æˆ·ç«¯ä¼šè¢«ä¸»åŠ¨å…³é—­è¿æ¥ 6. Namespaceå¯åŠ¨æ€åˆ›å»º 7. è¦æ±‚ä¸€å®šçš„ç›‘æ§æ•°æ®ï¼Œå¦‚é“¾æ¥æ•°é‡ï¼Œæˆ¿é—´æ•°é‡ï¼Œæ¶ˆæ¯æ•°é‡ç­‰ç­‰ã€‚ åº”ç”¨å¯¹æ¥ # å®¢æˆ·ç«¯ç”Ÿå­˜å‘¨æœŸæ³³é“å›¾ # å®ç°è¿‡ç¨‹ä¸­çš„é—®é¢˜ # socket.ioæ˜¯å¯¹é•¿è¿æ¥æœåŠ¡çš„ï¼Œåœ¨åˆ†å¸ƒå¼æœåŠ¡çš„åœºæ™¯ä¸‹ï¼Œè™½ç„¶æœ‰redis-adapterå¯ä»¥æ–¹ä¾¿çš„åšæ¶ˆæ¯åˆ†å‘åˆ°ä¸åŒçš„æœåŠ¡å®ä¾‹ä¸Šå»ï¼Œå¦‚æœä¸æ˜¯emitç›¸å…³çš„äº‹ä»¶åˆ™ä¸æ”¯æŒåˆ†å¸ƒå¼ã€‚ä¸‹é¢åˆ—ä¸¾äº†ä¸€éƒ¨åˆ†å…³äºåˆ†å¸ƒå¼æ—¶éœ€è¦è§£å†³çš„é—®é¢˜ï¼š\nSticky Session # å› ä¸ºsocket.ioåŒæ—¶æ”¯æŒäº†long-pollingå’Œwebsocketï¼Œå¹¶è‡ªå¸¦è‡ªåŠ¨å‡çº§åŠŸèƒ½ã€‚å› æ­¤å­˜åœ¨å‡çº§è¿‡ç¨‹ä¸­ï¼Œå­˜åœ¨HTTPåè®®å‡çº§æ—¶ï¼Œé“¾æ¥åˆ°ä¸åŒæœåŠ¡å™¨ï¼Œå¯¼è‡´æ— æ³•å®Œæˆå‡çº§è¿‡ç¨‹ã€‚è§£å†³åŠæ³•æœ‰ä¸¤ç§ï¼š\nä½¿ç”¨nginx / ip_hashæˆ–ç±»ä¼¼åŠŸèƒ½ï¼Œå¦‚æœæœ‰è‡ªå·±çš„LBæˆ–è€…ç½‘å…³ï¼Œå¯ä»¥è‡ªå®šä¹‰è¿™ä¸ªè§„åˆ™ï¼Œä¿è¯è´Ÿè½½å‡è¡¡çš„åŒæ—¶ä¿è¯åŒä¸€è¿æ¥æ¥åœ¨åŒä¸€æœåŠ¡å™¨ä¸Šå®Œæˆå‡çº§è¿‡ç¨‹ã€‚ é…ç½® transports ä¸ºä»… websocketï¼Œè§„é¿å‡çº§è¿‡ç¨‹ã€‚ var io = require(\u0026#39;socket.io-client\u0026#39;) var client = io(\u0026#39;https://myhost.com\u0026#39;, {transports: [\u0026#39;websocket\u0026#39;]}) https://socket.io/docs/internals/#socket-io-client\nRPCè°ƒç”¨å¦‚ä½•æ‰©å±•åˆ°åˆ†å¸ƒå¼ # éœ€RPCæä¾›çš„åŠŸèƒ½æœ‰è¸¢äººï¼Œæ–­å¼€ä¸å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œæ¸…ç©ºæˆ¿é—´ä¹‹ç±»ã€‚è¿™ä¸€ç±»å‘½ä»¤ä¸ä¼šè°ƒç”¨emit / broadcastï¼Œå› æ­¤ä¹Ÿä¸èƒ½é€šè¿‡redis-adapteræ¥å®ç°åˆ†å‘ã€‚è¿™é‡Œå¯ä»¥å€Ÿé‰´redis-adapteræ¶ˆæ¯åˆ†å‘çš„æ€æƒ³ï¼Œé€šè¿‡ redis PUB/SUB æ¥åˆ†å‘RPCå‘½ä»¤ï¼Œç”±æ­¤æ‰©å±•åˆ°åˆ†å¸ƒå¼ã€‚ä¸¾ä¾‹å¦‚ä¸‹:\ninterface IRpcCommand { evt: rpcCommandEvt meta: any } class grpcService { /* * è®¢é˜…redis channelï¼Œå¹¶åˆ†å‘å‘½ä»¤ */ private _subscribeCommandsToRedis() { this._sub.on(\u0026#34;message\u0026#34;, (ch: string, message: string) =\u0026gt; { logger.info(\u0026#34;recv an command from: \u0026#34;, ch, message) try { let command: IRpcCommand = JSON.parse(message) this._call(command) } catch (error) { logger.error(\u0026#34;could not execute message command: \u0026#34;, error) } }) this._sub.SUBSCRIBE(gRPCService.pubsubTopic()) } private _call(command: IRpcCommand) { switch (command.evt) { /* ignore other cases */ case rpcCommandEvt.clearRooms: let d6: clearRoomMeta = command.meta as clearRoomMeta this._clearRooms(d6.nspName, d6.roomIds) break default: logger.error(\u0026#34;undefined command evt\u0026#34;) } } /* ignore some codes */ private _clearRooms = (nspName: string, roomIds: string[]) =\u0026gt; { this._socketioSrv.clearRooms(nspName, roomIds) } /** * clearRoom */ clearRooms = (call: grpc.ServerUnaryCall\u0026lt;api_pb.ClearRoomsReq\u0026gt;, cb: grpc.requestCallback\u0026lt;api_pb.ClearRoomsResp\u0026gt;) =\u0026gt; { let roomIds = call.request.getRoomidsList() let nspName = call.request.getNspname() let resp = new api_pb.ClearRoomsResp() let meta: clearRoomMeta = { nspName, roomIds } this._publishCommandsToRedis(rpcCommandEvt.clearRooms, meta) resp.setErrcode(codes.OK) resp.setErrmsg(getMessage(codes.OK)) cb(null, resp) } } Namespaceä¸‹å”¯ä¸€ç”¨æˆ·IDå¦‚ä½•ä¿è¯ # è¿™ä¸ªéœ€æ±‚ç®€å•çš„å°±æ˜¯è¯´ï¼Œä¸šåŠ¡é€»è¾‘ä¸Šæƒ³å¯¹å®¢æˆ·ç«¯åŠ ä»¥é™åˆ¶ï¼Œä¸èƒ½è®©åŒä¸€ä¸ªç”¨æˆ·å¼€å¯å¤šä¸ªå®¢æˆ·ç«¯æ¥äº¤äº’ã€‚é€»è¾‘å¾ˆç®€å•ï¼šæ¯ä¸ªè¿æ¥é‰´æƒçš„æ—¶å€™ï¼Œå»æŸ¥è¯¢æ˜¯å¦è¯¥ç”¨æˆ·IDå·²ç»å­˜åœ¨Sessionäº†ï¼Œå¦‚æœå­˜åœ¨åˆ™æŠŠä¹‹å‰çš„è¿æ¥æ–­å¼€ã€‚åŒæ ·çš„åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼šç”¨æˆ·Aåˆ†é…åˆ°äº†S1æœåŠ¡å™¨ï¼Œç”¨æˆ·Aåœ¨å…¶ä»–åœ°æ–¹S2æœåŠ¡å™¨åˆå»ºç«‹ä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œé‚£ä¹ˆS2å¦‚ä½•æŠŠS1ä¸Šçš„è¿æ¥æ–­å¼€å‘¢ï¼Ÿ\nè¯´è¿‡ä¸Šé¢RPCçš„å‘½ä»¤åˆ†å‘ä¹‹åï¼Œè¿™é‡Œç®€å•äº†ï¼šåªéœ€è¦è§¦å‘ä¸€æ¬¡RPCçš„disconnectäº‹ä»¶å°±è¡Œäº†ã€‚\nNodeJS + gRPC + TypeScript å®æˆ˜ # ğŸ˜­ğŸ˜­ğŸ˜­å…ˆå“­ä¸ºæ•¬ï¼æƒ³èµ·æ¥å°±å¿ƒé…¸ã€‚æ ¸å¿ƒé—®é¢˜æ˜¯ï¼š 1. ç”¨ä»€ä¹ˆå·¥å…·ç»™protoæ–‡ä»¶ç”Ÿæˆtsæ–‡ä»¶ï¼›2. ts ä¸­å¦‚ä½•ä½¿ç”¨gRPCï¼›3. ts é…ç½®é—®é¢˜ï¼›å…¶ä»–ï¼›è¿™é‡Œç›´æ¥ç¥­å‡ºæœ€ç»ˆç»“æœï¼š\nç”Ÿæˆå·¥å…· # # generate js code for grpc proto file gen-js: ./node_modules/.bin/grpc_tools_node_protoc \\ --js_out=import_style=commonjs,binary:./src/codegen/api/ \\ --grpc_out=./src/codegen/api/ \\ --plugin=protoc-gen-grpc=./node_modules/.bin/grpc_tools_node_protoc_plugin \\ --proto_path=./src/api/ \\ api.proto # generate ts code for grpc messages and service gen-ts: protoc \\ --plugin=protoc-gen-ts=./node_modules/.bin/protoc-gen-ts \\ --ts_out=./src/codegen/api \\ --proto_path=./src/api/ \\ api.proto tsä¸­grpc.Serverç»‘å®šservice # // https://github.com/yeqown/socket.io-app/blob/master/src/server/grpc.ts serve = () =\u0026gt; { // const _protoPath = \u0026#39;../api/api.proto\u0026#39; // const _protoDescriptor: GrpcObject = grpc.load(_protoPath); // const service = ; let _srv = new grpc.Server() _srv.addService(grpc_pb.SocketMServiceService, { nspBroadcast: this.nspBroadcast, nspRoomsBroadcast: this.nspRoomsBroadcast, nspUsersBroadcast: this.nspUsersBroadcast, disconnect: this.disconnect, knockoutFromRoom: this.knockoutFromRoom, clearRooms: this.clearRooms, }) /* ignore some codes */ _srv.bind(\u0026#34;0.0.0.0:\u0026#34; + this.port.toString(), grpc.ServerCredentials.createInsecure()) _srv.start() } æ€»ç»“ # socket.io å·²ç»å¾ˆå…¨é¢äº†ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šåªéœ€è¦æ¥å…¥è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘å°±å¯ä»¥äº†ã€‚ redis çœŸå¥½ç”¨ TS çœŸå¥½ç”¨ï¼Œåªæ˜¯éƒ¨åˆ†å·¥å…·è·Ÿä¸ä¸Šï½ å¼€æºäº†ä¸€ä¸ªåŸºäºsocket.ioçš„appæ¶å­ï¼Œsocket.io-appï¼Œæ¬¢è¿äº¤æµ redis-adapter ä¼šä¸»åŠ¨åˆ†å‘emit, broadcastæŒ‡ä»¤ socket.ioçš„åè®®å‡çº§æœŸé—´éœ€è¦ä¿è¯åœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šå®Œæˆ æ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿å‹˜è¯¯æŒ‡æ­£ğŸ™ã€‚\nå‚è€ƒèµ„æ–™ # https://socket.io/docs https://github.com/yeqown/socket.io-app "},{"id":36,"href":"/2019/11/14/%E5%9F%BA%E4%BA%8ERepository%E8%AE%BE%E8%AE%A1%E7%BC%93%E5%AD%98%E6%96%B9%E6%A1%88/","title":"åŸºäºRepositoryè®¾è®¡ç¼“å­˜æ–¹æ¡ˆ","section":"Posts","content":" åœºæ™¯ # Testerâ€”Aï¼šè¿™ä¸ª getInfo æ¥å£å’‹è¿™ä¹ˆæ…¢å‘¢ï¼ŸæŸ¥ä¸€ä¸‹è¦5+sï¼ŸQPSç«Ÿç„¶åªæœ‰10ï¼ï¼ï¼ï¼ RD-B ï¼šè¿™æ˜¯å› ä¸ºgetInfoè¦æŸ¥åº“ã€‚ã€‚ã€‚Nå¤šåº“ Tester-Bï¼šé‚£ä¼˜åŒ–ä¸€ä¸‹å‘—ï¼Ÿ RD-B ï¼šå¥½çš„ï¼Œå®¹æˆ‘æ“ä½œä¸€æ³¢ï¼ˆç»™æ¥å£åŠ ä¸Šä¸€ä¸ªå“åº”ç¼“å­˜ï¼‰ï¼Œå¥½äº†ä½ å†æµ‹è¯•ä¸€ä¸‹ Tester-Bï¼šï¼ˆæµ‹è¯•ä¸­ã€‚ã€‚ã€‚ï¼‰ï¼Œé€Ÿåº¦æœç„¶å¿«äº†ä¸å°‘ã€‚è¯¶ä¸å¯¹ï¼Œè¿™ä¸ªæ¥å£é‡Œæ‹¿åˆ°çš„ç”¨æˆ·ä¿¡æ¯ä¸å¯¹ï¼Œæˆ‘æ˜æ˜å·²ç»balabaäº†ï¼Œè¿™é‡Œæ²¡æœ‰æ›´æ–°ï¼ï¼ï¼ RD-B ï¼šå“¦å“¦å“¦ï¼Œæˆ‘æ™“å¾—å’¯ï¼Œå†å®¹æˆ‘æ“ä½œä¸€æ³¢ï¼ˆç¼“å­˜åŠ æœ‰æ•ˆæ—¶é—´ï¼Œä¸ªäººä¿¡æ¯æ›´æ–°çš„æ—¶å€™å†å¼ºåˆ ç¼“å­˜ï¼‰ï¼ŒOäº† è‡³æ­¤å¼€å§‹äº†é’ˆå¯¹äºQPS+ç¼“å­˜æ›´æ–°çš„ä¸€äº›åˆ—æµ‹è¯•ã€‚ã€‚ã€‚å‰§ç»ˆã€‚ QPSå’Œå“åº”æ—¶é—´æ˜¯åï¼ˆjieï¼‰ç«¯ï¼ˆkou)å·¥ç¨‹å¸ˆéå¸¸ç†Ÿæ‚‰çš„æŒ‡æ ‡ï¼Œè¿™ä¸¤ä¸ªå€¼èƒ½æ¯”è¾ƒç›´è§‚çš„åæ˜ è¯¥æ¥å£çš„æ€§èƒ½ï¼Œé—´æ¥ç›´æ¥å½±å“äº†å‰ç«¯é¡µé¢çš„æµç•…åº¦ã€‚ã€‚ã€‚\né—®é¢˜æ¥äº† # æ¥å£æŸ¥è¯¢æ€§èƒ½å¦‚ä½•æé«˜ # é™¤å»æœºå™¨å’Œç¼–ç¨‹è¯­è¨€çš„å› ç´ ä¹‹åï¼Œè‚¯å®šè¦ä»ä¸šåŠ¡åœºæ™¯å‡ºå‘ï¼Œåˆ†ææ¥å£å“åº”ç¼“æ…¢çš„åŸå› ã€‚è­¬å¦‚ï¼Œæœ€å¸¸è§çš„:\næŸ¥Nå¤šè¡¨ï¼Œè¡¨è¿˜æ²¡æœ‰ç´¢å¼•orz æ— ç”¨æ•°æ®ï¼Œå¢åŠ ä¼ è¾“çš„Size åå¤æŸ¥è¯¢æŸäº›çƒ­ç‚¹æ•°æ®ï¼Œä½†æ¯æ¬¡éƒ½ç›´æ¥æ‰“åˆ°æ•°æ®åº“ ä¸Šæ¸¸æœåŠ¡å“åº”ç¼“æ…¢ å…¶ä»– å¥½äº†ï¼Œè¿™é‡Œåªè®¨è®ºçƒ­ç‚¹æ•°æ®çš„ç¼“å­˜æ–¹æ¡ˆï¼Œæ¯•ç«Ÿè¦å…·ä½“åœºæ™¯å…·ä½“åˆ†æï¼Œè€Œç¼“å­˜æ–¹æ¡ˆæ˜¯æ¯”è¾ƒé€šç”¨çš„ã€‚\nç¼“å­˜æ–¹æ¡ˆå¦‚ä½•é€‰æ‹© # åºå· ç¼“å­˜æ–¹æ¡ˆ ä¼˜åŠ¿ åŠ£åŠ¿ 1 Responseç¼“å­˜ ç®€å•æš´åŠ› ç¼“å­˜æ›´æ–°æ—¶æœºä¸å¥½æŠŠæ§ï¼Œå¦‚æœé¢é¢ä¿±åˆ°å¯èƒ½å¿ƒæ€å´©åï¼›ç¼“å­˜ç²’åº¦å¤ªå¤§ï¼Œæ— æ³•å±€éƒ¨æ›´æ–°ï¼›é’ˆå¯¹æŸ¥è¯¢æ¥å£æœ‰å¸®åŠ©ï¼Œå…¶ä»–ä¸šåŠ¡ä¸‹æŸ¥è¯¢æ•°æ®åˆ™æ¯«æ— å¸®åŠ© 2 Repositoryç¼“å­˜ ç²’åº¦ç”±Repoè‡ªè¡ŒæŒæ¡ï¼Œå¯æ§æ€§å¼ºï¼›Repoå¤ç”¨åœºæ™¯ä¸‹ä¼šæé«˜åº”ç”¨æ•´ä½“çš„é€Ÿåº¦ éœ€è¦é’ˆå¯¹å„ä¸ªRepoåšç¼“å­˜çš„å¤„ç†ï¼›æ”¹åŠ¨è¾ƒå¤šï¼›å…¶ä»–orz æ€»çš„æ¥è¯´ï¼ŒRepositoryçš„ç¼“å­˜æ–¹æ¡ˆï¼Œåœ¨ä¸Šè¿°èƒŒæ™¯ä¸Šè¾ƒç®€å•æš´åŠ›çš„ä¸­é—´ä»¶ç¼“å­˜æ³•è¦æ›´åŠ ä¼˜é›…å¯æ§ï½ã€‚\nç¼“å­˜ç®—æ³• # æåˆ°ç¼“å­˜å°±ä¸€å®šä¼šæåˆ°ç¼“å­˜æ›¿æ¢ç­–ç•¥ï¼Œæœ‰æœ€å¸¸è§çš„ï¼šLRU LFU FIFO MRU(æœ€è¿‘é¢‘ç¹ä½¿ç”¨ç®—æ³•) LRUçš„å¤šä¸ªå˜ç§ç®—æ³• LIRSç­‰ã€‚ è¿™é‡Œé€‰ç”¨äº†LRU-Kï¼ˆK=2ï¼‰å¹¶åŸºäºgolangæ¥å®ç° cached-repositoryï¼Œæ›´å¤šç®—æ³•çš„è¯¦ç»†ä¿¡æ¯å‚è§å‚è€ƒæ–‡æ¡£ä¸­çš„LRUå’ŒLRU-K:\nè¿™é‡Œåˆ†æˆäº†ä¸¤ä¸ªinterface:\nCacheAlgoré‡ç‚¹åœ¨äºä¸Repoäº¤äº’ï¼Œæ‰€ä»¥åªæä¾›äº†ç®€å•çš„å¢åˆ æ”¹æŸ¥ï¼Œåº•å±‚è¿˜æ˜¯åŸºäºCacheæ¥å®ç°çš„ã€‚æœ¬æ„æ˜¯æƒ³å®ç°å¤šç§ç¼“å­˜æ›¿æ¢ç®—æ³•æ¥ä¸°å¯Œcached-repositoryï¼Œorz\n// cache.go // CacheAlgor is an interface implements different alg. type CacheAlgor interface { Put(key, value interface{}) Get(key interface{}) (value interface{}, ok bool) Update(key, value interface{}) Delete(key interface{}) } lru.Cache åœ¨äºæä¾› åŸºäºLRU-likeç®—æ³•ç¼“å­˜å’Œæ›¿æ¢èƒ½åŠ›ï¼Œæ‰€ä»¥æ¥å£ä¼šæ›´ä¸°å¯Œä¸€äº›ï¼Œ\n// lru/types.go // Cache is the interface for simple LRU cache. type Cache interface { // Puts a value to the cache, returns true if an eviction occurred and // updates the \u0026#34;recently used\u0026#34;-ness of the key. Put(key, value interface{}) bool // Returns key\u0026#39;s value from the cache and // updates the \u0026#34;recently used\u0026#34;-ness of the key. #value, isFound Get(key interface{}) (value interface{}, ok bool) // Removes a key from the cache. Remove(key interface{}) bool // Peeks a key // Returns key\u0026#39;s value without updating the \u0026#34;recently used\u0026#34;-ness of the key. Peek(key interface{}) (value interface{}, ok bool) // Returns the oldest entry from the cache. #key, value, isFound Oldest() (interface{}, interface{}, bool) // Returns a slice of the keys in the cache, from oldest to newest. Keys() []interface{} // Returns the number of items in the cache. Len() int // iter all key and items in cache Iter(f IterFunc) // Clears all cache entries. Purge() } å…³äºå¦‚ä½•å®ç°LRUæˆ–è€…LRU-Kï¼Œç½‘ä¸Šå·²ç»æœ‰å¾ˆå¤šæ–‡ç« äº†ï¼ŒåŸç†ä¹Ÿä¸å¤æ‚ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šèµ˜è¿°äº†ï¼Œç›´æ¥ä¸Šæµ‹è¯•ç»“æœ\nç®€å•æµ‹è¯• # å®Œæ•´ä»£ç å‚è§code\n// MysqlRepo . type MysqlRepo struct { db *gorm.DB calg cp.CacheAlgor // *cp.EmbedRepo } // NewMysqlRepo . func NewMysqlRepo(db *gorm.DB) (*MysqlRepo, error) { // func NewLRUK(k, size, hSize uint, onEvict EvictCallback) (*K, error) c, err := lru.NewLRUK(2, 10, 20, func(k, v interface{}) { fmt.Printf(\u0026#34;key: %v, value: %v\\n\u0026#34;, k, v) }) if err != nil { return nil, err } return \u0026amp;MysqlRepo{ db: db, // func New(c lru.Cache) CacheAlgor calg: cp.New(c), }, nil } // GetByID . func (repo MysqlRepo) GetByID(id uint) (*userModel, error) { start := time.Now() defer func() { fmt.Printf(\u0026#34;this queryid=%d cost: %d ns\\n\u0026#34;,id, time.Now().Sub(start).Nanoseconds()) }() v, ok := repo.calg.Get(id) if ok { return v.(*userModel), nil } // actual find in DB m := new(userModel) if err := repo.db.Where(\u0026#34;id = ?\u0026#34;, id).First(m).Error; err != nil { return nil, err } repo.calg.Put(id, m) return m, nil } // Update . func (repo MysqlRepo) Update(id uint, m *userModel) error { if err := repo.db.Where(\u0026#34;id = ?\u0026#34;, id).Update(m).Error; err != nil { return err } fmt.Printf(\u0026#34;before: %v\\n\u0026#34;, m) m.ID = id if err := repo.db.First(m); err != nil { } fmt.Printf(\u0026#34;after: %v\\n\u0026#34;, m) // update cache, ifcache hit id repo.calg.Put(id, m) return nil } // Delete . func (repo MysqlRepo) Delete(id uint) error { if err := repo.db.Delete(nil, \u0026#34;id = ?\u0026#34;, id).Error; err != nil { return err } repo.calg.Delete(id) return nil } func main() { // ... prepare data rand.Seed(time.Now().UnixNano()) for i := 0; i \u0026lt; 1000; i++ { go func() { wg.Add(1) id := uint(rand.Intn(10)) if id == 0 { continue } v, err := repo.GetByID(id) if err != nil { fmt.Printf(\u0026#34;err: %d , %v\\n\u0026#34;, id, err) continue } if v.ID != id || v.Name != fmt.Sprintf(\u0026#34;name-%d\u0026#34;, id) || v.Province != fmt.Sprintf(\u0026#34;province-%d\u0026#34;, id) || v.City != fmt.Sprintf(\u0026#34;city-%d\u0026#34;, id) { fmt.Printf(\u0026#34;err: not matched target with id[%d]: %v\\n\u0026#34;, v.ID, v) } wg.Done() }() } wg.Wait() } âœ custom-cache-manage git:(master) âœ— go run main.go this queryid=9 cost: 245505 ns this queryid=1 cost: 131838 ns this queryid=3 cost: 128272 ns this queryid=2 cost: 112281 ns this queryid=7 cost: 123942 ns this queryid=4 cost: 140267 ns this queryid=7 cost: 148814 ns this queryid=9 cost: 126904 ns this queryid=6 cost: 129676 ns this queryid=2 cost: 174202 ns this queryid=1 cost: 151673 ns this queryid=4 cost: 156370 ns this queryid=3 cost: 159285 ns this queryid=6 cost: 142215 ns this queryid=3 cost: 691 ns this queryid=1 cost: 450 ns this queryid=8 cost: 160263 ns this queryid=5 cost: 149655 ns this queryid=4 cost: 756 ns this queryid=8 cost: 143363 ns this queryid=3 cost: 740 ns this queryid=9 cost: 558 ns this queryid=2 cost: 476 ns this queryid=5 cost: 184098 ns this queryid=1 cost: 824 ns this queryid=8 cost: 556 ns this queryid=9 cost: 632 ns this queryid=7 cost: 480 ns this queryid=5 cost: 439 ns this queryid=5 cost: 409 ns this queryid=7 cost: 431 ns this queryid=6 cost: 479 ns this queryid=4 cost: 423 ns this queryid=8 cost: 423 ns this queryid=1 cost: 411 ns this queryid=6 cost: 423 ns this queryid=8 cost: 394 ns this queryid=7 cost: 410 ns this queryid=9 cost: 424 ns this queryid=4 cost: 428 ns this queryid=2 cost: 433 ns this queryid=4 cost: 420 ns this queryid=9 cost: 424 ns this queryid=6 cost: 406 ns this queryid=6 cost: 399 ns this queryid=5 cost: 405 ns this queryid=2 cost: 428 ns this queryid=9 cost: 383 ns this queryid=4 cost: 399 ns this queryid=7 cost: 413 ns this queryid=4 cost: 381 ns this queryid=1 cost: 427 ns this queryid=2 cost: 430 ns this queryid=1 cost: 468 ns this queryid=1 cost: 406 ns this queryid=4 cost: 380 ns this queryid=2 cost: 360 ns this queryid=3 cost: 660 ns this queryid=6 cost: 393 ns this queryid=5 cost: 419 ns this queryid=7 cost: 1254 ns this queryid=6 cost: 723 ns this queryid=4 cost: 503 ns this queryid=8 cost: 448 ns this queryid=3 cost: 510 ns this queryid=1 cost: 432 ns this queryid=2 cost: 999 ns this queryid=1 cost: 419 ns this queryid=8 cost: 658 ns this queryid=9 cost: 1322 ns this queryid=9 cost: 543 ns this queryid=4 cost: 1311 ns this queryid=5 cost: 348 ns this queryid=4 cost: 309 ns this queryid=5 cost: 350 ns this queryid=9 cost: 311 ns this queryid=5 cost: 336 ns this queryid=3 cost: 567 ns this queryid=9 cost: 293 ns this queryid=7 cost: 338 ns this queryid=4 cost: 499 ns this queryid=7 cost: 318 ns this queryid=3 cost: 330 ns this queryid=7 cost: 322 ns this queryid=6 cost: 339 ns this queryid=7 cost: 1273 ns this queryid=4 cost: 1175 ns this queryid=6 cost: 306 ns this queryid=2 cost: 316 ns this queryid=5 cost: 330 ns this queryid=5 cost: 322 ns this queryid=6 cost: 324 ns this queryid=8 cost: 291 ns this queryid=2 cost: 310 ns this queryid=3 cost: 321 ns this queryid=3 cost: 294 ns this queryid=6 cost: 293 ns this queryid=8 cost: 3566 ns ...more ignored æ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿å‹˜è¯¯æŒ‡æ­£ğŸ™ã€‚\nä»£ç  # github.com/yeqown/cached-repository\nå‚è€ƒ # LIRS LRU-k "},{"id":37,"href":"/2019/10/10/AMQP%E9%87%8D%E8%BF%9E%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0-Go/","title":"AMQPé‡è¿æœºåˆ¶å®ç°","section":"Posts","content":" æ–‡ä¸­ä»£ç åŸºäº https://github.com/streadway/amqp å®ç°ã€‚æ­¤æ–¹å¼ç®€å•æš´åŠ›ï¼Œä½†æ²¡æœ‰åšåˆ°æœ€å°æˆæœ¬è¿ç§»ï¼ˆå¯ä»¥é€‰æ‹©åˆ†åˆ«åŒ…è£…Producerå’ŒConsumerï¼‰ã€‚\næ–‡ä¸­æ‰€æœ‰ä»£ç å‚è§ï¼šhttps://github.com/yeqown/infrastructure/tree/master/framework/amqp\nåŸºæœ¬çŸ¥è¯† # AMQP # AMQPï¼Œå³Advanced Message Queuing Protocol,ä¸€ä¸ªæä¾›ç»Ÿä¸€æ¶ˆæ¯æœåŠ¡çš„åº”ç”¨å±‚æ ‡å‡†é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œæ˜¯åº”ç”¨å±‚åè®®çš„ä¸€ä¸ªå¼€æ”¾æ ‡å‡†,ä¸ºé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶è®¾è®¡ã€‚åŸºäºæ­¤åè®®çš„å®¢æˆ·ç«¯ä¸æ¶ˆæ¯ä¸­é—´ä»¶å¯ä¼ é€’æ¶ˆæ¯ï¼Œå¹¶ä¸å—å®¢æˆ·ç«¯/ä¸­é—´ä»¶åŒäº§å“ï¼Œä¸åŒçš„å¼€å‘è¯­è¨€ç­‰æ¡ä»¶çš„é™åˆ¶ã€‚ç”¨ä¸‹å›¾ç®€å•æè¿°ä¸‹AMQPæ¨¡å‹ï¼š\nèƒŒæ™¯ # -é—®é¢˜ # ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨äº†RabbitMQåšå¼‚æ­¥æ¶ˆæ¯åˆ†å‘ï¼Œéš”ä¸€æ®µæ—¶é—´ä¼šå‡ºç°ï¼šå‘é€æ¥å£æŠ¥é”™ï¼›å‘é€æˆåŠŸåæœªè¢«æ¶ˆè´¹ç­‰æƒ…å†µã€‚é‡å¯æœåŠ¡åæ¢å¤ã€‚\n-é—®é¢˜ä»£ç  # ç”Ÿäº§è€…ï¼š\n// producer.go // NewClient . func NewClient(cfg *types.RabbitMQConfig) *Client { // init MQ connection return \u0026amp;Client{ ch: ch, // *amqp.Channel cfg: cfg, } } // Client . type Client struct { ch *amqp.Channel cfg *types.RabbitMQConfig } // Send . send by routing func (c *Client) Send(payload *types.Payload) error { var routing string switch payload.Typ { case types.PayloadTypUsers: routing = c.cfg.MqRoutingUser default: routing = c.cfg.MqRoutingSys } dat, _ := json.Marshal(payload) publishing := amqp.Publishing{ ContentType: \u0026#34;text/plain\u0026#34;, Body: dat, } return c.ch.Publish(c.cfg.MqExchagne, routing, false, false, publishing) } æ¶ˆè´¹è€…ï¼š\n// consumer.go // ... func (c *Client) Consume() error { err := c.initRabbitmqResource() if err != nil { logger.Std.Errorf(\u0026#34;could init rabbitmq resource: %v\u0026#34;, err) return err } msgs, err := c.rabbitmqChannel.Consume( c.rabbitmqQ, // queue \u0026#34;\u0026#34;, // consumer false, // auto ack false, // exclusive false, // no local false, // no wait nil, // args ) if err != nil { logger.Std.Errorf(\u0026#34;could not consume messages: %v\u0026#34;, err) return err } logger.Std.Infof(\u0026#34;start consumming messages\u0026#34;) for d := range msgs { logger.Std.Debugf(\u0026#34;consumming msg: body=%s, ex=%s, routing=%s, content-type=%s\u0026#34;, d.Body, d.Exchange, d.RoutingKey, d.ContentType) if err := c.sendout(d.Body); err != nil { continue } if err := d.Ack(false); err != nil { logger.Std.Errorf(\u0026#34;ack message error: %v\u0026#34;, err) } } // é˜Ÿåˆ—è¢«åˆ é™¤æ—¶ä¼šè¢«æ‰§è¡Œåˆ° logger.Std.Infof(\u0026#34;this should not be executed !!!!!\u0026#34;) return nil } // ... -åˆ†æé—®é¢˜ # æœåŠ¡æ•…éšœåï¼Œé¦–å…ˆæŸ¥çœ‹äº†ç”Ÿäº§è€…çš„ç³»ç»Ÿæ—¥å¿—ï¼Œå‘ç°äº† channel/connection is not openã€‚ä»githubä¸­æ£€ç´¢åå‘ç°https://github.com/streadway/amqp/blob/75d898a42a/channel.go#L155 æœ‰ä¸€ä¸ªé€»è¾‘æ˜¯å¤„ç†å·²ç»å…³é—­çš„channel, ä¼šè§¦å‘ErrClosed = \u0026amp;Error{Code: ChannelError, Reason: \u0026quot;channel/connection is not open\u0026quot;}ï¼Œæ°æ°channelè¢«å…³é—­æ˜¯ä¸Šè¿°ä»£ç æ²¡æœ‰è€ƒè™‘åˆ°çš„é—®é¢˜ã€‚\nåœ¨æ¶ˆè´¹è€…è¿™è¾¹çš„é—®é¢˜ï¼Œåœ¨channelè¢«å…³é—­çš„æƒ…å†µä¸‹ï¼Œå°±æ›´æ˜¾çœ¼äº†ï¼šchannelè¢«å…³é—­,æ¶ˆè´¹è€…ä¹Ÿå°±è¢«å…³é—­äº†ï¼Œæ¶ˆè´¹çš„goroutineè‡ªç„¶ä¹Ÿé€€å‡ºäº†ï¼Œä¹Ÿå°±å‡ºç°äº†æ¶ˆæ¯æ— æ³•è¢«æ¶ˆè´¹çš„æƒ…å†µã€‚å…·ä½“ä»£ç å‚è§ï¼š\nchannel.Consume https://github.com/streadway/amqp/blob/75d898a42a/channel.go#L1049 consumers.buffer https://github.com/streadway/amqp/blob/75d898a42a/consumers.go#L54 å¦‚æœè¿˜æœ‰å…´è¶£å¯ä»¥ç¿»çœ‹ä¸‹connection.shutdown, channel.shutdownã€‚\nfunc (subs *consumers) buffer(in chan *Delivery, out chan Delivery) { // é€€å‡ºæ—¶å…³é—­æ¶ˆè´¹channel defer close(out) defer subs.Done() var inflight = in var queue []*Delivery for delivery := range in { queue = append(queue, delivery) for len(queue) \u0026gt; 0 { select { // å¾ˆæ˜æ˜¾ï¼Œåç¨‹ä¼šåœ¨æ¶ˆè´¹è€…è¢«å…³é—­çš„æ—¶å€™é€€å‡º case \u0026lt;-subs.closed: // closed before drained, drop in-flight return case delivery, consuming := \u0026lt;-inflight: if consuming { queue = append(queue, delivery) } else { inflight = nil } case out \u0026lt;- *queue[0]: queue = queue[1:] } } } } è€Œä¸ºä»€ä¹ˆchannelä¼šè¢«å…³é—­ï¼Œåœ¨ç½‘ä¸Šæ£€ç´¢åå¹¶ç»“åˆä»£ç ï¼š\nSeq Description Reason Type 1 åº”ç”¨ç¨‹åºä¸»åŠ¨æ–­å¼€è¿æ¥ï¼Œç½‘ç»œå¼‚å¸¸è¢«åŠ¨æ–­å¼€è¿æ¥ è¿æ¥ä¸­æ–­ è¿æ¥å…³é—­ 2 é‡æ–°å£°æ˜ç°æœ‰é˜Ÿåˆ—æˆ–å…·æœ‰ä¸åŒ¹é…å±æ€§çš„äº¤æ¢å°†å¤±è´¥ 406 PRECONDITION_FAILED åè®®å¼‚å¸¸ 3 è®¿é—®ä¸å…è®¸ç”¨æˆ·è®¿é—®çš„èµ„æºå°†å¤±è´¥ 403 ACCESS_REFUSEDé”™è¯¯ åè®®å¼‚å¸¸ 4 ç»‘å®šä¸å­˜åœ¨çš„é˜Ÿåˆ—æˆ–ä¸å­˜åœ¨çš„äº¤æ¢å°†å¤±è´¥ 404 NOT_FOUNDé”™è¯¯ åè®®å¼‚å¸¸ 5 ä»ä¸å­˜åœ¨çš„é˜Ÿåˆ—ä¸­ä½¿ç”¨å°†å¤±è´¥ 404 NOT_FOUNDé”™è¯¯ åè®®å¼‚å¸¸ 6 å‘å¸ƒåˆ°ä¸é€€å‡ºçš„äº¤æ¢å°†å¤±è´¥ 404 NOT_FOUNDé”™è¯¯ åè®®å¼‚å¸¸ 7 ä»é™¤å£°æ˜è¿æ¥ä»¥å¤–çš„è¿æ¥è®¿é—®ç‹¬å é˜Ÿåˆ—å°†å¤±è´¥ 405 RESOURCE_LOCKED åè®®å¼‚å¸¸ å¾—åˆ°ç»“è®ºï¼šç”±äºç½‘ç»œæ³¢åŠ¨ã€ç”Ÿäº§è€…æ¶ˆè´¹è€…ä½¿ç”¨ä¸å½“ä¼šå¯¼è‡´channelè¢«å…³é—­.\né‡è¿åŸç† # å‚è€ƒï¼š\nhttps://ms2008.github.io/2019/06/16/golang-rabbitmq/ https://github.com/streadway/amqp/issues/133 ç®€è€Œè¨€ä¹‹ï¼Œchannel.NotifyCloseå’Œconnection.NotifyCloseå¯ä»¥æ¥æ”¶åˆ°é”™è¯¯æ¶ˆæ¯ï¼Œé‚£å°±ä»¥æ­¤ä¸ºé‡è¿çš„è§¦å‘å™¨ã€‚å‡½æ•°åŸå‹ï¼šfunc NotifyClose(c chan *Error) chan *Errorã€‚å®ç°æ€è·¯å¦‚å›¾ï¼š\nç»“åˆ***CODE***é£Ÿç”¨ï¼Œæ•ˆæœæ›´ä½³å“¦ã€‚handleReconnectä»£ç å¦‚ä¸‹ï¼š\nfunc (w *Wrapper) handleReconnect() { for { // æœªè¿æ¥ä¸Šçš„æƒ…å†µä¸‹ä¸€ç›´å°è¯•è¿æ¥ if !w.isConnected { log.Println(\u0026#34;Attempting to connect\u0026#34;) var ( connected = false err error ) for cnt := 0; !connected; cnt++ { // connect å°è¯•è¿æ¥ï¼Œå¹¶åœ¨æˆåŠŸåè§¦å‘changeConnäº‹ä»¶ï¼Œä¹Ÿä¼šæ›´æ–°isConnected if connected, err = w.connect(); err != nil { log.Printf(\u0026#34;Failed to connect: %s.\\n\u0026#34;, err) } if !connected { log.Printf(\u0026#34;Retrying... %d\\n\u0026#34;, cnt) } time.Sleep(reconnectDelay) } } // è¿æ¥æ­£å¸¸çš„æƒ…å†µä¸‹ï¼Œå¤„ç†channel.NotifyClose å’Œ conn.NotifyClose // æ³¨ï¼šåœ¨ä»»æ„ä¸€ä¸ªnotifyäº‹ä»¶é€šçŸ¥åï¼Œåº”å®Œå…¨å¤„ç†ä¸¤ä¸ªchannelä¸­çš„æ¶ˆæ¯ï¼Œå¦åˆ™ä¼šé€ æˆæ— ç¼“å†²é˜»å¡ã€‚ // https://ms2008.github.io/2019/06/16/golang-rabbitmq/ select { case \u0026lt;-w.done: println(\u0026#34;w.done\u0026#34;) return case err := \u0026lt;-w.chNotify: log.Printf(\u0026#34;channel close notify: %v\u0026#34;, err) w.isConnected = false case err := \u0026lt;-w.connNotify: log.Printf(\u0026#34;conn close notify: %v\u0026#34;, err) w.isConnected = false } time.Sleep(reconnectDetectDur) } } ä»¥ä¸Šã€‚\næ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿å‹˜è¯¯æŒ‡æ­£ğŸ™ã€‚\nå‚è€ƒ # https://github.com/streadway/amqp/issues/133 https://blog.csdn.net/jaredcoding/article/details/78656636 https://www.cnblogs.com/frankyou/p/5283539.html https://ms2008.github.io/2019/06/16/golang-rabbitmq/ã€å¿…è¯»ã€‘ "},{"id":38,"href":"/2019/09/21/TCP%E6%8B%86%E5%8C%85%E7%B2%98%E5%8C%85/","title":"TCPæ‹†åŒ…ä¸ç²˜åŒ…ï¼šä»å­—èŠ‚æµç‰¹æ€§åˆ°åº”ç”¨å±‚åè®®è®¾è®¡","section":"Posts","content":" \u0026ldquo;TCP is a stream-oriented protocol, not a message-oriented protocol.\u0026rdquo;\nåœ¨å®ç° RPC åè®®æˆ–å¤„ç†ç½‘ç»œé€šä¿¡æ—¶ï¼Œæˆ‘ä»¬å¸¸å¬åˆ°çš„æœ¯è¯­å°±æ˜¯â€œæ‹†åŒ…â€ï¼ˆPacket Splittingï¼‰å’Œâ€œç²˜åŒ…â€ï¼ˆPacket Aggregationï¼‰ã€‚è¿™ä¸¤ä¸ªç°è±¡å¾€å¾€è®©åˆå­¦è€…å›°æƒ‘ï¼šæ˜æ˜æˆ‘å‘é€çš„æ˜¯ä¸¤æ¡ç‹¬ç«‹çš„æ¶ˆæ¯ï¼Œä¸ºä»€ä¹ˆæ¥æ”¶ç«¯æ”¶åˆ°çš„æ˜¯ä¸€å¨æ··ä¹±çš„æ•°æ®ï¼Ÿæˆ–è€…ä¸ºä»€ä¹ˆæˆ‘å‘äº†ä¸€ä¸ªå¤§åŒ…ï¼Œå¯¹é¢å´åˆ†äº†å‡ æ¬¡æ‰æ”¶å…¨ï¼Ÿ\næœ¬æ–‡å°†æ¢ç©¶è¿™èƒŒåçš„åº•å±‚æœºåˆ¶ï¼Œå¹¶æ¼”ç¤ºåº”ç”¨å±‚åè®®å¦‚ä½•è®¾è®¡æ¥å±è”½è¿™äº›åº•å±‚ç»†èŠ‚ã€‚\nèƒŒæ™¯çŸ¥è¯†ï¼šMTU ä¸ MSS # è¦ç†è§£æ‹†åŒ…å’Œç²˜åŒ…ï¼Œé¦–å…ˆéœ€è¦ç†è§£ç½‘ç»œä¼ è¾“ä¸­çš„ä¸¤ä¸ªå…³é”®é™åˆ¶ï¼šMTU å’Œ MSSã€‚\nMTUï¼ˆMaximum Transmission Unitï¼‰ # The maximum transmission unit (MTU) is the size of the largest protocol data unit (PDU) that can be communicated in a single network layer transaction. â€”â€” from Wiki\nç®€å•æ¥è¯´ï¼ŒMTU æ˜¯æ•°æ®é“¾è·¯å±‚ï¼ˆå¦‚ä»¥å¤ªç½‘ï¼‰å¯¹ä¸Šå±‚ï¼ˆé€šå¸¸æ˜¯ IP å±‚ï¼‰è½½è·çš„æœ€å¤§é™åˆ¶ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œä»¥å¤ªç½‘çš„ MTU = 1500 bytesã€‚\nå¦‚æœ (IP Header + Transport Header + Data) \u0026gt; MTUï¼Œé‚£ä¹ˆ IP å±‚å°±å¿…é¡»è¿›è¡Œåˆ†ç‰‡ï¼ˆFragmentationï¼‰ã€‚\nMSSï¼ˆMaximum Segment Sizeï¼‰ # The maximum segment size (MSS) is a parameter of the options field of the TCP header that specifies the largest amount of data, specified in bytes, that a computer or communications device can receive in a single TCP segment. â€”â€” from Wiki\nMSS æ˜¯ TCP å±‚ ä¸ºäº†é¿å… IP å±‚åˆ†ç‰‡è€Œè®¡ç®—å‡ºçš„æœ€å¤§è½½è·å¤§å°ã€‚å®ƒä»£è¡¨äº† TCP æŠ¥æ–‡ä¸­ Payload çš„æœ€å¤§å€¼ã€‚ MSS = MTU - IP Header Length - TCP Header Lengthã€‚\nç°è±¡è§£æ # ä¸ºä»€ä¹ˆä¼šå‡ºç°â€œæ‹†åŒ…â€ï¼Ÿ # æ‹†åŒ…æŒ‡çš„æ˜¯åº”ç”¨å±‚ä½œä¸ºä¸€ä¸ªæ•´ä½“å‘é€çš„æ•°æ®ï¼Œåœ¨åº•å±‚è¢«æ‹†åˆ†æˆäº†å¤šä¸ª TCP æ®µå‘é€ã€‚\næœ€ç›´æ¥çš„åŸå› å°±æ˜¯æ•°æ®é‡è¿‡å¤§ã€‚å¦‚æœåº”ç”¨å±‚ä¸€æ¬¡å†™å…¥çš„æ•°æ®å­—èŠ‚æ•°è¶…è¿‡äº† MSSï¼ŒTCP åè®®æ ˆå°±å¿…é¡»å°†å…¶æ‹†åˆ†ä¸ºå¤šä¸ªæ®µï¼ˆSegmentï¼‰è¿›è¡Œä¼ è¾“ã€‚\nä¸ºä»€ä¹ˆä¼šå‡ºç°â€œç²˜åŒ…â€ï¼Ÿ # ç²˜åŒ…æŒ‡çš„æ˜¯å‘é€ç«¯å¤šæ¬¡å‘é€çš„å°æ®µæ•°æ®ï¼Œåœ¨æ¥æ”¶ç«¯è¢«åˆå¹¶æˆäº†ä¸€ä¸ªå¤§çš„æ•°æ®å—è¯»å–åˆ°ã€‚\nåŸå› ä¸»è¦æœ‰äºŒï¼š\nNagle ç®—æ³•ï¼šä¸ºäº†æ”¹å–„ç½‘ç»œä¼ è¾“æ•ˆç‡ï¼ŒTCP é»˜è®¤å¯ç”¨äº† Nagle ç®—æ³•ã€‚ç®€å•æ¥è¯´ï¼Œå¦‚æœä½ è¿ç»­å‘é€å¾ˆå°çš„æ•°æ®å—ï¼ŒTCP ä¸ä¼šç«‹å³å‘é€ï¼Œè€Œæ˜¯ä¼šåœ¨æœ¬åœ°ç¼“å†²åŒºç§¯æ”’ä¸€ä¸‹ï¼Œç­‰æ”’å¤Ÿäº†æˆ–è€…æ”¶åˆ°ä¸Šä¸€ä¸ªåŒ…çš„ ACK åï¼Œå†ä¸€æ¬¡æ€§æ‰“åŒ…å‘å‡ºå»ã€‚ æ¥æ”¶ç«¯ç¼“å†²ï¼šTCP æ¥æ”¶ç«¯æ‹¥æœ‰è‡ªå·±çš„ç¼“å†²åŒºã€‚å¦‚æœåº”ç”¨å±‚è¯»å–ä¸åŠæ—¶ï¼Œåç»­çš„ TCP æ®µä¹Ÿä¼šè¢«å †ç§¯åœ¨è¿™ä¸ªç¼“å†²åŒºä¸­ã€‚å½“åº”ç”¨å±‚å»è¯»å–æ—¶ï¼Œä¸€æ¬¡æ€§å°±è¯»åˆ°äº†å¤šä¸ªé€»è¾‘ä¸Šç‹¬ç«‹çš„æ•°æ®åŒ…ã€‚ æ ¸å¿ƒæœ¬è´¨ # æ— è®ºæ˜¯æ‹†åŒ…è¿˜æ˜¯ç²˜åŒ…ï¼Œå…¶æœ¬è´¨å½’ç»“ä¸ºä¸€å¥è¯ï¼š\nTCP æ˜¯é¢å‘å­—èŠ‚æµçš„åè®®ï¼Œæ²¡æœ‰â€œæ¶ˆæ¯è¾¹ç•Œâ€çš„æ¦‚å¿µã€‚\nTCP åªè´Ÿè´£æŠŠä¸€ä¸²å­—èŠ‚æµæ— å·®é”™åœ°ä¼ é€åˆ°å¯¹é¢ï¼Œå®ƒä¸ç†è§£â€œè¿™ 100 ä¸ªå­—èŠ‚æ˜¯ä¸€ä¸ªè¯·æ±‚ï¼Œåé¢ 50 ä¸ªå­—èŠ‚æ˜¯å¦ä¸€ä¸ªè¯·æ±‚â€ã€‚æ‰€è°“çš„â€œåŒ…â€å’Œâ€œç•Œé™â€ï¼Œå®Œå…¨æ˜¯åº”ç”¨å±‚ä¸ºäº†ä¾¿äºå¤„ç†ä¸šåŠ¡é€»è¾‘è€Œå¼ºåŠ ä¸Šå»çš„è¯­ä¹‰ã€‚\nè§£å†³æ–¹æ¡ˆ # æ—¢ç„¶ TCP ä¸ç®¡è¾¹ç•Œï¼Œé‚£åº”ç”¨å±‚å°±å¿…é¡»è‡ªå·±æ¥åˆ’æ¸…ç•Œé™ã€‚å¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š\n1. ç‰¹æ®Šåˆ†éš”ç¬¦ï¼ˆå¦‚ HTTPï¼‰ # å¯¹äºæ–‡æœ¬åè®®ï¼Œæœ€å¸¸è§çš„æ˜¯ä½¿ç”¨ç‰¹æ®Šå­—ç¬¦ä½œä¸ºè¾¹ç•Œã€‚ ä¾‹å¦‚ HTTP/1.1ï¼Œä½¿ç”¨ \\r\\n\\r\\n (CRLF CRLF) æ¥åŒºåˆ† Header å’Œ Bodyï¼Œæˆ–è€…åŒºåˆ†è¿ç»­çš„è¯·æ±‚ã€‚\n2. Length-Prefixed åè®®ï¼ˆäºŒè¿›åˆ¶åè®®ï¼‰ # å¯¹äºäºŒè¿›åˆ¶åè®®ï¼Œæœ€é€šç”¨çš„åšæ³•æ˜¯åœ¨æ¶ˆæ¯å¤´éƒ¨å›ºå®šä½ç½®å£°æ˜æ¶ˆæ¯ä½“çš„é•¿åº¦ï¼ˆLength-Prefixedï¼‰ã€‚\næ¥æ”¶ç«¯çš„é€»è¾‘å˜å¾—éå¸¸ä¸¥è°¨ï¼š\nå…ˆè¯»å–å›ºå®šé•¿åº¦çš„å¤´éƒ¨ï¼ˆHeaderï¼‰ã€‚ è§£æå¤´éƒ¨ï¼Œè·å–æ¶ˆæ¯ä½“é•¿åº¦ï¼ˆBody Lengthï¼‰ã€‚ æ ¹æ® Body Lengthï¼Œç²¾ç¡®è¯»å–æŒ‡å®šå­—èŠ‚æ•°çš„ Bodyã€‚ åè®®è®¾è®¡ç¤ºä¾‹ï¼ˆGolangï¼‰ # Talk is cheap, show me your Code. ä¸‹é¢æˆ‘ä»¬é€šè¿‡ Golang ä»£ç æ¥å±•ç¤ºä¸€ä¸ªå®Œæ•´çš„äºŒè¿›åˆ¶åè®®å®ç°ã€‚\n1. åè®®å¸¸é‡ä¸ç»“æ„ä½“å®šä¹‰\né¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰åè®®çš„å¸¸é‡ï¼ˆå¦‚ç‰ˆæœ¬å·ã€æ“ä½œç ï¼‰ä»¥åŠå¤´éƒ¨é•¿åº¦çš„è®¡ç®—è§„åˆ™ã€‚\npackage proto import ( \u0026#34;bufio\u0026#34; \u0026#34;encoding/binary\u0026#34; \u0026#34;errors\u0026#34; ) const ( // OpRequest Operation Request OpRequest uint16 = iota + 1 // OpResponse Operation Response OpResponse ) const ( // Ver1 Version 1 Ver1 uint16 = 1 ) var ( // ErrProtoHeaderLen . ErrProtoHeaderLen = errors.New(\u0026#34;not matched proto header len\u0026#34;) // ErrEmptyReader . ErrEmptyReader = errors.New(\u0026#34;empty reader\u0026#34;) ) const ( // Protocol Header Size Definition _packSize uint16 = 4 _headerSize uint16 = 2 _verSize uint16 = 2 _opSize uint16 = 2 _seqSize uint16 = 2 _rawHeaderSize uint16 = _packSize + _headerSize + _verSize + _opSize + _seqSize // Offsets _packOffset uint16 = 0 _headerOffset = _packOffset + _packSize _verOffset = _headerOffset + _headerSize _opOffset = _verOffset + _verSize _seqOffset = _opOffset + _opSize ) // Proto å®šä¹‰äº†åè®®çš„æ•°æ®ç»“æ„ type Proto struct { Ver uint16 Op uint16 // Type of Proto Seq uint16 // Seq of message Body []byte // Body of Proto } 2. å‘é€æ¶ˆæ¯ï¼ˆWriteTCPï¼‰\nå‘é€ç«¯çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼šè®¡ç®—æ•´ä¸ªåŒ…çš„é•¿åº¦ï¼Œå°† Header å„å­—æ®µæŒ‰å¤§ç«¯åºï¼ˆBigEndianï¼‰å†™å…¥ Bufferï¼Œæœ€åè¿½åŠ  Body å¹¶å†™å…¥ TCP è¿æ¥ã€‚\n// WriteTCP å°† Proto å¯¹è±¡åºåˆ—åŒ–å¹¶å†™å…¥ buffer func (p *Proto) WriteTCP(wr *bufio.Writer) (err error) { var ( buf = make([]byte, _rawHeaderSize) packLen int ) // è®¡ç®—åŒ…æ€»é•¿ = å¤´é•¿ + Bodyé•¿ packLen = int(_rawHeaderSize) + len(p.Body) // ä¾æ¬¡å†™å…¥å„ä¸ªå­—æ®µ (BigEndian) binary.BigEndian.PutUint32(buf[_packOffset:], uint32(packLen)) binary.BigEndian.PutUint16(buf[_headerOffset:], _rawHeaderSize) binary.BigEndian.PutUint16(buf[_verOffset:], p.Ver) binary.BigEndian.PutUint16(buf[_opOffset:], p.Op) binary.BigEndian.PutUint16(buf[_seqOffset:], p.Seq) // å†™ Header if _, err = wr.Write(buf); err != nil { return } // å†™ Body if p.Body != nil { _, err = wr.Write(p.Body) } return } 3. æ¥æ”¶æ¶ˆæ¯ï¼ˆReadTCPï¼‰\næ¥æ”¶ç«¯æ˜¯è§£å†³â€œæ‹†åŒ…ç²˜åŒ…â€çš„ä¸»æˆ˜åœºã€‚æˆ‘ä»¬éœ€è¦ä¸¥æ ¼æŒ‰ç…§ ReadNBytes çš„è¯­ä¹‰ï¼Œå…ˆè¯»æ»¡å¤´éƒ¨ï¼Œè§£æå‡º Body é•¿åº¦ï¼Œå†è¯»æ»¡ Bodyã€‚\n// ReadTCP ä» buffer ä¸­è¯»å–å¹¶ååºåˆ—åŒ–å‡º Proto å¯¹è±¡ func (p *Proto) ReadTCP(rr *bufio.Reader) (err error) { var ( bodyLen int headerLen uint16 packLen int buf []byte ) // 1. ä¸¥æ ¼è¯»å–å¤´éƒ¨å›ºå®šé•¿åº¦çš„å­—èŠ‚ if buf, err = ReadNBytes(rr, int(_rawHeaderSize)); err != nil { return } // 2. è§£æ Headerï¼Œè·å–åŒ…æ€»é•¿ packLen = int(binary.BigEndian.Uint32(buf[_packOffset:_headerOffset])) headerLen = binary.BigEndian.Uint16(buf[_headerOffset:_verOffset]) p.Ver = binary.BigEndian.Uint16(buf[_verOffset:_opOffset]) p.Op = binary.BigEndian.Uint16(buf[_opOffset:_seqOffset]) p.Seq = binary.BigEndian.Uint16(buf[_seqOffset:]) if headerLen != _rawHeaderSize { return ErrProtoHeaderLen } // 3. æ ¹æ®åŒ…æ€»é•¿å’Œå¤´é•¿ï¼Œè®¡ç®— Body é•¿åº¦ if bodyLen = packLen - int(headerLen); bodyLen \u0026gt; 0 { // 4. ä¸¥æ ¼è¯»å– Body é•¿åº¦çš„å­—èŠ‚ p.Body, err = ReadNBytes(rr, bodyLen) } else { p.Body = nil } return } // ReadNBytes ä¿è¯ä» reader ä¸­è¯»å– n ä¸ªå­—èŠ‚ï¼Œè§£å†³æ‹†åŒ…é—®é¢˜ func ReadNBytes(rr *bufio.Reader, N int) ([]byte, error) { if rr == nil { return nil, ErrEmptyReader } var ( buf = make([]byte, N) err error ) for i := 0; i \u0026lt; N; i++ { // ReadByte ä¼šé˜»å¡ç›´åˆ°è¯»åˆ°ä¸€ä¸ªå­—èŠ‚ if buf[i], err = rr.ReadByte(); err != nil { return nil, err } } return buf, err } 4. å®é™…ä½¿ç”¨\nåœ¨ä¸šåŠ¡ä»£ç ä¸­ï¼Œæˆ‘ä»¬å°±å¯ä»¥éå¸¸è½»æ¾åœ°å¤„ç†è¿æ¥äº†ï¼Œå®Œå…¨ä¸ç”¨æ‹…å¿ƒåº•å±‚çš„ç²˜åŒ…é—®é¢˜ã€‚\nfunc (s *Server) handleConn(conn net.Conn) { rr := bufio.NewReader(conn) wr := bufio.NewWriter(conn) var ( precv = proto.New() psend = proto.New() ) // æ­¤æ—¶ ReadTCP ä¼šè‡ªåŠ¨å¤„ç†å¥½è¾¹ç•Œï¼Œè¿”å›ä¸€ä¸ªå®Œæ•´çš„ Request if err := precv.ReadTCP(rr); err != nil { // å¤„ç†é”™è¯¯... return } // ä¸šåŠ¡å¤„ç†... // å‘é€å“åº” psend.Body = []byte(\u0026#34;response data...\u0026#34;) psend.WriteTCP(wr) wr.Flush() // è®°å¾— Flush } æ€»ç»“ # TCP çš„æ‹†åŒ…ä¸ç²˜åŒ…ç°è±¡ï¼Œæœ¬è´¨ä¸Šæ˜¯â€œæµå¼ä¼ è¾“â€ä¸â€œæ¶ˆæ¯å¼å¤„ç†â€ä¹‹é—´çš„è¯­ä¹‰é¸¿æ²Ÿã€‚\nTCP å…³æ³¨ç½‘ç»œä¼ è¾“çš„æ•ˆç‡ä¸å¯é æ€§ï¼ˆæµï¼‰ã€‚ åº”ç”¨å±‚ å…³æ³¨ä¸šåŠ¡é€»è¾‘çš„å®Œæ•´æ€§ä¸ç‹¬ç«‹æ€§ï¼ˆæ¶ˆæ¯ï¼‰ã€‚ é€šè¿‡åœ¨åº”ç”¨å±‚åè®®ä¸­æ˜¾å¼å®šä¹‰â€œé•¿åº¦â€å­—æ®µï¼Œæˆ‘ä»¬èƒ½å¤Ÿåœ¨æµä¹‹ä¸Šé‡å»ºå‡ºå¯é çš„æ¶ˆæ¯è¾¹ç•Œï¼Œè¿™æ˜¯æ‰€æœ‰åŸºäº RPC çš„ä¸­é—´ä»¶ï¼ˆå¦‚ Dubboã€gRPCã€Thrift ç­‰ï¼‰åº•å±‚é€šä¿¡æ¨¡å—çš„å…±åŒåŸºçŸ³ã€‚\n"},{"id":39,"href":"/2019/09/19/%E5%88%9D%E8%AF%86Ring-Buffer/","title":"åˆè¯†Ring Buffer","section":"Posts","content":" ä½¿ç”¨åœºæ™¯ # ä¸€ä¸ªæœåŠ¡å™¨ç¨‹åºå¯èƒ½ä¼šæ”¶åˆ°å¤šä¸ªå®¢æˆ·ç«¯çš„ç½‘ç»œæ•°æ®æµï¼Œåœ¨æ¯ä¸ªæ•°æ®æµä¸Šå®é™…ä¸Šæœ‰å¤šä¸ªç‹¬ç«‹çš„æ•°æ®åŒ…ï¼Œåªæœ‰ä¸€ä¸ªæ•°æ®åŒ…æ¥æ”¶å®Œæ•´äº†æ‰èƒ½åšè¿›ä¸€æ­¥çš„å¤„ç†ã€‚å¦‚æœåœ¨ä¸€ä¸ªç½‘ç»œè¿æ¥ä¸Šæ•°æ®åŒ…å¹¶ä¸å®Œæ•´ï¼Œå°±éœ€è¦æš‚æ—¶ç¼“å­˜ä½å°šæœªæ¥æ”¶å®Œçš„æ•°æ®åŒ…ã€‚\nè§£å†³ä»¥ä¸Šåœºæ™¯çš„æ–¹æ³•è‚¯å®šä¸æ­¢RingBufferè¿™ä¸€ç§ï¼ŒåŒç†RingBufferä¹Ÿä¸åªæ˜¯è¿™ä¸€ä¸ªä½¿ç”¨åœºæ™¯ï¼Œè¿™é‡Œåªæ˜¯ä»‹ç»ä¸‹RingBufferåœ¨è¿™ç§åœºæ™¯ä¸‹çš„ä½¿ç”¨ã€‚\nå®ç°æ–¹å¼ # RingBufferç»“æ„å®šä¹‰ï¼š\nconst A = 10 // Byts ... type Byts []byte // RingBuffer . not concurrent safe type RingBuffer struct { data []*Byts pRead uint pWrite uint size uint } // NewRingBuffer . at least 2 func NewRingBuffer(size uint) *RingBuffer { if size \u0026lt;= 1 { panic(\u0026#34;too small size\u0026#34;) } return \u0026amp;RingBuffer{ data: make([]*Byts, size), pRead: 0, pWrite: 0, size: size, } } RingBufferæ–¹æ³•å®šä¹‰ï¼š\nfunc (buf *RingBuffer) Write(d Byts) error { if (buf.pWrite+1)%buf.size == buf.pRead { return errFull } buf.data[buf.pWrite] = d buf.pWrite = (buf.pWrite + 1) % buf.size return nil } func (buf *RingBuffer) Read() (*Byts, error) { if buf.pRead == buf.pWrite { return nil, errEmpty } d := buf.data[buf.pRead] buf.pRead = (buf.pRead + 1) % buf.size return \u0026amp;d, nil } // Reset . drop all data func (buf *RingBuffer) Reset() { buf.pRead = 0 buf.pWrite = 0 } å‚è€ƒæ–‡çŒ® # Ring-Buffer in disroptor Introduction Goim Ring Bufferå®ç° Ring Buffer åº”ç”¨ "},{"id":40,"href":"/2019/08/12/LRU%E5%92%8CLRU-K/","title":"LRUå’ŒLRU-K","section":"Posts","content":" ç¼“å­˜æ·˜æ±°æœºåˆ¶ # ç¼“å­˜æ·˜æ±°æœºåˆ¶åœ¨ç¼“å­˜éœ€è¦è¢«æ¸…ç†çš„æ—¶å€™ä½¿ç”¨ã€‚ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ç®—æ³•ï¼š\nFIFOï¼šå…ˆå…¥å…ˆå‡ºï¼Œä¼˜å…ˆæ¸…ç†æœ€å…ˆè¢«ç¼“å­˜çš„æ•°æ®å¯¹è±¡ã€‚å®ç°ç®€å•ï¼Œç›´æ¥ä½¿ç”¨é˜Ÿåˆ—å°±å¯ä»¥å®ç°ã€‚ LRUï¼šæœ€è¿‘æœ€ä¹…æœªè¢«ä½¿ç”¨ï¼Œä¼˜å…ˆæ¸…ç†æœ€è¿‘æ²¡æœ‰è¢«ä½¿ç”¨çš„å¯¹è±¡ã€‚ä½¿ç”¨ä¸€ä¸ªæœ€è¿‘ä½¿ç”¨æ—¶é—´é™åºçš„æœ‰åºé˜Ÿåˆ—ï¼Œä¼˜å…ˆæ¸…ç†é˜Ÿåˆ—å¯¹åçš„æ•°æ®ã€‚ä¸LFUçš„åŒºåˆ«åœ¨äºï¼šLRUæ˜¯æŒ‰ç…§æœ€è¿‘ä½¿ç”¨ä½¿ç”¨çš„æ—¶é—´æ’åºï¼ŒLFUéœ€è¦ç»´æŠ¤ä¸€ä¸ªä½¿ç”¨é¢‘æ¬¡å¹¶ç”¨äºæ’åºã€‚ LFUï¼šæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼Œä¼˜å…ˆæ¸…ç†æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®å¯¹è±¡ã€‚ä½¿ç”¨ä¸€ä¸ªä½¿ç”¨æ¬¡æ•°é™åºçš„æœ‰åºé˜Ÿåˆ—ï¼Œä¼˜å…ˆæ¸…ç†é˜Ÿåˆ—æœ€åçš„æ•°æ®ã€‚ // å…¶ä¸­LRUå’ŒLFUå¯ä»¥é€šè¿‡ç»´æŠ¤ä¸€ä¸ªHashmapæ¥æé«˜è®¿é—®æ•ˆç‡ã€‚\nLRU / LRU-1 # LRUï¼ˆLeast recently usedï¼Œæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ç®—æ³•æ ¹æ®æ•°æ®çš„å†å²è®¿é—®è®°å½•æ¥è¿›è¡Œæ·˜æ±°æ•°æ®ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯â€œå¦‚æœæ•°æ®æœ€è¿‘è¢«è®¿é—®è¿‡ï¼Œé‚£ä¹ˆå°†æ¥è¢«è®¿é—®çš„å‡ ç‡ä¹Ÿæ›´é«˜â€ã€‚å®ç°æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼Œå°±ä¸è¿‡å¤šèµ˜è¿°äº†ï¼š\n// data to cache type data struct { key int value int } // LRUCache structture to support LRU alg. type LRUCache struct { recoder map[int]*list.Element // key hit for get op O(1) linked *list.List // linked-list rest int // rest capacity } // Constructor ... to generate a LRUCache func Constructor(capacity int) LRUCache { c := LRUCache{ rest: capacity, linked: list.New(), recoder: make(map[int]*list.Element), } return c } // Get ... O(1) wanted func (c *LRUCache) Get(key int) int { v, ok := c.recoder[key] if !ok { return -1 } // hit the key _ = c.linked.Remove(v) c.recoder[key] = c.linked.PushFront(v.Value) fmt.Println(\u0026#34;get\u0026#34;, key, c.linked.Len(), c.recoder) return v.Value.(*data).value } // Put ... O(1) wanted func (c *LRUCache) Put(key int, value int) { if v, ok := c.recoder[key]; ok { c.linked.Remove(v) goto h } if c.rest == 0 { tail := c.linked.Back() c.linked.Remove(tail) delete(c.recoder, tail.Value.(*data).key) } else { c.rest-- } h: head := c.linked.PushFront(\u0026amp;data{key, value}) c.recoder[key] = head } LRU-K # LRU-Kçš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†è§£å†³LRUç®—æ³•â€œç¼“å­˜æ±¡æŸ“â€çš„é—®é¢˜ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†â€œæœ€è¿‘ä½¿ç”¨è¿‡1æ¬¡â€çš„åˆ¤æ–­æ ‡å‡†æ‰©å±•ä¸ºâ€œæœ€è¿‘ä½¿ç”¨è¿‡Kæ¬¡â€ã€‚ä¹Ÿå°±æ˜¯è¯´æ²¡æœ‰åˆ°è¾¾Kæ¬¡è®¿é—®çš„æ•°æ®å¹¶ä¸ä¼šè¢«ç¼“å­˜ï¼Œè¿™ä¹Ÿæ„å‘³ç€éœ€è¦å¯¹äºç¼“å­˜æ•°æ®çš„è®¿é—®æ¬¡æ•°è¿›è¡Œè®¡æ•°ï¼Œå¹¶ä¸”è®¿é—®è®°å½•ä¸èƒ½æ— é™è®°å½•ï¼Œä¹Ÿéœ€è¦ä½¿ç”¨æ›¿æ¢ç®—æ³•è¿›è¡Œæ›¿æ¢ã€‚å½“éœ€è¦æ·˜æ±°æ•°æ®æ—¶ï¼ŒLRU-Kä¼šæ·˜æ±°ç¬¬Kæ¬¡è®¿é—®æ—¶é—´è·å½“å‰æ—¶é—´æœ€å¤§çš„æ•°æ®ã€‚\nç®€å•çš„æè¿°å°±æ˜¯ï¼šå½“è®¿é—®æ¬¡æ•°è¾¾åˆ°Kæ¬¡åï¼Œå°†æ•°æ®ç´¢å¼•ä»å†å²é˜Ÿåˆ—ç§»åˆ°ç¼“å­˜é˜Ÿåˆ—ä¸­ï¼ˆç¼“å­˜é˜Ÿåˆ—æ—¶é—´é™åºï¼‰ï¼›ç¼“å­˜æ•°æ®é˜Ÿåˆ—ä¸­è¢«è®¿é—®åé‡æ–°æ’åºï¼›éœ€è¦æ·˜æ±°æ•°æ®æ—¶ï¼Œæ·˜æ±°ç¼“å­˜é˜Ÿåˆ—ä¸­æ’åœ¨æœ«å°¾çš„æ•°æ®ã€‚\nç›¸æ¯”äºLRU-1ï¼Œç¼“å­˜æ•°æ®æ›´ä¸å®¹æ˜“è¢«æ›¿æ¢ï¼Œè€Œä¸”å¶å‘æ€§çš„æ•°æ®ä¸æ˜“è¢«ç¼“å­˜ã€‚åœ¨ä¿è¯äº†ç¼“å­˜æ•°æ®çº¯å‡€çš„åŒæ—¶è¿˜æé«˜äº†çƒ­ç‚¹æ•°æ®å‘½ä¸­ç‡ã€‚\ncode æœ‰ç‚¹ç•¥é•¿\nä¸‹é¢çš„ä»£ç åªèƒ½å¸®åŠ©ç†è§£LRU-Kçš„ç®—æ³•æ€æƒ³ï¼Œå¹¶ä¸é€‚ç”¨äºç”Ÿäº§ã€‚\n// LRUKCache history count struct type historyCounter struct { key int visited uint } // LRUKCache . type LRUKCache struct { K uint // the K setting rest uint // max - used = rest historyRest uint // historyMax - used = historyRest history *list.List // history doubly linked list historyHash map[int]*list.Element // history get op O(1) cache *list.List // cache doubly linked list, save cacheHash map[int]*list.Element // cache get op O(1) } // NewLRUKCache . func NewLRUKCache(k uint, capacity uint) *LRUKCache { // ignored } // reorderCache cache linked-list to sort (Least Recently Used) func (c *LRUKCache) reorderCache(ele *list.Element) { // é»˜è®¤æœ€è¿‘è®¿é—®çš„å…ƒç´ æ’åœ¨é˜Ÿé¦– } func (c *LRUKCache) cacheReplacingCheck() { if c.rest == 0 { // å¦‚æœè¶…å‡ºå®¹é‡åˆ™åˆ é™¤é˜Ÿå°¾å…ƒç´  } } func (c *LRUKCache) historyReplacingCheck() { if c.historyRest == 0 { // å¦‚æœè¶…å‡ºå®¹é‡åˆ™åˆ é™¤é˜Ÿå°¾å…ƒç´  } } func (c *LRUKCache) delfromHistory(key int) { // ä»å†å²ä¸­åˆ é™¤ä¸€ä¸ªå…ƒç´  } func (c *LRUKCache) addtoCache(d data) { // å¢åŠ ä¸€æ¡ç¼“å­˜è®°å½• } func (c *LRUKCache) addtoHistory(key, value int) historyCounter { var ( hc historyCounter ) hEle, ok := c.historyHash[key] if ok { // å¦‚æœå·²ç»å­˜åœ¨äºå†å²é˜Ÿåˆ—ä¸­ï¼Œåˆ™è‡ªå¢è®¿é—®æ¬¡æ•° hc = hEle.Value.(historyCounter) hc.visited++ // å¦‚æœè®¿é—®æ¬¡æ•°è¾¾åˆ°æ ‡å‡†ï¼Œåˆ™ä»å†å²ä¸­æ¼”ç§»é™¤ï¼Œå¢åŠ åœ¨ç¼“å­˜é˜Ÿåˆ—ä¸­å» if hc.visited \u0026gt;= c.K { // true: removed from history, and add into cache c.delfromHistory(key) c.addtoCache(data{key: key, value: value}) return hc } // å¦åˆ™å†™å›å†å²é˜Ÿåˆ— hEle.Value = hc } else { // å¦‚æœä¸å­˜åœ¨äºå†å²é˜Ÿåˆ—ä¸­ c.historyReplacingCheck() hc = historyCounter{key: key, visited: 1} hEle = c.history.PushFront(hc) c.historyRest-- } // æ›´æ–°å†å²è®¿é—®æ•°æ® c.historyHash[key] = hEle return hc } // Get key of cache in LRUKCache . func (c *LRUKCache) Get(key int) (value int, ok bool) { ele, ok := c.cacheHash[key] if ok { c.reorderCache(ele) return ele.Value.(data).value, true } // false: missed return 0, false } // Put of LRUKCache func (c *LRUKCache) Put(key, value int) { ele, ok := c.cacheHash[key] if ok { // true: hit the key c.reorderCache(ele) return } _ = c.addtoHistory(key, value) fmt.Printf(\u0026#34;cacheRest: %d / cacheMap: %v \\nhistoryRest: %d / historyMap: %v\\n\\n\u0026#34;, c.rest, c.cacheHash, c.historyRest, c.historyHash) return } testcase\nfunc TestLRUKCache(t *testing.T) { cache := cp.NewLRUKCache(2, 2) cache.Put(2, 1) if _, hit := cache.Get(2); hit { t.Error(\u0026#34;could not get 2 hit\u0026#34;) } cache.Put(3, 1) if _, hit := cache.Get(3); hit { t.Error(\u0026#34;could not get 3 hit\u0026#34;) } cache.Put(3, 1) if _, hit := cache.Get(3); !hit { t.Error(\u0026#34;should get 3 hit\u0026#34;) } cache.Put(4, 1) cache.Put(4, 1) if _, hit := cache.Get(2); hit { t.Error(\u0026#34;could not get 2 hit\u0026#34;) } if _, hit := cache.Get(4); !hit { t.Error(\u0026#34;should get 2 hit\u0026#34;) } if _, hit := cache.Get(3); !hit { t.Error(\u0026#34;should get 3 hit\u0026#34;) } } output\n# cacheRest: 2, historyRest: 6, k: 2 # cache.Put(2, 1) cacheRest: 2 / cacheMap: map[] historyRest: 5 / historyMap: map[2:0xc00006e420] # cache.Put(3, 1) cacheRest: 2 / cacheMap: map[] historyRest: 4 / historyMap: map[2:0xc00006e420 3:0xc0000e0000] # cache.Put(3, 1) cacheRest: 1 / cacheMap: map[3:0xc00006e4b0] historyRest: 5 / historyMap: map[2:0xc00006e420] # cache.Put(4, 1) cacheRest: 1 / cacheMap: map[3:0xc00006e4b0] historyRest: 4 / historyMap: map[2:0xc00006e420 4:0xc00006e570] # cache.Put(4, 1) cacheRest: 0 / cacheMap: map[3:0xc00006e4b0 4:0xc0000e00f0] historyRest: 5 / historyMap: map[2:0xc00006e420] FAQ # Q1. LRUç¼“å­˜æ±¡æŸ“æŒ‡çš„æ˜¯ä»€ä¹ˆæƒ…å†µï¼Ÿ\nå¶å‘æ€§çš„ã€å‘¨æœŸæ€§çš„æ‰¹é‡æ“ä½œä¼šå¯¼è‡´LRUå‘½ä¸­ç‡æ€¥å‰§ä¸‹é™ï¼Œè¿™æ—¶å€™ç¼“å­˜ä¸­çš„æ•°æ®å¤§éƒ¨åˆ†éƒ½ä¸æ˜¯çƒ­ç‚¹æ•°æ®ã€‚\nQ2. LRU-Kçš„Kå€¼æ€ä¹ˆç¡®å®šï¼Ÿ\nKå€¼å¢å¤§ï¼Œå‘½ä¸­ç‡ä¼šæ›´é«˜ï¼Œä½†æ˜¯é€‚åº”æ€§å·®ï¼ˆæ¸…é™¤ä¸€ä¸ªç¼“å­˜éœ€è¦å¤§é‡çš„æ•°æ®è®¿é—®ï¼Œä¸€èˆ¬é€‰æ‹©LRU-2ï¼‰ã€‚\n"},{"id":41,"href":"/2019/04/05/%E4%BB%8B%E7%BB%8D%E4%B8%80%E4%B8%8Bsnowflake%E5%92%8Crc4/","title":"ä»‹ç»ä¸€ä¸‹snowflakeå’Œrc4","section":"Posts","content":"snowflakeæ˜¯twitterå…¬å¸å¼€æºçš„ç”Ÿæˆå”¯ä¸€IDçš„ç½‘ç»œæœåŠ¡ï¼Œå…·æœ‰å¾ˆå¼ºçš„ä¼¸ç¼©æ€§ï¼Œè¿™é‡Œåªå–ç”¨ç”Ÿæˆå”¯ä¸€IDçš„ç®—æ³•éƒ¨åˆ†ã€‚ rc4ï¼ˆRivest Cipher 4ï¼‰æ˜¯ä¸€ç§æµåŠ å¯†ç®—æ³•ï¼Œå¯†é’¥é•¿åº¦å¯å˜ï¼Œå®ƒçš„åŠ è§£å¯†ä½¿ç”¨ç›¸åŒçš„å¯†é’¥ï¼Œå› æ­¤ä¹Ÿå±äºå¯¹ç§°åŠ å¯†ç®—æ³•ã€‚\nä¸ºå•¥è¦ä»‹ç»è¿™ä¸¤ç§ç®—æ³•ï¼Ÿ # å…¶ä¸€ï¼Œsnowflakeå¯ä»¥ç”Ÿæˆå”¯ä¸€IDï¼Œè€Œç›¸æ¯”ä¸UUIDï¼Œsnowflakeç”Ÿæˆçš„IDæ›´åŠ â€œå¥½ç”¨â€ï¼Œè¿™ä¸ªæ”¾åœ¨åé¢è§£é‡Šã€‚ å…¶äºŒï¼ŒUUIDå’Œsnowflakeè™½ç„¶å¯ä»¥ç”Ÿæˆå”¯ä¸€IDï¼Œä½†æ˜¯æ— æ³•é€‚ç”¨äºæ‰€æœ‰åœºæ™¯ï¼Œè­¬å¦‚è¯´â€œç”Ÿæˆæ¨å¹¿ç â€ã€‚ç”Ÿæˆæ¨å¹¿ç çš„æ—¶å€™ï¼Œå¸Œæœ›å°½å¯èƒ½çŸ­è€Œç²¾ï¼Œå¾ˆæ˜æ˜¾å”¯ä¸€IDéƒ½ä¸å¤ªçŸ­ã€‚\nsnowflake # snowflakeçš„å”¯ä¸€IDæ˜¯ä¸€ä¸ª64bitçš„intå‹æ•°æ®ï¼Œç›¸è¾ƒäºUUIDæ¥è¯´è€—è´¹ç©ºé—´æ›´å°ï¼Œå¯ä»¥æ›´æ–¹ä¾¿çš„ä½œä¸ºæ•°æ®åº“ä¸»é”®æ¥ç´¢å¼•å’Œæ’åºã€‚\nç”Ÿæˆè¿‡ç¨‹ï¼š # ç½®0ä¸ç”¨ timestampï¼ˆ41bitsï¼‰ç²¾ç¡®åˆ°msã€‚ machine-idï¼ˆ10bitsï¼‰è¯¥éƒ¨åˆ†å…¶å®ç”±datacenterIdå’ŒworkerIdä¸¤éƒ¨åˆ†ç»„æˆï¼Œè¿™ä¸¤éƒ¨åˆ†æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡æ˜çš„ã€‚datacenterIdï¼ˆ5bitsï¼‰æ–¹ä¾¿æ­å»ºå¤šä¸ªç”Ÿæˆuidçš„serviceï¼Œå¹¶ä¿è¯uidä¸é‡å¤ã€‚workerIdï¼ˆ5bitsï¼‰æ˜¯å®é™…serveræœºå™¨çš„ä»£å·ï¼Œæœ€å¤§åˆ°32ï¼ŒåŒä¸€ä¸ªdatacenterä¸‹çš„workerIdæ˜¯ä¸èƒ½é‡å¤çš„ã€‚ sequence-id(12bits)ï¼Œè¯¥idå¯ä»¥è¡¨ç¤º4096ä¸ªæ•°å­—ï¼Œå®ƒæ˜¯åœ¨timeç›¸åŒçš„æƒ…å†µä¸‹ï¼Œé€’å¢è¯¥å€¼ç›´åˆ°ä¸º0ï¼Œå³ä¸€ä¸ªå¾ªç¯ç»“æŸï¼Œæ­¤æ—¶ä¾¿åªèƒ½ç­‰åˆ°ä¸‹ä¸€ä¸ªmsåˆ°æ¥ï¼Œä¸€èˆ¬æƒ…å†µä¸‹4096/msçš„è¯·æ±‚æ˜¯ä¸å¤ªå¯èƒ½å‡ºç°çš„ï¼Œæ‰€ä»¥è¶³å¤Ÿä½¿ç”¨äº†ã€‚ ä¼˜åŠ¿å’Œç¼ºé™·ï¼š # é€Ÿåº¦å¿«ï¼Œæ— ä¾èµ–ï¼ŒåŸç†å’Œå®ç°ç®€å•ï¼Œä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚åšç®—æ³•è°ƒæ•´ ä¾èµ–æœºå™¨æ—¶é—´ï¼Œå¦‚æœæ—¶é—´å›æ‹¨å¯èƒ½å¯¼è‡´é‡å¤çš„ID rc4 # RC4åŠ å¯†ç®—æ³•ä¹Ÿæ˜¯ä¸€ç§åŸºäºå¯†é’¥æµçš„åŠ å¯†ç®—æ³•ã€‚\né¦–å…ˆï¼Œrc4æ ¹æ®æ˜æ–‡å’Œå¯†é’¥ç”Ÿæˆçš„å¯†é’¥æµï¼Œå…¶é•¿åº¦å’Œæ˜æ–‡çš„é•¿åº¦æ˜¯ç›¸ç­‰çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ˜æ–‡çš„é•¿åº¦æ˜¯500å­—èŠ‚ï¼Œé‚£ä¹ˆå¯†é’¥æµä¹Ÿæ˜¯500å­—èŠ‚ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ç”¨æ¥ç”Ÿæˆæ¨å¹¿ç çš„åŸå› ä¹‹ä¸€äº†ï¼›å…¶æ¬¡ï¼Œrc4æ˜¯æ˜¯å¯¹ç§°åŠ å¯†å®Œå…¨å¯ä»¥é€šè¿‡å¯†æ–‡å¾—åˆ°æ˜æ–‡ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ç”Ÿæˆç çš„æ—¶å€™æŠŠå¿…è¦ä¿¡æ¯æ”¾åœ¨æ˜æ–‡ä¸­ï¼Œåœ¨ä½¿ç”¨å¯†æ–‡çš„æ—¶å€™å¯ä»¥ä¸ç”¨æŸ¥åº“ä¹Ÿèƒ½å¾—åˆ°ç›¸å…³çš„ä¿¡æ¯ï¼Œè­¬å¦‚ç”¨æˆ·IDï¼Œè¿™æ˜¯åŸå› ä¹‹äºŒã€‚\nä½¿ç”¨åœºæ™¯ # ç°åœ¨éœ€è¦ç”Ÿæˆä¸€ç§ç ï¼ŒçŸ­å°æ˜“è®°ï¼Œä¸”å”¯ä¸€ï¼Œä½†å¹¶ä¸éœ€è¦å¤§é‡ã€‚\nä¸Šè¿°çš„snowflakeå’ŒUUIDéƒ½å¾ˆå®¹æ˜“å®ç°å”¯ä¸€ï¼Œä½†æ˜¯çŸ­å°å°±ä¸ç¬¦åˆè¦æ±‚äº†ã€‚å› ä¸ºå¹¶ä¸éœ€è¦å¤§é‡ç”Ÿæˆè¿™ç§ç ï¼Œå› æ­¤æˆ‘ä»¬è€ƒè™‘ç”¨è‡ªå¢ID + RC4æ¥å®ç°ï¼š\npackage main import ( \u0026#34;crypto/rc4\u0026#34; \u0026#34;encoding/hex\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;log\u0026#34; ) func main() { cipher, err := rc4.NewCipher([]byte(\u0026#34;thisiskey\u0026#34;)) if err != nil { log.Fatalf(\u0026#34;wrong with NewCipher: %v\u0026#34;, err) } c := map[string]bool{} for i := 0; i \u0026lt; 1000; i++ { src := []byte(fmt.Sprintf(\u0026#34;%7d\u0026#34;, i)) dst := make([]byte, len(src)) cipher.XORKeyStream(dst, src) s := toString(dst) // å¯†æ–‡æ˜¯ä¸å¯è¯»çš„å­—èŠ‚æµï¼Œè¿™é‡Œé‡‡ç”¨hexç¼–ç  println(s) // å½¢å¦‚ï¼ša09def6b6e4797 c[s] = true } println(len(c)) # 1000 } func toString(src []byte) string { return hex.EncodeToString(src) } å‚è€ƒ # twitter-snowflake bwmarrin/snowflake yeqown/snowflake å…³äºsnowflakeçš„åˆ†æ ä¸ºä»€ä¹ˆæ¨èInnoDBå¼•æ“ä½¿ç”¨è‡ªå¢ä¸»é”®? "},{"id":42,"href":"/2019/04/01/go-watcher-%E7%83%AD%E9%87%8D%E8%BD%BD%E8%BD%AE%E5%AD%90/","title":"go-watcher-çƒ­é‡è½½è½®å­","section":"Posts","content":"Golangç¼–å†™çš„çƒ­é‡è½½å·¥å…·ï¼Œè‡ªå®šä¹‰å‘½ä»¤ï¼Œæ”¯æŒç›‘è§†æ–‡ä»¶åŠè·¯å¾„é…ç½®ï¼Œç¯å¢ƒå˜é‡é…ç½®ã€‚è¿™æ˜¯ä¸€ä¸ªé‡å¤çš„è½®å­ï½\nå®‰è£…ä½¿ç”¨ # go install github.com/yeqown/go-watcher/cmd/go-watcher å‘½ä»¤è¡Œ # âœ go-watcher git:(master) âœ— ./go-watcher -h NAME: go-watcher - A new cli application USAGE: go-watcher [global options] command [command options] [arguments...] VERSION: 2.0.0 AUTHOR: yeqown@gmail.com COMMANDS: init generate a config file to specified postion run execute a command, and watch the files, if any change to these files, the command will reload help, h Shows a list of commands or help for one command GLOBAL OPTIONS: --help, -h show help --version, -v print the version é…ç½®æ–‡ä»¶ # watcher: # ç›‘è§†å™¨é…ç½® duration: 2000 # æ–‡ä»¶ä¿®æ”¹æ—¶é—´é—´éš”ï¼Œåªæœ‰é«˜äºè¿™ä¸ªé—´éš”æ‰å›è§¦å‘é‡è½½ included_filetypes: # ç›‘è§†çš„æ–‡ä»¶æ‰©å±•ç±»å‹ - .go # excluded_regexps: # ä¸è¢«ç›‘è§†æ›´æ”¹çš„æ–‡ä»¶æ­£åˆ™è¡¨è¾¾å¼ - ^.gitignore$ - \u0026#39;*.yml$\u0026#39; - \u0026#39;*.txt$\u0026#39; additional_paths: [] # é™¤äº†å½“å‰æ–‡ä»¶å¤¹éœ€è¦é¢å¤–ç›‘è§†çš„æ–‡ä»¶å¤¹ excluded_paths: # ä¸éœ€è¦ç›‘è§†çš„æ–‡ä»¶åï¼Œè‹¥ä¸ºç›¸å¯¹è·¯å¾„ï¼Œåªèƒ½å¯¹äºå½“å‰è·¯å¾„ç”Ÿæ•ˆ - vendor - .git envs: # é¢å¤–çš„ç¯å¢ƒå˜é‡ - GOROOT=/path/to/your/goroot - GOPATH=/path/to/your/gopath ä½¿ç”¨èŒƒä¾‹æ—¥å¿— # âœ go-watcher git:(master) âœ— ./package/osx/go-watcher run -e \u0026#34;make\u0026#34; -c ./config.yml [INFO] directory (/Users/yeqown/Projects/opensource/go-watcher) is under watching [INFO] directory (/Users/yeqown/Projects/opensource/go-watcher/cmd) is under watching [INFO] directory (/Users/yeqown/Projects/opensource/go-watcher/cmd/go-watcher) is under watching [INFO] directory (/Users/yeqown/Projects/opensource/go-watcher/internal) is under watching [INFO] directory (/Users/yeqown/Projects/opensource/go-watcher/internal/command) is under watching [INFO] directory (/Users/yeqown/Projects/opensource/go-watcher/internal/log) is under watching [INFO] directory (/Users/yeqown/Projects/opensource/go-watcher/internal/testdata) is under watching [INFO] directory (/Users/yeqown/Projects/opensource/go-watcher/internal/testdata/exclude) is under watching [INFO] directory (/Users/yeqown/Projects/opensource/go-watcher/internal/testdata/testdata_inner) is under watching [INFO] directory (/Users/yeqown/Projects/opensource/go-watcher/package) is under watching [INFO] directory (/Users/yeqown/Projects/opensource/go-watcher/package/archived) is under watching [INFO] directory (/Users/yeqown/Projects/opensource/go-watcher/package/linux) is under watching [INFO] directory (/Users/yeqown/Projects/opensource/go-watcher/package/osx) is under watching [INFO] directory (/Users/yeqown/Projects/opensource/go-watcher/resources) is under watching [INFO] directory (/Users/yeqown/Projects/opensource/go-watcher/utils) is under watching [INFO] directory (/Users/yeqown/Projects/opensource/go-watcher/utils/testdata) is under watching [INFO] directory (/Users/yeqown/Projects/opensource/go-watcher/utils/testdata/testdata_inner) is under watching rm -fr package go build -o package/osx/go-watcher cmd/go-watcher/main.go GOOS=linux GOARCH=amd64 go build -o package/linux/go-watcher cmd/go-watcher/main.go mkdir -p package/archived tar -zcvf package/archived/go-watcher.osx.tar.gz package/osx a package/osx a package/osx/go-watcher tar -zcvf package/archived/go-watcher.linux.tar.gz package/linux a package/linux a package/linux/go-watcher [INFO] command executed done! [INFO] (/Users/yeqown/Projects/opensource/go-watcher/package/osx/go-watcher) is skipped, not target filetype [INFO] (/Users/yeqown/Projects/opensource/go-watcher/package/osx) is skipped, not target filetype [INFO] (/Users/yeqown/Projects/opensource/go-watcher/package) is skipped, not target filetype [INFO] (/Users/yeqown/Projects/opensource/go-watcher/package/linux/go-watcher) is skipped, not target filetype [INFO] (/Users/yeqown/Projects/opensource/go-watcher/package/linux) is skipped, not target filetype [INFO] (/Users/yeqown/Projects/opensource/go-watcher/package/archived/go-watcher.linux.tar.gz) is skipped, not target filetype [INFO] (/Users/yeqown/Projects/opensource/go-watcher/package/archived) is skipped, not target filetype [INFO] (/Users/yeqown/Projects/opensource/go-watcher/VERSION) is skipped, not target filetype [INFO] [/Users/yeqown/Projects/opensource/go-watcher/cmd/go-watcher/main.go] changed rm -fr package mkdir -p package/osx mkdir -p package/linux echo \u0026#34;2.0.0\u0026#34; \u0026gt; VERSION cp VERSION package/osx cp VERSION package/linux go build -o package/osx/go-watcher cmd/go-watcher/main.go GOOS=linux GOARCH=amd64 go build -o package/linux/go-watcher cmd/go-watcher/main.go mkdir -p package/archived tar -zcvf package/archived/go-watcher.osx.tar.gz package/osx a package/osx a package/osx/go-watcher a package/osx/VERSION tar -zcvf package/archived/go-watcher.linux.tar.gz package/linux a package/linux a package/linux/go-watcher[INFO] (/Users/yeqown/Projects/opensource/go-watcher/package/osx) is skipped, not target filetype [INFO] (/Users/yeqown/Projects/opensource/go-watcher/package/linux) is skipped, not target filetype a package/linux/VERSION [INFO] command executed done! [INFO] (/Users/yeqown/Projects/opensource/go-watcher/package/osx) is skipped, not target filetype [INFO] (/Users/yeqown/Projects/opensource/go-watcher/package/archived) is skipped, not target filetype [INFO] (/Users/yeqown/Projects/opensource/go-watcher/package) is skipped, not target filetype [INFO] (/Users/yeqown/Projects/opensource/go-watcher/VERSION) is skipped, not target filetype [INFO] (/Users/yeqown/Projects/opensource/go-watcher/package) is skipped, not target filetype ^C[INFO] quit signal captured! [INFO] go-watcher exited âœ go-watcher git:(master) âœ— "},{"id":43,"href":"/2019/03/30/goswagger%E5%85%A5%E9%97%A8%E6%89%8B%E5%86%8C/","title":"goswaggerå…¥é—¨æ‰‹å†Œ","section":"Posts","content":" æœ¬æ–‡æ—¨åœ¨è®°å½•ä½¿ç”¨goswaggerè¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€äº›é—®é¢˜ï¼ˆåªåœ¨ç”Ÿæˆæ–‡æ¡£æ–¹é¢ï¼Œä¸æ¶‰åŠå…¶ä»–åŠŸèƒ½ï¼‰ï¼š\nå¦‚ä½•åœ¨go1.11+ä»¥ä¸Šï¼ˆæ”¯æŒGo Moduleï¼‰ç‰ˆæœ¬ä¸­çš„åº”ç”¨swagger ä¸€äº›æ³¨è§£ä¸Šçš„æ³¨æ„äº‹é¡¹ å¦‚ä½•åœ¨å›¢é˜Ÿä¸­ç®¡ç†APIæ–‡æ¡£ï¼ˆä¸»è¦æ¶µç›–äº†ï¼šswagger-uiçš„éƒ¨ç½²å’Œä½¿ç”¨ï¼‰ å…³äºswagger # swaggeræ¶µç›–WebAPIçš„ä¸€æ•´å¥—å·¥å…·ï¼šAPIè®¾è®¡ï¼ŒAPIå®ç°ï¼ˆä»£ç ç”Ÿæˆï¼‰ï¼ŒAPIæ–‡æ¡£ï¼ŒAPIæµ‹è¯•åŠAPIè§„èŒƒã€‚æ›´å¤šä¿¡æ¯è¯·å‚è§å®˜ç½‘\nå‡†å¤‡å·¥ä½œ # ä¸€ä¸ªGolang webé¡¹ç›®ï¼Œå¹¶è½¯è¿æ¥åˆ°GOPATH/srcä¸‹ã€‚ã€æ¯•ç«Ÿæ˜¯æ”¯æŒGomoduleçš„é¡¹ç›®ï¼Œè¿˜æ”¾åœ¨GOPATHä¸‹å°±ä¸ç§‘å­¦äº†ğŸ˜„ã€‘ å®‰è£…swaggerå·¥å…·. å‚è§å®‰è£… ç¯å¢ƒï¼š âœ swagger-demo git:(master) âœ— go version go version go1.11.5 darwin/amd64 âœ swagger-demo git:(master) âœ— swagger version version: v0.18.0 commit: 6b23bb61413826ce42c3b14a37bf5870caf91e0b ç¼–å†™æ³¨é‡Š # å…ƒä¿¡æ¯åŒ…å«äº†è¿™ä¸ªåº”ç”¨çš„åŸºæœ¬ä¿¡æ¯ã€‚ä¸€èˆ¬æ–°å»ºä¸€ä¸ªdoc.goæ”¾åœ¨ä½ çš„APIæ ¹ç›®å½•ä¸‹ï¼›è¿˜æœ‰ä¸€å®šè¦æ³¨æ„è¿™å¥è¯ï¼š\nYou give it a main file and it will parse all the files that are reachable by that main package to produce a swagger specification.To use you can add a go:generate comment to your main fileã€‚\n//go:generate swagger generate spec\nThe command requires a main package or file and it wants your code to compile. It uses the go tools loader to load an application and then scans all the packages that are in use by the code base. This means that for something to be discoverable it needs to be reachable by a code path triggered through the main package.\nå°±æ˜¯è¯´å¦‚æœä½ é…ç½®å¥½äº†ä¸€åˆ‡ä¸œè¥¿ï¼Œä½†æ˜¯å´å› ä¸ºä½ çš„mainåŒ…â€œèŠ±é‡Œèƒ¡å“¨â€ï¼Œè€Œæ— æ³•ç”Ÿæˆæ–‡æ¡£çš„æ—¶å€™ï¼Œè®°å¾—å°è¯•ä¸‹è¿™ä¸ªæ–¹æ³•ï¼ï¼ï¼\nä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªAPIçš„æ–‡æ¡£æ— éåŒ…æ‹¬ï¼šè¯·æ±‚æ–¹æ³•ï¼Œè·¯ç”±ï¼Œå‚æ•°ï¼Œå“åº”ã€‚å¦‚ä¸‹ï¼š\n// æ ¼å¼ï¼šswagger:parameters æ“ä½œID(ä¹Ÿå°±æ˜¯æ ‡ç¤ºä¸€ä¸ªè·¯ç”±çš„ID) // swagger:parameters opid-get type getForm struct { // in: query ID int `form:\u0026#34;id\u0026#34; binding:\u0026#34;required\u0026#34;` } // æ ¼å¼ï¼šswagger:model ?æ¨¡å‹å(å¯é€‰) // åŠ¨æ‰‹é¢˜ï¼šä¸ºä»€ä¹ˆè¿˜éœ€è¦é¢å¤–å®šä¹‰ä¸€ä¸ªæ¨¡å‹getmodelsæ¥ä½¿ç”¨ï¼Ÿè€Œä¸æ˜¯ç›´æ¥åœ¨getResponseä¸­ä½¿ç”¨ []*models.GetModel ? // swagger:model type getmodels []*models.GetModel // æ ¼å¼ï¼šswagger:response å“åº”ç»“æ„å // getResponse response demo of get controller // swagger:response getResponse type getResponse struct { // code intï¼Œè¿™é‡Œå‚æ•°è¾ƒå¤šè‡ªè¡Œå‚ç…§æ–‡æ¡£ï¼Œä¸ªäººè§‰å¾—æ¯”è¾ƒå®ç”¨çš„æ˜¯ â€œin: query|bodyâ€ ç”¨äºè¯´æ˜å‚æ•°å­˜åœ¨çš„ä½ç½® // in: body Code int `json:\u0026#34;code\u0026#34;` // modesl getmodel // in: body Models getmodels `json:\u0026#34;models\u0026#34;` } // Get ... func Get(c *gin.Context) { // swagger:route GET /base/get èŒƒä¾‹ opid-get // // swagger GetèŒƒä¾‹ // // // Consumes: // - application/json // - application/x-protobuf // // Produces: // - application/json // - application/x-protobuf // // Schemes: http, https, ws, wss // // Responses: // default: getResponse var ( form = new(getForm) resp = new(getResponse) ) resp.Code = 0 resp.Models = services.ListGetModels() log.Println(\u0026#34;form is :\u0026#34;, *form) c.JSON(http.StatusOK, resp) } ä¸Šè¿°åªæ˜¯æœ€åŸºæœ¬çš„å…³äºä¸€ä¸ªAPIçš„åŸºç¡€æ³¨é‡Šã€‚æ›´å¤šè¯·å‚è§å®˜æ–¹æ–‡æ¡£ï¼Œå°½ç®¡å®ƒä¸ä¸€å®šæ˜¯æœ€æ–°çš„ï½\nç”ŸæˆAPIæ–‡æ¡£ï¼ˆswagger.jsonï¼‰ # swagger ç”Ÿæˆæ–‡æ¡£çš„å‘½ä»¤å¦‚ä¸‹ï¼š\nâœ gonic git:(master) âœ— swagger generate spec -h Usage: swagger [OPTIONS] generate spec [spec-OPTIONS] generate a swagger spec document from a go application Application Options: -q, --quiet silence logs -o, --output=LOG-FILE redirect logs to file Help Options: -h, --help Show this help message [spec command options] -b, --base-path= the base path to use (default: .) -t, --tags= build tags -m, --scan-models includes models that were annotated with \u0026#39;swagger:model\u0026#39; --compact when present, doesn\u0026#39;t prettify the json -o, --output= the file to write to -i, --input= the file to use as input -c, --include= include packages matching pattern -x, --exclude= exclude packages matching pattern --include-tag= include routes having specified tags (can be specified many times) --exclude-tag= exclude routes having specified tags (can be specified many times) ç”¨äºè¯´æ˜çš„Makefile\ngen-doc: # ä¸ v3æ— å¼‚ï¼Œåªæ˜¯ä¸æ ¼å¼åŒ–ç”Ÿæˆçš„jsonæ–‡ä»¶ GO111MODULE=off swagger generate spec -o swagger-demo.swagger.final.json -b ./mainC -c swagger-demo -m --compact gen-doc-v3: # æ”¯æŒæ‰«æ swagger:model GO111MODULE=off swagger generate spec -o swagger-demo.swagger.v3.json -b ./mainC -c swagger-demo -m gen-doc-v2: # å¦‚æœé‡åˆ°æ‰¾ä¸åˆ°è‡ªå·±é¡¹ç›®å†…éƒ¨åŒ…çš„æƒ…å†µï¼Œä¸”mainåŒ…èŠ±é‡Œå‘¼å“¨ GO111MODULE=off swagger generate spec -o swagger-demo.swagger.v2.json -b ./mainC -c swagger-demo gen-doc-v1: # mainåŒ…èŠ±é‡Œèƒ¡å“¨ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå•æ–‡ä»¶ GO111MODULE=off swagger generate spec -o swagger-demo.swagger.v1.json -b ./mainC gen-doc-v0: # å¸¸è§„ç”¨æ³•ï¼ˆé€‚ç”¨äºç¬¦åˆgoswaggeræ ‡å‡†çš„é¡¹ç›®ï¼‰ GO111MODULE=off swagger generate spec -o swagger-demo.swagger.v0.json default: gen-doc-v0 gen-doc-v1 gen-doc-v2 gen-doc-v3 gen-doc ç®¡ç†APIæ–‡æ¡£ # ç”Ÿæˆäº†swagger.jsonæ–‡ä»¶ä¹‹åï¼Œæ¥ä¸‹æ¥å°±ç¥­å‡ºå¯è§†åŒ–å·¥å…·äº†swagger-uiã€‚å¦‚æœåªæ˜¯å°é²œï¼Œå¯ä»¥å…ˆç”¨swagger-editoré¢„è§ˆä¸€ä¸‹ã€‚\nè¯ä¸å¤šè¯´ï¼š swagger-uiçš„dockeré•œåƒç‰ˆï¼šè‡ªå¸¦nginxã€‚\nç›´æ¥ä¸Šdocker-composeé…ç½®æ–‡ä»¶ï¼Œè¯­æ³•å¯èƒ½ä¸å…¼å®¹å„ä¸ªç‰ˆæœ¬ï¼Œè¯·è‡ªè¡Œè°ƒè¯•ã€‚\nversion: \u0026#34;2\u0026#34; services: swagger_ui: environment: - SWAGGER_JSON=/usr/share/nginx/html/docs/swagger.json image: \u0026#34;swaggerapi/swagger-ui\u0026#34; volumes: [\u0026#34;./docs/:/usr/share/nginx/html/docs:rw\u0026#34;] restart: always ports: [\u0026#34;9000:8080\u0026#34;] æŠŠå®¹å™¨è¿è¡Œèµ·æ¥åï¼Œä½ å°±å¯ä»¥åœ¨é…ç½®çš„ç«¯å£è®¿é—®åˆ°swagger-uiçš„ç•Œé¢äº†ï¼Œåœ¨é¡¶éƒ¨çš„æœç´¢æ ä¸­è¾“å…¥æƒ³è¦æŸ¥çœ‹çš„æ–‡æ¡£çš„URLï¼Œå°±å¯ä»¥æ–¹ä¾¿çš„æŸ¥çœ‹æ–‡æ¡£äº†ã€‚\nå‚è€ƒèµ„æ–™ # ä»¥ä¸Šä»£ç å‡åœ¨yeqown/playground/gonic/swagger-demoå¯ä»¥æ‰¾åˆ° swaggerå®˜ç½‘ goswagger.io "},{"id":44,"href":"/2018/11/26/QR-Code%E7%94%9F%E6%88%90%E5%99%A8forgolang/","title":"Go è¯­è¨€å®ç° QR Code ç”Ÿæˆå™¨ï¼šä»åŸç†åˆ°å®è·µ","section":"Posts","content":" é¡¹ç›®åœ°å€ï¼šyeqown/go-qrcode\nåœ¨é€ è½®å­çš„è¿‡ç¨‹ä¸­ï¼Œå‚è€ƒäº†åŒç±»é¡¹ç›® skip2/go-qrcode çš„å®ç°ï¼Œç‰¹åˆ«æ˜¯å¤ç”¨äº†å…¶çº é”™ç®—æ³•å’Œ BitSet çš„éƒ¨åˆ†é€»è¾‘ã€‚ä½†ä¸ºäº†æ›´æ·±å…¥ç†è§£ QR Code çš„ç”Ÿæˆæœºåˆ¶ï¼Œæˆ‘å†³å®šå®Œæ•´åœ°æ¢³ç†ä¸€éæµç¨‹å¹¶é‡æ„å®ç°ã€‚\nèƒŒæ™¯ # äºŒç»´ç ï¼ˆQR Codeï¼‰çœ‹ä¼¼åªæ˜¯ä¸€å †æ‚ä¹±æ— ç« çš„é»‘ç™½åƒç´ ç‚¹ï¼Œå®åˆ™åŒ…å«äº†ä¸€å¥—ä¸¥å¯†çš„æ•°æ®ç¼–ç ã€çº é”™å’Œæ©ç æœºåˆ¶ã€‚ä½œä¸ºä¸€å Gopherï¼Œåœ¨æ—¥å¸¸å¼€å‘ä¸­è°ƒç”¨ç°æˆçš„åº“ç”ŸæˆäºŒç»´ç éå¸¸ç®€å•ï¼Œä½†å¦‚æœæƒ³æ¢ç©¶å…¶â€œé»‘ç›’â€å†…éƒ¨çš„ç§˜å¯†ï¼Œæœ€å¥½çš„æ–¹å¼è«è¿‡äºäº²æ‰‹å®ç°ä¸€ä¸ªã€‚\nå¿«é€Ÿä¸Šæ‰‹ # åœ¨æ·±å…¥åŸç†ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ go-qrcode åº“åœ¨å‡ è¡Œä»£ç å†…ç”Ÿæˆä¸€å¼ äºŒç»´ç å›¾ç‰‡ã€‚\nç¤ºä¾‹ä»£ç  # package main import ( \u0026#34;fmt\u0026#34; \u0026#34;log\u0026#34; \u0026#34;github.com/yeqown/go-qrcode/v2\u0026#34; \u0026#34;github.com/yeqown/go-qrcode/writer/standard\u0026#34; ) func main() { // 1. åˆå§‹åŒ– QRCode å¯¹è±¡ï¼Œè¾“å…¥æ–‡æœ¬å†…å®¹ qrc, err := qrcode.New(\u0026#34;https://github.com/yeqown/go-qrcode\u0026#34;) if err != nil { log.Fatalf(\u0026#34;could not generate QRCode: %v\u0026#34;, err) } // 2. åˆå§‹åŒ–æ ‡å‡† Writerï¼ŒæŒ‡å®šè¾“å‡ºæ–‡ä»¶å w, err := standard.New(\u0026#34;../testdata/repo-qrcode.jpeg\u0026#34;) if err != nil { log.Fatalf(\u0026#34;standard.New failed: %v\u0026#34;, err) } // 3. ä¿å­˜ if err = qrc.Save(w); err != nil { log.Fatalf(\u0026#34;could not save image: %v\u0026#34;, err) } fmt.Println(\u0026#34;QR Code generate successfully!\u0026#34;) } ç”Ÿæˆç»“æœç¤ºæ„å¦‚ä¸‹ï¼š\ngenerated qr-code image with logo è¿›é˜¶åŠŸèƒ½ # é™¤äº†åŸºç¡€çš„é»‘ç™½äºŒç»´ç ç”Ÿæˆï¼Œgo-qrcode è¿˜æ”¯æŒé«˜åº¦è‡ªå®šä¹‰çš„æ ·å¼è®¾è®¡ï¼Œæ»¡è¶³å“ç‰ŒåŒ–éœ€æ±‚ï¼š\nå¤šç‰ˆæœ¬æ”¯æŒ: è‡ªåŠ¨åˆ†æå†…å®¹é•¿åº¦ï¼Œè¦†ç›– Version 1 ~ 40 å…¨ç‰ˆæœ¬ã€‚ æ ·å¼è‡ªå®šä¹‰: å½¢çŠ¶: æ”¯æŒè‡ªå®šä¹‰æ•°æ®ç‚¹ï¼ˆCellï¼‰å½¢çŠ¶ï¼Œå¦‚åœ†å½¢ï¼ˆCircleï¼‰ã€åœ†è§’çŸ©å½¢ç­‰ã€‚ é¢œè‰²: å¯è‡ªå®šä¹‰èƒŒæ™¯è‰²å’Œå‰æ™¯è‰²ï¼ˆBackground/Foreground Colorï¼‰ã€‚ Logo åµŒå…¥: å¯ä»¥åœ¨äºŒç»´ç ä¸­å¿ƒåµŒå…¥å“ç‰Œ Logo (æ”¯æŒ PNG/JPEG)ã€‚ è¾¹æ¡†: å¯è°ƒæ•´å››å‘¨ç•™ç™½çš„å®½åº¦ã€‚ å¤šç«¯è¾“å‡º (Writers): standard: æ ‡å‡†å›¾ç‰‡æ–‡ä»¶è¾“å‡ºã€‚ terminal: ç›´æ¥åœ¨æ§åˆ¶å°æ‰“å° ASCII å­—ç¬¦äºŒç»´ç ã€‚ halftone: æ”¯æŒåŠè‰²è°ƒäºŒç»´ç ï¼ˆHalftone QR Codeï¼‰ã€‚ wasm: æ”¯æŒç¼–è¯‘ä¸º WebAssembly åœ¨æµè§ˆå™¨ç«¯è¿è¡Œã€‚ è¿™äº›ç‰¹æ€§ä½¿å¾—å®ƒä¸ä»…æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œæ›´æ˜¯ä¸€ä¸ªäºŒç»´ç è®¾è®¡å·¥å…·ã€‚\nQR Code èƒŒåçš„åŸç† # ä»ä¸€ä¸ªç®€å•çš„å­—ç¬¦ä¸²å˜ä¸ºä¸€ä¸ªå¤æ‚çš„äºŒç»´çŸ©é˜µï¼Œä¸­é—´ç»å†äº†å“ªäº›æ­¥éª¤ï¼Ÿæ ¹æ® ISO/IEC 18004 æ ‡å‡†ï¼Œè¿™ä¸ªè¿‡ç¨‹å¤§è‡´å¯ä»¥æ‹†åˆ†ä¸ºä»¥ä¸‹ 7 ä¸ªæ­¥éª¤ã€‚\nStep 1. æ•°æ®åˆ†æ (Data Analysis) # ç¬¬ä¸€æ­¥æ˜¯å¯¹è¾“å…¥æ•°æ®è¿›è¡Œåˆ†æï¼Œç¡®å®šæœ€åˆé€‚çš„ç¼–ç æ¨¡å¼ï¼ˆNumeric, Alphanumeric, Byte, Kanji ç­‰ï¼‰ã€‚\nä¸åŒæ¨¡å¼å¯¹æ•°æ®çš„å‹ç¼©æ•ˆç‡ä¸åŒã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ•°æ®å…¨æ˜¯æ•°å­—ï¼Œä½¿ç”¨ Numeric æ¨¡å¼å¯ä»¥æ¯” Byte æ¨¡å¼æ›´èŠ‚çœç©ºé—´ã€‚åŒæ—¶ä¹Ÿéœ€è¦æ ¹æ®æ•°æ®é•¿åº¦é€‰æ‹©åˆé€‚çš„ Versionï¼ˆå¤§å°ï¼‰å’Œ çº é”™çº§åˆ«ï¼ˆL/M/Q/Hï¼‰ã€‚\nStep 2. æ•°æ®ç¼–ç  (Data Encoding) # ç¡®å®šæ¨¡å¼åï¼Œå°†è¾“å…¥çš„å­—ç¬¦ä¸²è½¬æ¢æˆæ¯”ç‰¹æµï¼ˆBit Streamï¼‰ã€‚\nåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œè¿˜éœ€è¦æ’å…¥æ¨¡å¼æ ‡è¯†ç ï¼ˆMode Indicatorï¼‰å’Œå­—ç¬¦è®¡æ•°æ ‡è¯†ç¬¦ï¼ˆCharacter Count Indicatorï¼‰ã€‚å¦‚æœæ¯”ç‰¹æµé•¿åº¦ä¸è¶³å½“å‰ Version çš„å®¹é‡ï¼Œè¿˜éœ€è¦åŠ å…¥ç»ˆæ­¢ç¬¦ï¼ˆTerminatorï¼‰å’Œå¡«å……å­—èŠ‚ï¼ˆPadding Bytesï¼‰æ¥è¡¥é½ï¼Œç¡®ä¿æ•°æ®æ»¡è¶³æ ‡å‡†è¦æ±‚ã€‚\nStep 3. è®¡ç®—çº é”™ç  (Error Correction Coding) # è¿™æ˜¯äºŒç»´ç å³ä½¿ç ´æŸä¹Ÿèƒ½è¢«è¯†åˆ«çš„å…³é”®ã€‚\næˆ‘ä»¬éœ€è¦å¯¹ Step 2 äº§ç”Ÿçš„åŸå§‹æ•°æ®æ¯”ç‰¹æµè®¡ç®—çº é”™ç ï¼ˆError Correction Codewordsï¼‰ã€‚å¸¸ç”¨çš„ç®—æ³•æ˜¯ Reed-Solomon ç¼–ç ã€‚åœ¨é«˜ç‰ˆæœ¬ï¼ˆVersion è¶Šé«˜ï¼ŒçŸ©é˜µè¶Šå¤§ï¼‰ä¸­ï¼Œæ•°æ®æµå¯èƒ½éœ€è¦è¢«åˆ‡åˆ†æˆå¤šä¸ªå—ï¼ˆBlockï¼‰ï¼Œåˆ†åˆ«è®¡ç®—çº é”™ç åå†ç©¿æ’åˆå¹¶ã€‚\nStep 4. ç»„ç»‡æ•°æ® (Structure Final Message) # å°†â€œåŸå§‹æ•°æ®ç å­—â€å’Œâ€œçº é”™ç å­—â€æŒ‰æ—¢å®šè§„åˆ™è¿›è¡Œäº¤ç»‡ï¼ˆInterleaveï¼‰ï¼Œå½¢æˆæœ€ç»ˆéœ€è¦å¡«å……åˆ°çŸ©é˜µä¸­çš„äºŒè¿›åˆ¶ä½æµã€‚\nStep 5. çŸ©é˜µå¡«å…… (Module Placement in Matrix) # åˆ°äº†è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬æ‰å¼€å§‹çœŸæ­£åœ°â€œç”»â€äºŒç»´ç ã€‚\né¦–å…ˆåœ¨çŸ©é˜µä¸­ç”»å…¥åŠŸèƒ½æ€§å›¾å½¢ï¼ˆFunction Patternsï¼‰ï¼ŒåŒ…æ‹¬ï¼š\næ¢æµ‹å›¾å½¢ï¼ˆFinder Patternsï¼‰ï¼šä¸‰ä¸ªè§’è½çš„å¤§å›å­—ã€‚ å¯¹é½å›¾å½¢ï¼ˆAlignment Patternsï¼‰ï¼šç”¨äºæ ¡æ­£æ‰­æ›²ã€‚ å®šä½å›¾å½¢ï¼ˆTiming Patternsï¼‰ï¼šè¿æ¥æ¢æµ‹å›¾å½¢çš„é»‘ç™½ç›¸é—´çº¿æ¡ã€‚ ç„¶åï¼Œå°† Step 4 å¾—åˆ°çš„äºŒè¿›åˆ¶æ•°æ®æµï¼Œä»¥â€œä¹‹â€å­—å½¢ï¼ˆZigzagï¼‰é¡ºåºå¡«å……åˆ°çŸ©é˜µçš„å‰©ä½™ç©ºé—´ä¸­ã€‚\nStep 6. åº”ç”¨æ•°æ®æ©ç  (Data Masking) # å¦‚æœç›´æ¥å¡«å……æ•°æ®ï¼Œå¯èƒ½ä¼šå‡ºç°å¤§é¢ç§¯çš„ç©ºç™½æˆ–é»‘å—ï¼Œå¯¼è‡´æ‰«æè®¾å¤‡éš¾ä»¥å®šä½ã€‚\nå› æ­¤ï¼Œæ ‡å‡†å®šä¹‰äº† 8 ç§æ©ç å›¾æ¡ˆï¼ˆMask Patternsï¼‰ã€‚æˆ‘ä»¬éœ€è¦å°†è¿™ 8 ç§æ©ç åˆ†åˆ«åº”ç”¨åˆ°çŸ©é˜µä¸Šï¼ˆXOR æ“ä½œï¼‰ï¼Œç„¶åé€šè¿‡ä¸€å¥—è¯„åˆ†æœºåˆ¶ï¼ˆPenalty Scoreï¼‰è¯„ä¼°å“ªç§æ©ç çš„æ•ˆæœæœ€å¥½ï¼ˆæ¯”å¦‚é»‘ç™½æ¯”ä¾‹æœ€å‡åŒ€ï¼‰ï¼Œæœ€ç»ˆé€‰æ‹©é‚£ä¸ªæœ€ä¼˜çš„æ©ç ã€‚\nStep 7. å¡«å……æ ¼å¼å’Œç‰ˆæœ¬ä¿¡æ¯ (Format and Version Information) # æœ€åï¼Œå°†é€‰å®šçš„çº é”™ç­‰çº§ã€æ©ç åºå·ç­‰ä¿¡æ¯ç¼–ç æˆæ ¼å¼ä¿¡æ¯ï¼ˆFormat Informationï¼‰ï¼Œå¡«å…¥æ¢æµ‹å›¾å½¢çš„å‘¨è¾¹ã€‚å¦‚æœæ˜¯ Version 7 ä»¥ä¸Šçš„å¤§å°ºå¯¸äºŒç»´ç ï¼Œè¿˜è¦å¡«å…¥ç‰ˆæœ¬ä¿¡æ¯ï¼ˆVersion Informationï¼‰ã€‚\nè‡³æ­¤ï¼Œä¸€ä¸ªå®Œæ•´çš„äºŒç»´ç å°±è¯ç”Ÿäº†ã€‚\næ€»ç»“ä¸å‚è€ƒ # å®ç°äºŒç»´ç ç”Ÿæˆå™¨çš„è¿‡ç¨‹ï¼Œå®é™…ä¸Šæ˜¯å¯¹è®¡ç®—æœºç¼–ç ç†è®ºï¼ˆå¦‚ Reed-Solomonï¼‰ã€ä½è¿ç®—å’ŒçŸ©é˜µæ“ä½œçš„ä¸€æ¬¡ç»¼åˆå®è·µã€‚\nå¦‚æœä½ å¸Œæœ›æ·±å…¥äº†è§£æ¯ä¸€ä¸ªå­—èŠ‚æ˜¯å¦‚ä½•è¢«ç¼–ç çš„ï¼Œå¼ºçƒˆæ¨èé˜…è¯»ä»¥ä¸‹èµ„æ–™ï¼š\nQR Code Tutorial: (å¼ºçƒˆæ¨è) éå¸¸è¯¦å°½çš„ä¿å§†çº§æ•™ç¨‹ï¼Œä¸€æ­¥æ­¥æ‰‹ç®—æ¼”ç¤ºã€‚ QRCode Wiki: ç»´åŸºç™¾ç§‘çš„æ¦‚è¿°ã€‚ äºŒç»´ç è¯¦è§£ï¼ˆQR Codeï¼‰: çŸ¥ä¹ä¸Šçš„ä¸­æ–‡è¯¦è§£ã€‚ "},{"id":45,"href":"/2018/11/19/go-get%E9%81%87%E5%88%B0%E5%A2%99%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/","title":"go-geté‡åˆ°ğŸ§±çš„è§£å†³æ–¹æ³•","section":"Posts","content":"è§£å†³æ–¹æ³•æœ‰ä¸¤ç§ï¼Œåœ¨ç½‘ä¸Šä¹Ÿå¾ˆå¥½æ‰¾åˆ°ï¼š\n1. æœ€ç®€å•çš„ï¼Œä»Â¥â€œgithub.com/golangâ€æ‰¾åˆ°å¯¹åº”çš„åŒ…å¹¶ä¸‹è½½åˆ° $GOPATH/src/golang.org/x/ ä¸‹ 2. ç¬¬äºŒç§ï¼Œå°±æ˜¯ç¿»è¿‡ğŸ§±äº†ã€‚ 1 é—®é¢˜ï¼šç¿»äº†ğŸ§±ï¼Œè¿˜æ˜¯æ²¡åŠæ³•ç›´æ¥ä½¿ç”¨go getæ¥ä¸‹è½½å‘¢ï¼Ÿ # å…ˆè¯´åŸå› ï¼Œå› ä¸ºgo getå¹¶æ²¡æœ‰èµ°ä½ çš„ä»£ç†å•Šï¼ï¼ï¼ï¼é‚£ä¹ˆå¦‚ä½•è®¾ç½®ä»£ç†å‘¢ï¼Ÿ\nexport http_proxy=http://ip:port go get golang.org/xxx å…¶ä»–è®¾ç½®ä»£ç†çš„æ–¹å¼ï¼Œè‡ªè¡Œå‚è§ å‚è€ƒ\n2 å¦‚æœä½ çš„ä»£ç†ä¸æ”¯æŒhttp || httpsåè®®ï¼Œå¯å’‹æ•´ï¼Ÿ # é‚£ä¹ˆæƒ³åŠæ³•æ”¯æŒhttpæˆ–è€…æŠŠhttpå†ä»£ç†åˆ°ä½ å¯ä»¥ä½¿ç”¨çš„åè®®ï¼ˆsocks5~ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨cowã€‚\ncow æ¨èä½¿ç”¨æ–¹å¼ï¼š\ngo get ä¸‹è½½å®‰è£…ï¼ˆå› ä¸ºåˆšå¼€å§‹å›¾ç®€å•ï¼Œä½¿ç”¨ç¨‹åºçš„æ—¶å€™è¿è¡ŒæŠ¥é”™äº†ï¼Œgo get å®‰è£…æ–¹å¼å¹¶ä¸ä¼šæœ‰è¿™æ ·çš„å›°æ‰°ï¼‰ã€‚ é…ç½®çš„æ—¶å€™ä¹Ÿå¾ˆç®€å•ï¼Œç¼–è¾‘é…ç½®æ–‡ä»¶ ï½/.cow/rcï¼Œé…ç½®http socks5ä»£ç†æœåŠ¡å’Œç›‘å¬ä»£ç†ç«¯å£ã€‚\nlisten = http://127.0.0.1:7777 proxy = socks5://127.0.0.1:1080 3 è¿è¡Œ # é…ç½®å®Œæˆä¹‹åå°±å¯ä»¥ç›´æ¥è¿è¡Œäº†\n./cow # å¦å¼€ä¸€ä¸ªTerminal export http_proxy=http://ip:port go get golang.org/xxx å†™åœ¨åé¢ # çŸ¥é“äº†go getæ— æ³•ç¿»ğŸ§±çš„åŸå› ä¹‹åï¼Œå°±å¯ä»¥å‘æŒ¥è‡ªå·±çš„æƒ³è±¡åŠ›æ¥è§£å†³é—®é¢˜äº†ï¼Œè¿™æ ·è§£å†³è¿˜æ˜¯æŒºç¹ççš„ã€‚è™½ç„¶cowå¯ä»¥é…ç½®å¼€æœºå¯åŠ¨ï¼Œä½†å¯¹äºä¸€ä¸ªæ‡’ç™Œæ™šæœŸï¼‰çš„äººæ¥è¯´ï¼ˆå¦‚æœä¸æ˜¯å› ä¸ºå‡çº§Goåˆ°äº†1.11ï¼Œgo-moduleæœºåˆ¶è®©æˆ‘æ— æ³•å¼€å¿ƒçš„ç©è€ï¼Œæˆ‘ä¹Ÿä¸ä¼šå»è€ƒè™‘ä¸ºå•¥ç¿»ğŸ§±äº†go getè¿˜æ˜¯ä¸èƒ½ç”¨ï¼Œæ˜æ˜æœ‰ä»£ç†å´è¿˜æœ‰ä½¿ç”¨å¦å¤–ä¸€ä¸ªä»£ç†ï½ã€‚\nå‹æƒ…æç¤ºï¼švscode-go ä¹Ÿå¯ä»¥è®¾ç½®proxyå“¦\nå‚è€ƒï¼š # go get ä½¿ç”¨ä»£ç† cow cowé…ç½®æ–‡ä»¶è¯´æ˜ vscode-goè®¾ç½®proxy "},{"id":46,"href":"/2018/10/23/etcd-service-registration-discovery/","title":"etcdä¸service-registration-discovery","section":"Posts","content":" å£°æ˜ï¼šæœ¬æ–‡å¯¹etcdçš„åŸç†ï¼Œå®ç°ç»†èŠ‚ï¼Œæ€§èƒ½ç­‰å‡ä¸è€ƒè™‘ï¼Œä»…å°†etcdä½œä¸ºä¸€ä¸ªåˆ†å¸ƒå¼çš„K-Vå­˜å‚¨ç»„ä»¶ã€‚æœ¬æ–‡æä»·ä»£ç å‡åœ¨ï¼š github.com/yeqown/server-common/tree/master/framework/etcd\nä¸€ä¸ªæ ¸å¿ƒ # etcd, åˆ†å¸ƒå¼Key-Valueå­˜å‚¨å·¥å…·ã€‚è¯¦ç»†èµ„æ–™ç”±æ­¤å»\netcdä¸‹è½½å®‰è£… ä¸¤ä¸ªå¯¹è±¡ # æœåŠ¡æä¾›è€…ï¼ˆåœ¨æµ‹è¯•ç¯å¢ƒä¸­ï¼Œæˆ‘å®šä¹‰ä¸ºå•ç‹¬çš„æœåŠ¡å®ä¾‹ï¼‰ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡çš„æä¾›è€…ï¼Œéœ€è¦å‘å…¶ä»–æœåŠ¡æš´éœ²è‡ªå·±çš„ipå’Œç«¯å£ï¼Œæ–¹ä¾¿è°ƒç”¨ã€‚ æœåŠ¡è°ƒç”¨è€…ï¼ˆåŒæ ·åœ°ï¼Œåœ¨æµ‹è¯•ç¯å¢ƒä¸­æˆ‘å®šä¹‰ä¸ºåå‘ä»£ç†ç½‘å…³ç¨‹åºï¼‰ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡çš„è°ƒç”¨è€…ï¼Œéœ€è¦è·å–åˆ° å¯ä½¿ç”¨ åœ°æœåŠ¡åœ°å€å¹¶è°ƒç”¨ã€‚ å…³äºæœåŠ¡æ³¨å†Œä¸å‘ç° # å°±å…·ä½“åœºæ™¯è€Œè¨€ï¼šæˆ‘ä»¬çš„ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨äº†ä¸€ä¸ªä»£ç†ç½‘å…³æœåŠ¡å™¨ï¼Œç”¨äºè½¬å‘ç§»åŠ¨ç«¯å’ŒPCç«¯çš„APIè¯·æ±‚ï¼Œå¹¶å®Œæˆå…¶ä»–åŠŸèƒ½ã€‚æ‰€æœ‰çš„æœåŠ¡å®ä¾‹é…ç½®éƒ½æ˜¯ç¡¬ç¼–ç åœ¨ç½‘å…³ç¨‹åºä¸­ï¼Œé¡¶å¤šå°±æ˜¯æŠ½ç¦»å‡ºæ¥æˆäº†ä¸€ä¸ªé…ç½®æ–‡ä»¶ã€‚è¿™æ ·åšçš„ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼šâ€œéåŠ¨æ€â€ã€‚ä¹Ÿå°±æ„å‘³ç€ï¼Œä¸€æ—¦æœ‰æœåŠ¡Downæ‰ï¼Œé‚£ä¹ˆç”¨æˆ·è®¿é—®åˆ™å¯èƒ½å¼‚å¸¸ï¼Œç”šè‡³å¯¼è‡´æ•´ä¸ªæœåŠ¡çš„å´©æºƒï¼›å…¶æ¬¡ï¼Œéœ€è¦å¯¹æœåŠ¡è¿›è¡Œæ‰©å®¹çš„æƒ…å†µä¸‹ï¼Œåˆ™éœ€è¦å…ˆè¿›è¡ŒæœåŠ¡éƒ¨ç½²å†æ›´æ–°ç½‘å…³ç¨‹åºï¼Œæ­¥éª¤ç¹çä¸”å®¹æ˜“å‡ºé”™ã€‚\né‚£ä¹ˆå¦‚æœæˆ‘ä»¬è®¾è®¡æˆä¸ºå¦‚ä¸‹å›¾çš„æ ·å­ï¼š å¯¹äºæ–°æ·»åŠ çš„æœåŠ¡å®ä¾‹ï¼Œåªéœ€è¦å¯åŠ¨æ–°çš„æœåŠ¡ï¼Œå¹¶æ³¨å†Œåˆ°etcdç›¸åº”çš„è·¯å¾„ä¸‹å°±è¡Œäº†ã€‚\næ³¨å†Œï¼šå¯¹äºåŒä¸€ç»„æœåŠ¡ï¼Œé…ç½®ä¸€ä¸ªç»Ÿä¸€çš„å‰ç¼€ï¼ˆå¦‚å›¾ä¸Šçš„\u0026quot;/specServer\u0026quot;ï¼‰ï¼Œä¸åŒå®ä¾‹ä½¿ç”¨IDåŠ ä»¥åŒºåˆ†ã€‚\nå°†ç°è¡ŒæœåŠ¡æ”¹é€ æˆä¸ºä¸Šè¿°æ¨¡å¼éœ€è¦è§£å†³çš„é—®é¢˜ï¼š # etcd é…ç½®å®‰è£… ç½‘å…³ç¨‹åºæ”¹é€ ï¼ˆç›‘å¬etcdçš„èŠ‚ç‚¹å¤¹å­/prefix;é€‚é…åŠ¨æ€çš„æœåŠ¡å®ä¾‹è°ƒç”¨ï¼‰ æœåŠ¡å®ä¾‹æ”¹é€ ï¼ˆæ³¨å†ŒæœåŠ¡å®ä¾‹åˆ°etcd;å¿ƒè·³æ›´æ–°;å…¶ä»–é…å¥—è®¾æ–½ï¼Œå¼‚å¸¸é€€å‡ºåˆ é™¤æ³¨å†Œä¿¡æ¯ï¼‰ etcdå®‰è£…é…ç½®åœ¨github.comå·²ç»éå¸¸è¯¦ç»†äº†ã€‚åœ¨è¿™é‡Œè´´ä¸€ä¸‹æˆ‘åœ¨æœ¬åœ°æµ‹è¯•æ—¶å€™å¯åŠ¨çš„è„šæœ¬ï¼ˆè¿™éƒ¨åˆ†æ˜¯ä»etcd-demoè·å–åˆ°çš„ï¼Œåšäº†é’ˆå¯¹ç«¯å£çš„æ”¹åŠ¨ï¼‰ï¼š\n#!/bin/bash # For each machine TOKEN=token-01 CLUSTER_STATE=new NAME_1=machine1 NAME_2=machine2 NAME_3=machine3 HOST_1=127.0.0.1 HOST_2=127.0.0.1 HOST_3=127.0.0.1 CLUSTER=${NAME_1}=http://${HOST_1}:2380,${NAME_2}=http://${HOST_2}:2381,${NAME_3}=http://${HOST_3}:2382 # For machine 1 THIS_NAME=${NAME_1} THIS_IP=${HOST_1} etcd --data-dir=machine1.etcd --name ${THIS_NAME} \\ --initial-advertise-peer-urls http://${THIS_IP}:2380 --listen-peer-urls http://${THIS_IP}:2380 \\ --advertise-client-urls http://${THIS_IP}:2377 --listen-client-urls http://${THIS_IP}:2377 \\ --initial-cluster ${CLUSTER} \\ --initial-cluster-state ${CLUSTER_STATE} --initial-cluster-token ${TOKEN} \u0026amp; # For machine 2 THIS_NAME=${NAME_2} THIS_IP=${HOST_2} etcd --data-dir=machine2.etcd --name ${THIS_NAME} \\ --initial-advertise-peer-urls http://${THIS_IP}:2381 --listen-peer-urls http://${THIS_IP}:2381 \\ --advertise-client-urls http://${THIS_IP}:2378 --listen-client-urls http://${THIS_IP}:2378 \\ --initial-cluster ${CLUSTER} \\ --initial-cluster-state ${CLUSTER_STATE} --initial-cluster-token ${TOKEN} \u0026amp; # For machine 3 THIS_NAME=${NAME_3} THIS_IP=${HOST_3} etcd --data-dir=machine3.etcd --name ${THIS_NAME} \\ --initial-advertise-peer-urls http://${THIS_IP}:2382 --listen-peer-urls http://${THIS_IP}:2382 \\ --advertise-client-urls http://${THIS_IP}:2379 --listen-client-urls http://${THIS_IP}:2379 \\ --initial-cluster ${CLUSTER} \\ --initial-cluster-state ${CLUSTER_STATE} --initial-cluster-token ${TOKEN} \u0026amp; å¯¹äºç¨‹åºçš„æ”¹é€ ï¼Œé‰´äºæœåŠ¡è¾ƒå¤šä¸”etcdæ“ä½œæµç¨‹å¤§ä½“ä¸€è‡´ï¼Œä¾¿ç®€å•åŒ…è£…äº†ä¸€ä¸‹ï¼Œé¡¹ç›®åœ°å€è§æ–‡é¦–ä½ç½®ã€‚\n1.å¯¹äºè°ƒç”¨æ–¹ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š\n// etcdtest/gw.go func main() { // ... endpoints := []string{ \u0026#34;http://127.0.0.1:2377\u0026#34;, \u0026#34;http://127.0.0.1:2379\u0026#34;, \u0026#34;http://127.0.0.1:2378\u0026#34;, } // è¿æ¥etcdè·å–KeysAPI kapi, err := etcd.Connect(endpoints...) if err != nil { fmt.Println(err) os.Exit(2) } // debug more, more log ~ etcd.OpenDebug(true) // etcd watch, ç›‘å¬/prefixç›®å½•ä¸‹çš„æ”¹åŠ¨ï¼ˆâ€œexpire;set;update;deleteâ€ï¼‰ // å¦‚ï¼šset {Key: /prefix/srv_3457, CreatedIndex: 1155, ModifiedIndex: 1155, TTL: 12} // å¹¶æ›´æ–°watcher.members, ç»´æŒæœ€æ–°çš„èŠ‚ç‚¹çŠ¶æ€å’Œæ•°é‡ watcher = etcd.NewWatcher(kapi, \u0026#34;prefix\u0026#34;) go watcher.Watch() // ... } func ServeHTTP() { // ... srvs := watcher.RangeMember() // è·å–æ‰€æœ‰å¯ç”¨çš„æœåŠ¡èŠ‚ç‚¹ // ... } 2.å¯¹äºè¯·æ±‚æä¾›æ–¹ï¼Œä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š\n// etcdtest/server.go func main() { // ... endpoints := []string{ \u0026#34;http://127.0.0.1:2377\u0026#34;, \u0026#34;http://127.0.0.1:2379\u0026#34;, \u0026#34;http://127.0.0.1:2378\u0026#34;, } etcd.OpenDebug(true) kapi, err := etcd.Connect(endpoints...) if err != nil { fmt.Errorf(err.Error()) os.Exit(2) } // æ ¹æ®æœåŠ¡ç”Ÿæˆä¸€ä¸ªprovider, ç”¨äºç”ŸæˆK:V provider := etcd.NewProvider( fmt.Sprintf(\u0026#34;srv_%d\u0026#34;, *port), // name fmt.Sprintf(\u0026#34;http://127.0.0.1:%d\u0026#34;, *port), // addr ) ctx, cancel := context.WithCancel(context.Background()) // æ¯10sè®¾ç½®ä¸€ä¸ªTTL=12sçš„ â€œ/prefix/idâ€:â€œhttp://host:portâ€ çš„çš„é”®å€¼å¯¹ // 10så’Œ12sæ˜¯å†™æ­»çš„ï¼Œæ²¡æœ‰è€ƒè™‘åŠ¨æ€ï½ï½ï¼Œåç»­è€ƒè™‘å‡çº§ï¼Œç›®å‰ä»…ä»…æ˜¯æµ‹è¯•ã€‚ go provider.Heartbeat(ctx, kapi, \u0026amp;etcd.ProvideOptions{ NamePrefix: \u0026#34;prefix\u0026#34;, SetOpts: nil, }) //... } å…³äºè¯¦ç»†çš„ä»£ç ï¼Œå¯ä»¥å‚è§:\ngodoc.org/go.etcd.io/etcd/client provider.go#L42 requester.go#L134 etcdtest-æµ‹è¯•ä»£ç  æµ‹è¯• # dplayer \"url=/mov/etcd-example-video.mov\" \"loop=no\" \"theme=#FADFA3\" \"autoplay=false\" \"token=tokendemo\" æ€»ç»“ # ä»£ç åŒ…è£…å¾—æ¯”è¾ƒç²—ç³™ï¼Œè§†é¢‘æ¼”ç¤ºè¿˜æ²¡æœ‰åŒ…å«åˆ°æœåŠ¡å¼‚å¸¸ï¼ˆé€€å‡ºï¼‰ä¹‹åç½‘å…³ç¨‹åºçš„åº”å¯¹ï¼ˆè¿™éƒ¨åˆ†æ˜¯å·²ç»å®Œæˆï¼Œåªæ˜¯æ²¡æœ‰æ¼”ç¤ºï¼‰ã€‚\n"},{"id":47,"href":"/2018/08/29/Golang%E9%80%82%E7%94%A8%E7%9A%84DTO%E5%B7%A5%E5%85%B7/","title":"Golangé€‚ç”¨çš„DTOå·¥å…·","section":"Posts","content":" DTO (Data Transfer Object) æ˜¯Javaä¸­çš„æ¦‚å¿µï¼Œèµ·åˆ°æ•°æ®å°è£…å’Œéš”ç¦»çš„ä½œç”¨ã€‚åœ¨ä½¿ç”¨Golangå¼€å‘Webåº”ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¼šæœ‰ç±»ä¼¼çš„éœ€æ±‚ã€‚å…ˆè´´é¡¹ç›®åœ°å€ github.com/yeqown/server-common/tree/master/dbs/tools\nä¸¾ä¸ªä¾‹å­ # ç°åœ¨æœ‰ä¸€ä¸ªç”¨æˆ·æ•°æ®ç»“æ„å¦‚ä¸‹,\ntype UserModel struct { ID int64 `gorm:\u0026#34;column:id\u0026#34;` Name string `gorm:\u0026#34;column:name\u0026#34;` Password string `gorm:\u0026#34;column:password\u0026#34;` } // é—®é¢˜1: ç°åœ¨è¦æ±‚æ˜¯æƒ³è¦JSONæ ¼å¼è¿”å›ç”¨æˆ·æ•°æ®ï¼Œå¹¶ä¸”ä¸å¸Œæœ›å…¶ä¸­åŒ…å«æœ‰Passwordå­—æ®µ // è§£å†³1:\ntype UserModel struct { ID int64 `gorm:\u0026#34;column:id\u0026#34; json:\u0026#34;id\u0026#34;` Name string `gorm:\u0026#34;column:name\u0026#34; json:\u0026#34;name\u0026#34;` Password string `gorm:\u0026#34;column:password\u0026#34; json:\u0026#34;-\u0026#34;` } // é—®é¢˜2: åŒæ ·æ˜¯JSONæ•°æ®æ ¼å¼ï¼Œå¹¶ä¸”å¸Œæœ›é¢å¤–è¿”å›ç”¨æˆ·çš„èº«ä»½æ ‡ç¤ºIdentï¼ˆå‡è®¾å¿…é¡»è¦è·Ÿç”¨æˆ·æ•°æ®æ”¾åœ¨ä¸€èµ·ï¼‰ // è§£å†³2: ï¼ˆè¿™ä¹Ÿæ˜¯æˆ‘çš„åœºæ™¯ï¼‰\ntype UserDTO struct { ID int64 `json:\u0026#34;id\u0026#34;` Name string `json:\u0026#34;name\u0026#34;` Password string `json:\u0026#34;-\u0026#34;` Ident string `json:\u0026#34;ident\u0026#34;` } func LoadUserDTOFromModel(data *UserMolde) *UserDTO { ident := genUserIdent(data) return \u0026amp;{ ID data.ID, Name data.Name, Ident ident, } } èƒŒæ™¯å’Œéœ€æ±‚ # ä¸€èˆ¬æ¥è¯´æˆ‘çš„é¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼šå…¶ä¸­modelså’Œservicesä¹Ÿå°±æ˜¯åˆ†å¼€å®šä¹‰Data struct(UserModel)å’ŒObject(UserDTO)çš„æ–‡ä»¶å¤¹ã€‚\nå…¶å®DTOçš„è¿‡ç¨‹å¯¹äºæˆ‘æ¥è¯´ï¼Œå°±æ˜¯åŸºäºData Structç”Ÿæˆä¸€ä¸ªæ–°çš„Structç»“æ„ï¼Œå¹¶é™„å¸¦ä¸€ä¸ªfunc LoadDTOTypeFromModel(data *ModelType) *DTOTypeã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå…¶å®é™¤äº†ä¸ªåˆ«Objectç»“æ„ä½“éœ€è¦é¢å¤–å¤„ç†ä»¥å¤–ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯æ–°æ¢ä¸€ä¸ªtag~ã€‚å› æ­¤è¿™éƒ¨åˆ†å·¥ä½œæ­¥éª¤éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¸ç”¨ä¸€ä¸ªå·¥å…·æ¥é¿å…è¿™éƒ¨åˆ†é‡å¤çš„å·¥ä½œå‘¢ï½ï¼Ÿ\næ€è·¯ # å…ˆè¯´ä¸€ä¸‹æ€è·¯:\nÂ· 1. ä».goä¸­è·å–åˆ°æŒ‡å®šç»“æ„ä½“çš„ç»“æ„æ€§æè¿° Â· 2. æ ¹æ®ç»“æ„æ€§æè¿°æ¥ç”Ÿæˆæ–°çš„ç»“æ„ä½“ Â· 3. æ ¹æ®é¢å¤–çš„é…ç½®ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„æ–‡ä»¶types.go\nå…¶ä¸­ç»“æ„æ€§æè¿°å¦‚ä¸‹ï¼š\ntype innerStruct struct { fields []*field content string name string pkgName string } type field struct { name string // field name string typ string // field type string tag string // tag name string } åœ¨æ•´ä¸ªæµç¨‹ä¸­æ¯”è¾ƒéº»çƒ¦çš„å°±æ˜¯ï¼Œæ€ä¹ˆè·å–åˆ°ï¼Œç‰¹å®šç±»å‹ç»“æ„ä½“çš„ç»“æ„æ€§æè¿°ï¼ŸGoæ–‡ä»¶è§£æéƒ¨åˆ†ã€‚è¿™é‡Œæƒ³è®°å½•ä¸€ä¸ªå°æ’æ›²ï¼šæœ€å¼€å§‹æˆ‘æ‰¾è§£ægoæ–‡ä»¶æ–¹æ³•çš„æ—¶å€™ï¼Œåœ¨Googleä¸­æœç´¢â€œå¦‚ä½•è§£ægoæ–‡ä»¶â€ï¼Œå‡ºæ¥çš„ç»“æœæ²¡æœ‰å¤ªå¤§å¸®åŠ©ï¼Œç„¶åæˆ‘åˆå°è¯•äº†â€œHow to parse .go file source codeâ€ï¼Œç»“æœå°±æç¤ºäº†parser \u0026amp; loader ä¸¤ä¸ªçœ‹èµ·æ¥å°±å¾ˆæœ‰å¸®åŠ©çš„åŒ…åã€‚ã€‚ã€‚ã€‚è¿™é‡Œæˆ‘é€‰ç”¨äº†loaderã€‚\nå…³äºloaderåŒ…çš„è¯´æ˜ # Package loader loads a complete Go program from source code, parsing and type-checking the initial packages plus their transitive closure of dependencies.\næ­£å¥½è¿™ä¸ªåŒ…æ˜¯ä»æºä»£ç å»åŠ è½½Goç¨‹åºï¼Œå¯¹åˆå§‹åŒ…è¿›è¡Œè§£æå’Œç±»å‹æ£€æŸ¥ç­‰ã€‚\nGoæ–‡ä»¶è§£æéƒ¨åˆ† # ç»è¿‡é˜…è¯»loaderåŒ…æ–‡æ¡£ï¼Œæˆ‘å®Œæˆäº†ä¸€ä¸ªå‡½æ•°ç”¨äºè·å–æŒ‡å®šçš„ç»“æ„ä½“çš„ç»“æ„æ€§æè¿°ä¿¡æ¯ï¼šä»£ç åœ¨æ­¤\n// Exported, and specified type func loadGoFiles(dir string, filenames ...string) ([]*innerStruct, error) { newFilenames := []string{} for _, filename := range filenames { newFilenames = append(newFilenames, path.Join(dir, filename)) } conf.CreateFromFilenames(\u0026#34;\u0026#34;, newFilenames...) prog, err := conf.Load() if err != nil { log.Println(\u0026#34;load program err:\u0026#34;, err) return nil, err } return loopProgramCreated(prog.Created), nil } // loopProgramCreated to loo and filter: // 1. unexported type // 2. bultin types // 3. only specified style struct name func loopProgramCreated( created []*loader.PackageInfo, ) (innerStructs []*innerStruct) { for _, pkgInfo := range created { pkgName := pkgInfo.Pkg.Name() defs := pkgInfo.Defs for indent, obj := range defs { if !indent.IsExported() || obj == nil || !strings.HasSuffix(indent.Name, specifiedStructTypeSuffix) { continue } // obj.String() å¾—åˆ°çš„stringå¦‚ï¼š // type testdata.UserModel struct{Name string \u0026#34;gorm:\\\u0026#34;colunm:name\\\u0026#34;\u0026#34;; Password string \u0026#34;gorm:\\\u0026#34;column:password\\\u0026#34;\u0026#34;} is := parseStructString(obj.String()) is.pkgName = pkgName is.pureName() if isDebug { log.Println(\u0026#34;parse one Model: \u0026#34;, is.name, is.pkgName, is.content) } innerStructs = append(innerStructs, is) } } return } å…¶ä¸­parseStructStringæ˜¯å¯¹å½¢å¦‚***type testdata.UserModel struct{Name string \u0026ldquo;gorm:\u0026quot;colunm:name\u0026quot;\u0026rdquo;; Password string \u0026ldquo;gorm:\u0026quot;column:password\u0026quot;\u0026rdquo;}***çš„å­—ç¬¦ä¸²è¿›è¡Œå¤„ç†å¹¶æ•´ç†æˆä¸ºinnerStructæ•°æ®ã€‚\nä½¿ç”¨è¯´æ˜ # go get github.com/yeqown/server-common/dbs/tools # è·å– github.com/yeqown/server-common/tool.main.go, # å¹¶é€‰æ‹©æ€§çš„å®ç°è‡ªå·±çš„ CustomParseTagFunc \u0026amp; CustomGenerateTagFunc go build -o dbtools tool.main.go âœ âœ— dbtools -h Usage of ./dbtools: -debug è°ƒè¯•æ¨¡å¼å¼€å…³ï¼Œè°ƒè¯•æ¨¡å¼ä¸‹ä¼šè¾“å‡ºé¢å¤–çš„ä¿¡æ¯ -dir string æŒ‡å®šéœ€è¦è§£æçš„ç›®å½• -filename string æŒ‡å®šå“ªäº›æ–‡ä»¶éœ€è¦è¢«è§£æï¼Œå¦‚æœæœªè®¾ç½®é»˜è®¤dirè·¯å¾„ä¸‹æ‰€æœ‰çš„.goæ–‡ä»¶ -generateDir string ç”Ÿæˆæ–‡ä»¶å­˜æ”¾çš„ç›®å½•ï¼Œé»˜è®¤å½“å‰è·¯å¾„ -generateFilename string ç”Ÿæˆæ–‡ä»¶åï¼Œé»˜è®¤\u0026#34;types.go\u0026#34; -generatePkgName string ç”Ÿæˆæ–‡ä»¶çš„åŒ…åï¼Œé»˜è®¤\u0026#34;types\u0026#34; -generateStructSuffix string æ›¿æ¢model structçš„åç¼€ï¼Œé»˜è®¤æ— åç¼€ï¼Œå¦‚UserSuffix =\u0026gt; User -modelImportPath string æŒ‡æ˜model structçš„å¯¼å…¥è·¯å¾„, å¦‚my-server/models -modelStructSuffix string æŒ‡æ˜ç‰¹å®šåç¼€çš„model structéœ€è¦è¢«è§£æï¼Œé»˜è®¤\u0026#34;Model\u0026#34; å·¥å…·æµ‹è¯•ç»“æœ # ./bin/dbtools \\ -dir=./dbs/tools/testdata \\ -filename=type_model.go \\ -generatePkgName=main \\ -modelImportPath=github.com/yeqown/server-common/dbs/tools/testdata \\ å‚è€ƒé“¾æ¥ # loader parser "},{"id":48,"href":"/2018/06/28/%E6%80%8E%E4%B9%88%E6%89%8D%E5%8F%AB%E7%86%9F%E6%82%89http%E5%8D%8F%E8%AE%AE/","title":"æ€ä¹ˆæ‰å«ç†Ÿæ‚‰httpåè®®?","section":"Posts","content":"â€œç†Ÿæ‚‰httpåè®®â€ï¼Œè‚¯å®šå¾ˆå¤šITå°ä¼™ä¼´éƒ½åœ¨æ‹›è˜å²—ä½ä¸Šçœ‹å¾—åˆ°è¿‡ï¼Œä½†æ˜¯æ€ä¹ˆæ‰å«ç†Ÿæ‚‰httpåè®®å‘¢ï¼ŸæŠ½ç©ºæ¢³ç†äº†ä¸€ä¸‹ï¼Œä¹Ÿç®—æ˜¯å¯¹è¿™ä¸€éƒ¨åˆ†çŸ¥è¯†çš„ç¬”è®°å§ï¼\nå¯èƒ½å¯¹äºå¤§éƒ¨åˆ†äººæ¥è¯´ï¼Œç½‘ç»œwebç¼–ç¨‹å°±æ˜¯ä½¿ç”¨ä¸€äº›ç¬¬ä¸‰æ–¹åº“æ¥è¿›è¡Œè¯·æ±‚å’Œå“åº”çš„å¤„ç†ï¼Œå†å¤šè¯´ä¸€ç‚¹å°±æ˜¯è¿™ä¸ªURIè¦ä½¿ç”¨POSTæ–¹æ³•ï¼Œå¯¹äºæºå¸¦çš„æ•°æ®éœ€è¦å¤„ç†æˆä¸ºformdataã€‚\nåŸºç¡€çŸ¥è¯† # Q1: HTTPåè®®æ˜¯ä»€ä¹ˆï¼Ÿç”¨æ¥å¹²ä»€ä¹ˆï¼Ÿ\nHTTPåè®®æ˜¯åŸºäºTCP/IPåè®®çš„åº”ç”¨å±‚åè®®ï¼Œä¸»è¦è§„å®šäº†å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´çš„é€šä¿¡æ ¼å¼ã€‚ä¸»è¦ä½œç”¨ä¹Ÿå°±æ˜¯ä¼ è¾“æ•°æ®ï¼ˆHTMLï¼Œå›¾ç‰‡ï¼Œæ–‡ä»¶ï¼ŒæŸ¥è¯¢ç»“æœï¼‰ã€‚\n#ç½‘ç»œåˆ†å±‚ # äº’è”ç½‘çš„å®ç°åˆ†æˆäº†å‡ å±‚ï¼Œå¦‚ä½•åˆ†å±‚æœ‰ä¸åŒçš„æ¨¡å‹ï¼ˆä¸ƒå±‚ï¼Œäº”å±‚ï¼Œå››å±‚ï¼‰ï¼Œè¿™é‡ŒæŒ‰äº”å±‚æ¨¡å‹æ¥è§£é‡Šï¼š\nï¼ˆé è¿‘ç”¨æˆ·ï¼‰åº”ç”¨å±‚ \u0026lt; ä¼ è¾“å±‚ \u0026lt; ç½‘ç»œå±‚ \u0026lt; é“¾æ¥å±‚ \u0026lt; ç‰©ç†å±‚ï¼ˆé è¿‘ç¡¬ä»¶ï¼‰\nå±‚çº§ ä½œç”¨ æ‹¥æœ‰åè®® ç‰©ç†å±‚ ä¼ é€ç”µä¿¡å·0 1 æ—  æ•°æ®é“¾è·¯å±‚ å®šä¹‰æ•°æ®åŒ…;ç½‘å¡MACåœ°å€;å¹¿æ’­çš„å‘é€æ–¹å¼; Ethernet 802.3; Token Ring 802.5 ç½‘ç»œå±‚ å¼•è¿›äº†IPåœ°å€ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„è®¡ç®—æœºæ˜¯å¦å±äºåŒä¸€ç½‘ç»œ IP; ARP; RARP ä¼ è¾“å±‚ å»ºç«‹ç«¯å£åˆ°ç«¯å£çš„é€šä¿¡ï¼Œå®ç°ç¨‹åºæ—¶é—´çš„äº¤æµï¼Œä¹Ÿå°±æ˜¯socket TCP; UDP åº”ç”¨å±‚ çº¦å®šåº”ç”¨ç¨‹åºçš„æ•°æ®æ ¼å¼ HTTP; FTP; DNS æ¯ä¸€å±‚çº§ï¼Œéƒ½æ˜¯è§£å†³é—®é¢˜è€Œè¯ç”Ÿçš„ï¼Œä¹Ÿå°±æ˜¯ä»–ä»¬å„è‡ªä½œç”¨å¯¹åº”çš„é—®é¢˜ï¼Œæ¨èå‚è€ƒèµ„æ–™ä¸­çš„â€œäº’è”ç½‘åè®®å…¥é—¨â€ã€‚\n#HTTPé€šä¿¡æµç¨‹ # #æ‹“å±•\u0026ndash;ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹ # ç»å¸¸åœ¨å…¶ä»–åœ°æ–¹çœ‹åˆ°è¿™äº›ï¼Œä¸€ç›´ä¸çŸ¥é“äº†è§£è¿™éƒ¨åˆ†æœ‰ä»€ä¹ˆç”¨ï¼Œä½†æ˜¯syn Floodæ”»å‡»ï¼Œæ°æ°æ˜¯åˆ©ç”¨äº†TCPä¸‰æ¬¡æ¡æ‰‹ä¸­çš„ç¯èŠ‚ã€‚åˆ©ç”¨å‡IPä¼ªé€ SYNè¯·æ±‚ï¼ŒæœåŠ¡ç«¯ä¼šå¤šæ¬¡å°è¯•å‘é€SYN-ACKç»™å®¢æˆ·ç«¯ï¼Œä½†æ˜¯IPå¹¶ä¸å­˜åœ¨ä¹Ÿå°±æ— æ³•æˆåŠŸå»ºç«‹è¿æ¥ã€‚åœ¨ä¸€å®šæ—¶é—´å†…ä¼ªé€ å¤§é‡è¿™ç§è¯·æ±‚ï¼Œä¼šå¯¼è‡´æœåŠ¡å™¨èµ„æºè€—å°½æ— æ³•ä¸ºæ­£å¸¸çš„è¿æ¥æœåŠ¡ã€‚(æ³¨ï¼šæœåŠ¡å™¨SYNè¿æ¥æ•°é‡æœ‰é™åˆ¶ï¼ŒSYN-ACKè¶…æ—¶é‡ä¼ æœºåˆ¶)\nä¸‰æ¬¡æ¡æ‰‹æµç¨‹ï¼š\nThe client requests a connection by sending a SYN (synchronize) message to the server. The server acknowledges this request by sending SYN-ACK back to the client. The client responds with an ACK, and the connection is established. å››æ¬¡æŒ¥æ‰‹æµç¨‹ï¼š\nWhen an endpoint wishes to stop its half of the connection, it transmits a FIN packet. which the other end acknowledges with an ACK. Therefore, a typical tear-down requires a pair of FIN and ACK segments from each TCP endpoint. After the side that sent the first FIN has responded with the final ACK, it waits for a timeout before finally closing the connection, during which time the local port is unavailable for new connections.\nHTTPæŠ¥æ–‡ # HTTPæŠ¥æ–‡æ˜¯ç”±ä¸€è¡Œä¸€è¡Œçš„ç®€å•å­—ç¬¦ä¸²ç»„æˆçš„ï¼ŒHTTPæŠ¥æ–‡éƒ½æ˜¯çº¯æ–‡æœ¬ã€‚\nHTTPæŠ¥æ–‡åŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ï¼šèµ·å§‹è¡Œï¼›å¤´éƒ¨å­—æ®µï¼›ä¸»ä½“æ•°æ®ã€‚å…¶ä¸­å¤´éƒ¨æ˜¯éå¸¸é‡è¦çš„éƒ¨åˆ†ï¼Œä¼šå•ç‹¬æˆç« ã€‚\nä¸¾ä¾‹ï¼š\nGET / HTTP/1.1 Host: www.baidu.com Connection: keep-alive Upgrade-Insecure-Requests: 1 User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.71 Safari/537.36 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Encoding: gzip, deflate, sdch Accept-Language: zh-CN,zh;q=0.8,en;q=0.6 Cookie: BAIDUID=4082549DEE5E64678FC46642E185D98C:FG=1 ä¸¾ä¾‹ï¼š\nHTTP/1.1 200 OK Server: bfe/1.0.8.18 Date: Thu, 03 Nov 2016 08:30:43 GMT Content-Type: text/html Content-Length: 277 Last-Modified: Mon, 13 Jun 2016 02:50:03 GMT Connection: Keep-Alive ETag: \u0026#34;575e1f5b-115\u0026#34; Cache-Control: private, no-cache, no-store, proxy-revalidate, no-transform Pragma: no-cache Accept-Ranges: bytes #çŠ¶æ€ç  # çŠ¶æ€ä»£ç æœ‰ä¸‰ä½æ•°å­—ç»„æˆï¼Œç¬¬ä¸€ä¸ªæ•°å­—å®šä¹‰äº†å“åº”çš„ç±»åˆ«ï¼Œå…±åˆ†äº”ç§ç±»åˆ«:\n1xxï¼šæŒ‡ç¤ºä¿¡æ¯ ï¼ˆè¡¨ç¤ºè¯·æ±‚å·²æ¥æ”¶ï¼Œç»§ç»­å¤„ç†ï¼‰ 2xxï¼šæˆåŠŸ ï¼ˆè¡¨ç¤ºè¯·æ±‚å·²è¢«æˆåŠŸæ¥æ”¶ã€ç†è§£ã€æ¥å—ï¼‰ 3xxï¼šé‡å®šå‘ ï¼ˆè¦å®Œæˆè¯·æ±‚å¿…é¡»è¿›è¡Œæ›´è¿›ä¸€æ­¥çš„æ“ä½œï¼‰ 4xxï¼šå®¢æˆ·ç«¯é”™è¯¯ ï¼ˆè¯·æ±‚æœ‰è¯­æ³•é”™è¯¯æˆ–è¯·æ±‚æ— æ³•å®ç°ï¼‰ 5xxï¼šæœåŠ¡å™¨ç«¯é”™è¯¯ ï¼ˆæœåŠ¡å™¨æœªèƒ½å®ç°åˆæ³•çš„è¯·æ±‚ï¼‰\nè¿™é‡Œæˆ‘è§‰å¾—å¾ˆæœ‰å¿…è¦è¯´ä¸€ä¸‹çš„ï¼š3xxã€‚æœ€è¿‘å¼€å‘çš„æ—¶å€™é‡åˆ°ä¸€ä¸ªæƒ…å†µï¼š\nä»é¡µé¢ä¸Špostè·³è½¬åˆ°ç¬¬ä¸‰æ–¹é¡µé¢ï¼Œå®Œæˆåå¯¹æ–¹ä¼šé€šè¿‡POSTæºå¸¦æ•°æ®çš„æ–¹å¼è¿”å›åˆ°æˆ‘ä»¬çš„é¡µé¢ã€‚åœ¨å‰åç«¯åˆ†ç¦»çš„å¼€å‘æ¨¡å¼ä¸‹ï¼Œæš‚æ—¶æ²¡æœ‰æƒ³åˆ°å‰ç«¯è‡ªè¡Œè§£å†³çš„æ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬é€šè¿‡æœåŠ¡ç«¯æ¥å¤„ç†è¿™ä¸ªPOSTå›è°ƒæ¥å—æ•°æ®ï¼Œå†é€šè¿‡é‡å®šå‘çš„æ–¹å¼ï¼Œè·³å›åˆ°æˆ‘ä»¬è‡ªå·±çš„é¡µé¢ï¼ˆåªéœ€è¦å°†å¤„ç†ç»“æœï¼šæˆåŠŸæˆ–è€…å¤±è´¥ï¼Œé€šè¿‡urlå‚æ•°ä¼ ç»™å‰ç«¯ï¼‰ã€‚\né‡å®šå‘çš„æ—¶å€™ï¼Œéšä¾¿é€‰æ‹©äº†ä¸€ä¸ª307ï¼ˆTemporary Redirectï¼‰ï¼Œç„¶åè¿”å›é¡µé¢çš„æ—¶å€™è¿˜æ˜¯ä¼šæç¤ºï¼šâ€œ501 Not Implementedï¼Œ æ„æ€å°±æ˜¯ï¼šé¡µé¢ä¸æ”¯æŒPOSTè¯·æ±‚â€ã€‚è§£å†³åŠæ³•æ˜¯è¦æŠŠè¿™ä¸ªPOSTè½¬æˆGETå’¯ï¼Œæ€ä¹ˆè½¬å‘¢ï¼Ÿå¦‚ä¸‹ï¼š\nCode Text Method handling Typical use case 302 Found GET methods unchanged.Others may or may not be changed to GET The Web page is temporarily not available for reasons that have not been unforeseen. That way, search engines don\u0026rsquo;t update their links. 303 See Other GET methods unchanged.Others changed to GET (body lost). Used to redirect after a PUT or a POST to prevent a refresh of the page that would re-trigger the operation. 307 Temporary Redirect Method and body not changed. The Web page is temporarily not available for reasons that have not been unforeseen. That way, search engines don\u0026rsquo;t update their links. Better than 302 when non-GET links/operations are available on the site. æˆ‘ä»¬éœ€è¦çš„å°±æ˜¯303äº†ï¼š\nhttp.Redirect(w, r, url, 303) // æŠŠr(POST)é‡å®šå‘åˆ°url(GET) HTTPå¤´éƒ¨ # è¿™éƒ¨åˆ†ä¹Ÿå°±æ˜¯å¸¸è¯´çš„Headerï¼Œåœ¨HTTPåè®®ä¸­å¤´éƒ¨ä¸»è¦ä½œç”¨ä¸ºï¼šä¼ é€’é¢å¤–ä¿¡æ¯ã€‚åœ¨HTTPä¸­å¤´éƒ¨å¸¸è§åˆ†ç±»æœ‰ï¼šè¯·æ±‚å¤´éƒ¨/å“åº”å¤´éƒ¨/é€šç”¨å¤´éƒ¨/å®ä½“å¤´éƒ¨ã€‚ è¿™é‡Œä¹Ÿä¸ç»†è¯´æ¯ä¸ªè¯·æ±‚å¤´çš„ä½œç”¨äº†ï¼ˆåæ­£éƒ½æ˜¯æœé›†åˆ«äººçš„èµ„æ–™ï½ï¼Œå¯ä»¥å‚è§MDN HTTP Headersï¼‰ï¼Œå°±æ”¾å‡ ä¸ªå¯èƒ½ä¼šæœ‰å¸®åŠ©çš„ï¼š\n#Set-Cookie [Response] # å‘é€cookiesåˆ°å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯è¯·æ±‚çš„æ—¶å€™å¸¦ä¸ŠCookieå‘é€ç»™æœåŠ¡ç«¯ï¼Œå¯ä»¥å®Œæˆä¸€äº›éªŒè¯ã€‚\nSet-Cookie: \u0026lt;cookie-name\u0026gt;=\u0026lt;cookie-value\u0026gt; Set-Cookie: \u0026lt;cookie-name\u0026gt;=\u0026lt;cookie-value\u0026gt;; Expires=\u0026lt;date\u0026gt; Set-Cookie: \u0026lt;cookie-name\u0026gt;=\u0026lt;cookie-value\u0026gt;; Max-Age=\u0026lt;non-zero-digit\u0026gt; Set-Cookie: \u0026lt;cookie-name\u0026gt;=\u0026lt;cookie-value\u0026gt;; Domain=\u0026lt;domain-value\u0026gt; Set-Cookie: \u0026lt;cookie-name\u0026gt;=\u0026lt;cookie-value\u0026gt;; Path=\u0026lt;path-value\u0026gt; Set-Cookie: \u0026lt;cookie-name\u0026gt;=\u0026lt;cookie-value\u0026gt;; Secure Set-Cookie: \u0026lt;cookie-name\u0026gt;=\u0026lt;cookie-value\u0026gt;; HttpOnly Set-Cookie: \u0026lt;cookie-name\u0026gt;=\u0026lt;cookie-value\u0026gt;; SameSite=Strict Set-Cookie: \u0026lt;cookie-name\u0026gt;=\u0026lt;cookie-value\u0026gt;; SameSite=Lax // Multiple directives are also possible, for example: Set-Cookie: \u0026lt;cookie-name\u0026gt;=\u0026lt;cookie-value\u0026gt;; Domain=\u0026lt;domain-value\u0026gt;; Secure; HttpOnly #Access-Control-Allow-Origin [Repsonse] # å…è®¸å“ªä¸ªåŸŸå¯ä»¥è®¿é—®ä½ çš„èµ„æº\nAccess-Control-Allow-Origin: * Access-Control-Allow-Origin: \u0026lt;origin\u0026gt; #Access-Control-Allow-Credentials [Response] # è·¨åŸŸè¯·æ±‚å¿…è®¾ç½®\nThe Access-Control-Allow-Credentials header works in conjunction with the XMLHttpRequest.withCredentials property or with the credentials option in the Request() constructor of the Fetch API. Credentials must be set on both sides (the Access-Control-Allow-Credentials header and in the XHR or Fetch request) in order for the CORS request with credentials to succeed.\nAccess-Control-Allow-Credentials: true #Access-Control-Allow-Methods [Response] # å“åº”å¤´æŒ‡å®šè®¿é—®èµ„æºä»¥å“åº”é¢„æ£€è¯·æ±‚æ—¶å…è®¸çš„æ–¹æ³•ã€‚\nAccess-Control-Allow-Methods: \u0026lt;method\u0026gt;, \u0026lt;method\u0026gt;, ... #Access-Control-Allow-Headers [Response] # ï¼ˆé¢„æ£€è¯·æ±‚ï¼‰ç”¨äºæŒ‡æ˜åœ¨å®é™…è¯·æ±‚ä¸­å¯ä»¥ä½¿ç”¨å“ªäº›HTTPå¤´ã€‚\nAccess-Control-Allow-Headers: \u0026lt;header-name\u0026gt;, \u0026lt;header-name\u0026gt;, ... #Content-Type [Response/Request] # ç”¨äºè¡¨æ˜èµ„æºæ˜¯å“ªç§æ ¼å¼\nContent-Type: text/html; charset=utf-8 Content-Type: multipart/form-data; boundary=something HTTP Methods # æ–¹æ³• æè¿° ä½¿ç”¨åœºæ™¯ è¯·æ±‚æ˜¯å¦æœ‰body å“åº”æ˜¯å¦æœ‰body GET è·å–æŒ‡å®šèµ„æº è·å–ç½‘é¡µï¼ŒæŸ¥è¯¢èµ„æº æ²¡æœ‰ æœ‰ POST å‘é€æ•°æ®ç»™æœåŠ¡ç«¯ æ–°å»ºèµ„æºï¼›ç”¨æˆ·é€šè¿‡è¡¨å•ç™»å½• æœ‰ æœ‰ PUT æ–°å»ºèµ„æºæˆ–è€…æ›¿æ¢æŒ‡å®šèµ„æº æ›´æ–°ä¸€æ¡è®°å½• æœ‰ æœ‰ DELETE åˆ é™¤æŒ‡å®šèµ„æº åˆ é™¤ä¸€æ¡è®°å½•ï¼› æœ‰ æœ‰ OPTIONS ç”¨äºæè¿°ç‰¹å®šèµ„æºçš„è®¿é—®é€‰é¡¹ è·å–æœåŠ¡ç«¯æ”¯æŒçš„è¯·æ±‚æ–¹æ³• æ²¡æœ‰ æœ‰ CONNECT å¼€å¯åŒå‘é€šä¿¡ undefined æ²¡æœ‰ æœ‰ HEAD æè¿° ä½¿ç”¨åœºæ™¯ æ²¡æœ‰ æ²¡æœ‰ PATCH å¯¹èµ„æºéƒ¨åˆ†æ›´æ”¹ ä½¿ç”¨åœºæ™¯ æœ‰ æ²¡æœ‰ TRACE æè¿° ä½¿ç”¨åœºæ™¯ æœ‰ æœ‰ #GETå’ŒPOSTåŒºåˆ« # è¢«äººç†ŸçŸ¥çš„åŒºåˆ«æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š\nGETåé€€æŒ‰é’®/åˆ·æ–°æ— å®³ï¼ŒPOSTæ•°æ®ä¼šè¢«é‡æ–°æäº¤ï¼ˆæµè§ˆå™¨åº”è¯¥å‘ŠçŸ¥ç”¨æˆ·æ•°æ®ä¼šè¢«é‡æ–°æäº¤ï¼‰ã€‚ GETèƒ½è¢«ç¼“å­˜ï¼ŒPOSTå¤§éƒ¨åˆ†ä¸ç¼“å­˜ã€‚ GETç¼–ç ç±»å‹application/x-www-form-urlï¼ŒPOSTç¼–ç ç±»å‹encodedapplication/x-www-form-urlencoded æˆ– multipart/form-dataã€‚ä¸ºäºŒè¿›åˆ¶æ•°æ®ä½¿ç”¨å¤šé‡ç¼–ç ã€‚ GETå¯¹æ•°æ®é•¿åº¦æœ‰é™åˆ¶ï¼Œå½“å‘é€æ•°æ®æ—¶ï¼ŒGETæ–¹æ³•å‘URLæ·»åŠ æ•°æ®ï¼›URL çš„é•¿åº¦æ˜¯å—é™åˆ¶çš„ï¼ˆURLçš„æœ€å¤§é•¿åº¦æ˜¯2048ä¸ªå­—ç¬¦ã€‚POSTæ— é™åˆ¶ã€‚ GETåªå…è®¸ASCIIå­—ç¬¦ã€‚POSTæ²¡æœ‰é™åˆ¶ã€‚ä¹Ÿå…è®¸äºŒè¿›åˆ¶æ•°æ®ã€‚ ä¸ POST ç›¸æ¯”ï¼ŒGETçš„å®‰å…¨æ€§è¾ƒå·®ï¼Œå› ä¸ºæ‰€å‘é€çš„æ•°æ®æ˜¯URLçš„ä¸€éƒ¨åˆ†ã€‚ ä¸Šè¿°æ˜¯ä»è¡¨è±¡æ¥è¯´ä¸¤è€…æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œé‚£ä¹ˆä»æ–¹æ³•è¯­ä¹‰å‘¢ï¼ŸHTTPåè®®ä¸­GETå’ŒPOSTçš„åŒºåˆ«å¥½å§ï¼Œå…¶å®å°±æ˜¯è¯´ï¼šGETè¯·æ±‚å¯¹äºèµ„æºä¸åº”è¯¥äº§ç”Ÿå½±å“ï¼ŒPOST\tè¯·æ±‚ä¼šé€ æˆèµ„æºå˜åŒ–ï¼Œä¸”å¤šæ¬¡è¯·æ±‚å˜åŒ–ä¸å›ºå®šï¼ˆéå¹‚ç­‰ï¼‰ã€‚\n#PUTå’ŒPOSTåŒºåˆ« # åŒä¸€ä¸ªPUTè°ƒç”¨å¤šæ¬¡ï¼Œä¸å¯¹äº§ç”Ÿå…¶ä»–å½±å“ï¼Œè¿”å›ç»“æœä¸€è‡´ï¼Œèµ„æºå˜åŒ–ä¸€è‡´ã€‚ä½†æ˜¯å¤šæ¬¡æäº¤ç›¸åŒçš„POSTå¯èƒ½ä¼šæœ‰ä¸ä¸€æ ·çš„å“åº”ï¼Œæ ¹æ®è®¾è®¡çš„ä¸åŒï¼ŒæœåŠ¡ç«¯å¯èƒ½æç¤ºï¼šèµ„æºé‡å¤ï¼Œæˆ–è€…æ–°å¢ç›¸åŒçš„èµ„æºå¤šæ¬¡ã€‚ä¹Ÿå°±æ˜¯è¯´PUTå¹‚ç­‰ï¼ŒPOSTéå¹‚ç­‰ã€‚\næ€»ç»“ # ä¸Šè¿°åªèƒ½ç®—HTTPåè®®çš„å°éƒ¨åˆ†çŸ¥è¯†ï¼Œå…¶åŒ…å«åŠç›¸å…³çŸ¥è¯†è¿˜æœ‰å¾ˆå¤šï¼Œå¦‚åŸºæœ¬çš„HTTPé‰´æƒï¼ŒHTTPSçš„å·¥ä½œæµç¨‹ï¼ŒHTTPå¦‚ä½•åŸºäºTCP/IPåè®®æ¥å®ç°çš„ã€‚\nå‚è€ƒèµ„æ–™ # æ¥ä¸€åœºè½°è½°çƒˆçƒˆçš„HTTPåè®®æ‰«ç›² HTTPåè®®å…¥é—¨ äº’è”ç½‘åè®®å…¥é—¨ MDN HTTP Headers HTTPåè®®ä¸­GETå’ŒPOSTçš„åŒºåˆ« "},{"id":49,"href":"/2018/06/08/api-gateway%E4%B8%AD%E5%AE%9E%E7%8E%B0%E5%9F%BA%E4%BA%8E%E6%9D%83%E9%87%8D%E7%9A%84%E8%BD%AE%E8%AF%A2%E8%B0%83%E5%BA%A6/","title":"api-gatewayä¸­å®ç°åŸºäºæƒé‡çš„è½®è¯¢è°ƒåº¦","section":"Posts","content":" èƒŒæ™¯å’Œç›®æ ‡ # èƒŒæ™¯ # é¡¹ç›®éœ€è¦åœ¨ç°æœ‰é¡¹ç›®çš„åŸºç¡€ä¸Šå®ç°æƒé™ç³»ç»Ÿï¼Œä½†ä¸ºäº†ä½è€¦åˆï¼Œé€‰æ‹©å®ç°äº†ä¸€ä¸ªåŸºäºne7ermore/gRBACçš„auth-serverï¼Œç”¨äºå®ç°æƒé™ï¼Œè§’è‰²ï¼Œç”¨æˆ·çš„ç®¡ç†ï¼Œä»¥åŠæä¾›é‰´æƒæœåŠ¡ã€‚åœ¨å¼€å‘ç¯å¢ƒå¯¹æ¥æ²¡æœ‰é—®é¢˜ï¼Œæ­£å¸¸çš„é‰´æƒè®¿é—®ã€‚åˆ°äº†çº¿ä¸Šéƒ¨ç½²çš„æ—¶å€™ï¼Œæ‰å‘ç°ï¼š\nçº¿ä¸ŠæŸæœåŠ¡éƒ¨ç½²åœ¨å¤šå°æœºå™¨ä¸Š; ç›®å‰çš„api-gatewayå¹¶ä¸æ”¯æŒåŒä¸€æœåŠ¡é…ç½®å¤šä¸ªnode; æƒ³çš„åŠæ³•æœ‰ï¼š\nåºå· æè¿° ä¼˜ç‚¹ ç¼ºç‚¹ 1 api-gatewayé€šè¿‡urlæ¥è½¬å‘è¯·æ±‚ï¼Œä¹‹å‰æ˜¯é…ç½®IPåŠ ç«¯å£ api-gatewayæ”¹åŠ¨å° å½±å“webå’ŒAPPå‡çº§ 2 api-gatewayèƒ½æ”¯æŒå¤šå°æœºå™¨ï¼Œå¹¶è¿›è¡Œè°ƒåº¦ api-gatewayåŠŸèƒ½æ›´å¼ºå¤§ï¼ŒæŠŠä»¥åè¦åšçš„äº‹æƒ…æå‰åšå¥½åŸºç¡€ å¥½åƒæ²¡å•¥ç¼ºç‚¹ï¼Œåªæ˜¯è´¹ç‚¹æ—¶é—´æ”¯æŒä¸‹å¤šèŠ‚ç‚¹é…ç½®ï¼Œå¹¶è°ƒåº¦ å¦‚æœæ²¡è¯´æ¸…ï¼Œè¯·çœ‹ä¸‹å›¾ï¼š\nç›®æ ‡ # é‚£ä¹ˆï¼Œç›®æ ‡ä¹Ÿå°±æ˜ç¡®äº†ï¼Œéœ€è¦å®ç°api-gatewayä¸­å®ç°åŸºäºæƒé‡çš„è°ƒåº¦ã€‚ä¸ºå•¥è¦åŸºäºæƒé‡ï¼Ÿå…¶ä¸€æ˜¯ä»¿ç…§nginxåŸºäºæƒé‡çš„è´Ÿè½½å‡è¡¡ï¼Œå…¶äºŒæ˜¯æœåŠ¡å™¨æ€§èƒ½å·®å¼‚ã€‚\nè½®è¯¢è°ƒåº¦ç®—æ³•ä»‹ç» # è½®è¯¢è°ƒåº¦ç®—æ³•: # è½®è¯¢è°ƒåº¦ç®—æ³•çš„åŸç†æ˜¯æ¯ä¸€æ¬¡æŠŠæ¥è‡ªç”¨æˆ·çš„è¯·æ±‚è½®æµåˆ†é…ç»™å†…éƒ¨ä¸­çš„æœåŠ¡å™¨ï¼Œä»1å¼€å§‹ï¼Œç›´åˆ°N(å†…éƒ¨æœåŠ¡å™¨ä¸ªæ•°)ï¼Œç„¶åé‡æ–°å¼€å§‹å¾ªç¯ã€‚è¯¥ç®—æ³•çš„ä¼˜ç‚¹æ˜¯å…¶ç®€æ´æ€§ï¼Œå®ƒæ— éœ€è®°å½•å½“å‰æ‰€æœ‰è¿æ¥çš„çŠ¶æ€ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€ç§æ— çŠ¶æ€è°ƒåº¦ã€‚\nå‡è®¾æœ‰ä¸€ç»„æœåŠ¡å™¨Nå°ï¼ŒS = {S1, S2, â€¦, Sn}ï¼Œä¸€ä¸ªæŒ‡ç¤ºå˜é‡iè¡¨ç¤ºä¸Šä¸€æ¬¡é€‰æ‹©çš„æœåŠ¡å™¨IDã€‚å˜é‡iè¢«åˆå§‹åŒ–ä¸ºN-1ã€‚å…¶ç®—æ³•å¦‚ä¸‹ï¼š\nj = i; do { j = (j + 1) mod n; i = j; return Si; } while (j != i); return NULL; å¹³æ»‘åŠ æƒè½®è¯¢è°ƒåº¦ç®—æ³•ï¼š # ä¸Šè¿°çš„è½®è¯¢è°ƒåº¦ç®—æ³•ï¼Œå¹¶æ²¡æœ‰è€ƒè™‘æœåŠ¡å™¨æ€§èƒ½çš„å·®å¼‚ï¼Œå®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ¯ä¸€å°æœåŠ¡å™¨é…ç½®å’Œå®‰è£…çš„ä¸šåŠ¡å¹¶ä¸ä¸€å®šç›¸åŒï¼Œå¤„ç†èƒ½åŠ›ä¸å®Œå…¨ä¸€æ ·ã€‚å› æ­¤éœ€è¦æ ¹æ®æœåŠ¡å™¨èƒ½åŠ›ï¼Œåˆ†é…ä¸åŒçš„æƒå€¼ï¼Œä»¥å…æœåŠ¡çš„è¶…è´Ÿè·å’Œè¿‡åˆ†é—²ä½™ã€‚\nå‡è®¾æœ‰ä¸€ç»„æœåŠ¡å™¨S = {S0, S1, â€¦, Sn-1}, å…¶ç®—æ³•å¦‚ä¸‹ï¼š\n// iè¡¨ç¤ºä¸Šä¸€æ¬¡é€‰æ‹©çš„æœåŠ¡å™¨ï¼Œå˜é‡iåˆå§‹åŒ–ä¸º-1 // W(Si)è¡¨ç¤ºæœåŠ¡å™¨Siçš„æƒå€¼ // cwè¡¨ç¤ºå½“å‰è°ƒåº¦çš„æƒå€¼ cwåˆå§‹åŒ–ä¸º0 // max(S)è¡¨ç¤ºé›†åˆSä¸­æ‰€æœ‰æœåŠ¡å™¨çš„æœ€å¤§æƒå€¼ // gcd(S)è¡¨ç¤ºé›†åˆSä¸­æ‰€æœ‰æœåŠ¡å™¨æƒå€¼çš„æœ€å¤§å…¬çº¦æ•° while (true) { i = (i + 1) mod n; if (i == 0) { cw = cw - gcd(S); if (cw \u0026lt;= 0) { cw = max(S); if (cw == 0) return NULL; } } if (W(Si) \u0026gt;= cw) return Si; } NginxåŸºäºæƒé‡çš„è½®è¯¢ç®—æ³•çš„å®ç°å¯ä»¥å‚è€ƒå®ƒçš„ä¸€æ¬¡ä»£ç æäº¤ï¼š Upstream: smooth weighted round-robin balancingã€‚\nå®ƒä¸ä½†å®ç°äº†åŸºäºæƒé‡çš„è½®è¯¢ç®—æ³•ï¼Œè€Œä¸”è¿˜å®ç°äº†å¹³æ»‘çš„ç®—æ³•ã€‚æ‰€è°“å¹³æ»‘ï¼Œå°±æ˜¯åœ¨ä¸€æ®µæ—¶é—´å†…ï¼Œä¸ä»…æœåŠ¡å™¨è¢«é€‰æ‹©çš„æ¬¡æ•°çš„åˆ†å¸ƒå’Œå®ƒä»¬çš„æƒé‡ä¸€è‡´ï¼Œè€Œä¸”è°ƒåº¦ç®—æ³•è¿˜æ¯”è¾ƒå‡åŒ€çš„é€‰æ‹©æœåŠ¡å™¨ï¼Œè€Œä¸ä¼šé›†ä¸­ä¸€æ®µæ—¶é—´ä¹‹å†…åªé€‰æ‹©æŸä¸€ä¸ªæƒé‡æ¯”è¾ƒé«˜çš„æœåŠ¡å™¨ã€‚å¦‚æœä½¿ç”¨éšæœºç®—æ³•é€‰æ‹©æˆ–è€…æ™®é€šçš„åŸºäºæƒé‡çš„è½®è¯¢ç®—æ³•ï¼Œå°±æ¯”è¾ƒå®¹æ˜“é€ æˆæŸä¸ªæœåŠ¡é›†ä¸­è¢«è°ƒç”¨å‹åŠ›è¿‡å¤§ã€‚\nä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚æƒé‡ä¸º{a:5, b:1, c:1)çš„ä¸€ç»„æœåŠ¡å™¨ï¼ŒNginxçš„å¹³æ»‘çš„è½®è¯¢ç®—æ³•é€‰æ‹©çš„åºåˆ—ä¸º{ a, a, b, a, c, a, a },è¿™æ˜¾ç„¶è¦æ¯”{ c, b, a, a, a, a, a }åºåˆ—æ›´å¹³æ»‘ï¼Œæ›´åˆç†ï¼Œä¸ä¼šé€ æˆå¯¹aæœåŠ¡å™¨çš„é›†ä¸­è®¿é—®ã€‚\nåœ¨å‚è€ƒæ–‡çŒ®å¹³æ»‘çš„åŸºäºæƒé‡çš„è°ƒåº¦ç®—æ³•ä¸­ï¼Œä½œè€…ç»™å‡ºäº†ä»¿ç…§nginxdçš„å¹³æ»‘æƒé‡è½®è¯¢è°ƒåº¦ç®—æ³•çš„Golangç‰ˆæœ¬ä»£ç ï¼Œè¿˜æœ‰ä¸€ä¸ªweightedåº“è‡ªèã€‚è¿™é‡Œåšä¸€ä¸ªå»¶ä¼¸ï½\nè´´ä¸€ä¸‹æµ‹è¯•æµ‹è¯•ä»£ç åŠç»“æœï¼š\nfunc Test_Init(t *testing.T) { servers := []*conf.ProxyServerConfig{ { Schema: \u0026#34;http://\u0026#34;, Host: \u0026#34;127.0.0.1\u0026#34;, Prefix: \u0026#34;/api\u0026#34;, Port: 8808, Weight: 4, }, { Schema: \u0026#34;http://\u0026#34;, Host: \u0026#34;127.0.0.1\u0026#34;, Prefix: \u0026#34;/api\u0026#34;, Port: 8808, Weight: 4, }, { Schema: \u0026#34;http://\u0026#34;, Host: \u0026#34;127.0.0.1\u0026#34;, Prefix: \u0026#34;/api\u0026#34;, Port: 8808, Weight: 2, }, } bla := InitBalancer(servers) cnt := 0 mark := map[int]int{} for cnt \u0026lt; 10 { idx := bla.Distribute() t.Log(idx) mark[idx]++ cnt++ } t.Log(mark) } // === RUN Test_Init // --- PASS: Test_Init (0.00s) // balance_test.go:45: 0 // balance_test.go:45: 1 // balance_test.go:45: 0 // balance_test.go:45: 1 // balance_test.go:45: 2 // balance_test.go:45: 0 // balance_test.go:45: 1 // balance_test.go:45: 0 // balance_test.go:45: 1 // balance_test.go:45: 2 // balance_test.go:50: map[0:4 1:4 2:2] // åœ¨10æ¬¡è°ƒåº¦ä¸­ï¼Œä¸‰ä¸ªæœåŠ¡åˆ†åˆ«è¢«è°ƒç”¨äº†å“åº”æƒé‡çš„æ¬¡æ•°ï¼Œä¸”é¡ºåºå¹¶ä¸æ˜¯[0,0,0,0,1,1,1,1,2,2] è°ƒåº¦å™¨å®ç° # ç®—æ³•è®²å®Œäº†ï¼Œæˆ‘å°±ç›´æ¥ä¸Šä»£ç äº†ã€‚\ntype Balancer struct { serverWeights map[int]int // host and weight maxWeight int // 0 maxGCD int // 1 lenOfSW int // 0 i int //è¡¨ç¤ºä¸Šä¸€æ¬¡é€‰æ‹©çš„æœåŠ¡å™¨, -1 cw int //è¡¨ç¤ºå½“å‰è°ƒåº¦çš„æƒå€¼, 0 } // æ ¹æ®æœåŠ¡é…ç½®åˆå§‹åŒ–è°ƒåº¦å™¨ // conf.ProxyServerConfig é…ç½®å¯ä»¥å‚è§ä¸Šè¿°æµ‹è¯•ä»£ç  func InitBalancer(servers []*conf.ProxyServerConfig) *Balancer { bla := \u0026amp;Balancer{ serverWeights: make(map[int]int), maxWeight: 0, maxGCD: 1, lenOfSW: len(servers), i: -1, cw: 0, } _tmp_gcd := make([]int, 0, bla.lenOfSW) for idx, psc := range servers { bla.serverWeights[idx] = psc.Weight if psc.Weight \u0026gt; bla.maxWeight { bla.maxWeight = psc.Weight } _tmp_gcd = append(_tmp_gcd, psc.Weight) } // æ±‚æœ€å¤§å…¬çº¦æ•° bla.maxGCD = nGCD(_tmp_gcd, bla.lenOfSW) return bla } // è°ƒåº¦ func (bla *Balancer) Distribute() int { for true { bla.i = (bla.i + 1) % bla.lenOfSW if bla.i == 0 { bla.cw = bla.cw - bla.maxGCD if bla.cw \u0026lt;= 0 { bla.cw = bla.maxWeight if bla.cw == 0 { return 0 } } } if bla.serverWeights[bla.i] \u0026gt;= bla.cw { return bla.i } } return 0 } // æ±‚æœ€å¤§å…¬çº¦æ•° func GCD(a, b int) int { if a \u0026lt; b { a, b = b, a // swap a \u0026amp; b } if b == 0 { return a } return GCD(b, a%b) } // Nä¸ªæ•°çš„æœ€å¤§å…¬çº¦æ•° func nGCD(data []int, n int) int { if n == 1 { return data[0] } return GCD(data[n-1], nGCD(data, n-1)) } åµŒå…¥Api-Gateway # å·²ç»å®ç°äº†è°ƒåº¦å™¨ï¼Œå¹¶æµ‹è¯•å¦¥å½“ï¼Œé‚£ä¹ˆå¦‚ä½•å®é™…æ”¾åˆ°ç½‘å…³æœåŠ¡ä¸­å»å‘¢ï¼Ÿæˆ‘å…ˆç®€å•æè¿°ä¸‹ï¼Œä¹‹å‰çš„æœåŠ¡æ˜¯å¦‚ä½•è°ƒç”¨çš„ã€‚åœ¨Golangæ ‡å‡†åº“é‡Œæœ‰ä¸€ä¸ªä¸œè¥¿å«åšï¼š\nhttputil.NewSingleHostReverseProxy æ–‡æ¡£ç”±æ­¤å»\nè¿™å°±æ˜¯æœ¬ç½‘å…³ä¸­ä¸»è¦ç”¨äºè¯·æ±‚è½¬å‘çš„å…³é”®ã€‚åœ¨è½¬å‘è¯·æ±‚ä¹‹å‰ï¼Œæˆ‘éœ€è¦åšçš„äº‹å°±æ˜¯ï¼šåŒ¹é…æœ¬æ¬¡è¯·æ±‚åº”è¯¥è½¬å‘ç»™å“ªä¸€ä¸ªæœåŠ¡ï¼Ÿå¤§å®¶éƒ½é€šè¿‡ï¼šapi.xxx.comçš„åŸŸåæ¥è®¿é—®ï¼Œä½†æ˜¯å¯¹äºä¸åŒçš„åŠŸèƒ½ä¼šæœ‰ä¸åŒçš„è·¯å¾„å‰ç¼€å¦‚ï¼š\u0026quot;/api\u0026quot;, \u0026ldquo;/auth\u0026rdquo;, \u0026ldquo;/res\u0026quot;ç­‰ç­‰ã€‚åŒ¹é…å®Œæˆï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šæˆ‘è¦è½¬å‘ç»™çš„æœåŠ¡æœ‰å¤šä¸ªï¼Œå’‹ä¸ªè°ƒåº¦å‘¢ï¼Ÿè¿™ä¸ªä½ç½®å°±æ˜¯æˆ‘éœ€è¦æŠŠè°ƒåº¦å™¨åµŒå…¥çš„ä½ç½®ï¼Œä¸Šä»£ç ï¼š\ntype ProxyServer struct { // ... some other data Servers map[string][]*conf.ProxyServerConfig Balancer map[string]*Balancer } func (ps *ProxyServer) InitBalancer() { for srv_name, srvs := range ps.Servers { ps.Balancer[srv_name] = InitBalancer(srvs) } } // åŒ¹é…éœ€è¦è½¬å‘çš„å‰ç¼€ func (ps *ProxyServer) MatchProxy(path string, req *http.Request) (error, *url.URL) { for srv_name, srvs := range ps.Servers { // default set 0, to choose srvs to service srv := srvs[0] if strings.HasPrefix(path, srv.Prefix) { // load balance srv_idx := ps.Balancer[srv_name].Distribute() srv = srvs[srv_idx] _url := utils.Fstring(\u0026#34;%s%s:%d\u0026#34;, srv.Schema, srv.Host, srv.Port) remote, err := url.Parse(_url) if err != nil { return err, nil } req.URL.Path = strings.TrimPrefix(path, srv.Prefix) return nil, remote } } return errors.New(\u0026#34;did not match any proxy server\u0026#34;), nil } è‡³æ­¤ï¼Œä¹Ÿå°±å®Œæˆäº†åœ¨api-gatewayä¸­åµŒå…¥åŸºäºæƒé‡çš„è½®è¯¢è°ƒåº¦ã€‚\næ³¨ # ç”¨è¯è¡¨è¿°ä¸å½“ï¼Œè¿˜æœ›è°…è§£å¹¶åŠæ—¶å‘ŠçŸ¥ã€‚å…¶æ¬¡æ²¡æœ‰è¿‡å¤šçš„åˆ†æç®—æ³•æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Œè¿™å¹¶éæˆ‘æ‰€æ“…é•¿ï¼Œä¹Ÿä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï½ ä»¥ä¸Š\nå‚è€ƒæ–‡çŒ® # è½®è¯¢è°ƒåº¦ç®—æ³•(Round-Robin Scheduling) golangå®ç°æƒé‡è½®è¯¢è°ƒåº¦ç®—æ³• å¹³æ»‘çš„åŸºäºæƒé‡çš„è°ƒåº¦ç®—æ³• "},{"id":50,"href":"/2018/05/18/%E4%BD%BF%E7%94%A8golang-%E5%AE%9E%E7%8E%B0JSON-RPC2-0/","title":"ä½¿ç”¨golang å®ç°JSON-RPC2.0","section":"Posts","content":" ä»€ä¹ˆæ˜¯RPCï¼Ÿ # è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆè‹±è¯­ï¼šRemote Procedure Callï¼Œç¼©å†™ä¸º RPCï¼‰æ˜¯ä¸€ä¸ªè®¡ç®—æœºé€šä¿¡åè®®ã€‚è¯¥åè®®å…è®¸è¿è¡Œäºä¸€å°è®¡ç®—æœºçš„ç¨‹åºè°ƒç”¨å¦ä¸€å°è®¡ç®—æœºçš„å­ç¨‹åºï¼Œè€Œç¨‹åºå‘˜æ— éœ€é¢å¤–åœ°ä¸ºè¿™ä¸ªäº¤äº’ä½œç”¨ç¼–ç¨‹ã€‚å¦‚æœæ¶‰åŠçš„è½¯ä»¶é‡‡ç”¨é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼Œé‚£ä¹ˆè¿œç¨‹è¿‡ç¨‹è°ƒç”¨äº¦å¯ç§°ä½œè¿œç¨‹è°ƒç”¨æˆ–è¿œç¨‹æ–¹æ³•è°ƒç”¨ã€‚\nè¿œç¨‹è¿‡ç¨‹è°ƒç”¨æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼è®¡ç®—çš„å®¢æˆ·ç«¯-æœåŠ¡å™¨ï¼ˆClient/Serverï¼‰çš„ä¾‹å­ï¼Œå®ƒç®€å•è€Œåˆå¹¿å—æ¬¢è¿ã€‚è¿œç¨‹è¿‡ç¨‹è°ƒç”¨æ€»æ˜¯ç”±å®¢æˆ·ç«¯å¯¹æœåŠ¡å™¨å‘å‡ºä¸€ä¸ªæ‰§è¡Œè‹¥å¹²è¿‡ç¨‹è¯·æ±‚ï¼Œå¹¶ç”¨å®¢æˆ·ç«¯æä¾›çš„å‚æ•°ã€‚æ‰§è¡Œç»“æœå°†è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ç”±äºå­˜åœ¨å„å¼å„æ ·çš„å˜ä½“å’Œç»†èŠ‚å·®å¼‚ï¼Œå¯¹åº”åœ°æ´¾ç”Ÿäº†å„å¼è¿œç¨‹è¿‡ç¨‹è°ƒç”¨åè®®ï¼Œè€Œä¸”å®ƒä»¬å¹¶ä¸äº’ç›¸å…¼å®¹ã€‚â€”â€”â€”â€”â€”â€”æºè‡ªç»´åŸºç™¾ç§‘\nä»€ä¹ˆåˆæ˜¯JSON-RPC? # JSON-RPCï¼Œæ˜¯ä¸€ä¸ªæ— çŠ¶æ€ä¸”è½»é‡çº§çš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰ä¼ é€åè®®ï¼Œå…¶ä¼ é€’å†…å®¹é€šè¿‡ JSON ä¸ºä¸»ã€‚ç›¸è¾ƒäºä¸€èˆ¬çš„ REST é€šè¿‡ç½‘å€ï¼ˆå¦‚ GET /userï¼‰è°ƒç”¨è¿œç¨‹æœåŠ¡å™¨ï¼ŒJSON-RPC ç›´æ¥åœ¨å†…å®¹ä¸­å®šä¹‰äº†æ¬²è°ƒç”¨çš„å‡½æ•°åç§°ï¼ˆå¦‚ {\u0026ldquo;method\u0026rdquo;: \u0026ldquo;getUser\u0026rdquo;}ï¼‰ï¼Œè¿™ä¹Ÿä»¤å¼€å‘è€…ä¸ä¼šé™·äºè¯¥ä½¿ç”¨ PUT æˆ–è€… PATCH çš„é—®é¢˜ä¹‹ä¸­ã€‚ æ›´å¤šJSON-RPCçº¦å®šå‚è§ï¼šhttps://zh.wikipedia.org/wiki/JSON-RPC\né—®é¢˜ # æœåŠ¡ç«¯æ³¨å†ŒåŠè°ƒç”¨ # çº¦å®šå¦‚**net/rpc**ï¼š\nthe method\u0026rsquo;s type is exported. the method is exported. the method has two arguments, both exported (or builtin) types. the method\u0026rsquo;s second argument is a pointer. the method has return type error. // è¿™å°±æ˜¯çº¦å®š func (t *T) MethodName(argType T1, replyType *T2) error é‚£ä¹ˆé—®é¢˜æ¥äº†:\né—®é¢˜1: Serveræ€ä¹ˆæ¥æ³¨å†Œ`t.Methods`? é—®é¢˜2: JSON-RPCè¯·æ±‚å‚æ•°é‡Œé¢çš„Paramsç»™åˆ°args? serverç«¯ç±»å‹å®šä¹‰ï¼š\ntype methodType struct { method reflect.Method // ç”¨äºè°ƒç”¨ ArgType reflect.Type ReplyType reflect.Type } type service struct { name string // æœåŠ¡çš„åå­—, ä¸€èˆ¬ä¸º`T` rcvr reflect.Value // æ–¹æ³•çš„æ¥å—è€…, å³çº¦å®šä¸­çš„ `t` typ reflect.Type // æ³¨å†Œçš„ç±»å‹, å³çº¦å®šä¸­çš„`T` method map[string]*methodType // æ³¨å†Œçš„æ–¹æ³•, å³çº¦å®šä¸­çš„`MethodName`çš„é›†åˆ } // Server represents an RPC Server. type Server struct { serviceMap sync.Map // map[string]*service } è§£å†³é—®é¢˜1ï¼Œå‚è€ƒäº†net/rpcä¸­çš„æ³¨å†Œè°ƒç”¨ã€‚ä¸»è¦ä½¿ç”¨reflectè¿™ä¸ªåŒ…ã€‚ä»£ç å¦‚ä¸‹ï¼š\n// è§£æä¼ å…¥çš„ç±»å‹åŠç›¸åº”çš„å¯å¯¼å‡ºæ–¹æ³•ï¼Œå°†rcvrçš„typeï¼ŒMethodsçš„ç›¸å…³ä¿¡æ¯å­˜æ”¾åˆ°Server.mä¸­ã€‚ // å¦‚æœtypeæ˜¯ä¸å¯å¯¼å‡ºçš„ï¼Œåˆ™ä¼šæŠ¥é”™ func (s *Server) Register(rcvr interface{}) error { _service := new(service) _service.typ = reflect.TypeOf(rcvr) _service.rcvr = reflect.ValueOf(rcvr) sname := reflect.Indirect(_service.rcvr).Type().Name() if sname == \u0026#34;\u0026#34; { err_s := \u0026#34;rpc.Register: no service name for type \u0026#34; + _service.typ.String() log.Print(err_s) return errors.New(err_s) } if !isExported(sname) { err_s := \u0026#34;rpc.Register: type \u0026#34; + sname + \u0026#34; is not exported\u0026#34; log.Print(err_s) return errors.New(err_s) } _service.name = sname _service.method = suitableMethods(_service.typ, true) // sync.Map.LoadOrStore if _, dup := s.m.LoadOrStore(sname, _service); dup { return errors.New(\u0026#34;rpc: service already defined: \u0026#34; + sname) } return nil } // å…³äºsuitableMethodsï¼Œä¹Ÿæ˜¯ä½¿ç”¨reflectï¼Œ // æ¥è·å–_service.typä¸­çš„æ‰€æœ‰å¯å¯¼å‡ºæ–¹æ³•åŠæ–¹æ³•çš„ç›¸å…³å‚æ•°ï¼Œä¿å­˜æˆ*methodType suitableMethodsä»£ç ç”±æ­¤å»ï¼š[https: //github.com/yeqown/rpc/blob/master/server.go#L105](https: //github.com/yeqown/rpc/blob/master/server.go#L105)\nè§£å†³é—®é¢˜2ï¼Œè¦è§£å†³é—®é¢˜2ï¼Œä¸”å…ˆçœ‹å¦‚ä½•è°ƒç”¨Methodï¼Œä»£ç å¦‚ä¸‹ï¼š\n// çº¦å®šï¼š func (t *T) MethodName(argType T1, replyType *T2) error // s.rcvrï¼š å³çº¦å®šä¸­çš„ t // argvï¼š å³çº¦å®šä¸­çš„ argType // replyvï¼š å³çº¦å®šä¸­çš„ replyType func (s *service) call(mtype *methodType, req *Request, argv, replyv reflect.Value) *Response { function := mtype.method.Func returnValues := function.Call([]reflect.Value{s.rcvr, argv, replyv}) errIter := returnValues[0].Interface() errmsg := \u0026#34;\u0026#34; if errIter != nil { errmsg = errIter.(error).Error() return NewResponse(req.ID, nil, NewJsonrpcErr(InternalErr, errmsg, nil)) } return NewResponse(req.ID, replyv.Interface(), nil) } çœ‹äº†å¦‚ä½•è°ƒç”¨ï¼Œå†åŠ ä¸ŠJSON-RPCçš„çº¦å®šï¼ŒçŸ¥é“äº†ä¼ ç»™æœåŠ¡ç«¯çš„æ˜¯ä¸€ä¸ªJSONï¼Œè€Œä¸”å…¶ä¸­çš„Paramsæ˜¯ä¸€ä¸ªjsonæ ¼å¼çš„æ•°æ®ã€‚é‚£å°±å˜æˆäº†:interface{} - req.Params åˆ°reflect.Value - argvã€‚é‚£ä¹ˆæ€ä¹ˆè½¬æ¢å‘¢ï¼Ÿçœ‹ä»£ç ï¼š\nfunc (s *Server) call(req *Request) *Response { // .... // æ ¹æ®req.Methodæ¥æŸ¥è¯¢method // req.Method æ ¼å¼å¦‚ï¼š\u0026#34;ServiceName.MethodName\u0026#34; // mtype *methodType mtype := svc.method[methodName] // æ ¹æ®æ³¨å†Œæ—¶å€™çš„mtype.ArgTypeæ¥ç”Ÿæˆä¸€ä¸ªreflect.Value argIsValue := false // if true, need to indirect before calling. var argv reflect.Value if mtype.ArgType.Kind() == reflect.Ptr { argv = reflect.New(mtype.ArgType.Elem()) } else { argv = reflect.New(mtype.ArgType) argIsValue = true } if argIsValue { argv = argv.Elem() } // ä¸ºargvå‚æ•°ç”Ÿæˆäº†ä¸€ä¸ªreflect.Value,ä½†æ˜¯argvç›®å‰ä¸ºæ­¢éƒ½è¿˜æ˜¯æ˜¯0å€¼ã€‚ // é‚£ä¹ˆæ€ä¹ˆæŠŠreq.Params å¤åˆ¶ç»™argv ? // æˆ‘å°è¯•è¿‡ï¼Œargv = reflect.Value(req.Params)ï¼Œä½†æ˜¯åœ¨è°ƒç”¨çš„æ—¶å€™ ä¼šæç¤ºè¯´ï¼šâ€œmap[string]interface{} as main.*Argsâ€ï¼Œ // è¿™ä¹Ÿå°±æ˜¯è¯´ï¼Œå¹¶æ²¡æœ‰å°†å‚æ•°çš„å€¼æ­£ç¡®çš„èµ‹å€¼ç»™argvã€‚ // åé¢æ‰åˆäº†è¿™ä¸ªconvertå‡½æ•°: // bs, _ := json.Marshal(req.Params) // json.Unmarshal(bs, argv.Interface()) // å› æ­¤æœ‰ä¸€äº›é™åˆ¶ï½ï¼Œå°±ä¸å¤šè¯´äº† convert(req.Params, argv.Interface()) // Note: çº¦å®šä¸­ReplyTypeæ˜¯ä¸€ä¸ªæŒ‡é’ˆç±»å‹ï¼Œæ–¹ä¾¿èµ‹å€¼ã€‚ // æ ¹æ®æ³¨å†Œæ—¶å€™çš„mtype.ReplyTypeæ¥ç”Ÿæˆä¸€ä¸ªreflect.Value replyv := reflect.New(mtype.ReplyType.Elem()) switch mtype.ReplyType.Elem().Kind() { case reflect.Map: replyv.Elem().Set(reflect.MakeMap(mtype.ReplyType.Elem())) case reflect.Slice: replyv.Elem().Set(reflect.MakeSlice(mtype.ReplyType.Elem(), 0, 0)) } return svc.call(mtype, req, argv, replyv) } æ”¯æŒHTTPè°ƒç”¨ # å·²ç»å®Œæˆäº†ä¸Šè¿°çš„éƒ¨åˆ†ï¼Œå†æ¥è°ˆæ”¯æŒHTTPå°±éå¸¸ç®€å•äº†ã€‚å®ç°http.Handleræ¥å£å°±è¡Œå•¦ï½ã€‚å¦‚ä¸‹ï¼š\n// æ”¯æŒä¹‹POST \u0026amp; json func (s *Server) ServeHTTP(w http.ResponseWriter, r *http.Request) { var resp *Response w.Header().Set(\u0026#34;Content-Type\u0026#34;, \u0026#34;application/json\u0026#34;) if r.Method != http.MethodPost { resp = NewResponse(\u0026#34;\u0026#34;, nil, NewJsonrpcErr( http.StatusMethodNotAllowed, \u0026#34;HTTP request method must be POST\u0026#34;, nil), ) response(w, resp) return } // è§£æè¯·æ±‚å‚æ•°åˆ°[]*rpc.Request reqs, err := getRequestFromBody(r) if err != nil { resp = NewResponse(\u0026#34;\u0026#34;, nil, NewJsonrpcErr(InternalErr, err.Error(), nil)) response(w, resp) return } // å¤„ç†è¯·æ±‚ï¼ŒåŒ…æ‹¬æ‰¹é‡è¯·æ±‚ resps := s.handleWithRequests(reqs) if len(resps) \u0026gt; 1 { response(w, resps) } else { response(w, resps[0]) } return } ä½¿ç”¨ç¤ºä¾‹ # æœåŠ¡ç«¯ä½¿ç”¨ # // test_server.go package main import ( // \u0026#34;fmt\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;github.com/yeqown/rpc\u0026#34; ) type Int int type Args struct { A int `json:\u0026#34;a\u0026#34;` B int `json:\u0026#34;b\u0026#34;` } func (i *Int) Sum(args *Args, reply *int) error { *reply = args.A + args.B return nil } type MultyArgs struct { A *Args `json:\u0026#34;aa\u0026#34;` B *Args `json:\u0026#34;bb\u0026#34;` } type MultyReply struct { A int `json:\u0026#34;aa\u0026#34;` B int `json:\u0026#34;bb\u0026#34;` } func (i *Int) Multy(args *MultyArgs, reply *MultyReply) error { reply.A = (args.A.A * args.A.B) reply.B = (args.B.A * args.B.B) return nil } func main() { s := rpc.NewServer() mine_int := new(Int) s.Register(mine_int) go s.HandleTCP(\u0026#34;127.0.0.1:9999\u0026#34;) // å¼€å¯http http.ListenAndServe(\u0026#34;:9998\u0026#34;, s) } å®¢æˆ·ç«¯ä½¿ç”¨ # // test_client.go package main import ( \u0026#34;github.com/yeqown/rpc\u0026#34; ) type Args struct { A int `json:\u0026#34;a\u0026#34;` B int `json:\u0026#34;b\u0026#34;` } type MultyArgs struct { A *Args `json:\u0026#34;aa\u0026#34;` B *Args `json:\u0026#34;bb\u0026#34;` } type MultyReply struct { A int `json:\u0026#34;aa\u0026#34;` B int `json:\u0026#34;bb\u0026#34;` } func main() { c := rpc.NewClient() c.DialTCP(\u0026#34;127.0.0.1:9999\u0026#34;) var sum int c.Call(\u0026#34;1\u0026#34;, \u0026#34;Int.Sum\u0026#34;, \u0026amp;Args{A: 1, B: 2}, \u0026amp;sum) println(sum) c.DialTCP(\u0026#34;127.0.0.1:9999\u0026#34;) var reply MultyReply c.Call(\u0026#34;2\u0026#34;, \u0026#34;Int.Multy\u0026#34;, \u0026amp;MultyArgs{A: \u0026amp;Args{1, 2}, B: \u0026amp;Args{3, 4}}, \u0026amp;reply) println(reply.A, reply.B) } è¿è¡Œæˆªå›¾ # å®ç° # ä¸Šé¢åªæŒ‘äº†æˆ‘è§‰å¾—æ¯”è¾ƒé‡è¦çš„éƒ¨åˆ†ï¼Œè®²äº†å®ç°ï¼Œæ›´å¤šå¦‚å®¢æˆ·ç«¯çš„æ”¯æŒï¼ŒJSON-RPCçš„è¯·æ±‚å“åº”å®šä¹‰ï¼Œå¯ä»¥åœ¨é¡¹ç›®ä¸­é‡ŒæŸ¥é˜…ã€‚ç›®å‰åŸºäºTCPå’ŒHTTPå®ç°äº†JSON-RPCï¼Œé¡¹ç›®åœ°å€ï¼šgithub.com/yeqown/rpc\nç¼ºé™· # åªæ”¯æŒJSON-RPC, ä¸”è¿˜æ²¡æœ‰å®Œå…¨å®ç°JSON-RPCçš„çº¦å®šã€‚è­¬å¦‚æ‰¹é‡è°ƒç”¨ä¸­ï¼š\nè‹¥æ‰¹é‡è°ƒç”¨çš„ RPC æ“ä½œæœ¬èº«éä¸€ä¸ªæœ‰æ•ˆ JSON æˆ–ä¸€ä¸ªè‡³å°‘åŒ…å«ä¸€ä¸ªå€¼çš„æ•°ç»„ï¼Œåˆ™æœåŠ¡ç«¯è¿”å›çš„å°†å•å•æ˜¯ä¸€ä¸ªå“åº”å¯¹è±¡è€Œéæ•°ç»„ã€‚è‹¥æ‰¹é‡è°ƒç”¨æ²¡æœ‰éœ€è¦è¿”å›çš„å“åº”å¯¹è±¡ï¼Œåˆ™æœåŠ¡ç«¯ä¸éœ€è¦è¿”å›ä»»ä½•ç»“æœä¸”å¿…é¡»ä¸èƒ½è¿”å›ä¸€ä¸ªç©ºæ•°ç»„ç»™å®¢æˆ·ç«¯ã€‚\né˜…è¯»å‚è€ƒä¸­çš„ä¸¤ä¸ªRPCï¼Œå‘ç°ä¸¤è€…éƒ½æ˜¯ä½¿ç”¨çš„codecçš„æ–¹å¼æ¥æä¾›æ‰©å±•ã€‚å› æ­¤ä»¥åå¯ä»¥è€ƒè™‘ä½¿ç”¨è¿™ç§æ–¹å¼æ¥æ‰©å±•ã€‚\nå‚è€ƒ # net/rpc grollia/rpc "},{"id":51,"href":"/2018/05/18/%E8%87%AA%E5%B7%B1%E5%86%99%E4%B8%80%E4%B8%AA%E6%89%8B%E6%9C%BA%E8%8F%9C%E8%B0%B1APP/","title":"è‡ªå·±å†™ä¸€ä¸ªæ‰‹æœºèœè°±APP","section":"Posts","content":"éœ€è¦çš„æŠ€æœ¯åŠå·¥å…·ï¼š\nPython3 + Selenuium Golang net/http React-Native ç›¸å…³ï¼ˆä½¿ç”¨äº†react-navigationï¼‰ MongoDB Redis ä»£ç åœ°å€ï¼š\ngithub.com/yeqown/recipe é¡¹ç›®æ„æ€åŠæ„æˆ # é£Ÿè°±ç±»å‹çš„Appï¼Œåº”ç”¨å¸‚åœºè‚¯å®šæœ‰æ›´å¥½çš„çš„é£Ÿè°±APPã€‚æ‰€ä»¥è‡ªå·±å¼€å‘çš„ç›®çš„ï¼Œé¦–å…ˆæ˜¯å†™ä»£ç ï¼Œå…¶æ¬¡æ˜¯å®šåˆ¶APPï½ å¥½çš„ï¼Œç°åœ¨åŒ–èº«äº§å“ç»ç†ï¼Œè®¾è®¡ä¸€ä¸‹APPæœ‰å“ªäº›åŠŸèƒ½ï¼š\næ¯æ—¥èœè°±æ¨èï¼Œæ¨èå¯æ›´æ¢ æ¯å¤©éœ€è¦å‡†å¤‡çš„ææ–™æé†’ å‘ç°æ›´å¤šèœè°± åˆ†ç±»ç­›é€‰èœè°± æœç´¢èœè°± æŸ¥çœ‹èœè°±è¯¦æƒ… è®¾ç½®ï¼ˆä¸çŸ¥é“è®¾ç½®å•¥ï¼Œæå‰å‡†å¤‡å§ï¼‰ è®¾è®¡ç¨¿ï¼Ÿä¸å­˜åœ¨çš„ï¼Œéšå¿ƒæ‰€æ¬²ã€‚\nç°åœ¨åˆ†æä¸‹æˆ‘éœ€è¦åšçš„äº‹æƒ…ï¼š\nèƒ½è·‘èµ·æ¥çš„APPï¼Œä¸restful web api äº¤äº’ã€‚ èƒ½è·‘èµ·æ¥çš„web-apiï¼Œæä¾›èœè°±æ•°æ®ï¼Œç­›é€‰ï¼Œæ¨èï¼Œæœç´¢ç­‰åŠŸèƒ½ èƒ½è·‘èµ·æ¥çš„ç®€æ˜“spiderï¼Œä»ç½‘ä¸Šè·å–èœè°±ä¿¡æ¯ã€‚ï¼ˆè¿™ä¸ªçˆ¬è™«èƒ½è§£æåŠ¨æ€ç”Ÿæˆç½‘ç«™å°±å¤Ÿç”¨äº†ï¼Œå§‘ä¸”ç§°ä¹‹ä¸ºçˆ¬è™«å§ï¼‰ æ²¡æœ‰è€ƒè™‘å¤§é‡æ•°æ®ï¼Œå› æ­¤çˆ¬è™«å¹¶ä¸é€šç”¨ï¼Œåªé€‚åˆç‰¹å®šXXç½‘ç«™ã€‚\nå®æˆ˜çˆ¬è™« # è¿™ä¸ªAPPé‡Œé¢æœ€é‡è¦çš„å°±æ˜¯èœè°±æ•°æ®äº†ï¼Œé‚£ä¹ˆå¼€å‘ä¹‹å‰ï¼Œéœ€è¦æ˜ç¡®çš„æ•°æ®æ ¼å¼ï¼Œå¦‚ä¸‹ï¼š\n{ \u0026#34;name\u0026#34;: \u0026#34;name\u0026#34;, \u0026#34;cat\u0026#34;: \u0026#34;cat\u0026#34;, \u0026#34;img\u0026#34;: \u0026#34;img_url\u0026#34;, \u0026#34;mark_cnt\u0026#34;: 19101, \u0026#34;view_cnt\u0026#34;: 181891, \u0026#34;setps\u0026#34;: [ { \u0026#34;desc\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;img\u0026#34;: \u0026#34;\u0026#34;, }, // more step ], \u0026#34;material\u0026#34;: { \u0026#34;ingredients\u0026#34;: [ { \u0026#34;name\u0026#34;: \u0026#34;ingredients_name\u0026#34;, \u0026#34;weight\u0026#34;: \u0026#34;ingredients_weight\u0026#34;, }, // more ingredients ], \u0026#34;seasoning\u0026#34;: [ { \u0026#34;name\u0026#34;: \u0026#34;seasoning_name\u0026#34;, \u0026#34;weight\u0026#34;: \u0026#34;seasoning_weight\u0026#34;, }, // more seasoning ], }, \u0026#34;create_time\u0026#34;: \u0026#34;2018xxxxxx\u0026#34;, \u0026#34;update_time\u0026#34;: \u0026#34;2018xxxxxx\u0026#34;, } ç›®æ ‡ # å‰æï¼šæ— æ³•ç›´æ¥è·å–åˆ°è¯¥ç½‘ç«™çš„æœåŠ¡APIï¼Œæ‰ä½¿ç”¨çˆ¬è™«é—´æ¥è·å–æ•°æ®ã€‚\nç›®æ ‡æ˜¯æŸä¸ªç½‘ç«™çš„èœè°±ï¼Œç½‘é¡µå±‚æ¬¡å’Œç»“æ„æ¯”è¾ƒæ˜ç¡®ï¼Œä¿¡æ¯ä¹Ÿæ­£å¥½ã€‚ç»“åˆéœ€è¦çš„æ•°æ®é‡çº§å’Œä¿¡æ¯ï¼Œå› æ­¤çˆ¬è™«éµå¾ªäº†ä»¥ä¸‹æµç¨‹ï¼š\nstep1. è·å–ç‰¹å®šåˆ†ç±»çš„å…¥å£ç½‘å€ step2. ä»åˆ†ç±»çš„å…¥å£ç½‘å€è·å–è¯¥åˆ†ç±»çš„çš„æ‰€æœ‰èœè°±è¯¦æƒ…ç½‘å€ step3. ä»å•ä¸ªèœè°±è¯¦æƒ…ç½‘å€ä¸­è§£æèœè°±æ•°æ®ã€‚ ä½¿ç”¨äº†redisä½œä¸ºçˆ¬è™«é—´çš„æ•°æ®é€šé“ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ–¹ä¾¿å¼€å¤šä¸ªè¿›ç¨‹çˆ¬å–ã€‚\né—®é¢˜ # ç¿»é¡µå’Œåˆ¤å®šå½“å‰é¡µä¸ºæœ€åä¸€é¡µ # æè¿°ï¼šæŸäº›åˆ†ç±»ä¸‹ä¸æ­¢ä¸€é¡µæ•°æ®ï¼Œå¦‚ä½•è¿›è¡Œç¿»é¡µå’Œä¸‹ä¸€é¡µçš„åˆ¤å®šã€‚ åŸå› ï¼šæ—  è§£å†³ï¼šç‚¹å‡»ç¿»é¡µæŒ‰é’®ï¼Œè§‚å¯Ÿurlçš„å˜åŒ–ï¼ˆ30 * (page-1)ï¼‰ï¼›ç›´æ¥è·³è½¬åˆ°æœ€åä¸€é¡µï¼Œè§‚å¯Ÿé¡µé¢ç‰¹å¾ï¼ˆæ— â€œä¸‹ä¸€é¡µâ€æŒ‰é’®ï¼‰ çˆ¬å–åŠ¨æ€é¡µé¢ # æè¿°ï¼šèœè°±è¯¦æƒ…é¡µé¢æ˜¯åŠ¨æ€ç”Ÿæˆçš„ï¼Œæ— æ³•ç›´æ¥ä½¿ç”¨bs4 + requestsæ¥çˆ¬å–ã€‚ åŸå› ï¼šæ—  è§£å†³ï¼šæŸ¥çœ‹äº†requestsè·å–åˆ°çš„é¡µé¢ç»“æ„ï¼Œå‘ç°åœ¨scriptæ ‡ç­¾ä¸­ï¼Œæœ‰éœ€è¦çš„æ•°æ®ï¼Œä½†æ˜¯éœ€è¦é¢å¤–å¤„ç†ï¼Œè€Œä¸”æŸäº›æ•°æ®ä¿¡æ¯ç¼ºå¤±ã€‚å› æ­¤ å¼€å§‹è€ƒè™‘seleniumæ¥åŠ è½½é¡µé¢ï¼Œè§£æèœè°±ä¿¡æ¯ã€‚ å®æˆ˜æ‰‹æœºApp # ä¸ºäº†æ–¹ä¾¿é«˜æ•ˆï¼Œæ²¡æœ‰é€‰ç”¨åŸç”Ÿçš„çš„å¼€å‘æ–¹å¼ï¼Œè€Œæ˜¯é€‰æ‹©äº†React-Nativeæ¥æ’¸Appã€‚Appä¸»è¦è¿è¡ŒäºAndroidï¼Œå¾ç­‰åŠä¸ç”¨ä¸èµ·iPhoneï¼‰ã€‚\nè¿è¡Œæˆªå›¾ # é—®é¢˜ # æ€ä¹ˆç”¨React-Nativeæ¥æ’¸ä¸€ä¸ªAppçš„æ­¥éª¤ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚ä¸»è¦è®°å½•ä¸€ä¸‹è¿™æœŸé—´é‡åˆ°çš„é—®é¢˜ï¼š\né—®é¢˜ä¸€ï¼šæ— æ³•è®¿é—®æœ¬åœ°çš„APIæœåŠ¡ # æè¿°ï¼šå¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°äº†ä½¿ç”¨`fetch\\axios`å‡æ— æ³•è®¿é—®`localhost`apiæœåŠ¡çš„é—®é¢˜ï¼Œé”™è¯¯æç¤ºâ€œnetwork request failedâ€ï¼Œæœ¬åœ°çš„apiæœåŠ¡ä¹Ÿç¡®å®æ²¡æœ‰æ¥æ”¶åˆ°ä»»ä½•è¯·æ±‚ã€‚ä½†æ˜¯å°è¯•è®¿é—®å…¶ä»–åŸŸåapiå´å¯ä»¥æ­£å¸¸ã€‚ åŸå› ï¼šReact-NativeæŠŠè‡ªå·±å½“æˆäº†localhostï¼Œå› æ­¤localhostå¹¶æ²¡æœ‰è¯·æ±‚çš„åˆ°çœŸçš„apiæœåŠ¡ã€‚ è§£å†³ï¼šå°†localhostæ›¿æ¢ä¸º`10.0.2.2`ä¾¿å®šå‘åˆ°äº†æœ¬åœ°ã€‚ é—®é¢˜äºŒï¼šTabNavigatoræ— æ³•ä½¿ç”¨icon # æè¿°ï¼šæ ¹æ®å®˜æ–¹æ–‡æ¡£æ¥è®¾ç½®Iconï¼Œä¸€ç›´æŠ¥é”™ï¼ŒIconä¹Ÿçœ‹ä¸è§ã€‚ åŸå› ï¼šä¸æ™“å¾—ã€‚ è§£å†³ï¼šåœ¨TabNavigatoræ³¨å†Œçš„å„ä¸ªScreenä¸­æŒ‡å®šã€‚ TabNavigatorå®šä¹‰å‚è§ï¼šhttps://github.com/yeqown/recipe/blob/master/recipes-mobile/index.js#L18 æŒ‡å®šä»£ç ï¼šhttps://github.com/yeqown/recipe/blob/master/recipes-mobile/src/Home.js#L34\nå®æˆ˜web-api # ä»£ç ç”±æ­¤å»\nè¿™ä¸€éƒ¨åˆ†æ²¡æœ‰å•¥ç‰¹åˆ«çš„åœ°æ–¹ï¼Œå°±ç•¥è¿‡äº†ã€‚åœ¨è¿™é‡Œæ¨é”€ä¸€ä¸‹: github.com/yeqown/gwebä¸€ä¸ªç®€æ˜“å°è£…çš„golang web æ¡†æ¶ã€‚\n"},{"id":52,"href":"/2018/05/03/docker-jenkins-golang%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E5%AE%9E%E8%B7%B5/","title":"docker+jenkins+golangæŒç»­é›†æˆå®è·µ","section":"Posts","content":" èµ·å›  # å› ä¸ºç”Ÿäº§éœ€è¦æœ€è¿‘åˆé‡æ–°æŠ˜è…¾äº†ä¸€ä¸‹Jenkinså’Œdockerã€‚ä¸»è¦ç›®çš„æ˜¯æƒ³è‡ªåŠ¨ç¼–è¯‘ï¼Œæ‰“åŒ…ï¼Œéƒ¨ç½²ä¸€äº›Golangçš„HttpServerã€‚äºæ˜¯å†³å®šä½¿ç”¨Jenkinsæ¥åšè¿™ä¸ªæŒç»­é›†æˆçš„è½½ä½“ï¼Œé€‰æ‹©Jenkinså‡ºäºä¸¤ç‚¹åŸå› ï¼š\n1. ä»¥å‰å°±ä½¿ç”¨è¿‡ï¼Œä¸Šæ‰‹ä¼šæ›´å¿« 2. ç¤¾åŒºæ¯”è¾ƒæˆç†Ÿï¼Œæ’ä»¶å’Œæ–‡æ¡£ä¸°å¯Œ\nå®‰è£…Dockerå’ŒPull Jenkinsé•œåƒ # è¿™ä¸€æ­¥ï¼Œä½œä¸ºå‰ç½®æ¡ä»¶ä¸”ä¸æ˜¯æœ¬æ–‡ä¸»è¦è¦æè¿°çš„æ­¥éª¤ï¼Œå› æ­¤ç•¥å»ã€‚ç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šå‚è€ƒèµ„æ–™ï½\nJenkins \u0026amp; docker-composeé…ç½® # ä¸ºäº†æ–¹ä¾¿æˆ‘æ‰ç”¨äº†docker-composeè¿™ä¸ªå·¥å…·ï¼Œdocker-compose åŸºç¡€å¯ä»¥å‚è§æˆ‘çš„docker-composeä¸Šæ‰‹ã€‚è¿™é‡Œç›´æ¥ä¸Šé…ç½®ï¼š\nversion: \u0026#39;2\u0026#39; services: jenkins: container_name: jenkins-lts ports: - 9001:8080 - 50000:50000 image: jenkins/jenkins:lts volumes: - /home/worker/jenkins/jenkins_home:/var/jenkins_home é…ç½®ä¹Ÿæ˜¯å®˜æ–¹çš„ç¤ºä¾‹é…ç½®ã€‚\nNote: å°†å®¿ä¸»æœºçš„/home/worker/jenkins/jenkins_homeæŒ‚è½½ä¸ºå®¹å™¨çš„/var/jenkins_homeç›®å½•ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ï¼Œå¦‚æœå®¹å™¨è¢«ä¸å°å¿ƒåˆ é™¤ä¹Ÿä¸è‡³äºJenkinsçš„æ•°æ®ä¸¢å¤±ã€‚\nåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬åªéœ€è¦æ‰§è¡Œdocker-compose up -dä¾¿å¯ä»¥å°†Jenkinså®¹å™¨è·‘èµ·æ¥äº†ï¼Œå†é…ç½®ä¸€ä¸‹Nginxï¼Œä¾¿å¯ä»¥ç›´æ¥è®¿é—®åˆ°Jenkinsé¡µé¢äº†ï¼Œå¹¶è¿›è¡Œåˆå§‹åŒ–ã€‚\næˆ‘çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š\nâœ jenkins ll total 8.0K -rw-rw-r-- 1 worker worker 220 May 2 17:19 docker-compose.yml drwxrwxr-x 19 worker worker 4.0K May 3 15:53 jenkins_home âœ jenkins pwd /home/worker/jenkins âœ jenkins docker-compose up -d # è¿è¡Œ Publish Over SSHé…ç½® # Publish Over SSHé…ç½®ï¼Œç”±äºæˆ‘ä»¬æ˜¯é€šè¿‡dockerè¿è¡Œçš„Jenkinsï¼Œå› æ­¤è¦ç‰¹åˆ«é…ç½®ä¸€ä¸‹SSHï¼Œæ–¹ä¾¿Jenkinséƒ¨ç½²é¡¹ç›®ã€‚è¿™é‡Œå…ˆåˆ—å‡ºæ­¥éª¤ï¼š\nå®‰è£…Publish Over SSH å®¹å™¨å†…ssh-keygen é…ç½®Publish Over SSH é…ç½®Gitä»“åº“éƒ¨ç½²å…¬é’¥ #è¿™ä¸€æ­¥ç›¸å½“äºæ‹‰å–ä»£ç çš„Credentials Golang Build-env # å› ä¸ºé»˜è®¤çš„Jenkinsé•œåƒæ˜¯ä¸å¸¦æœ‰Goçš„ç¼–è¯‘å·¥å…·çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾ˆæœ‰å¿…è¦å®‰è£…ä¸€ä¸ªGoæ’ä»¶Go-Plugin-Jenkins å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š\nå®‰è£…JenkinsGoæ’ä»¶ åœ¨å…¨å±€å·¥å…·é…ç½®ä¸­ï¼Œå®‰è£…Go åœ¨å¯¹åº”ä»»åŠ¡é…ç½®-\u0026gt; æ„å»ºç¯å¢ƒé¡¹ï¼Œé€‰æ‹©Goç‰ˆæœ¬ è¿™ä¸€æ­¥çš„è¯¦ç»†æ­¥éª¤å¯ä»¥åœ¨å‚è€ƒæ–‡çŒ®ç¬¬ä¸€æ¡ä¸­æŸ¥è¯¢Setup Go Build Environment\nNote: å®˜æ–¹æ–‡æ¡£ä¸­è¯´å…¨å±€é…ç½®Goæ˜¯åœ¨ç³»ç»Ÿè®¾ç½®ä¸­è¿›è¡Œçš„ï¼Œä½†æ˜¯æˆ‘ç”¨çš„Jenkins ver. 2.107.2ï¼Œè¿™ä¸€é¡¹é…ç½®æ˜¯åœ¨å…¨å±€å·¥å…·é…ç½®ä¸­ã€‚\nå¦‚ä½•æ‰“åŒ…éƒ¨ç½² # ç¼–å†™ä¸€ä¸ªmakefileæ¥æ‰“åŒ…é¡¹ç›®ï¼Œé€šè¿‡scpæ¥åˆ†å‘éƒ¨ç½²æœåŠ¡ï¼Œè¿™ä¹Ÿæ˜¯é…ç½®Publish Over SSHçš„ç›®çš„ã€‚\nç”±äºJenkinsé•œåƒä¸å¸¦æœ‰makeç›¸å…³å·¥å…·ï¼ˆç”šè‡³Vimä¹Ÿæ²¡æœ‰ï¼‰ï¼Œæ‰€ä»¥éœ€è¦å®‰è£…MakeåŠå…¶ç›¸å…³å·¥å…·ã€‚ä¸æ­¤åŒæ—¶ï¼Œå¦‚æœé¡¹ç›®ä½¿ç”¨äº†ç›¸å…³çš„ä¾èµ–ç®¡ç†å·¥å…·ï¼Œå› æ­¤è¿˜æœ‰å¿…è¦å»é…ç½®ç›¸å…³çš„GOç¯å¢ƒå˜é‡ã€‚å…¶ä¸­Goçš„å®‰è£…è·¯å¾„åœ¨ï¼š /var/jenkins_home/tools/org.jenkinsci.plugins.golang.GolangInstallation/$GOVERSIONä¸­ã€‚\nè¿™é‡Œè´´ä¸Šæˆ‘çš„Makefile\n# To test, build, deploy offline-tasks # -: ignore this commnad error # @: no display current commnad to std output # Commnads declare GOCMD=go GOTEST=$(GOCMD) test GOBUILD=$(GOCMD) build # Params define MAIN_PATH=../main PACKAGE_PATH=../package PACKAGE_BIN_PATH=../package/bin BIN=offline-tasks FILENAME=offline-tasks.tar.gz # Deploy Params DEV_HOST=zy-dev DEV_TAR_PATH=/home/worker/project/offline-tasks PROD_HOST=zy-pro2 PROD_TAR_PATH=/home/worker/project/offline-tasks default: build pack test: # testing - $(GOTEST) ../... -v build: # building mkdir $(PACKAGE_PATH) mkdir $(PACKAGE_BIN_PATH) cd $(MAIN_PATH) \u0026amp;\u0026amp; $(GOBUILD) -o $(BIN) mv \u0026#34;$(MAIN_PATH)/$(BIN)\u0026#34; $(PACKAGE_BIN_PATH) cp -r \u0026#34;../configs\u0026#34; $(PACKAGE_PATH) cp \u0026#34;../sh/start.sh\u0026#34; $(PACKAGE_BIN_PATH) pack: # packing cd $(PACKAGE_PATH) \u0026amp;\u0026amp; tar -zcvf ../$(FILENAME) ./* mv ../$(FILENAME) $(PACKAGE_PATH) ################################################## # # # deploy: from zy-dev to execute # # deploy-dev: from dev-CI to execute # # deploy-prod: from prod-CI to execute # # # ################################################## deploy: clean build pack # deploy dev from dev cp $(PACKAGE_PATH)/$(FILENAME) $(DEV_TAR_PATH) cd $(DEV_TAR_PATH) \u0026amp;\u0026amp; tar zxvf $(FILENAME) \u0026amp;\u0026amp; supervisorctl -c configs/dev.supervisord.conf restart offline-tasks deploy-dev: clean build pack # deploy-dev from CI scp $(PACKAGE_PATH)/$(FILENAME) $(DEV_HOST):$(DEV_TAR_PATH) ssh $(DEV_HOST) \u0026#34;cd $(DEV_TAR_PATH) \u0026amp;\u0026amp; tar zxvf $(FILENAME) \u0026amp;\u0026amp; supervisorctl -c configs/dev.supervisord.conf restart offline-tasks\u0026#34; deploy-prod: clean build pack # deploying prod from dev or CI scp $(PACKAGE_PATH)/$(FILENAME) $(PROD_HOST):$(PROD_TAR_PATH) ssh $(PROD_HOST) \u0026#34;cd $(PROD_TAR_PATH) \u0026amp;\u0026amp; tar zxvf $(FILENAME) \u0026amp;\u0026amp; supervisorctl -c configs/prod.supervisord.conf restart offline-tasks\u0026#34; clean: # cleaning rm -fr $(PACKAGE_PATH) rm -fr ../$(FILENAME) æ€»ç»“ # è¿›è¿‡ä¸Šè¿°çš„ä¸€ç³»åˆ—æ“ä½œä¹‹åï¼Œåªå‰©ä¸‹ä¸€ä¸ªæ¯”è¾ƒå°´å°¬çš„é—®é¢˜äº†ï¼šå¦‚æœGoä»£ç ä»“åº“ä¸­vendorä¸å¸¦æœ‰ä¾èµ–é¡¹ç›®ï¼Œé‚£ä¹ˆè·å–ä¾èµ–çš„åŠ¨ä½œå°±è¦è‡ªå·±æ‰‹åŠ¨æ¥æ“ä½œäº†ï½ã€‚æˆ–è®¸å¯ä»¥åœ¨makefileä¸­æ–°å¢ä¸€ä¸ªdepsï¼Œå¦‚ä¸‹ï¼š\n# default set $CURDIR=\u0026#34;$PROJ_ROOT/sh\u0026#34; # preparing works... GVT_RESTORE=gvt restore PROJ_ROOT=../ deps: cd ($PROJ_ROOT) \u0026amp;\u0026amp; $(GVT_RESTORE) build: deps # building mkdir $(PACKAGE_PATH) mkdir $(PACKAGE_BIN_PATH) cd $(MAIN_PATH) \u0026amp;\u0026amp; $(GOBUILD) -o $(BIN) mv \u0026#34;$(MAIN_PATH)/$(BIN)\u0026#34; $(PACKAGE_BIN_PATH) cp -r \u0026#34;../configs\u0026#34; $(PACKAGE_PATH) cp \u0026#34;../sh/start.sh\u0026#34; $(PACKAGE_BIN_PATH) # other commands... å¹¶ä¸”åŠ depså‘½ä»¤ï¼ŒåŠ buildå‘½ä»¤ä¸­ï¼Œæ¯æ¬¡æ‰“åŒ…éƒ½æ£€æŸ¥ä¸€ä¸‹ä¾èµ–ã€‚\nå‚è€ƒèµ„æ–™ # https://zpjiang.me/2017/08/09/Setup-Jenkins-for-Go-Projects/ https://wiki.jenkins.io/display/JENKINS/Go+Plugin "},{"id":53,"href":"/2018/04/20/gorm%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/","title":"gormä½¿ç”¨è®°å½•","section":"Posts","content":" å…³äºGorm # gormæ–‡æ¡£\né‡è§é—®é¢˜ # æ— æ³•é€šè¿‡ç»“æ„ä½“çš„æ–¹å¼æ›´æ–°æˆ–æŸ¥è¯¢é›¶å€¼ # è¿™é‡Œé›¶å€¼æ˜¯è¯´ï¼Œå„ä¸ªç±»å‹çš„é»˜è®¤å€¼ã€‚ å…³äºè¿™ä¸€ç‚¹æ˜¯åœ¨è¿™é‡Œä¸­æ³¨æ˜äº†çš„ï¼Œä¹Ÿæä¾›äº†è§£å†³æ–¹æ¡ˆï¼š\nWARNING when update with struct, GORM will only update those fields that with non blank value\nFor below Update, nothing will be updated as \u0026ldquo;\u0026rdquo;, 0, false are blank values of their types\nNOTE When query with struct, GORM will only query with those fields has non-zero value, that means if your fieldâ€™s value is 0, \u0026lsquo;\u0026rsquo;, false or other zero values, it wonâ€™t be used to build query conditions,\nYou could consider to use pointer type or scanner/valuer to avoid this.\n// Use pointer value type User struct { gorm.Model Name string Age *int } // Use scanner/valuer type User struct { gorm.Model Name string Age sql.NullInt64 } åŒæ ·é€‚ç”¨å…¶ä»–å½¢å¼çš„æ•°æ®æ¥è¿›è¡Œæ›´æ–°ä¹Ÿæ˜¯å¯ä»¥ï¼Œå¦‚ï¼š\nupdateData := map[string]interface{}{ \u0026#34;age\u0026#34;: 0, \u0026#34;update_time\u0026#34;: time.Now(), } db.Model(\u0026amp;User{}).Update(updateData) åŒä¸€ä¸ªè¿æ¥æ— æ³•å¤šæ¬¡æŸ¥è¯¢ # åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°çš„æƒ…å†µè·Ÿhttps://github.com/jinzhu/gorm/issues/1574æè¿°ç±»ä¼¼ï¼Œä½†æ˜¯å›å¤ä¸­çš„è§£å†³åŠæ³•å¹¶ä¸èƒ½å¸®æˆ‘è§£å†³é—®é¢˜ã€‚\næˆ‘çš„ä»£ç å¦‚ä¸‹ï¼š\n// mysql.go var myDB *gorm.DB func GetMyDB() *gorm.DB { return myDB } func ConnMysql() { //... db, err := gorm.Open(...) //... myDB = db } ä½¿ç”¨\n// models/user.go type User struct { Name string `gorm:\u0026#34;column:name\u0026#34;` Age int `gorm:\u0026#34;column:age\u0026#34;` //... } type UserColl struct { *gorm.DB } func NewUserColl() *UserColl{ return \u0026amp;UserColl{ DB: GetMyDB().Model(\u0026amp;User{}) } } func FindUserWithName(name string) (error, *User) { uc := NewUserColl() u := new(User) if err := uc.Where(\u0026#34;name = ?\u0026#34;, name).First(u).Error; err != nil { return err, nil } return nil, u } // æ— æ³•æ­£å¸¸ä½¿ç”¨çš„å‡½æ•° func FindUsersWithNames(names []string) (map[string]error, []*User) { uc := NewUserColl() us := make([]*User, len(names)) errs := map[string]error{} for _, name := range names { u := new(User) if err := uc.Where(\u0026#34;name = ?\u0026#34;, name).First(u).Error; err != nil { map[name] = err continue } us = append(us, u) } return errs, us } ä¸Šè¿°çš„FindUsersWithNamesåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­,å¤šä¸ªæŸ¥è¯¢åªæœ‰ç¬¬ä¸€ä¸ªæŸ¥è¯¢æ˜¯æ­£å¸¸çš„ï¼Œå…¶ä»–çš„ä¼šæŠ¥é”™ï¼šâ€œrecord not foundâ€ï¼Œä½†å…¶å®æ•°æ®æ˜¯å­˜åœ¨çš„ã€‚\nè¿›è¿‡æ£€ç´¢æˆ‘å‘ç°äº†ï¼Œåœ¨gormå®ç°ä¸­ï¼Œdbæ˜¯å¤ç”¨çš„ï¼Œå› æ­¤å¤šæ¬¡æŸ¥è¯¢ä¼šåœ¨å·²ç»å­˜åœ¨çš„ç»“æœä¸­æŸ¥è¯¢ï¼Œé‚£ä¹ˆæ‰¾ä¸åˆ°å°±èƒ½è§£é‡Šäº†ã€‚é‚£ä¹ˆå¦‚ä½•è§£å†³å‘¢ï¼Ÿissue#1574ä¸­æåˆ°äº†é‡æ–°ç”³è¯·ä¸€ä¸ªconnectionèƒ½è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å› æ­¤æˆ‘å°è¯•äº†ä¸€ä¸‹æ›´æ”¹ï¼š\n// æ›´æ”¹1 - æ— æ•ˆ func FindUsersWithNames(names []string) (map[string]error, []*User) { us := make([]*User, len(names)) errs := map[string]error{} for _, name := range names { uc := NewUserColl().New() // æ¯æ¬¡loopéƒ½è°ƒç”¨ä¸€æ¬¡`New` u := new(User) if err := uc.Where(\u0026#34;name = ?\u0026#34;, name).First(u).Error; err != nil { map[name] = err continue } us = append(us, u) } return errs, us } // æ›´æ”¹2 - æ— æ•ˆ func FindUsersWithNames(names []string) (map[string]error, []*User) { us := make([]*User, len(names)) errs := map[string]error{} for _, name := range names { ConnMysql() // æ¯æ¬¡loopéƒ½é‡æ–°è¿æ¥ä¸€æ¬¡æ•°æ®åº“ uc := NewUserColl() u := new(User) if err := uc.Where(\u0026#34;name = ?\u0026#34;, name).First(u).Error; err != nil { map[name] = err continue } us = append(us, u) } return errs, us } // æ›´æ”¹3 å¯ç”¨ func FindUsersWithNames(names []string) (map[string]error, []*User) { us := make([]*User, len(names)) errs := map[string]error{} for _, name := range names { err, u := FindUserWithName(name) // è°ƒç”¨ä¸€æ¬¡å‡½æ•° if err != nil { errs[name] = err continue } us = append(us, u) } return errs, us } ç»è¿‡ä»¥ä¸Šå°è¯•ï¼Œæ‰¾åˆ°äº†ä¸€ä¸ªè§£å†³åŠæ³•ã€‚\nåè¨€ # ä½†æ˜¯é—®é¢˜å¹¶ä¸æ˜¯åˆ°æ­¤ä¸ºæ­¢ï¼Œä¸ºä»€ä¹ˆè°ƒç”¨ä¸€å±‚å‡½æ•°ï¼Œå°±å¯ä»¥è§£å†³ï¼Œè€Œgorm.DB.Newå´ä¸è¡Œå‘¢ï¼Ÿå¤§èƒ†åˆ†æä¸€ä¸‹ï¼šä¸Šè¿°çš„ä¸‰ç§å°è¯•çš„åŒºåˆ«åœ¨äºï¼Œucåœ¨ç¬¬ä¸‰ç§æ–¹å¼ä¸­ï¼Œæ¯æ¬¡å¾ªç¯éƒ½æ˜¯ä¸€ä¸ªå…¨æ–°çš„å˜é‡ï¼Œè€Œä¸æ˜¯é‡æ–°èµ‹å€¼ï¼Œä½†è¿™ä¾ç„¶ä¸èƒ½è§£é‡Šä¸ºä»€ä¹ˆNewä¸èƒ½è§£å†³ä¸Šè¿°é—®é¢˜ã€‚å…·ä½“çš„åŸå› åç»­ç ”ç©¶åè¡¥ä¸Šã€‚\n"},{"id":54,"href":"/2018/04/17/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84%E5%85%A5%E9%97%A8/","title":"åˆ†å¸ƒå¼æ¶æ„å…¥é—¨","section":"Posts","content":"åœ¨å¼€å§‹ä¹‹å‰å¿…é¡»æ˜ç¡®çš„æ˜¯ï¼Œåˆ†å¸ƒå¼å’Œé›†ç¾¤çš„åŒºåˆ«ï¼Œç®€å•çš„è¯´ï¼š\n1.åˆ†å¸ƒå¼æ˜¯ä¸€ç§å·¥ä½œæ–¹å¼ï¼ŒæŠŠä¸€ä¸ªç³»ç»Ÿçš„ä¸åŒåŠŸèƒ½æ”¾åœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼› 2.é›†ç¾¤æ˜¯ä¸€ç§ç‰©ç†å½¢æ€ï¼ŒåŒä¸€ä¸ªä»»åŠ¡æ”¾åœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼› è¿™æ ·è¯´ï¼Œä¹Ÿå¹¶ä¸æ˜¯è¯´è¿™ä¸¤ä¸ªæ¦‚å¿µæ˜¯å®Œå…¨ä¸åŒï¼Œè¿˜äº’ç›¸ç‹¬ç«‹ï¼Œè€Œæ˜¯å®é™…åº”ç”¨ä¸­ç›¸è¾…ç›¸æˆã€‚ æˆ‘ä»¬å¸¸è¯´çš„è´Ÿè½½å‡è¡¡çš„èƒŒåå°±æ˜¯é›†ç¾¤éƒ¨ç½²ï¼ŒæŸäº›å…¬å¸ä¸ºäº†èƒ½æ‰›ä½çªç„¶å¢é•¿çš„æµé‡ï¼Œä¼šé‡‡ç”¨åŠ å¾ˆå¤šå°æœåŠ¡å™¨çš„æ–¹å¼æ¥æé«˜æ€§èƒ½ã€‚çœ‹ä¸‹å›¾ï¼š å¯¹äºå°å…¬å¸æ¥è¯´ï¼Œè¿™æ ·éƒ¨ç½²çš„æ–¹å¼åœ¨äºï¼šç®€å•å¿«é€Ÿï¼Œæˆæœ¬åœ¨å¯æ¥å—èŒƒå›´ã€‚ï¼ˆå¦‚æœæ„¿æ„å¤šèŠ±ç‚¹æ—¶é—´è¿›è¡Œä»£ç é‡æ„å’ŒæŠ€æœ¯å†é€‰å‹æˆ–è®¸æ•ˆæœä¼šæ›´å¥½ï¼Œå½“ç„¶ä¼°è®¡è¦æ¢ä¸ªä¸æ‡‚æŠ€æœ¯çš„è€æ¿ï¼Œç„¶åå¿½æ‚ ä»–ğŸ˜Šï¼‰\nä½†æ˜¯ä¹Ÿä¸æ˜¯æ²¡æœ‰éšæ‚£ï¼Œä¸€æ–¹é¢ï¼Œé›†ç¾¤éƒ¨ç½²è™½ç„¶èƒ½æé«˜ç³»ç»Ÿçš„å¯ç”¨æ€§ï¼Œä½†æ˜¯å¦‚æœå¤šå°æœºå™¨ç¦»çº¿ï¼Œä¼šå¯¼è‡´å…¶ä»–æœºå™¨å‹åŠ›å¢å¤§ï¼Œå¦‚æœä¸¥é‡è¶…è¿‡æœºå™¨è´Ÿè½½èƒ½åŠ›ï¼Œä¼šå¯¼è‡´è¶Šæ¥è¶Šå¤šçš„æœºå™¨ç¦»çº¿ï¼Œä¸€æ—¦è§£å†³ä¸åŠæ—¶ä¾¿ä¼šå¯¼è‡´æ•´ä¸ªåº”ç”¨å´©æºƒã€‚å…¶æ¬¡ï¼Œé›†ç¾¤éƒ¨ç½²ä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œä¸€èˆ¬å¤šé‡‡ç”¨ç›¸åŒæ•°æ®æºï¼Œå› æ­¤é›†ç¾¤å¹¶ä¸èƒ½æ— é™åˆ¶æ‰©å¼ ã€‚\nåˆ†å¸ƒå¼ç³»ç»Ÿçš„åº”ç”¨åœºæ™¯ # åˆ†å¸ƒå¼ä¸»è¦è§£å†³çš„é—®é¢˜æ˜¯æå‡åº”ç”¨çš„è´Ÿè½½èƒ½åŠ›ã€‚\nåˆ†å¸ƒå¼çš„ä¼˜ç¼ºç‚¹ # å°†ä¸€ä¸ªç³»ç»Ÿçš„ä¸åŒæ¨¡å—åˆ†åˆ«éƒ¨ç½²åœ¨ä¸åŒçš„æœºå™¨ä¸Šã€‚è¿™é‡Œä¸å¾—ä¸è¯´åˆ°å¾®æœåŠ¡ï¼Œå¾®æœåŠ¡æ˜¯æŠŠç³»ç»ŸæœåŠ¡æ‹†åˆ†æˆä¸ºç‹¬ç«‹çš„æœåŠ¡æ¥éƒ¨ç½²ï¼ˆè¿™é‡Œè¯´çš„ç‹¬ç«‹ï¼Œæ˜¯æ•°æ®ç‹¬ç«‹å’Œéƒ¨ç½²ç‹¬ç«‹ï¼Œä¸ä¾èµ–äºå…¶ä»–æœåŠ¡ï¼‰ã€‚\nä»æœ¬è´¨ä¸Šæ¥è¯´å¾®æœåŠ¡ä¹Ÿæ˜¯åˆ†å¸ƒå¼éƒ¨ç½²çš„ä¸€ç§ã€‚åªæ˜¯ç›¸æ¯”ä¸€èˆ¬åˆ†å¸ƒå¼åº”ç”¨ï¼Œæ‹†åˆ†æ›´åŠ å½»åº•ã€‚\nä¼˜ç‚¹ # åˆ†æˆå¤šä¸ªæ¨¡å—ï¼Œå¹¶ä½¿ç”¨æ¥å£é€šä¿¡ï¼Œä½è€¦åˆï¼› å›¢é˜Ÿåä½œå¼€å‘ï¼Œäº‹å…ˆçº¦å®šå¥½æ¥å£ï¼Œç‹¬ç«‹å¼€å‘ï¼Œæ•ˆç‡æ›´é«˜ï¼› éƒ¨ç½²æ›´åŠ çµæ´»ï¼› ç¼ºç‚¹ # ä¾èµ–ç½‘ç»œé€šä¿¡ï¼Œå¢åŠ é¢å¤–å¼€å‘é€šä¿¡æ¥å£ã€‚ æ€»ç»“ # ä»¥ä¸Šè¯´çš„éƒ½æ˜¯åƒåœ¾ï¼Œåªå¸Œæœ›æ‰“å¼€æ€è·¯ã€‚æŸé‚“åŒå¿—è¯´ï¼šèƒ½æŠ—ä½å‹åŠ›çš„åº”ç”¨æ‰æ˜¯å¥½åº”ç”¨ã€‚\nå‚è€ƒèµ„æ–™ # https://blog.csdn.net/boonya/article/details/55046568 https://www.jianshu.com/p/39c1e4ec0d63\n"},{"id":55,"href":"/2018/04/17/golang%E7%83%AD%E9%87%8D%E8%BD%BD%E5%B7%A5%E5%85%B7/","title":"golangçƒ­é‡è½½å·¥å…·","section":"Posts","content":" è¿è¡Œæˆªå›¾ # é¡¹ç›®åœ°å€ # https://github.com/yeqown/gw\næœ¬é¡¹ç›®ç”±https://github.com/silenceper/gowatchæ”¹é€ è€Œæ¥ã€‚ä¸åŒä¹‹å¤„åœ¨äº:\næœ¬gwä»»æ„æŒ‡å®šé‡æ–°æ‰§è¡Œçš„å‘½ä»¤ã€‚ è€ŒåŸæ¥çš„gwé»˜è®¤æ˜¯é‡æ–°ç¼–è¯‘æ‰“åŒ…goç¨‹åºã€‚\n"},{"id":56,"href":"/2018/04/08/Golang%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/","title":"Golangå­¦ä¹ ç¬”è®°","section":"Posts","content":" ç›®å½• # Channel Goroutine Channel # ä¸€å¼€å§‹æ˜¯åœ¨çœ‹channelçš„æºç ï¼Œç»“æœå‘ç°é‡Œé¢å«æœ‰ä¸€äº›æŠ½è±¡çš„æè¿°ï¼ˆå¯èƒ½ä¹Ÿå°±æ˜¯æˆ‘è§‰å¾—ã€‚ã€‚ã€‚æ¯•ç«Ÿæ²¡æœ‰æ·±å…¥ï¼‰\nDo not change another G\u0026rsquo;s status while holding this lock (in particular, do not ready a G), as this can deadlock with stack shrinking.\nå…¶ä¸­Gæ˜¯å•¥ï¼Ÿæˆ‘çœ‹ç€æ˜¯å¾ˆæ‡µé€¼çš„ï¼Œå»googleäº†ä¸€ä¸‹ï¼Œå…¶å®æ˜¯goroutineç›¸å…³çš„çŸ¥è¯†ï¼Œé‚£å°±æŠŠgoroutineç†è§£äº†å…ˆã€‚\n2020-04-13 å¡«å‘\nchannel in go\nGoroutine # G: è¡¨ç¤ºgoroutineï¼Œå­˜å‚¨äº†goroutineçš„æ‰§è¡Œstackä¿¡æ¯ã€goroutineçŠ¶æ€ä»¥åŠgoroutineçš„ä»»åŠ¡å‡½æ•°ç­‰ï¼›å¦å¤–Gå¯¹è±¡æ˜¯å¯ä»¥é‡ç”¨çš„ã€‚ P: è¡¨ç¤ºé€»è¾‘processorï¼ŒPçš„æ•°é‡å†³å®šäº†ç³»ç»Ÿå†…æœ€å¤§å¯å¹¶è¡Œçš„Gçš„æ•°é‡ï¼ˆå‰æï¼šç³»ç»Ÿçš„ç‰©ç†cpuæ ¸æ•°\u0026gt;=Pçš„æ•°é‡ï¼‰ï¼›Pçš„æœ€å¤§ä½œç”¨è¿˜æ˜¯å…¶æ‹¥æœ‰çš„å„ç§Gå¯¹è±¡é˜Ÿåˆ—ã€é“¾è¡¨ã€ä¸€äº›cacheå’ŒçŠ¶æ€ã€‚ M: ä»£è¡¨ç€çœŸæ­£çš„æ‰§è¡Œè®¡ç®—èµ„æºã€‚åœ¨ç»‘å®šæœ‰æ•ˆçš„påï¼Œè¿›å…¥scheduleå¾ªç¯ï¼›è€Œscheduleå¾ªç¯çš„æœºåˆ¶å¤§è‡´æ˜¯ä»å„ç§é˜Ÿåˆ—ã€pçš„æœ¬åœ°é˜Ÿåˆ—ä¸­è·å–Gï¼Œåˆ‡æ¢åˆ°Gçš„æ‰§è¡Œæ ˆä¸Šå¹¶æ‰§è¡ŒGçš„å‡½æ•°ï¼Œè°ƒç”¨goexitåšæ¸…ç†å·¥ä½œå¹¶å›åˆ°mï¼Œå¦‚æ­¤åå¤ã€‚Må¹¶ä¸ä¿ç•™GçŠ¶æ€ï¼Œè¿™æ˜¯Gå¯ä»¥è·¨Mè°ƒåº¦çš„åŸºç¡€ã€‚Må¿…é¡»å…³è”äº†Pæ‰èƒ½æ‰§è¡ŒGoä»£ç ã€‚\nç»“åˆä¸‹å›¾æ›´æ–¹ä¾¿ç†è§£ï¼š \u0026ndash;æºäºTonybaiçš„åšå®¢ï¼Œè§å‚è€ƒèµ„æ–™ã€‚ å‚è€ƒèµ„æ–™ # runtime/runtime2.go Tonybai-goroutineè°ƒåº¦å™¨ "},{"id":57,"href":"/2018/03/02/aliyun-rds%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD%E6%96%B9%E6%A1%88/","title":"aliyun-rdsæ•°æ®å¤‡ä»½æ–¹æ¡ˆ","section":"Posts","content":"æœ¬æ–‡ä¸»è¦æ˜¯æ€»ç»“ä¸‹åœ¨ä½¿ç”¨aliyun-rdsæ•°æ®å¤‡ä»½æ–¹æ¡ˆè¿‡ç¨‹ä¸­çš„å¿ƒå¾—ã€‚\né«˜å¯ç”¨ä¸€ç›´éƒ½æ˜¯çº¿ä¸ŠæœåŠ¡ç»´æŠ¤ç”¨æˆ·ä½“éªŒçš„å…³é”®ä¹‹ä¸€ã€‚ä¸ºäº†è¾¾åˆ°é«˜å¯ç”¨ï¼Œä¸šç•Œå·²ç»æœ‰äº†å¾ˆå¤šæ–¹æ¡ˆã€‚æœ€å…¸å‹çš„å°±æ˜¯â€œå†—ä½™å¤‡ä»½+è‡ªåŠ¨æ•…éšœè½¬ç§»â€ã€‚å†—ä½™å¤‡ä»½æ˜¯è¯´ï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹æœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œæœ‰å…¶ä»–æœåŠ¡èƒ½å¤Ÿä»£æ›¿å…¶å·¥ä½œã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå¦‚æœæœåŠ¡å‡ºç°äº†å¿…é¡»äººå·¥ä»‹å…¥è§£å†³çš„æ•…éšœï¼Œä¹Ÿä¼šå½±å“ç³»ç»Ÿçš„é«˜å¯ç”¨ç‰¹æ€§ã€‚\næœ¬æ–‡ç€é‡ä»‹ç»æ•°æ®çš„é«˜å¯ç”¨æ–¹æ¡ˆ\næ•°æ®åº“å†—ä½™ # å¦‚æœæ˜¯å•èŠ‚ç‚¹çš„æ•°æ®åº“ï¼Œè¿˜ç”¨çš„ç€è¯´å—ï¼Ÿè¦ä¿è¯æœåŠ¡é«˜å¯ç”¨ï¼Œé™¤äº†ä¸»-ä»æ•°æ®åº“ä¹‹å¤–ï¼Œè¿˜éœ€è¦ä»å¤‡ä»½æ•°æ®åº“ï¼Œå½“ç„¶ä¸èƒ½ä¿è¯è¯´ä¸€å®šä¸ä¼šé‡åˆ°æ‰€æœ‰çš„å¤‡ä»½æ•°æ®åº“ï¼Œéƒ½æŒ‚æ‰çš„æƒ…å†µ\u0026hellip;ã€‚é˜¿é‡Œäº‘æä¾›äº†RDS-é«˜å¯ç”¨ç‰ˆæœ¬å’ŒRDS-å•æœºç‰ˆ,ä¸¤è€…çš„åŒºåˆ«è§ä¸‹å›¾ï¼š è¿™å°±ç®—æœ€åŸºæœ¬çš„å†—ä½™äº†ï¼Œæ²¡æœ‰ä¸»ä»å¤åˆ¶ï¼Œæ²¡æœ‰è¯»å†™åˆ†ç¦»ã€‚ä½†æ˜¯èƒ½ä¿è¯ä¸»åº“åœ¨æ¢æ‰çš„æ—¶å€™ï¼Œè¿˜èƒ½ä½¿ç”¨å¤‡åº“æä¾›æœåŠ¡ã€‚å¦‚æœæœåŠ¡å¯¹äºæ•°æ®åº“æ€§èƒ½å’Œå¯ç”¨æ€§æœ‰ä¸€å®šè¦æ±‚ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨è¿™ä¸ªåŸºç¡€ä¸Šå‡ä¸ªçº§ï¼Œè§ä¸‹å›¾ï¼š æ•°æ®æ•…éšœè‡ªåŠ¨è½¬ç§» # å·²ç»æœ‰äº†å†—ä½™çš„æ•°æ®åº“èŠ‚ç‚¹äº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥è¦åšçš„äº‹æƒ…å°±æ˜¯æ€ä¹ˆæ„ŸçŸ¥æ•°æ®åº“å¼‚å¸¸ï¼Œå¹¶å®ç°è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ä»½å®ä¾‹ä¸­? é˜¿é‡Œäº‘ç¾å¤‡æ–¹æ¡ˆçš„æ–‡æ¡£æ˜¯è¿™æ ·æè¿°çš„ï¼š\nä¸»å®ä¾‹å’Œç¾å¤‡å®ä¾‹å‡æ­å»ºä¸»å¤‡é«˜å¯ç”¨æ¶æ„ï¼Œå½“ä¸»å®ä¾‹æ‰€åœ¨åŒºåŸŸå‘ç”Ÿçªå‘æ€§è‡ªç„¶ç¾å®³ç­‰çŠ¶å†µï¼Œä¸»èŠ‚ç‚¹ï¼ˆMasterï¼‰å’Œå¤‡èŠ‚ç‚¹ï¼ˆSlaveï¼‰å‡æ— æ³•è¿æ¥æ—¶ï¼Œå¯å°†å¼‚åœ°ç¾å¤‡å®ä¾‹åˆ‡æ¢ä¸ºä¸»å®ä¾‹ï¼Œåœ¨åº”ç”¨ç«¯ä¿®æ”¹æ•°æ®åº“é“¾æ¥åœ°å€åï¼Œå³å¯å¿«é€Ÿæ¢å¤åº”ç”¨çš„ä¸šåŠ¡è®¿é—®ã€‚\nå¯¹äºä¸»èŠ‚ç‚¹å…¨éƒ¨ä¸å¯ç”¨çš„æƒ…å†µå¯¹åº”ç”¨æœåŠ¡æ˜¯å¯è§çš„ï¼Œå› æ­¤åº”ç”¨æœåŠ¡å¯ä»¥é€šè¿‡æŒ‡å®šä¸€äº›å¼‚å¸¸åˆ¤æ–­ï¼Œåœ¨åˆ¤å®šä¸»èŠ‚ç‚¹ä¸å¯ç”¨çš„æ—¶å€™ï¼Œä¸»åŠ¨åˆ‡æ¢æ•°æ®åº“è¿æ¥åœ°å€æ¥è·å–æ•°æ®ï¼Œæä¾›æœåŠ¡ã€‚\n// sql-detect.go package main import ( \u0026#34;database/sql\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;time\u0026#34; _ \u0026#34;github.com/go-sql-driver/mysql\u0026#34; _ \u0026#34;github.com/mxk/go-sqlite\u0026#34; ) var ( mysqlAvailable bool = true mutex = sync.Mutex{} db *sql.DB = nil ) func MysqlDetection(db *sql.DB, ticker *time.Ticker) { for { select { case \u0026lt;-ticker.C: if e := db.Ping(); e != nil { fmt.Println(\u0026#34;got error\u0026#34;, e) mutex.Lock() mysqlAvailable = false mutex.Unlock() } else { fmt.Println(\u0026#34;status ok\u0026#34;) } } } } func MysqlSwitch() { for { mutex.Lock() if !mysqlAvailable { fmt.Println(\u0026#34;Switch Sqlite3\u0026#34;) db, _ = sql.Open(\u0026#34;sqlite3\u0026#34;, \u0026#34;./foo.db\u0026#34;) } mutex.Unlock() time.Sleep(time.Second * 4) } } func main() { c := make(chan bool) db, _ = sql.Open(\u0026#34;mysql\u0026#34;, \u0026#34;yeqiang:yeqiang@/test_yeqiang\u0026#34;) ticker := time.NewTicker(time.Second * 2) go MysqlDetection(db, ticker) go MysqlSwitch() \u0026lt;-c } æµ‹è¯•æˆªå›¾ï¼š\né˜¿é‡Œäº‘é«˜å¯ç”¨ç‰ˆæœ¬çš„RDSï¼Œä¼šè‡ªåŠ¨æ£€æµ‹ä¸»èŠ‚ç‚¹å’Œå¤‡èŠ‚ç‚¹æ˜¯å¦æ­£å¸¸æä¾›æœåŠ¡ã€‚é€šè¿‡8-10ç§’çš„å¿ƒè·³ï¼Œæ£€æµ‹æ¨¡å—å¯ä»¥åœ¨30ç§’å†…å®Œæˆå¼‚å¸¸åˆ‡æ¢ï¼Œå¯¹äºåº”ç”¨æœåŠ¡æ¥è¯´æ˜¯é€æ˜çš„ã€‚\né˜¿é‡Œäº‘DBS # DBSï¼Œè¿™æ˜¯é˜¿é‡Œäº‘æ–°å‡ºçš„å¤‡ä»½æœåŠ¡ï¼Œç›®å‰å¤„äºå…¬æµ‹é˜¶æ®µã€‚æ–‡æ¡£ä¸­æåˆ°çš„å®æ—¶å¤‡ä»½å’Œå¢é‡å¤‡ä»½ï¼Œå€’æ˜¯å¾ˆå¸å¼•äººã€‚ å›¾ç‰‡å¤šæºäºé˜¿é‡Œäº‘\n"},{"id":58,"href":"/2018/03/01/Stack%E5%AE%9E%E7%8E%B0O1%E7%9A%84Min%E5%92%8CMax/","title":"Stackå®ç°O(1)çš„Minå’ŒMaxï¼šä»ç©ºé—´æ¢æ—¶é—´åˆ°æ•°å­¦é­”æ³•çš„æ¢ç©¶","section":"Posts","content":" æ ˆï¼ˆStackï¼‰ä½œä¸ºä¸€ç§åŸºç¡€çš„æ•°æ®ç»“æ„ï¼Œå…¶ Push å’Œ Pop æ“ä½œçš„ $O(1)$ æ—¶é—´å¤æ‚åº¦é€šè¿‡æ ˆé¡¶æŒ‡é’ˆå³å¯è½»æ¾ä¿è¯ã€‚ä½†å¦‚æœåœ¨å®é™…ä¸šåŠ¡åœºæ™¯æˆ–ç®—æ³•æŒ‘æˆ˜ä¸­ï¼Œè¦æ±‚æˆ‘ä»¬å®ç° O(1) æ—¶é—´å¤æ‚åº¦å†…çš„ Min å’Œ Max æ“ä½œï¼Œé—®é¢˜å°±å˜å¾—æœ‰è¶£èµ·æ¥äº†ã€‚\nèƒŒæ™¯ # åœ¨å¸¸è§„çš„æ ˆå®ç°ä¸­ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦è·å–æ ˆå†…çš„æœ€å¤§å€¼æˆ–æœ€å°å€¼ï¼Œé€šå¸¸çš„åšæ³•æ˜¯éå†æ•´ä¸ªæ ˆã€‚è¿™ç§åšæ³•çš„æ—¶é—´å¤æ‚åº¦æ˜¯ $O(N)$ï¼Œå…¶ä¸­ $N$ æ˜¯æ ˆä¸­å…ƒç´ çš„æ•°é‡ã€‚\nç„¶è€Œï¼Œåœ¨æŸäº›å¯¹æ€§èƒ½è¦æ±‚è‹›åˆ»çš„åœºæ™¯ï¼ˆå¦‚å®æ—¶æµç›‘æ§çª—å£çš„æœ€å€¼è®¡ç®—ï¼‰æˆ–è€…ç®—æ³•é¢è¯•ä¸­ï¼Œé€šå¸¸ä¼šè¦æ±‚æˆ‘ä»¬å°† Min å’Œ Max çš„è·å–æ—¶é—´ä¹Ÿå‹ç¼©åˆ° $O(1)$ã€‚\né¢å¯¹è¿™ä¸ªéœ€æ±‚ï¼Œæˆ‘ä»¬æœ€å…ˆæƒ³åˆ°çš„æ€è·¯é€šå¸¸æ˜¯â€œç©ºé—´æ¢æ—¶é—´â€ï¼šå³é€šè¿‡ç»´æŠ¤é¢å¤–çš„çŠ¶æ€æ¥å®æ—¶è®°å½•æœ€å€¼ã€‚é‚£ä¹ˆï¼Œå…·ä½“è¯¥å¦‚ä½•è®¾è®¡å¹¶ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å‘¢ï¼Ÿ\næ–¹æ¡ˆä¸€ï¼šè¾…åŠ©æ ˆ (Auxiliary Stack) # æœ€ç›´è§‚çš„æ€è·¯æ˜¯è®¾ç½®ä¸€ä¸ªè¾…åŠ©ç»“æ„æ¥åŒæ­¥è®°å½•æœ€å€¼ã€‚æˆ‘ä»¬ä»¥â€œæœ€å¤§å€¼â€ä¸ºä¾‹ï¼Œå¼•å…¥ä¸€ä¸ªè¾…åŠ©æ ˆ SMaxã€‚\nç®—æ³•æè¿° # State: DataStack: [Integer] // The primary storage SMax: [Integer] // Auxiliary stack to store the sequence of maximums åœ¨è¿™ä¸ªæ–¹æ¡ˆä¸­ï¼Œé€»è¾‘å¦‚ä¸‹ï¼š\nPush: å½“å…ƒç´ å…¥æ ˆæ—¶ï¼Œæˆ‘ä»¬ä¸ä»…å°†å…¶å‹å…¥æ•°æ®æ ˆï¼›åŒæ—¶ï¼Œæ¯”è¾ƒè¯¥å…ƒç´ ä¸ SMax æ ˆé¡¶å…ƒç´ ã€‚å¦‚æœè¯¥å…ƒç´ å¤§äºç­‰äº SMax æ ˆé¡¶å…ƒç´ ï¼ˆæˆ–è€… SMax ä¸ºç©ºï¼‰ï¼Œåˆ™å°†è¯¥å…ƒç´ ä¹Ÿå‹å…¥ SMaxã€‚ Pop: å½“å…ƒç´ å‡ºæ ˆæ—¶ï¼Œåˆ¤æ–­è¯¥å…ƒç´ æ˜¯å¦ç­‰äº SMax çš„æ ˆé¡¶å…ƒç´ ã€‚å¦‚æœç›¸ç­‰ï¼Œè¯´æ˜æˆ‘ä»¬è¦å¼¹å‡ºçš„æ­£æ˜¯å½“å‰çš„æœ€å¤§å€¼ï¼Œå› æ­¤ SMax ä¹Ÿè¦åŒæ­¥å¼¹å‡ºæ ˆé¡¶ã€‚ ä¼ªä»£ç æè¿° # Function Push(element): DataStack.Push(element) // If element is new max, push to SMax IF SMax.IsEmpty() OR element \u0026gt;= SMax.Top(): SMax.Push(element) Function Pop(): value = DataStack.Pop() // If we are popping the current max, pop from SMax too IF value == SMax.Top(): SMax.Pop() RETURN value Function GetMax(): RETURN SMax.Top() åœºæ™¯æ¨æ¼” # ä¸ºäº†éªŒè¯è¿™ä¸ªé€»è¾‘ï¼Œæˆ‘ä»¬ä»¥åºåˆ— 1, 3, 6, 1, 12, 512, 12, 5121, 121, 412 ä¸ºä¾‹è¿›è¡Œæ¨æ¼”ï¼š\nStep-1. å…ƒç´  1 å…¥æ ˆ å½“å‰ SMax ä¸ºç©ºï¼Œç›´æ¥å…¥æ ˆã€‚\nStack: 1 SMax: 1 Step-2. å…ƒç´  3 å…¥æ ˆ 3 \u0026gt; 1ï¼Œä¸ºäº†ä¿è¯ SMax æ ˆé¡¶å§‹ç»ˆæ˜¯å½“å‰æœ€å¤§å€¼ï¼Œ3 å…¥ SMaxã€‚\nStack: 1, 3 SMax: 1, 3 Step-3. å…ƒç´  6 å…¥æ ˆ 6 \u0026gt; 3ï¼ŒåŒæ­¥æ›´æ–°ã€‚\nStack: 1, 3, 6 SMax: 1, 3, 6 \u0026hellip; çœç•¥ä¸­é—´æ­¥éª¤ \u0026hellip;\nStep-End. æ‰€æœ‰å…ƒç´ å…¥æ ˆå æœ€ç»ˆçŠ¶æ€å¦‚ä¸‹ï¼š\nStack: 1, 3, 6, 1, 12, 512, 12, 5121, 121, 412 SMax: 1, 3, 6, 12, 512, 5121 æ³¨ï¼šSMax ä¸­ä»…å­˜å‚¨æ¯”æ ˆé¡¶æ›´å¤§çš„æ–°å…ƒç´ ï¼Œå› æ­¤ 1, 12, 121, 412\nå¯ä»¥çœ‹åˆ°ï¼Œè¿™ç§æ–¹å¼é€»è¾‘æ¸…æ™°ï¼Œå®ç°ç®€å•ã€‚ä½†ä»æ¨æ¼”ä¸­æˆ‘ä»¬ä¹Ÿå‘ç°äº†ä¸€ä¸ªæ˜æ˜¾çš„ç¼ºé™·ï¼šç©ºé—´å¤æ‚åº¦ã€‚\nå¦‚æœå…¥æ ˆçš„å…ƒç´ æ˜¯é€’å¢åºåˆ—ï¼ˆå¦‚ 1, 2, 3, ... Nï¼‰ï¼Œé‚£ä¹ˆ SMax æ ˆçš„å¤§å°å°†ç­‰åŒäºæ•°æ®æ ˆï¼Œç©ºé—´è€—è´¹ä¸º $2N$ã€‚ä»…ä»…ä¸ºäº†è®°å½•ä¸€ä¸ªæœ€å€¼ï¼Œè€—è´¹äº†ä¸€å€çš„é¢å¤–ç©ºé—´ï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯æœ€ä¼˜è§£ã€‚\næ–¹æ¡ˆäºŒï¼šå·®å€¼æ ‡è®°æ³• (Value Difference) # æœ‰æ²¡æœ‰ä¸€ç§æ–¹æ³•ï¼Œæ—¢èƒ½ä¿è¯ $O(1)$ çš„æ—¶é—´å¤æ‚åº¦ï¼Œåˆèƒ½æ˜¾è‘—å‡å°‘ç©ºé—´å ç”¨ï¼Ÿ\nå›é¡¾æˆ‘ä»¬çš„éœ€æ±‚ï¼Œæˆ‘ä»¬çœŸæ­£å…³å¿ƒçš„æ˜¯â€œå½“å‰çš„æœ€å¤§å€¼â€ã€‚å¦‚æœæˆ‘ä»¬åˆ©ç”¨æ ˆä¸­å­˜å‚¨çš„å…ƒç´ æœ¬èº«æ¥æ‰¿è½½ä¸€äº›â€œé¢å¤–ä¿¡æ¯â€ï¼Œæ˜¯å¦å¯è¡Œï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œæˆ‘ä»¬å¯ä»¥å­˜å‚¨å·®å€¼ã€‚\nç®—æ³•è®¾è®¡ # åœ¨è¿™ä¸ªä¼˜åŒ–æ–¹æ¡ˆä¸­ï¼Œæˆ‘ä»¬ä¸å†å­˜å‚¨åŸå§‹æ•°å€¼ï¼Œè€Œæ˜¯å­˜å‚¨ (å½“å‰å…ƒç´  - å½“å‰æœ€å¤§å€¼) çš„å·®å€¼ã€‚\nState: DataStack: [Integer] // Stores the difference (Val - Max) Max: Integer // Tracks the current maximum value å…¶æ ¸å¿ƒé€»è¾‘æ˜¾å¾—ç•¥å¾®â€œåç›´è§‰â€ï¼Œè¿™é‡Œéœ€è¦ç»†ç»†å“å‘³ï¼š\nPush: è®¡ç®— diff = å½“å‰å…ƒç´  - Maxï¼Œå°† diff å…¥æ ˆã€‚ å¦‚æœ å½“å‰å…ƒç´  \u0026gt; Maxï¼Œè¯´æ˜æœ€å¤§å€¼å˜äº†ï¼Œæ›´æ–° Max = å½“å‰å…ƒç´ ã€‚ (æ³¨æ„ï¼šæ­¤æ—¶æ ˆé¡¶å­˜å‚¨çš„ diff æ˜¯æ­£æ•°ï¼Œæ ‡è®°äº†æ–° Max çš„äº§ç”Ÿ) Pop: å–å‡º æ ˆé¡¶å…ƒç´  (diff)ã€‚ å¦‚æœ diff \u0026gt; 0ï¼šè¯´æ˜åœ¨è¿™ä¸ªå…ƒç´ å…¥æ ˆæ—¶æ›´æ–°è¿‡ Maxã€‚å½“å‰å®é™…å¼¹å‡ºçš„å…ƒç´ å°±æ˜¯ Maxï¼Œè€Œä¸Šä¸€ä¸ª Max çš„å€¼å¯ä»¥é€šè¿‡ Max - diff è¿˜åŸã€‚æˆ‘ä»¬éœ€è¦æ›´æ–° Max = Max - diffã€‚ å¦‚æœ diff \u0026lt;= 0ï¼šè¯´æ˜å…¥æ ˆæ—¶æ¯” Max å°ï¼Œæ²¡æ›´æ–°è¿‡ Maxã€‚å½“å‰å®é™…å¼¹å‡ºçš„å…ƒç´ æ˜¯ Max + diffï¼Œæ— éœ€æ›´æ–° Maxã€‚ ä¼ªä»£ç æè¿° # Function Push(element): IF DataStack.IsEmpty(): Max = element DataStack.Push(0) // 0 means element == Max ELSE: diff = element - Max DataStack.Push(diff) // If diff \u0026gt; 0, it means element \u0026gt; current Max IF diff \u0026gt; 0: Max = element Function Pop(): diff = DataStack.Pop() IF diff \u0026gt; 0: // This element updated the Max when pushed // Current value is Max, we need to restore previous Max value = Max Max = Max - diff RETURN value ELSE: // Max was not updated by this element // Original value was (Max + diff) RETURN Max + diff Function GetMax(): RETURN Max æ·±åº¦å¤ç›˜ # è¿™ä¸ªé€»è¾‘æ¯”è¾ƒæŠ½è±¡ï¼Œæˆ‘ä»¬ç”¨ä¸€ç»„æ•°æ® 5, 23, 12, 499, 45, 20, 60 æ¥è¿›è¡Œä¸€æ¬¡å®Œæ•´çš„â€œæŠ“åŒ…â€åˆ†æã€‚\nStep-1. å…ƒç´  5 å…¥æ ˆ å½“å‰ Max åˆå§‹åŒ–ä¸ºæå°å€¼ã€‚ å…¥æ ˆå†…å®¹ï¼š5 - MinInt (æ­£æ•°)ã€‚ æ›´æ–° Max = 5ã€‚\nStack: [5-MinInt] Max: 5 Step-2. å…ƒç´  23 å…¥æ ˆ å½“å‰å…ƒç´  23 \u0026gt; Max(5)ã€‚ å…¥æ ˆå†…å®¹ï¼š23 - 5 = 18ã€‚ æ›´æ–° Max = 23ã€‚\nStack: [..., 18] Max: 23 Step-3. å…ƒç´  12 å…¥æ ˆ å½“å‰å…ƒç´  12 \u0026lt; Max(23)ã€‚ å…¥æ ˆå†…å®¹ï¼š12 - 23 = -11ã€‚ ä¸æ›´æ–° Maxã€‚\nStack: [..., 18, -11] Max: 23 æ­¤æ—¶ï¼Œå¦‚æœæˆ‘ä»¬è¦è¿›è¡Œ Pop æ“ä½œï¼Œæµç¨‹å¦‚ä¸‹ï¼š\nStep-4. å¼¹å‡ºæ ˆé¡¶ -11 æ ˆé¡¶ -11 \u0026lt; 0ã€‚ è¿™æ„å‘³ç€å½“å‰ Max å¹¶ä¸æ˜¯åœ¨è¿™ä¸ªå…ƒç´ å…¥æ ˆæ—¶è¢«ä¿®æ”¹çš„ã€‚ è¿˜åŸçœŸå®å…ƒç´ ï¼šMax(23) + (-11) = 12ã€‚ Max ä¿æŒ 23 ä¸å˜ã€‚\nStack: [..., 18] Max: 23 ç»“æœæ­£ç¡®ï¼šå¼¹å‡ºäº† 12ï¼Œä¸” Max ä»ä¸º 23ã€‚\nStep-5. å¼¹å‡ºæ ˆé¡¶ 18 æ ˆé¡¶ 18 \u0026gt; 0ã€‚ è¿™æ˜¯ä¸€ä¸ªå…³é”®ä¿¡å·ï¼è¯´æ˜å½“åˆè¿™ä¸ªå…ƒç´ å…¥æ ˆæ—¶ï¼Œå®ƒæ¨é«˜äº† Max å€¼ã€‚ å½“å‰çœŸå®å…ƒç´ å°±æ˜¯ Max(23)ã€‚ æˆ‘ä»¬éœ€è¦â€œå›æº¯â€ Max å€¼ï¼šNewMax = Max(23) - 18 = 5ã€‚\nStack: [...] Max: 5 ç»“æœæ­£ç¡®ï¼šå¼¹å‡ºäº† 23ï¼Œä¸” Max æ¢å¤ä¸ºäº† 5ã€‚\nä¼˜åŠ¿åˆ†æ # ç›¸è¾ƒäºè¾…åŠ©æ ˆæ–¹æ¡ˆï¼Œå·®å€¼æ³•çš„ä¼˜åŠ¿åœ¨äºï¼š\nç©ºé—´æ•ˆç‡ï¼šä¸éœ€è¦é¢å¤–çš„ $O(N)$ ç©ºé—´å­˜å‚¨è¾…åŠ©æ ˆï¼Œä»…éœ€ $O(1)$ çš„å˜é‡å­˜å‚¨ Maxã€‚ ä¼˜é›…æ€§ï¼šåˆ©ç”¨æ•°å­¦ç‰¹æ€§ï¼ˆåŠ å‡é€†è¿ç®—ï¼‰è¿˜åŸä¸Šä¸‹æ–‡ï¼Œå‡å°‘äº†æ•°æ®ç»“æ„çš„å¤æ‚åº¦ã€‚ ä¸¾ä¸€åä¸‰ï¼šæœ€å°å€¼çš„å®ç° # ä¸Šè¿°é€»è¾‘ç€é‡æ¢ç©¶äº† Max çš„å®ç°ï¼Œå¯¹äº Min çš„å®ç°ï¼ŒåŸç†æ˜¯å®Œå…¨å¯¹ç§°çš„ã€‚\nå¯¹äºè¾…åŠ©æ ˆæ³•ï¼Œæˆ‘ä»¬åªéœ€è¦ç»´æŠ¤ä¸€ä¸ª SMin æ ˆï¼ŒPush æ—¶è‹¥å½“å‰å…ƒç´  \u0026lt;= SMin æ ˆé¡¶åˆ™å…¥æ ˆï¼ŒPop æ—¶è‹¥ç­‰äºåˆ™å‡ºæ ˆã€‚\nå¯¹äºå·®å€¼æ ‡è®°æ³•ï¼Œé€»è¾‘ç¨ä½œè°ƒæ•´ï¼š\nPush: å­˜å‚¨ å½“å‰å…ƒç´  - Minã€‚è‹¥ å½“å‰å…ƒç´  \u0026lt; Minï¼Œåˆ™æ›´æ–° Minã€‚æ­¤æ—¶å…¥æ ˆçš„å·®å€¼ä¸ºè´Ÿæ•°ã€‚ Pop: è‹¥ æ ˆé¡¶å…ƒç´  \u0026lt; 0ï¼Œè¯´æ˜æ›´æ–°è¿‡ Minï¼Œè¿˜åŸ PreMin = Min - æ ˆé¡¶å…ƒç´ ã€‚ æ€»ç»“ # æœ¬æ–‡ä»ä¸€ä¸ªç®€å•çš„ $O(1)$ æœ€å€¼éœ€æ±‚å‡ºå‘ï¼Œå±•ç¤ºäº†ä¸¤ç§æˆªç„¶ä¸åŒçš„è§£å†³æ€è·¯ã€‚\nè¾…åŠ©æ ˆæ³•èƒœåœ¨ç›´è§‚ã€æ˜“ç†è§£ï¼Œç¬¦åˆçº¿æ€§æ€ç»´ï¼Œä½†åœ¨æç«¯æƒ…å†µä¸‹ç©ºé—´æµªè´¹ä¸¥é‡ã€‚ å·®å€¼æ ‡è®°æ³•åˆ©ç”¨äº†æ•°æ®çš„ç›¸å¯¹å…³ç³»ï¼Œé€šè¿‡æ•°å­¦å˜æ¢å°†â€œå†å²çŠ¶æ€â€ç¼–ç åœ¨å½“å‰æ•°æ®ä¸­ï¼Œå®ç°äº†æè‡´çš„ç©ºé—´ä¼˜åŒ–ã€‚ åœ¨å®é™…å·¥ç¨‹å’Œç®—æ³•è®¾è®¡ä¸­ï¼Œè¿™ç§â€œåˆ©ç”¨æ•°æ®é—´çš„ç›¸å¯¹å…³ç³»æ¥å‹ç¼©ä¿¡æ¯â€çš„æ€æƒ³ï¼ˆç±»ä¼¼å·®åˆ†æ•°ç»„ã€å‰ç¼€å’Œï¼‰æ˜¯éå¸¸é€šç”¨çš„è§£é¢˜åˆ©å™¨ã€‚çŸ¥å…¶ç„¶æ›´çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œæ‰èƒ½åœ¨é¢å¯¹æ›´å¤æ‚çš„é—®é¢˜æ—¶æ¸¸åˆƒæœ‰ä½™ã€‚\n"},{"id":59,"href":"/2018/02/11/Trie%E6%A0%91%E5%8E%9F%E7%90%86%E4%BB%8B%E7%BB%8D/","title":"Trieæ ‘å­¦ä¹ ","section":"Posts","content":"Trieæ ‘(Retrieval Tree)åˆç§°å‰ç¼€æ ‘ï¼Œå¯ä»¥ç”¨æ¥ä¿å­˜å¤šä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶ä¸”æŸ¥æ‰¾æ•ˆç‡é«˜ã€‚åœ¨trieä¸­æŸ¥æ‰¾ä¸€ä¸ªå­—ç¬¦ä¸²çš„æ—¶é—´åªå–å†³äºç»„æˆè¯¥ä¸²çš„å­—ç¬¦æ•°ï¼Œä¸æ ‘çš„èŠ‚ç‚¹æ•°æ— å…³ã€‚Trieæ ‘å½¢çŠ¶å¦‚ä¸‹å›¾ï¼š åº”ç”¨åœºæ™¯ # è¯é¢‘ç»Ÿè®¡ï¼ˆæœç´¢å¼•æ“å¸¸ç”¨ï¼‰ å‰ç¼€å•è¯æœç´¢ æ„é€ Trieæ ‘ # æ„é€ Trieæ ‘æœ‰å¦‚ä¸‹å‡ ç§æ–¹å¼ï¼ˆéå…¨éƒ¨ï¼‰ï¼š\n// ç»“æ„1ï¼Œç®€å•ä¸”ç›´è§‚ï¼Œä½†æ˜¯ç©ºé—´é—²ç½®è¾ƒå¤šï¼Œåˆ©ç”¨ç‡ä½ä¸‹ type TrieNode struct{ Char\trune Children [27]*TrieNode } // ç»“æ„äºŒ å¯å˜æ•°ç»„Trieæ ‘, å‡å°‘äº†é—²ç½®æŒ‡é’ˆï¼Œä½†æ˜¯åªèƒ½é€šè¿‡éå†æ¥è·å–ä¸‹ä¸€çŠ¶æ€ï¼Œé™ä½äº†æŸ¥è¯¢æ•ˆç‡ type TrieNode struct { Char rune Children []*TrieNode } // ç»“æ„3ï¼ŒåŒæ•°ç»„Trieæ ‘ï¼Œç©ºé—´å’Œæ—¶é—´ä¸Šè€—è´¹è¾ƒä¸ºå‡è¡¡ï¼Œä½†æ˜¯åŠ¨æ€æ„å»ºï¼Œè§£å†³å†²çªè€—è´¹æ—¶é—´è¾ƒå¤š type TrieNode struct { Base []int Check []int } æ•°ç»„æ„é€ æ–¹å¼ # è¿™é‡Œé€‰æ‹©åŒæ•°ç»„æ–¹å¼æ¥å®ç°Trieæ ‘ã€‚\nåŸºäºæ•°ç»„çš„å®ç°æ–¹å¼ï¼ŒæŠŠtrieçœ‹ä½œä¸€ä¸ªDFAï¼Œæ ‘çš„æ¯ä¸ªèŠ‚ç‚¹å¯¹åº”ä¸€ä¸ªDFAçŠ¶æ€ï¼Œæ¯æ¡ä»çˆ¶èŠ‚ç‚¹æŒ‡å‘å­èŠ‚ç‚¹çš„æœ‰å‘è¾¹å¯¹åº”ä¸€ä¸ªDFAå˜æ¢ã€‚éå†ä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œå­—ç¬¦ä¸²çš„æ¯ä¸ªå­—ç¬¦ä½œä¸ºè¾“å…¥ç”¨æ¥ç¡®å®šä¸‹ä¸€ä¸ªçŠ¶æ€ï¼Œç›´åˆ°å¶èŠ‚ç‚¹ã€‚ \u0026mdash;- æ‘˜è‡ªå‚è€ƒèµ„æ–™ï¼ŒTrieæ•°ç»„å®ç°åŸç†\nå…³äºåŒæ•°ç»„ï¼š\nBaseæ•°ç»„ï¼Œè¡¨ç¤ºåå³èŠ‚ç‚¹çš„åŸºåœ°å€çš„æ•°ç»„ï¼Œå¶å­èŠ‚ç‚¹æ²¡æœ‰åç»§ Checkæ•°ç»„ï¼Œç”¨äºæ£€æŸ¥ Trieæ ‘åº”ç”¨ä¹‹å‰ç¼€æœç´¢ # å‰ç¼€æœç´¢ã€‚ä¹Ÿå°±æ˜¯ç»™ä¸€å®šçš„å­—ç¬¦ä¸²ï¼Œç»™å‡ºæ‰€æœ‰ä»¥è¯¥å­—ç¬¦ä¸²å¼€å§‹çš„å•è¯ã€‚è­¬å¦‚ï¼ŒSearch(\u0026ldquo;go\u0026rdquo;)ï¼Œå¾—åˆ°[\u0026ldquo;go\u0026rdquo;, \u0026ldquo;golang\u0026rdquo;, \u0026ldquo;google\u0026rdquo;, \u0026hellip;]\nä¸‰ç§æ„é€ æ–¹å¼çš„ä¼˜åŠ£åˆ†æ # Trieæ ‘ï¼ˆæ•°ç»„Trieæ ‘ï¼‰ # æ¯ä¸ªèŠ‚ç‚¹éƒ½å«æœ‰26ä¸ªå­—æ¯æŒ‡é’ˆï¼Œä½†å¹¶ä¸æ˜¯éƒ½ä¼šä½¿ç”¨ï¼Œå†…å­˜åˆ©ç”¨ç‡ä½ã€‚æ—¶é—´å¤æ‚åº¦ï¼šO(k)ï¼Œ ç©ºé—´å¤æ‚åº¦ï¼šO(26^n)\nåŒæ•°ç»„Trieæ ‘ # æ„é€ è°ƒæ•´è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªçŠ¶æ€éƒ½ä¾èµ–äºå…¶ä»–çŠ¶æ€ï¼Œæ‰€ä»¥å½“åœ¨è¯å…¸ä¸­æ’å…¥æˆ–åˆ é™¤è¯è¯­çš„æ—¶å€™ï¼Œå¾€å¾€éœ€è¦å¯¹åŒæ•°ç»„ç»“æ„è¿›è¡Œå…¨å±€è°ƒæ•´,çµæ´»æ€§èƒ½è¾ƒå·®ã€‚åŒæ•°ç»„å·²ç»å¤§å¹…æ”¹å–„äº†ç»å…¸Trieæ ‘çš„ç©ºé—´æµªè´¹ï¼Œä½†æ˜¯å†²çªå‘ç”Ÿçš„æ—¶å€™ï¼Œæ€»æ˜¯å¾€åå¯»å€ï¼Œä¸å¯é¿å…æ•°ç»„ç©ºç½®ã€‚éšç€æ•°æ®é‡å¢å¤§ï¼Œå†²çªçš„å‡ ç‡ä¹Ÿè¶Šæ¥è¶Šå¤§ï¼Œå­—å…¸æ ‘çš„æ„å»ºä¹Ÿè¶Šæ¥è¶Šæ…¢ã€‚å¦‚æœæ ¸å¿ƒè¯å…¸å·²ç»é¢„å…ˆå»ºç«‹å¥½å¹¶ä¸”æœ‰åºçš„ï¼Œå¹¶ä¸”ä¸ä¼šæ·»åŠ æˆ–åˆ é™¤æ–°è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªç¼ºç‚¹æ˜¯å¯ä»¥å¿½ç•¥çš„ã€‚æ‰€ä»¥å¸¸ç”¨åŒæ•°ç»„Tireæ ‘éƒ½æ˜¯è½½å…¥æ•´ä¸ªé¢„å…ˆå»ºç«‹å¥½çš„æ ¸å¿ƒåˆ†è¯è¯å…¸ã€‚\nTail-Trieæ ‘ # ä¸‰æ•°ç»„Trieæ ‘å®åœ¨åŒæ•°ç»„çš„åŸºç¡€ä¸Šä¼˜åŒ–è€Œæ¥ï¼Œå¢åŠ äº†tailèŠ‚ç‚¹ï¼Œå°±æ˜¯å°†éå…¬å…±å‰ç¼€çš„è¯å°¾åˆå¹¶æˆä¸ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œå‡å°‘èŠ‚ç‚¹æ€»æ•°ï¼Œæå‡è¯å…¸æ ‘çš„æ„å»ºé€Ÿåº¦ã€‚å¦‚å›¾ï¼š å‚è€ƒèµ„æ–™ # An Implementation of Double-Array Trie Trieæ ‘è¯¦è§£åŠåº”ç”¨ DoubleArrayTrie An Efficient Implementation of Trie Structures github.com/gansidui/trie.go github.com/smtc/godat "},{"id":60,"href":"/2018/02/11/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92%E4%B9%8B%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%BC%96%E8%BE%91%E8%B7%9D%E7%A6%BB%E9%97%AE%E9%A2%98-LD/","title":"åŠ¨æ€è§„åˆ’ä¹‹å­—ç¬¦ä¸²ç¼–è¾‘è·ç¦»","section":"Posts","content":" é—®é¢˜æè¿° # ç»™å®š 2 ä¸ªå­—ç¬¦ä¸² a, b. ç¼–è¾‘è·ç¦»æ˜¯å°† a è½¬æ¢ä¸º b çš„æœ€å°‘æ“ä½œæ¬¡æ•°ï¼Œæ“ä½œåªå…è®¸å¦‚ä¸‹ 3 ç§ï¼š æ’å…¥ä¸€ä¸ªå­—ç¬¦ï¼Œä¾‹å¦‚ï¼šfj -\u0026gt; fxj åˆ é™¤ä¸€ä¸ªå­—ç¬¦ï¼Œä¾‹å¦‚ï¼šfxj -\u0026gt; fj æ›¿æ¢ä¸€ä¸ªå­—ç¬¦ï¼Œä¾‹å¦‚ï¼šjyj -\u0026gt; fyj\nå‡½æ•°åŸå‹ï¼š\nfunc LevenshteinDis(str1, str2 string) int { ... } ç®—æ³•é€‚ç”¨åœºæ™¯ # æ‹¼å†™æ£€æŸ¥ è¾“å…¥è”æƒ³ è¯­éŸ³è¯†åˆ« è®ºæ–‡æ£€æŸ¥ DNAåˆ†æ é—®é¢˜åˆ†æ # å‡å®šå‡½æ•°edit_dis(stra, strb)è¡¨ç¤ºï¼Œstraåˆ°strbçš„ç¼–è¾‘è·ç¦»ã€‚ç®—æ³•é—®é¢˜å¯ä»¥åˆ†ä¸ºå››ç§æƒ…å†µï¼š\nedit_dis(0, 0) = 0 edit_dis(0, strb) = len(strb) edit_dis(stra, strb) = len(stra) edit_dis(stra, strb) = ? å¯¹äº4thä¸€èˆ¬æƒ…å†µï¼Œæ²¡æœ‰åŠæ³•ç›´æ¥ç»™å‡ºæ±‚è§£æ–¹å¼ï¼Œæˆ‘ä»¬æ¥åˆ†æedit_dis(stra+chara, strb+charb)å¯èƒ½çš„æƒ…å†µï¼š\nstraèƒ½è½¬æˆstrbï¼Œé‚£ä¹ˆåªéœ€è¦åˆ¤æ–­charaæ˜¯ä¸æ˜¯ç­‰äºcharb (cur_cost = 0 if chara == charb else 1) stra+charaèƒ½è½¬æˆstrb, é‚£ä¹ˆè¦è®©stra + chara è½¬æˆstrb+ charb, åªéœ€è¦æ’å…¥charbå°±è¡Œäº† å¦‚æœstra å¯ä»¥ç›´æ¥è½¬æˆstrb+charbï¼Œé‚£ä¹ˆåˆ é™¤charaå°±å¯ä»¥è½¬æ¢æˆåŠŸäº† ç»¼ä¸Šçš„åˆ†æï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹DPå…¬å¼ï¼š\n|-- 0, (i=0, j=0) |-- j, (i=0, j\u0026gt;0) edit_dis(i, j) = |-- i, (i\u0026gt;0, j=0) |-- min{edit_dis(i-1, j)+1, edit_dis(i, j-1)+1, edit_dis(i-1, j-1) + cur_cost} # cur_cost = 0 if chara == charb else 1 åˆ°è¿™é‡Œï¼Œå®Œå…¨å¯ä»¥å¼€å§‹åŠ¨æ‰‹å†™ä»£ç äº†ã€‚å¦‚æœè¿˜ä¸æ¸…æ¥šï¼Œå¯ä»¥å‚è€ƒLevenshtein Distance, in Three Flavorsï¼Œé‡Œé¢æœ‰è¯¦ç»†æ­¥éª¤å’Œåˆ†æ\nç¼–ç åŠæµ‹è¯• # ä½¿ç”¨Golangç¼–ç LevenshteinDistanceå¦‚ä¸‹ï¼š\nfunc LevenshteinDistance(source, dest string) int { var cols, rows int = len(source), len(dest) if cols == 0 { return rows } if rows == 0 { return cols } var ld *LD = \u0026amp;LD{Rows: rows, Cols: cols} ld.constructMatrix() // åˆå§‹åŒ–äºŒç»´çŸ©é˜µ // PrintMatrix(ld.M) // step 5 for c := 1; c \u0026lt;= cols; c++ { for r := 1; r \u0026lt;= rows; r++ { var cur_cost int = 1 if source[c-1] == dest[r-1] { cur_cost = 0 } // step 6 cost := minOfThree(ld.M[r-1][c-1]+cur_cost, ld.M[r-1][c]+1, ld.M[r][c-1]+1) // step 7 ld.setMatrix(cost, r, c) } } PrintMatrix(ld.M) return ld.M[rows][cols] } åšäº†ç®€å•çš„åˆ’åˆ†ï¼Œè®©ç®—æ³•çœ‹èµ·æ¥æ›´æ¸…æ™°ï¼Œè¿™é‡Œæ˜¯æ”¾å…¥äº†ä¸€èˆ¬æƒ…å†µçš„å¤„ç†ã€‚\næµ‹è¯•ä»£ç åŠæµ‹è¯•ç»“æœæˆªå›¾ï¼š\n// ... func Test_PrintMatrix(t *testing.T) { m := Matrix{ {1, 2, 3, 4}, {1, 2, 3, 4}, {1, 2, 3, 4}, {1, 2, 3, 4}, {1, 2, 3, 4}, {1, 2, 3, 4}, {1, 2, 3, 4}, } PrintMatrix(m) } func Test_LD_ConstructMatrix(t *testing.T) { ld := \u0026amp;LD{Rows: 3, Cols: 6} ld.constructMatrix() if len(ld.M[0]) != 7 { t.Fatal(\u0026#34;ConstructMatrix make a wrong matrix with cols\u0026#34;) } if len(ld.M) != 4 { t.Fatal(\u0026#34;ConstructMatrix make a wrong matrix with rows\u0026#34;) } // display PrintMatrix(ld.M) } func Test_LevenshteinDistance(t *testing.T) { source := \u0026#34;GUMBO\u0026#34; dest := \u0026#34;GAMBOL\u0026#34; dis := LevenshteinDistance(source, dest) if dis != 2 { t.Fatalf(\u0026#34;wrong dis is got, %d, actual: %d\u0026#34;, dis, 2) } } func Test_LevenshteinDistance_case1(t *testing.T) { source := \u0026#34;\u0026#34; dest := \u0026#34;GAMBOL\u0026#34; dis := LevenshteinDistance(source, dest) if dis != 6 { t.Fatalf(\u0026#34;wrong dis is got, %d, actual: %d\u0026#34;, dis, 2) } } func Test_LevenshteinDistance_case2(t *testing.T) { source := \u0026#34;GUMBO\u0026#34; dest := \u0026#34;\u0026#34; dis := LevenshteinDistance(source, dest) if dis != 5 { t.Fatalf(\u0026#34;wrong dis is got, %d, actual: %d\u0026#34;, dis, 2) } } func Test_LevenshteinDistance_case3(t *testing.T) { source := \u0026#34;GUMBO\u0026#34; dest := \u0026#34;GUMBO\u0026#34; dis := LevenshteinDistance(source, dest) if dis != 0 { t.Fatalf(\u0026#34;wrong dis is got, %d, actual: %d\u0026#34;, dis, 2) } } func Test_LevenshteinDistance_case4(t *testing.T) { source := \u0026#34;\u0026#34; dest := \u0026#34;\u0026#34; dis := LevenshteinDistance(source, dest) if dis != 0 { t.Fatalf(\u0026#34;wrong dis is got, %d, actual: %d\u0026#34;, dis, 2) } } å‚è€ƒèµ„æ–™ # ç¼–è¾‘è·ç¦»-æ˜æ— æ¢¦çš„åšå®¢ æ–‡ç« ä¸­é‡‡ç”¨äº†ä¸¤ç§æ–¹æ³•ï¼ˆåˆ†æ²»ï¼ŒåŠ¨æ€è§„åˆ’ï¼‰æ¥è§£å†³ç¼–è¾‘è·ç¦»çš„é—®é¢˜ å­—ç¬¦ä¸²ç¼–è¾‘è·ç¦»è¯¦è§£-èœé¸ŸåŠ è´çš„çˆ¬å‡ Levenshtein Distance, in Three Flavors ä»£ç åœ°å€ # github.com/yeqown/alg/dp/levenshtein_dis.go github.com/yeqown/alg/dp/levenshtein_dis_test.go\n"},{"id":61,"href":"/2018/01/29/ShortURL%E7%94%9F%E6%88%90%E7%B3%BB%E7%BB%9F/","title":"ShortURLç³»ç»Ÿå®ç°","section":"Posts","content":"åœ¨çŸ¥ä¹ä¸Šçœ‹äº†ä¸€ä¸ªå¾ˆæœ‰å¯å‘çš„å›ç­”ï¼Œå› æ­¤å®é™…åŠ¨æ‰‹æ¥å®ç°çŸ­URLç”Ÿæˆç³»ç»Ÿã€‚è´´ä¸Šé“¾æ¥ï¼š çŸ¥ä¹ - çŸ­URLç³»ç»Ÿæ˜¯å¦‚ä½•è®¾è®¡çš„ã€‚å…¶ä¸­æåˆ°äº†ï¼Œè¦å®ç°çŸ­URLç”Ÿæˆç³»ç»Ÿè¦è§£å†³çš„é—®é¢˜æœ‰ï¼š\nå¦‚ä½•ä¼˜é›…çš„å®ç°ï¼Ÿ æ€ä¹ˆåŸºæœ¬å®ç°é•¿å¯¹çŸ­ã€ä¸€å¯¹ä¸€ï¼Ÿ å¦‚ä½•å®ç°åˆ†å¸ƒå¼ï¼Œé«˜å¹¶å‘ï¼Œé«˜å¯ç”¨ï¼Ÿ å‚¨å­˜é€‰ç”¨ï¼Ÿ åŸºæœ¬åŸç† # æ•°æ®åº“è‡ªå¢IDè½¬æ¢62è¿›åˆ¶\nä½¿ç”¨è‡ªå¢IDä¸ä¼šäº§ç”Ÿé‡å¤çš„çŸ­é“¾æ¥ã€‚ ä¸ºäº†è§£å†³è‡ªå¢IDè¶…é•¿å’Œä¸ä¾¿è®°å¿†ï¼Œå¯¹IDè¿›è¡Œ62è¿›åˆ¶ç¼–ç ã€‚æ‰€è°“62è¿›åˆ¶å°±æ˜¯0-9ï¼Œa-zï¼ŒA-Zã€‚ ç®€å•è®¡ç®—ä¸‹ï¼š\n62 ^ 4 = 14,776,336 62 ^ 5 = 916,132,832 62 ^ 6 = 56,800,235,584 // å·²ç»è¶³å¤Ÿä½¿ç”¨äº† æ€»ä½“ç»“æ„åŠå¤„ç†æµç¨‹ # é•¿é“¾æ¥å¤„ç†æµç¨‹ # è·å–å‚æ•°ï¼Œè°ƒç”¨shortURLæœåŠ¡ å°è¯•ä»ç¼“å­˜ä¸­è·å–ï¼Œå¦‚æœå‘½ä¸­ï¼Œåˆ™è¯»å–çŸ­é“¾æ¥(é‡ç½®è¿‡æœŸæ—¶é—´)ã€‚è·³è½¬ç¬¬4æ­¥ å°†é•¿é“¾æ¥å­˜å‚¨åˆ°Mysqlæ•°æ®åº“ï¼Œæ ¹æ®IDè¿›è¡Œbase62ç¼–ç ï¼Œç»„è£…Domain+Encodedå­—ç¬¦ä¸²å¹¶æ›´æ–°æ•°æ®åº“ è¿”å›ç”Ÿæˆçš„çŸ­é“¾æ¥ çŸ­é“¾æ¥å¤„ç†æµç¨‹ # è§£æçŸ­é“¾æ¥ä¸ºID æŸ¥è¯¢IDå¯¹åº”çš„é•¿é“¾æ¥ ä»¥301æ–¹å¼è·³è½¬åˆ°é•¿é“¾æ¥ é•¿é“¾æ¥ä¸çŸ­é“¾æ¥çš„å¯¹åº”å…³ç³» # ä¸€å¯¹å¤šï¼Œä¸€ä¸ªé•¿é“¾æ¥å¯èƒ½å¯¹åº”å¤šä¸ªçŸ­é“¾æ¥ã€‚æ•°æ®è¡¨å­˜å‚¨ç»“æ„å¦‚ä¸‹ï¼š\n+-----------+--------------+------+-----+---------+----------------+ | Field | Type | Null | Key | Default | Extra | +-----------+--------------+------+-----+---------+----------------+ | id | int(64) | NO | PRI | NULL | auto_increment | | long_url | varchar(100) | NO | | NULL | | | short_url | varchar(40) | YES | | NULL | | +-----------+--------------+------+-----+---------+----------------+ åˆ†å¸ƒå¼å’Œé«˜å¹¶å‘è®¾è®¡ # ###æ³¨ï¼šè¿™éƒ¨åˆ†æœªå®ç°ã€‚æˆ‘çš„æ€è·¯å¦‚ä¸‹ï¼š\nåˆ†å¸ƒå¼éƒ¨ç½²ä¼šé‡åˆ°çš„é—®é¢˜\u0026quot;IDé‡å¤\u0026quot;ï¼Œå…³äºè¿™ä¸€ç‚¹åœ¨å›ç­”ä¸­ä¹Ÿæç¤ºäº†ï¼šæ ¹æ®nodeæ•°æ¥é…ç½®è‡ªå¢stepã€‚è­¬å¦‚è¯´ï¼Œæœ‰1000ä¸ªnodeï¼š\n|èŠ‚ç‚¹|1st-URL-ID|2nd-URL-ID|3th-URL-ID|\u0026hellip;|Nth-URL-ID| |\u0026mdash;|\u0026mdash;|\u0026mdash;|\u0026mdash;-|\u0026mdash;-| |node-1|0|1000|2000|\u0026hellip;| 0 + (N-1) * 1000| |||||\u0026hellip;.|| |node-1000|999|1999|2999|\u0026hellip;|999 + (N-1) * 1000|\næµ‹è¯• # å•å…ƒæµ‹è¯•ï¼ˆä¸å†™å•å…ƒæµ‹è¯•ä¸å‡†push!!ï¼‰ # âœ _shorturl git:(master) âœ— go test -v === RUN Test_Encode --- PASS: Test_Encode (0.00s) === RUN Test_Decode --- PASS: Test_Decode (0.00s) === RUN Test_ProcessEncodeThenDecode --- PASS: Test_ProcessEncodeThenDecode (0.00s) === RUN Test_SetUrlCache --- PASS: Test_SetUrlCache (0.01s) === RUN Test_LoadConfig --- PASS: Test_LoadConfig (0.00s) === RUN Test_GetInstance --- PASS: Test_GetInstance (0.00s) === RUN Test_Insert --- PASS: Test_Insert (0.08s) === RUN Test_QueryUrl --- PASS: Test_QueryUrl (0.02s) === RUN Test_Update --- PASS: Test_Update (0.00s) === RUN Test_RegRouter --- PASS: Test_RegRouter (0.00s) === RUN Test_ShortenAndParse 2018/02/01 11:23:28 deal with url: http://www.baidu.com --- PASS: Test_ShortenAndParse (0.02s) === RUN Test_ConnectDB --- PASS: Test_ConnectDB (0.00s) === RUN Test_GetDB --- PASS: Test_GetDB (0.00s) === RUN Test_CloseConnection --- PASS: Test_CloseConnection (0.00s) PASS ok shorturl/_shorturl\t0.157s åŠŸèƒ½æµ‹è¯• # {% dplayer \u0026ldquo;url=/mov/æ¼”ç¤ºçŸ­é“¾æ¥åŠŸèƒ½.mov\u0026rdquo; \u0026ldquo;loop=no\u0026rdquo; \u0026ldquo;theme=#FADFA3\u0026rdquo; \u0026ldquo;autoplay=false\u0026rdquo; \u0026ldquo;token=tokendemo\u0026rdquo; %}\næ€§èƒ½æµ‹è¯• # æœªä½¿ç”¨åˆ†å¸ƒå¼æµ‹è¯•ç»“æœæˆªå›¾å¦‚ä¸‹ï¼ˆæ²¡æœ‰è¾¾åˆ°æœ€å¤§ååé‡ï¼‰ï¼š å­˜å‚¨é€‰ç”¨ # é€‰æ‹©Mysqlç”¨äºå­˜å‚¨æ•°æ®ï¼ŒRedisä½œä¸ºç¼“å­˜ã€‚\næºç  # github.com/yeqown/shorturl\n"},{"id":62,"href":"/2018/01/27/Golang%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/","title":"GolangæœåŠ¡ç«¯æŠ€æœ¯ç¬”è®°","section":"Posts","content":"æ€»ç»“ä½¿ç”¨Golangå¼€å‘æœåŠ¡ç«¯æ—¶ï¼Œä½¿ç”¨çš„åŸºç¡€çš„å·¥å…·å’Œéƒ¨ç½²æ–¹å¼ã€‚ç”¨äºæ€è€ƒä¸è¶³å¹¶ä¼˜åŒ–ï¼Œæå‡ç¼–ç æ•ˆç‡ã€‚ æ€»ä½“ä¸Šé‡‡ç”¨MVCSçš„è½¯ä»¶æ¨¡å¼ï¼Œå¦‚ä¸‹å›¾ï¼š\nä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒMVCSæ˜¯ä»MVCè¿›åŒ–è€Œæ¥ï¼Œç›¸æ¯”äºMVCï¼Œå¢åŠ äº†Serviceå±‚ã€‚æŠŠä¸šåŠ¡é€»è¾‘ä»Controllerå±‚ä¸­æŠ½ç¦»å‡ºæ¥ï¼Œè¿™æ ·åšçš„å¥½å¤„åœ¨äºï¼Œé¡¹ç›®æ—¥ç›Šåºå¤§ä¹‹åï¼Œå°†æŸäº›åŠŸèƒ½ç‹¬ç«‹å‡ºæ¥ã€‚\nGolangå·¥å…· # \u0026ldquo;gvt\u0026rdquo; ä¾èµ–ç®¡ç†å·¥å…· \u0026ldquo;httprouter\u0026rdquo; è·¯ç”±åŠä¸­é—´ä»¶é…ç½® \u0026ldquo;schema\u0026rdquo; è§£æè¯·æ±‚å‚æ•°åˆ°ç»“æ„ä½“ \u0026ldquo;beego/validation\u0026rdquo; ç»“æ„ä½“æ ¡éªŒå·¥å…· \u0026ldquo;github.com/go-redis/redis\u0026rdquo; redisæ“ä½œåº“ \u0026ldquo;github.com/go-sql-driver/mysql\u0026rdquo; Mysql Driver\næ–‡ä»¶ç»“æ„ # --Golang Project |-sh # shellè„šæœ¬ï¼ŒåŒ…æ‹¬æ•°æ®åº“è„šæœ¬ |-config # é…ç½®æ–‡ä»¶ |-logs # æ—¥å¿—æ–‡ä»¶ |-vendor # é¡¹ç›®æºç åŠä¾èµ– | |-github.com # | |-mainfest # gvt ä¾èµ–ç®¡ç†æ–‡ä»¶ | |-app | |-utils | |-controllers | |-models | |-route | |-services |-Dockerfile # dockeræ„å»ºé•œåƒé…ç½®æ–‡ä»¶ |-docker-compose.yml # docker-compose.ymlæ–‡ä»¶ `-entry.go # webæœåŠ¡å…¥å£æ–‡ä»¶ éƒ¨ç½²æ–¹å¼ # é‡‡ç”¨dockeræ¥éƒ¨ç½²åº”ç”¨ã€‚åˆ†åˆ«ç¼–å†™Dockerfileå’Œdocker-composer.ymlæ–‡ä»¶ï¼Œå®ä¾‹å¦‚ä¸‹ï¼š\nDockerfile # #### # build #### FROM golang:1.9-alpine AS build WORKDIR /go/src/web-server COPY ./entry.go ./ COPY ./vendor ./vendor RUN CGO_ENABLED=0 GOOS=linux ARCH=amd64 go build -o web-server entry.go #### # deploy #### FROM alpine WORKDIR /usr/src/web-server COPY --from=build /go/src/web-server/web-server ./ COPY ./config ./ RUN mkdir ./logs EXPOSE 9090 # CMD [\u0026#34;./web-server\u0026#34;, \u0026#34;--conf ./config/config.json\u0026#34;] æ‰“åŒ…é•œåƒçš„æ–¹æ³•å¦‚ä¸‹ï¼š docker build -t web-server:release . -f Dockerfile\ndocker-compose.ymlé…ç½® # version: \u0026#34;2\u0026#34; services: web: image: web-server:release container_name: ${SERVER_NAME} links: - postgres:postgres volumes: - ./logs:/usr/src/web-server/logs ports: - 9090:9090 postgres: image: postgres:9.4 container_name: postgres volumes: - ./postgresql:/var/lib/postgresql/data ports: - 5432:5432 environment: POSTGRES_PASSWORD: ${USER_PWD} POSTGRES_USER: ${USER} POSTGRES_DB: ${$DB_NAME} ç®€å•è§£é‡Šï¼š\nlinksï¼šé‡‡ç”¨å®¹å™¨å†…è”çš„æ–¹å¼æ¥é€šä¿¡ï¼Œå¦‚æ­¤ä¾¿å¯ä»¥åœ¨web-serverå®¹å™¨ä¸­ï¼Œè®¿é—®HOST=postgresæ¥è®¿é—®postgresqlæ•°æ®åº“ volumesï¼šæŒ‚è½½å®¿ä¸»æœºä¸Šæ–‡ä»¶æˆ–è€…æ–‡ä»¶å¤¹åˆ°å®¹å™¨å†…ï¼Œä»¥ä¾¿å®Œæˆæ•°æ®æŒä¹…åŒ–\næ•°æ®åº“é€‰æ‹© # no Sqlé€‰ç”¨Mongoï¼ŒRedisï¼ˆç¼“å­˜ç³»ç»Ÿï¼‰\nSqlé€‰ç”¨Postgreæˆ–è€…MySql\n"},{"id":63,"href":"/2018/01/27/Drone%E4%BD%93%E9%AA%8C/","title":"Droneä½“éªŒ","section":"Posts","content":"ç›¸è¾ƒäºJenkinsï¼ŒGitlab-CI\u0026hellip;ç­‰ï¼Œå°è¯•Droneçš„é¦–è¦åŸå› æ˜¯ï¼Œå¤©ç”Ÿçš„dockeræ”¯æŒã€‚ä¸ç”¨å»æ“å¿ƒéƒ¨ç½²CIæˆ–è€…CDçš„ç¯å¢ƒé…ç½®ç­‰ç­‰çƒ¦å¿ƒäº‹ã€‚åªéœ€è¦ä¸Šæ‰‹ï¼Œå¦‚ä½•é…ç½®è¿™ä¸ªCDå·¥å…·ï¼Œè®©æˆ‘ä½¿ç”¨æ›´åŠ ç•…å¿«å’Œé¡ºæ‰‹ã€‚\nå®‰è£…éƒ¨ç½² # å‰æï¼šå·²ç»å®‰è£…äº†dockerï¼Œdocker-composeï¼Œå¹¶åŸºæœ¬æŒæ¡dockerç”¨æ³•ï¼ŒåŸºæœ¬ç†Ÿæ‚‰docker-composeé…ç½®æ–‡ä»¶\npullé•œåƒ # docker pull drone/drone:0.8 # droner-server é•œåƒ docker pull dorner/agent:0.8 # drone-agent é•œåƒ ä¹Ÿå¯ä»¥è·³è¿‡è¿™ä¸€æ­¥ï¼Œdockerè¿è¡Œçš„æ—¶å€™ï¼Œå¦‚æœåŒ¹é…ä¸åˆ°æœ¬åœ°é•œåƒï¼Œä¼šè‡ªåŠ¨æ‹‰å–ã€‚\ndocker-compose.ymlé…ç½®æ–‡ä»¶ # ä¸ºäº†æ–¹ä¾¿ï¼Œæ–°å»ºä¸€ä¸ªDroneæ–‡ä»¶å¤¹ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹ï¼š\n--Drone # æ–‡ä»¶å¤¹ |---docker-compose.yml # docker-compose é…ç½®æ–‡ä»¶ |---data # ç”¨äºæŒ‚è½½çš„æ•°æ®æ–‡ä»¶ |---drone.domain.com # nginx sever é…ç½®æ–‡ä»¶ `---other.file # å…¶ä»–æ–‡ä»¶ å·²çŸ¥æ–‡ä»¶ç»“æ„åï¼Œç¼–å†™çš„docker-compose.ymlæ–‡ä»¶å¦‚ä¸‹ï¼š\nversion: \u0026#39;2\u0026#39; services: drone-server: image: drone/drone:0.8 container_name: drone-server ports: - 8000:8000 - 9000:9000 volumes: - ./data:/var/lib/drone/ # åœ¨æ²¡æœ‰è·Ÿæ•°æ®åº“ç»‘å®šçš„æƒ…å†µä¸‹ï¼Œé»˜è®¤ä½¿ç”¨sqliteæ•°æ®åº“ restart: always environment: - DRONE_OPEN=false - DRONE_HOST=http://127.0.0.1:8000 # æœ€å¥½æ˜¯åœ¨æœåŠ¡å™¨ä¸Šï¼Œlocalhostæ— æ³•æ”¶åˆ°webhookçš„é€šçŸ¥ - DRONE_ADMIN=yourname - DRONE_GITHUB=true - DRONE_GITHUB_CLIENT=7bc7971bxxxxx # éœ€è¦é¢„å…ˆæ³¨å†Œä¸€ä¸ªgithub oauthåº”ç”¨ - DRONE_GITHUB_SECRET=9456c630xxxxxxxxxxxxxx - DRONE_SECRET=secret - DRONE_DEBUG=false drone-agent: image: drone/agent:0.8 container_name: drone-agent command: agent restart: always depends_on: - drone-server volumes: - /var/run/docker.sock:/var/run/docker.sock environment: - DRONE_SERVER=drone-server:9000 - DRONE_SECRET=secret - DRONE_DEBUG=true å¯åŠ¨Drone # å¯åŠ¨å°±å¾ˆç®€å•äº†ï¼ŒDroneç›®å½•ä¸‹æ‰§è¡Œï¼šdocker-compose up -dï¼Œå¯åŠ¨ç»“æœæˆªå›¾å¦‚ä¸‹ï¼š å¦‚æœæ˜¯é¦–æ¬¡æ‰“å¼€ï¼Œä¼šå…ˆå»githubè¯·æ±‚æˆæƒï¼Œç„¶åå›è°ƒschema://drone.your_domain.com/authorizeï¼Œå¦‚æˆªå›¾ï¼š å…¶ä»–é…ç½® # è¿™éƒ¨åˆ†å°±å‚è§å®˜æ–¹æ–‡æ¡£äº†\nç»ˆæ­¢ # åˆ°è¿™é‡Œä¹Ÿåªæ˜¯å®Œæˆäº†ï¼Œé…ç½®å’Œè¿è¡Œï¼Œä½†æ˜¯CIå’ŒCDçš„åŠŸèƒ½ï¼Œç”±äºæœåŠ¡å™¨å…³ç³»æ²¡æœ‰æ·±å…¥ã€‚ç¨ç¨å°è¯•äº†ä¸€ä¸‹ï¼š\nåœ¨è‡ªå·±çš„Repoä¸­åŠ å…¥.drone.ymlé…ç½®æ–‡ä»¶ è®¾ç½®å¥½è§¦å‘æ¡ä»¶ï¼ˆå¦‚ï¼Œpushï¼Œmergeï¼‰ pushä»£ç è§¦å‘ï¼Œè¿™æ—¶å€™åˆ·æ–°é¡µé¢ï¼Œä¾¿èƒ½çœ‹è§ï¼ŒDroneçš„pipelineå¤„äºè¿è¡Œä¸­ ç„¶è€Œä¹Ÿæ²¡é‚£ä¹ˆé¡ºå¿ƒ # è¯šç„¶Droneå®‰è£…éƒ¨ç½²æ¯”å…¶ä»–CIå·¥å…·ç®€å•å¾ˆå¤šï¼Œä½†æ˜¯åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¹Ÿé‡è§äº†ä¸è¶³ï¼š\næ–‡æ¡£ä¸è¶³ï¼Œæ˜¾å¾—ç²—ç‡¥ï¼Œç½‘ä¸Šä¹Ÿæ²¡æœ‰å¤ªå¤šçš„æ•™ç¨‹æ–‡æ¡£ã€‚ å¯¹äºgitlabå¹¶éå®Œå…¨æ”¯æŒã€‚ç²¾åŠ›æœ‰é™ï¼Œåªå°è¯•äº†gitlabå’Œgithubï¼Œå…¶ä¸­gitlab API=v3,v4 å‡æœªæˆåŠŸï¼Œgithubä¸€æ¬¡æˆåŠŸã€‚ ç›¸è¾ƒäºJenkinsï¼ŒDroneä¼¼ä¹æ²¡æœ‰ä¸»åŠ¨æ‰§è¡Œæ„å»ºçš„å¯èƒ½æ€§ã€‚å¯ä»¥å‚è§Droneä¸Jenkinsçš„ä¼˜åŠ£ Droneä¸Jenkinsçš„ä¼˜åŠ£ # å¯¹æ¯”é¡¹ Jenkins Drone å®‰è£…éƒ¨ç½² ä¸€èˆ¬ï¼ˆå¦‚æœä¸é‡‡ç”¨dockeréƒ¨ç½²ï¼‰ éå¸¸ç®€å• é…ç½®å¤æ‚åº¦ å¤æ‚ï¼Œéœ€è¦è¿›è¡Œæ’ä»¶é…ç½®ï¼Œè´¦æˆ·ç®¡ç†.. ä¸€ä¸ªé…ç½®æ–‡ä»¶ æƒé™ç®¡ç† ç‹¬ç«‹ ä¾èµ–VCS èƒ½å¦æ‰‹åŠ¨è§¦å‘ èƒ½ ä¸èƒ½ æ˜¯å¦æ”¯æŒpipeline ä¸æ”¯æŒ æ”¯æŒ ç•Œé¢å¤æ‚ç¨‹åº¦ å¤æ‚ ç®€å• å¼€å‘è¯­è¨€ Java Golang æ˜¯å¦æ”¯æŒdockeréƒ¨ç½² æ”¯æŒ æ”¯æŒ æ„å»ºæ—¶å¯¹ç¯å¢ƒä¾èµ–ç¨‹åº¦ è„šæœ¬+docker å…¨ç¨‹åœ¨dockerä¸­ Droneç®€å•ä½¿ç”¨ # ç©è…»äº†Jenkinsï¼Œä¹Ÿæ¥ç©ç©Drone CI\næœ€å # ç›¸æ¯”è€ç‰ŒCIï¼Œä»æ”¯æŒå’Œç¨³å®šæ€§ä¸Šæ¥è¯´ï¼Œéƒ½è¿˜å·®ä¸€äº›ã€‚ä¸å»ºè®®ç”¨äºç”Ÿäº§ï¼ˆå¤§ç‰›é™¤å¤–ï¼‰ï¼ŒæœŸå¾…è¶Šæ¥è¶Šå¥½å§ï¼ï¼ï¼\n"},{"id":64,"href":"/2018/01/24/Docker-Compose%E4%B8%8A%E6%89%8B/","title":"docker-composeä¸Šæ‰‹","section":"Posts","content":"docker compose ç”¨äºå¿«é€Ÿåœ¨é›†ç¾¤ä¸­éƒ¨ç½²åˆ†å¸ƒå¼åº”ç”¨ã€‚æŒ‰æˆ‘çš„ç†è§£ä¹Ÿå¯ä»¥ç”¨äºç®€åŒ–éƒ¨ç½²å•ä¸ªåº”ç”¨ã€‚è­¬å¦‚æˆ‘è¦ä½¿ç”¨dock erå¯åŠ¨ä¸€ä¸ªnginxæœåŠ¡ï¼Œéœ€è¦åšç«¯å£æ˜ å°„ï¼ŒæŒ‚è½½æ•°æ®æ–‡ä»¶ï¼ŒæŒ‡å®šé•œåƒ\u0026hellip;ç­‰ç­‰ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥å°†å¯åŠ¨å®¹å™¨çš„å‘½ä»¤æ•´åˆåˆ°docker-compose.ymlæ–‡ä»¶ä¸­ï¼Œå¯ä»¥åœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œç¬é—´å°±å®Œæˆäº†nginxçš„å®‰è£…åŠé…ç½®ï¼Œå†ä¹Ÿä¸ç”¨å»ç¼–è¯‘ï¼Œè§£å†³ç¯å¢ƒä¾èµ–äº†ï¼Œè¿™ç§æ„Ÿè§‰å®åœ¨æ˜¯å¤ªçˆ½äº†ï¼ï¼ï¼\nå®‰è£… # ä½¿ç”¨pip pip install docker-compose ä»å®˜æ–¹Github Releaseä¸‹è½½äºŒè¿›åˆ¶åŒ…æ–‡ä»¶ å…¶ä»–æ–¹æ³•ç•¥å» ä½¿ç”¨åœºæ™¯ # åœ¨æ—¥å¸¸å·¥ä½œä¸­ï¼Œç»å¸¸ä¼šç¢°åˆ°éœ€è¦å¤šä¸ªå®¹å™¨ç›¸äº’é…åˆæ¥å®ŒæˆæŸé¡¹ä»»åŠ¡çš„æƒ…å†µã€‚ä¾‹å¦‚è¦å®ç°ä¸€ä¸ª Web é¡¹ç›®ï¼Œé™¤äº† Web æœåŠ¡å®¹å™¨æœ¬èº«ï¼Œå¾€å¾€è¿˜éœ€è¦å†åŠ ä¸Šåç«¯çš„æ•°æ®åº“æœåŠ¡å®¹å™¨ï¼Œç”šè‡³è¿˜åŒ…æ‹¬è´Ÿè½½å‡è¡¡å®¹å™¨ç­‰ã€‚\nå®æˆ˜åœºæ™¯ # éœ€è¦éƒ¨ç½²çš„é¡¹ç›®ï¼Œåªæœ‰ä¸¤ä¸ªdockerå®¹å™¨ï¼Œä¸€ä¸ªserverï¼Œä¸€ä¸ªdbã€‚ä¸€èˆ¬çš„éƒ¨ç½²æ–¹å¼æ˜¯ï¼Œåˆ†åˆ«å¯åŠ¨ä¸¤ä¸ªå®¹å™¨ï¼Œå®¹å™¨é—´é€šè¿‡äº’è”çš„æ–¹å¼é€šä¿¡ï¼š\nsudo docker run --rm -p 5433:5432 --name postgres -e POSTGRES_PASSWORD=minepwd -e POSTGRES_USER=mineusr -d postgres sudo docker run --rm -p 9091:9091 --link postgres:postgres --name mineserver -d me/mineserver è¿™ä¸¤æ¡å‘½ä»¤è¿˜æ˜¯æœ‰æŒºéº»çƒ¦çš„ï¼Œå¦‚æœè®°ä¸ä½ï¼Œå½“ç„¶å¯ä»¥ç”¨shellè„šæœ¬æ¥è¿è¡Œï¼Œå¯ä»¥å¦‚æœå…¶ä¸­æŸä¸€ä¸ªæœåŠ¡æ— æ³•å¦‚æœŸè¿è¡Œã€‚ã€‚ã€‚å°±å¾ˆç›‘ä»‹äº†ã€‚è¿™æ—¶å€™å°±å¯ä»¥å¼•å…¥docker-composeäº†ã€‚\nç¼–å†™docker-compose.ymlæ¥éƒ¨ç½²é¡¹ç›® # version: \u0026#34;2\u0026#34; # æŒ‡å®šdocker-composeç‰ˆæœ¬ services: # é¡¹ç›®ä¾èµ–çš„æœåŠ¡ postgres: # æœåŠ¡åå­— image: postgres # æœåŠ¡éœ€è¦çš„dockeré•œåƒä¸docker runå‘½ä»¤ä¸­çš„é•œåƒæŒ‡å®šæ–¹å¼ä¸€è‡´ volumes: # æŒ‚è½½å·ï¼Œè¿™é‡Œçš„ä¸»è¦ç›®çš„æ˜¯ï¼Œæ–¹ä¾¿åŒæ­¥æ•°æ®åº“å’Œæ•°æ®è„šæœ¬ - ./postgres:/var/lib/postgresql/data - ./sh:/usr/src/sh ports: # ç«¯å£ç»‘å®š - 5433:5432 container_name: postgres environment: # è®¾ç½®ç¯å¢ƒå˜é‡ POSTGRES_PASSWORD: \u0026#34;minepwd\u0026#34; POSTGRES_USER: \u0026#34;mineusr\u0026#34; POSTGRES_DB: \u0026#34;minedb\u0026#34; mineserver: image: me/mineserver volumes: # æŒ‚è½½å·ï¼Œæ–¹ä¾¿æŸ¥çœ‹è¾“å‡ºæ—¥å¿— - ./logs:/usr/src/mineserver/logs ports: - 9091:9091 container_name: mineserver links: # å®¹å™¨äº’è” - postgres:postgres åœ¨ç¼–å†™docker-compose.ymlçš„æ—¶å€™ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å„ä¸ªé€‰é¡¹çš„æ•°æ®ç±»å‹ï¼Œä¸è¿‡docker-composeä¼šæœ‰æç¤ºï¼Œä¹Ÿå¾ˆæ–¹ä¾¿\nè¿™æ ·ç¼–å†™ä¹‹åï¼Œå¯ä»¥ç›´æ¥è¿è¡Œdocker-compose upå°±å¯ä»¥å¯åŠ¨ä¸¤ä¸ªå®¹å™¨äº†ã€‚è¾“å‡ºå¦‚ä¸‹ï¼š\nâœ mineserver git:(yeqown) docker-compose up Starting postgres ... done Starting mineserver ... done Attaching to postgres, mineserver mineserver | 2018/01/25 06:28:02 Loading config: ./configs/config.json mineserver | 2018/01/25 06:28:02 init all logger done mineserver | 2018/01/25 06:28:02 host=postgres user=mineusr dbname=minedb sslmode=disable password=minepwd mineserver | panic: dial tcp 172.18.0.2:5432: getsockopt: connection refused mineserver | mineserver | goroutine 1 [running]: mineserver | mineserver/vendor/app/models.ConnPgsql(0xc4200127d0, 0x4a) mineserver | /go/src/mineserver/vendor/app/models/pgsql.go:17 +0x28b mineserver | main.main() mineserver | /go/src/mineserver/main.go:32 +0x16d mineserver exited with code 2 postgres | 2018-01-25 06:28:05.360 UTC [1] LOG: listening on IPv4 address \u0026quot;0.0.0.0\u0026quot;, port 5432 postgres | 2018-01-25 06:28:05.360 UTC [1] LOG: listening on IPv6 address \u0026quot;::\u0026quot;, port 5432 postgres | 2018-01-25 06:28:05.363 UTC [1] LOG: listening on Unix socket \u0026quot;/var/run/postgresql/.s.PGSQL.5432\u0026quot; postgres | 2018-01-25 06:28:05.449 UTC [20] LOG: database system was shut down at 2018-01-25 05:48:24 UTC postgres | 2018-01-25 06:28:05.475 UTC [1] LOG: database system is ready to accept connections å¦‚è¾“å‡ºï¼Œä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œmineserverä¾èµ–äºpostgreï¼Œå¯¼è‡´mineserveræ— æ³•æ­£å¸¸å¯åŠ¨ã€‚è§£å†³æ–¹æ¡ˆæœ‰ï¼š 1 é‡å¯minerserverï¼Œdocker-compose start mineserver 2 æ”¹å†™mineserveré“¾æ¥æ•°æ®åº“çš„éƒ¨åˆ†ï¼Œå¢åŠ é‡è¯•æœºåˆ¶ 3 åˆ†æˆå¤šä¸ªdocker-composr.ymlï¼ŒæŒ‰ä¾èµ–å…³ç³»æ¥åˆ†å…ˆåå¯åŠ¨ 4 æ·»åŠ ä¾èµ–å…³ç³»æ¥æ§åˆ¶å¯åŠ¨é¡ºåºï¼Œæ–°å¢depends_oné€‰é¡¹å¦‚ä¸‹ï¼š\n# docker-compose.yml ... mineserver: ... depends_on: # ä¾èµ–å…³ç³» - postgres links: # å®¹å™¨äº’è” - postgres:postgres ä½†æ˜¯ï¼Œä¹Ÿæ²¡æœ‰åŠæ³•çŸ¥é“è¢«ä¾èµ–çš„æœåŠ¡æ˜¯ä¸æ˜¯å¯åŠ¨æˆåŠŸäº†ï¼Œæ‰€ä»¥åœ¨å¿…é¡»ä¾èµ–çš„æ—¶å€™åè¿˜æ˜¯ä¼šæœ‰é—®é¢˜ 5 å‚è§å®˜ç½‘è§£å†³æ–¹æ¡ˆï¼Œå¢åŠ ä¸€ä¸ªwait-for-it.shã€‚ docker-compose.yml æ–‡ä»¶å¦‚ä¸‹ï¼š\n# docker-compose.yml ... mineserver: ... depends_on: # ä¾èµ–å…³ç³» - postgres links: # å®¹å™¨äº’è” - postgres:postgres command: [\u0026#34;./wait-postgres.sh\u0026#34;, \u0026#34;./mineserver\u0026#34;] # ç»“åˆwait-postgres.shç†è§£ wait-postgres.sh æ–‡ä»¶å¦‚ä¸‹ï¼š\n#!/bin/sh # wait-postgre.sh host=\u0026#34;postgres\u0026#34; for i in $(seq 1 10) do nc -z $host 5432 if [[ $? -eq \u0026#34;\u0026#34; ]]; then echo -n . sleep 1 else echo \u0026#34;Postgres is ready\u0026#34; break fi done # execute mineserver, $1 is command that start mineserver $1 # how to use? # command: [\u0026#34;./wait-postgres.sh\u0026#34;, \u0026#34;./imetro-server\u0026#34;] å…³äº5thï¼Œéœ€è¦æ³¨æ„çš„è¦æ³¨æ„wait-for-it.sh, éœ€è¦æ”¾åˆ°æœåŠ¡é•œåƒä¸­å»ï¼›è¦æ ¹æ®serveré•œåƒä¸­çš„shellæ¥æŒ‡å®šshï¼Œè­¬å¦‚è¯´ï¼Œæˆ‘æœ€å¼€å§‹ä½¿ç”¨çš„æ˜¯bashï¼Œç„¶è€Œbashåœ¨alpineä¸­å¹¶ä¸å­˜åœ¨â€¦â€¦ï¼›å¦å¤–wait-for-it.sh éœ€è¦å¯æ‰§è¡Œæƒé™å“¦ã€‚\nå…³äºdocker-compose.ymlçš„å…¶ä»–å‘½ä»¤ # å®˜æ–¹æ–‡æ¡£æˆ–è€…Dockerå…¥é—¨åˆ°å®è·µå·²ç»è®²çš„å¾ˆæ¸…æ¥šäº†\n"},{"id":65,"href":"/2018/01/23/docker-selenium-python%E6%9E%84%E5%BB%BA%E5%89%8D%E7%AB%AF%E8%87%AA%E5%8A%A8%E5%8C%96%E5%88%86%E5%B8%83%E5%BC%8F%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83/","title":"docker+selenium+pythonæ„å»ºå‰ç«¯è‡ªåŠ¨åŒ–åˆ†å¸ƒå¼æµ‹è¯•ç¯å¢ƒ","section":"Posts","content":"docker + selenium + python æ„å»ºå‰ç«¯è‡ªåŠ¨åŒ–åˆ†å¸ƒå¼æµ‹è¯•ç¯å¢ƒã€‚åˆ©ç”¨seleninum-gridåˆ†å¸ƒå¼æ¡†æ¶ï¼Œpythonç¼–å†™æµ‹è¯•ä»£ç ï¼Œdockeréƒ¨ç½²æ¥è¿›è¡Œå‰ç«¯è‡ªåŠ¨åŒ–æµ‹è¯•\n2018-2-1 æ›´æ–° ä½¿ç”¨docker-composeç¼–æ’\nåˆ†å¸ƒå¼éƒ¨ç½²çš„ä¼˜ç‚¹ # è‡ªåŠ¨åŒ–çš„ä¼˜ç¼ºç‚¹å°±ä¸å†é‡å¤äº†ï¼Œä¸»è¦åˆ†æä¸‹dockeéƒ¨ç½²å’Œåˆ†å¸ƒå¼çš„ä¼˜åŠ¿\næé«˜è‡ªåŠ¨åŒ–çš„æµ‹è¯•æ•ˆç‡ï¼ˆåˆ†å¸ƒå¼ï¼‰ æ–¹ä¾¿æ‰“åŒ…å’ŒæŒç»­é›†æˆï¼ˆdockerï¼‰ è§£å†³å¤šäººcodingï¼Œå´å› ä¸ºè·¯å¾„ä¸ä¸€è‡´å¯¼è‡´æ— æ³•è¿è¡Œçš„é—®é¢˜ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼æ¥è§£å†³ï½ï¼‰ è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼šä½¿ç”¨dockeréƒ¨ç½²æ–¹å¼è¿è¡Œæµ‹è¯•ä»£ç ï¼Œæ˜¯çœ‹ä¸è§æœ¬åœ°æµè§ˆå™¨å¯åŠ¨çš„ï¼Œå› æ­¤åœ¨è°ƒè¯•æµ‹è¯•ä»£ç çš„æ—¶å€™ï¼Œéœ€è¦ä¸€å®šçš„å·¥å…·æ¥ååŠ©ï¼Œè­¬å¦‚VNC viewer\nå¼€ç¯‡-selenium # å¤§å®¶éƒ½çŸ¥é“ Selenium æ˜¯æ”¯æŒå¤šç§æµè§ˆå™¨å¤šä¸ªç¼–ç¨‹è¯­è¨€çš„ä¸€ä¸ªè‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·ã€‚è€Œ Selenium Grid æ˜¯ä¸€ç§å¯ä»¥è®©ç”¨æˆ·åœ¨ä¸åŒçš„ç¯å¢ƒå’Œä¸åŒçš„æµè§ˆå™¨ä¸Šå¹¶è¡Œè¿è¡Œ web æµ‹è¯•ç”¨ä¾‹çš„æ¡†æ¶ã€‚æ¢è€Œè¨€ä¹‹ï¼Œä½¿ç”¨ Selenium Grid å¯ä»¥è®©æˆ‘ä»¬åœ¨åˆ†å¸ƒå¼æµ‹è¯•ç¯å¢ƒä¸‹æ‰§è¡Œæµ‹è¯•ï¼Œä¾‹å¦‚ Windowsï¼ŒLinuxï¼ŒMac OSï¼ŒAndoid/iOS ç­‰ç­‰ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§å‡å°‘é‡å¤çš„å·¥ä½œé‡ï¼Œæé«˜æˆ‘ä»¬çš„å·¥ä½œæ•ˆç‡ã€‚\nseleniumåˆ†å¸ƒå¼ç»“æ„å¦‚å›¾ï¼š æ­å»ºåˆ†å¸ƒå¼ç¯å¢ƒ # åœ¨Dockerhubå·²ç»å…·æœ‰äº†ç›¸åº”çš„seleniumçš„é•œåƒï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨å°±è¡Œäº†\næ‹‰å–é•œåƒ # docker pull selenium/hub docker pull selenium/node-chorme-debug å…³äºnode-chrome-debugå’Œnode-chromeçš„åŒºåˆ«ï¼š æš‚æœªç ”ç©¶\nè¿è¡Œå®¹å™¨ # docker run -d -p 4444:4444 --name sel-hub selunium/hub # è¿è¡ŒhubæœåŠ¡ docker run -d -p 5900:5900 --link sel-hub:hub selunium/node-chrome-debug # è¿è¡Œslenium chrome èŠ‚ç‚¹ # more node could append like node-chrome-debug æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯ # åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€http://127.0.0.1:4444/grid/console è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ˜¯åœ¨æœ¬åœ°è¿è¡Œçš„å®¹å™¨ï¼Œå¹¶æ˜ å°„4444ç«¯å£ï¼Œå› æ­¤å¾—åˆ°127.0.0.1:4444ï¼Œå¦‚æœæ˜¯åœ¨è™šæ‹Ÿæœºä¸­è¿è¡Œï¼Œipå’Œç«¯å£åº”è¯¥æ ¹æ®ç½‘ç»œæ¥è·å–ç›¸åº”çš„IPå’ŒPORT\næŸ¥çœ‹å®¹å™¨ # å¯ä»¥ä½¿ç”¨docker ps -aæ¥æŸ¥çœ‹å®¹å™¨çš„çŠ¶æ€ï¼Œç¡®ä¿hubæœåŠ¡å’ŒnodeèŠ‚ç‚¹å·²ç»æˆåŠŸè¿è¡Œäº†\nCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES f2559a691250 selenium/node-chrome-debug \u0026#34;/opt/bin/entry_poinâ€¦\u0026#34; 24 minutes ago Up 24 minutes 0.0.0.0:5900-\u0026gt;5900/tcp vibrant_bardeen 69c8bf2544b8 selenium/hub \u0026#34;/opt/bin/entry_poinâ€¦\u0026#34; 25 minutes ago Up 25 minutes 0.0.0.0:4444-\u0026gt;4444/tcp selenium-hub ç¼–å†™ç®€å•æµ‹è¯•ä»£ç  # å…³äºpython-seleniumçš„ä½¿ç”¨æ–¹æ³•ï¼Œå‚è§http://selenium-python.readthedocs.io/index.html\nOS python selenium MacOS 3.6.5 3.8.0 æµ‹è¯•ä»£ç ä½¿ç”¨pythonç¼–å†™ï¼Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­é‡åˆ°äº†æŠ¥é”™ï¼Œé€šè¿‡å‡çº§python-seleniumç‰ˆæœ¬åˆ°3.8.0è§£å†³\nfrom selenium import webdriver as wd from from selenium.webdriver.common.desired_capabilities import DesiredCapabilities as DC hub_remote_url = \u0026#34;http://127.0.0.1:4444/wd/hub\u0026#34; driver = wd.Remote( command_executor=hub_remote_url, desired_capabilities=DC.CHROME) test_url = \u0026#34;http://www.baidu.com\u0026#34; def test_baidu_screenshot(): driver.get(test_url) driver.save_screenshot(\u0026#34;baidu.png\u0026#34;) print(\u0026#34;save baidu screenshot done\u0026#34;) test_baidu_screenshot() driver.quit() æ‰©å±•-æµ‹è¯•ä»£ç åˆ¶ä½œé•œåƒ # ä½¿ç”¨äº†pytestæµ‹è¯•æ¡†æ¶ æµ‹è¯•ä»£ç çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š\ndocker-test |---lib //pythonè™šæ‹Ÿç¯å¢ƒç›¸å…³ |---bin //pythonè™šæ‹Ÿç¯å¢ƒç›¸å…³ |---include //pythonè™šæ‹Ÿç¯å¢ƒç›¸å…³ |---src | `-æµ‹è¯•ä»£ç ... |---requirements.txt //ä¾èµ–æ¸…å• `---Dockerfile //ç”¨äºè¯´æ˜å¦‚ä½•æ„å»ºä¸€ä¸ªdockeré•œåƒ ç¼–å†™Dockerfile # FROM python:alpine3.6 WORKDIR /usr/src/test COPY requirements.txt ./ COPY src/ ./src RUN pip install --no-cache-dir -r requirements.txt \\ \u0026amp;\u0026amp; find ./src -name \u0026#34;__pycache__\u0026#34; | xargs rm -fr # æ³¨ï¼šåˆ é™¤__pycache__æ–‡ä»¶å¤¹æ˜¯é¿å…æŠŠè°ƒè¯•ç¯å¢ƒçš„å·®å¼‚æ„å»ºåˆ°é•œåƒä¸­ï¼ˆè¯¥å·®å¼‚ä¼šå¯¼è‡´æ— æ³•æ­£ç¡®æ‰§è¡Œï¼‰ ä½¿ç”¨docker-composeç¼–æ’ # åŸºæœ¬ä¸Šå°±æ˜¯å•ä¸ªå®¹å™¨çš„æ‰§è¡Œè½¬æ¢æˆdocker-composeé…ç½®æ–‡ä»¶æ ¼å¼å°±è¡Œäº†\nversion: \u0026#34;2\u0026#34; networks: private: driver: bridge services: hub: image: selenium/hub ports: - 4444:4444 networks: - private chrome: image: selenium/node-chrome ports: - 5900:5900 links: - hub depends_on: - hub # æ³¨æ„è¿™ä¸€ç‚¹ï¼Œå¦‚æœä¸é…ç½®è¿™äº›ç¯å¢ƒå˜é‡ä¼šå¯¼è‡´nodeæ— æ³•æ‰¾åˆ°hubæœåŠ¡ environment: HUB_PORT_4444_TCP_ADDR: hub HUB_PORT_4444_TCP_PORT: 4444 networks: - private æ„å»ºé•œåƒæˆªå›¾ # è¿è¡Œå®¹å™¨æˆªå›¾ # è¿™é‡Œé€‰æ‹©çš„æ˜¯ï¼Œäº¤äº’æ–¹å¼æ‰§è¡Œæµ‹è¯•ä»£ç docker run --rm -it dcoker-test /bin/sh, ä¹Ÿå¯ä»¥ç›´æ¥æ‰§è¡Œpytestæµ‹è¯•docker run --rm docker-test pytest -vï¼Œåªæ˜¯è¿™ç§æ–¹å¼åœ¨è¾“å‡ºæ–¹å¼ä¸Šæ²¡æœ‰ç¬¬ä¸€ç§ç¾è§‚ï¼ˆï½^ï½) æ€»ç»“ # ä½¿ç”¨dockeræå¤§å±è”½äº†éƒ¨ç½²seleniumä¼šé‡åˆ°çš„ç³»ç»Ÿå·®å¼‚é—®é¢˜ï¼Œæ­¥éª¤ç®€æ´ï¼Œæ˜“äºé…ç½®ã€‚ åˆ†å¸ƒå¼éƒ¨ç½²seleniumåˆèƒ½æå‡å‰ç«¯è‡ªåŠ¨åŒ–æµ‹è¯•çš„æ•ˆç‡ï¼Œèƒ½å¤ŸåŒæ—¶è¿è¡Œåœ¨ä¸åŒçš„ç³»ç»Ÿå’Œæµè§ˆå™¨ï¼Œé«˜æ•ˆåˆä¾¿æ·ã€‚ dockeræ‰“åŒ…æµ‹è¯•ä»£ç ï¼Œæ–¹ä¾¿ååŒcodingå’Œè¿è¡Œåœ¨ä¸åŒç³»ç»Ÿç¯å¢ƒï¼Œç®€åŒ–é…ç½®æ–¹æ¡ˆ ç›®å‰é‡åˆ°çš„ä¸è¶³ï¼Œselenium-gridæ¡†æ¶åœ¨æ‰§è¡Œæµ‹è¯•ä»£ç çš„æ—¶å€™ï¼Œè°ƒè¯•ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œéœ€è¦ä¾èµ–å…¶ä»–çš„å·¥å…·(VNCï¼Œè¿æ¥åœ¨ä¸Šæ–¹) åœ¨dockerä¸­è¿è¡Œæµ‹è¯•ï¼Œä¼šé‡åˆ°ä¸­æ–‡å­—ç¬¦ä¹±ç çš„æƒ…å†µï¼Œå¯ä»¥é€šè¿‡æ”¹å†™Dockerfileé‡æ–°æ‰“åŒ…é•œåƒæ¥è§£å†³è¯¥é—®é¢˜ "},{"id":66,"href":"/2018/01/18/docker%E6%8E%A2%E7%B4%A2/","title":"dockeræ¢ç´¢","section":"Posts","content":"docker å­¦ä¹ å®æˆ˜ç¬”è®°ã€‚å…³äºdockerçš„è¯¦ç»†ä¿¡æ¯å‚è§å®˜æ–¹æ–‡æ¡£\nå®æˆ˜ç¯å¢ƒé…ç½®ï¼š\nç³»ç»Ÿ Docker MacOS 17.12.0-ce å®æˆ˜ä¸€ ç®€å•éƒ¨ç½²å¯æ‰§è¡Œæ–‡ä»¶ # æœ¬æ¬¡å®æˆ˜æ˜¯éƒ¨ç½²ä¸€ä¸ªgolangçš„webæœåŠ¡, éœ€è¦mongo, redisæ”¯æŒ\nçœç•¥ä»£ç ï¼Œæ‰“åŒ…è¿‡ç¨‹ï¼ˆMacç”¨æˆ·åˆ«å¿˜äº†æ‰“åŒ…GOOS=linuxï¼Œ0Â·0ï¼‰\nç¼–å†™Dockerfile\nFROM alpine # ç®€ç‰ˆlinux RUN mkdir /app # åœ¨é•œåƒä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ COPY ./webapp /app COPY ./config /app/config COPY ./logs /app/logs EXPOSE 35764 # æš´éœ²35764ç«¯å£ï¼Œä¹Ÿå°±æ˜¯ä¸ºäº†ä»å¤–éƒ¨å¯ä»¥è®¿é—®åˆ°å®¹å™¨ç±»çš„æœåŠ¡ WORKDIR /app # åˆ‡æ¢åˆ°åº”ç”¨æ–‡ä»¶å¤¹ï¼ˆåœ¨é•œåƒæ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨åˆ‡æ¢ï¼‰ æ„å»ºé•œåƒ æ‰§è¡Œå‘½ä»¤ docker build -t tp-api:v1 . æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š\nSending build context to Docker daemon 55.5MB Step 1/7 : FROM alpine ---\u0026gt; 3fd9065eaf02 Step 2/7 : RUN mkdir /app ---\u0026gt; Using cache ---\u0026gt; 6948fdc89bbd Step 3/7 : COPY ./webapp /app ---\u0026gt; Using cache ---\u0026gt; 555307961735 Step 4/7 : COPY ./config /app/config ---\u0026gt; ab15feb5a3ab Step 5/7 : COPY ./logs /app/logs ---\u0026gt; 0055512da60b Step 6/7 : EXPOSE 35764 ---\u0026gt; Running in db0503538961 Removing intermediate container db0503538961 ---\u0026gt; 1d214b7aff6d Step 7/7 : WORKDIR /app Removing intermediate container 42889dd384a7 ---\u0026gt; f0b05bcb428d Successfully built f0b05bcb428d Successfully tagged tp-api:v2 è°ƒè¯•å®¹å™¨ æ‰§è¡Œå‘½ä»¤docker run -it --rm -p 35765:35764 tp-api:v1,ä¼šè¿›å…¥å®¹å™¨äº¤äº’æ¨¡å¼ï¼Œå¦‚ä¸‹ï¼š\n-\u0026gt; /app # -\u0026gt; /app # -\u0026gt; /app # ls config logs webapp -\u0026gt; /app # æ­¤æ—¶è¾“å…¥./webapp å°±å¯ä»¥åœ¨å®¹å™¨å†…è¿è¡Œè¯¥äºŒè¿›åˆ¶æ–‡ä»¶äº†ã€‚\n-\u0026gt; /app # -\u0026gt; /app # -\u0026gt; /app # ls config logs webapp -\u0026gt; /app # ./webapp -\u0026gt; 2018/01/22 07:38:50 loading config from: [ ./config/dev/config.json \u0026amp; ./config/dev/server.json ] -\u0026gt; 2018/01/22 07:38:50 load dbconfig file done -\u0026gt; 2018/01/22 07:38:50 load server config file done -\u0026gt; /app # æ€»ç»“ æœ¬æ¬¡å®æˆ˜é‡åˆ°çš„é—®é¢˜æœ‰ï¼š\nå¦‚ä½•è®©å®¹å™¨å†…çš„åº”ç”¨å¯ä»¥è®¿é—®å®¿ä¸»æœºçš„åº”ç”¨ï¼Œè­¬å¦‚ï¼ˆmongoï¼Œredisï¼‰ï¼Ÿ Aï¼š ç»è¿‡æŸ¥é˜…å®˜æ–¹æ–‡æ¡£å’Œgoogleæ£€ç´¢ã€‚dockerä¼šåˆ›å»ºä¸€ä¸ªç½‘æ¡¥æ¥è´Ÿè´£å®¹å™¨ä¹‹é—´ï¼Œå®¹å™¨ä¸å®¿ä¸»æœºçš„é€šä¿¡ï¼Œå¦‚ä¸‹å›¾ï¼š æ›´å¤šèµ„æ–™å¯ä»¥å‚è€ƒDocker â€” ä»å…¥é—¨åˆ°å®è·µ æ€»çš„æ¥è¯´ï¼Œä¸æƒ³é€šè¿‡å®¹å™¨äº’è”çš„æ–¹å¼æ¥è¿è¡Œç¨‹åºï¼Œé‚£ä¹ˆå°±éœ€è¦é…ç½®ä¸€ä¸ªhostæ¥æä¾›ç»™å®¹å™¨å†…çš„åº”ç”¨è®¿é—®ã€‚é‚£ä¹ˆè¿™ä¸ªhostæ€ä¹ˆç¡®è®¤å‘¢ï¼Ÿ\ndocker inspect --format \u0026#34;{{.NetworkSettings.Gateway}}\u0026#34; c41c11eefc83 # c41c11eefc83 å®¹å™¨ID ä¼šå¾—åˆ°172.17.0.1ï¼ˆæ ¹æ®ç³»ç»Ÿä¸åŒä¼šå¾—åˆ°ä¸ä¸€æ ·çš„ç½‘å…³åœ°å€ï¼‰\næ³¨æ„ï¼š Mac ä¸Šåˆ°è¿™é‡Œä»ç„¶æ²¡æœ‰æˆåŠŸè¿è¡Œç¨‹åºï¼Œå› ä¸ºè¿™æ ·çš„é…ç½®è¿˜æ˜¯æ— æ³•è®¿é—®å®¿ä¸»æœºå™¨ä¸Šçš„Mongoå’ŒRedisæœåŠ¡ã€‚æœ€ç»ˆæ­£ç¡®çš„Hoståº”è¯¥æ˜¯docker.for.mac.localhost\té™„ä¸Šå®˜æ–¹æ–‡æ¡£çš„è¯´æ˜Docker-for-Mac-Networking\nä»17.06å¼€å§‹ï¼Œæˆ‘ä»¬çš„å»ºè®®æ˜¯è¿æ¥åˆ°ç‰¹æ®Šçš„ä»…é™äºMacçš„DNSåç§°docker.for.mac.localhostï¼Œè¯¥åç§°å°†è§£æä¸ºä¸»æœºä½¿ç”¨çš„å†…éƒ¨IPåœ°å€ã€‚\nå®æˆ˜äºŒ Dockerå¤šé˜¶æ®µæ„å»º # https://yeasy.gitbooks.io/docker_practice/content/image/multistage-builds.html é“¾æ¥ä¸­å·²ç»å……åˆ†é˜è¿°äº†ï¼Œå¤šé˜¶æ®µæ„å»ºçš„ä½¿ç”¨åœºæ™¯ï¼Œæœ¬å®æˆ˜åªæ˜¯æè¿°æˆ‘è‡ªå·±åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­çš„çŠ¶å†µåŠå°å°æ€è€ƒã€‚\nåœ¨å®æˆ˜ä¸€ä¸­ï¼Œéƒ¨ç½²çš„webæœåŠ¡æ˜¯ä¸€ä¸ªæ‰‹åŠ¨æ‰“åŒ…å¥½çš„å¯æ‰§è¡Œç¨‹åºæ–‡ä»¶ã€‚ä¹‹æ‰€ä»¥è¿™æ ·éƒ¨ç½²ï¼Œæ˜¯å› ä¸ºå½“æ—¶åœ¨ç»ƒä¹ ä½¿ç”¨dockerï¼Œä¸çŸ¥é“å¦‚ä½•åˆ¶ä½œè‡ªåŠ¨æ‰“åŒ…çš„é•œåƒï¼ˆç›‘ä»‹0-0ï¼‰ã€‚ å†åæ¥ä¾¿å°è¯•äº†è‡ªåŠ¨æ‰“åŒ…ï¼ŒDockerfileå¦‚ä¸‹ï¼š\nFROM golang:1.9-alpine WORKDIR /go/src/myapp COPY ./vendor ./vendor COPY ./webapp.go ./ RUN CGO_ENABLED=0 GOOS=linux ARCH=amd64 go build -o webapp webapp.go EXPOSE 35764 CMD [\u0026#34;./webapp\u0026#34;] æŸ¥çœ‹ä¸‹æ‰“åŒ…çš„é•œåƒï¼Œè¶³è¶³æœ‰282MBï¼Œç›¸æ¯”ç¬¬ä¸€ç§æ‰“åŒ…æ–¹å¼ï¼Œä½“ç§¯å˜å¤§äº†å¾ˆå¤šï¼ˆå°½ç®¡å·²ç»ä½¿ç”¨äº†golang:1.9-alpineé•œåƒï¼Œå¦‚æœä¸æ˜¯ä½¿ç”¨è¿™ä¸ªçš„è¯ï¼Œè¿˜ä¼šæ›´å¤§ã€‚ã€‚ã€‚ï¼‰ã€‚\nâœ test-platform git:(master) âœ— docker images REPOSITORY TAG IMAGE ID CREATED SIZE tp-api v1.2 9cbe31c46664 7 seconds ago 282MB å½“ç„¶ä¸ºäº†å‡å°é•œåƒä½“ç§¯ï¼Œæœ‰å¦‚ä¸‹æ–¹æ¡ˆï¼š\næ–¹æ¡ˆä¸€ï¼šå¯ä»¥é‡‡ç”¨ç¼–å†™shellè„šæœ¬æˆ–æ‰‹åŠ¨æ‰“åŒ…ï¼Œç„¶åå†éƒ¨ç½²æœåŠ¡ã€‚ # å¼Šç«¯ï¼šä½†æ˜¯åœ¨ä¸åŒçš„ç¯å¢ƒä¸Šï¼Œshellè„šæœ¬ä¸èƒ½ä¿è¯ç™¾åˆ†ç™¾å¯é ï¼Œè€Œä¸”è¿˜éœ€è¦è¯¥ç¯å¢ƒæ”¯æŒ æ–¹æ¡ˆäºŒï¼šå¤šä¸ªDockerfile, å°†ç¼–è¯‘åçš„ç¨‹åºåŠå…¶ä»–æ–‡ä»¶æ”¾å…¥ç”¨äºéƒ¨ç½²çš„é•œåƒä¸­ # å¼Šç«¯ï¼šæ­¥éª¤è¾ƒä¸ºç¹çï¼Œå› ä¸ºç¼–è¯‘åçš„æ–‡ä»¶ä½äºé•œåƒä¸­ï¼Œå¿…é¡»å…ˆå°†å…¶å¤åˆ¶å‡ºæ¥ï¼›å…¶æ¬¡æ˜¯è‡³å°‘éœ€è¦ç¼–å†™ä¸‰ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªç”¨äºç¼–è¯‘çš„dockerfile.build, ä¸€ä¸ªç”¨äºéƒ¨ç½²çš„dockerfile.deployï¼Œä¸€ä¸ªç”¨äºé“¾æ¥ä¸¤ä¸ªæ­¥éª¤çš„shellè„šæœ¬ æ–¹æ¡ˆä¸‰ï¼š dockerå¤šé˜¶æ®µæ„å»º # ä¸ºè§£å†³ä»¥ä¸Šé—®é¢˜ï¼ŒDocker v17.05 å¼€å§‹æ”¯æŒå¤šé˜¶æ®µæ„å»º (multistage builds)ã€‚ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºæˆ‘ä»¬å°±å¯ä»¥å¾ˆå®¹æ˜“è§£å†³å‰é¢æåˆ°çš„é—®é¢˜ï¼Œå¹¶ä¸”åªéœ€è¦ç¼–å†™ä¸€ä¸ª Dockerfile\nç›¸æ¯”äºæ–¹æ¡ˆäºŒï¼Œè¿™æ˜¯ä¸€ç§æ›´ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆã€‚å› ä¸ºåœ¨ä¸€ä¸ªdockerfileä¸­ä½ å¯ä»¥ç»™å„ä¸ªé˜¶æ®µå‘½åï¼Œç„¶åå¤åˆ¶çš„æ—¶å€™å¸¦ä¸Š--from=stage_nameä¾¿å¯ä»¥æ–¹ä¾¿çš„å¤åˆ¶ç¼–è¯‘åçš„æ–‡ä»¶äº†ã€‚\n##### # ç¼–è¯‘é˜¶æ®µ #### FROM golang:1.9-alpine AS build WORKDIR /go/src/test-platform COPY ./vendor ./vendor COPY ./webapp.go ./ RUN CGO_ENABLED=0 GOOS=linux go build ./webapp.go ##### # éƒ¨ç½²é˜¶æ®µ ##### FROM alpine RUN mkdir /app COPY --from=build /go/src/test-platform/webapp /app COPY ./config /app/config COPY ./logs /app/logs EXPOSE 35764 WORKDIR /app CMD [\u0026#34;./webapp\u0026#34;, \u0026#34;-env $RUN_ENV\u0026#34;] å®æˆ˜ä¸‰ Dockerç½‘ç»œåŸºç¡€åŠå®¹å™¨äº’è” # ä½¿ç”¨dockeréƒ¨ç½²webæœåŠ¡çš„æ—¶å€™ï¼Œä¸€å®šä¼šæ¥è§¦åˆ°çš„å°±æ˜¯ï¼š\nå¦‚ä½•ä»å®¹å™¨å¤–è®¿é—®å®¹å™¨å†…çš„æœåŠ¡ï¼Ÿ å¦‚ä½•ä»å®¹å™¨å†…è®¿é—®å®¿ä¸»æœºçš„æœåŠ¡ï¼Ÿ å¦‚ä½•å®¹å™¨é—´é€šä¿¡ï¼Ÿ 1.å¦‚ä½•ä»å®¹å™¨å¤–è®¿é—®å®¹å™¨å†…çš„æœåŠ¡ï¼Ÿ # 2.å¦‚ä½•ä»å®¹å™¨å†…è®¿é—®å®¿ä¸»æœºçš„æœåŠ¡ï¼Ÿ # 3.å¦‚ä½•å®¹å™¨é—´é€šä¿¡ï¼Ÿ # "},{"id":67,"href":"/2018/01/16/wrk%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/","title":"wrkæ€§èƒ½æµ‹è¯•å·¥å…·ä½¿ç”¨æ€»ç»“","section":"Posts","content":"wrk å‹åŠ›æµ‹è¯•å·¥å…·çš„ç®€å•å°ç»“ã€‚ é¡¹ç›®åœ°å€ï¼šhttps://github.com/wg/wrk\nå®‰è£… # Win: https://github.com/wg/wrk/wiki/Installing-wrk-on-Windows-10 Linux: https://github.com/wg/wrk/wiki/Installing-wrk-on-Linux MacOS: brew install wrk\nåŸºæœ¬å‘½ä»¤ # âœ ~ wrk Usage: wrk \u0026lt;options\u0026gt; \u0026lt;url\u0026gt; Options: -c, --connections \u0026lt;N\u0026gt; è¿æ¥æ•° -d, --duration \u0026lt;T\u0026gt; æŒç»­æ—¶é—´ -t, --threads \u0026lt;N\u0026gt; çº¿ç¨‹æ•° -s, --script \u0026lt;S\u0026gt; åˆ¶å®šluaè„šæœ¬ -H, --header \u0026lt;H\u0026gt; æ·»åŠ è¯·æ±‚å¤´ --latency æ‰“å°å»¶è¿Ÿåˆ†å¸ƒä¿¡æ¯ --timeout \u0026lt;T\u0026gt; è®¾ç½®è¯·æ±‚è¶…æ—¶ -v, --version æ‰“å°ç‰ˆæœ¬ä¿¡æ¯ \u0026lt;N\u0026gt;è¡¨ç¤ºæ•°å­—å‚æ•°ï¼Œæ”¯æŒå›½é™…å•ä½ (1k, 1M, 1G) \u0026lt;T\u0026gt;è¡¨ç¤ºæ—¶é—´å‚æ•°ï¼Œæ”¯æŒå›½é™…å•ä½ (2s, 2m, 2h) ç®€å•ä½¿ç”¨åŠè§£é‡Š # wrk -t1 -d20s -c10 -s post.lua http://api.example.com/fake/post ä»¥å•çº¿ç¨‹ ä¿æŒ10ä¸ªè¿æ¥ æŒç»­20ç§’ è¿è¡Œpost.luaè„šæœ¬è®¿é—®http://api.example.com/fake/post\næŠ¥å‘Šåˆ†æ # å¦‚ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„æ€§èƒ½æµ‹è¯•æŠ¥å‘Š\nRunning 10s test @ http://api.example.com/vioce/url 1 threads and 1 connections Thread Stats Avg Stdev Max +/- Stdev Latency 1.71s 98.25ms 1.85s 75.00% Req/Sec 0.00 0.00 0.00 100.00% 5 requests in 10.04s, 1.55KB read Socket errors: connect 0, read 0, write 0, timeout 1 Requests/sec: 0.50 //QPS Transfer/sec: 157.88B //æ¯ç§’å¤„ç†æ•°æ® ç¼–å†™luaè„šæœ¬å®ç°postè¯·æ±‚ # -- wrk å…¨å±€å˜é‡ï¼Œæ”¹åŠ¨ä¹‹åä¼šå½±å“æ‰€æœ‰çš„è¯·æ±‚ wrk = { scheme = \u0026#34;http\u0026#34;, host = \u0026#34;localhost\u0026#34;, port = nil, method = \u0026#34;GET\u0026#34;, path = \u0026#34;/\u0026#34;, headers = {}, body = nil, thread = \u0026lt;userdata\u0026gt;, } jsonæ ¼å¼ # å¯¹äºjsonæ ¼å¼æ•°æ®å‘æƒ…postè¯·æ±‚ä¹Ÿæ˜¯å¾ˆç®€å•çš„\n-- filename: post.json.lua -- è®¾ç½®è¯·æ±‚æ–¹å¼ wrk.method = \u0026#34;POST\u0026#34; -- json string wrk.body = \u0026#39;{\u0026#34;key1\u0026#34;: \u0026#34;val1\u0026#34;, \u0026#34;key2\u0026#34;: \u0026#34;val2\u0026#34;}\u0026#39; -- è®¾ç½®content-type wrk.headers[\u0026#34;Content-Type\u0026#34;] = \u0026#34;application/json\u0026#34; ä½¿ç”¨post.json.lua è„šæœ¬ï¼š wrk -t4 -d1m -c10 -s post.json.lua http://api.example.com/fake/post/json\nä¸Šä¼ æ–‡ä»¶ # å®ç°ä¸Šä¼ æ–‡ä»¶æµ‹è¯•ï¼Œä¸jsonç±»ä¼¼ï¼Œä¹Ÿæ˜¯è®¾ç½®wrk.bodyå’Œwrk.headers, åªæ˜¯bodyè¾ƒéº»çƒ¦ä¸€äº›\nwrk.method = \u0026#34;POST\u0026#34; wrk.headers[\u0026#34;Content-Type\u0026#34;] = \u0026#34;multipart/form-data;boundary=------WebKitFormBoundaryX3bY6PBMcxB1vCan\u0026#34; file = io.open(\u0026#34;path/to/fake.jpg\u0026#34;, \u0026#34;rb\u0026#34;) -- æ‹¼è£…form-data form = \u0026#34;------WebKitFormBoundaryX3bY6PBMcxB1vCan\\r\\n\u0026#34; form = form .. \u0026#34;Content-Disposition: form-data; name=\u0026#34;file\u0026#34;; filename=\u0026#34;fake.jpg\u0026#34;\\r\\n\u0026#34; form = form .. \u0026#34;Content-Type: image/jpeg\\r\\n\\r\\n\u0026#34; form = form .. file:read(\u0026#34;*a\u0026#34;) form = form .. \u0026#34;\\r\\n------WebKitFormBoundaryX3bY6PBMcxB1vCan--\u0026#34; wrk.body = form å®šåˆ¶åŒ–wrk # å®šåˆ¶å‚è€ƒï¼š https://github.com/wg/wrk/blob/master/SCRIPTING\næœªå®Œå¾…ç»­\n"},{"id":68,"href":"/2018/01/13/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/","title":"æŒç»­é›†æˆ-Jenkins","section":"Posts","content":"æŒç»­é›†æˆæ˜¯ä¸€ç§è½¯ä»¶å¼€å‘å®è·µï¼Œå³å›¢é˜Ÿå¼€å‘æˆå‘˜ç»å¸¸é›†æˆå®ƒä»¬çš„å·¥ä½œï¼Œé€šè¿‡æ¯ä¸ªæˆå‘˜æ¯å¤©è‡³å°‘é›†æˆä¸€æ¬¡ï¼Œä¹Ÿå°±æ„å‘³ç€æ¯å¤©å¯èƒ½ä¼šå‘ç”Ÿå¤šæ¬¡é›†æˆã€‚æ¯æ¬¡é›†æˆéƒ½é€šè¿‡è‡ªåŠ¨åŒ–çš„æ„å»ºï¼ˆåŒ…æ‹¬ç¼–è¯‘ï¼Œå‘å¸ƒï¼Œè‡ªåŠ¨åŒ–æµ‹è¯•ï¼‰æ¥éªŒè¯ï¼Œä»è€Œå°½æ—©åœ°å‘ç°é›†æˆé”™è¯¯ã€‚\nå…³äºæŒç»­é›†æˆ # è¦ç´ \n. ç»Ÿä¸€çš„ä»£ç åº“ . è‡ªåŠ¨æ„å»º . è‡ªåŠ¨æµ‹è¯• . æ¯ä¸ªäººæ¯å¤©éƒ½è¦å‘ä»£ç åº“ä¸»å¹²æäº¤ä»£ç  . æ¯æ¬¡ä»£ç é€’äº¤åéƒ½ä¼šåœ¨æŒç»­é›†æˆæœåŠ¡å™¨ä¸Šè§¦å‘ä¸€æ¬¡æ„å»º . ä¿è¯å¿«é€Ÿæ„å»º . æ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒçš„è‡ªåŠ¨æµ‹è¯• . æ¯ä¸ªäººéƒ½å¯ä»¥å¾ˆå®¹æ˜“çš„è·å–æœ€æ–°å¯æ‰§è¡Œçš„åº”ç”¨ç¨‹åº . æ¯ä¸ªäººéƒ½æ¸…æ¥šæ­£åœ¨å‘ç”Ÿçš„çŠ¶å†µ . è‡ªåŠ¨åŒ–çš„éƒ¨ç½²\nJenkinsçš„æ­å»ºä¸ä½¿ç”¨ï¼š # å‰æï¼šå®‰è£…å¥½Javaç¯å¢ƒ\n. ä¸‹è½½å‚è§ä¸‹è½½åœ°å€, æˆ‘é‡‡ç”¨çš„æ˜¯java -jar jenkins.warçš„æ–¹å¼éƒ¨ç½² . å¯èƒ½æœ‰ç”¨çš„æ•™ç¨‹ http://geek.csdn.net/news/detail/95824\næ›´æ”¹jenkinsæœåŠ¡ç«¯å£ # ä½¿ç”¨java -jar jenkins.warè¿™æ ·çš„å‘½ä»¤æ¥å¯åŠ¨jenkinsæ—¶ä¼šä½¿ç”¨é»˜è®¤çš„ç«¯å£8080ï¼Œæœ‰äº›æƒ…å†µä¸‹8080ç«¯å£å·²ç»è¢«æˆ‘ä»¬ä½¿ç”¨äº†ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœå¸Œæœ›ä¿®æ”¹è¿™ä¸ªç«¯å£åº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ\nåœ¨å‘½ä»¤è¡Œåé¢æ·»åŠ  --httpPort=8899ï¼Œå…¶å®å°±æ˜¯é…ç½®jettyçš„å¯åŠ¨ç«¯å£ã€‚å¦‚ä¸‹ï¼š\nsetÂ JENKINS_HOME=./ javaÂ -Djsse.enableSNIExtension=falseÂ -jarÂ path/to/jenkins.warÂ --httpPort=8899Â zshè®¾ç½®Jenkinsç¯å¢ƒå˜é‡ # export JENKINS_HOME = \u0026#34;your/jenkins/path\u0026#34; è¡¥å…… # äº2018-1-26æ—¥æ›´æ–°\né‰´äºå°è¯•äº†droneå’Œdocker, å¼ºçƒˆå»ºè®®é‡‡ç”¨dockeréƒ¨ç½²jenkinsï¼Œæˆ–è€…æ›¿æ¢Jenkinsä¸ºDrone\næœ€å # å†™å¾—å¾ˆç®€ç•¥ï¼Œæ²¡æœ‰æä¾›é…ç½®æ—¶å€™é‡åˆ°çš„å‘ä»¥åŠè§£å†³æ–¹æ³•ï¼Œé‡åˆ°ä¹‹åå†è¡¥ä¸Šã€‚ã€‚ã€‚ä»¥ä¸Šhahah\n"},{"id":69,"href":"/2018/01/13/pytest%E7%94%A8%E6%B3%95%E5%B0%8F%E7%BB%93/","title":"pytestç”¨æ³•å°ç»“","section":"Posts","content":"pytestæœ€å¸¸ç”¨æ³•æ€»ç»“ï¼Œå½“ç„¶ä¸æ­¢è¿™ä¸€ç‚¹åŠŸèƒ½ã€‚å…³äºæ›´å¤šæ›´å¼ºå¤§çš„æ’ä»¶ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±éœ€è¦æ¥å®šåˆ¶ã€‚\nå®‰è£… # pytest å®‰è£…å’Œä½¿ç”¨éƒ½éå¸¸ç®€å•, åªéœ€pip install pytest\nç¼–å†™æµ‹è¯•ä»£ç  # ä½¿ç”¨pytestï¼Œä¸éœ€è¦åƒunittestæ¨¡å—ä¸€æ ·ï¼Œpytestä½¿ç”¨çš„æ˜¯pythonè‡ªå¸¦çš„assertï¼Œå¦‚ï¼š\ndef test_global_function(): assert 1 == 1 ä½¿ç”¨pytest.mark # pytest.mark ç”¨äºç»™æµ‹è¯•æ–¹æ³•æ‰“ä¸Šæ ‡ç­¾ï¼Œåœ¨ç¨åçš„æ‰§è¡Œä¸­ä¼šè®²åˆ°å¦‚ä½•ä½¿ç”¨marker\n@pytest.mark.marker_self def test_global_function(): assert 1 == 1 ä½¿ç”¨pytest.fixture # @pytest.fixture def google_url(): return \u0026#34;http://google.com\u0026#34; setup å’Œ teardown # setupå’Œteardownæ–¹æ³•ä½œç”¨èŒƒå›´ï¼Œåˆ†ä¸ºå…¨å±€ä½œç”¨ï¼Œç±»ä½œç”¨ï¼Œæ–¹æ³•ä½œç”¨\nå…¨å±€ï¼šä½œç”¨äºå…¨å±€æµ‹è¯•å‡½æ•° ç±»ï¼š ä½œç”¨äºè‡ªèº«ç±» ç±»æ–¹æ³•ï¼š ä½œç”¨äºç±»å‡½æ•° ç®€å•ä¸¾ä¾‹: # # å…¨å±€ def setup_function(function): print(\u0026#34;setup function global\u0026#34;) def teardown_function(function): print(\u0026#34;teardown function global\u0026#34;) # ç±» class Test_fixture: @classmethod def setup_class(cls): print(\u0026#34;class setup method\u0026#34;) @classmethod def teardown_class(cls): print(\u0026#34;class teardown method\u0026#34;) # ç±»æ–¹æ³• def setup_method(self, method): print(\u0026#34;class method setup function\u0026#34;) def teardown_method(self, method): print(\u0026#34;class method teardown function\u0026#34;) pytesté…ç½®æ–‡ä»¶ # é…ç½®æ–‡ä»¶åä¸ºpytest.ini setup.cfg tox.ini å…³äºé…ç½®æ–‡ä»¶ä¼˜å…ˆçº§è¯·æŸ¥é˜…å®˜æ–¹æ–‡æ¡£ ç®€å•ä¸¾ä¾‹ï¼š\n[pytest] addopts = --maxfail=2 // set default pytest options python_classes = *Api //execute all *Api like TestSingUpApi or TestSignUpApi æ›´å¤šé…ç½®å†…å®¹å‚è§https://docs.pytest.org/en/latest/customize.html\næ‰§è¡Œæ–¹æ³• # æ­¤å¤„åªåˆ—ä¸¾äº†è¾ƒå¸¸ç”¨çš„å‚æ•°ï¼Œä¸»è¦ç”¨äºæ¼”ç¤ºmarkerå’Œé€‰ä¸­ï¼Œå’Œæ–‡ä»¶ï¼Œç±»ï¼Œå‡½æ•°çš„é€‰ä¸­\n# æ‰§è¡Œæ–¹æ³•ï¼špytest [options] test_file::Test_class::test_method [plugin-options] # æ‰§è¡Œæœ‰æ ‡è®°ä¸ºmarker_selfçš„case pytest -v -m \u0026#34;marker_self\u0026#34; test_demo.py::Test_fixture::test_fixture_demo # æ‰§è¡Œæœ‰æ ‡è®°ä¸ºmarker_self ä¸” marker_otherä¸çš„case pytest -v -m \u0026#34;marker_self and marker_other\u0026#34; test_demo.py::Test_fixture # æ‰§è¡Œæœ‰æ ‡è®°ä¸ºmarker_self æˆ– marker_otherçš„case pytest -v -m \u0026#34;yeqiag or marker_other\u0026#34; test_demo.py # æ‰§è¡Œæµ‹è¯•æ–‡ä»¶ä¸­æŸä¸€ä¸ªæµ‹è¯•ç±»çš„ä¸€ä¸ªæµ‹è¯•case pytest -v test_demo.py::Test_fixture::test_fixture_demo # æ‰§è¡Œæµ‹è¯•æ–‡ä»¶ä¸­æŸä¸€ä¸ªæµ‹è¯•ç±» pytest -v test_demo.py::Test_fixture # æ‰§è¡Œæµ‹è¯•æ–‡ä»¶ pytest -v test_demo.py å…¨éƒ¨ä»£ç  # \u0026#34;\u0026#34;\u0026#34; 1.setup teardown ä½œç”¨èŒƒå›´ï¼š å…¨å±€çš„ ä½œç”¨äº å…¨å±€çš„å•ä¸ªå‡½æ•°ï¼Œ class ä½œç”¨äº è¯¥ç±»çš„å•ä¸ªå‡½æ•° 2.markçš„ä½¿ç”¨ ä½¿ç”¨å…¨å±€çš„skip, xfailæ¥æ ‡è®°å¹¶ç•¥è¿‡ä¸€éƒ¨åˆ†çš„æµ‹è¯•case ä½¿ç”¨è‡ªå®šä¹‰çš„markeræ¥åŒºåˆ†æµ‹è¯•ç­‰çº§ 3.fixtureçš„ä½œç”¨èŒƒå›´ å…¨å±€ä½œç”¨ classå†…éƒ¨ä½œç”¨ \u0026#34;\u0026#34;\u0026#34; import pytest def setup_function(function): print(\u0026#34;setup function global\u0026#34;) def teardown_function(function): print(\u0026#34;teardown function global\u0026#34;) def test_simple_method(): assert 1 == 1 @pytest.mark.marker_self def test_global_function(): assert 1 == 1 class Test_class_case: \u0026#34;\u0026#34;\u0026#34; Must Know These Things 1. æµ‹è¯•ç±» initå‡½æ•°ä¸ä¼šè¢«æ‰§è¡Œ 2. æµ‹è¯•ç±» å±æ€§åªè¯» \u0026#34;\u0026#34;\u0026#34; @classmethod def setup_class(cls): print(\u0026#34;class setup function\u0026#34;) @classmethod def teardown_class(cls): print(\u0026#34;class teardown function\u0026#34;) def setup_method(self, method): print(\u0026#34;class method setup function\u0026#34;) def teardown_method(self, method): print(\u0026#34;class method teardown function\u0026#34;) @pytest.mark.xfail(reason=\u0026#34;ä¸€å®šå¤±è´¥\u0026#34;) def test_case0(self): assert 1 == 0 def test_case1(self): assert 1 == 1 @pytest.mark.skip(reason=\u0026#34;æˆ‘çŸ¥é“è¿™æ˜¯é”™çš„\u0026#34;) def test_case2(self): assert 1 == 0 def test_case3(self): assert True == False @pytest.fixture def google_url(): return \u0026#34;http://google.com\u0026#34; @pytest.mark.marker_self def test_fixture_google(google_url): assert google_url == \u0026#34;http://google.com\u0026#34; assert 1 == 0 def test_(google_url): assert google_url == \u0026#34;http;//google.com\u0026#34; def test_baidu_url(baidu_url): assert baidu_url == \u0026#34;http://baidu.com\u0026#34; class Test_fixture: @classmethod def setup_class(cls): print(\u0026#34;class setup method\u0026#34;) @classmethod def teardown_class(cls): print(\u0026#34;class teardown method\u0026#34;) @pytest.fixture def baidu_url(self): return \u0026#34;http://www.baidu.com\u0026#34; @pytest.mark.marker_self def test_fixture_demo(self, baidu_url): assert baidu_url == \u0026#34;http://www.baidu.com\u0026#34; assert 1 == 0 @pytest.mark.marker_other def test_fixture_demo_2(self, baidu_url): assert baidu_url == \u0026#34;http://google.com\u0026#34; @pytest.mark.marker_self @pytest.mark.skip(reason=\u0026#34;æ²¡æœ‰åŸå› ä¸‰\u0026#34;) def test_self_marker_demo0(self): assert 10 == 0 @pytest.mark.marker_self def test_self_marker_demo1(self): assert 10 == 0 @pytest.mark.marker_self @pytest.mark.marker_other def test_fixture_demo_google(self, google_url): assert google_url == \u0026#34;http://google.com\u0026#34; æ‰§è¡Œç»“æœæˆªå›¾\næœªå®Œå¾…ç»­\u0026hellip;\n"},{"id":70,"href":"/2018/01/11/git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/","title":"gitå‘½ä»¤æ¸…å•","section":"Posts","content":"gitå‘½ä»¤æ¸…å•\nåŸºæœ¬å‘½ä»¤ # git help \u0026lt;command\u0026gt; # æ˜¾ç¤ºcommandçš„help git show # æ˜¾ç¤ºæŸæ¬¡æäº¤çš„å†…å®¹ git show $id git co -- \u0026lt;file\u0026gt; # æŠ›å¼ƒå·¥ä½œåŒºä¿®æ”¹ git co . # æŠ›å¼ƒå·¥ä½œåŒºä¿®æ”¹ git add \u0026lt;file\u0026gt; # å°†å·¥ä½œæ–‡ä»¶ä¿®æ”¹æäº¤åˆ°æœ¬åœ°æš‚å­˜åŒº git add . # å°†æ‰€æœ‰ä¿®æ”¹è¿‡çš„å·¥ä½œæ–‡ä»¶æäº¤æš‚å­˜åŒº git rm \u0026lt;file\u0026gt; # ä»ç‰ˆæœ¬åº“ä¸­åˆ é™¤æ–‡ä»¶ git rm \u0026lt;file\u0026gt; --cached # ä»ç‰ˆæœ¬åº“ä¸­åˆ é™¤æ–‡ä»¶ï¼Œä½†ä¸åˆ é™¤æ–‡ä»¶ git reset \u0026lt;file\u0026gt; # ä»æš‚å­˜åŒºæ¢å¤åˆ°å·¥ä½œæ–‡ä»¶ git reset -- . # ä»æš‚å­˜åŒºæ¢å¤åˆ°å·¥ä½œæ–‡ä»¶ git reset --hard # æ¢å¤æœ€è¿‘ä¸€æ¬¡æäº¤è¿‡çš„çŠ¶æ€ï¼Œå³æ”¾å¼ƒä¸Šæ¬¡æäº¤åçš„æ‰€æœ‰æœ¬æ¬¡ä¿®æ”¹ # git ci \u0026lt;file\u0026gt; git ci . git ci -a # å°†git add, git rmå’Œgit ciç­‰æ“ä½œéƒ½åˆå¹¶åœ¨ä¸€èµ·åš git ci -am \u0026#34;some comments\u0026#34; git ci --amend # ä¿®æ”¹æœ€åä¸€æ¬¡æäº¤è®°å½• git revert \u0026lt;$id\u0026gt; # æ¢å¤æŸæ¬¡æäº¤çš„çŠ¶æ€ï¼Œæ¢å¤åŠ¨ä½œæœ¬èº«ä¹Ÿåˆ›å»ºæ¬¡æäº¤å¯¹è±¡ git revert HEAD # æ¢å¤æœ€åä¸€æ¬¡æäº¤çš„çŠ¶æ€ æŸ¥çœ‹æ–‡ä»¶(diff) # git diff \u0026lt;file\u0026gt; # æ¯”è¾ƒå½“å‰æ–‡ä»¶å’Œæš‚å­˜åŒºæ–‡ä»¶å·®å¼‚ git diff git diff \u0026lt;id1\u0026gt;\u0026lt;id1\u0026gt;\u0026lt;id2\u0026gt; # æ¯”è¾ƒä¸¤æ¬¡æäº¤ä¹‹é—´çš„å·®å¼‚ git diff \u0026lt;branch1\u0026gt;..\u0026lt;branch2\u0026gt; # åœ¨ä¸¤ä¸ªåˆ†æ”¯ä¹‹é—´æ¯”è¾ƒ git diff --staged # æ¯”è¾ƒæš‚å­˜åŒºå’Œç‰ˆæœ¬åº“å·®å¼‚ git diff --cached # æ¯”è¾ƒæš‚å­˜åŒºå’Œç‰ˆæœ¬åº“å·®å¼‚ git diff --stat # ä»…ä»…æ¯”è¾ƒç»Ÿè®¡ä¿¡æ¯ æŸ¥çœ‹æäº¤è®°å½•(log) # git log git log \u0026lt;file\u0026gt; # æŸ¥çœ‹è¯¥æ–‡ä»¶æ¯æ¬¡æäº¤è®°å½• git log -p \u0026lt;file\u0026gt; # æŸ¥çœ‹æ¯æ¬¡è¯¦ç»†ä¿®æ”¹å†…å®¹çš„diff git log -p -2 # æŸ¥çœ‹æœ€è¿‘ä¸¤æ¬¡è¯¦ç»†ä¿®æ”¹å†…å®¹çš„diff git log --stat #æŸ¥çœ‹æäº¤ç»Ÿè®¡ä¿¡æ¯ *tig: Macä¸Šå¯ä»¥ä½¿ç”¨tigä»£æ›¿diffå’Œlog * brew install tig Git æœ¬åœ°åˆ†æ”¯ç®¡ç† # æŸ¥çœ‹ã€åˆ‡æ¢ã€åˆ›å»ºå’Œåˆ é™¤åˆ†æ”¯\ngit br -r # æŸ¥çœ‹è¿œç¨‹åˆ†æ”¯ git br \u0026lt;new_branch\u0026gt; # åˆ›å»ºæ–°çš„åˆ†æ”¯ git br -v # æŸ¥çœ‹å„ä¸ªåˆ†æ”¯æœ€åæäº¤ä¿¡æ¯ git br --merged # æŸ¥çœ‹å·²ç»è¢«åˆå¹¶åˆ°å½“å‰åˆ†æ”¯çš„åˆ†æ”¯ git br --no-merged # æŸ¥çœ‹å°šæœªè¢«åˆå¹¶åˆ°å½“å‰åˆ†æ”¯çš„åˆ†æ”¯ git co \u0026lt;branch\u0026gt; # åˆ‡æ¢åˆ°æŸä¸ªåˆ†æ”¯ git co -b \u0026lt;new_branch\u0026gt; # åˆ›å»ºæ–°çš„åˆ†æ”¯ï¼Œå¹¶ä¸”åˆ‡æ¢è¿‡å» git co -b \u0026lt;new_branch\u0026gt; \u0026lt;branch\u0026gt; # åŸºäºbranchåˆ›å»ºæ–°çš„new_branch git co $id # æŠŠæŸæ¬¡å†å²æäº¤è®°å½•checkoutå‡ºæ¥ï¼Œä½†æ— åˆ†æ”¯ä¿¡æ¯ï¼Œåˆ‡æ¢åˆ°å…¶ä»–åˆ†æ”¯ä¼šè‡ªåŠ¨åˆ é™¤ git co $id -b \u0026lt;new_branch\u0026gt; # æŠŠæŸæ¬¡å†å²æäº¤è®°å½•checkoutå‡ºæ¥ï¼Œåˆ›å»ºæˆä¸€ä¸ªåˆ†æ”¯ git br -d \u0026lt;branch\u0026gt; # åˆ é™¤æŸä¸ªåˆ†æ”¯ git br -D \u0026lt;branch\u0026gt; # å¼ºåˆ¶åˆ é™¤æŸä¸ªåˆ†æ”¯ (æœªè¢«åˆå¹¶çš„åˆ†æ”¯è¢«åˆ é™¤çš„æ—¶å€™éœ€è¦å¼ºåˆ¶) ###Â åˆ†æ”¯åˆå¹¶å’Œrebase\ngit merge \u0026lt;branch\u0026gt; # å°†branchåˆ†æ”¯åˆå¹¶åˆ°å½“å‰åˆ†æ”¯ git merge origin/master --no-ff # ä¸è¦Fast-Fowardåˆå¹¶ï¼Œè¿™æ ·å¯ä»¥ç”Ÿæˆmergeæäº¤ git rebase master \u0026lt;branch\u0026gt; # å°†master rebaseåˆ°branchï¼Œç›¸å½“äºï¼š git co \u0026lt;branch\u0026gt; \u0026amp;\u0026amp; git rebase master \u0026amp;\u0026amp; git co master \u0026amp;\u0026amp; git merge \u0026lt;branch\u0026gt; Gitè¡¥ä¸ç®¡ç†(æ–¹ä¾¿åœ¨å¤šå°æœºå™¨ä¸Šå¼€å‘åŒæ­¥æ—¶ç”¨) # git diff \u0026gt; ../sync.patch # ç”Ÿæˆè¡¥ä¸ git apply ../sync.patch # æ‰“è¡¥ä¸ git apply --check ../sync.patch #æµ‹è¯•è¡¥ä¸èƒ½å¦æˆåŠŸ ###Â Gitæš‚å­˜ç®¡ç†\ngit stash # æš‚å­˜ git stash list # åˆ—æ‰€æœ‰stash git stash apply # æ¢å¤æš‚å­˜çš„å†…å®¹ git stash drop # åˆ é™¤æš‚å­˜åŒº Gitè¿œç¨‹åˆ†æ”¯ç®¡ç† # git pull # æŠ“å–è¿œç¨‹ä»“åº“æ‰€æœ‰åˆ†æ”¯æ›´æ–°å¹¶åˆå¹¶åˆ°æœ¬åœ° git pull --no-ff # æŠ“å–è¿œç¨‹ä»“åº“æ‰€æœ‰åˆ†æ”¯æ›´æ–°å¹¶åˆå¹¶åˆ°æœ¬åœ°ï¼Œä¸è¦å¿«è¿›åˆå¹¶ git fetch origin # æŠ“å–è¿œç¨‹ä»“åº“æ›´æ–° git merge origin/master # å°†è¿œç¨‹ä¸»åˆ†æ”¯åˆå¹¶åˆ°æœ¬åœ°å½“å‰åˆ†æ”¯ git co --track origin/branch # è·Ÿè¸ªæŸä¸ªè¿œç¨‹åˆ†æ”¯åˆ›å»ºç›¸åº”çš„æœ¬åœ°åˆ†æ”¯ git co -b \u0026lt;local_branch\u0026gt; origin/\u0026lt;remote_branch\u0026gt; # åŸºäºè¿œç¨‹åˆ†æ”¯åˆ›å»ºæœ¬åœ°åˆ†æ”¯ï¼ŒåŠŸèƒ½åŒä¸Š git push # pushæ‰€æœ‰åˆ†æ”¯ git push origin master # å°†æœ¬åœ°ä¸»åˆ†æ”¯æ¨åˆ°è¿œç¨‹ä¸»åˆ†æ”¯ git push -u origin master # å°†æœ¬åœ°ä¸»åˆ†æ”¯æ¨åˆ°è¿œç¨‹(å¦‚æ— è¿œç¨‹ä¸»åˆ†æ”¯åˆ™åˆ›å»ºï¼Œç”¨äºåˆå§‹åŒ–è¿œç¨‹ä»“åº“) git push origin \u0026lt;local_branch\u0026gt; # åˆ›å»ºè¿œç¨‹åˆ†æ”¯ï¼Œ originæ˜¯è¿œç¨‹ä»“åº“å git push origin \u0026lt;local_branch\u0026gt;:\u0026lt;remote_branch\u0026gt; # åˆ›å»ºè¿œç¨‹åˆ†æ”¯ git push origin :\u0026lt;remote_branch\u0026gt; #å…ˆåˆ é™¤æœ¬åœ°åˆ†æ”¯(git br -d \u0026lt;branch\u0026gt;)ï¼Œç„¶åå†pushåˆ é™¤è¿œç¨‹åˆ†æ”¯ Gitè¿œç¨‹ä»“åº“ç®¡ç† # GitHub\ngit remote -v # æŸ¥çœ‹è¿œç¨‹æœåŠ¡å™¨åœ°å€å’Œä»“åº“åç§° git remote show origin # æŸ¥çœ‹è¿œç¨‹æœåŠ¡å™¨ä»“åº“çŠ¶æ€ git remote add origin git@ github:robbin/robbin_site.git # æ·»åŠ è¿œç¨‹ä»“åº“åœ°å€ git remote set-url origin git@ github.com:robbin/robbin_site.git # è®¾ç½®è¿œç¨‹ä»“åº“åœ°å€(ç”¨äºä¿®æ”¹è¿œç¨‹ä»“åº“åœ°å€) git remote rm \u0026lt;repository\u0026gt; # åˆ é™¤è¿œç¨‹ä»“åº“ åˆ›å»ºè¿œç¨‹ä»“åº“ # git clone --bare robbin_site robbin_site.git # ç”¨å¸¦ç‰ˆæœ¬çš„é¡¹ç›®åˆ›å»ºçº¯ç‰ˆæœ¬ä»“åº“ scp -r my_project.git git@ git.csdn.net:~ # å°†çº¯ä»“åº“ä¸Šä¼ åˆ°æœåŠ¡å™¨ä¸Š mkdir robbin_site.git \u0026amp;\u0026amp; cd robbin_site.git \u0026amp;\u0026amp; git --bare init # åœ¨æœåŠ¡å™¨åˆ›å»ºçº¯ä»“åº“ git remote add origin git@ github.com:robbin/robbin_site.git # è®¾ç½®è¿œç¨‹ä»“åº“åœ°å€ git push -u origin master # å®¢æˆ·ç«¯é¦–æ¬¡æäº¤ git push -u origin develop # é¦–æ¬¡å°†æœ¬åœ°developåˆ†æ”¯æäº¤åˆ°è¿œç¨‹developåˆ†æ”¯ï¼Œå¹¶ä¸”track git remote set-head origin master # è®¾ç½®è¿œç¨‹ä»“åº“çš„HEADæŒ‡å‘masteråˆ†æ”¯ è®¾ç½®è·Ÿè¸ªè¿œç¨‹åº“å’Œæœ¬åœ°åº“ # git branch --set-upstream master origin/master git branch --set-upstream develop origin/develop "},{"id":71,"href":"/2018/01/11/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B4%A2%E5%BC%95%E5%9F%BA%E7%A1%80/","title":"æ•°æ®åº“ç´¢å¼•åŸºç¡€","section":"Posts","content":"æ•°æ®åº“ç´¢å¼•çš„ç®€å•ä»‹ç»å’Œä½¿ç”¨æ³¨æ„äº‹é¡¹\næ ‘ # äºŒå‰æ ‘ # æ€§è´¨1ï¼šåœ¨äºŒå‰æ ‘ä¸­ç¬¬ i å±‚çš„ç»“ç‚¹æ•°æœ€å¤šä¸º2^(i-1)ï¼ˆi â‰¥ 1ï¼‰ æ€§è´¨2ï¼šé«˜åº¦ä¸ºkçš„äºŒå‰æ ‘å…¶ç»“ç‚¹æ€»æ•°æœ€å¤šä¸º2^kï¼1ï¼ˆ k â‰¥ 1ï¼‰ æ€§è´¨3ï¼šå¯¹ä»»æ„çš„éç©ºäºŒå‰æ ‘ T ï¼Œå¦‚æœå¶ç»“ç‚¹çš„ä¸ªæ•°ä¸º n0ï¼Œè€Œå…¶åº¦ä¸º 2 çš„ç»“ç‚¹æ•°ä¸º n2ï¼Œåˆ™ï¼šn0 = n2 + 1 äºŒå‰æœç´¢æ ‘ BST # è‹¥å·¦å­æ ‘ä¸ç©ºï¼Œåˆ™å·¦å­æ ‘ä¸Šæ‰€æœ‰ç»“ç‚¹çš„å€¼å‡å°äºå®ƒçš„æ ¹ç»“ç‚¹çš„å€¼ï¼› è‹¥å³å­æ ‘ä¸ç©ºï¼Œåˆ™å³å­æ ‘ä¸Šæ‰€æœ‰ç»“ç‚¹çš„å€¼å‡å¤§äºæˆ–ç­‰äºå®ƒçš„æ ¹ç»“ç‚¹çš„å€¼ï¼› å·¦ã€å³å­æ ‘ä¹Ÿåˆ†åˆ«ä¸ºäºŒå‰æ’åºæ ‘ï¼› æ²¡æœ‰é”®å€¼ç›¸ç­‰çš„èŠ‚ç‚¹ å¹³è¡¡äºŒå‰æ ‘ AVLæ ‘ # å¹³è¡¡äºŒå‰æ ‘ï¼ˆbalanced binary treeï¼‰,åˆç§° AVL æ ‘ã€‚å®ƒæˆ–è€…æ˜¯ä¸€æ£µç©ºæ ‘,æˆ–è€…æ˜¯å…·æœ‰å¦‚ä¸‹æ€§è´¨çš„äºŒå‰æ ‘ï¼š\nå®ƒçš„å·¦å­æ ‘å’Œå³å­æ ‘éƒ½æ˜¯å¹³è¡¡äºŒå‰æ ‘ï¼Œ å·¦å­æ ‘å’Œå³å­æ ‘çš„æ·±åº¦ä¹‹å·®çš„ç»å¯¹å€¼ä¸è¶…è¿‡1ã€‚ å¹³è¡¡äºŒå‰æ ‘æ˜¯å¯¹äºŒå‰æœç´¢æ ‘(åˆç§°ä¸ºäºŒå‰æ’åºæ ‘)çš„ä¸€ç§æ”¹è¿›ã€‚äºŒå‰æœç´¢æ ‘æœ‰ä¸€ä¸ªç¼ºç‚¹å°±æ˜¯ï¼Œæ ‘çš„ç»“æ„æ˜¯æ— æ³•é¢„æ–™çš„ï¼Œéšæ„æ€§å¾ˆå¤§ï¼Œå®ƒåªä¸èŠ‚ç‚¹çš„å€¼å’Œæ’å…¥çš„é¡ºåºæœ‰å…³ç³»ï¼Œå¾€å¾€å¾—åˆ°çš„æ˜¯ä¸€ä¸ªä¸å¹³è¡¡çš„äºŒå‰æ ‘ã€‚åœ¨æœ€åçš„æƒ…å†µä¸‹ï¼Œå¯èƒ½å¾—åˆ°çš„æ˜¯ä¸€ä¸ªå•æ”¯äºŒå‰æ ‘ï¼Œå…¶é«˜åº¦å’ŒèŠ‚ç‚¹æ•°ç›¸åŒï¼Œç›¸å½“äºä¸€ä¸ªå•é“¾è¡¨ï¼Œå¯¹å…¶æ­£å¸¸çš„æ—¶é—´å¤æ‚åº¦æœ‰O(log(n))å˜æˆäº†O(n)ï¼Œä»è€Œä¸§å¤±äº†äºŒå‰æ’åºæ ‘çš„ä¸€äº›åº”è¯¥æœ‰çš„ä¼˜ç‚¹ã€‚\nBæ ‘ # BTreeæ˜¯å¹³è¡¡æœç´¢å¤šå‰æ ‘ï¼Œè®¾æ ‘çš„åº¦ä¸º2dï¼ˆd\u0026gt;1ï¼‰ï¼Œé«˜åº¦ä¸ºhï¼Œé‚£ä¹ˆBTreeè¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š\næ¯ä¸ªå¶å­ç»“ç‚¹çš„é«˜åº¦ä¸€æ ·ï¼Œç­‰äºhï¼› æ¯ä¸ªéå¶å­ç»“ç‚¹ç”±n-1ä¸ªkeyå’Œnä¸ªæŒ‡é’ˆpointç»„æˆï¼Œå…¶ä¸­d\u0026lt;=n\u0026lt;=2d,keyå’Œpointç›¸äº’é—´éš”ï¼Œç»“ç‚¹ä¸¤ç«¯ä¸€å®šæ˜¯keyï¼› å¶å­ç»“ç‚¹æŒ‡é’ˆéƒ½ä¸ºnullï¼› éå¶å­ç»“ç‚¹çš„keyéƒ½æ˜¯[key,data]äºŒå…ƒç»„ï¼Œå…¶ä¸­keyè¡¨ç¤ºä½œä¸ºç´¢å¼•çš„é”®ï¼Œdataä¸ºé”®å€¼æ‰€åœ¨è¡Œçš„æ•°æ®ï¼› B+æ ‘ # B+Treeæ˜¯BTreeçš„ä¸€ä¸ªå˜ç§ï¼Œè®¾dä¸ºæ ‘çš„åº¦æ•°ï¼Œhä¸ºæ ‘çš„é«˜åº¦ï¼ŒB+Treeå’ŒBTreeçš„ä¸åŒä¸»è¦åœ¨äºï¼š\nB+Treeä¸­çš„éå¶å­ç»“ç‚¹ä¸å­˜å‚¨æ•°æ®ï¼Œåªå­˜å‚¨é”®å€¼ï¼› B+Treeçš„å¶å­ç»“ç‚¹æ²¡æœ‰æŒ‡é’ˆï¼Œæ‰€æœ‰é”®å€¼éƒ½ä¼šå‡ºç°åœ¨å¶å­ç»“ç‚¹ä¸Šï¼Œä¸”keyå­˜å‚¨çš„é”®å€¼å¯¹åº”dataæ•°æ®çš„ç‰©ç†åœ°å€ï¼› B+Treeçš„æ¯ä¸ªéå¶å­èŠ‚ç‚¹ç”±nä¸ªé”®å€¼keyå’Œnä¸ªæŒ‡é’ˆpointç»„æˆï¼› ç´¢å¼• # èšç°‡ç´¢å¼•å’Œéèšç°‡ç´¢å¼•ï¼ˆä¹Ÿå«ï¼šèšé›†å’Œéèšé›†ï¼‰ # MyISAM éèšç°‡ç´¢å¼•\nMyISAMå­˜å‚¨å¼•æ“é‡‡ç”¨çš„æ˜¯éèšç°‡ç´¢å¼•ï¼Œéèšç°‡ç´¢å¼•çš„ä¸»ç´¢å¼•å’Œè¾…åŠ©ç´¢å¼•å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯ä¸»ç´¢å¼•ä¸å…è®¸é‡å¤ï¼Œä¸å…è®¸ç©ºå€¼ï¼Œä»–ä»¬çš„å¶å­ç»“ç‚¹çš„keyéƒ½å­˜å‚¨æŒ‡å‘é”®å€¼å¯¹åº”çš„æ•°æ®çš„ç‰©ç†åœ°å€ã€‚éèšç°‡ç´¢å¼•çš„æ•°æ®è¡¨å’Œç´¢å¼•è¡¨æ˜¯åˆ†å¼€å­˜å‚¨çš„ã€‚éèšç°‡ç´¢å¼•ä¸­çš„æ•°æ®æ˜¯æ ¹æ®æ•°æ®çš„æ’å…¥é¡ºåºä¿å­˜ã€‚å› æ­¤éèšç°‡ç´¢å¼•æ›´é€‚åˆå•ä¸ªæ•°æ®çš„æŸ¥è¯¢ã€‚æ’å…¥é¡ºåºä¸å—é”®å€¼å½±å“ã€‚\nInnoDB èšç°‡ç´¢å¼•\nèšç°‡ç´¢å¼•çš„ä¸»ç´¢å¼•çš„å¶å­ç»“ç‚¹å­˜å‚¨çš„æ˜¯é”®å€¼å¯¹åº”çš„æ•°æ®æœ¬èº«ï¼Œè¾…åŠ©ç´¢å¼•çš„å¶å­ç»“ç‚¹å­˜å‚¨çš„æ˜¯é”®å€¼å¯¹åº”çš„æ•°æ®çš„ä¸»é”®é”®å€¼ã€‚å› æ­¤ä¸»é”®çš„å€¼é•¿åº¦è¶Šå°è¶Šå¥½ï¼Œç±»å‹è¶Šç®€å•è¶Šå¥½ã€‚èšç°‡ç´¢å¼•çš„æ•°æ®å’Œä¸»é”®ç´¢å¼•å­˜å‚¨åœ¨ä¸€èµ·ã€‚èšç°‡ç´¢å¼•çš„æ•°æ®æ˜¯æ ¹æ®ä¸»é”®çš„é¡ºåºä¿å­˜ã€‚å› æ­¤é€‚åˆæŒ‰ä¸»é”®ç´¢å¼•çš„åŒºé—´æŸ¥æ‰¾ï¼Œå¯ä»¥æœ‰æ›´å°‘çš„ç£ç›˜I/Oï¼ŒåŠ å¿«æŸ¥è¯¢é€Ÿåº¦ã€‚\nä½†æ˜¯ä¹Ÿæ˜¯å› ä¸ºè¿™ä¸ªåŸå› ï¼Œèšç°‡ç´¢å¼•çš„æ’å…¥é¡ºåºæœ€å¥½æŒ‰ç…§ä¸»é”®å•è°ƒçš„é¡ºåºæ’å…¥ï¼Œå¦åˆ™ä¼šé¢‘ç¹çš„å¼•èµ·é¡µåˆ†è£‚ï¼Œä¸¥é‡å½±å“æ€§èƒ½ã€‚åœ¨InnoDBä¸­ï¼Œå¦‚æœåªéœ€è¦æŸ¥æ‰¾ç´¢å¼•çš„åˆ—ï¼Œå°±å°½é‡ä¸è¦åŠ å…¥å…¶å®ƒçš„åˆ—ï¼Œè¿™æ ·ä¼šæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚\nç´¢å¼•ç±»å‹ # ä¸»é”®ç´¢å¼•ï¼šæ ¹æ®ä¸»é”®pk_clolumï¼ˆlengthï¼‰å»ºç«‹ç´¢å¼•ï¼Œä¸å…è®¸é‡å¤ï¼Œä¸å…è®¸ç©ºå€¼ã€‚\nå”¯ä¸€ç´¢å¼•ï¼šç”¨æ¥å»ºç«‹ç´¢å¼•çš„åˆ—çš„å€¼å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œå…è®¸ç©ºå€¼ã€‚\nå…¨æ–‡ç´¢å¼•ï¼šæ–‡æœ¬å¯¹è±¡çš„åˆ—æ„å»ºçš„ç´¢å¼•ï¼Œå€’æ’ç´¢å¼•ã€‚\nç»„åˆç´¢å¼•ï¼šç”¨å¤šä¸ªåˆ—ç»„åˆæ„å»ºçš„ç´¢å¼•ï¼Œè¿™å¤šä¸ªåˆ—ä¸­çš„å€¼ä¸å…è®¸æœ‰ç©ºå€¼\nHashç´¢å¼•ï¼ŒBTreeç´¢å¼•ï¼Œå‰ç¼€ç´¢å¼•\nç´¢å¼•çš„ä¼˜ç‚¹ # é€šè¿‡åˆ›å»ºå”¯ä¸€æ€§ç´¢å¼•ï¼Œå¯ä»¥ä¿è¯æ•°æ®åº“è¡¨ä¸­æ¯ä¸€è¡Œæ•°æ®çš„å”¯ä¸€æ€§ã€‚ å¯ä»¥å¤§å¤§åŠ å¿«æ•°æ®çš„æ£€ç´¢é€Ÿåº¦ï¼Œè¿™ä¹Ÿæ˜¯åˆ›å»ºç´¢å¼•çš„æœ€ä¸»è¦çš„åŸå› ã€‚ å¯ä»¥åŠ é€Ÿè¡¨å’Œè¡¨ä¹‹é—´çš„è¿æ¥ï¼Œç‰¹åˆ«æ˜¯åœ¨å®ç°æ•°æ®çš„å‚è€ƒå®Œæ•´æ€§æ–¹é¢ç‰¹åˆ«æœ‰æ„ä¹‰ã€‚ åœ¨ä½¿ç”¨åˆ†ç»„å’Œæ’åºå­å¥è¿›è¡Œæ•°æ®æ£€ç´¢æ—¶ï¼ŒåŒæ ·å¯ä»¥æ˜¾è‘—å‡å°‘æŸ¥è¯¢ä¸­åˆ†ç»„å’Œæ’åºçš„æ—¶é—´ã€‚ é€šè¿‡ä½¿ç”¨ç´¢å¼•ï¼Œå¯ä»¥åœ¨æŸ¥è¯¢çš„è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨ä¼˜åŒ–éšè—å™¨ï¼Œæé«˜ç³»ç»Ÿçš„æ€§èƒ½ã€‚Â ç´¢å¼•ä¼˜åŒ– # TODO:\nQ\u0026amp;A # ä¸ºä»€ä¹ˆä¸å¯¹æ¯ä¸€åˆ—éƒ½åˆ›å»ºç´¢å¼•? # åˆ›å»ºç´¢å¼•å’Œç»´æŠ¤ç´¢å¼•è¦è€—è´¹æ—¶é—´ï¼Œè¿™ç§æ—¶é—´éšç€æ•°æ®é‡çš„å¢åŠ è€Œå¢åŠ ã€‚ ç´¢å¼•éœ€è¦å ç‰©ç†ç©ºé—´ï¼Œé™¤äº†æ•°æ®è¡¨å æ•°æ®ç©ºé—´ä¹‹å¤–ï¼Œæ¯ä¸€ä¸ªç´¢å¼•è¿˜è¦å ä¸€å®šçš„ç‰©ç†ç©ºé—´ï¼Œå¦‚æœè¦å»ºç«‹èšç°‡ç´¢å¼•ï¼Œé‚£ä¹ˆéœ€è¦çš„ç©ºé—´å°±ä¼šæ›´å¤§ã€‚ å½“å¯¹è¡¨ä¸­çš„æ•°æ®è¿›è¡Œå¢åŠ ã€åˆ é™¤å’Œä¿®æ”¹çš„æ—¶å€™ï¼Œç´¢å¼•ä¹Ÿè¦åŠ¨æ€çš„ç»´æŠ¤ï¼Œè¿™æ ·å°±é™ä½äº†æ•°æ®çš„ç»´æŠ¤é€Ÿåº¦ã€‚ ä¸€ä¸ªè¡¨æœ€å¤š16åˆ—ç´¢å¼•ã€‚ åº”è¯¥é€‰æ‹©å“ªäº›åˆ—æ¥åˆ›å»ºç´¢å¼•ï¼Ÿ # åœ¨ç»å¸¸éœ€è¦æœç´¢çš„åˆ—ä¸Šï¼Œå¯ä»¥åŠ å¿«æœç´¢çš„é€Ÿåº¦ï¼› åœ¨ä½œä¸ºä¸»é”®çš„åˆ—ä¸Šï¼Œå¼ºåˆ¶è¯¥åˆ—çš„å”¯ä¸€æ€§å’Œç»„ç»‡è¡¨ä¸­æ•°æ®çš„æ’åˆ—ç»“æ„ï¼› åœ¨ç»å¸¸ç”¨åœ¨è¿æ¥çš„åˆ—ä¸Šï¼Œè¿™äº›åˆ—ä¸»è¦æ˜¯ä¸€äº›å¤–é”®ï¼Œå¯ä»¥åŠ å¿«è¿æ¥çš„é€Ÿåº¦ï¼› åœ¨ç»å¸¸éœ€è¦æ ¹æ®èŒƒå›´è¿›è¡Œæœç´¢çš„åˆ—ä¸Šåˆ›å»ºç´¢å¼•ï¼Œå› ä¸ºç´¢å¼•å·²ç»æ’åºï¼Œå…¶æŒ‡å®šçš„èŒƒå›´æ˜¯è¿ç»­çš„ï¼› åœ¨ç»å¸¸éœ€è¦æ’åºçš„åˆ—ä¸Šåˆ›å»ºç´¢å¼•ï¼Œå› ä¸ºç´¢å¼•å·²ç»æ’åºï¼Œè¿™æ ·æŸ¥è¯¢å¯ä»¥åˆ©ç”¨ç´¢å¼•çš„æ’åºï¼ŒåŠ å¿«æ’åºæŸ¥è¯¢æ—¶é—´ï¼›åœ¨ç»å¸¸ä½¿ç”¨åœ¨WHEREå­å¥ä¸­çš„åˆ—ä¸Šé¢åˆ›å»ºç´¢å¼•ï¼ŒåŠ å¿«æ¡ä»¶çš„åˆ¤æ–­é€Ÿåº¦ã€‚ å“ªäº›åˆ—ä¸åº”è¯¥åˆ›å»ºç´¢å¼•ï¼Ÿ # å¯¹äºé‚£äº›åœ¨æŸ¥è¯¢ä¸­å¾ˆå°‘ä½¿ç”¨æˆ–è€…å‚è€ƒçš„åˆ—ä¸åº”è¯¥åˆ›å»ºç´¢å¼•ã€‚è¿™äº›åˆ—å¾ˆå°‘ä½¿ç”¨åˆ°ï¼Œå› æ­¤æœ‰ç´¢å¼•æˆ–è€…æ— ç´¢å¼•ï¼Œå¹¶ä¸èƒ½æé«˜æŸ¥è¯¢é€Ÿåº¦ã€‚åè€Œç”±äºå¢åŠ äº†ç´¢å¼•ï¼Œé™ä½äº†ç³»ç»Ÿçš„ç»´æŠ¤é€Ÿåº¦å’Œå¢å¤§äº†ç©ºé—´éœ€æ±‚ã€‚ å¯¹äºé‚£äº›åªæœ‰å¾ˆå°‘æ•°æ®å€¼çš„åˆ—ä¹Ÿä¸åº”è¯¥å¢åŠ ç´¢å¼•ã€‚è¿™æ˜¯å› ä¸ºï¼Œç”±äºè¿™äº›åˆ—çš„å–å€¼å¾ˆå°‘ï¼Œä¾‹å¦‚äººäº‹è¡¨çš„æ€§åˆ«åˆ—ï¼Œåœ¨æŸ¥è¯¢çš„ç»“æœä¸­ï¼Œç»“æœé›†çš„æ•°æ®è¡Œå äº†è¡¨ä¸­æ•°æ®è¡Œçš„å¾ˆå¤§æ¯”ä¾‹ï¼Œå³éœ€è¦åœ¨è¡¨ä¸­æœç´¢çš„æ•°æ®è¡Œçš„æ¯”ä¾‹å¾ˆå¤§ã€‚å¢åŠ ç´¢å¼•ï¼Œå¹¶ä¸èƒ½æ˜æ˜¾åŠ å¿«æ£€ç´¢é€Ÿåº¦ã€‚ å¯¹äºé‚£äº›å®šä¹‰ä¸ºtext, imageå’Œbitæ•°æ®ç±»å‹çš„åˆ—ä¸åº”è¯¥å¢åŠ ç´¢å¼•ã€‚è¿™æ˜¯å› ä¸ºï¼Œè¿™äº›åˆ—çš„æ•°æ®é‡è¦ä¹ˆç›¸å½“å¤§ï¼Œè¦ä¹ˆå–å€¼å¾ˆå°‘ã€‚ å½“ä¿®æ”¹æ€§èƒ½è¿œè¿œå¤§äºæ£€ç´¢æ€§èƒ½æ—¶ï¼Œä¸åº”è¯¥åˆ›å»ºç´¢å¼•ã€‚è¿™æ˜¯å› ä¸ºï¼Œä¿®æ”¹æ€§èƒ½å’Œæ£€ç´¢æ€§èƒ½æ˜¯äº’ç›¸çŸ›ç›¾çš„ã€‚å½“å¢åŠ ç´¢å¼•æ—¶ï¼Œä¼šæé«˜æ£€ç´¢æ€§èƒ½ï¼Œä½†æ˜¯ä¼šé™ä½ä¿®æ”¹æ€§èƒ½ã€‚å½“å‡å°‘ç´¢å¼•æ—¶ï¼Œä¼šæé«˜ä¿®æ”¹æ€§èƒ½ï¼Œé™ä½æ£€ç´¢æ€§èƒ½ã€‚å› æ­¤ï¼Œå½“ä¿®æ”¹æ€§èƒ½è¿œè¿œå¤§äºæ£€ç´¢æ€§èƒ½æ—¶ï¼Œä¸åº”è¯¥åˆ›å»ºç´¢å¼•ã€‚ å‚è€ƒ # https://hit-alibaba.github.io/interview/basic/algo/Tree.html https://blog.csdn.net/tongdanping/article/details/79878302Â· "},{"id":72,"href":"/2018/01/11/RN%E5%8E%86%E9%99%A9%E8%AE%B0/","title":"RNå†é™©è®°","section":"Posts","content":"è®²è¿°é…ç½®ReactNativeçš„å¿ƒé…¸å†ç¨‹\nç¨‹åºçŒ¿é•¿å¾ç¬¬ä¸€æ­¥ # æ ¹æ®å®˜æ–¹æ–‡æ¡£æ¥å®‰è£…RN, ä»¥åŠå·¨å¤§æ— æ¯”çš„Xcode Ver9.0.0\né”™è¯¯ä¸€ï¼šBuild Fail # å¯èƒ½æè¿°ä¸å¤ªä¸€è‡´, ä½†æ˜¯åŸå› éƒ½å·®ä¸å¤š, æ–‡ä»¶ç¼ºå¤±ã€‚ èœé¸Ÿæƒ³å¿…çœ‹åˆ°è¿™äº›ä¸ªæŠ¥é”™, ä¸¤çœ¼ä¸€æ‡µé€¼, å•¥å­æƒ…å†µ, æ€ä¹ˆå’Œå®˜æ–¹çš„æè¿°ä¸ä¸€è‡´, ä¸€ä¸ªåŠå…¶ç®€å•çš„RN-Demo, æˆ‘å°±æ˜¯æƒ³è·‘ä¸€ä¸‹çš„å–‚ï¼\næˆ‘é‡åˆ°çš„æƒ…å†µ, åˆ†ä¸ºä¸¤ç§ï¼š\nå…¶ä¸€æ˜¯å®‰è£…å¾ˆæ…¢, ä¹‹åå¤±è´¥ å…¶äºŒæ˜¯å®‰è£…å¾ˆå¿«, ç„¶åå¤±è´¥\nç»è¿‡åå¤çš„â€œçå­â€è°ƒæ•´, åœ¨å¤šæ¬¡æ›´æ¢react, react-nativeç‰ˆæœ¬, æ±‚åŠ©Googleå¤§å”æ— æœä¹‹åã€‚æˆ‘å¼€å§‹äº†é˜…è¯»è¾“å‡ºæ—¥å¿—çš„æ¼«æ¼«é•¿è·¯, ç»ˆäºå‘ç°äº†buildå¤±è´¥çš„å…ƒå‡¶, boost/xxx.hpp not foundä¸ºå•¥æ‰¾ä¸åˆ°å‘¢, å»æ–‡ä»¶å¤¹ä¸€çœ‹, æ‰å‘ç°è¿™äº›æ–‡ä»¶çœŸçš„ä¸å­˜åœ¨\u0026hellip;\u0026hellip;\nå¥½äº†çŸ¥é“é”™è¯¯, å°±å†Googleä¸‹å’¯ï¼ˆå…¶å®æˆ‘è¿˜å»æ”¹è¿‡è¿™äº›#includ\u0026lt;boost/config/user.hpp\u0026gt; 0\u0026lt;~\u0026gt;0ï¼‰è¿™é‡Œå°±ç›´æ¥ç»™å‡ºæˆ‘æ‰¾çš„ç»“æœå§: http://cdn2.jianshu.io/p/2ef019a7e82a\næ€»çš„è¯´æ¥, å°±æ˜¯è‡ªåŠ¨ä¸‹è½½çš„çš„ç¬¬ä¸‰æ–¹åº“æ˜¯æ®‹ç¼ºçš„\né”™è¯¯äºŒï¼šCFBundleIdentifier not Found # ç¬¬äºŒé”™è¯¯ä¹Ÿæ˜¯å›°æ‰°äº†æ¯”è¾ƒå¤šäºº, æˆ‘é‡åˆ°çš„åªæ˜¯å¯¼è‡´è¿™ä¸ªæƒ…å†µçš„å…¶ä¸­ä¹‹ä¸€\né€šè¿‡æŸ¥çœ‹è¾“å‡ºæ—¥å¿—, å¹¶æ²¡æœ‰å‘ç°ä»€ä¹ˆæœ‰ç”¨çš„ä¿¡æ¯, æç¤ºçš„æ˜¯Command Fail , balabalaâ€¦ æ‰‹åŠ¨æœç´¢äº†ä¸€ä¸‹PlistBuddy, äº†è§£äº†ä¸‹ç”¨æ³•, ç„¶åæˆ‘æ‰‹åŠ¨æ‰§è¡Œäº†ä¸‹å‘½ä»¤, å±…ç„¶å¯ä»¥ï¼ï¼ï¼ï¼ä»€ä¹ˆæƒ…å†µ, é‚£ä¸ºä»€ä¹ˆæç¤ºé”™è¯¯ä¿¡æ¯ï¼Ÿæœæ–­è¿›å…¥åˆ°æ–‡ä»¶å¤¹ä¸­æŸ¥çœ‹,æœç„¶æ–‡ä»¶æ˜¯å­˜åœ¨çš„é‚£ä¹ˆä¸ºå•¥ä¸€ä¸ªå¯ä»¥, ä¸€ä¸ªä¸å¯ä»¥å‘¢ï¼Ÿåˆ°è¿™é‡Œ, å¤§è‡´çŒœåˆ°åŸå› äº†, æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶\nå†æ¬¡ä»¥æ­¤ä¸ºç‚¹æ±‚åŠ©Googleå¤§å”: http://blog.csdn.net/ohyeahhhh/article/details/54691512\nè¿™ä¸ªå‘å°±æ˜¯, Xcodeç¼–è¯‘ä¿å­˜çš„è·¯å¾„å’Œreact-native-cliå¯»æ‰¾çš„è·¯å¾„ä¸ä¸€è‡´, é€šè¿‡ä¿®æ”¹è·¯å¾„å°±OKå•¦, è¿˜æœ‰å…¶ä»–åŸå› å¯¼è‡´çš„è¿™ä¸ªfail è¯·å‚é˜…é“¾æ¥, å…ˆææ¸…æ¥šreact-native run-iosåšäº†å•¥äº‹.\nä¸­é—´æ›´å¤šç»†èŠ‚â€è™â€œå»~~~~, æ„Ÿè°¢é¢„å…ˆè¸©å‘çš„å‰è¾ˆ, æœ€ç»ˆé¡¹ç›®æˆåŠŸè¿è¡Œå•¦ï¼\nå¿ƒå¾—ï¼š\n~ä¸è¦æ€•éº»çƒ¦, å…ˆçœ‹é”™è¯¯æ—¥å¿—, å®šä½é”™è¯¯, é‚£æ ·æ£€ç´¢çš„æ—¶å€™æ›´æœ‰æ–¹å‘, èŒƒå›´æ›´å° ~å¯¹äºæŠ¥é”™ä¸æ¸…æ¥šçš„command fail, å°½é‡è‡ªå·±å»æ‰§è¡Œ, æ˜ç¡®é”™è¯¯ï¼ˆç»“åˆæŸ¥çœ‹æ–‡ä»¶åˆ¤æ–­ï¼‰ ~å¥½å¥½ç”¨Google ~ç¬‘ç€æ´»ä¸‹å» é…ç½® å‚æ•° OS MacPro 10.13.1 Node v8.3.0 Npm v5.6.0 React-native 0.46.4 React-native-cli 0.2.1 "}]